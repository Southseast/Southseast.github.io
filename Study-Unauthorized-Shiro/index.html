<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="baidu-site-verification" content="5ZQsOe30cm" />
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"southsea.st","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.17.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqusjs","storage":true,"lazyload":false,"nav":null,"activeClass":"disqusjs"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="浅跟一下。">
<meta property="og:type" content="article">
<meta property="og:title" content="浅析 Shiro 未授权 CVE">
<meta property="og:url" content="https://southsea.st/Study-Unauthorized-Shiro/index.html">
<meta property="og:site_name" content="南溟NaN">
<meta property="og:description" content="浅跟一下。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-06-11T00:00:00.000Z">
<meta property="article:modified_time" content="2025-01-24T03:34:53.075Z">
<meta property="article:author" content="南溟NaN">
<meta property="article:tag" content="Web">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="Unauthorized">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://southsea.st/Study-Unauthorized-Shiro/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://southsea.st/Study-Unauthorized-Shiro/","path":"Study-Unauthorized-Shiro/","title":"浅析 Shiro 未授权 CVE"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>浅析 Shiro 未授权 CVE | 南溟NaN</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">南溟NaN</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">在这浩瀚星河的你是什么</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">24</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">5</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">68</span></a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#request-%E6%96%B9%E6%B3%95%E7%9A%84%E5%B7%AE%E5%BC%82%E6%80%A7"><span class="nav-number">1.</span> <span class="nav-text">request 方法的差异性</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#tomcat-%E7%9A%84%E8%AF%B7%E6%B1%82%E8%BD%AC%E6%8D%A2%E4%B8%8E%E6%98%A0%E5%B0%84"><span class="nav-number">2.</span> <span class="nav-text">Tomcat 的请求转换与映射</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E6%A0%88"><span class="nav-number">2.1.</span> <span class="nav-text">调用栈</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#postparserequest"><span class="nav-number">2.1.1.</span> <span class="nav-text">postParseRequest</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#normalize"><span class="nav-number">2.1.2.</span> <span class="nav-text">normalize</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#converturi"><span class="nav-number">2.1.3.</span> <span class="nav-text">convertURI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#map"><span class="nav-number">2.1.4.</span> <span class="nav-text">map</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#internalmapwrapper"><span class="nav-number">2.1.5.</span> <span class="nav-text">internalMapWrapper</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#cve-2010-3863"><span class="nav-number">3.</span> <span class="nav-text">CVE-2010-3863</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B"><span class="nav-number">3.1.</span> <span class="nav-text">漏洞简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-number">3.2.</span> <span class="nav-text">漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%95%E8%BF%87"><span class="nav-number">3.2.1.</span> <span class="nav-text">&#x2F;.&#x2F; 绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#shiro-%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86"><span class="nav-number">3.2.1.1.</span> <span class="nav-text">Shiro 处理部分</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#getchain"><span class="nav-number">3.2.1.1.1.</span> <span class="nav-text">getChain</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getpathwithinapplication"><span class="nav-number">3.2.1.1.2.</span> <span class="nav-text">getPathWithinApplication</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getrequesturi"><span class="nav-number">3.2.1.1.3.</span> <span class="nav-text">getRequestUri</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#decodeandcleanuristring"><span class="nav-number">3.2.1.1.4.</span> <span class="nav-text">decodeAndCleanUriString</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#proxy"><span class="nav-number">3.2.1.1.5.</span> <span class="nav-text">proxy</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tomcat-%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86"><span class="nav-number">3.2.1.2.</span> <span class="nav-text">Tomcat 处理部分</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#gethandlerinternal"><span class="nav-number">3.2.1.2.1.</span> <span class="nav-text">getHandlerInternal</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getpathwithinservletmapping"><span class="nav-number">3.2.1.2.2.</span> <span class="nav-text">getPathWithinServletMapping</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getservletpath"><span class="nav-number">3.2.1.2.3.</span> <span class="nav-text">getServletPath</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#lookuphandlermethod"><span class="nav-number">3.2.1.2.4.</span> <span class="nav-text">lookupHandlerMethod</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="nav-number">3.3.</span> <span class="nav-text">漏洞修复</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#cve-2016-6802"><span class="nav-number">4.</span> <span class="nav-text">CVE-2016-6802</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#cve-2020-1957"><span class="nav-number">5.</span> <span class="nav-text">CVE-2020-1957</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#cve-2020-11989"><span class="nav-number">6.</span> <span class="nav-text">CVE-2020-11989</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B-1"><span class="nav-number">6.1.</span> <span class="nav-text">漏洞简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1"><span class="nav-number">6.2.</span> <span class="nav-text">漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#context-path-%E7%BB%95%E8%BF%87"><span class="nav-number">6.2.1.</span> <span class="nav-text">context-path 绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#shiro-%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86-1"><span class="nav-number">6.2.1.1.</span> <span class="nav-text">Shiro 处理部分</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#executechain"><span class="nav-number">6.2.1.1.1.</span> <span class="nav-text">executeChain</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getexecutionchain"><span class="nav-number">6.2.1.1.2.</span> <span class="nav-text">getExecutionChain</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getchain-1"><span class="nav-number">6.2.1.1.3.</span> <span class="nav-text">getChain</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getpathwithinapplication-1"><span class="nav-number">6.2.1.1.4.</span> <span class="nav-text">getPathWithinApplication</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getcontextpath"><span class="nav-number">6.2.1.1.5.</span> <span class="nav-text">getContextPath</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getrequesturi-1"><span class="nav-number">6.2.1.1.6.</span> <span class="nav-text">getRequestUri</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#decodeandcleanuristring-1"><span class="nav-number">6.2.1.1.7.</span> <span class="nav-text">decodeAndCleanUriString</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tomcat-%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86-1"><span class="nav-number">6.2.1.2.</span> <span class="nav-text">Tomcat 处理部分</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#dofilter"><span class="nav-number">6.2.1.2.1.</span> <span class="nav-text">doFilter</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getpathwithinservletmapping-1"><span class="nav-number">6.2.1.2.2.</span> <span class="nav-text">getPathWithinServletMapping</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getpathwithinapplication-2"><span class="nav-number">6.2.1.2.3.</span> <span class="nav-text">getPathWithinApplication</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getrequesturi-2"><span class="nav-number">6.2.1.2.4.</span> <span class="nav-text">getRequestUri</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#decodeandcleanuristring-2"><span class="nav-number">6.2.1.2.5.</span> <span class="nav-text">decodeAndCleanUriString</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#removesemicoloncontent"><span class="nav-number">6.2.1.2.6.</span> <span class="nav-text">removeSemicolonContent</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#removesemicoloncontentinternal"><span class="nav-number">6.2.1.2.7.</span> <span class="nav-text">removeSemicolonContentInternal</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#gethandlerinternal-1"><span class="nav-number">6.2.1.2.8.</span> <span class="nav-text">getHandlerInternal</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8C%E5%B1%82-url-%E7%BC%96%E7%A0%81%E7%BB%95%E8%BF%87"><span class="nav-number">6.2.2.</span> <span class="nav-text">双层 URL 编码绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#shiro-%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86-2"><span class="nav-number">6.2.2.1.</span> <span class="nav-text">Shiro 处理部分</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#executechain-1"><span class="nav-number">6.2.2.1.1.</span> <span class="nav-text">executeChain</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E6%A0%88-1"><span class="nav-number">6.2.2.1.2.</span> <span class="nav-text">调用栈</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getrequesturi-3"><span class="nav-number">6.2.2.1.3.</span> <span class="nav-text">getRequestUri</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#decodeandcleanuristring-3"><span class="nav-number">6.2.2.1.4.</span> <span class="nav-text">decodeAndCleanUriString</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tomcat-%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86-2"><span class="nav-number">6.2.2.2.</span> <span class="nav-text">Tomcat 处理部分</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E6%A0%88-2"><span class="nav-number">6.2.2.2.1.</span> <span class="nav-text">调用栈</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getrequesturi-4"><span class="nav-number">6.2.2.2.2.</span> <span class="nav-text">getRequestUri</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#decodeandcleanuristring-4"><span class="nav-number">6.2.2.2.3.</span> <span class="nav-text">decodeAndCleanUriString</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-1"><span class="nav-number">6.3.</span> <span class="nav-text">漏洞修复</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#cve-2020-13933"><span class="nav-number">7.</span> <span class="nav-text">CVE-2020-13933</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B-2"><span class="nav-number">7.1.</span> <span class="nav-text">漏洞简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-2"><span class="nav-number">7.2.</span> <span class="nav-text">漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-1"><span class="nav-number">7.2.1.</span> <span class="nav-text">; 绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#shiro-%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86-3"><span class="nav-number">7.2.1.1.</span> <span class="nav-text">Shiro 处理部分</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E6%A0%88-3"><span class="nav-number">7.2.1.1.1.</span> <span class="nav-text">调用栈</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getpathwithinapplication-3"><span class="nav-number">7.2.1.1.2.</span> <span class="nav-text">getPathWithinApplication</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#removesemicolon"><span class="nav-number">7.2.1.1.3.</span> <span class="nav-text">removeSemicolon</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getchain-2"><span class="nav-number">7.2.1.1.4.</span> <span class="nav-text">getChain</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tomcat-%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86-3"><span class="nav-number">7.2.1.2.</span> <span class="nav-text">Tomcat 处理部分</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E6%A0%88-4"><span class="nav-number">7.2.1.2.1.</span> <span class="nav-text">调用栈</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getrequesturi-5"><span class="nav-number">7.2.1.2.2.</span> <span class="nav-text">getRequestUri</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#decodeandcleanuristring-5"><span class="nav-number">7.2.1.2.3.</span> <span class="nav-text">decodeAndCleanUriString</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-2"><span class="nav-number">7.3.</span> <span class="nav-text">漏洞修复</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#cve-2020-17510"><span class="nav-number">8.</span> <span class="nav-text">CVE-2020-17510</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B-3"><span class="nav-number">8.1.</span> <span class="nav-text">漏洞简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-3"><span class="nav-number">8.2.</span> <span class="nav-text">漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-2"><span class="nav-number">8.2.1.</span> <span class="nav-text">. 绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#shiro-%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86-4"><span class="nav-number">8.2.1.1.</span> <span class="nav-text">Shiro 处理部分</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E6%A0%88-5"><span class="nav-number">8.2.1.1.1.</span> <span class="nav-text">调用栈</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getpathwithinapplication-4"><span class="nav-number">8.2.1.1.2.</span> <span class="nav-text">getPathWithinApplication</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getservletpath-1"><span class="nav-number">8.2.1.1.3.</span> <span class="nav-text">getServletPath</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tomcat-%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86-4"><span class="nav-number">8.2.1.2.</span> <span class="nav-text">Tomcat 处理部分</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E6%A0%88-6"><span class="nav-number">8.2.1.2.1.</span> <span class="nav-text">调用栈</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getrequesturi-6"><span class="nav-number">8.2.1.2.2.</span> <span class="nav-text">getRequestUri</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#decodeandcleanuristring-6"><span class="nav-number">8.2.1.2.3.</span> <span class="nav-text">decodeAndCleanUriString</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-3"><span class="nav-number">8.3.</span> <span class="nav-text">漏洞修复</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#cve-2020-17523"><span class="nav-number">9.</span> <span class="nav-text">CVE-2020-17523</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B-4"><span class="nav-number">9.1.</span> <span class="nav-text">漏洞简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-4"><span class="nav-number">9.2.</span> <span class="nav-text">漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A9%BA%E6%A0%BC%E7%BB%95%E8%BF%87%E5%88%86%E6%9E%90"><span class="nav-number">9.2.1.</span> <span class="nav-text">空格绕过分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#shiro-%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86-5"><span class="nav-number">9.2.1.1.</span> <span class="nav-text">Shiro 处理部分</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E6%A0%88-7"><span class="nav-number">9.2.1.1.1.</span> <span class="nav-text">调用栈</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getpathwithinapplication-5"><span class="nav-number">9.2.1.1.2.</span> <span class="nav-text">getPathWithinApplication</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getchain-3"><span class="nav-number">9.2.1.1.3.</span> <span class="nav-text">getChain</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#tokenizetostringarray"><span class="nav-number">9.2.1.1.4.</span> <span class="nav-text">tokenizeToStringArray</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#domatch"><span class="nav-number">9.2.1.1.5.</span> <span class="nav-text">doMatch</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tomcat-%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86-5"><span class="nav-number">9.2.1.2.</span> <span class="nav-text">Tomcat 处理部分</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E6%A0%88-8"><span class="nav-number">9.2.1.2.1.</span> <span class="nav-text">调用栈</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getrequesturi-7"><span class="nav-number">9.2.1.2.2.</span> <span class="nav-text">getRequestUri</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#decodeandcleanuristring-7"><span class="nav-number">9.2.1.2.3.</span> <span class="nav-text">decodeAndCleanUriString</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#tokenizetostringarray-1"><span class="nav-number">9.2.1.2.4.</span> <span class="nav-text">tokenizeToStringArray</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-4"><span class="nav-number">9.3.</span> <span class="nav-text">漏洞修复</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#cve-2021-41303"><span class="nav-number">10.</span> <span class="nav-text">CVE-2021-41303</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B-5"><span class="nav-number">10.1.</span> <span class="nav-text">漏洞简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-5"><span class="nav-number">10.2.</span> <span class="nav-text">漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-3"><span class="nav-number">10.2.1.</span> <span class="nav-text">&#x2F; 绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#shiro%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86"><span class="nav-number">10.2.1.1.</span> <span class="nav-text">Shiro处理部分</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E6%A0%88-9"><span class="nav-number">10.2.1.1.1.</span> <span class="nav-text">调用栈</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getchain-4"><span class="nav-number">10.2.1.1.2.</span> <span class="nav-text">getChain</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#pathmatches"><span class="nav-number">10.2.1.1.3.</span> <span class="nav-text">pathMatches</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getchain-5"><span class="nav-number">10.2.1.1.4.</span> <span class="nav-text">getChain</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#proxy-1"><span class="nav-number">10.2.1.1.5.</span> <span class="nav-text">proxy</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-5"><span class="nav-number">10.3.</span> <span class="nav-text">漏洞修复</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#cve-2022-32532"><span class="nav-number">11.</span> <span class="nav-text">CVE-2022-32532</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#refer"><span class="nav-number">12.</span> <span class="nav-text">Refer</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="南溟NaN"
      src="https://avatars.githubusercontent.com/u/34373144?v=4">
  <p class="site-author-name" itemprop="name">南溟NaN</p>
  <div class="site-description" itemprop="description">在这浩瀚星河的你是什么</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">68</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/southseast" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;southseast" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:st.southsea@gmail.com" title="E-Mail → mailto:st.southsea@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://southsea.st/Study-Unauthorized-Shiro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/34373144?v=4">
      <meta itemprop="name" content="南溟NaN">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="南溟NaN">
      <meta itemprop="description" content="在这浩瀚星河的你是什么">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="浅析 Shiro 未授权 CVE | 南溟NaN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          浅析 Shiro 未授权 CVE
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-06-11 00:00:00" itemprop="dateCreated datePublished" datetime="2023-06-11T00:00:00+00:00">2023-06-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>浅跟一下。</p>
<span id="more"></span>
<h1 id="request-方法的差异性">request 方法的差异性</h1>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 52%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr class="header">
<th>方法</th>
<th>描述</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>request.getPathInfo</td>
<td>仅返回传递到<strong>Servlet</strong>的路径，如果没有传递额外的路径信息，则此返回<strong>NULL</strong></td>
<td>/test</td>
</tr>
<tr class="even">
<td>request.getContextPath</td>
<td>返回工程名部分，如果工程映射为<strong>/</strong>，则返回为空</td>
<td></td>
</tr>
<tr class="odd">
<td>request.getServletPath</td>
<td>返回除去<strong>Host</strong>和工程名部分的路径</td>
<td>/admin</td>
</tr>
<tr class="even">
<td>request.getRequestURI</td>
<td>返回除去<strong>Host</strong>部分的路径</td>
<td>/admin/test</td>
</tr>
<tr class="odd">
<td>request.getRequestURL</td>
<td>返回全路径</td>
<td>http://localhost:9090/admin/test</td>
</tr>
</tbody>
</table>
<h1 id="tomcat-的请求转换与映射">Tomcat 的请求转换与映射</h1>
<p>首先 <strong>Tomcat</strong> 会先处理 <strong>HTTP</strong>
请求，检查起合法性后映射请求到
<strong>MappingData</strong>，然后再执行引擎的反射判断路由最终调用匹配的方法。</p>
<p>而在映射的过程中，<strong>normalize</strong>
方法进行了很多的格式化操作，诸如替换 <strong>/./</strong> 为空。</p>
<h2 id="调用栈">调用栈</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">normalize:1212, CoyoteAdapter (org.apache.catalina.connector)</span><br><span class="line">postParseRequest:652, CoyoteAdapter (org.apache.catalina.connector)</span><br><span class="line">service:351, CoyoteAdapter (org.apache.catalina.connector)</span><br><span class="line">service:382, Http11Processor (org.apache.coyote.http11)</span><br><span class="line">process:65, AbstractProcessorLight (org.apache.coyote)</span><br><span class="line">process:893, AbstractProtocol$ConnectionHandler (org.apache.coyote)</span><br><span class="line">doRun:1723, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)</span><br><span class="line">run:49, SocketProcessorBase (org.apache.tomcat.util.net)</span><br><span class="line">runWorker:1149, ThreadPoolExecutor (java.util.concurrent)</span><br><span class="line">run:624, ThreadPoolExecutor$Worker (java.util.concurrent)</span><br><span class="line">run:61, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)</span><br><span class="line">run:750, Thread (java.lang)</span><br></pre></td></tr></table></figure>
<h3 id="postparserequest">postParseRequest</h3>
<p>首先是 <strong>CoyoteAdapter</strong> 类的
<strong>postParseRequest</strong> 方法，调用 <strong>normalize</strong>
进行标准化判断。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CoyoteAdapter (org.apache.catalina.connector)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">postParseRequest</span><span class="params">(org.apache.coyote.Request req, Request request, org.apache.coyote.Response res, Response response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="comment">// Normalization</span></span><br><span class="line">    <span class="keyword">if</span> (normalize(req.decodedURI())) &#123;</span><br><span class="line">        <span class="comment">// Character decoding</span></span><br><span class="line">        convertURI(decodedURI, request);</span><br><span class="line">        <span class="keyword">if</span> (!checkNormalize(req.decodedURI())) &#123;</span><br><span class="line">            response.sendError(<span class="number">400</span>, <span class="string">&quot;Invalid URI&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        response.sendError(<span class="number">400</span>, <span class="string">&quot;Invalid URI&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="normalize">normalize</h3>
<p><strong>normalize</strong> 方法匹配到 <strong>/.</strong> 结尾的
<strong>URI</strong>，末尾添加 <strong>/</strong>，然后截断，因此当
<strong>URI</strong> 为 <strong>/admin/.</strong> 时，先处理为
<strong>/admin/./</strong> ，然后替换为空得到
<strong>/admin/</strong>，但此时并没有直接赋值，而是进行了
<strong>setEnd</strong> 操作，标记了结束位。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CoyoteAdapter (org.apache.catalina.connector)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">normalize</span><span class="params">(MessageBytes uriMB)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">ByteChunk</span> <span class="variable">uriBC</span> <span class="operator">=</span> uriMB.getByteChunk();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">byte</span>[] b = uriBC.getBytes();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> uriBC.getStart();</span><br><span class="line">    <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> uriBC.getEnd();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// An empty URL is not acceptable</span></span><br><span class="line">    <span class="keyword">if</span> (start == end) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Replace &#x27;\&#x27; with &#x27;/&#x27;</span></span><br><span class="line">    <span class="comment">// Check for null byte</span></span><br><span class="line">    <span class="keyword">for</span> (pos = start; pos &lt; end; pos++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (b[pos] == (<span class="type">byte</span>) <span class="string">&#x27;\\&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ALLOW_BACKSLASH) &#123;</span><br><span class="line">                b[pos] = (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (b[pos] == (<span class="type">byte</span>) <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The URL must start with &#x27;/&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> (b[start] != (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Replace &quot;//&quot; with &quot;/&quot;</span></span><br><span class="line">    <span class="keyword">for</span> (pos = start; pos &lt; (end - <span class="number">1</span>); pos++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (b[pos] == (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> ((pos + <span class="number">1</span> &lt; end) &amp;&amp; (b[pos + <span class="number">1</span>] == (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">                copyBytes(b, pos, pos + <span class="number">1</span>, end - pos - <span class="number">1</span>);</span><br><span class="line">                end--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the URI ends with &quot;/.&quot; or &quot;/..&quot;, then we append an extra &quot;/&quot;</span></span><br><span class="line">    <span class="comment">// Note: It is possible to extend the URI by 1 without any side effect</span></span><br><span class="line">    <span class="comment">// as the next character is a non-significant WS.</span></span><br><span class="line">    <span class="keyword">if</span> (((end - start) &gt;= <span class="number">2</span>) &amp;&amp; (b[end - <span class="number">1</span>] == (<span class="type">byte</span>) <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((b[end - <span class="number">2</span>] == (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">            || ((b[end - <span class="number">2</span>] == (<span class="type">byte</span>) <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">                &amp;&amp; (b[end - <span class="number">3</span>] == (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>))) &#123;</span><br><span class="line">            b[end] = (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">            end++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uriBC.setEnd(end);</span><br><span class="line"></span><br><span class="line">    index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Resolve occurrences of &quot;/./&quot; in the normalized path</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        index = uriBC.indexOf(<span class="string">&quot;/./&quot;</span>, <span class="number">0</span>, <span class="number">3</span>, index);</span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        copyBytes(b, start + index, start + index + <span class="number">2</span>,</span><br><span class="line">                  end - start - index - <span class="number">2</span>);</span><br><span class="line">        end = end - <span class="number">2</span>;</span><br><span class="line">        uriBC.setEnd(end);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Resolve occurrences of &quot;/../&quot; in the normalized path</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        index = uriBC.indexOf(<span class="string">&quot;/../&quot;</span>, <span class="number">0</span>, <span class="number">4</span>, index);</span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Prevent from going outside our context</span></span><br><span class="line">        <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">index2</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (pos = start + index - <span class="number">1</span>; (pos &gt;= <span class="number">0</span>) &amp;&amp; (index2 &lt; <span class="number">0</span>); pos --) &#123;</span><br><span class="line">            <span class="keyword">if</span> (b[pos] == (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                index2 = pos;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        copyBytes(b, start + index2, start + index + <span class="number">3</span>,</span><br><span class="line">                  end - start - index - <span class="number">3</span>);</span><br><span class="line">        end = end + index2 - index - <span class="number">3</span>;</span><br><span class="line">        uriBC.setEnd(end);</span><br><span class="line">        index = index2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="converturi">convertURI</h3>
<p>如果 <strong>normalize</strong> 的合法性校验通过，此时才会调用
<strong>convertURI</strong> 方法，完成 <strong>URI</strong>
的标准化操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CoyoteAdapter (org.apache.catalina.connector)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">convertURI</span><span class="params">(MessageBytes uri, Request request)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">ByteChunk</span> <span class="variable">bc</span> <span class="operator">=</span> uri.getByteChunk();</span><br><span class="line">    <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> bc.getLength();</span><br><span class="line">    <span class="type">CharChunk</span> <span class="variable">cc</span> <span class="operator">=</span> uri.getCharChunk();</span><br><span class="line">    cc.allocate(length, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Charset</span> <span class="variable">charset</span> <span class="operator">=</span> connector.getURICharset();</span><br><span class="line"></span><br><span class="line">    <span class="type">B2CConverter</span> <span class="variable">conv</span> <span class="operator">=</span> request.getURIConverter();</span><br><span class="line">    <span class="keyword">if</span> (conv == <span class="literal">null</span>) &#123;</span><br><span class="line">        conv = <span class="keyword">new</span> <span class="title class_">B2CConverter</span>(charset, <span class="literal">true</span>);</span><br><span class="line">        request.setURIConverter(conv);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        conv.recycle();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        conv.convert(bc, cc, <span class="literal">true</span>);</span><br><span class="line">        uri.setChars(cc.getBuffer(), cc.getStart(), cc.getLength());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        <span class="comment">// Should never happen as B2CConverter should replace</span></span><br><span class="line">        <span class="comment">// problematic characters</span></span><br><span class="line">        request.getResponse().sendError(HttpServletResponse.SC_BAD_REQUEST);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="map">map</h3>
<p>返回标准化的 <strong>URI</strong> 之后，<strong>Tomcat</strong>
开始使用 <strong>map</strong> 方法处理映射。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mapper (org.apache.catalina.mapper)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">map</span><span class="params">(MessageBytes host, MessageBytes uri, String version,</span></span><br><span class="line"><span class="params">                MappingData mappingData)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (host.isNull()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">defaultHostName</span> <span class="operator">=</span> <span class="built_in">this</span>.defaultHostName;</span><br><span class="line">        <span class="keyword">if</span> (defaultHostName == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        host.getCharChunk().append(defaultHostName);</span><br><span class="line">    &#125;</span><br><span class="line">    host.toChars();</span><br><span class="line">    uri.toChars();</span><br><span class="line">    internalMap(host.getCharChunk(), uri.getCharChunk(), version, mappingData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="internalmapwrapper">internalMapWrapper</h3>
<p><strong>map</strong> 调用 <strong>internalMap</strong> ，然后继续调用
<strong>internalMapWrapper</strong>，在
<strong>internalMapWrapper</strong> 中对 <strong>mappingData</strong>
的成员变量 <strong>wrapperPath</strong> 进行了 <strong>setChars</strong>
赋值操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mapper (org.apache.catalina.mapper)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">internalMapWrapper</span><span class="params">(ContextVersion contextVersion, CharChunk path, MappingData mappingData)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (contextVersion.defaultWrapper != <span class="literal">null</span>) &#123;</span><br><span class="line">        mappingData.wrapper = contextVersion.defaultWrapper.object;</span><br><span class="line">        mappingData.requestPath.setChars(path.getBuffer(), path.getStart(), path.getLength());</span><br><span class="line">        mappingData.wrapperPath.setChars(path.getBuffer(), path.getStart(), path.getLength());</span><br><span class="line">        mappingData.matchType = MappingMatch.DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="cve-2010-3863">CVE-2010-3863</h1>
<h2 id="漏洞简介">漏洞简介</h2>
<p>影响版本：<strong>shiro &lt; 1.1.0</strong></p>
<p>漏洞描述：<strong>Shiro</strong> 没有处理
<strong>/./</strong>，<strong>Spring Controller</strong>
处理了，因为这样对 <strong>URL</strong>
解析的不同操作，匹配到不同的过滤链，导致权限绕过。</p>
<p>测试环境：<strong>1.0.0-incubating</strong>，<strong>SpringBoot
2.2.6.RELEASE</strong></p>
<h2 id="漏洞分析">漏洞分析</h2>
<p>配置如下。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.properties</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">9090</span></span><br></pre></td></tr></table></figure>
<p>路由如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">ShiroFilterFactoryBean <span class="title function_">shiroFilterFactoryBean</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ShiroFilterFactoryBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">    bean.setSecurityManager(securityManager());</span><br><span class="line">    bean.setLoginUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">    bean.setSuccessUrl(<span class="string">&quot;/index&quot;</span>);</span><br><span class="line">    bean.setUnauthorizedUrl(<span class="string">&quot;/unauthorizedurl&quot;</span>);</span><br><span class="line">    Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;/doLogin&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;/admin/**&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">    bean.setFilterChainDefinitionMap(map);</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>HTTP</strong> 请求如下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET http://127.0.0.1:9090/./admin/whoami</span><br></pre></td></tr></table></figure>
<h3 id="绕过">/./ 绕过</h3>
<h4 id="shiro-处理部分">Shiro 处理部分</h4>
<h5 id="getchain">getChain</h5>
<p><strong>getChain</strong> 调用
<strong>getPathWithinApplication</strong> 获取 <strong>URI</strong> 为
<strong>/./admin/whoami</strong>，然后 <strong>for</strong> 循环匹配到
<strong>/**</strong> 而不是 <strong>/admin/**</strong>，而后
<strong>proxy</strong> 根据 <strong>/**</strong> 获取
<strong>anno</strong> 路由。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> FilterChain <span class="title function_">getChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain originalChain)</span> &#123;</span><br><span class="line">    <span class="type">FilterChainManager</span> <span class="variable">filterChainManager</span> <span class="operator">=</span> getFilterChainManager();</span><br><span class="line">    <span class="keyword">if</span> (!filterChainManager.hasChains()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> getPathWithinApplication(request);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//the &#x27;chain names&#x27; in this implementation are actually path patterns defined by the user.  We just use them</span></span><br><span class="line">    <span class="comment">//as the chain name for the FilterChainManager&#x27;s requirements</span></span><br><span class="line">    <span class="keyword">for</span> (String pathPattern : filterChainManager.getChainNames()) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the path does match, then pass on to the subclass implementation for specific checks:</span></span><br><span class="line">        <span class="keyword">if</span> (pathMatches(pathPattern, requestURI)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                log.trace(<span class="string">&quot;Matched path pattern [&quot;</span> + pathPattern + <span class="string">&quot;] for requestURI [&quot;</span> + requestURI + <span class="string">&quot;].  &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;Utilizing corresponding filter chain...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> filterChainManager.proxy(originalChain, pathPattern);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getpathwithinapplication">getPathWithinApplication</h5>
<p><strong>getPathWithinApplication</strong> 中调用
<strong>getRequestUri</strong> 获取 <strong>URI</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPathWithinApplication</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">contextPath</span> <span class="operator">=</span> getContextPath(request);</span><br><span class="line">    <span class="type">String</span> <span class="variable">requestUri</span> <span class="operator">=</span> getRequestUri(request);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.startsWithIgnoreCase(requestUri, contextPath)) &#123;</span><br><span class="line">        <span class="comment">// Normal case: URI contains context path.</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> requestUri.substring(contextPath.length());</span><br><span class="line">        <span class="keyword">return</span> (StringUtils.hasText(path) ? path : <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Special case: rather unusual.</span></span><br><span class="line">        <span class="keyword">return</span> requestUri;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getrequesturi">getRequestUri</h5>
<p><strong>getRequestUri</strong> 传入
<strong>decodeAndCleanUriString</strong> 进行一些格式化处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getRequestUri</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> (String) request.getAttribute(INCLUDE_REQUEST_URI_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (uri == <span class="literal">null</span>) &#123;</span><br><span class="line">        uri = request.getRequestURI();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> decodeAndCleanUriString(request, uri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="decodeandcleanuristring">decodeAndCleanUriString</h5>
<p><strong>decodeAndCleanUriString</strong> 按 <strong>;</strong>
分割，返回。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">decodeAndCleanUriString</span><span class="params">(HttpServletRequest request, String uri)</span> &#123;</span><br><span class="line">    uri = decodeRequestString(request, uri);</span><br><span class="line">    <span class="type">int</span> <span class="variable">semicolonIndex</span> <span class="operator">=</span> uri.indexOf(<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> (semicolonIndex != -<span class="number">1</span> ? uri.substring(<span class="number">0</span>, semicolonIndex) : uri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="proxy">proxy</h5>
<p><strong>proxy</strong> 中根据 <strong>chainName</strong> 获取到
<strong>anno</strong> 路由。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> FilterChain <span class="title function_">proxy</span><span class="params">(FilterChain original, String chainName)</span> &#123;</span><br><span class="line">    <span class="type">NamedFilterList</span> <span class="variable">configured</span> <span class="operator">=</span> getChain(chainName);</span><br><span class="line">    <span class="keyword">if</span> (configured == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;There is no configured chain under the name/key [&quot;</span> + chainName + <span class="string">&quot;].&quot;</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> configured.proxy(original);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img
src="/images/Study-Unauthorized-Shiro/image-20230616151007411.png" /></p>
<h4 id="tomcat-处理部分">Tomcat 处理部分</h4>
<h5 id="gethandlerinternal">getHandlerInternal</h5>
<p><strong>getHandlerInternal</strong> 使用
<strong>getLookupPathForRequest</strong> 转
<strong>getPathWithinServletMapping</strong> 调用
<strong>getServletPath</strong> 返回的是
<strong>/admin/whoami</strong>。</p>
<p>然后 <strong>getHandlerInternal</strong> 使用
<strong>lookupHandlerMethod</strong> 方法，而
<strong>lookupHandlerMethod</strong> 调用
<strong>addMatchingMappings</strong> 匹配到
<strong>/admin/{name}</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractHandlerMethodMapping (org.springframework.web.servlet.handler)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> HandlerMethod <span class="title function_">getHandlerInternal</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 使用 getLookupPathForRequest 转 getPathWithinServletMapping 调用 getServletPath 返回的是 /admin/whoami。</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">lookupPath</span> <span class="operator">=</span> getUrlPathHelper().getLookupPathForRequest(request);</span><br><span class="line">    request.setAttribute(LOOKUP_PATH, lookupPath);</span><br><span class="line">    <span class="built_in">this</span>.mappingRegistry.acquireReadLock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// lookupHandlerMethod 调用 addMatchingMappings 匹配到 /admin/&#123;name&#125;。</span></span><br><span class="line">        <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> lookupHandlerMethod(lookupPath, request);</span><br><span class="line">        <span class="keyword">return</span> (handlerMethod != <span class="literal">null</span> ? handlerMethod.createWithResolvedBean() : <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mappingRegistry.releaseReadLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getpathwithinservletmapping">getPathWithinServletMapping</h5>
<p><strong>getPathWithinServletMapping</strong> 最后返回的是
<strong>getServletPath</strong> 的值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getPathWithinServletMapping</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">pathWithinApp</span> <span class="operator">=</span> getPathWithinApplication(request);</span><br><span class="line">    <span class="type">String</span> <span class="variable">servletPath</span> <span class="operator">=</span> getServletPath(request);</span><br><span class="line">    <span class="type">String</span> <span class="variable">sanitizedPathWithinApp</span> <span class="operator">=</span> getSanitizedPath(pathWithinApp);</span><br><span class="line">    String path;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the app container sanitized the servletPath, check against the sanitized version</span></span><br><span class="line">    <span class="keyword">if</span> (servletPath.contains(sanitizedPathWithinApp)) &#123;</span><br><span class="line">        path = getRemainingPath(sanitizedPathWithinApp, servletPath, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        path = getRemainingPath(pathWithinApp, servletPath, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (path != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Normal case: URI contains servlet path.</span></span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Special case: URI is different from servlet path.</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">pathInfo</span> <span class="operator">=</span> request.getPathInfo();</span><br><span class="line">        <span class="keyword">if</span> (pathInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Use path info if available. Indicates index page within a servlet mapping?</span></span><br><span class="line">            <span class="comment">// e.g. with index page: URI=&quot;/&quot;, servletPath=&quot;/index.html&quot;</span></span><br><span class="line">            <span class="keyword">return</span> pathInfo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.urlDecode) &#123;</span><br><span class="line">            <span class="comment">// No path info... (not mapped by prefix, nor by extension, nor &quot;/*&quot;)</span></span><br><span class="line">            <span class="comment">// For the default servlet mapping (i.e. &quot;/&quot;), urlDecode=false can</span></span><br><span class="line">            <span class="comment">// cause issues since getServletPath() returns a decoded path.</span></span><br><span class="line">            <span class="comment">// If decoding pathWithinApp yields a match just use pathWithinApp.</span></span><br><span class="line">            path = getRemainingPath(decodeInternal(request, pathWithinApp), servletPath, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (path != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> pathWithinApp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Otherwise, use the full servlet path.</span></span><br><span class="line">        <span class="keyword">return</span> servletPath;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getservletpath">getServletPath</h5>
<p>跟进 <strong>getServletPath</strong>，可见是调用了映射处理时候封装的
<strong>wrapperPath</strong> 成员变量，而 <strong>wrapperPath</strong>
在解析 <strong>HTTP</strong> 请求的时候就处理过，其中的
<strong>/./</strong> 被替换为空，因此返回了
<strong>/admin/whoami</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Request (org.apache.catalina.connector)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getServletPath</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mappingData.wrapperPath.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="lookuphandlermethod">lookupHandlerMethod</h5>
<p>最后在 <strong>lookupHandlerMethod</strong> 的
<strong>addMatchingMappings</strong> 方法中匹配到
<strong>/admin/{name}</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractHandlerMethodMapping (org.springframework.web.servlet.handler)</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> HandlerMethod <span class="title function_">lookupHandlerMethod</span><span class="params">(String lookupPath, HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    List&lt;Match&gt; matches = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;T&gt; directPathMatches = <span class="built_in">this</span>.mappingRegistry.getMappingsByUrl(lookupPath);</span><br><span class="line">    <span class="keyword">if</span> (directPathMatches != <span class="literal">null</span>) &#123;</span><br><span class="line">        addMatchingMappings(directPathMatches, matches, request);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (matches.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// No choice but to go through all mappings...</span></span><br><span class="line">        addMatchingMappings(<span class="built_in">this</span>.mappingRegistry.getMappings().keySet(), matches, request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!matches.isEmpty()) &#123;</span><br><span class="line">        <span class="type">Match</span> <span class="variable">bestMatch</span> <span class="operator">=</span> matches.get(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (matches.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            Comparator&lt;Match&gt; comparator = <span class="keyword">new</span> <span class="title class_">MatchComparator</span>(getMappingComparator(request));</span><br><span class="line">            matches.sort(comparator);</span><br><span class="line">            bestMatch = matches.get(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">                logger.trace(matches.size() + <span class="string">&quot; matching mappings: &quot;</span> + matches);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (CorsUtils.isPreFlightRequest(request)) &#123;</span><br><span class="line">                <span class="keyword">return</span> PREFLIGHT_AMBIGUOUS_MATCH;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Match</span> <span class="variable">secondBestMatch</span> <span class="operator">=</span> matches.get(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (comparator.compare(bestMatch, secondBestMatch) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">Method</span> <span class="variable">m1</span> <span class="operator">=</span> bestMatch.handlerMethod.getMethod();</span><br><span class="line">                <span class="type">Method</span> <span class="variable">m2</span> <span class="operator">=</span> secondBestMatch.handlerMethod.getMethod();</span><br><span class="line">                <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                        <span class="string">&quot;Ambiguous handler methods mapped for &#x27;&quot;</span> + uri + <span class="string">&quot;&#x27;: &#123;&quot;</span> + m1 + <span class="string">&quot;, &quot;</span> + m2 + <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        request.setAttribute(BEST_MATCHING_HANDLER_ATTRIBUTE, bestMatch.handlerMethod);</span><br><span class="line">        handleMatch(bestMatch.mapping, lookupPath, request);</span><br><span class="line">        <span class="keyword">return</span> bestMatch.handlerMethod;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> handleNoMatch(<span class="built_in">this</span>.mappingRegistry.getMappings().keySet(), lookupPath, request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img
src="/images/Study-Unauthorized-Shiro/image-20230616153030512.png" /></p>
<h2 id="漏洞修复">漏洞修复</h2>
<p><strong>Shiro</strong> 在 <a
target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/ab8294940a19743583d91f0c7e29b405d197cc34"><strong>Commit</strong></a>
中新增了 <strong>normalize</strong> 方法用于格式化。</p>
<p><img
src="/images/Study-Unauthorized-Shiro/github.com_apache_shiro_commit_ab8294940a19743583d91f0c7e29b405d197cc34.png" /></p>
<h1 id="cve-2016-6802">CVE-2016-6802</h1>
<h1 id="cve-2020-1957">CVE-2020-1957</h1>
<h1 id="cve-2020-11989">CVE-2020-11989</h1>
<h2 id="漏洞简介-1">漏洞简介</h2>
<p>影响版本：<strong>shiro &lt; 1.5.3</strong></p>
<p>漏洞描述：在 <strong>Shiro &lt; 1.5.3</strong> 的情况下，将
<strong>Shiro</strong> 与 <strong>Spring Controller</strong>
一起使用时，由于对 <strong>URL</strong>
解析的不同操作，匹配到不同的过滤链，导致权限绕过。</p>
<p>测试环境：<strong>Shiro 1.5.2</strong>，<strong>SpringBoot
2.2.6.RELEASE</strong></p>
<h2 id="漏洞分析-1">漏洞分析</h2>
<p>为了修复 <strong>CVE-2020-1957</strong>,<strong>shiro</strong> 在
<strong>1.5.2</strong> 版本进行了更新，将
<strong>request.getRequestURI()</strong> 修改为
<strong>request.getContextPath()</strong>、<strong>request.getServletPath()</strong>、<strong>request.getPathInfo()</strong>
拼接构造 <strong>URI</strong>。</p>
<h3 id="context-path-绕过">context-path 绕过</h3>
<p>配置如下。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.properties</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">9090</span></span><br><span class="line"><span class="attr">server.servlet.context-path</span>=<span class="string">/test</span></span><br></pre></td></tr></table></figure>
<p><strong>HTTP</strong> 请求如下。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET http://127.0.0.1:9090/test;/admin/cmd</span><br></pre></td></tr></table></figure>
<h4 id="shiro-处理部分-1">Shiro 处理部分</h4>
<h5 id="executechain">executeChain</h5>
<p>从 <strong>executeChain</strong> 方法开始，执行过滤链，先调用
<strong>getExecutionChain</strong> 方法获取 <strong>Shiro</strong>
配置的过滤链，然后执行 <strong>doFilter</strong> 方法进行过滤。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractShiroFilter (org.apache.shiro.web.servlet)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">executeChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain origChain)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="type">FilterChain</span> <span class="variable">chain</span> <span class="operator">=</span> getExecutionChain(request, response, origChain);</span><br><span class="line">    chain.doFilter(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getexecutionchain">getExecutionChain</h5>
<p>从 <strong>getFilterChainResolver</strong> 方法获取解析器，然后调用
<strong>getChain</strong> 根据 <strong>URL</strong> 获取要执行的链。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractShiroFilter (org.apache.shiro.web.servlet)</span></span><br><span class="line"><span class="keyword">protected</span> FilterChain <span class="title function_">getExecutionChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain origChain)</span> &#123;</span><br><span class="line">    <span class="type">FilterChain</span> <span class="variable">chain</span> <span class="operator">=</span> origChain;</span><br><span class="line"></span><br><span class="line">    <span class="type">FilterChainResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> getFilterChainResolver();</span><br><span class="line">    <span class="keyword">if</span> (resolver == <span class="literal">null</span>) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;No FilterChainResolver configured.  Returning original FilterChain.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> origChain;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">FilterChain</span> <span class="variable">resolved</span> <span class="operator">=</span> resolver.getChain(request, response, origChain);</span><br><span class="line">    <span class="keyword">if</span> (resolved != <span class="literal">null</span>) &#123;</span><br><span class="line">        log.trace(<span class="string">&quot;Resolved a configured FilterChain for the current request.&quot;</span>);</span><br><span class="line">        chain = resolved;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.trace(<span class="string">&quot;No FilterChain configured for the current request.  Using the default.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> chain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getchain-1">getChain</h5>
<p>调用 <strong>getPathWithinApplication</strong> 方法拿到
<strong>requestURI</strong> 为 <strong>/test</strong> ，去匹配
<strong>shiroFilterFactoryBean</strong>中 的
<strong>filter</strong>，匹配不到，返回为空。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span></span><br><span class="line"><span class="keyword">public</span> FilterChain <span class="title function_">getChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain originalChain)</span> &#123;</span><br><span class="line">    <span class="type">FilterChainManager</span> <span class="variable">filterChainManager</span> <span class="operator">=</span> getFilterChainManager();</span><br><span class="line">    <span class="keyword">if</span> (!filterChainManager.hasChains()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 获取到的URI为 &quot;/test&quot;</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> getPathWithinApplication(request); <span class="comment">// requestURI: &quot;/test&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 防止 &quot;/resource/menus&quot; 绕过 &quot;/resource/menus/&quot; 的保护</span></span><br><span class="line">    <span class="keyword">if</span>(requestURI != <span class="literal">null</span> &amp;&amp; !DEFAULT_PATH_SEPARATOR.equals(requestURI)</span><br><span class="line">            &amp;&amp; requestURI.endsWith(DEFAULT_PATH_SEPARATOR)) &#123;</span><br><span class="line">        requestURI = requestURI.substring(<span class="number">0</span>, requestURI.length() - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  [&quot;/doLogin&quot;, &quot;/admin/*&quot;]</span></span><br><span class="line">    <span class="keyword">for</span> (String pathPattern : filterChainManager.getChainNames()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pathPattern != <span class="literal">null</span> &amp;&amp; !DEFAULT_PATH_SEPARATOR.equals(pathPattern)</span><br><span class="line">                &amp;&amp; pathPattern.endsWith(DEFAULT_PATH_SEPARATOR)) &#123;</span><br><span class="line">            pathPattern = pathPattern.substring(<span class="number">0</span>, pathPattern.length() - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (pathMatches(pathPattern, requestURI)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                log.trace(<span class="string">&quot;Matched path pattern [&quot;</span> + pathPattern + <span class="string">&quot;] for requestURI [&quot;</span> + Encode.forHtml(requestURI) + <span class="string">&quot;].  &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;Utilizing corresponding filter chain...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> filterChainManager.proxy(originalChain, pathPattern);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getpathwithinapplication-1">getPathWithinApplication</h5>
<p>之所以在 <strong>getChain</strong> 中匹配不到，是因为
<strong>getPathWithinApplication</strong> 获取 <strong>URI</strong>
中部署路径之后的路径，例如 <strong>context-path</strong> 为
<strong>/test/</strong> 的时候 <strong>/test/admin/cmd</strong> 返回
<strong>/admin/cmd</strong>, 而 <strong>/test;/admin/cmd</strong>
由于解析差异则返回了 <strong>/test</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPathWithinApplication</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取当前Web应用程序的上下文路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">contextPath</span> <span class="operator">=</span> getContextPath(request); <span class="comment">// contextPath: &quot;/test;&quot;</span></span><br><span class="line">    <span class="comment">// 获取当前请求的请求URI</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">requestUri</span> <span class="operator">=</span> getRequestUri(request); <span class="comment">// requestUri: &quot;/test&quot;</span></span><br><span class="line">    <span class="comment">// 检查请求URI是否以上下文路径开头</span></span><br><span class="line">    <span class="comment">// 如果 &quot;/test/admin/cmd&quot; 则最后会返回 &quot;/admin/cmd&quot;， 而 &quot;/test;/admin/cmd&quot; 由于解析差异则返回了 &quot;/test&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.startsWithIgnoreCase(requestUri, contextPath)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> requestUri.substring(contextPath.length());</span><br><span class="line">        <span class="keyword">return</span> (StringUtils.hasText(path) ? path : <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> requestUri; <span class="comment">// requestUri: &quot;/test&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getcontextpath">getContextPath</h5>
<p>返回给定请求的上下文路径，即前两个 <strong>/</strong> 之间的参数
<strong>/test;</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">getContextPath</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">lastSlash</span> <span class="operator">=</span> mappingData.contextSlashCount;</span><br><span class="line">    <span class="comment">// Special case handling for the root context</span></span><br><span class="line">    <span class="keyword">if</span> (lastSlash == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">canonicalContextPath</span> <span class="operator">=</span> getServletContext().getContextPath(); <span class="comment">// canonicalContextPath: &quot;/test&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> getRequestURI(); <span class="comment">// uri: &quot;/test;/admin/cmd&quot;</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!getContext().getAllowMultipleLeadingForwardSlashInPath()) &#123;</span><br><span class="line">        <span class="comment">// 确保以 &quot;/&quot; 开头</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            pos++;</span><br><span class="line">        &#125; <span class="keyword">while</span> (pos &lt; uri.length() &amp;&amp; uri.charAt(pos) == <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">        pos--;</span><br><span class="line">        uri = uri.substring(pos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>[] uriChars = uri.toCharArray(); <span class="comment">// uriChars: [/, t, e, s, t, ;, /, a, d, m, i, n, /, c, m, d]</span></span><br><span class="line">    <span class="comment">// Need at least the number of slashes in the context path</span></span><br><span class="line">    <span class="keyword">while</span> (lastSlash &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        pos = nextSlash(uriChars, pos + <span class="number">1</span>); <span class="comment">// pos: 6</span></span><br><span class="line">        <span class="keyword">if</span> (pos == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        lastSlash--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 规范化路径</span></span><br><span class="line">    String candidate;</span><br><span class="line">    <span class="keyword">if</span> (pos == -<span class="number">1</span>) &#123;</span><br><span class="line">        candidate = uri;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        candidate = uri.substring(<span class="number">0</span>, pos); <span class="comment">// candidate: &quot;/test;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 移除 &quot;;&quot; 返回 &quot;/test&quot;</span></span><br><span class="line">    candidate = removePathParameters(candidate); </span><br><span class="line">    <span class="comment">// URL解码</span></span><br><span class="line">    candidate = UDecoder.URLDecode(candidate, connector.getURICharset());</span><br><span class="line">    <span class="comment">// 替换 &quot;\\&quot; 为 &quot;/&quot;, 若URL不以 &quot;/&quot; 开头则加上，替换 &quot;//&quot;、&quot;/./&quot;、&quot;/../&quot; 为 &quot;/&quot;</span></span><br><span class="line">    candidate = org.apache.tomcat.util.http.RequestUtil.normalize(candidate);</span><br><span class="line">    <span class="comment">// 检测处理前后是否相等</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">match</span> <span class="operator">=</span> canonicalContextPath.equals(candidate);</span><br><span class="line">    <span class="keyword">while</span> (!match &amp;&amp; pos != -<span class="number">1</span>) &#123;</span><br><span class="line">        pos = nextSlash(uriChars, pos + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (pos == -<span class="number">1</span>) &#123;</span><br><span class="line">            candidate = uri;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            candidate = uri.substring(<span class="number">0</span>, pos);</span><br><span class="line">        &#125;</span><br><span class="line">        candidate = removePathParameters(candidate);</span><br><span class="line">        candidate = UDecoder.URLDecode(candidate, connector.getURICharset());</span><br><span class="line">        candidate = org.apache.tomcat.util.http.RequestUtil.normalize(candidate);</span><br><span class="line">        match = canonicalContextPath.equals(candidate);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (match) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pos == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> uri;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> uri.substring(<span class="number">0</span>, pos); <span class="comment">// return: &quot;/test;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Should never happen</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(sm.getString(</span><br><span class="line">                <span class="string">&quot;coyoteRequest.getContextPath.ise&quot;</span>, canonicalContextPath, uri));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getrequesturi-1">getRequestUri</h5>
<p><strong>Shiro</strong> 中获取的 <strong>URI</strong> 还未经
<strong>servlet</strong> 解码，因此需要解码一次，对于如
<strong>JBoss/Jetty</strong> 等容器，在 <strong>URI</strong> 使用如
<strong>;jsessionid</strong> 样式进行传参，因此需要进行截断，返回
<strong>/test</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getRequestUri</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> (String) request.getAttribute(INCLUDE_REQUEST_URI_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (uri == <span class="literal">null</span>) &#123;</span><br><span class="line">        uri = valueOrEmpty(request.getContextPath()) + <span class="string">&quot;/&quot;</span> + <span class="comment">// &quot;/test;&quot;</span></span><br><span class="line">              valueOrEmpty(request.getServletPath()) + <span class="comment">// &quot;/admin/cmd&quot;</span></span><br><span class="line">              valueOrEmpty(request.getPathInfo()); <span class="comment">// &quot;&quot;</span></span><br><span class="line">    &#125; <span class="comment">// uri: &quot;/test;//admin/cmd&quot;</span></span><br><span class="line">    <span class="keyword">return</span> normalize(decodeAndCleanUriString(request, uri));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="decodeandcleanuristring-1">decodeAndCleanUriString</h5>
<p>该方法对传入的 <strong>URI</strong> 字符串进行解码，并删除任何在分号
<strong>;</strong> 字符之后的多余部分。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">decodeAndCleanUriString</span><span class="params">(HttpServletRequest request, String uri)</span> &#123;</span><br><span class="line">    uri = decodeRequestString(request, uri);</span><br><span class="line">    <span class="type">int</span> <span class="variable">semicolonIndex</span> <span class="operator">=</span> uri.indexOf(<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> (semicolonIndex != -<span class="number">1</span> ? uri.substring(<span class="number">0</span>, semicolonIndex) : uri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="tomcat-处理部分-1">Tomcat 处理部分</h4>
<h5 id="dofilter">doFilter</h5>
<p><strong>executeChain</strong> 调用 <strong>doFilter</strong> 之后进入
<strong>Tomcat</strong> 处理的部分。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ApplicationFilterChain (org.apache.catalina.core)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> request;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ServletResponse</span> <span class="variable">res</span> <span class="operator">=</span> response;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            java.security.AccessController.doPrivileged(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">java</span>.security.PrivilegedExceptionAction&lt;Void&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Void <span class="title function_">run</span><span class="params">()</span></span><br><span class="line">                        <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">                        internalDoFilter(req,res);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line">        &#125; <span class="keyword">catch</span>( PrivilegedActionException pe) &#123;</span><br><span class="line">            <span class="type">Exception</span> <span class="variable">e</span> <span class="operator">=</span> pe.getException();</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ServletException)</span><br><span class="line">                <span class="keyword">throw</span> (ServletException) e;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> IOException)</span><br><span class="line">                <span class="keyword">throw</span> (IOException) e;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RuntimeException)</span><br><span class="line">                <span class="keyword">throw</span> (RuntimeException) e;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        internalDoFilter(request,response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getpathwithinservletmapping-1">getPathWithinServletMapping</h5>
<p>返回请求 <strong>URL</strong> 中 <strong>servlet</strong>
之后的部分，例如 <strong>context-path</strong> 为
<strong>/test/</strong> 的时候 <strong>/test/admin/cmd</strong> 返回
<strong>/admin/cmd</strong>, <strong>/test;/admin/cmd</strong> 返回
<strong>/admin/cmd</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getPathWithinServletMapping</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">pathWithinApp</span> <span class="operator">=</span> getPathWithinApplication(request); <span class="comment">// pathWithinApp: &quot;/test/admin/cmd&quot;</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">servletPath</span> <span class="operator">=</span> getServletPath(request); <span class="comment">// servletPath: &quot;/admin/cmd&quot;</span></span><br><span class="line">    <span class="comment">// 替换//为/</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sanitizedPathWithinApp</span> <span class="operator">=</span> getSanitizedPath(pathWithinApp); <span class="comment">// sanitizedPathWithinApp: &quot;/test/admin/cmd&quot;</span></span><br><span class="line">    String path;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (servletPath.contains(sanitizedPathWithinApp)) &#123;</span><br><span class="line">        path = getRemainingPath(sanitizedPathWithinApp, servletPath, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        path = getRemainingPath(pathWithinApp, servletPath, <span class="literal">false</span>); <span class="comment">// path: null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (path != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">pathInfo</span> <span class="operator">=</span> request.getPathInfo(); <span class="comment">// pathInfo: null</span></span><br><span class="line">        <span class="keyword">if</span> (pathInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> pathInfo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.urlDecode) &#123;</span><br><span class="line">            path = getRemainingPath(decodeInternal(request, pathWithinApp), servletPath, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (path != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> pathWithinApp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> servletPath; <span class="comment">// servletPath: &quot;/admin/cmd&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getpathwithinapplication-2">getPathWithinApplication</h5>
<p>其中的 <strong>getRemainingPath</strong> 将给定的
<strong>mapping</strong> 与 <strong>requestUri</strong>
的开头进行匹配，如果匹配成功，则返回额外的部分。之所以需要此方法，是因为
<strong>HttpServletRequest</strong> 返回的上下文路径和
<strong>servlet</strong> 路径不同，<strong>requestUri</strong>
保留了分号内容用于传参。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getPathWithinApplication</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">contextPath</span> <span class="operator">=</span> getContextPath(request); <span class="comment">// contextPath: &quot;/test;&quot;</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">requestUri</span> <span class="operator">=</span> getRequestUri(request); <span class="comment">// requestUri: &quot;/test/admin/cmd&quot;</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> getRemainingPath(requestUri, contextPath, <span class="literal">true</span>); <span class="comment">// path: null</span></span><br><span class="line">    <span class="keyword">if</span> (path != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (StringUtils.hasText(path) ? path : <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> requestUri; <span class="comment">// requestUri: &quot;/test/admin/cmd&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getrequesturi-2">getRequestUri</h5>
<p>而 <strong>getRequestUri</strong> 返回的是
<strong>/test/admin/cmd</strong>，主要是经过了
<strong>decodeAndCleanUriString</strong> 方法的解析。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getRequestUri</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> (String) request.getAttribute(WebUtils.INCLUDE_REQUEST_URI_ATTRIBUTE); <span class="comment">// uri: &quot;/test;/admin/cmd&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (uri == <span class="literal">null</span>) &#123;</span><br><span class="line">        uri = request.getRequestURI();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> decodeAndCleanUriString(request, uri); <span class="comment">// return: &quot;/test/admin/cmd&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="decodeandcleanuristring-2">decodeAndCleanUriString</h5>
<p>而在 <strong>decodeAndCleanUriString</strong> 方法中最主要的还是
<strong>removeSemicolonContent</strong> 方法，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">decodeAndCleanUriString</span><span class="params">(HttpServletRequest request, String uri)</span> &#123;</span><br><span class="line">    uri = removeSemicolonContent(uri);</span><br><span class="line">    uri = decodeRequestString(request, uri);</span><br><span class="line">    uri = getSanitizedPath(uri);</span><br><span class="line">    <span class="keyword">return</span> uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="removesemicoloncontent">removeSemicolonContent</h5>
<p>当 <strong>this.removeSemicolonContent</strong> 为
<strong>true</strong> 的时候，调用
<strong>removeSemicolonContentInternal</strong> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">removeSemicolonContent</span><span class="params">(String requestUri)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">this</span>.removeSemicolonContent ?</span><br><span class="line">            removeSemicolonContentInternal(requestUri) : removeJsessionid(requestUri));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5
id="removesemicoloncontentinternal">removeSemicolonContentInternal</h5>
<p>循环检测并删除 <strong>;</strong> 使得
<strong>/test;/admin/cmd</strong> 变成
<strong>/test/admin/cmd</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">removeSemicolonContentInternal</span><span class="params">(String requestUri)</span> &#123; <span class="comment">// requestUri: &quot;/test;/admin/cmd&quot;</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">semicolonIndex</span> <span class="operator">=</span> requestUri.indexOf(<span class="string">&#x27;;&#x27;</span>); <span class="comment">// semicolonIndex: 5</span></span><br><span class="line">    <span class="keyword">while</span> (semicolonIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">slashIndex</span> <span class="operator">=</span> requestUri.indexOf(<span class="string">&#x27;/&#x27;</span>, semicolonIndex); <span class="comment">// slashIndex: 6</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">start</span> <span class="operator">=</span> requestUri.substring(<span class="number">0</span>, semicolonIndex); <span class="comment">// start: &quot;/test&quot;</span></span><br><span class="line">        requestUri = (slashIndex != -<span class="number">1</span>) ? start + requestUri.substring(slashIndex) : start;</span><br><span class="line">        semicolonIndex = requestUri.indexOf(<span class="string">&#x27;;&#x27;</span>, semicolonIndex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> requestUri; <span class="comment">// requestUri: &quot;/test/admin/cmd&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="gethandlerinternal-1">getHandlerInternal</h5>
<p><strong>getPathWithinServletMapping</strong> 返回的
<strong>/admin/cmd</strong> 进入 <strong>lookupHandlerMethod</strong>
方法寻找相匹配的 <strong>serlvet</strong>，因为 <strong>Shiro</strong>
的差异性解析没有匹配上，最后进入 <strong>SpringBoot</strong> 匹配到
<strong>admin</strong> 路由句柄。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractHandlerMapping (org.springframework.web.servlet.handler)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> HandlerMethod <span class="title function_">getHandlerInternal</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">lookupPath</span> <span class="operator">=</span> getUrlPathHelper().getLookupPathForRequest(request); <span class="comment">// lookupPath: &quot;/admin/cmd&quot;</span></span><br><span class="line">    request.setAttribute(LOOKUP_PATH, lookupPath);</span><br><span class="line">    <span class="built_in">this</span>.mappingRegistry.acquireReadLock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> lookupHandlerMethod(lookupPath, request);</span><br><span class="line">        <span class="keyword">return</span> (handlerMethod != <span class="literal">null</span> ? handlerMethod.createWithResolvedBean() : <span class="literal">null</span>); <span class="comment">// handlerMethod: &quot;st.southsea.shiro.LoginController#admin(String)&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mappingRegistry.releaseReadLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="双层-url-编码绕过">双层 URL 编码绕过</h3>
<p>配置如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># application.properties</span><br><span class="line">server.port=9090</span><br></pre></td></tr></table></figure>
<p><strong>HTTP</strong> 请求如下</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET http://127.0.0.1:9090/admin/a%252Fb</span><br></pre></td></tr></table></figure>
<p>同 <strong>context-path</strong> 绕过类似的调用过程。</p>
<h4 id="shiro-处理部分-2">Shiro 处理部分</h4>
<h5 id="executechain-1">executeChain</h5>
<p>从 <strong>executeChain</strong> 方法开始，执行过滤链，先调用
<strong>getExecutionChain</strong> 方法获取 <strong>shiro</strong>
配置的过滤链，然后执行 <strong>doFilter</strong> 方法进行过滤。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractShiroFilter (org.apache.shiro.web.servlet)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">executeChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain origChain)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="type">FilterChain</span> <span class="variable">chain</span> <span class="operator">=</span> getExecutionChain(request, response, origChain);</span><br><span class="line">    chain.doFilter(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="调用栈-1">调用栈</h5>
<p>一路往下一直到 <strong>getRequestUri</strong> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">getRequestUri:143, WebUtils (org.apache.shiro.web.util)</span><br><span class="line">getPathWithinApplication:113, WebUtils (org.apache.shiro.web.util)</span><br><span class="line">getPathWithinApplication:164, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getChain:103, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getExecutionChain:415, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br></pre></td></tr></table></figure>
<h5 id="getrequesturi-3">getRequestUri</h5>
<p>此处 <strong>getServletPath</strong> 获取的值是经过一次
<strong>URL</strong> 解码的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getRequestUri</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> (String) request.getAttribute(INCLUDE_REQUEST_URI_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (uri == <span class="literal">null</span>) &#123;</span><br><span class="line">        uri = valueOrEmpty(request.getContextPath()) + <span class="string">&quot;/&quot;</span> + <span class="comment">// &quot;&quot;</span></span><br><span class="line">              valueOrEmpty(request.getServletPath()) + <span class="comment">// &quot;/admin/a%2fb&quot;</span></span><br><span class="line">              valueOrEmpty(request.getPathInfo()); <span class="comment">// &quot;&quot;</span></span><br><span class="line">    &#125; <span class="comment">// uri: &quot;/test;//admin/cmd&quot;</span></span><br><span class="line">    <span class="keyword">return</span> normalize(decodeAndCleanUriString(request, uri));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="decodeandcleanuristring-3">decodeAndCleanUriString</h5>
<p>而后调用的 <strong>decodeAndCleanUriString</strong> 方法中又做了一次
<strong>URL</strong> 解码，返回的值为
<strong>/admin/a/b</strong>，无法在 <strong>shiro</strong> 中根据
<strong>Ant</strong> 规则匹配到
<strong>/admin/*</strong>，因此同样的，<strong>getChain</strong>
方法返回空。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">decodeAndCleanUriString</span><span class="params">(HttpServletRequest request, String uri)</span> &#123;</span><br><span class="line">    uri = decodeRequestString(request, uri);</span><br><span class="line">    <span class="type">int</span> <span class="variable">semicolonIndex</span> <span class="operator">=</span> uri.indexOf(<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> (semicolonIndex != -<span class="number">1</span> ? uri.substring(<span class="number">0</span>, semicolonIndex) : uri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="tomcat-处理部分-2">Tomcat 处理部分</h4>
<h5 id="调用栈-2">调用栈</h5>
<p>一路往下一直到 <strong>SpringBoot</strong> 的
<strong>getRequestUri</strong> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">getRequestUri:349, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getPathWithinApplication:265, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getPathWithinServletMapping:216, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getLookupPathForRequest:172, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getHandlerInternal:363, AbstractHandlerMethodMapping (org.springframework.web.servlet.handler)</span><br><span class="line">getHandlerInternal:110, RequestMappingInfoHandlerMapping (org.springframework.web.servlet.mvc.method)</span><br><span class="line">getHandlerInternal:59, RequestMappingInfoHandlerMapping (org.springframework.web.servlet.mvc.method)</span><br><span class="line">getHandler:395, AbstractHandlerMapping (org.springframework.web.servlet.handler)</span><br><span class="line">getHandler:1234, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doDispatch:1016, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doService:943, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">processRequest:1006, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">doGet:898, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:634, HttpServlet (javax.servlet.http)</span><br><span class="line">service:883, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:741, HttpServlet (javax.servlet.http)</span><br><span class="line">internalDoFilter:231, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:166, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:53, WsFilter (org.apache.tomcat.websocket.server)</span><br><span class="line">internalDoFilter:193, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:166, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">executeChain:449, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br></pre></td></tr></table></figure>
<h5 id="getrequesturi-4">getRequestUri</h5>
<p>在 <strong>SpringBoot</strong> 的 <strong>getRequestUri</strong>
方法中调用的 <strong>getRequestURI</strong> 方法返回的是原始的值
<strong>/admin/a%252Fb</strong>，并未经过 <strong>URL</strong>
解码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getRequestUri</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> (String) request.getAttribute(WebUtils.INCLUDE_REQUEST_URI_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (uri == <span class="literal">null</span>) &#123;</span><br><span class="line">        uri = request.getRequestURI();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> decodeAndCleanUriString(request, uri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="decodeandcleanuristring-4">decodeAndCleanUriString</h5>
<p>而后调用 <strong>decodeAndCleanUriString</strong> 方法解码一次，返回
<strong>/admin/a%2fb</strong>，匹配到 <strong>admin/*</strong>
路由，成功绕过。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">decodeAndCleanUriString</span><span class="params">(HttpServletRequest request, String uri)</span> &#123;</span><br><span class="line">    uri = removeSemicolonContent(uri);</span><br><span class="line">    uri = decodeRequestString(request, uri);</span><br><span class="line">    uri = getSanitizedPath(uri);</span><br><span class="line">    <span class="keyword">return</span> uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="漏洞修复-1">漏洞修复</h2>
<p><strong>Shiro</strong> 在 <a
target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/01887f645f92d276bbaf7dc644ad28ed4e82ef02"><strong>Commit</strong></a>
中修改了 <strong>URL</strong> 获取的逻辑。</p>
<p>在 <strong>WebUtils#getPathWithinApplication</strong> 中，使用
<strong>getServletPath(request) + getPathInfo(request)</strong>。</p>
<p>在 <strong>WebUtils#getRequestUri</strong> 中，修改处理逻辑与
<strong>SpringBoot</strong> 一致。</p>
<p><img
src="/images/Study-Unauthorized-Shiro/github.com_apache_shiro_commit_01887f645f92d276bbaf7dc644ad28ed4e82ef02.png" /></p>
<h1 id="cve-2020-13933">CVE-2020-13933</h1>
<h2 id="漏洞简介-2">漏洞简介</h2>
<p>影响版本：<strong>shiro &lt; 1.6.0</strong></p>
<p>漏洞描述：<strong>Shiro</strong>
由于处理身份验证请求时存在权限绕过漏洞，特制的<strong>HTTP</strong>请求可以绕过身份验证过程并获得对应用程序的未授权访问。</p>
<p>测试环境：<strong>Shiro 1.5.3</strong>，<strong>SpringBoot
2.2.6.RELEASE</strong></p>
<h2 id="漏洞分析-2">漏洞分析</h2>
<h3 id="绕过-1">; 绕过</h3>
<p>配置如下。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.properties</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">9090</span></span><br></pre></td></tr></table></figure>
<p><strong>HTTP</strong> 请求如下。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET http://127.0.0.1:9090/admin/%3bcmd</span><br></pre></td></tr></table></figure>
<h4 id="shiro-处理部分-3"><strong>Shiro</strong> 处理部分</h4>
<h5 id="调用栈-3">调用栈</h5>
<p>一路往下一直到 <strong>getPathWithinApplication</strong> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">getPathWithinApplication:112, WebUtils (org.apache.shiro.web.util)</span><br><span class="line">getPathWithinApplication:164, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getChain:103, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getExecutionChain:415, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br><span class="line">executeChain:448, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br></pre></td></tr></table></figure>
<h5 id="getpathwithinapplication-3">getPathWithinApplication</h5>
<p>同上一个版本类似，即使修复了，但是在
<strong>getPathWithinApplication</strong> 中调用的
<strong>getServletPath</strong> 方法获得的 <strong>URL</strong>
是依旧是经过 <strong>URL</strong> 解码的，然后才调用了
<strong>removeSemicolon</strong> 方法，移除了 <strong>;</strong>
之后的字符串，返回了 <strong>/admin/</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPathWithinApplication</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> normalize(removeSemicolon(getServletPath(request) + getPathInfo(request)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="removesemicolon">removeSemicolon</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">removeSemicolon</span><span class="params">(String uri)</span> &#123; <span class="comment">// uri: &quot;/admin/;cmd&quot;</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">semicolonIndex</span> <span class="operator">=</span> uri.indexOf(<span class="number">59</span>);</span><br><span class="line">    <span class="keyword">return</span> semicolonIndex != -<span class="number">1</span> ? uri.substring(<span class="number">0</span>, semicolonIndex) : uri; <span class="comment">// &quot;/admin/&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getchain-2">getChain</h5>
<p><strong>getChain</strong> 中获取到 <strong>requestURI</strong> 为
<strong>/admin/</strong>，然后被 <strong>Shiro</strong>
的安全机制替换掉了最后的斜杠，得到
<strong>/admin</strong>，接着循环遍历匹配路径，由于配置为
<strong>/admin/*</strong>，不会匹配到
<strong>/admin</strong>，因此返回空。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span></span><br><span class="line"><span class="keyword">public</span> FilterChain <span class="title function_">getChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain originalChain)</span> &#123;</span><br><span class="line">    <span class="type">FilterChainManager</span> <span class="variable">filterChainManager</span> <span class="operator">=</span> getFilterChainManager();</span><br><span class="line">    <span class="keyword">if</span> (!filterChainManager.hasChains()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> getPathWithinApplication(request);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(requestURI != <span class="literal">null</span> &amp;&amp; !DEFAULT_PATH_SEPARATOR.equals(requestURI)</span><br><span class="line">            &amp;&amp; requestURI.endsWith(DEFAULT_PATH_SEPARATOR)) &#123;</span><br><span class="line">        requestURI = requestURI.substring(<span class="number">0</span>, requestURI.length() - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (String pathPattern : filterChainManager.getChainNames()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pathPattern != <span class="literal">null</span> &amp;&amp; !DEFAULT_PATH_SEPARATOR.equals(pathPattern)</span><br><span class="line">                &amp;&amp; pathPattern.endsWith(DEFAULT_PATH_SEPARATOR)) &#123;</span><br><span class="line">            pathPattern = pathPattern.substring(<span class="number">0</span>, pathPattern.length() - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the path does match, then pass on to the subclass implementation for specific checks:</span></span><br><span class="line">        <span class="keyword">if</span> (pathMatches(pathPattern, requestURI)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                log.trace(<span class="string">&quot;Matched path pattern [&quot;</span> + pathPattern + <span class="string">&quot;] for requestURI [&quot;</span> + Encode.forHtml(requestURI) + <span class="string">&quot;].  &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;Utilizing corresponding filter chain...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> filterChainManager.proxy(originalChain, pathPattern);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="tomcat-处理部分-3">Tomcat 处理部分</h4>
<h5 id="调用栈-4">调用栈</h5>
<p>一路往下一直到 <strong>SpringBoot</strong> 的
<strong>getRequestUri</strong> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">getRequestUri:349, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getPathWithinApplication:265, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getPathWithinServletMapping:216, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getLookupPathForRequest:172, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getHandlerInternal:363, AbstractHandlerMethodMapping (org.springframework.web.servlet.handler)</span><br><span class="line">getHandlerInternal:110, RequestMappingInfoHandlerMapping (org.springframework.web.servlet.mvc.method)</span><br><span class="line">getHandlerInternal:59, RequestMappingInfoHandlerMapping (org.springframework.web.servlet.mvc.method)</span><br><span class="line">getHandler:395, AbstractHandlerMapping (org.springframework.web.servlet.handler)</span><br><span class="line">getHandler:1234, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doDispatch:1016, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doService:943, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">processRequest:1006, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">doGet:898, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:634, HttpServlet (javax.servlet.http)</span><br><span class="line">service:883, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:741, HttpServlet (javax.servlet.http)</span><br><span class="line">internalDoFilter:231, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:166, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:53, WsFilter (org.apache.tomcat.websocket.server)</span><br><span class="line">internalDoFilter:193, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:166, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">executeChain:449, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br></pre></td></tr></table></figure>
<h5 id="getrequesturi-5">getRequestUri</h5>
<p>同上一个 <strong>CVE</strong> 的处理方式一样，在
<strong>SpringBoot</strong> 的 <strong>getRequestUri</strong>
方法中调用的 <strong>getRequestURI</strong> 方法返回的是原始的值
<strong>/admin/%3bcmd</strong>，并未经过 <strong>URL</strong> 解码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getRequestUri</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> (String) request.getAttribute(WebUtils.INCLUDE_REQUEST_URI_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (uri == <span class="literal">null</span>) &#123;</span><br><span class="line">        uri = request.getRequestURI();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> decodeAndCleanUriString(request, uri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="decodeandcleanuristring-5">decodeAndCleanUriString</h5>
<p>而后先移除了 <strong>;</strong>，然后才进行 <strong>URL</strong>
解码，得到 <strong>/admin/;cmd</strong>，因此匹配到
<strong>/admin/*</strong>，得以绕过。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">decodeAndCleanUriString</span><span class="params">(HttpServletRequest request, String uri)</span> &#123;</span><br><span class="line">    uri = removeSemicolonContent(uri);</span><br><span class="line">    uri = decodeRequestString(request, uri);</span><br><span class="line">    uri = getSanitizedPath(uri);</span><br><span class="line">    <span class="keyword">return</span> uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="漏洞修复-2">漏洞修复</h2>
<p><strong><a
target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/dc194fc977ab6cfbf3c1ecb085e2bac5db14af6d">Commit</a></strong>
如下，<strong>org.apache.shiro.spring.web#ShiroFilterFactoryBean</strong>
中增加了 <strong>/**</strong>
的默认路径配置，使其可以全局匹配进行过滤校验。</p>
<p><img
src="/images/Study-Unauthorized-Shiro/github.com_apache_shiro_commit_dc194fc977ab6cfbf3c1ecb085e2bac5db14af6d.png" /></p>
<p>默认的 <strong>/**</strong> 配置对应一个全局的
<strong>InvalidRequestFilter</strong>，这个类继承了
<strong>AccessControlFilter</strong>。用来过滤特殊字符（分号、反斜线、非
<strong>ASCII</strong> 码字符)，并返回 <strong>400</strong> 状态码。</p>
<h1 id="cve-2020-17510">CVE-2020-17510</h1>
<h2 id="漏洞简介-3">漏洞简介</h2>
<p>影响版本：<strong>shiro &lt; 1.7.0</strong></p>
<p>漏洞描述：第三种 <strong>AntPathMatcher</strong> 的绕过方式</p>
<p>测试环境：<strong>Shiro 1.6.0</strong>，<strong>SpringBoot
2.5.3</strong></p>
<h2 id="漏洞分析-3">漏洞分析</h2>
<p>这个漏洞还是对 <strong>AntPathMatcher</strong> 的继续绕过,在
<strong>CVE-2020-11989</strong> 和 <strong>CVE-2020-13933</strong>
分别尝试了 <strong>/</strong> 的双重 <strong>URL</strong> 编码和
<strong>;</strong> 的 <strong>URL</strong>
编码绕过，归根到底这种方式还是因为<strong>Shiro</strong>与<strong>Spring</strong>对<strong>URI</strong>处理的差异化导致的。</p>
<p>上一个版本使用了全局的 <strong>InvalidRequestFilter</strong> 方法过滤
<strong>;</strong>，但是字符 <strong>.</strong> 同样会在
<strong>getServletPath</strong> 方法中进行标准化处理，</p>
<h3 id="绕过-2">. 绕过</h3>
<p>配置如下。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.properties</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">9090</span></span><br></pre></td></tr></table></figure>
<p><strong>HTTP</strong> 请求如下。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET http://127.0.0.1:9090/admin/.</span><br></pre></td></tr></table></figure>
<h4 id="shiro-处理部分-4"><strong>Shiro</strong> 处理部分</h4>
<h5 id="调用栈-5">调用栈</h5>
<p>一路往下一直到 <strong>getPathWithinApplication</strong> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">getPathWithinApplication:112, WebUtils (org.apache.shiro.web.util)</span><br><span class="line">getPathWithinApplication:164, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getChain:103, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getExecutionChain:415, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br><span class="line">executeChain:448, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br></pre></td></tr></table></figure>
<h5 id="getpathwithinapplication-4">getPathWithinApplication</h5>
<p><strong>getPathWithinApplication</strong> 调用了
<strong>getServletPath</strong> 来获取 <strong>URI</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPathWithinApplication</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> normalize(removeSemicolon(getServletPath(request) + getPathInfo(request)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getservletpath-1">getServletPath</h5>
<p>跟进 <strong>getServletPath</strong>，可见是调用了映射处理时候封装的
<strong>wrapperPath</strong> 成员变量，直接返回
<strong>/admin/</strong>，而后便同 <strong>CVE-2020-13933</strong>
一样，<strong>/admin/</strong> 被处理为
<strong>/admin</strong>，无法匹配上 <strong>/admin/*</strong>，从而
<strong>Shiro</strong> 的过滤链失效，然后进入 <strong>Tomcat</strong>
的默认过滤链。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Request (org.apache.catalina.connector)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getServletPath</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mappingData.wrapperPath.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="tomcat-处理部分-4">Tomcat 处理部分</h4>
<h5 id="调用栈-6">调用栈</h5>
<p>一路往下一直到 <strong>SpringBoot</strong> 的
<strong>getRequestUri</strong> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">getRequestUri:433, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getPathWithinApplication:355, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getLookupPathForRequest:249, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">resolveAndCacheLookupPath:200, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">initLookupPath:579, AbstractHandlerMapping (org.springframework.web.servlet.handler)</span><br><span class="line">getHandlerInternal:376, AbstractHandlerMethodMapping (org.springframework.web.servlet.handler)</span><br><span class="line">getHandlerInternal:125, RequestMappingInfoHandlerMapping (org.springframework.web.servlet.mvc.method)</span><br><span class="line">getHandlerInternal:67, RequestMappingInfoHandlerMapping (org.springframework.web.servlet.mvc.method)</span><br><span class="line">getHandler:498, AbstractHandlerMapping (org.springframework.web.servlet.handler)</span><br><span class="line">getHandler:1258, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doDispatch:1040, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doService:963, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">processRequest:1006, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">doGet:898, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:655, HttpServlet (javax.servlet.http)</span><br><span class="line">service:883, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:764, HttpServlet (javax.servlet.http)</span><br><span class="line">internalDoFilter:228, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:163, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:53, WsFilter (org.apache.tomcat.websocket.server)</span><br><span class="line">internalDoFilter:190, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:163, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:61, ProxiedFilterChain (org.apache.shiro.web.servlet)</span><br><span class="line">executeChain:108, AdviceFilter (org.apache.shiro.web.servlet)</span><br><span class="line">doFilterInternal:137, AdviceFilter (org.apache.shiro.web.servlet)</span><br><span class="line">doFilter:125, OncePerRequestFilter (org.apache.shiro.web.servlet)</span><br><span class="line">doFilter:66, ProxiedFilterChain (org.apache.shiro.web.servlet)</span><br><span class="line">executeChain:450, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br></pre></td></tr></table></figure>
<h5 id="getrequesturi-6">getRequestUri</h5>
<p>同上一个 <strong>CVE</strong> 的处理方式一样，在
<strong>SpringBoot</strong> 的 <strong>getRequestUri</strong>
方法中调用的 <strong>getRequestURI</strong> 方法返回的是原始的值
<strong>/admin/.</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getRequestUri</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> (String) request.getAttribute(WebUtils.INCLUDE_REQUEST_URI_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (uri == <span class="literal">null</span>) &#123;</span><br><span class="line">        uri = request.getRequestURI();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> decodeAndCleanUriString(request, uri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="decodeandcleanuristring-6">decodeAndCleanUriString</h5>
<p><strong>URL</strong> 解码，依旧是
<strong>/admin/.</strong>，因此匹配到
<strong>/admin/</strong>*，得以绕过。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">decodeAndCleanUriString</span><span class="params">(HttpServletRequest request, String uri)</span> &#123;</span><br><span class="line">    uri = removeSemicolonContent(uri);</span><br><span class="line">    uri = decodeRequestString(request, uri);</span><br><span class="line">    uri = getSanitizedPath(uri);</span><br><span class="line">    <span class="keyword">return</span> uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="漏洞修复-3">漏洞修复</h2>
<p>在 <a
target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/6acaaee9bb3a27927b599c37fabaeb7dd6109403"><strong>Commit</strong></a>
中发现 <strong>org.apache.shiro.spring.web</strong> 下新增了
<strong>ShiroUrlPathHelper</strong> 类，属于
<strong>UrlPathHelper</strong> 的子类，重写了
<strong>getPathWithinApplication</strong> 和
<strong>getPathWithinServletMapping</strong>
两个方法，通过相关配置后，<strong>SpringBoot</strong> 就会使用
<strong>Shiro</strong> 的
<strong>UrlPathHelper</strong>，这样两者判断逻辑一致，就不存在因差异性问题而导致的绕过了。</p>
<p><img
src="/images/Study-Unauthorized-Shiro/github.com_apache_shiro_commit_6acaaee9bb3a27927b599c37fabaeb7dd6109403.png" /></p>
<h1 id="cve-2020-17523">CVE-2020-17523</h1>
<h2 id="漏洞简介-4">漏洞简介</h2>
<p>影响版本：<strong>Shiro &lt; 1.7.1</strong></p>
<p>漏洞描述：<strong>Shiro 1.7.1</strong> 之前的版本，在将
<strong>Shiro</strong> 与 <strong>Spring</strong> 结合使用时，特制的
<strong>HTTP</strong> 请求可能会导致身份验证绕过。</p>
<p>测试环境：<strong>Shiro 1.7.0</strong>，<strong>SpringBoot
2.5.3</strong></p>
<h2 id="漏洞分析-4">漏洞分析</h2>
<p>如 <strong>CVE-2020-17510</strong> 那样，这个漏洞可以使用空格
<strong>%20</strong>
进行绕过。这个漏洞的主要原因是代码中，<strong>Shiro</strong> 会对请求的
<strong>URI</strong> 进行鉴权操作，校验的函数为
<strong>PathMatches</strong>，当 <strong>PathMatches</strong> 返回
<strong>true</strong> 时才会进入鉴权。</p>
<h3 id="空格绕过分析">空格绕过分析</h3>
<p>配置如下。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.properties</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">9090</span></span><br></pre></td></tr></table></figure>
<p><strong>HTTP</strong> 请求如下。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET http://127.0.0.1:9090/admin/%20</span><br></pre></td></tr></table></figure>
<h4 id="shiro-处理部分-5">Shiro 处理部分</h4>
<h5 id="调用栈-7">调用栈</h5>
<p>和 <strong>CVE-2020-17510</strong> 类似，一路往下一直到
<strong>getPathWithinApplication</strong> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">getPathWithinApplication:114, WebUtils (org.apache.shiro.web.util)</span><br><span class="line">getPathWithinApplication:164, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getChain:103, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getExecutionChain:416, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br><span class="line">executeChain:449, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br></pre></td></tr></table></figure>
<h5 id="getpathwithinapplication-5">getPathWithinApplication</h5>
<p>同样是调用 <strong>getPathWithinApplication</strong>
方法，并且进行标准化处理，直接返回 <strong>/admin/[空格]</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// WebUtils (org.apache.shiro.web.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPathWithinApplication</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> normalize(removeSemicolon(getServletPath(request) + getPathInfo(request)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getchain-3">getChain</h5>
<p>跟进 <strong>pathMatches</strong> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span></span><br><span class="line"><span class="keyword">public</span> FilterChain <span class="title function_">getChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain originalChain)</span> &#123;</span><br><span class="line">    <span class="type">FilterChainManager</span> <span class="variable">filterChainManager</span> <span class="operator">=</span> <span class="built_in">this</span>.getFilterChainManager();</span><br><span class="line">    <span class="keyword">if</span> (!filterChainManager.hasChains()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> <span class="built_in">this</span>.getPathWithinApplication(request); <span class="comment">// requestURI: &quot;/admin/ &quot;</span></span><br><span class="line">        <span class="keyword">if</span> (requestURI != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;/&quot;</span>.equals(requestURI) &amp;&amp; requestURI.endsWith(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">            requestURI = requestURI.substring(<span class="number">0</span>, requestURI.length() - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Iterator</span> <span class="variable">var6</span> <span class="operator">=</span> filterChainManager.getChainNames().iterator();</span><br><span class="line"></span><br><span class="line">        String pathPattern;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!var6.hasNext()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            pathPattern = (String)var6.next(); <span class="comment">// pathPattern: &quot;/admin/*&quot;</span></span><br><span class="line">            <span class="keyword">if</span> (pathPattern != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;/&quot;</span>.equals(pathPattern) &amp;&amp; pathPattern.endsWith(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">                pathPattern = pathPattern.substring(<span class="number">0</span>, pathPattern.length() - <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span>(!<span class="built_in">this</span>.pathMatches(pathPattern, requestURI));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">            log.trace(<span class="string">&quot;Matched path pattern [&quot;</span> + pathPattern + <span class="string">&quot;] for requestURI [&quot;</span> + Encode.forHtml(requestURI) + <span class="string">&quot;].  Utilizing corresponding filter chain...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> filterChainManager.proxy(originalChain, pathPattern);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="tokenizetostringarray">tokenizeToStringArray</h5>
<p><strong>pathMatches</strong> 开始一路转至
<strong>doMatch</strong>，进入 <strong>tokenizeToStringArray</strong>
方法，在 <strong>tokenizeToStringArray</strong>
中，<strong>trimTokens</strong> 默认设置为
<strong>true</strong>，所以在按 <strong>/</strong> 分割字符串后经
<strong>token.trim()</strong> 处理，空格等字符会被清除，返回
<strong>admin</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StringUtils (org.apache.shiro.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String[] tokenizeToStringArray(String str, String delimiters) &#123; <span class="comment">// str:&quot;/admin/ &quot;, delimiters: &quot;/&quot;</span></span><br><span class="line">    <span class="keyword">return</span> tokenizeToStringArray(str, delimiters, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String[] tokenizeToStringArray(String str, String delimiters, <span class="type">boolean</span> trimTokens, <span class="type">boolean</span> ignoreEmptyTokens) &#123;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="literal">null</span>) &#123; <span class="comment">// str: &quot;/admin/ &quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">StringTokenizer</span> <span class="variable">st</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringTokenizer</span>(str, delimiters);</span><br><span class="line">        <span class="type">List</span> <span class="variable">tokens</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            String token;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!st.hasMoreTokens()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> toStringArray(tokens);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                token = st.nextToken();</span><br><span class="line">                <span class="keyword">if</span> (trimTokens) &#123; <span class="comment">// true</span></span><br><span class="line">                    token = token.trim(); </span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span>(ignoreEmptyTokens &amp;&amp; token.length() &lt;= <span class="number">0</span>);</span><br><span class="line">            tokens.add(token);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="domatch">doMatch</h5>
<p><strong>tokenizeToStringArray</strong> 返回的是
<strong>["admin"]</strong>，数组长度不同于
<strong>pattern</strong>，因此循环到第二次比对时退出，匹配失败，然后继续进入
<strong>SpringBoot</strong> 的过滤链。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AntPathMatcher (org.apache.shiro.util)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">doMatch</span><span class="params">(String pattern, String path, <span class="type">boolean</span> fullMatch)</span> &#123; <span class="comment">// pattern: &quot;/admin/*&quot;, path: &quot;/admin/ &quot;, fullMatch: true</span></span><br><span class="line">    <span class="keyword">if</span> (path.startsWith(<span class="built_in">this</span>.pathSeparator) != pattern.startsWith(<span class="built_in">this</span>.pathSeparator)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String[] pattDirs = StringUtils.tokenizeToStringArray(pattern, <span class="built_in">this</span>.pathSeparator); <span class="comment">// pattern: &quot;/admin/*&quot;, pattDirs: [&quot;admin&quot;, &quot;*&quot;]</span></span><br><span class="line">    String[] pathDirs = StringUtils.tokenizeToStringArray(path, <span class="built_in">this</span>.pathSeparator); <span class="comment">// path: &quot;/admin/ &quot;, pathDirs: [&quot;admin&quot;], pathSeparator: &quot;/&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">pattIdxStart</span> <span class="operator">=</span> <span class="number">0</span>; </span><br><span class="line">    <span class="type">int</span> <span class="variable">pattIdxEnd</span> <span class="operator">=</span> pattDirs.length - <span class="number">1</span>; <span class="comment">// 1</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">pathIdxStart</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pathIdxEnd</span> <span class="operator">=</span> pathDirs.length - <span class="number">1</span>; <span class="comment">// 0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 匹配所有的元素知道第一个 **</span></span><br><span class="line">    <span class="keyword">while</span> (pattIdxStart &lt;= pattIdxEnd &amp;&amp; pathIdxStart &lt;= pathIdxEnd) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">patDir</span> <span class="operator">=</span> pattDirs[pattIdxStart]; <span class="comment">// patDir: [&quot;admin&quot;, &quot;*&quot;]</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;**&quot;</span>.equals(patDir)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// </span></span><br><span class="line">        <span class="keyword">if</span> (!matchStrings(patDir, pathDirs[pathIdxStart])) &#123; <span class="comment">// pathDirs: [&quot;admin&quot;], patDir: &quot;admin&quot;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pattIdxStart++;</span><br><span class="line">        pathIdxStart++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="tomcat-处理部分-5">Tomcat 处理部分</h4>
<h5 id="调用栈-8">调用栈</h5>
<p>和之前的 <strong>CVE-2020-17510</strong> 类似，一路往下一直到
<strong>SpringBoot</strong> 的 <strong>getRequestUri</strong> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">getRequestUri:345, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getPathWithinApplication:265, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getLookupPathForRequest:169, UrlPathHelper (org.springframework.web.util)</span><br><span class="line">getHandlerInternal:363, AbstractHandlerMethodMapping (org.springframework.web.servlet.handler)</span><br><span class="line">getHandlerInternal:110, RequestMappingInfoHandlerMapping (org.springframework.web.servlet.mvc.method)</span><br><span class="line">getHandlerInternal:59, RequestMappingInfoHandlerMapping (org.springframework.web.servlet.mvc.method)</span><br><span class="line">getHandler:395, AbstractHandlerMapping (org.springframework.web.servlet.handler)</span><br><span class="line">getHandler:1234, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doDispatch:1016, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doService:943, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">processRequest:1006, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">doGet:898, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:634, HttpServlet (javax.servlet.http)</span><br><span class="line">service:883, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:741, HttpServlet (javax.servlet.http)</span><br><span class="line">internalDoFilter:231, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:166, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:53, WsFilter (org.apache.tomcat.websocket.server)</span><br><span class="line">internalDoFilter:193, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:166, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:61, ProxiedFilterChain (org.apache.shiro.web.servlet)</span><br><span class="line">executeChain:108, AdviceFilter (org.apache.shiro.web.servlet)</span><br></pre></td></tr></table></figure>
<h5 id="getrequesturi-7">getRequestUri</h5>
<p>同上一个 <strong>CVE</strong> 的处理方式一样，在
<strong>SpringBoot</strong> 的 <strong>getRequestUri</strong>
方法中调用的 <strong>getRequestURI</strong> 方法返回的是原始的值
<strong>/admin/%20</strong>，并未经过 <strong>URL</strong> 解码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getRequestUri</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> (String) request.getAttribute(WebUtils.INCLUDE_REQUEST_URI_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (uri == <span class="literal">null</span>) &#123;</span><br><span class="line">        uri = request.getRequestURI();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> decodeAndCleanUriString(request, uri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="decodeandcleanuristring-7">decodeAndCleanUriString</h5>
<p><strong>URL</strong> 解码，得到 <strong>/admin/[空格]</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UrlPathHelper (org.springframework.web.util)</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">decodeAndCleanUriString</span><span class="params">(HttpServletRequest request, String uri)</span> &#123;</span><br><span class="line">    uri = removeSemicolonContent(uri);</span><br><span class="line">    uri = decodeRequestString(request, uri);</span><br><span class="line">    uri = getSanitizedPath(uri);</span><br><span class="line">    <span class="keyword">return</span> uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="tokenizetostringarray-1">tokenizeToStringArray</h5>
<p>接下来同 <strong>Shiro</strong> 一样，按照 <strong>/</strong>
分割并调用 <strong>trim</strong> 方法，差别在默认的
<strong>trimTokens</strong> 是
<strong>false</strong>，因此空格还在，返回了 <strong>["admin", "
"]</strong>，得以匹配到 <strong>/admin/</strong>*。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StringUtils (org.springframework.util)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String[] tokenizeToStringArray(</span><br><span class="line">        <span class="meta">@Nullable</span> String str, String delimiters, <span class="type">boolean</span> trimTokens, <span class="type">boolean</span> ignoreEmptyTokens) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (str == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> EMPTY_STRING_ARRAY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">StringTokenizer</span> <span class="variable">st</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringTokenizer</span>(str, delimiters);</span><br><span class="line">    List&lt;String&gt; tokens = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span> (st.hasMoreTokens()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> st.nextToken();</span><br><span class="line">        <span class="keyword">if</span> (trimTokens) &#123;</span><br><span class="line">            token = token.trim();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!ignoreEmptyTokens || token.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            tokens.add(token);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> toStringArray(tokens);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="漏洞修复-4">漏洞修复</h2>
<p>在 <a
target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/0842c27fa72d0da5de0c5723a66d402fe20903df"><strong>Commit</strong></a>
中将 <strong>tokenizeToStringArray</strong> 的
<strong>trimTokens</strong> 参数置为 <strong>false</strong>，这样同
<strong>SpringBoot</strong> 一致，默认不会调用 <strong>trim()</strong>
函数处理，因此也不会造成经过处理后的鉴权失败。</p>
<p><img
src="/images/Study-Unauthorized-Shiro/github.com_apache_shiro_commit_0842c27fa72d0da5de0c5723a66d402fe20903df.png" /></p>
<h1 id="cve-2021-41303">CVE-2021-41303</h1>
<h2 id="漏洞简介-5">漏洞简介</h2>
<p>影响版本：<strong>shiro &lt; 1.8.0</strong></p>
<p>漏洞描述：<strong>1.8.0</strong> 之前的 <strong>Apache
Shiro</strong>，在 <strong>Spring Boot</strong> 中使用 <strong>Apache
Shiro</strong> 时，特制的 <strong>HTTP</strong>
请求可能会导致身份验证绕过。用户应该更新到 <strong>Apache Shiro
1.8.0</strong>。</p>
<p>测试环境：<strong>Shiro 1.7.1</strong>，<strong>SpringBoot
2.5.3</strong></p>
<h2 id="漏洞分析-5">漏洞分析</h2>
<h3 id="绕过-3">/ 绕过</h3>
<p>配置如下。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.properties</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">9090</span></span><br></pre></td></tr></table></figure>
<p>权限配置，这个需要这样的特殊配置，因此有些鸡肋。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">ShiroFilterFactoryBean <span class="title function_">shiroFilterFactoryBean</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ShiroFilterFactoryBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">    bean.setSecurityManager(securityManager());</span><br><span class="line">    bean.setLoginUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">    bean.setSuccessUrl(<span class="string">&quot;/index&quot;</span>);</span><br><span class="line">    bean.setUnauthorizedUrl(<span class="string">&quot;/unauthorizedurl&quot;</span>);</span><br><span class="line">    Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;/doLogin&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;/admin/*&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;/admin/page&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">    bean.setFilterChainDefinitionMap(map);</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>HTTP</strong> 请求如下。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET http://127.0.0.1:9090/admin/page/</span><br></pre></td></tr></table></figure>
<h4 id="shiro处理部分">Shiro处理部分</h4>
<h5 id="调用栈-9">调用栈</h5>
<p>和之前的 <strong>CVE</strong> 类似，一路往下一直到
<strong>getPathWithinApplication</strong> 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">getPathWithinApplication:114, WebUtils (org.apache.shiro.web.util)</span><br><span class="line">getPathWithinApplication:166, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getChain:103, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getExecutionChain:416, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br><span class="line">executeChain:449, AbstractShiroFilter (org.apache.shiro.web.servlet)</span><br></pre></td></tr></table></figure>
<h5 id="getchain-4">getChain</h5>
<p><strong>getPathWithinApplication</strong> 返回
<strong>/admin/page/</strong>，<strong>removeTrailingSlash</strong> 删除
<strong>/</strong> 得到
<strong>/admin/page</strong>，由于拦截器的顺序，URL会经过
<strong>pathMatches</strong> 先匹配 <strong>/admin/*</strong>
拦截规则。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span></span><br><span class="line"><span class="keyword">public</span> FilterChain <span class="title function_">getChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain originalChain)</span> &#123;</span><br><span class="line">    <span class="type">FilterChainManager</span> <span class="variable">filterChainManager</span> <span class="operator">=</span> getFilterChainManager();</span><br><span class="line">    <span class="keyword">if</span> (!filterChainManager.hasChains()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> getPathWithinApplication(request); <span class="comment">// requestURI: &quot;/admin/test/page/&quot;</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">requestURINoTrailingSlash</span> <span class="operator">=</span> removeTrailingSlash(requestURI); <span class="comment">// requestURI: &quot;/admin/test/page/&quot;, requestURINoTrailingSlash: &quot;/admin/test/page&quot; </span></span><br><span class="line">    <span class="keyword">for</span> (String pathPattern : filterChainManager.getChainNames()) &#123;</span><br><span class="line">        <span class="comment">// for 循环匹配调用 pathMatches</span></span><br><span class="line">        <span class="keyword">if</span> (pathMatches(pathPattern, requestURI)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                log.trace(<span class="string">&quot;Matched path pattern [&#123;&#125;] for requestURI [&#123;&#125;].  &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;Utilizing corresponding filter chain...&quot;</span>, pathPattern, Encode.forHtml(requestURI));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> filterChainManager.proxy(originalChain, pathPattern);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            pathPattern = removeTrailingSlash(pathPattern); <span class="comment">// pathPattern: &quot;/admin/*/page&quot;</span></span><br><span class="line">            <span class="keyword">if</span> (pathMatches(pathPattern, requestURINoTrailingSlash)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                    log.trace(<span class="string">&quot;Matched path pattern [&#123;&#125;] for requestURI [&#123;&#125;].  &quot;</span> +</span><br><span class="line">                              <span class="string">&quot;Utilizing corresponding filter chain...&quot;</span>, pathPattern, Encode.forHtml(requestURINoTrailingSlash));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> filterChainManager.proxy(originalChain, requestURINoTrailingSlash);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="pathmatches">pathMatches</h5>
<p><strong>pathMatches</strong> 一路调到 <strong>doMatch</strong>，在
<strong>doMatch</strong> 中调用
<strong>tokenizeToStringArray</strong>，根据上一个
<strong>CVE-2020-17523</strong> 的修复已经把 <strong>trimToken</strong>
默认设置为 <strong>false</strong>，通过
<strong>tokenizeToStringArray</strong> 方法将路径以 <strong>/</strong>
拆分成数组，最后返回 <strong>false</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AntPathMatcher (org.apache.shiro.util)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">doMatch</span><span class="params">(String pattern, String path, <span class="type">boolean</span> fullMatch)</span> &#123; <span class="comment">// pattern: &quot;/admin/*&quot;, path: &quot;/admin/page/&quot;, fullMatch: true</span></span><br><span class="line">    <span class="keyword">if</span> (path == <span class="literal">null</span> || path.startsWith(<span class="built_in">this</span>.pathSeparator) != pattern.startsWith(<span class="built_in">this</span>.pathSeparator)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String[] pattDirs = StringUtils.tokenizeToStringArray(pattern, <span class="built_in">this</span>.pathSeparator, <span class="literal">false</span>, <span class="literal">true</span>); <span class="comment">// pattern: &quot;/admin/*&quot;, pattDirs: [&quot;admin&quot;, &quot;*&quot;]</span></span><br><span class="line">    String[] pathDirs = StringUtils.tokenizeToStringArray(path, <span class="built_in">this</span>.pathSeparator, <span class="literal">false</span>, <span class="literal">true</span>); <span class="comment">// path: &quot;/admin/page/&quot;, pathDir: [&quot;admin&quot;, &quot;page&quot;], pathSeparator: &quot;/&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">pattIdxStart</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pattIdxEnd</span> <span class="operator">=</span> pattDirs.length - <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pathIdxStart</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pathIdxEnd</span> <span class="operator">=</span> pathDirs.length - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (pattIdxStart &lt;= pattIdxEnd &amp;&amp; pathIdxStart &lt;= pathIdxEnd) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">patDir</span> <span class="operator">=</span> pattDirs[pattIdxStart];</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;**&quot;</span>.equals(patDir)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!matchStrings(patDir, pathDirs[pathIdxStart])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pattIdxStart++;</span><br><span class="line">        pathIdxStart++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pathIdxStart &gt; pathIdxEnd) &#123;</span><br><span class="line">        <span class="comment">// Path is exhausted, only match if rest of pattern is * or **&#x27;s</span></span><br><span class="line">        <span class="keyword">if</span> (pattIdxStart &gt; pattIdxEnd) &#123;</span><br><span class="line">            <span class="comment">// pattern 以 * 结尾，因此返回 !path.endsWith(&quot;/&quot;) 的结果，为 false</span></span><br><span class="line">            <span class="keyword">return</span> (pattern.endsWith(<span class="built_in">this</span>.pathSeparator) ?</span><br><span class="line">                    path.endsWith(<span class="built_in">this</span>.pathSeparator) : !path.endsWith(<span class="built_in">this</span>.pathSeparator));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getchain-5">getChain</h5>
<p><strong>pathMatches</strong> 返回 <strong>false</strong> 得以进入
<strong>else</strong> 分支，然后 <strong>removeTrailingSlash</strong>
移除末尾的 <strong>/</strong> 得到
<strong>/admin/page</strong>，继续进入
<strong>pathMatches</strong>，这次返回 <strong>true</strong>，因此返回
<strong>filterChainManager.proxy</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span></span><br><span class="line"><span class="keyword">public</span> FilterChain <span class="title function_">getChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain originalChain)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">for</span> (String pathPattern : filterChainManager.getChainNames()) &#123;</span><br><span class="line">        <span class="comment">// for 循环匹配调用 pathMatches</span></span><br><span class="line">        <span class="keyword">if</span> (pathMatches(pathPattern, requestURI)) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            pathPattern = removeTrailingSlash(pathPattern); <span class="comment">// pathPattern: &quot;/admin/*/page&quot;</span></span><br><span class="line">            <span class="keyword">if</span> (pathMatches(pathPattern, requestURINoTrailingSlash)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                    log.trace(<span class="string">&quot;Matched path pattern [&#123;&#125;] for requestURI [&#123;&#125;].  &quot;</span> +</span><br><span class="line">                              <span class="string">&quot;Utilizing corresponding filter chain...&quot;</span>, pathPattern, Encode.forHtml(requestURINoTrailingSlash));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> filterChainManager.proxy(originalChain, requestURINoTrailingSlash);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="proxy-1">proxy</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DefaultFilterChainManager (org.apache.shiro.web.filter.mgt)</span></span><br><span class="line"><span class="keyword">public</span> FilterChain <span class="title function_">proxy</span><span class="params">(FilterChain original, String chainName)</span> &#123;</span><br><span class="line">    <span class="type">NamedFilterList</span> <span class="variable">configured</span> <span class="operator">=</span> getChain(chainName);</span><br><span class="line">    <span class="keyword">if</span> (configured == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;There is no configured chain under the name/key [&quot;</span> + chainName + <span class="string">&quot;].&quot;</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> configured.proxy(original);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处 <strong>chainName</strong> 传入为 <strong>/admin/page</strong>
调用 <strong>getChain</strong> 方法获取过滤链，返回的是
<strong>ShiroConfig</strong> 中配置的 <strong>map.put("/admin/page",
"anon")</strong>，因此得以绕过。</p>
<p><img
src="/images/Study-Unauthorized-Shiro/image-20230615001055265.png" /></p>
<h2 id="漏洞修复-5">漏洞修复</h2>
<p><a
target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/4a20bf0e995909d8fda58f9c0485ea9eb2d43f0e"><strong>Commit</strong></a>
如下，直接将 <strong>filterChainManager.proxy</strong> 的第二个参数改为
<strong>pathPattern</strong>，直接传配置中的 <strong>URI</strong>
了，修复了此处的 <strong>/</strong> 的绕过问题。</p>
<p><img
src="/images/Study-Unauthorized-Shiro/github.com_apache_shiro_commit_4a20bf0e995909d8fda58f9c0485ea9eb2d43f0e.png" /></p>
<h1 id="cve-2022-32532">CVE-2022-32532</h1>
<h1 id="refer">Refer</h1>
<p><a target="_blank" rel="noopener" href="https://shiro.apache.org/security-reports"><strong>Apache
Shiro Vulnerability Reports</strong></a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11633"><strong>Shiro</strong>
历史漏洞分析</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Web/" rel="tag"><i class="fa fa-tag"></i> Web</a>
              <a href="/tags/CTF/" rel="tag"><i class="fa fa-tag"></i> CTF</a>
              <a href="/tags/Unauthorized/" rel="tag"><i class="fa fa-tag"></i> Unauthorized</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023-GYBD/" rel="prev" title="2023 贵阳大数据 CTF 部分题解">
                  <i class="fa fa-chevron-left"></i> 2023 贵阳大数据 CTF 部分题解
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/Study-Unserialize-Shiro/" rel="next" title="浅探 Shiro 反序列化">
                  浅探 Shiro 反序列化 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments disqusjs-container">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <script src="/live2d-widget/autoload.js"></script>
  &copy; 2018 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">南溟NaN</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/disqusjs/3.0.2/styles/disqusjs.css" integrity="sha256-71XarXwNr1Td27HmZI9zjY+rMzRdush6/glo6VFXp7o=" crossorigin="anonymous">

<script class="next-config" data-name="disqusjs" type="application/json">{"enable":true,"api":"https://disqus.skk.moe/disqus/","apikey":"Cz7uQCDoGwWYGv80HeDq40mZr1rrmYy9tHhCpcWG95DFzOD1TJKLXtbTxFqWBCr5","shortname":"southseast","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/disqusjs/3.0.2/disqusjs.es2015.umd.min.js","integrity":"sha256-okP99ZQKVpIy7+NogAMpGlIQzJa9XKXhIJcFgdju5bU="}}</script>
<script src="/js/third-party/comments/disqusjs.js"></script>

</body>
</html>
